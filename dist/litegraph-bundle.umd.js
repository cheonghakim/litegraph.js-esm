(function(D,pe){typeof exports=="object"&&typeof module<"u"?pe(exports):typeof define=="function"&&define.amd?define(["exports"],pe):(D=typeof globalThis<"u"?globalThis:D||self,pe(D.LiteGraph={}))})(this,function(exports){"use strict";var We=Object.defineProperty;var Xe=(D,pe,de)=>pe in D?We(D,pe,{enumerable:!0,configurable:!0,writable:!0,value:de}):D[pe]=de;var R=(D,pe,de)=>Xe(D,typeof pe!="symbol"?pe+"":pe,de);function earcut(e,t,r=2){const s=t&&t.length,n=s?t[0]*r:e.length;let a=linkedList(e,0,n,r,!0);const o=[];if(!a||a.next===a.prev)return o;let l,h,c;if(s&&(a=eliminateHoles(e,t,a,r)),e.length>80*r){l=1/0,h=1/0;let u=-1/0,p=-1/0;for(let f=r;f<n;f+=r){const d=e[f],g=e[f+1];d<l&&(l=d),g<h&&(h=g),d>u&&(u=d),g>p&&(p=g)}c=Math.max(u-l,p-h),c=c!==0?32767/c:0}return earcutLinked(a,o,r,l,h,c,0),o}function linkedList(e,t,r,s,n){let a;if(n===signedArea(e,t,r,s)>0)for(let o=t;o<r;o+=s)a=insertNode(o/s|0,e[o],e[o+1],a);else for(let o=r-s;o>=t;o-=s)a=insertNode(o/s|0,e[o],e[o+1],a);return a&&equals$6(a,a.next)&&(removeNode(a),a=a.next),a}function filterPoints(e,t){if(!e)return e;t||(t=e);let r=e,s;do if(s=!1,!r.steiner&&(equals$6(r,r.next)||area(r.prev,r,r.next)===0)){if(removeNode(r),r=t=r.prev,r===r.next)break;s=!0}else r=r.next;while(s||r!==t);return t}function earcutLinked(e,t,r,s,n,a,o){if(!e)return;!o&&a&&indexCurve(e,s,n,a);let l=e;for(;e.prev!==e.next;){const h=e.prev,c=e.next;if(a?isEarHashed(e,s,n,a):isEar(e)){t.push(h.i,e.i,c.i),removeNode(e),e=c.next,l=c.next;continue}if(e=c,e===l){o?o===1?(e=cureLocalIntersections(filterPoints(e),t),earcutLinked(e,t,r,s,n,a,2)):o===2&&splitEarcut(e,t,r,s,n,a):earcutLinked(filterPoints(e),t,r,s,n,a,1);break}}}function isEar(e){const t=e.prev,r=e,s=e.next;if(area(t,r,s)>=0)return!1;const n=t.x,a=r.x,o=s.x,l=t.y,h=r.y,c=s.y,u=Math.min(n,a,o),p=Math.min(l,h,c),f=Math.max(n,a,o),d=Math.max(l,h,c);let g=s.next;for(;g!==t;){if(g.x>=u&&g.x<=f&&g.y>=p&&g.y<=d&&pointInTriangleExceptFirst(n,l,a,h,o,c,g.x,g.y)&&area(g.prev,g,g.next)>=0)return!1;g=g.next}return!0}function isEarHashed(e,t,r,s){const n=e.prev,a=e,o=e.next;if(area(n,a,o)>=0)return!1;const l=n.x,h=a.x,c=o.x,u=n.y,p=a.y,f=o.y,d=Math.min(l,h,c),g=Math.min(u,p,f),m=Math.max(l,h,c),b=Math.max(u,p,f),E=zOrder(d,g,t,r,s),L=zOrder(m,b,t,r,s);let T=e.prevZ,_=e.nextZ;for(;T&&T.z>=E&&_&&_.z<=L;){if(T.x>=d&&T.x<=m&&T.y>=g&&T.y<=b&&T!==n&&T!==o&&pointInTriangleExceptFirst(l,u,h,p,c,f,T.x,T.y)&&area(T.prev,T,T.next)>=0||(T=T.prevZ,_.x>=d&&_.x<=m&&_.y>=g&&_.y<=b&&_!==n&&_!==o&&pointInTriangleExceptFirst(l,u,h,p,c,f,_.x,_.y)&&area(_.prev,_,_.next)>=0))return!1;_=_.nextZ}for(;T&&T.z>=E;){if(T.x>=d&&T.x<=m&&T.y>=g&&T.y<=b&&T!==n&&T!==o&&pointInTriangleExceptFirst(l,u,h,p,c,f,T.x,T.y)&&area(T.prev,T,T.next)>=0)return!1;T=T.prevZ}for(;_&&_.z<=L;){if(_.x>=d&&_.x<=m&&_.y>=g&&_.y<=b&&_!==n&&_!==o&&pointInTriangleExceptFirst(l,u,h,p,c,f,_.x,_.y)&&area(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function cureLocalIntersections(e,t){let r=e;do{const s=r.prev,n=r.next.next;!equals$6(s,n)&&intersects(s,r,r.next,n)&&locallyInside(s,n)&&locallyInside(n,s)&&(t.push(s.i,r.i,n.i),removeNode(r),removeNode(r.next),r=e=n),r=r.next}while(r!==e);return filterPoints(r)}function splitEarcut(e,t,r,s,n,a){let o=e;do{let l=o.next.next;for(;l!==o.prev;){if(o.i!==l.i&&isValidDiagonal(o,l)){let h=splitPolygon(o,l);o=filterPoints(o,o.next),h=filterPoints(h,h.next),earcutLinked(o,t,r,s,n,a,0),earcutLinked(h,t,r,s,n,a,0);return}l=l.next}o=o.next}while(o!==e)}function eliminateHoles(e,t,r,s){const n=[];for(let a=0,o=t.length;a<o;a++){const l=t[a]*s,h=a<o-1?t[a+1]*s:e.length,c=linkedList(e,l,h,s,!1);c===c.next&&(c.steiner=!0),n.push(getLeftmost(c))}n.sort(compareXYSlope);for(let a=0;a<n.length;a++)r=eliminateHole(n[a],r);return r}function compareXYSlope(e,t){let r=e.x-t.x;if(r===0&&(r=e.y-t.y,r===0)){const s=(e.next.y-e.y)/(e.next.x-e.x),n=(t.next.y-t.y)/(t.next.x-t.x);r=s-n}return r}function eliminateHole(e,t){const r=findHoleBridge(e,t);if(!r)return t;const s=splitPolygon(r,e);return filterPoints(s,s.next),filterPoints(r,r.next)}function findHoleBridge(e,t){let r=t;const s=e.x,n=e.y;let a=-1/0,o;if(equals$6(e,r))return r;do{if(equals$6(e,r.next))return r.next;if(n<=r.y&&n>=r.next.y&&r.next.y!==r.y){const p=r.x+(n-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(p<=s&&p>a&&(a=p,o=r.x<r.next.x?r:r.next,p===s))return o}r=r.next}while(r!==t);if(!o)return null;const l=o,h=o.x,c=o.y;let u=1/0;r=o;do{if(s>=r.x&&r.x>=h&&s!==r.x&&pointInTriangle(n<c?s:a,n,h,c,n<c?a:s,n,r.x,r.y)){const p=Math.abs(n-r.y)/(s-r.x);locallyInside(r,e)&&(p<u||p===u&&(r.x>o.x||r.x===o.x&&sectorContainsSector(o,r)))&&(o=r,u=p)}r=r.next}while(r!==l);return o}function sectorContainsSector(e,t){return area(e.prev,e,t.prev)<0&&area(t.next,e,e.next)<0}function indexCurve(e,t,r,s){let n=e;do n.z===0&&(n.z=zOrder(n.x,n.y,t,r,s)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next;while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,sortLinked(n)}function sortLinked(e){let t,r=1;do{let s=e,n;e=null;let a=null;for(t=0;s;){t++;let o=s,l=0;for(let c=0;c<r&&(l++,o=o.nextZ,!!o);c++);let h=r;for(;l>0||h>0&&o;)l!==0&&(h===0||!o||s.z<=o.z)?(n=s,s=s.nextZ,l--):(n=o,o=o.nextZ,h--),a?a.nextZ=n:e=n,n.prevZ=a,a=n;s=o}a.nextZ=null,r*=2}while(t>1);return e}function zOrder(e,t,r,s,n){return e=(e-r)*n|0,t=(t-s)*n|0,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,e|t<<1}function getLeftmost(e){let t=e,r=e;do(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next;while(t!==e);return r}function pointInTriangle(e,t,r,s,n,a,o,l){return(n-o)*(t-l)>=(e-o)*(a-l)&&(e-o)*(s-l)>=(r-o)*(t-l)&&(r-o)*(a-l)>=(n-o)*(s-l)}function pointInTriangleExceptFirst(e,t,r,s,n,a,o,l){return!(e===o&&t===l)&&pointInTriangle(e,t,r,s,n,a,o,l)}function isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!intersectsPolygon(e,t)&&(locallyInside(e,t)&&locallyInside(t,e)&&middleInside(e,t)&&(area(e.prev,e,t.prev)||area(e,t.prev,t))||equals$6(e,t)&&area(e.prev,e,e.next)>0&&area(t.prev,t,t.next)>0)}function area(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function equals$6(e,t){return e.x===t.x&&e.y===t.y}function intersects(e,t,r,s){const n=sign(area(e,t,r)),a=sign(area(e,t,s)),o=sign(area(r,s,e)),l=sign(area(r,s,t));return!!(n!==a&&o!==l||n===0&&onSegment(e,r,t)||a===0&&onSegment(e,s,t)||o===0&&onSegment(r,e,s)||l===0&&onSegment(r,t,s))}function onSegment(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function sign(e){return e>0?1:e<0?-1:0}function intersectsPolygon(e,t){let r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&intersects(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}function locallyInside(e,t){return area(e.prev,e,e.next)<0?area(e,t,e.next)>=0&&area(e,e.prev,t)>=0:area(e,t,e.prev)<0||area(e,e.next,t)<0}function middleInside(e,t){let r=e,s=!1;const n=(e.x+t.x)/2,a=(e.y+t.y)/2;do r.y>a!=r.next.y>a&&r.next.y!==r.y&&n<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(s=!s),r=r.next;while(r!==e);return s}function splitPolygon(e,t){const r=createNode(e.i,e.x,e.y),s=createNode(t.i,t.x,t.y),n=e.next,a=t.prev;return e.next=t,t.prev=e,r.next=n,n.prev=r,s.next=r,r.prev=s,a.next=s,s.prev=a,s}function insertNode(e,t,r,s){const n=createNode(e,t,r);return s?(n.next=s.next,n.prev=s,s.next.prev=n,s.next=n):(n.prev=n,n.next=n),n}function removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function createNode(e,t,r){return{i:e,x:t,y:r,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function signedArea(e,t,r,s){let n=0;for(let a=t,o=r-s;a<r;a+=s)n+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return n}var EPSILON=1e-6,ARRAY_TYPE=typeof Float32Array<"u"?Float32Array:Array,RANDOM=Math.random;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function create$5(){var e=new ARRAY_TYPE(9);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function fromMat4(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function clone$5(e){var t=new ARRAY_TYPE(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function copy$5(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function fromValues$5(e,t,r,s,n,a,o,l,h){var c=new ARRAY_TYPE(9);return c[0]=e,c[1]=t,c[2]=r,c[3]=s,c[4]=n,c[5]=a,c[6]=o,c[7]=l,c[8]=h,c}function set$5(e,t,r,s,n,a,o,l,h,c){return e[0]=t,e[1]=r,e[2]=s,e[3]=n,e[4]=a,e[5]=o,e[6]=l,e[7]=h,e[8]=c,e}function identity$2(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function transpose$1(e,t){if(e===t){var r=t[1],s=t[2],n=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=s,e[7]=n}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}function invert$2(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],c=t[7],u=t[8],p=u*o-l*c,f=-u*a+l*h,d=c*a-o*h,g=r*p+s*f+n*d;return g?(g=1/g,e[0]=p*g,e[1]=(-u*s+n*c)*g,e[2]=(l*s-n*o)*g,e[3]=f*g,e[4]=(u*r-n*h)*g,e[5]=(-l*r+n*a)*g,e[6]=d*g,e[7]=(-c*r+s*h)*g,e[8]=(o*r-s*a)*g,e):null}function adjoint$1(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],c=t[7],u=t[8];return e[0]=o*u-l*c,e[1]=n*c-s*u,e[2]=s*l-n*o,e[3]=l*h-a*u,e[4]=r*u-n*h,e[5]=n*a-r*l,e[6]=a*c-o*h,e[7]=s*h-r*c,e[8]=r*o-s*a,e}function determinant$1(e){var t=e[0],r=e[1],s=e[2],n=e[3],a=e[4],o=e[5],l=e[6],h=e[7],c=e[8];return t*(c*a-o*h)+r*(-c*n+o*l)+s*(h*n-a*l)}function multiply$5(e,t,r){var s=t[0],n=t[1],a=t[2],o=t[3],l=t[4],h=t[5],c=t[6],u=t[7],p=t[8],f=r[0],d=r[1],g=r[2],m=r[3],b=r[4],E=r[5],L=r[6],T=r[7],_=r[8];return e[0]=f*s+d*o+g*c,e[1]=f*n+d*l+g*u,e[2]=f*a+d*h+g*p,e[3]=m*s+b*o+E*c,e[4]=m*n+b*l+E*u,e[5]=m*a+b*h+E*p,e[6]=L*s+T*o+_*c,e[7]=L*n+T*l+_*u,e[8]=L*a+T*h+_*p,e}function translate$1(e,t,r){var s=t[0],n=t[1],a=t[2],o=t[3],l=t[4],h=t[5],c=t[6],u=t[7],p=t[8],f=r[0],d=r[1];return e[0]=s,e[1]=n,e[2]=a,e[3]=o,e[4]=l,e[5]=h,e[6]=f*s+d*o+c,e[7]=f*n+d*l+u,e[8]=f*a+d*h+p,e}function rotate$2(e,t,r){var s=t[0],n=t[1],a=t[2],o=t[3],l=t[4],h=t[5],c=t[6],u=t[7],p=t[8],f=Math.sin(r),d=Math.cos(r);return e[0]=d*s+f*o,e[1]=d*n+f*l,e[2]=d*a+f*h,e[3]=d*o-f*s,e[4]=d*l-f*n,e[5]=d*h-f*a,e[6]=c,e[7]=u,e[8]=p,e}function scale$5(e,t,r){var s=r[0],n=r[1];return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=n*t[3],e[4]=n*t[4],e[5]=n*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function fromTranslation$1(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e}function fromRotation$1(e,t){var r=Math.sin(t),s=Math.cos(t);return e[0]=s,e[1]=r,e[2]=0,e[3]=-r,e[4]=s,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function fromScaling$1(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function fromMat2d(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e}function fromQuat$1(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],o=r+r,l=s+s,h=n+n,c=r*o,u=s*o,p=s*l,f=n*o,d=n*l,g=n*h,m=a*o,b=a*l,E=a*h;return e[0]=1-p-g,e[3]=u-E,e[6]=f+b,e[1]=u+E,e[4]=1-c-g,e[7]=d-m,e[2]=f-b,e[5]=d+m,e[8]=1-c-p,e}function normalFromMat4(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],c=t[7],u=t[8],p=t[9],f=t[10],d=t[11],g=t[12],m=t[13],b=t[14],E=t[15],L=r*l-s*o,T=r*h-n*o,_=r*c-a*o,I=s*h-n*l,A=s*c-a*l,M=n*c-a*h,O=u*m-p*g,C=u*b-f*g,P=u*E-d*g,N=p*b-f*m,k=p*E-d*m,B=f*E-d*b,S=L*B-T*k+_*N+I*P-A*C+M*O;return S?(S=1/S,e[0]=(l*B-h*k+c*N)*S,e[1]=(h*P-o*B-c*C)*S,e[2]=(o*k-l*P+c*O)*S,e[3]=(n*k-s*B-a*N)*S,e[4]=(r*B-n*P+a*C)*S,e[5]=(s*P-r*k-a*O)*S,e[6]=(m*M-b*A+E*I)*S,e[7]=(b*_-g*M-E*T)*S,e[8]=(g*A-m*_+E*L)*S,e):null}function projection(e,t,r){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/r,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e}function str$5(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}function frob$1(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])}function add$5(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e}function subtract$4(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e}function multiplyScalar$1(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e}function multiplyScalarAndAdd$1(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e[3]=t[3]+r[3]*s,e[4]=t[4]+r[4]*s,e[5]=t[5]+r[5]*s,e[6]=t[6]+r[6]*s,e[7]=t[7]+r[7]*s,e[8]=t[8]+r[8]*s,e}function exactEquals$5(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]}function equals$5(e,t){var r=e[0],s=e[1],n=e[2],a=e[3],o=e[4],l=e[5],h=e[6],c=e[7],u=e[8],p=t[0],f=t[1],d=t[2],g=t[3],m=t[4],b=t[5],E=t[6],L=t[7],T=t[8];return Math.abs(r-p)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(p))&&Math.abs(s-f)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(n-d)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(a-g)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(o-m)<=EPSILON*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(l-b)<=EPSILON*Math.max(1,Math.abs(l),Math.abs(b))&&Math.abs(h-E)<=EPSILON*Math.max(1,Math.abs(h),Math.abs(E))&&Math.abs(c-L)<=EPSILON*Math.max(1,Math.abs(c),Math.abs(L))&&Math.abs(u-T)<=EPSILON*Math.max(1,Math.abs(u),Math.abs(T))}var mul$5=multiply$5,sub$4=subtract$4;const mat3$1=Object.freeze(Object.defineProperty({__proto__:null,add:add$5,adjoint:adjoint$1,clone:clone$5,copy:copy$5,create:create$5,determinant:determinant$1,equals:equals$5,exactEquals:exactEquals$5,frob:frob$1,fromMat2d,fromMat4,fromQuat:fromQuat$1,fromRotation:fromRotation$1,fromScaling:fromScaling$1,fromTranslation:fromTranslation$1,fromValues:fromValues$5,identity:identity$2,invert:invert$2,mul:mul$5,multiply:multiply$5,multiplyScalar:multiplyScalar$1,multiplyScalarAndAdd:multiplyScalarAndAdd$1,normalFromMat4,projection,rotate:rotate$2,scale:scale$5,set:set$5,str:str$5,sub:sub$4,subtract:subtract$4,translate:translate$1,transpose:transpose$1},Symbol.toStringTag,{value:"Module"}));function create$4(){var e=new ARRAY_TYPE(16);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function clone$4(e){var t=new ARRAY_TYPE(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function copy$4(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function fromValues$4(e,t,r,s,n,a,o,l,h,c,u,p,f,d,g,m){var b=new ARRAY_TYPE(16);return b[0]=e,b[1]=t,b[2]=r,b[3]=s,b[4]=n,b[5]=a,b[6]=o,b[7]=l,b[8]=h,b[9]=c,b[10]=u,b[11]=p,b[12]=f,b[13]=d,b[14]=g,b[15]=m,b}function set$4(e,t,r,s,n,a,o,l,h,c,u,p,f,d,g,m,b){return e[0]=t,e[1]=r,e[2]=s,e[3]=n,e[4]=a,e[5]=o,e[6]=l,e[7]=h,e[8]=c,e[9]=u,e[10]=p,e[11]=f,e[12]=d,e[13]=g,e[14]=m,e[15]=b,e}function identity$1(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function transpose(e,t){if(e===t){var r=t[1],s=t[2],n=t[3],a=t[6],o=t[7],l=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=s,e[9]=a,e[11]=t[14],e[12]=n,e[13]=o,e[14]=l}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function invert$1(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],c=t[7],u=t[8],p=t[9],f=t[10],d=t[11],g=t[12],m=t[13],b=t[14],E=t[15],L=r*l-s*o,T=r*h-n*o,_=r*c-a*o,I=s*h-n*l,A=s*c-a*l,M=n*c-a*h,O=u*m-p*g,C=u*b-f*g,P=u*E-d*g,N=p*b-f*m,k=p*E-d*m,B=f*E-d*b,S=L*B-T*k+_*N+I*P-A*C+M*O;return S?(S=1/S,e[0]=(l*B-h*k+c*N)*S,e[1]=(n*k-s*B-a*N)*S,e[2]=(m*M-b*A+E*I)*S,e[3]=(f*A-p*M-d*I)*S,e[4]=(h*P-o*B-c*C)*S,e[5]=(r*B-n*P+a*C)*S,e[6]=(b*_-g*M-E*T)*S,e[7]=(u*M-f*_+d*T)*S,e[8]=(o*k-l*P+c*O)*S,e[9]=(s*P-r*k-a*O)*S,e[10]=(g*A-m*_+E*L)*S,e[11]=(p*_-u*A-d*L)*S,e[12]=(l*C-o*N-h*O)*S,e[13]=(r*N-s*C+n*O)*S,e[14]=(m*T-g*I-b*L)*S,e[15]=(u*I-p*T+f*L)*S,e):null}function adjoint(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],c=t[7],u=t[8],p=t[9],f=t[10],d=t[11],g=t[12],m=t[13],b=t[14],E=t[15];return e[0]=l*(f*E-d*b)-p*(h*E-c*b)+m*(h*d-c*f),e[1]=-(s*(f*E-d*b)-p*(n*E-a*b)+m*(n*d-a*f)),e[2]=s*(h*E-c*b)-l*(n*E-a*b)+m*(n*c-a*h),e[3]=-(s*(h*d-c*f)-l*(n*d-a*f)+p*(n*c-a*h)),e[4]=-(o*(f*E-d*b)-u*(h*E-c*b)+g*(h*d-c*f)),e[5]=r*(f*E-d*b)-u*(n*E-a*b)+g*(n*d-a*f),e[6]=-(r*(h*E-c*b)-o*(n*E-a*b)+g*(n*c-a*h)),e[7]=r*(h*d-c*f)-o*(n*d-a*f)+u*(n*c-a*h),e[8]=o*(p*E-d*m)-u*(l*E-c*m)+g*(l*d-c*p),e[9]=-(r*(p*E-d*m)-u*(s*E-a*m)+g*(s*d-a*p)),e[10]=r*(l*E-c*m)-o*(s*E-a*m)+g*(s*c-a*l),e[11]=-(r*(l*d-c*p)-o*(s*d-a*p)+u*(s*c-a*l)),e[12]=-(o*(p*b-f*m)-u*(l*b-h*m)+g*(l*f-h*p)),e[13]=r*(p*b-f*m)-u*(s*b-n*m)+g*(s*f-n*p),e[14]=-(r*(l*b-h*m)-o*(s*b-n*m)+g*(s*h-n*l)),e[15]=r*(l*f-h*p)-o*(s*f-n*p)+u*(s*h-n*l),e}function determinant(e){var t=e[0],r=e[1],s=e[2],n=e[3],a=e[4],o=e[5],l=e[6],h=e[7],c=e[8],u=e[9],p=e[10],f=e[11],d=e[12],g=e[13],m=e[14],b=e[15],E=t*o-r*a,L=t*l-s*a,T=t*h-n*a,_=r*l-s*o,I=r*h-n*o,A=s*h-n*l,M=c*g-u*d,O=c*m-p*d,C=c*b-f*d,P=u*m-p*g,N=u*b-f*g,k=p*b-f*m;return E*k-L*N+T*P+_*C-I*O+A*M}function multiply$4(e,t,r){var s=t[0],n=t[1],a=t[2],o=t[3],l=t[4],h=t[5],c=t[6],u=t[7],p=t[8],f=t[9],d=t[10],g=t[11],m=t[12],b=t[13],E=t[14],L=t[15],T=r[0],_=r[1],I=r[2],A=r[3];return e[0]=T*s+_*l+I*p+A*m,e[1]=T*n+_*h+I*f+A*b,e[2]=T*a+_*c+I*d+A*E,e[3]=T*o+_*u+I*g+A*L,T=r[4],_=r[5],I=r[6],A=r[7],e[4]=T*s+_*l+I*p+A*m,e[5]=T*n+_*h+I*f+A*b,e[6]=T*a+_*c+I*d+A*E,e[7]=T*o+_*u+I*g+A*L,T=r[8],_=r[9],I=r[10],A=r[11],e[8]=T*s+_*l+I*p+A*m,e[9]=T*n+_*h+I*f+A*b,e[10]=T*a+_*c+I*d+A*E,e[11]=T*o+_*u+I*g+A*L,T=r[12],_=r[13],I=r[14],A=r[15],e[12]=T*s+_*l+I*p+A*m,e[13]=T*n+_*h+I*f+A*b,e[14]=T*a+_*c+I*d+A*E,e[15]=T*o+_*u+I*g+A*L,e}function translate(e,t,r){var s=r[0],n=r[1],a=r[2],o,l,h,c,u,p,f,d,g,m,b,E;return t===e?(e[12]=t[0]*s+t[4]*n+t[8]*a+t[12],e[13]=t[1]*s+t[5]*n+t[9]*a+t[13],e[14]=t[2]*s+t[6]*n+t[10]*a+t[14],e[15]=t[3]*s+t[7]*n+t[11]*a+t[15]):(o=t[0],l=t[1],h=t[2],c=t[3],u=t[4],p=t[5],f=t[6],d=t[7],g=t[8],m=t[9],b=t[10],E=t[11],e[0]=o,e[1]=l,e[2]=h,e[3]=c,e[4]=u,e[5]=p,e[6]=f,e[7]=d,e[8]=g,e[9]=m,e[10]=b,e[11]=E,e[12]=o*s+u*n+g*a+t[12],e[13]=l*s+p*n+m*a+t[13],e[14]=h*s+f*n+b*a+t[14],e[15]=c*s+d*n+E*a+t[15]),e}function scale$4(e,t,r){var s=r[0],n=r[1],a=r[2];return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*a,e[9]=t[9]*a,e[10]=t[10]*a,e[11]=t[11]*a,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function rotate$1(e,t,r,s){var n=s[0],a=s[1],o=s[2],l=Math.hypot(n,a,o),h,c,u,p,f,d,g,m,b,E,L,T,_,I,A,M,O,C,P,N,k,B,S,U;return l<EPSILON?null:(l=1/l,n*=l,a*=l,o*=l,h=Math.sin(r),c=Math.cos(r),u=1-c,p=t[0],f=t[1],d=t[2],g=t[3],m=t[4],b=t[5],E=t[6],L=t[7],T=t[8],_=t[9],I=t[10],A=t[11],M=n*n*u+c,O=a*n*u+o*h,C=o*n*u-a*h,P=n*a*u-o*h,N=a*a*u+c,k=o*a*u+n*h,B=n*o*u+a*h,S=a*o*u-n*h,U=o*o*u+c,e[0]=p*M+m*O+T*C,e[1]=f*M+b*O+_*C,e[2]=d*M+E*O+I*C,e[3]=g*M+L*O+A*C,e[4]=p*P+m*N+T*k,e[5]=f*P+b*N+_*k,e[6]=d*P+E*N+I*k,e[7]=g*P+L*N+A*k,e[8]=p*B+m*S+T*U,e[9]=f*B+b*S+_*U,e[10]=d*B+E*S+I*U,e[11]=g*B+L*S+A*U,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function rotateX$2(e,t,r){var s=Math.sin(r),n=Math.cos(r),a=t[4],o=t[5],l=t[6],h=t[7],c=t[8],u=t[9],p=t[10],f=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=a*n+c*s,e[5]=o*n+u*s,e[6]=l*n+p*s,e[7]=h*n+f*s,e[8]=c*n-a*s,e[9]=u*n-o*s,e[10]=p*n-l*s,e[11]=f*n-h*s,e}function rotateY$2(e,t,r){var s=Math.sin(r),n=Math.cos(r),a=t[0],o=t[1],l=t[2],h=t[3],c=t[8],u=t[9],p=t[10],f=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*n-c*s,e[1]=o*n-u*s,e[2]=l*n-p*s,e[3]=h*n-f*s,e[8]=a*s+c*n,e[9]=o*s+u*n,e[10]=l*s+p*n,e[11]=h*s+f*n,e}function rotateZ$2(e,t,r){var s=Math.sin(r),n=Math.cos(r),a=t[0],o=t[1],l=t[2],h=t[3],c=t[4],u=t[5],p=t[6],f=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*n+c*s,e[1]=o*n+u*s,e[2]=l*n+p*s,e[3]=h*n+f*s,e[4]=c*n-a*s,e[5]=u*n-o*s,e[6]=p*n-l*s,e[7]=f*n-h*s,e}function fromTranslation(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function fromScaling(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function fromRotation(e,t,r){var s=r[0],n=r[1],a=r[2],o=Math.hypot(s,n,a),l,h,c;return o<EPSILON?null:(o=1/o,s*=o,n*=o,a*=o,l=Math.sin(t),h=Math.cos(t),c=1-h,e[0]=s*s*c+h,e[1]=n*s*c+a*l,e[2]=a*s*c-n*l,e[3]=0,e[4]=s*n*c-a*l,e[5]=n*n*c+h,e[6]=a*n*c+s*l,e[7]=0,e[8]=s*a*c+n*l,e[9]=n*a*c-s*l,e[10]=a*a*c+h,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function fromXRotation(e,t){var r=Math.sin(t),s=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=r,e[7]=0,e[8]=0,e[9]=-r,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function fromYRotation(e,t){var r=Math.sin(t),s=Math.cos(t);return e[0]=s,e[1]=0,e[2]=-r,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=r,e[9]=0,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function fromZRotation(e,t){var r=Math.sin(t),s=Math.cos(t);return e[0]=s,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function fromRotationTranslation(e,t,r){var s=t[0],n=t[1],a=t[2],o=t[3],l=s+s,h=n+n,c=a+a,u=s*l,p=s*h,f=s*c,d=n*h,g=n*c,m=a*c,b=o*l,E=o*h,L=o*c;return e[0]=1-(d+m),e[1]=p+L,e[2]=f-E,e[3]=0,e[4]=p-L,e[5]=1-(u+m),e[6]=g+b,e[7]=0,e[8]=f+E,e[9]=g-b,e[10]=1-(u+d),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function fromQuat2(e,t){var r=new ARRAY_TYPE(3),s=-t[0],n=-t[1],a=-t[2],o=t[3],l=t[4],h=t[5],c=t[6],u=t[7],p=s*s+n*n+a*a+o*o;return p>0?(r[0]=(l*o+u*s+h*a-c*n)*2/p,r[1]=(h*o+u*n+c*s-l*a)*2/p,r[2]=(c*o+u*a+l*n-h*s)*2/p):(r[0]=(l*o+u*s+h*a-c*n)*2,r[1]=(h*o+u*n+c*s-l*a)*2,r[2]=(c*o+u*a+l*n-h*s)*2),fromRotationTranslation(e,t,r),e}function getTranslation(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function getScaling(e,t){var r=t[0],s=t[1],n=t[2],a=t[4],o=t[5],l=t[6],h=t[8],c=t[9],u=t[10];return e[0]=Math.hypot(r,s,n),e[1]=Math.hypot(a,o,l),e[2]=Math.hypot(h,c,u),e}function getRotation(e,t){var r=new ARRAY_TYPE(3);getScaling(r,t);var s=1/r[0],n=1/r[1],a=1/r[2],o=t[0]*s,l=t[1]*n,h=t[2]*a,c=t[4]*s,u=t[5]*n,p=t[6]*a,f=t[8]*s,d=t[9]*n,g=t[10]*a,m=o+u+g,b=0;return m>0?(b=Math.sqrt(m+1)*2,e[3]=.25*b,e[0]=(p-d)/b,e[1]=(f-h)/b,e[2]=(l-c)/b):o>u&&o>g?(b=Math.sqrt(1+o-u-g)*2,e[3]=(p-d)/b,e[0]=.25*b,e[1]=(l+c)/b,e[2]=(f+h)/b):u>g?(b=Math.sqrt(1+u-o-g)*2,e[3]=(f-h)/b,e[0]=(l+c)/b,e[1]=.25*b,e[2]=(p+d)/b):(b=Math.sqrt(1+g-o-u)*2,e[3]=(l-c)/b,e[0]=(f+h)/b,e[1]=(p+d)/b,e[2]=.25*b),e}function fromRotationTranslationScale(e,t,r,s){var n=t[0],a=t[1],o=t[2],l=t[3],h=n+n,c=a+a,u=o+o,p=n*h,f=n*c,d=n*u,g=a*c,m=a*u,b=o*u,E=l*h,L=l*c,T=l*u,_=s[0],I=s[1],A=s[2];return e[0]=(1-(g+b))*_,e[1]=(f+T)*_,e[2]=(d-L)*_,e[3]=0,e[4]=(f-T)*I,e[5]=(1-(p+b))*I,e[6]=(m+E)*I,e[7]=0,e[8]=(d+L)*A,e[9]=(m-E)*A,e[10]=(1-(p+g))*A,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function fromRotationTranslationScaleOrigin(e,t,r,s,n){var a=t[0],o=t[1],l=t[2],h=t[3],c=a+a,u=o+o,p=l+l,f=a*c,d=a*u,g=a*p,m=o*u,b=o*p,E=l*p,L=h*c,T=h*u,_=h*p,I=s[0],A=s[1],M=s[2],O=n[0],C=n[1],P=n[2],N=(1-(m+E))*I,k=(d+_)*I,B=(g-T)*I,S=(d-_)*A,U=(1-(f+E))*A,W=(b+L)*A,z=(g+T)*M,q=(b-L)*M,Y=(1-(f+m))*M;return e[0]=N,e[1]=k,e[2]=B,e[3]=0,e[4]=S,e[5]=U,e[6]=W,e[7]=0,e[8]=z,e[9]=q,e[10]=Y,e[11]=0,e[12]=r[0]+O-(N*O+S*C+z*P),e[13]=r[1]+C-(k*O+U*C+q*P),e[14]=r[2]+P-(B*O+W*C+Y*P),e[15]=1,e}function fromQuat(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],o=r+r,l=s+s,h=n+n,c=r*o,u=s*o,p=s*l,f=n*o,d=n*l,g=n*h,m=a*o,b=a*l,E=a*h;return e[0]=1-p-g,e[1]=u+E,e[2]=f-b,e[3]=0,e[4]=u-E,e[5]=1-c-g,e[6]=d+m,e[7]=0,e[8]=f+b,e[9]=d-m,e[10]=1-c-p,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function frustum(e,t,r,s,n,a,o){var l=1/(r-t),h=1/(n-s),c=1/(a-o);return e[0]=a*2*l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a*2*h,e[6]=0,e[7]=0,e[8]=(r+t)*l,e[9]=(n+s)*h,e[10]=(o+a)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*a*2*c,e[15]=0,e}function perspectiveNO(e,t,r,s,n){var a=1/Math.tan(t/2),o;return e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,n!=null&&n!==1/0?(o=1/(s-n),e[10]=(n+s)*o,e[14]=2*n*s*o):(e[10]=-1,e[14]=-2*s),e}var perspective=perspectiveNO;function perspectiveZO(e,t,r,s,n){var a=1/Math.tan(t/2),o;return e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,n!=null&&n!==1/0?(o=1/(s-n),e[10]=n*o,e[14]=n*s*o):(e[10]=-1,e[14]=-s),e}function perspectiveFromFieldOfView(e,t,r,s){var n=Math.tan(t.upDegrees*Math.PI/180),a=Math.tan(t.downDegrees*Math.PI/180),o=Math.tan(t.leftDegrees*Math.PI/180),l=Math.tan(t.rightDegrees*Math.PI/180),h=2/(o+l),c=2/(n+a);return e[0]=h,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-((o-l)*h*.5),e[9]=(n-a)*c*.5,e[10]=s/(r-s),e[11]=-1,e[12]=0,e[13]=0,e[14]=s*r/(r-s),e[15]=0,e}function orthoNO(e,t,r,s,n,a,o){var l=1/(t-r),h=1/(s-n),c=1/(a-o);return e[0]=-2*l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*h,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+r)*l,e[13]=(n+s)*h,e[14]=(o+a)*c,e[15]=1,e}var ortho=orthoNO;function orthoZO(e,t,r,s,n,a,o){var l=1/(t-r),h=1/(s-n),c=1/(a-o);return e[0]=-2*l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*h,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=c,e[11]=0,e[12]=(t+r)*l,e[13]=(n+s)*h,e[14]=a*c,e[15]=1,e}function lookAt(e,t,r,s){var n,a,o,l,h,c,u,p,f,d,g=t[0],m=t[1],b=t[2],E=s[0],L=s[1],T=s[2],_=r[0],I=r[1],A=r[2];return Math.abs(g-_)<EPSILON&&Math.abs(m-I)<EPSILON&&Math.abs(b-A)<EPSILON?identity$1(e):(u=g-_,p=m-I,f=b-A,d=1/Math.hypot(u,p,f),u*=d,p*=d,f*=d,n=L*f-T*p,a=T*u-E*f,o=E*p-L*u,d=Math.hypot(n,a,o),d?(d=1/d,n*=d,a*=d,o*=d):(n=0,a=0,o=0),l=p*o-f*a,h=f*n-u*o,c=u*a-p*n,d=Math.hypot(l,h,c),d?(d=1/d,l*=d,h*=d,c*=d):(l=0,h=0,c=0),e[0]=n,e[1]=l,e[2]=u,e[3]=0,e[4]=a,e[5]=h,e[6]=p,e[7]=0,e[8]=o,e[9]=c,e[10]=f,e[11]=0,e[12]=-(n*g+a*m+o*b),e[13]=-(l*g+h*m+c*b),e[14]=-(u*g+p*m+f*b),e[15]=1,e)}function targetTo(e,t,r,s){var n=t[0],a=t[1],o=t[2],l=s[0],h=s[1],c=s[2],u=n-r[0],p=a-r[1],f=o-r[2],d=u*u+p*p+f*f;d>0&&(d=1/Math.sqrt(d),u*=d,p*=d,f*=d);var g=h*f-c*p,m=c*u-l*f,b=l*p-h*u;return d=g*g+m*m+b*b,d>0&&(d=1/Math.sqrt(d),g*=d,m*=d,b*=d),e[0]=g,e[1]=m,e[2]=b,e[3]=0,e[4]=p*b-f*m,e[5]=f*g-u*b,e[6]=u*m-p*g,e[7]=0,e[8]=u,e[9]=p,e[10]=f,e[11]=0,e[12]=n,e[13]=a,e[14]=o,e[15]=1,e}function str$4(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"}function frob(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function add$4(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e[9]=t[9]+r[9],e[10]=t[10]+r[10],e[11]=t[11]+r[11],e[12]=t[12]+r[12],e[13]=t[13]+r[13],e[14]=t[14]+r[14],e[15]=t[15]+r[15],e}function subtract$3(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e[9]=t[9]-r[9],e[10]=t[10]-r[10],e[11]=t[11]-r[11],e[12]=t[12]-r[12],e[13]=t[13]-r[13],e[14]=t[14]-r[14],e[15]=t[15]-r[15],e}function multiplyScalar(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12]*r,e[13]=t[13]*r,e[14]=t[14]*r,e[15]=t[15]*r,e}function multiplyScalarAndAdd(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e[3]=t[3]+r[3]*s,e[4]=t[4]+r[4]*s,e[5]=t[5]+r[5]*s,e[6]=t[6]+r[6]*s,e[7]=t[7]+r[7]*s,e[8]=t[8]+r[8]*s,e[9]=t[9]+r[9]*s,e[10]=t[10]+r[10]*s,e[11]=t[11]+r[11]*s,e[12]=t[12]+r[12]*s,e[13]=t[13]+r[13]*s,e[14]=t[14]+r[14]*s,e[15]=t[15]+r[15]*s,e}function exactEquals$4(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]}function equals$4(e,t){var r=e[0],s=e[1],n=e[2],a=e[3],o=e[4],l=e[5],h=e[6],c=e[7],u=e[8],p=e[9],f=e[10],d=e[11],g=e[12],m=e[13],b=e[14],E=e[15],L=t[0],T=t[1],_=t[2],I=t[3],A=t[4],M=t[5],O=t[6],C=t[7],P=t[8],N=t[9],k=t[10],B=t[11],S=t[12],U=t[13],W=t[14],z=t[15];return Math.abs(r-L)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(L))&&Math.abs(s-T)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(T))&&Math.abs(n-_)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(_))&&Math.abs(a-I)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(I))&&Math.abs(o-A)<=EPSILON*Math.max(1,Math.abs(o),Math.abs(A))&&Math.abs(l-M)<=EPSILON*Math.max(1,Math.abs(l),Math.abs(M))&&Math.abs(h-O)<=EPSILON*Math.max(1,Math.abs(h),Math.abs(O))&&Math.abs(c-C)<=EPSILON*Math.max(1,Math.abs(c),Math.abs(C))&&Math.abs(u-P)<=EPSILON*Math.max(1,Math.abs(u),Math.abs(P))&&Math.abs(p-N)<=EPSILON*Math.max(1,Math.abs(p),Math.abs(N))&&Math.abs(f-k)<=EPSILON*Math.max(1,Math.abs(f),Math.abs(k))&&Math.abs(d-B)<=EPSILON*Math.max(1,Math.abs(d),Math.abs(B))&&Math.abs(g-S)<=EPSILON*Math.max(1,Math.abs(g),Math.abs(S))&&Math.abs(m-U)<=EPSILON*Math.max(1,Math.abs(m),Math.abs(U))&&Math.abs(b-W)<=EPSILON*Math.max(1,Math.abs(b),Math.abs(W))&&Math.abs(E-z)<=EPSILON*Math.max(1,Math.abs(E),Math.abs(z))}var mul$4=multiply$4,sub$3=subtract$3;const mat4$1=Object.freeze(Object.defineProperty({__proto__:null,add:add$4,adjoint,clone:clone$4,copy:copy$4,create:create$4,determinant,equals:equals$4,exactEquals:exactEquals$4,frob,fromQuat,fromQuat2,fromRotation,fromRotationTranslation,fromRotationTranslationScale,fromRotationTranslationScaleOrigin,fromScaling,fromTranslation,fromValues:fromValues$4,fromXRotation,fromYRotation,fromZRotation,frustum,getRotation,getScaling,getTranslation,identity:identity$1,invert:invert$1,lookAt,mul:mul$4,multiply:multiply$4,multiplyScalar,multiplyScalarAndAdd,ortho,orthoNO,orthoZO,perspective,perspectiveFromFieldOfView,perspectiveNO,perspectiveZO,rotate:rotate$1,rotateX:rotateX$2,rotateY:rotateY$2,rotateZ:rotateZ$2,scale:scale$4,set:set$4,str:str$4,sub:sub$3,subtract:subtract$3,targetTo,translate,transpose},Symbol.toStringTag,{value:"Module"}));function create$3(){var e=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function clone$3(e){var t=new ARRAY_TYPE(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function length$3(e){var t=e[0],r=e[1],s=e[2];return Math.hypot(t,r,s)}function fromValues$3(e,t,r){var s=new ARRAY_TYPE(3);return s[0]=e,s[1]=t,s[2]=r,s}function copy$3(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function set$3(e,t,r,s){return e[0]=t,e[1]=r,e[2]=s,e}function add$3(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function subtract$2(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function multiply$3(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function divide$2(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}function ceil$2(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function floor$2(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function min$2(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e}function max$2(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e}function round$2(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}function scale$3(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function scaleAndAdd$2(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e}function distance$2(e,t){var r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return Math.hypot(r,s,n)}function squaredDistance$2(e,t){var r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return r*r+s*s+n*n}function squaredLength$3(e){var t=e[0],r=e[1],s=e[2];return t*t+r*r+s*s}function negate$2(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function inverse$2(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}function normalize$3(e,t){var r=t[0],s=t[1],n=t[2],a=r*r+s*s+n*n;return a>0&&(a=1/Math.sqrt(a)),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a,e}function dot$3(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function cross$2(e,t,r){var s=t[0],n=t[1],a=t[2],o=r[0],l=r[1],h=r[2];return e[0]=n*h-a*l,e[1]=a*o-s*h,e[2]=s*l-n*o,e}function lerp$3(e,t,r,s){var n=t[0],a=t[1],o=t[2];return e[0]=n+s*(r[0]-n),e[1]=a+s*(r[1]-a),e[2]=o+s*(r[2]-o),e}function hermite(e,t,r,s,n,a){var o=a*a,l=o*(2*a-3)+1,h=o*(a-2)+a,c=o*(a-1),u=o*(3-2*a);return e[0]=t[0]*l+r[0]*h+s[0]*c+n[0]*u,e[1]=t[1]*l+r[1]*h+s[1]*c+n[1]*u,e[2]=t[2]*l+r[2]*h+s[2]*c+n[2]*u,e}function bezier(e,t,r,s,n,a){var o=1-a,l=o*o,h=a*a,c=l*o,u=3*a*l,p=3*h*o,f=h*a;return e[0]=t[0]*c+r[0]*u+s[0]*p+n[0]*f,e[1]=t[1]*c+r[1]*u+s[1]*p+n[1]*f,e[2]=t[2]*c+r[2]*u+s[2]*p+n[2]*f,e}function random$3(e,t){t=t||1;var r=RANDOM()*2*Math.PI,s=RANDOM()*2-1,n=Math.sqrt(1-s*s)*t;return e[0]=Math.cos(r)*n,e[1]=Math.sin(r)*n,e[2]=s*t,e}function transformMat4$2(e,t,r){var s=t[0],n=t[1],a=t[2],o=r[3]*s+r[7]*n+r[11]*a+r[15];return o=o||1,e[0]=(r[0]*s+r[4]*n+r[8]*a+r[12])/o,e[1]=(r[1]*s+r[5]*n+r[9]*a+r[13])/o,e[2]=(r[2]*s+r[6]*n+r[10]*a+r[14])/o,e}function transformMat3$1(e,t,r){var s=t[0],n=t[1],a=t[2];return e[0]=s*r[0]+n*r[3]+a*r[6],e[1]=s*r[1]+n*r[4]+a*r[7],e[2]=s*r[2]+n*r[5]+a*r[8],e}function transformQuat$1(e,t,r){var s=r[0],n=r[1],a=r[2],o=r[3],l=t[0],h=t[1],c=t[2],u=n*c-a*h,p=a*l-s*c,f=s*h-n*l,d=n*f-a*p,g=a*u-s*f,m=s*p-n*u,b=o*2;return u*=b,p*=b,f*=b,d*=2,g*=2,m*=2,e[0]=l+u+d,e[1]=h+p+g,e[2]=c+f+m,e}function rotateX$1(e,t,r,s){var n=[],a=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],a[0]=n[0],a[1]=n[1]*Math.cos(s)-n[2]*Math.sin(s),a[2]=n[1]*Math.sin(s)+n[2]*Math.cos(s),e[0]=a[0]+r[0],e[1]=a[1]+r[1],e[2]=a[2]+r[2],e}function rotateY$1(e,t,r,s){var n=[],a=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],a[0]=n[2]*Math.sin(s)+n[0]*Math.cos(s),a[1]=n[1],a[2]=n[2]*Math.cos(s)-n[0]*Math.sin(s),e[0]=a[0]+r[0],e[1]=a[1]+r[1],e[2]=a[2]+r[2],e}function rotateZ$1(e,t,r,s){var n=[],a=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],a[0]=n[0]*Math.cos(s)-n[1]*Math.sin(s),a[1]=n[0]*Math.sin(s)+n[1]*Math.cos(s),a[2]=n[2],e[0]=a[0]+r[0],e[1]=a[1]+r[1],e[2]=a[2]+r[2],e}function angle$1(e,t){var r=e[0],s=e[1],n=e[2],a=t[0],o=t[1],l=t[2],h=Math.sqrt(r*r+s*s+n*n),c=Math.sqrt(a*a+o*o+l*l),u=h*c,p=u&&dot$3(e,t)/u;return Math.acos(Math.min(Math.max(p,-1),1))}function zero$2(e){return e[0]=0,e[1]=0,e[2]=0,e}function str$3(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"}function exactEquals$3(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function equals$3(e,t){var r=e[0],s=e[1],n=e[2],a=t[0],o=t[1],l=t[2];return Math.abs(r-a)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(s-o)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(o))&&Math.abs(n-l)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(l))}var sub$2=subtract$2,mul$3=multiply$3,div$2=divide$2,dist$2=distance$2,sqrDist$2=squaredDistance$2,len$3=length$3,sqrLen$3=squaredLength$3,forEach$2=function(){var e=create$3();return function(t,r,s,n,a,o){var l,h;for(r||(r=3),s||(s=0),n?h=Math.min(n*r+s,t.length):h=t.length,l=s;l<h;l+=r)e[0]=t[l],e[1]=t[l+1],e[2]=t[l+2],a(e,e,o),t[l]=e[0],t[l+1]=e[1],t[l+2]=e[2];return t}}();const vec3$1=Object.freeze(Object.defineProperty({__proto__:null,add:add$3,angle:angle$1,bezier,ceil:ceil$2,clone:clone$3,copy:copy$3,create:create$3,cross:cross$2,dist:dist$2,distance:distance$2,div:div$2,divide:divide$2,dot:dot$3,equals:equals$3,exactEquals:exactEquals$3,floor:floor$2,forEach:forEach$2,fromValues:fromValues$3,hermite,inverse:inverse$2,len:len$3,length:length$3,lerp:lerp$3,max:max$2,min:min$2,mul:mul$3,multiply:multiply$3,negate:negate$2,normalize:normalize$3,random:random$3,rotateX:rotateX$1,rotateY:rotateY$1,rotateZ:rotateZ$1,round:round$2,scale:scale$3,scaleAndAdd:scaleAndAdd$2,set:set$3,sqrDist:sqrDist$2,sqrLen:sqrLen$3,squaredDistance:squaredDistance$2,squaredLength:squaredLength$3,str:str$3,sub:sub$2,subtract:subtract$2,transformMat3:transformMat3$1,transformMat4:transformMat4$2,transformQuat:transformQuat$1,zero:zero$2},Symbol.toStringTag,{value:"Module"}));function create$2(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function clone$2(e){var t=new ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function fromValues$2(e,t,r,s){var n=new ARRAY_TYPE(4);return n[0]=e,n[1]=t,n[2]=r,n[3]=s,n}function copy$2(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function set$2(e,t,r,s,n){return e[0]=t,e[1]=r,e[2]=s,e[3]=n,e}function add$2(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e}function subtract$1(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}function multiply$2(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e}function divide$1(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e[3]=t[3]/r[3],e}function ceil$1(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e}function floor$1(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e}function min$1(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e}function max$1(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e}function round$1(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e}function scale$2(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e}function scaleAndAdd$1(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e[3]=t[3]+r[3]*s,e}function distance$1(e,t){var r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2],a=t[3]-e[3];return Math.hypot(r,s,n,a)}function squaredDistance$1(e,t){var r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2],a=t[3]-e[3];return r*r+s*s+n*n+a*a}function length$2(e){var t=e[0],r=e[1],s=e[2],n=e[3];return Math.hypot(t,r,s,n)}function squaredLength$2(e){var t=e[0],r=e[1],s=e[2],n=e[3];return t*t+r*r+s*s+n*n}function negate$1(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function inverse$1(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e}function normalize$2(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],o=r*r+s*s+n*n+a*a;return o>0&&(o=1/Math.sqrt(o)),e[0]=r*o,e[1]=s*o,e[2]=n*o,e[3]=a*o,e}function dot$2(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function cross$1(e,t,r,s){var n=r[0]*s[1]-r[1]*s[0],a=r[0]*s[2]-r[2]*s[0],o=r[0]*s[3]-r[3]*s[0],l=r[1]*s[2]-r[2]*s[1],h=r[1]*s[3]-r[3]*s[1],c=r[2]*s[3]-r[3]*s[2],u=t[0],p=t[1],f=t[2],d=t[3];return e[0]=p*c-f*h+d*l,e[1]=-(u*c)+f*o-d*a,e[2]=u*h-p*o+d*n,e[3]=-(u*l)+p*a-f*n,e}function lerp$2(e,t,r,s){var n=t[0],a=t[1],o=t[2],l=t[3];return e[0]=n+s*(r[0]-n),e[1]=a+s*(r[1]-a),e[2]=o+s*(r[2]-o),e[3]=l+s*(r[3]-l),e}function random$2(e,t){t=t||1;var r,s,n,a,o,l;do r=RANDOM()*2-1,s=RANDOM()*2-1,o=r*r+s*s;while(o>=1);do n=RANDOM()*2-1,a=RANDOM()*2-1,l=n*n+a*a;while(l>=1);var h=Math.sqrt((1-o)/l);return e[0]=t*r,e[1]=t*s,e[2]=t*n*h,e[3]=t*a*h,e}function transformMat4$1(e,t,r){var s=t[0],n=t[1],a=t[2],o=t[3];return e[0]=r[0]*s+r[4]*n+r[8]*a+r[12]*o,e[1]=r[1]*s+r[5]*n+r[9]*a+r[13]*o,e[2]=r[2]*s+r[6]*n+r[10]*a+r[14]*o,e[3]=r[3]*s+r[7]*n+r[11]*a+r[15]*o,e}function transformQuat(e,t,r){var s=t[0],n=t[1],a=t[2],o=r[0],l=r[1],h=r[2],c=r[3],u=c*s+l*a-h*n,p=c*n+h*s-o*a,f=c*a+o*n-l*s,d=-o*s-l*n-h*a;return e[0]=u*c+d*-o+p*-h-f*-l,e[1]=p*c+d*-l+f*-o-u*-h,e[2]=f*c+d*-h+u*-l-p*-o,e[3]=t[3],e}function zero$1(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e}function str$2(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function exactEquals$2(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function equals$2(e,t){var r=e[0],s=e[1],n=e[2],a=e[3],o=t[0],l=t[1],h=t[2],c=t[3];return Math.abs(r-o)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-l)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-h)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(a-c)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(c))}var sub$1=subtract$1,mul$2=multiply$2,div$1=divide$1,dist$1=distance$1,sqrDist$1=squaredDistance$1,len$2=length$2,sqrLen$2=squaredLength$2,forEach$1=function(){var e=create$2();return function(t,r,s,n,a,o){var l,h;for(r||(r=4),s||(s=0),n?h=Math.min(n*r+s,t.length):h=t.length,l=s;l<h;l+=r)e[0]=t[l],e[1]=t[l+1],e[2]=t[l+2],e[3]=t[l+3],a(e,e,o),t[l]=e[0],t[l+1]=e[1],t[l+2]=e[2],t[l+3]=e[3];return t}}();const vec4$1=Object.freeze(Object.defineProperty({__proto__:null,add:add$2,ceil:ceil$1,clone:clone$2,copy:copy$2,create:create$2,cross:cross$1,dist:dist$1,distance:distance$1,div:div$1,divide:divide$1,dot:dot$2,equals:equals$2,exactEquals:exactEquals$2,floor:floor$1,forEach:forEach$1,fromValues:fromValues$2,inverse:inverse$1,len:len$2,length:length$2,lerp:lerp$2,max:max$1,min:min$1,mul:mul$2,multiply:multiply$2,negate:negate$1,normalize:normalize$2,random:random$2,round:round$1,scale:scale$2,scaleAndAdd:scaleAndAdd$1,set:set$2,sqrDist:sqrDist$1,sqrLen:sqrLen$2,squaredDistance:squaredDistance$1,squaredLength:squaredLength$2,str:str$2,sub:sub$1,subtract:subtract$1,transformMat4:transformMat4$1,transformQuat,zero:zero$1},Symbol.toStringTag,{value:"Module"}));function create$1(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function identity(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function setAxisAngle(e,t,r){r=r*.5;var s=Math.sin(r);return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=Math.cos(r),e}function getAxisAngle(e,t){var r=Math.acos(t[3])*2,s=Math.sin(r/2);return s>EPSILON?(e[0]=t[0]/s,e[1]=t[1]/s,e[2]=t[2]/s):(e[0]=1,e[1]=0,e[2]=0),r}function getAngle(e,t){var r=dot$1(e,t);return Math.acos(2*r*r-1)}function multiply$1(e,t,r){var s=t[0],n=t[1],a=t[2],o=t[3],l=r[0],h=r[1],c=r[2],u=r[3];return e[0]=s*u+o*l+n*c-a*h,e[1]=n*u+o*h+a*l-s*c,e[2]=a*u+o*c+s*h-n*l,e[3]=o*u-s*l-n*h-a*c,e}function rotateX(e,t,r){r*=.5;var s=t[0],n=t[1],a=t[2],o=t[3],l=Math.sin(r),h=Math.cos(r);return e[0]=s*h+o*l,e[1]=n*h+a*l,e[2]=a*h-n*l,e[3]=o*h-s*l,e}function rotateY(e,t,r){r*=.5;var s=t[0],n=t[1],a=t[2],o=t[3],l=Math.sin(r),h=Math.cos(r);return e[0]=s*h-a*l,e[1]=n*h+o*l,e[2]=a*h+s*l,e[3]=o*h-n*l,e}function rotateZ(e,t,r){r*=.5;var s=t[0],n=t[1],a=t[2],o=t[3],l=Math.sin(r),h=Math.cos(r);return e[0]=s*h+n*l,e[1]=n*h-s*l,e[2]=a*h+o*l,e[3]=o*h-a*l,e}function calculateW(e,t){var r=t[0],s=t[1],n=t[2];return e[0]=r,e[1]=s,e[2]=n,e[3]=Math.sqrt(Math.abs(1-r*r-s*s-n*n)),e}function exp(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],o=Math.sqrt(r*r+s*s+n*n),l=Math.exp(a),h=o>0?l*Math.sin(o)/o:0;return e[0]=r*h,e[1]=s*h,e[2]=n*h,e[3]=l*Math.cos(o),e}function ln(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],o=Math.sqrt(r*r+s*s+n*n),l=o>0?Math.atan2(o,a)/o:0;return e[0]=r*l,e[1]=s*l,e[2]=n*l,e[3]=.5*Math.log(r*r+s*s+n*n+a*a),e}function pow(e,t,r){return ln(e,t),scale$1(e,e,r),exp(e,e),e}function slerp(e,t,r,s){var n=t[0],a=t[1],o=t[2],l=t[3],h=r[0],c=r[1],u=r[2],p=r[3],f,d,g,m,b;return d=n*h+a*c+o*u+l*p,d<0&&(d=-d,h=-h,c=-c,u=-u,p=-p),1-d>EPSILON?(f=Math.acos(d),g=Math.sin(f),m=Math.sin((1-s)*f)/g,b=Math.sin(s*f)/g):(m=1-s,b=s),e[0]=m*n+b*h,e[1]=m*a+b*c,e[2]=m*o+b*u,e[3]=m*l+b*p,e}function random$1(e){var t=RANDOM(),r=RANDOM(),s=RANDOM(),n=Math.sqrt(1-t),a=Math.sqrt(t);return e[0]=n*Math.sin(2*Math.PI*r),e[1]=n*Math.cos(2*Math.PI*r),e[2]=a*Math.sin(2*Math.PI*s),e[3]=a*Math.cos(2*Math.PI*s),e}function invert(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],o=r*r+s*s+n*n+a*a,l=o?1/o:0;return e[0]=-r*l,e[1]=-s*l,e[2]=-n*l,e[3]=a*l,e}function conjugate(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e}function fromMat3(e,t){var r=t[0]+t[4]+t[8],s;if(r>0)s=Math.sqrt(r+1),e[3]=.5*s,s=.5/s,e[0]=(t[5]-t[7])*s,e[1]=(t[6]-t[2])*s,e[2]=(t[1]-t[3])*s;else{var n=0;t[4]>t[0]&&(n=1),t[8]>t[n*3+n]&&(n=2);var a=(n+1)%3,o=(n+2)%3;s=Math.sqrt(t[n*3+n]-t[a*3+a]-t[o*3+o]+1),e[n]=.5*s,s=.5/s,e[3]=(t[a*3+o]-t[o*3+a])*s,e[a]=(t[a*3+n]+t[n*3+a])*s,e[o]=(t[o*3+n]+t[n*3+o])*s}return e}function fromEuler(e,t,r,s){var n=.5*Math.PI/180;t*=n,r*=n,s*=n;var a=Math.sin(t),o=Math.cos(t),l=Math.sin(r),h=Math.cos(r),c=Math.sin(s),u=Math.cos(s);return e[0]=a*h*u-o*l*c,e[1]=o*l*u+a*h*c,e[2]=o*h*c-a*l*u,e[3]=o*h*u+a*l*c,e}function str$1(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}var clone$1=clone$2,fromValues$1=fromValues$2,copy$1=copy$2,set$1=set$2,add$1=add$2,mul$1=multiply$1,scale$1=scale$2,dot$1=dot$2,lerp$1=lerp$2,length$1=length$2,len$1=length$1,squaredLength$1=squaredLength$2,sqrLen$1=squaredLength$1,normalize$1=normalize$2,exactEquals$1=exactEquals$2,equals$1=equals$2,rotationTo=function(){var e=create$3(),t=fromValues$3(1,0,0),r=fromValues$3(0,1,0);return function(s,n,a){var o=dot$3(n,a);return o<-.999999?(cross$2(e,t,n),len$3(e)<1e-6&&cross$2(e,r,n),normalize$3(e,e),setAxisAngle(s,e,Math.PI),s):o>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(cross$2(e,n,a),s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1+o,normalize$1(s,s))}}(),sqlerp=function(){var e=create$1(),t=create$1();return function(r,s,n,a,o,l){return slerp(e,s,o,l),slerp(t,n,a,l),slerp(r,e,t,2*l*(1-l)),r}}(),setAxes=function(){var e=create$5();return function(t,r,s,n){return e[0]=s[0],e[3]=s[1],e[6]=s[2],e[1]=n[0],e[4]=n[1],e[7]=n[2],e[2]=-r[0],e[5]=-r[1],e[8]=-r[2],normalize$1(t,fromMat3(t,e))}}();const quat$1=Object.freeze(Object.defineProperty({__proto__:null,add:add$1,calculateW,clone:clone$1,conjugate,copy:copy$1,create:create$1,dot:dot$1,equals:equals$1,exactEquals:exactEquals$1,exp,fromEuler,fromMat3,fromValues:fromValues$1,getAngle,getAxisAngle,identity,invert,len:len$1,length:length$1,lerp:lerp$1,ln,mul:mul$1,multiply:multiply$1,normalize:normalize$1,pow,random:random$1,rotateX,rotateY,rotateZ,rotationTo,scale:scale$1,set:set$1,setAxes,setAxisAngle,slerp,sqlerp,sqrLen:sqrLen$1,squaredLength:squaredLength$1,str:str$1},Symbol.toStringTag,{value:"Module"}));function create(){var e=new ARRAY_TYPE(2);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0),e}function clone(e){var t=new ARRAY_TYPE(2);return t[0]=e[0],t[1]=e[1],t}function fromValues(e,t){var r=new ARRAY_TYPE(2);return r[0]=e,r[1]=t,r}function copy(e,t){return e[0]=t[0],e[1]=t[1],e}function set(e,t,r){return e[0]=t,e[1]=r,e}function add(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e}function subtract(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function multiply(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e}function divide(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e}function ceil(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function floor(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function min(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e}function max(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e}function round(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function scale(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e}function scaleAndAdd(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e}function distance(e,t){var r=t[0]-e[0],s=t[1]-e[1];return Math.hypot(r,s)}function squaredDistance(e,t){var r=t[0]-e[0],s=t[1]-e[1];return r*r+s*s}function length(e){var t=e[0],r=e[1];return Math.hypot(t,r)}function squaredLength(e){var t=e[0],r=e[1];return t*t+r*r}function negate(e,t){return e[0]=-t[0],e[1]=-t[1],e}function inverse(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function normalize(e,t){var r=t[0],s=t[1],n=r*r+s*s;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e}function dot(e,t){return e[0]*t[0]+e[1]*t[1]}function cross(e,t,r){var s=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=s,e}function lerp(e,t,r,s){var n=t[0],a=t[1];return e[0]=n+s*(r[0]-n),e[1]=a+s*(r[1]-a),e}function random(e,t){t=t||1;var r=RANDOM()*2*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e}function transformMat2(e,t,r){var s=t[0],n=t[1];return e[0]=r[0]*s+r[2]*n,e[1]=r[1]*s+r[3]*n,e}function transformMat2d(e,t,r){var s=t[0],n=t[1];return e[0]=r[0]*s+r[2]*n+r[4],e[1]=r[1]*s+r[3]*n+r[5],e}function transformMat3(e,t,r){var s=t[0],n=t[1];return e[0]=r[0]*s+r[3]*n+r[6],e[1]=r[1]*s+r[4]*n+r[7],e}function transformMat4(e,t,r){var s=t[0],n=t[1];return e[0]=r[0]*s+r[4]*n+r[12],e[1]=r[1]*s+r[5]*n+r[13],e}function rotate(e,t,r,s){var n=t[0]-r[0],a=t[1]-r[1],o=Math.sin(s),l=Math.cos(s);return e[0]=n*l-a*o+r[0],e[1]=n*o+a*l+r[1],e}function angle(e,t){var r=e[0],s=e[1],n=t[0],a=t[1],o=Math.sqrt(r*r+s*s)*Math.sqrt(n*n+a*a),l=o&&(r*n+s*a)/o;return Math.acos(Math.min(Math.max(l,-1),1))}function zero(e){return e[0]=0,e[1]=0,e}function str(e){return"vec2("+e[0]+", "+e[1]+")"}function exactEquals(e,t){return e[0]===t[0]&&e[1]===t[1]}function equals(e,t){var r=e[0],s=e[1],n=t[0],a=t[1];return Math.abs(r-n)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(s-a)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(a))}var len=length,sub=subtract,mul=multiply,div=divide,dist=distance,sqrDist=squaredDistance,sqrLen=squaredLength,forEach=function(){var e=create();return function(t,r,s,n,a,o){var l,h;for(r||(r=2),s||(s=0),n?h=Math.min(n*r+s,t.length):h=t.length,l=s;l<h;l+=r)e[0]=t[l],e[1]=t[l+1],a(e,e,o),t[l]=e[0],t[l+1]=e[1];return t}}();const vec2$1=Object.freeze(Object.defineProperty({__proto__:null,add,angle,ceil,clone,copy,create,cross,dist,distance,div,divide,dot,equals,exactEquals,floor,forEach,fromValues,inverse,len,length,lerp,max,min,mul,multiply,negate,normalize,random,rotate,round,scale,scaleAndAdd,set,sqrDist,sqrLen,squaredDistance,squaredLength,str,sub,subtract,transformMat2,transformMat2d,transformMat3,transformMat4,zero},Symbol.toStringTag,{value:"Module"})),vec2=Object.assign({},vec2$1),vec3=Object.assign({},vec3$1),vec4=Object.assign({},vec4$1),quat=Object.assign({},quat$1),mat3=Object.assign({},mat3$1),mat4=Object.assign({},mat4$1),glMatrix=Object.assign({},void 0),global$1=typeof window<"u"?window:typeof self<"u"?self:global$1,GL$1=global$1.GL=global$1.LiteGL={};global$1.requestAnimationFrame=global$1.requestAnimationFrame||global$1.mozRequestAnimationFrame||global$1.webkitRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},GL$1.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0},GL$1.reverse=null,GL$1.LEFT_MOUSE_BUTTON=0,GL$1.MIDDLE_MOUSE_BUTTON=1,GL$1.RIGHT_MOUSE_BUTTON=2,GL$1.LEFT_MOUSE_BUTTON_MASK=1,GL$1.RIGHT_MOUSE_BUTTON_MASK=2,GL$1.MIDDLE_MOUSE_BUTTON_MASK=4,GL$1.last_context_id=0,GL$1.COLOR_BUFFER_BIT=16384,GL$1.DEPTH_BUFFER_BIT=256,GL$1.STENCIL_BUFFER_BIT=1024,GL$1.TEXTURE_2D=3553,GL$1.TEXTURE_CUBE_MAP=34067,GL$1.TEXTURE_3D=32879,GL$1.TEXTURE_MAG_FILTER=10240,GL$1.TEXTURE_MIN_FILTER=10241,GL$1.TEXTURE_WRAP_S=10242,GL$1.TEXTURE_WRAP_T=10243,GL$1.BYTE=5120,GL$1.UNSIGNED_BYTE=5121,GL$1.SHORT=5122,GL$1.UNSIGNED_SHORT=5123,GL$1.INT=5124,GL$1.UNSIGNED_INT=5125,GL$1.FLOAT=5126,GL$1.HALF_FLOAT_OES=36193,GL$1.HALF_FLOAT=5131,GL$1.DEPTH_COMPONENT16=33189,GL$1.DEPTH_COMPONENT24=33190,GL$1.DEPTH_COMPONENT32F=36012,GL$1.FLOAT_VEC2=35664,GL$1.FLOAT_VEC3=35665,GL$1.FLOAT_VEC4=35666,GL$1.INT_VEC2=35667,GL$1.INT_VEC3=35668,GL$1.INT_VEC4=35669,GL$1.BOOL=35670,GL$1.BOOL_VEC2=35671,GL$1.BOOL_VEC3=35672,GL$1.BOOL_VEC4=35673,GL$1.FLOAT_MAT2=35674,GL$1.FLOAT_MAT3=35675,GL$1.FLOAT_MAT4=35676,GL$1.TYPE_LENGTH={},GL$1.TYPE_LENGTH[GL$1.FLOAT]=GL$1.TYPE_LENGTH[GL$1.INT]=GL$1.TYPE_LENGTH[GL$1.BYTE]=GL$1.TYPE_LENGTH[GL$1.BOOL]=1,GL$1.TYPE_LENGTH[GL$1.FLOAT_VEC2]=GL$1.TYPE_LENGTH[GL$1.INT_VEC2]=GL$1.TYPE_LENGTH[GL$1.BOOL_VEC2]=2,GL$1.TYPE_LENGTH[GL$1.FLOAT_VEC3]=GL$1.TYPE_LENGTH[GL$1.INT_VEC3]=GL$1.TYPE_LENGTH[GL$1.BOOL_VEC3]=3,GL$1.TYPE_LENGTH[GL$1.FLOAT_VEC4]=GL$1.TYPE_LENGTH[GL$1.INT_VEC4]=GL$1.TYPE_LENGTH[GL$1.BOOL_VEC4]=4,GL$1.TYPE_LENGTH[GL$1.FLOAT_MAT3]=9,GL$1.TYPE_LENGTH[GL$1.FLOAT_MAT4]=16,GL$1.SAMPLER_2D=35678,GL$1.SAMPLER_3D=35679,GL$1.SAMPLER_CUBE=35680,GL$1.INT_SAMPLER_2D=36298,GL$1.INT_SAMPLER_3D=36299,GL$1.INT_SAMPLER_CUBE=36300,GL$1.UNSIGNED_INT_SAMPLER_2D=36306,GL$1.UNSIGNED_INT_SAMPLER_3D=36307,GL$1.UNSIGNED_INT_SAMPLER_CUBE=36308,GL$1.DEPTH_COMPONENT=6402,GL$1.ALPHA=6406,GL$1.RGB=6407,GL$1.RGBA=6408,GL$1.LUMINANCE=6409,GL$1.LUMINANCE_ALPHA=6410,GL$1.DEPTH_STENCIL=34041,GL$1.UNSIGNED_INT_24_8=GL$1.UNSIGNED_INT_24_8_WEBGL=34042,GL$1.R8=33321,GL$1.R16F=33325,GL$1.R32F=33326,GL$1.R8UI=33330,GL$1.RG8=33323,GL$1.RG16F=33327,GL$1.RG32F=33328,GL$1.RGB8=32849,GL$1.SRGB8=35905,GL$1.RGB565=36194,GL$1.R11F_G11F_B10F=35898,GL$1.RGB9_E5=35901,GL$1.RGB16F=34843,GL$1.RGB32F=34837,GL$1.RGB8UI=36221,GL$1.RGBA8=32856,GL$1.RGB5_A1=32855,GL$1.RGBA16F=34842,GL$1.RGBA32F=34836,GL$1.RGBA8UI=36220,GL$1.RGBA16I=36232,GL$1.RGBA16UI=36214,GL$1.RGBA32I=36226,GL$1.RGBA32UI=36208,GL$1.DEPTH24_STENCIL8=35056,GL$1.NEAREST=9728,GL$1.LINEAR=9729,GL$1.NEAREST_MIPMAP_NEAREST=9984,GL$1.LINEAR_MIPMAP_NEAREST=9985,GL$1.NEAREST_MIPMAP_LINEAR=9986,GL$1.LINEAR_MIPMAP_LINEAR=9987,GL$1.REPEAT=10497,GL$1.CLAMP_TO_EDGE=33071,GL$1.MIRRORED_REPEAT=33648,GL$1.ZERO=0,GL$1.ONE=1,GL$1.SRC_COLOR=768,GL$1.ONE_MINUS_SRC_COLOR=769,GL$1.SRC_ALPHA=770,GL$1.ONE_MINUS_SRC_ALPHA=771,GL$1.DST_ALPHA=772,GL$1.ONE_MINUS_DST_ALPHA=773,GL$1.DST_COLOR=774,GL$1.ONE_MINUS_DST_COLOR=775,GL$1.SRC_ALPHA_SATURATE=776,GL$1.CONSTANT_COLOR=32769,GL$1.ONE_MINUS_CONSTANT_COLOR=32770,GL$1.CONSTANT_ALPHA=32771,GL$1.ONE_MINUS_CONSTANT_ALPHA=32772,GL$1.VERTEX_SHADER=35633,GL$1.FRAGMENT_SHADER=35632,GL$1.FRONT=1028,GL$1.BACK=1029,GL$1.FRONT_AND_BACK=1032,GL$1.NEVER=512,GL$1.LESS=513,GL$1.EQUAL=514,GL$1.LEQUAL=515,GL$1.GREATER=516,GL$1.NOTEQUAL=517,GL$1.GEQUAL=518,GL$1.ALWAYS=519,GL$1.KEEP=7680,GL$1.REPLACE=7681,GL$1.INCR=7682,GL$1.DECR=7683,GL$1.INCR_WRAP=34055,GL$1.DECR_WRAP=34056,GL$1.INVERT=5386,GL$1.STREAM_DRAW=35040,GL$1.STATIC_DRAW=35044,GL$1.DYNAMIC_DRAW=35048,GL$1.ARRAY_BUFFER=34962,GL$1.ELEMENT_ARRAY_BUFFER=34963,GL$1.POINTS=0,GL$1.LINES=1,GL$1.LINE_LOOP=2,GL$1.LINE_STRIP=3,GL$1.TRIANGLES=4,GL$1.TRIANGLE_STRIP=5,GL$1.TRIANGLE_FAN=6,GL$1.CW=2304,GL$1.CCW=2305,GL$1.CULL_FACE=2884,GL$1.DEPTH_TEST=2929,GL$1.BLEND=3042,GL$1.temp_vec3=vec3.create(),GL$1.temp2_vec3=vec3.create(),GL$1.temp_vec4=vec4.create(),GL$1.temp_quat=quat.create(),GL$1.temp_mat3=mat3.create(),GL$1.temp_mat4=mat4.create(),global$1.DEG2RAD=.0174532925,global$1.RAD2DEG=57.295779578552306,global$1.EPSILON=1e-6,global$1.isPowerOfTwo=GL$1.isPowerOfTwo=function(t){return Math.log(t)/Math.log(2)%1==0},global$1.nearestPowerOfTwo=GL$1.nearestPowerOfTwo=function(t){return Math.pow(2,Math.round(Math.log(t)/Math.log(2)))},global$1.nextPowerOfTwo=GL$1.nextPowerOfTwo=function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)))};var typed_arrays=[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array];function typedToArray(){return Array.prototype.slice.call(this)}typed_arrays.forEach(function(e){e.prototype.toJSON||Object.defineProperty(e.prototype,"toJSON",{value:typedToArray,enumerable:!1,configurable:!0,writable:!0})}),typeof performance<"u"?global$1.getTime=performance.now.bind(performance):global$1.getTime=Date.now.bind(Date),GL$1.getTime=global$1.getTime,global$1.isFunction=function(t){return!!(t&&t.constructor&&t.call&&t.apply)},global$1.isArray=function(t){return t&&t.constructor===Array},global$1.isNumber=function(t){return t!=null&&t.constructor===Number},global$1.getClassName=function(t){if(t){if(t.name)return t.name;if(t.toString){var r=t.toString().match(/function\s*(\w+)/);if(r&&r.length==2)return r[1]}}},global$1.cloneObject=GL$1.cloneObject=function(e,t){if(e.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";t=t||{};for(var r in e){var s=e[r];if(s===null){t[r]=null;continue}switch(s.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:t[r]=new s.constructor(s);break;case Boolean:case Number:case String:t[r]=s;break;case Array:t[r]=s.concat();break;case Object:t[r]=GL$1.cloneObject(s);break}}return t},global$1.regexMap=function(t,r,s){for(var n;(n=t.exec(r))!=null;)s(n)},global$1.createCanvas=GL$1.createCanvas=function(t,r){var s=document.createElement("canvas");return s.width=t,s.height=r,s},global$1.cloneCanvas=GL$1.cloneCanvas=function(t){var r=document.createElement("canvas");r.width=t.width,r.height=t.height;var s=r.getContext("2d");return s.drawImage(t,0,0),r},typeof Image<"u"&&(Image.prototype.getPixels=function(){var e=document.createElement("canvas");e.width=this.width,e.height=this.height;var t=e.getContext("2d");return t.drawImage(this,0,0),t.getImageData(0,0,this.width,this.height).data}),Object.prototype.hasOwnProperty.call(String.prototype,"replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(e){var t=this;for(var r in e)t=t.split(r).join(e[r]);return t},enumerable:!1}),Object.prototype.hasOwnProperty.call(String.prototype,"hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var e=0,t,r,s;if(this.length==0)return e;for(t=0,s=this.length;t<s;++t)r=this.charCodeAt(t),e=(e<<5)-e+r,e|=0;return e},enumerable:!1}),Object.prototype.hasOwnProperty.call(Array.prototype,"clone")||Object.defineProperty(Array.prototype,"clone",{value:Array.prototype.concat,enumerable:!1}),Object.prototype.hasOwnProperty.call(Float32Array.prototype,"clone")||Object.defineProperty(Float32Array.prototype,"clone",{value:function(){return new Float32Array(this)},enumerable:!1}),global$1.wipeObject=function(t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&delete t[r]},global$1.extendClass=GL$1.extendClass=function(t,r){for(var s in r)Object.prototype.hasOwnProperty.call(t,s)||(t[s]=r[s]);if(r.prototype)for(var n=Object.getOwnPropertyNames(r.prototype),s=0;s<n.length;++s){var a=n[s];Object.prototype.hasOwnProperty.call(t,a)||(r.prototype.__lookupGetter__(a)?t.prototype.__defineGetter__(a,r.prototype.__lookupGetter__(a)):t.prototype[a]=r.prototype[a],r.prototype.__lookupSetter__(a)&&t.prototype.__defineSetter__(a,r.prototype.__lookupSetter__(a)))}Object.prototype.hasOwnProperty.call(t,"superclass")||Object.defineProperty(t,"superclass",{get:function(){return r},enumerable:!1})},global$1.HttpRequest=GL$1.request=function(t,r,s,n,a){var o=!0;if(a=a||{},a.async!==void 0&&(o=a.async),r){var l=null,h=[];for(var c in r)h.push(c+"="+r[c]);l=h.join("&"),t=t+"?"+l}var u=new XMLHttpRequest;if(u.open("GET",t,o),u.responseType=a.responseType||"text",u.onload=function(p){if(this.response,this.getResponseHeader("Content-Type"),this.status!=200){LEvent.trigger(u,"fail",this.status),n&&n(this.status);return}LEvent.trigger(u,"done",this.response),s&&s(this.response)},u.onerror=function(p){LEvent.trigger(u,"fail",p)},a){for(var c in a)u[c]=a[c];a.binary&&(u.responseType="arraybuffer")}return u.send(),u},global$1.XMLHttpRequest&&(Object.prototype.hasOwnProperty.call(XMLHttpRequest.prototype,"done")||Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(e){return LEvent.bind(this,"done",function(t,r){e(r)}),this}}),Object.prototype.hasOwnProperty.call(XMLHttpRequest.prototype,"fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(e){return LEvent.bind(this,"fail",function(t,r){e(r)}),this}})),global$1.getFileExtension=function(t){var r=t.indexOf("?");r!=-1&&(t=t.substr(0,r));var s=t.lastIndexOf(".");return s==-1?"":t.substr(s+1).toLowerCase()},global$1.loadFileAtlas=GL$1.loadFileAtlas=function(t,r,s){var n=null;return global$1.HttpRequest(t,null,function(a){var o=GL$1.processFileAtlas(a);r&&r(o),n&&n(o)},alert,s),{done:function(a){n=a}}},global$1.processFileAtlas=GL$1.processFileAtlas=function(e,t){for(var r=e.split(`
`),s={},n=[],a="",o=0,l=r.length;o<l;o++){var h=t?r[o]:r[o].trim();if(h.length){if(h[0]!="\\"){n.push(h);continue}n.length&&(s[a]=n.join(`
`)),n.length=0,a=h.substr(1)}}return n.length&&(s[a]=n.join(`
`)),s},global$1.typedArrayToArray=function(e){var t=[];t.length=e.length;for(var r=0;r<e.length;r++)t[r]=e[r];return t},global$1.RGBToHex=function(e,t,r){return e=Math.min(255,e*255)|0,t=Math.min(255,t*255)|0,r=Math.min(255,r*255)|0,"#"+((1<<24)+(e<<16)+(t<<8)+r).toString(16).slice(1)},global$1.HUEToRGB=function(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+(t-e)*6*r:r<1/2?t:r<2/3?e+(t-e)*(2/3-r)*6:e},global$1.HSLToRGB=function(e,t,r,s){var n,a,o;if(s=s||vec3.create(),t==0)n=a=o=r;else{var l=r<.5?r*(1+t):r+t-r*t,h=2*r-l;n=global$1.HUEToRGB(h,l,e+1/3),a=global$1.HUEToRGB(h,l,e),o=global$1.HUEToRGB(h,l,e-1/3)}return s[0]=n,s[1]=a,s[2]=o,s},global$1.hexColorToRGBA=function(){var e={white:[1,1,1],black:[0,0,0],gray:[.501960813999176,.501960813999176,.501960813999176],red:[1,0,0],orange:[1,.6470588445663452,0],pink:[1,.7529411911964417,.7960784435272217],green:[0,.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[.9333333373069763,.5098039507865906,.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[.6470588445663452,.16470588743686676,.16470588743686676],silver:[.7529411911964417,.7529411911964417,.7529411911964417],gold:[1,.843137264251709,0],transparent:[0,0,0,0]};return function(t,r,s){if(s=s===void 0?1:s,r=r||new Float32Array(4),r[3]=s,typeof t!="string")return r;var n=e[t];if(n!==void 0)return r.set(n),r.length==3?r[3]=s:r[3]*=s,r;var o=t.indexOf("rgba(");if(o!=-1){var a=t.substr(5,t.length-2);return a=a.split(","),r[0]=parseInt(a[0])/255,r[1]=parseInt(a[1])/255,r[2]=parseInt(a[2])/255,r[3]=parseFloat(a[3])*s,r}var o=t.indexOf("hsla(");if(o!=-1){var a=t.substr(5,t.length-2);return a=a.split(","),global$1.HSLToRGB(parseInt(a[0])/360,parseInt(a[1])/100,parseInt(a[2])/100,r),r[3]=parseFloat(a[3])*s,r}r[3]=s;var o=t.indexOf("rgb(");if(o!=-1){var a=t.substr(4,t.length-2);return a=a.split(","),r[0]=parseInt(a[0])/255,r[1]=parseInt(a[1])/255,r[2]=parseInt(a[2])/255,r}var o=t.indexOf("hsl(");if(o!=-1){var a=t.substr(4,t.length-2);return a=a.split(","),global$1.HSLToRGB(parseInt(a[0])/360,parseInt(a[1])/100,parseInt(a[2])/100,r),r}var l=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(l,function(c,u,p,f){return u+u+p+p+f+f});var h=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return h&&(r[0]=parseInt(h[1],16)/255,r[1]=parseInt(h[2],16)/255,r[2]=parseInt(h[3],16)/255),r}}(),global$1.toHalfFloat=function(){var e=new Float32Array(1),t=new Int32Array(e.buffer);return function(s){e[0]=s;var n=t[0],a=n>>16&32768,o=(n&2147483647)+4096;return o>=1199570944?(n&2147483647)>=1199570944?o<2139095040?a|31744:a|31744|(n&8388607)>>13:a|31743:o>=947912704?a|o-939524096>>13:o<855638016?a:(o=(n&2147483647)>>23,a|(n&8388607|8388608)+(8388608>>>o-102)>>126-o)}}();var DDS=function(){var e=542327876,t=131072,r=512,s=4;function n(N){return N.charCodeAt(0)+(N.charCodeAt(1)<<8)+(N.charCodeAt(2)<<16)+(N.charCodeAt(3)<<24)}function a(N){return String.fromCharCode(N&255,N>>8&255,N>>16&255,N>>24&255)}var o=n("DXT1"),l=n("DXT3"),h=n("DXT5"),c=31,u=0,p=1,f=2,d=3,g=4,m=7,b=20,E=21,L=27;function T(N,k,B,S){for(var U=new Uint16Array(4),W=new Uint16Array(B*S),z=0,q=0,Y=0,H=0,Z=0,oe=0,ue=0,he=0,se=0,ve=B/4,fe=S/4,me=0;me<fe;me++)for(var Ae=0;Ae<ve;Ae++)Y=k+4*(me*ve+Ae),U[0]=N[Y],U[1]=N[Y+1],H=U[0]&31,Z=U[0]&2016,oe=U[0]&63488,ue=U[1]&31,he=U[1]&2016,se=U[1]&63488,U[2]=5*H+3*ue>>3|5*Z+3*he>>3&2016|5*oe+3*se>>3&63488,U[3]=5*ue+3*H>>3|5*he+3*Z>>3&2016|5*se+3*oe>>3&63488,z=N[Y+2],q=me*4*B+Ae*4,W[q]=U[z&3],W[q+1]=U[z>>2&3],W[q+2]=U[z>>4&3],W[q+3]=U[z>>6&3],q+=B,W[q]=U[z>>8&3],W[q+1]=U[z>>10&3],W[q+2]=U[z>>12&3],W[q+3]=U[z>>14],z=N[Y+3],q+=B,W[q]=U[z&3],W[q+1]=U[z>>2&3],W[q+2]=U[z>>4&3],W[q+3]=U[z>>6&3],q+=B,W[q]=U[z>>8&3],W[q+1]=U[z>>10&3],W[q+2]=U[z>>12&3],W[q+3]=U[z>>14];return W}function _(N){for(var k=0,B=N.length,S=0;k<B;k+=4)S=N[k],N[k]=N[k+2],N[k+2]=S}function I(N,k,B,S){var U=new Int32Array(B,0,c),W,z,q,Y,H,Z,oe,ue,he,se,ve,fe,me;if(U[u]!=e)return console.error("Invalid magic number in DDS header"),0;if(!U[b]&s)return console.error("Unsupported format, must contain a FourCC code"),0;switch(W=U[E],W){case o:z=8,q=k?k.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case l:z=16,q=k?k.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case h:z=16,q=k?k.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:z=4,W=null,q=N.RGBA}if(ve=1,U[f]&t&&S!==!1&&(ve=Math.max(1,U[m])),Y=U[g],H=U[d],oe=U[p]+4,ue=!!(U[L+1]&r),ue)for(me=0;me<6;++me){Y=U[g],H=U[d];for(var fe=0;fe<ve;++fe)W?(Z=Math.max(4,Y)/4*Math.max(4,H)/4*z,se=new Uint8Array(B,oe,Z),N.compressedTexImage2D(N.TEXTURE_CUBE_MAP_POSITIVE_X+me,fe,q,Y,H,0,se)):(N.pixelStorei(N.UNPACK_FLIP_Y_WEBGL,!1),Z=Y*H*z,se=new Uint8Array(B,oe,Z),_(se),N.texImage2D(N.TEXTURE_CUBE_MAP_POSITIVE_X+me,fe,q,Y,H,0,N.RGBA,N.UNSIGNED_BYTE,se)),oe+=Z,Y*=.5,H*=.5}else if(k){N.pixelStorei(N.UNPACK_FLIP_Y_WEBGL,!0);for(var fe=0;fe<ve;++fe)W?(Z=Math.max(4,Y)/4*Math.max(4,H)/4*z,se=new Uint8Array(B,oe,Z),N.compressedTexImage2D(N.TEXTURE_2D,fe,q,Y,H,0,se)):(Z=Y*H*z,se=new Uint8Array(B,oe,Z),_(se),N.texImage2D(N.TEXTURE_2D,fe,q,Y,H,0,q,N.UNSIGNED_BYTE,se)),oe+=Z,Y*=.5,H*=.5}else if(W==o)Z=Math.max(4,Y)/4*Math.max(4,H)/4*z,se=new Uint16Array(B),he=T(se,oe/2,Y,H),N.texImage2D(N.TEXTURE_2D,0,N.RGB,Y,H,0,N.RGB,N.UNSIGNED_SHORT_5_6_5,he),S&&N.generateMipmap(N.TEXTURE_2D);else return console.error("No manual decoder for",a(W),"and no native support"),0;return ve}function A(N,k,B){var S=new Int32Array(N,0,c),U,W,z,q,Y,H,Z,oe,ue,he,se,ve;if(S[u]!=e)return console.error("Invalid magic number in DDS header"),0;if(!S[b]&s)return console.error("Unsupported format, must contain a FourCC code"),0;switch(U=S[E],U){case o:W=8,z="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case l:W=16,z="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case h:W=16,z="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:W=4,z="RGBA"}he=1,S[f]&t&&B!==!1&&(he=Math.max(1,S[m])),q=S[g],Y=S[d],Z=S[p]+4,oe=!!(S[L+1]&r);var fe=[];if(oe)for(var ve=0;ve<6;++ve){q=S[g],Y=S[d];for(var se=0;se<he;++se)U?(H=Math.max(4,q)/4*Math.max(4,Y)/4*W,ue=new Uint8Array(N,Z,H),fe.push({tex:"TEXTURE_CUBE_MAP",face:ve,mipmap:se,internalFormat:z,width:q,height:Y,offset:0,dataOffset:Z,dataLength:H})):(H=q*Y*W,ue=new Uint8Array(N,Z,H),_(ue),fe.push({tex:"TEXTURE_CUBE_MAP",face:ve,mipmap:se,internalFormat:z,width:q,height:Y,offset:0,type:"UNSIGNED_BYTE",dataOffset:Z,dataLength:H})),Z+=H,q*=.5,Y*=.5}else for(var se=0;se<he;++se)H=Math.max(4,q)/4*Math.max(4,Y)/4*W,ue=new Uint8Array(N,Z,H),fe.push({tex:"TEXTURE_2D",mipmap:se,internalFormat:z,width:q,height:Y,offset:0,type:"UNSIGNED_BYTE",dataOffset:Z,dataLength:H}),Z+=H,q*=.5,Y*=.5;return fe}function M(N,k,B,S,U,W){var z=new XMLHttpRequest;return z.open("GET",B,!0),z.responseType="arraybuffer",z.onload=function(){if(this.status==200){var q=new Int32Array(this.response,0,c),Y=!!(q[L+1]&r),H=Y?N.TEXTURE_CUBE_MAP:N.TEXTURE_2D;N.bindTexture(H,S);var Z=I(N,k,this.response,U);N.texParameteri(H,N.TEXTURE_MAG_FILTER,N.LINEAR),N.texParameteri(H,N.TEXTURE_MIN_FILTER,Z>1?N.LINEAR_MIPMAP_LINEAR:N.LINEAR),N.bindTexture(H,null),S.texture_type=H,S.width=q[g],S.height=q[d]}W&&W(S)},z.send(null),S}function O(N,k,B,S,U){var W=new Int32Array(B,0,c),z=!!(W[L+1]&r),q=z?N.TEXTURE_CUBE_MAP:N.TEXTURE_2D;S.handler,N.bindTexture(q,S.handler);var Y=I(N,k,B,U);return N.texParameteri(q,N.TEXTURE_MAG_FILTER,N.LINEAR),N.texParameteri(q,N.TEXTURE_MIN_FILTER,Y>1?N.LINEAR_MIPMAP_LINEAR:N.LINEAR),z&&(N.texParameteri(q,N.TEXTURE_WRAP_S,N.CLAMP_TO_EDGE),N.texParameteri(q,N.TEXTURE_WRAP_T,N.CLAMP_TO_EDGE)),N.bindTexture(q,null),S.handler&&(S.texture_type=q,S.width=W[g],S.height=W[d]),S}function C(N){var k=new Int32Array(N,0,c),B=!!(k[L+1]&r),S=B?"TEXTURE_CUBE_MAP":"TEXTURE_2D",U=A(N),W={type:S,buffers:U,data:N,width:k[g],height:k[d]};return W}function P(N,W,B,S){var U=N.createTexture(),W=N.getExtension("WEBGL_compressed_texture_s3tc");return M(N,W,B,U,!0,S),U}return{dxtToRgb565:T,uploadDDSLevels:I,loadDDSTextureEx:M,loadDDSTexture:P,loadDDSTextureFromMemoryEx:O,getDDSTextureFromMemoryEx:C}}();if(typeof global$1<"u"&&(global$1.DDS=DDS),typeof glMatrix>"u"&&typeof exports<"u"&&typeof process<"u"&&exports.vec3)for(var i$1 in exports)global$1[i$1]=exports[i$1];Math.clamp=function(e,t,r){return t>e?t:r<e?r:e},Math.lerp=function(e,t,r){return e*(1-r)+t*r},Math.lerp01=function(e,t,r){return Math.clamp(e*(1-r)+t*r,0,1)},Math.iLerp=function(e,t,r){return(r-e)/(t-e)},Math.remap=function(e,t,r,s,n){return Math.lerp(s,n,Math.iLerp(t,r,e))},vec3.create,vec3.create,vec3.ZERO=vec3.fromValues(0,0,0),vec3.FRONT=vec3.fromValues(0,0,-1),vec3.UP=vec3.fromValues(0,1,0),vec3.RIGHT=vec3.fromValues(1,0,0),vec2.rotate=function(e,t,r){var s=t[0],n=t[1],a=Math.cos(r),o=Math.sin(r);return e[0]=s*a-n*o,e[1]=s*o+n*a,e},vec3.zero=function(e){return e[0]=e[1]=0,e},vec2.perpdot=function(e,t){return e[1]*t[0]+-e[0]*t[1]},vec2.computeSignedAngle=function(e,t){return Math.atan2(vec2.perpdot(e,t),vec2.dot(e,t))},vec2.random=function(e,t){return t=t||1,e[0]=Math.random()*t,e[1]=Math.random()*t,e},vec3.zero=function(e){return e[0]=e[1]=e[2]=0,e},vec3.minValue=function(e){return e[0]<e[1]&&e[0]<e[2]?e[0]:e[1]<e[2]?e[1]:e[2]},vec3.maxValue=function(e){return e[0]>e[1]&&e[0]>e[2]?e[0]:e[1]>e[2]?e[1]:e[2]},vec3.minValue=function(e){return e[0]<e[1]&&e[0]<e[2]?e[0]:e[1]<e[2]?e[1]:e[2]},vec3.addValue=function(e,t,r){e[0]=t[0]+r,e[1]=t[1]+r,e[2]=t[2]+r},vec3.subValue=function(e,t,r){e[0]=t[0]-r,e[1]=t[1]-r,e[2]=t[2]-r},vec3.toArray=function(e){return[e[0],e[1],e[2]]},vec3.rotateX=function(e,t,r){var s=t[1],n=t[2],a=Math.cos(r),o=Math.sin(r);return e[0]=t[0],e[1]=s*a-n*o,e[2]=s*o+n*a,e},vec3.rotateY=function(e,t,r){var s=t[0],n=t[2],a=Math.cos(r),o=Math.sin(r);return e[0]=s*a-n*o,e[1]=t[1],e[2]=s*o+n*a,e},vec3.rotateZ=function(e,t,r){var s=t[0],n=t[1],a=Math.cos(r),o=Math.sin(r);return e[0]=s*a-n*o,e[1]=s*o+n*a,e[2]=t[2],e},vec3.angle=function(e,t){return Math.acos(vec3.dot(e,t))},vec3.signedAngle=function(e,t,r){var s=vec3.angle(e,t),n=e[1]*t[2]-e[2]*t[1],a=e[2]*t[0]-e[0]*t[2],o=e[0]*t[1]-e[1]*t[0],l=Math.sign(r[0]*n+r[1]*a+r[2]*o);return s*l},vec3.random=function(e,t){return t=t||1,e[0]=Math.random()*t,e[1]=Math.random()*t,e[2]=Math.random()*t,e},vec3.cartesianToPolar=function(e,t){e=e||vec3.create();var r=t[0],s=t[1],n=t[2];return e[0]=Math.sqrt(r*r+s*s+n*n),e[1]=Math.asin(s/e[0]),e[2]=Math.atan2(r,n),e},vec3.polarToCartesian=function(e,t){var r=t[0],s=t[1],n=t[2];return e[0]=r*Math.cos(s)*Math.sin(n),e[1]=r*Math.sin(s),e[2]=r*Math.cos(s)*Math.cos(n),e},vec3.reflect=function(e,t,r){var s=t[0],n=t[1],a=t[2];return vec3.scale(e,r,-2*vec3.dot(t,r)),e[0]+=s,e[1]+=n,e[2]+=a,e},vec4.random=function(e,t){return t=t||1,e[0]=Math.random()*t,e[1]=Math.random()*t,e[2]=Math.random()*t,e[3]=Math.random()*t,e},vec4.toArray=function(e){return[e[0],e[1],e[2],e[3]]},mat3.IDENTITY=mat3.create(),mat4.IDENTITY=mat4.create(),mat4.toArray=function(e){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]},mat4.setUpAndOrthonormalize=function(e,t,r){t!=e&&mat4.copy(e,t);var s=e.subarray(0,3);vec3.normalize(e.subarray(4,7),r);var n=e.subarray(8,11);vec3.cross(s,r,n),vec3.normalize(s,s),vec3.cross(n,s,r),vec3.normalize(n,n)},mat4.multiplyVec3=function(e,t,r){var s=r[0],n=r[1],a=r[2];return e[0]=t[0]*s+t[4]*n+t[8]*a+t[12],e[1]=t[1]*s+t[5]*n+t[9]*a+t[13],e[2]=t[2]*s+t[6]*n+t[10]*a+t[14],e},mat4.projectVec3=function(e,t,r){var s=r[0],n=r[1],a=r[2],o=t[0]*s+t[4]*n+t[8]*a+t[12],l=t[1]*s+t[5]*n+t[9]*a+t[13],h=t[2]*s+t[6]*n+t[10]*a+t[14],c=t[3]*s+t[7]*n+t[11]*a+t[15];return e[0]=(o/c+1)/2,e[1]=(l/c+1)/2,e[2]=(h/c+1)/2,e},vec3.project=function(e,t,r,s){s=s||gl.viewport_data;var n=r,a=t[0],o=t[1],l=t[2],h=n[0]*a+n[4]*o+n[8]*l+n[12],c=n[1]*a+n[5]*o+n[9]*l+n[13],u=n[2]*a+n[6]*o+n[10]*l+n[14],p=n[3]*a+n[7]*o+n[11]*l+n[15],f=(h/p+1)/2,d=1-(c/p+1)/2,g=(u/p+1)/2;return e[0]=f*s[2]+s[0],e[1]=d*s[3]+s[1],e[2]=g,e};var unprojectMat=mat4.create(),unprojectVec=vec4.create();vec3.unproject=function(e,t,r,s){var n=unprojectMat,a=unprojectVec;return a[0]=(t[0]-s[0])*2/s[2]-1,a[1]=(t[1]-s[1])*2/s[3]-1,a[2]=2*t[2]-1,a[3]=1,!mat4.invert(n,r)||(vec4.transformMat4(a,a,n),a[3]===0)?null:(e[0]=a[0]/a[3],e[1]=a[1]/a[3],e[2]=a[2]/a[3],e)},mat4.rotateVec3=function(e,t,r){var s=r[0],n=r[1],a=r[2];return e[0]=t[0]*s+t[4]*n+t[8]*a,e[1]=t[1]*s+t[5]*n+t[9]*a,e[2]=t[2]*s+t[6]*n+t[10]*a,e},mat4.fromTranslationFrontTop=function(e,t,r,s){return vec3.cross(e.subarray(0,3),r,s),e.set(s,4),e.set(r,8),e.set(t,12),e},mat4.translationMatrix=function(e){var t=mat4.create();return t[12]=e[0],t[13]=e[1],t[14]=e[2],t},mat4.setTranslation=function(e,t){return e[12]=t[0],e[13]=t[1],e[14]=t[2],e},mat4.getTranslation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},mat4.toRotationMat4=function(e,t){return mat4.copy(e,t),e[12]=e[13]=e[14]=0,e},mat4.swapRows=function(e,t,r,s,n){if(e!=t)return mat4.copy(e,t),e[4*r]=t[4*s],e[4*r+1]=t[4*s+1],e[4*r+2]=t[4*s+2],e[4*r+3]=t[4*s+3],e[4*s]=t[4*r],e[4*s+1]=t[4*r+1],e[4*s+2]=t[4*r+2],e[4*s+3]=t[4*r+3],e;var a=new Float32Array(n.subarray(r*4,r*5));return n.set(n.subarray(s*4,s*5),r*4),n.set(a,s*4),e},mat4.scaleAndAdd=function(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e[3]=t[3]+r[3]*s,e[4]=t[4]+r[4]*s,e[5]=t[5]+r[5]*s,e[6]=t[6]+r[6]*s,e[7]=t[7]+r[7]*s,e[8]=t[8]+r[8]*s,e[9]=t[9]+r[9]*s,e[10]=t[10]+r[10]*s,e[11]=t[11]+r[11]*s,e[12]=t[12]+r[12]*s,e[13]=t[13]+r[13]*s,e[14]=t[14]+r[14]*s,e[15]=t[15]+r[15]*s,e},quat.fromAxisAngle=function(e,t){var r=quat.create();t=t*.5;var s=Math.sin(t);return r[0]=s*e[0],r[1]=s*e[1],r[2]=s*e[2],r[3]=Math.cos(t),r},quat.lookRotation=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s,n,a){vec3.normalize(e,n),vec3.cross(t,a,e),vec3.normalize(t,t),vec3.cross(r,e,t);var o=t[0],l=t[1],h=t[2],c=r[0],u=r[1],p=r[2],f=e[0],d=e[1],g=e[2],m=o+u+g;if(m>0){var b=Math.sqrt(m+1);return s[3]=b*.5,b=.5/b,s[0]=(p-d)*b,s[1]=(f-h)*b,s[2]=(l-c)*b,s}if(o>=u&&o>=g){var E=Math.sqrt(1+o-u-g),L=.5/E;return s[0]=.5*E,s[1]=(l+c)*L,s[2]=(h+f)*L,s[3]=(p-d)*L,s}if(u>g){var T=Math.sqrt(1+u-o-g),_=.5/T;return s[0]=(c+l)*_,s[1]=.5*T,s[2]=(d+p)*_,s[3]=(f-h)*_,s}var I=Math.sqrt(1+g-o-u),A=.5/I;return s[0]=(f+h)*A,s[1]=(d+p)*A,s[2]=.5*I,s[3]=(l-c)*A,s}}(),quat.toEuler=function(e,t){var r=Math.atan2(2*t[1]*t[3]-2*t[0]*t[2],1-2*t[1]*t[1]-2*t[2]*t[2]),s=Math.asin(2*t[0]*t[1]+2*t[2]*t[3]),n=Math.atan2(2*t[0]*t[3]-2*t[1]*t[2],1-2*t[0]*t[0]-2*t[2]*t[2]);return e||(e=vec3.create()),vec3.set(e,r,s,n),e},quat.fromEuler=function(e,t){var r=t[0],s=t[1],n=t[2],a=Math.cos(r),o=Math.cos(s),l=Math.cos(n),h=Math.sin(r),c=Math.sin(s),u=Math.sin(n),p=Math.sqrt(1+a*o+a*l-h*c*u+o*l)*.5;p==0&&(p=1e-6);var f=(o*u+a*u+h*c*l)/(4*p),d=(h*o+h*l+a*c*u)/(4*p),g=(-h*u+a*c*l+c)/(4*p);return quat.set(e,f,d,g,p),quat.normalize(e,e),e},quat.fromMat4=function(e,t){var r=t[0]+t[5]+t[10];if(r>0){var s=Math.sqrt(r+1);e[3]=s*.5;var n=.5/s;e[0]=(t[9]-t[6])*n,e[1]=(t[8]-t[2])*n,e[2]=(t[4]-t[1])*n}else{var a=0;t[5]>t[0]&&(a=1),t[10]>t[a*4+a]&&(a=2);var o=(a+1)%3,l=(o+1)%3,s=Math.sqrt(t[a*4+a]-t[o*4+o]-t[l*4+l]+1);e[a]=.5*s;var n=.5/s;e[3]=(t[l*4+o]-t[o*4+l])*n,e[o]=(t[o*4+a]+t[a*4+o])*n,e[l]=(t[l*4+a]+t[a*4+l])*n}quat.normalize(e,e)},vec3.getMat3Column=function(e,t,r){return e[0]=t[r*3],e[1]=t[r*3+1],e[2]=t[r*3+2],e},mat3.setColumn=function(e,t,r){return e[r*3]=t[0],e[r*3+1]=t[1],e[r*3+2]=t[2],e},quat.fromMat3AndQuat=function(){var e=mat3.create(),t=quat.create(),r=vec3.create(),s=vec3.create(),n=vec3.create(),a=vec3.create(),o=vec3.create(),l=vec3.create(),h=vec3.create(),c=vec3.create(),u=vec3.create(),p=vec3.create();return mat3.create(),function(f,d,g){g=g||25;for(var m=0;m<g;++m){var b=mat3.fromQuat(e,f);vec3.getMat3Column(r,b,0),vec3.getMat3Column(s,b,1),vec3.getMat3Column(n,b,2),vec3.getMat3Column(a,d,0),vec3.getMat3Column(o,d,1),vec3.getMat3Column(l,d,2),vec3.cross(h,r,a),vec3.cross(c,s,o),vec3.cross(u,n,l),vec3.add(p,h,c),vec3.add(p,p,u);var E=1/Math.abs(vec3.dot(r,a)+vec3.dot(s,o)+vec3.dot(n,l))+1e-9;vec3.scale(p,p,E);var L=vec3.length(p);if(L<1e-9)break;vec3.scale(p,p,1/L),quat.setAxisAngle(t,p,L),quat.mul(f,t,f),quat.normalize(f,f)}return f}}(),quat.rotateToFrom=function(){var e=vec3.create();return function(t,r,s){t=t||quat.create();var n=vec3.cross(e,r,s),a=vec3.dot(r,s);return a<-1+.01?(t[0]=0,t[1]=1,t[2]=0,t[3]=0,t):(t[0]=n[0]*.5,t[1]=n[1]*.5,t[2]=n[2]*.5,t[3]=(1+a)*.5,quat.normalize(t,t),t)}}(),quat.lookAt=function(){var e=vec3.create();return function(t,r,s){var n=vec3.dot(vec3.FRONT,r);if(Math.abs(n- -1)<1e-6)return t.set(vec3.UP),t[3]=Math.PI,t;if(Math.abs(n-1)<1e-6)return quat.identity(t);var a=Math.acos(n);return vec3.cross(e,vec3.FRONT,r),vec3.normalize(e,e),quat.setAxisAngle(t,e,a),t}}(),GL$1.Indexer=function(){this.unique=[],this.indices=[],this.map={}},GL$1.Indexer.prototype={add:function(e){var t=JSON.stringify(e);return t in this.map||(this.map[t]=this.unique.length,this.unique.push(e)),this.map[t]}},GL$1.Buffer=function(t,r,s,n,a){GL$1.debug&&console.log("GL.Buffer created"),a!==null&&(a=a||global$1.gl),this.gl=a,this.buffer=null,this.target=t,this.attribute=null,this.normalize=!1,this.data=r,this.spacing=s||3,this.data&&this.gl&&this.upload(n)},GL$1.Buffer.prototype.bind=function(e,t){t=t||this.gl,t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,this.spacing,this.buffer.gl_type,this.normalize||!1,0,0)},GL$1.Buffer.prototype.unbind=function(e,t){t=t||this.gl,t.disableVertexAttribArray(e)},GL$1.Buffer.prototype.forEach=function(e){for(var t=this.data,r=0,s=this.spacing,n=t.length;r<n;r+=s)e(t.subarray(r,r+s),r);return this},GL$1.Buffer.prototype.applyTransform=function(e){for(var t=this.data,r=0,s=this.spacing,n=t.length;r<n;r+=s){var a=t.subarray(r,r+s);vec3.transformMat4(a,a,e)}return this},GL$1.Buffer.prototype.upload=function(e){var t=this.spacing||3,r=this.gl;if(r){if(!this.data)throw"No data supplied";var s=this.data;if(!s.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||r.createBuffer(),!!this.buffer){switch(this.buffer.length=s.length,this.buffer.spacing=t,s.constructor){case Int8Array:this.buffer.gl_type=r.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=r.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=r.SHORT;break;case Uint16Array:this.buffer.gl_type=r.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=r.INT;break;case Uint32Array:this.buffer.gl_type=r.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=r.FLOAT;break;default:throw"unsupported buffer type"}this.target==r.ARRAY_BUFFER&&(this.buffer.gl_type==r.INT||this.buffer.gl_type==r.UNSIGNED_INT)&&(console.warn("WebGL does not support UINT32 or INT32 as vertex buffer types, converting to FLOAT"),this.buffer.gl_type=r.FLOAT,s=new Float32Array(s)),r.bindBuffer(this.target,this.buffer),r.bufferData(this.target,s,e||this.stream_type||r.STATIC_DRAW)}}},GL$1.Buffer.prototype.compile=GL$1.Buffer.prototype.upload,GL$1.Buffer.prototype.setData=function(e,t){if(!e.buffer)throw"Data must be typed array";if(t=t||0,this.data){if(this.data.length<e.length)throw"buffer is not big enough, you cannot set data to a smaller buffer"}else{this.data=e,this.upload();return}if(this.data!=e){if(this.data.length==e.length){this.data.set(e),this.upload();return}var r=new Uint8Array(e.buffer,e.buffer.byteOffset,e.buffer.byteLength),s=new Uint8Array(this.data.buffer);s.set(r,t),this.uploadRange(t,r.length)}},GL$1.Buffer.prototype.uploadRange=function(e,t){if(!this.data)throw"No data stored in this buffer";var r=this.data;if(!r.buffer)throw"Buffers must be typed arrays";var s=new Uint8Array(this.data.buffer,e,t),n=this.gl;n.bindBuffer(this.target,this.buffer),n.bufferSubData(this.target,e,s)},GL$1.Buffer.prototype.clone=function(e){var t=new GL$1.Buffer;if(e)for(var r in this)t[r]=this[r];else this.target&&(t.target=this.target),this.gl&&(t.gl=this.gl),this.spacing&&(t.spacing=this.spacing),this.data&&(t.data=new global$1[this.data.constructor](this.data),t.upload());return t},GL$1.Buffer.prototype.toJSON=function(){return this.data?{data_type:global$1.getClassName(this.data),data:this.data.toJSON(),target:this.target,attribute:this.attribute,spacing:this.spacing}:(console.error("cannot serialize a mesh without data"),null)},GL$1.Buffer.prototype.fromJSON=function(e){var t=global$1[e.data_type]||Float32Array;this.data=new t(e.data),this.target=e.target,this.spacing=e.spacing||3,this.attribute=e.attribute,this.upload(GL$1.STATIC_DRAW)},GL$1.Buffer.prototype.delete=function(){var e=this.gl;e.deleteBuffer(this.buffer),this.buffer=null},global$1.Mesh=GL$1.Mesh=function(t,r,s,n){if(GL$1.debug&&console.log("GL.Mesh created"),n!==null&&(n=n||global$1.gl,this.gl=n),this.gl&&(this._context_id=this.gl.context_id),this.vertexBuffers={},this.indexBuffers={},this.info={groups:[]},this._bounding=global$1.BBox.create(),(t||r)&&this.addBuffers(t,r,s?s.stream_type:null),s)for(var a in s)this[a]=s[a]},Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal",normalize:!0},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color",normalize:!0},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights",normalize:!0},extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}},Mesh.default_datatype=Float32Array,Object.defineProperty(Mesh.prototype,"bounding",{set:function(e){if(e){if(e.length<13)throw"Bounding must use the BBox bounding format of 13 floats: center, halfsize, min, max, radius";this._bounding.set(e)}},get:function(){return this._bounding}}),Mesh.prototype.addBuffer=function(e,t){if(t.target==gl.ARRAY_BUFFER?this.vertexBuffers[e]=t:this.indexBuffers[e]=t,!t.attribute){var r=GL$1.Mesh.common_buffers[e];r&&(t.attribute=r.attribute)}},Mesh.prototype.addBuffers=function(e,t,r){var s=0;this.vertexBuffers.vertices&&(s=this.vertexBuffers.vertices.data.length/3);for(var n in e){var a=e[n];if(a){if(a.constructor==GL$1.Buffer||a.data)a=a.data;else if(typeof a[0]!="number"){for(var o=[],l=0,h=1e4;l<a.length;l+=h)o=Array.prototype.concat.apply(o,a.slice(l,l+h));a=o}var c=GL$1.Mesh.common_buffers[n];if(a.constructor===Array){var u=GL$1.Mesh.default_datatype;c&&c.type&&(u=c.type),a=new u(a)}n=="vertices"&&(s=a.length/3);var p=a.length/s;c&&c.spacing&&(p=c.spacing);var f="a_"+n;c&&c.attribute&&(f=c.attribute),this.vertexBuffers[n]?this.updateVertexBuffer(n,f,p,a,r):this.createVertexBuffer(n,f,p,a,r)}}if(t)for(var n in t){var a=t[n];if(a){if((a.constructor==GL$1.Buffer||a.data)&&(a=a.data),typeof a[0]!="number"){o=[];for(var n=0,h=1e4;n<a.length;n+=h)o=Array.prototype.concat.apply(o,a.slice(n,n+h));a=o}if(a.constructor===Array){var u=Uint16Array;s>256*256&&(u=Uint32Array),a=new u(a)}this.createIndexBuffer(n,a)}}},Mesh.prototype.createVertexBuffer=function(e,t,r,s,n){var a=GL$1.Mesh.common_buffers[e];if(!t&&a&&(t=a.attribute),!t)throw"Buffer added to mesh without attribute name";if(!r&&a&&(a&&a.spacing?r=a.spacing:r=3),!s){var o=this.getNumVertices();if(!o)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";s=new GL$1.Mesh.default_datatype(o*r)}if(!s.buffer)throw"Buffer data MUST be typed array";var l=this.vertexBuffers[e]=new GL$1.Buffer(GL$1.ARRAY_BUFFER,s,r,n,this.gl);return l.name=e,l.attribute=t,(s.constructor==Uint8Array||s.constructor==Int8Array||s.constructor==Uint16Array||s.constructor==Int16Array||s.constructor==Uint32Array||s.constructor==Int32Array)&&a&&a.normalize&&(l.normalize=!0),l},Mesh.prototype.updateVertexBuffer=function(e,t,r,s,n){var a=this.vertexBuffers[e];if(!a){console.log("buffer not found: ",e);return}s.length&&(a.attribute=t,a.spacing=r,a.data=s,a.upload(n))},Mesh.prototype.removeVertexBuffer=function(e,t){var r=this.vertexBuffers[e];r&&(t&&r.delete(),delete this.vertexBuffers[e])},Mesh.prototype.getVertexBuffer=function(e){return this.vertexBuffers[e]},Mesh.prototype.createIndexBuffer=function(e,t,r){if(t.constructor===Array){var s=Uint16Array,n=this.vertexBuffers.vertices;if(n){var a=n.data.length/3;a>256*256&&(s=Uint32Array),t=new s(t)}}var o=this.indexBuffers[e]=new GL$1.Buffer(GL$1.ELEMENT_ARRAY_BUFFER,t,0,r,this.gl);return o},Mesh.prototype.getBuffer=function(e){return this.vertexBuffers[e]},Mesh.prototype.getIndexBuffer=function(e){return this.indexBuffers[e]},Mesh.prototype.removeIndexBuffer=function(e,t){var r=this.indexBuffers[e];r&&(t&&r.delete(),delete this.indexBuffers[e])},Mesh.prototype.upload=function(e){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t];r.upload(e)}for(var s in this.indexBuffers){var r=this.indexBuffers[s];r.upload()}},Mesh.prototype.compile=Mesh.prototype.upload,Mesh.prototype.deleteBuffers=function(){for(var e in this.vertexBuffers){var t=this.vertexBuffers[e];t.delete()}this.vertexBuffers={};for(var e in this.indexBuffers){var t=this.indexBuffers[e];t.delete()}this.indexBuffers={}},Mesh.prototype.delete=Mesh.prototype.deleteBuffers,Mesh.prototype.bindBuffers=function(e){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t],s=r.attribute||t,n=e.attributes[s];n==null||!r.buffer||(gl.bindBuffer(gl.ARRAY_BUFFER,r.buffer),gl.enableVertexAttribArray(n),gl.vertexAttribPointer(n,r.buffer.spacing,r.buffer.gl_type,r.normalize||!1,0,0))}},Mesh.prototype.unbindBuffers=function(e){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t],s=r.attribute||t,n=e.attributes[s];n==null||!r.buffer||gl.disableVertexAttribArray(e.attributes[s])}},Mesh.prototype.clone=function(t){var t=t||global$1.gl,r={},s={};for(var n in this.vertexBuffers){var a=this.vertexBuffers[n];r[n]=new a.data.constructor(a.data)}for(var n in this.indexBuffers){var a=this.indexBuffers[n];s[n]=new a.data.constructor(a.data)}return new GL$1.Mesh(r,s,void 0,t)},Mesh.prototype.cloneShared=function(t){var t=t||global$1.gl;return new GL$1.Mesh(this.vertexBuffers,this.indexBuffers,void 0,t)},Mesh.prototype.toObject=function(){var e={},t={};for(var r in this.vertexBuffers){var s=this.vertexBuffers[r];e[r]={spacing:s.spacing,data:new s.data.constructor(s.data)}}for(var r in this.indexBuffers){var s=this.indexBuffers[r];t[r]={data:new s.data.constructor(s.data)}}return{vertexBuffers:e,indexBuffers:t,info:this.info?global$1.cloneObject(this.info):null,bounding:this._bounding.toJSON()}},Mesh.prototype.toJSON=function(){var e={vertexBuffers:{},indexBuffers:{},info:this.info?global$1.cloneObject(this.info):null,bounding:this._bounding.toJSON()};for(var t in this.vertexBuffers)e.vertexBuffers[t]=this.vertexBuffers[t].toJSON();for(var t in this.indexBuffers)e.indexBuffers[t]=this.indexBuffers[t].toJSON();return e},Mesh.prototype.fromJSON=function(e){this.vertexBuffers={},this.indexBuffers={};for(var t in e.vertexBuffers)if(e.vertexBuffers[t]){var r=new GL$1.Buffer;r.fromJSON(e.vertexBuffers[t]),!r.attribute&&GL$1.Mesh.common_buffers[t]&&(r.attribute=GL$1.Mesh.common_buffers[t].attribute),this.vertexBuffers[t]=r}for(var t in e.indexBuffers)if(e.indexBuffers[t]){var r=new GL$1.Buffer;r.fromJSON(e.indexBuffers[t]),this.indexBuffers[t]=r}e.info&&(this.info=global$1.cloneObject(e.info)),e.bounding&&(this.bounding=e.bounding)},Mesh.prototype.generateMetadata=function(){var e={},t=this.vertexBuffers.vertices.data,r=this.indexBuffers.triangles.data;e.vertices=t.length/3,r?e.faces=r.length/3:e.faces=t.length/9,e.indexed=!!this.metadata.faces,this.metadata=e},Mesh.prototype.computeWireframe=function(){var e=this.indexBuffers.triangles,t=this.vertexBuffers.vertices.data,r=t.length/3;if(e){for(var o=e.data,l=new GL$1.Indexer,a=0;a<o.length;a+=3)for(var h=o.subarray(a,a+3),c=0;c<h.length;c++){var u=h[c],p=h[(c+1)%h.length];l.add([Math.min(u,p),Math.max(u,p)])}for(var f=l.unique,n=r>256*256?new Uint32Array(f.length*2):new Uint16Array(f.length*2),a=0,d=f.length;a<d;++a)n.set(f[a],a*2)}else for(var s=r/3,n=r>256*256?new Uint32Array(s*6):new Uint16Array(s*6),a=0;a<r;a+=3)n[a*2]=a,n[a*2+1]=a+1,n[a*2+2]=a+1,n[a*2+3]=a+2,n[a*2+4]=a+2,n[a*2+5]=a;return this.createIndexBuffer("wireframe",n),this},Mesh.prototype.flipNormals=function(e){var t=this.vertexBuffers.normals;if(t){for(var n=t.data,a=n.length,r=0;r<a;++r)n[r]*=-1;t.upload(e),this.indexBuffers.triangles||this.computeIndices();for(var s=this.indexBuffers.triangles,n=s.data,a=n.length,r=0;r<a;r+=3){var o=n[r];n[r]=n[r+1],n[r+1]=o}s.upload(e)}},Mesh.prototype.computeIndices=function(){var e=[],t=[],r=[],s=[],n=this.vertexBuffers.vertices,a=this.vertexBuffers.normals,o=this.vertexBuffers.coords,l=n.data,h=null;a&&(h=a.data);var c=null;o&&(c=o.data);for(var u={},p=l.length/3,f=0;f<p;++f){var d=l.subarray(f*3,(f+1)*3),g=d[0]*1e3|0,m=0,b=u[g];if(b)for(var E=b.length;m<E;m++){var L=e[b[m]];if(vec3.sqrDist(d,L)<.01){s.push(m);break}}if(!(b&&m!=E)){var T=m;e.push(d),u[g]?u[g].push(T):u[g]=[T],h&&t.push(h.subarray(f*3,(f+1)*3)),c&&r.push(c.subarray(f*2,(f+1)*2)),s.push(T)}}this.vertexBuffers={},this.createVertexBuffer("vertices",GL$1.Mesh.common_buffers.vertices.attribute,3,linearizeArray(e)),h&&this.createVertexBuffer("normals",GL$1.Mesh.common_buffers.normals.attribute,3,linearizeArray(t)),c&&this.createVertexBuffer("coords",GL$1.Mesh.common_buffers.coords.attribute,2,linearizeArray(r)),this.createIndexBuffer("triangles",s)},Mesh.prototype.explodeIndices=function(e){e=e||"triangles";var t=this.getIndexBuffer(e);if(t){var r=t.data,s={};for(var n in this.vertexBuffers){var a=GL$1.Mesh.common_buffers[n];s[n]=new(a.type||Float32Array)(a.spacing*r.length)}for(var n=0,o=r.length;n<o;++n){var l=r[n];for(var h in this.vertexBuffers){var c=this.vertexBuffers[h],a=GL$1.Mesh.common_buffers[h],u=c.spacing||a.spacing,p=s[h];p.set(c.data.subarray(l*u,l*u+u),n*u)}}for(var n in s){var f=this.vertexBuffers[n];this.createVertexBuffer(n,f.attribute,f.spacing,s[n])}delete this.indexBuffers[e]}},Mesh.prototype.computeNormals=function(e){var t=this.vertexBuffers.vertices;if(!t)return console.error("Cannot compute normals of a mesh without vertices");var r=this.vertexBuffers.vertices.data;r.length/3;var s=new Float32Array(r.length),n=null;this.indexBuffers.triangles&&(n=this.indexBuffers.triangles.data);for(var a=GL$1.temp_vec3,o=GL$1.temp2_vec3,l,h,c,u,p,f,d,g,m,b=n?n.length:r.length,E=0;E<b;E+=3)n?(l=n[E],h=n[E+1],c=n[E+2],u=r.subarray(l*3,l*3+3),p=r.subarray(h*3,h*3+3),f=r.subarray(c*3,c*3+3),d=s.subarray(l*3,l*3+3),g=s.subarray(h*3,h*3+3),m=s.subarray(c*3,c*3+3)):(u=r.subarray(E*3,E*3+3),p=r.subarray(E*3+3,E*3+6),f=r.subarray(E*3+6,E*3+9),d=s.subarray(E*3,E*3+3),g=s.subarray(E*3+3,E*3+6),m=s.subarray(E*3+6,E*3+9)),vec3.sub(a,p,u),vec3.sub(o,f,u),vec3.cross(a,a,o),vec3.normalize(a,a),vec3.add(d,d,a),vec3.add(g,g,a),vec3.add(m,m,a);if(n)for(var E=0,b=s.length;E<b;E+=3){var L=s.subarray(E,E+3);vec3.normalize(L,L)}var T=this.vertexBuffers.normals;if(T)T.data=s,T.upload(e);else return this.createVertexBuffer("normals",GL$1.Mesh.common_buffers.normals.attribute,3,s);return T},Mesh.prototype.computeTangents=function(){var e=this.vertexBuffers.vertices;if(!e)return console.error("Cannot compute tangents of a mesh without vertices");var t=this.vertexBuffers.normals;if(!t)return console.error("Cannot compute tangents of a mesh without normals");var r=this.vertexBuffers.coords;if(!r)return console.error("Cannot compute tangents of a mesh without uvs");var s=this.indexBuffers.triangles;if(!s)return console.error("Cannot compute tangents of a mesh without indices");var n=e.data,a=t.data,o=r.data,l=s.data;if(!(!n||!a||!o)){var h=n.length/3,c=new Float32Array(h*4),u=new Float32Array(h*3*2),p=u.subarray(h*3),f,d,g=vec3.create(),m=vec3.create(),b=vec3.create(),E=vec3.create();for(f=0,d=l.length;f<d;f+=3){var L=l[f],T=l[f+1],_=l[f+2],I=n.subarray(L*3,L*3+3),A=n.subarray(T*3,T*3+3),M=n.subarray(_*3,_*3+3),O=o.subarray(L*2,L*2+2),C=o.subarray(T*2,T*2+2),P=o.subarray(_*2,_*2+2),N=A[0]-I[0],k=M[0]-I[0],B=A[1]-I[1],S=M[1]-I[1],U=A[2]-I[2],W=M[2]-I[2],z=C[0]-O[0],q=P[0]-O[0],Y=C[1]-O[1],H=P[1]-O[1],Z,oe=z*H-q*Y;Math.abs(oe)<1e-9?Z=0:Z=1/oe,vec3.copy(g,[(H*N-Y*k)*Z,(H*B-Y*S)*Z,(H*U-Y*W)*Z]),vec3.copy(m,[(z*k-q*N)*Z,(z*S-q*B)*Z,(z*W-q*U)*Z]),vec3.add(u.subarray(L*3,L*3+3),u.subarray(L*3,L*3+3),g),vec3.add(u.subarray(T*3,T*3+3),u.subarray(T*3,T*3+3),g),vec3.add(u.subarray(_*3,_*3+3),u.subarray(_*3,_*3+3),g),vec3.add(p.subarray(L*3,L*3+3),p.subarray(L*3,L*3+3),m),vec3.add(p.subarray(T*3,T*3+3),p.subarray(T*3,T*3+3),m),vec3.add(p.subarray(_*3,_*3+3),p.subarray(_*3,_*3+3),m)}for(f=0,d=n.length;f<d;f+=3){var ue=a.subarray(f,f+3),he=u.subarray(f,f+3);vec3.subtract(b,he,vec3.scale(b,ue,vec3.dot(ue,he))),vec3.normalize(b,b);var se=vec3.dot(vec3.cross(E,ue,he),p.subarray(f,f+3))<0?-1:1;c.set([b[0],b[1],b[2],se],f/3*4)}this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,c)}},Mesh.prototype.computeTextureCoordinates=function(e){var t=this.vertexBuffers.vertices;if(!t)return console.error("Cannot compute uvs of a mesh without vertices");this.explodeIndices("triangles");var r=t.data,s=r.length/3,n=this.vertexBuffers.coords,a=new Float32Array(s*2),o=this.indexBuffers.triangles,l=null;o&&(l=o.data);var h=vec3.create(),c=vec3.create(),u=vec3.create(),p=this.getBoundingBox(),f=global$1.BBox.getCenter(p),d=vec3.create();d.set(global$1.BBox.getHalfsize(p)),vec3.scale(d,d,2);for(var g=l?l.length:r.length/3,m=0;m<g;m+=3){if(l)var b=l[m],E=l[m+1],L=l[m+2],T=r.subarray(b*3,b*3+3),_=r.subarray(E*3,E*3+3),I=r.subarray(L*3,L*3+3),A=a.subarray(b*2,b*2+2),M=a.subarray(E*2,E*2+2),O=a.subarray(L*2,L*2+2);else var T=r.subarray(m*3,m*3+3),_=r.subarray((m+1)*3,(m+1)*3+3),I=r.subarray((m+2)*3,(m+2)*3+3),A=a.subarray(m*2,m*2+2),M=a.subarray((m+1)*2,(m+1)*2+2),O=a.subarray((m+2)*2,(m+2)*2+2);vec3.sub(c,T,_),vec3.sub(u,T,I),vec3.cross(h,c,u),h[0]=Math.abs(h[0]),h[1]=Math.abs(h[1]),h[2]=Math.abs(h[2]),h[0]>h[1]&&h[0]>h[2]?(A[0]=(T[2]-f[2])/d[2],A[1]=(T[1]-f[1])/d[1],M[0]=(_[2]-f[2])/d[2],M[1]=(_[1]-f[1])/d[1],O[0]=(I[2]-f[2])/d[2],O[1]=(I[1]-f[1])/d[1]):h[1]>h[2]?(A[0]=(T[0]-f[0])/d[0],A[1]=(T[2]-f[2])/d[2],M[0]=(_[0]-f[0])/d[0],M[1]=(_[2]-f[2])/d[2],O[0]=(I[0]-f[0])/d[0],O[1]=(I[2]-f[2])/d[2]):(A[0]=(T[0]-f[0])/d[0],A[1]=(T[1]-f[1])/d[1],M[0]=(_[0]-f[0])/d[0],M[1]=(_[1]-f[1])/d[1],O[0]=(I[0]-f[0])/d[0],O[1]=(I[1]-f[1])/d[1])}n?(n.data=a,n.upload(e)):this.createVertexBuffer("coords",Mesh.common_buffers.coords.attribute,2,a)},Mesh.prototype.getNumVertices=function(){var e=this.vertexBuffers.vertices;return e?e.data.length/e.spacing:0},Mesh.prototype.getNumTriangles=function(){var e=this.getIndexBuffer("triangles");return e?e.data.length/3:this.getNumVertices()/3},Mesh.computeBoundingBox=function(e,t,r){if(e){var s=0;if(r){for(var n=0;n<r.length;++n)if(r[n]){s=n;break}if(s==r.length){console.warn("mask contains only zeros, no vertices marked");return}}for(var a=vec3.clone(e.subarray(s*3,s*3+3)),o=vec3.clone(e.subarray(s*3,s*3+3)),l,n=s*3;n<e.length;n+=3)r&&!r[n/3]||(l=e.subarray(n,n+3),vec3.min(a,l,a),vec3.max(o,l,o));(isNaN(a[0])||isNaN(a[1])||isNaN(a[2])||isNaN(o[0])||isNaN(o[1])||isNaN(o[2]))&&(a[0]=a[1]=a[2]=0,o[0]=o[1]=o[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices"));var h=vec3.add(vec3.create(),a,o);vec3.scale(h,h,.5);var c=vec3.subtract(vec3.create(),o,h);return global$1.BBox.setCenterHalfsize(t||global$1.BBox.create(),h,c)}},Mesh.prototype.getBoundingBox=function(){return this._bounding?this._bounding:(this.updateBoundingBox(),this._bounding)},Mesh.prototype.updateBoundingBox=function(){var e=this.vertexBuffers.vertices;e&&(GL$1.Mesh.computeBoundingBox(e.data,this._bounding),this.info&&this.info.groups&&this.info.groups.length&&this.computeGroupsBoundingBoxes())},Mesh.prototype.computeGroupsBoundingBoxes=function(){var e=null,t=this.getIndexBuffer("triangles");t&&(e=t.data);var r=this.getVertexBuffer("vertices");if(!r)return!1;var s=r.data;if(!s.length)return!1;var n=this.info.groups;if(n){for(var a=0;a<n.length;++a){var o=n[a];o.bounding=o.bounding||global$1.BBox.create();var l=null;if(e){for(var h=new Uint8Array(s.length/3),c=o.start,u=0,p=o.length;u<p;u+=3)h[e[c+u]]=1,h[e[c+u+1]]=1,h[e[c+u+2]]=1;GL$1.Mesh.computeBoundingBox(s,o.bounding,h)}else l=s.subarray(o.start*3,(o.start+o.length)*3),GL$1.Mesh.computeBoundingBox(l,o.bounding)}return!0}},Mesh.prototype.setBoundingBox=function(e,t){global$1.BBox.setCenterHalfsize(this._bounding,e,t)},Mesh.prototype.freeData=function(){for(var e in this.vertexBuffers)this.vertexBuffers[e].data=null,delete this[this.vertexBuffers[e].name];for(var t in this.indexBuffers)this.indexBuffers[t].data=null,delete this[this.indexBuffers[t].name]},Mesh.prototype.configure=function(e,t){var r={},s={};t=t||{};for(var n in e)if(e[n]){if(n=="vertexBuffers"||n=="vertex_buffers"){for(a in e[n])r[a]=e[n][a];continue}if(n=="indexBuffers"||n=="index_buffers"){for(a in e[n])s[a]=e[n][a];continue}n=="indices"||n=="lines"||n=="wireframe"||n=="triangles"?s[n]=e[n]:GL$1.Mesh.common_buffers[n]?r[n]=e[n]:t[n]=e[n]}this.addBuffers(r,s,t.stream_type);for(var a in t)this[a]=t[a];t.bounding||this.updateBoundingBox()},Mesh.prototype.totalMemory=function(){var e=0;for(var t in this.vertexBuffers)e+=this.vertexBuffers[t].data.buffer.byteLength;for(var t in this.indexBuffers)e+=this.indexBuffers[t].data.buffer.byteLength;return e},Mesh.prototype.slice=function(e,t){var r={},s=this.indexBuffers.triangles;if(!s)return console.warn("splice in not indexed not supported yet"),null;var n=s.data,a=[],o=new Int32Array(n.length);o.fill(-1);var l=e+t;l>=n.length&&(l=n.length);for(var h=0,c=e;c<l;++c){var u=n[c];if(o[u]!=-1){a.push(o[u]);continue}var p=h++;o[u]=p,a.push(p);for(var f in this.vertexBuffers){var d=this.vertexBuffers[f],g=d.data,m=d.spacing;r[f]||(r[f]=[]);for(var b=r[f],E=0;E<m;++E)b.push(g[E+u*m])}}var L=new GL$1.Mesh(r,{triangles:a},null,gl);return L.updateBoundingBox(),L},Mesh.prototype.simplify=function(){var e=this.getBoundingBox(),t=global$1.BBox.getMin(e),r=global$1.BBox.getHalfsize(e),s=vec3.scale(vec3.create(),r,2),n=new GL$1.Mesh,a=vec3.create();for(var o in this.vertexBuffers){var l=this.vertexBuffers[o],h=l.data,c=new Float32Array(h.length);if(o=="vertices")for(var u=0,p=h.length;u<p;u+=3){var f=h.subarray(u,u+3);vec3.sub(a,f,t),vec3.div(a,a,s),a[0]=Math.round(a[0]*256)/256,a[1]=Math.round(a[1]*256)/256,a[2]=Math.round(a[2]*256)/256,vec3.mul(a,a,s),vec3.add(a,a,t),c.set(a,u)}n.addBuffer()}},Mesh.load=function(e,t,r,s){t=t||{},t.no_gl&&(s=null);var n=r||new GL$1.Mesh(null,null,null,s);return n.configure(e,t),n},Mesh.mergeMeshes=function(e,t){t=t||{};for(var r={},s={},n={},a=[],o=0,l=0,h=[],c=[],u={},p=0,f=null,d=0;d<e.length;++d){var g=e[d],m=g.mesh,b=o;a.push(b);var E=m.vertexBuffers.vertices.data.length/3;o+=E;for(var L in m.vertexBuffers)r[L]?r[L]+=m.vertexBuffers[L].data.length:r[L]=m.vertexBuffers[L].data.length;for(var L in m.indexBuffers)s[L]?s[L]+=m.indexBuffers[L].data.length:s[L]=m.indexBuffers[L].data.length;var T={name:"mesh_"+d,start:b,length:E,material:""};if(m.bones){for(var _={},L=0;L<m.bones.length;++L){var I=m.bones[L];u[I[0]]||(u[I[0]]=c.length,c.push(I)),_[L]=u[I[0]]}for(var A=m.vertexBuffers.bone_indices.data,L=0;L<A.length;L+=1)A[L]=_[A[L]]}else if(c.length)throw"cannot merge meshes, one contains bones, the other doesnt";if(h.push(T),m.morphs){var M=Object.values(m.morphs).length;if(p==0)p=M;else if(p!==M)throw"cannot merge meshes with and without morph targets"}}for(var L in r){var O=t[L];if(O===null){delete r[L];continue}if(!O){var C=m.vertexBuffers[L];C&&(C.data&&(C=C.data),C.constructor!==Array&&(O=C.constructor)),O||(O=Float32Array)}r[L]=new O(r[L]),n[L]=0,L==="vertices"&&(l=r[L].length/3)}if(p){f=[];for(var d=0;d<p;++d){var P=e[0].mesh,N={name:P.morphs[d].name,weight:P.morphs[d].weight,buffers:{vertices:new Float32Array(l*3),normals:new Float32Array(l*3)}};f.push(N)}}for(var L in s){var O=o<65536?Uint16Array:Uint32Array;s[L]=new O(s[L]),n[L]=0}for(var d=0;d<e.length;++d){var g=e[d],m=g.mesh,b=n.vertices,E=0;for(var L in m.vertexBuffers)if(r[L]){if(L=="vertices"&&(E=m.vertexBuffers[L].data.length/3),r[L].set(m.vertexBuffers[L].data,n[L]),g[L+"_matrix"]){var k=g[L+"_matrix"];k.length==16?U(r[L],n[L],m.vertexBuffers[L].data.length,k):k.length==9&&W(r[L],n[L],m.vertexBuffers[L].data.length,k)}n[L]+=m.vertexBuffers[L].data.length}for(var L in m.indexBuffers)s[L].set(m.indexBuffers[L].data,n[L]),z(s[L],n[L],m.indexBuffers[L].data.length,a[d]),n[L]+=m.indexBuffers[L].data.length;if(p)for(var L=0;L<m.morphs.length;++L){var B=m.morphs[L];for(var S in B.buffers){var N=B.buffers[S];f[L].buffers[S].set(N,b)}}}function U(Y,H,Z,oe){for(var ue=H+Z,he=H;he<ue;he+=3){var se=Y.subarray(he,he+3);vec3.transformMat4(se,se,oe)}}function W(Y,H,Z,oe){for(var ue=H+Z,he=H;he<ue;he+=2){var se=Y.subarray(he,he+2);vec2.transformMat3(se,se,oe)}}function z(Y,H,Z,oe){if(oe)for(var ue=H+Z,he=H;he<ue;++he)Y[he]+=oe}var q={info:{groups:h}};if(c.length&&(q.bones=c),!t.only_data){var m=new GL$1.Mesh(r,s,q);return m.updateBoundingBox(),f&&(m.morphs=f),m}return{vertexBuffers:r,indexBuffers:s,info:{groups:h},morphs:f}},Mesh.parsers={},Mesh.encoders={},Mesh.binary_file_formats={},Mesh.compressors={},Mesh.decompressors={},Mesh.fromURL=function(e,t,r,s){s=s||{},r=r||global$1.gl;var n=e.lastIndexOf("."),a=e.substr(n+1).toLowerCase();s.extension&&(a=s.extension);var o=GL$1.Mesh.parsers[a.toLowerCase()];if(!o)return console.error("No parser available in litegl to parse mesh of type",a),null;var l=new GL$1.Mesh(void 0,void 0,void 0,r);return l.ready=!1,s.binary=Mesh.binary_file_formats[a],global$1.HttpRequest(e,null,function(h){l.parse(h,a,s),delete l.ready,t&&t.call(l,l,e,s)},function(h){t&&t(null)},s),l},Mesh.prototype.parse=function(e,t,r){r=r||{},r.mesh=this,t=t.toLowerCase();var s=GL$1.Mesh.parsers[t];if(s)return s.call(null,e,r);throw"GL.Mesh.parse: no parser found for format "+t},Mesh.prototype.encode=function(e,t){e=e.toLowerCase();var r=GL$1.Mesh.encoders[e];if(r)return r.call(null,this,t);throw"GL.Mesh.encode: no encoder found for format "+e},Mesh.getScreenQuad=function(e){e=e||global$1.gl;var t=e.meshes[":screen_quad"];if(t)return t;var r=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]),s=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]);return t=new GL$1.Mesh({vertices:r,coords:s},void 0,void 0,e),e.meshes[":screen_quad"]=t};function linearizeArray(e,t){if(e.constructor===t)return e;if(e.constructor!==Array)return t=t||Float32Array,new t(e);t=t||Float32Array;for(var r=e[0].length,s=e.length*r,n=new t(s),a=0;a<e.length;++a)for(var o=0;o<r;++o)n[a*r+o]=e[a][o];return n}GL$1.linearizeArray=linearizeArray,GL$1.Mesh.EXTENSION="wbin",GL$1.Mesh.enable_wbin_compression=!0;function DynamicMesh(e,t,r,s,n){e=e||1024,GL$1.debug&&console.log("GL.Mesh created"),n!==null&&(n=n||global$1.gl,this.gl=n),this.normals=t,this.coords=r,this._context_id=n.context_id,this.vertexBuffers={},this.indexBuffers={},this.info={groups:[]},this._bounding=global$1.BBox.create(),this.resize(e)}DynamicMesh.DEFAULT_NORMAL=vec3.fromValues(0,1,0),DynamicMesh.DEFAULT_COORD=vec2.fromValues(.5,.5),DynamicMesh.DEFAULT_COLOR=vec4.fromValues(1,1,1,1),DynamicMesh.prototype.resize=function(e){var t={};this._vertex_data=new Float32Array(e*3),t.vertices=this._vertex_data,this.normals&&(t.normals=this._normal_data=new Float32Array(e*3)),this.coords&&(t.coords=this._coord_data=new Float32Array(e*2)),this.colors&&(t.colors=this._color_data=new Float32Array(e*4)),this.addBuffers(t),this.current_pos=0,this.max_size=e,this._must_update=!0},DynamicMesh.prototype.clear=function(){this.current_pos=0},DynamicMesh.prototype.addPoint=function(e,t,r,s){if(n>=this.max_size)return console.warn("DynamicMesh: not enough space, reserve more"),!1;var n=this.current_pos++;return this._vertex_data.set(e,n*3),this._normal_data&&this._normal_data.set(t||DynamicMesh.DEFAULT_NORMAL,n*3),this._coord_data&&this._coord_data.set(r||DynamicMesh.DEFAULT_COORD,n*2),this._color_data&&this._color_data.set(s||DynamicMesh.DEFAULT_COLOR,n*4),this._must_update=!0,!0},DynamicMesh.prototype.update=function(e){return!this._must_update&&!e?this.current_pos:(this._must_update=!1,this.getBuffer("vertices").upload(gl.STREAM_DRAW),this._normal_data&&this.getBuffer("normal").upload(gl.STREAM_DRAW),this._coord_data&&this.getBuffer("coord").upload(gl.STREAM_DRAW),this._color_data&&this.getBuffer("color").upload(gl.STREAM_DRAW),this.current_pos)},global$1.extendClass(DynamicMesh,Mesh),Mesh.plane=function(e,t){e=e||{},e.triangles=[];var r=e.detailX||e.detail||1,s=e.detailY||e.detail||1,n=e.width||e.size||1,a=e.height||e.size||1,o=e.xz;n*=.5,a*=.5;var l=[],h=[],c=[],u=[],p=vec3.fromValues(0,0,1);o&&p.set([0,1,0]);for(var f=0;f<=s;f++)for(var d=f/s,g=0;g<=r;g++){var m=g/r;if(o?h.push((2*m-1)*n,0,-(2*d-1)*a):h.push((2*m-1)*n,(2*d-1)*a,0),c.push(m,d),u.push(p[0],p[1],p[2]),g<r&&f<s){var b=g+f*(r+1);o?(l.push(b+1,b+r+1,b),l.push(b+1,b+r+2,b+r+1)):(l.push(b,b+1,b+r+1),l.push(b+r+1,b+1,b+r+2))}}var E=global$1.BBox.fromCenterHalfsize([0,0,0],o?[n,0,a]:[n,a,0]),L={vertices:h,normals:u,coords:c,triangles:l};return GL$1.Mesh.load(L,{bounding:E},t)},Mesh.plane2D=function(e,t){var r=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),s=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(e&&e.size)for(var n=e.size*.5,a=0;a<r.length;++a)r[a]*=n;return new GL$1.Mesh({vertices2D:r,coords:s},null,t)},Mesh.point=function(e){return new GL$1.Mesh({vertices:[0,0,0]})},Mesh.cube=function(e,t){e=e||{};var r=(e.size||1)*.5,s={};s.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var n=0,a=s.vertices.length;n<a;++n)s.vertices[n]*=r;return s.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]),s.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]),e.wireframe&&(s.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11])),e.bounding=global$1.BBox.fromCenterHalfsize([0,0,0],[r,r,r]),GL$1.Mesh.load(s,e,t)},Mesh.box=function(e,t){e=e||{};var r=e.sizex||1,s=e.sizey||1,n=e.sizez||1;r*=.5,s*=.5,n*=.5;var a={};a.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var o=0,l=a.vertices.length;o<l;o+=3)a.vertices[o]*=r,a.vertices[o+1]*=s,a.vertices[o+2]*=n;return a.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]),a.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]),e.wireframe&&(a.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11])),e.bounding=global$1.BBox.fromCenterHalfsize([0,0,0],[r,s,n]),GL$1.Mesh.load(a,e,t)},Mesh.circle=function(e,t){e=e||{};var r=e.size||e.radius||1,s=Math.ceil(e.slices||24),n=e.xz||!1,a=e.empty||!1;s<3&&(s=3);var o=2*Math.PI/s,l=vec3.create(),h=vec3.create(),c=vec3.fromValues(0,0,1),u=vec2.fromValues(.5,.5),p=vec2.create();n&&c.set([0,1,0]);var f=n?2:1,d=new Float32Array(3*(s+1)),g=new Float32Array(3*(s+1)),m=new Float32Array(2*(s+1)),b=null;d.set(l,0),g.set(c,0),m.set(u,0);for(var E=0,L=0,T=0;T<s;++T)E=Math.sin(o*T),L=Math.cos(o*T),h[0]=E*r,h[f]=L*r,p[0]=E*.5+.5,p[1]=L*.5+.5,d.set(h,T*3+3),g.set(c,T*3+3),m.set(p,T*2+2);if(a)d=d.subarray(3),g=d.subarray(3),m=d.subarray(2),b=null;else{var b=new Uint16Array(3*s),_=2,I=1;n&&(_=1,I=2);for(var T=0;T<s-1;++T)b[T*3]=0,b[T*3+1]=T+_,b[T*3+2]=T+I;b[T*3]=0,n?(b[T*3+1]=T+1,b[T*3+2]=1):(b[T*3+1]=1,b[T*3+2]=T+1)}e.bounding=global$1.BBox.fromCenterHalfsize([0,0,0],n?[r,0,r]:[r,r,0]);var A={vertices:d,normals:g,coords:m,triangles:b};if(e.wireframe){for(var M=new Uint16Array(s*2),T=0;T<s;T++)M[T*2]=T,M[T*2+1]=T+1;M[0]=s,A.wireframe=M}return GL$1.Mesh.load(A,e,t)},Mesh.ring=function(e,t){e=e||{};var r=e.size||e.radius||1,s=e.thickness||r*.1,n=Math.ceil(e.slices||24),a=e.xz||!1,o=e.empty||!1;n<3&&(n=3);var l=2*Math.PI/n;vec3.create();var h=vec3.create(),c=vec3.create(),u=vec3.fromValues(0,0,1);vec2.fromValues(.5,.5);var p=vec2.create();a&&u.set([0,1,0]);for(var f=a?2:1,d=new Float32Array(3*(n*2+2)),g=new Float32Array(3*(n*2+2)),m=new Float32Array(2*(n*2+2)),b=null,E=0,L=0,T=0;T<=n;++T)E=Math.sin(l*T),L=Math.cos(l*T),h[0]=E*(r-s),h[f]=L*(r-s),p[0]=T/n,p[1]=0,d.set(h,T*6),g.set(u,T*6),m.set(p,T*4),c[0]=E*(r+s),c[f]=L*(r+s),p[1]=1,d.set(c,T*6+3),g.set(u,T*6+3),m.set(p,T*4+2);if(o)d=d.subarray(3),g=d.subarray(3),m=d.subarray(2),b=null;else{var b=new Uint16Array(6*n),_=2,I=1;a&&(_=1,I=2);for(var T=0;T<n;++T)b[T*6]=T*2,b[T*6+1]=T*2+_,b[T*6+2]=T*2+I,b[T*6+3]=T*2+I,b[T*6+4]=T*2+_,b[T*6+5]=T*2+3}e.bounding=global$1.BBox.fromCenterHalfsize([0,0,0],a?[r+s,0,r+s]:[r+s,r+s,0]);var A={vertices:d,normals:g,coords:m,triangles:b};if(e.wireframe){for(var M=new Uint16Array(n*4),T=0;T<n;T++)M[T*4]=T*2,M[T*4+1]=T*2+2,M[T*4+2]=T*2+1,M[T*4+3]=T*2+3;A.wireframe=M}return GL$1.Mesh.load(A,e,t)},Mesh.cylinder=function(e,t){e=e||{};for(var r=e.radius||e.size||1,s=e.height||e.size||2,n=e.subdivisions||64,a=new Float32Array(n*6*3*2),o=new Float32Array(n*6*3*2),l=new Float32Array(n*6*2*2),h=2*Math.PI/n,c=null,u=0;u<n;++u){var p=u*h;c=[Math.sin(p),0,Math.cos(p)],a.set([c[0]*r,s*.5,c[2]*r],u*6*3),o.set(c,u*6*3),l.set([u/n,1],u*6*2),c=[Math.sin(p),0,Math.cos(p)],a.set([c[0]*r,s*-.5,c[2]*r],u*6*3+3),o.set(c,u*6*3+3),l.set([u/n,0],u*6*2+2),c=[Math.sin(p+h),0,Math.cos(p+h)],a.set([c[0]*r,s*-.5,c[2]*r],u*6*3+6),o.set(c,u*6*3+6),l.set([(u+1)/n,0],u*6*2+4),c=[Math.sin(p+h),0,Math.cos(p+h)],a.set([c[0]*r,s*.5,c[2]*r],u*6*3+9),o.set(c,u*6*3+9),l.set([(u+1)/n,1],u*6*2+6),c=[Math.sin(p),0,Math.cos(p)],a.set([c[0]*r,s*.5,c[2]*r],u*6*3+12),o.set(c,u*6*3+12),l.set([u/n,1],u*6*2+8),c=[Math.sin(p+h),0,Math.cos(p+h)],a.set([c[0]*r,s*-.5,c[2]*r],u*6*3+15),o.set(c,u*6*3+15),l.set([(u+1)/n,0],u*6*2+10)}var f=u*6*3,d=u*6*2,g=f;if(e.caps===!1)a=a.subarray(0,f),o=o.subarray(0,f),l=l.subarray(0,d);else for(var m=vec3.fromValues(0,s*.5,0),b=vec3.fromValues(0,s*-.5,0),E=vec3.fromValues(0,1,0),L=vec3.fromValues(0,-1,0),u=0;u<n;++u){var p=u*h,T=vec3.fromValues(Math.sin(p),0,Math.cos(p)),_=vec3.fromValues(Math.sin(p+h),0,Math.cos(p+h));a.set([T[0]*r,s*.5,T[2]*r],f+u*6*3),o.set(E,f+u*6*3),l.set([-T[0]*.5+.5,T[2]*.5+.5],d+u*6*2),a.set([_[0]*r,s*.5,_[2]*r],f+u*6*3+3),o.set(E,f+u*6*3+3),l.set([-_[0]*.5+.5,_[2]*.5+.5],d+u*6*2+2),a.set(m,f+u*6*3+6),o.set(E,f+u*6*3+6),l.set([.5,.5],d+u*6*2+4),a.set([_[0]*r,s*-.5,_[2]*r],f+u*6*3+9),o.set(L,f+u*6*3+9),l.set([_[0]*.5+.5,_[2]*.5+.5],d+u*6*2+6),a.set([T[0]*r,s*-.5,T[2]*r],f+u*6*3+12),o.set(L,f+u*6*3+12),l.set([T[0]*.5+.5,T[2]*.5+.5],d+u*6*2+8),a.set(b,f+u*6*3+15),o.set(L,f+u*6*3+15),l.set([.5,.5],d+u*6*2+10)}var I={vertices:a,normals:o,coords:l};return e.bounding=global$1.BBox.fromCenterHalfsize([0,0,0],[r,s*.5,r]),e.info={groups:[]},e.caps!==!1&&(e.info.groups.push({name:"side",start:0,length:g/3}),e.info.groups.push({name:"caps",start:g/3,length:(a.length-g)/3})),Mesh.load(I,e,t)},Mesh.cone=function(e,t){e=e||{};for(var r=e.radius||e.size||1,s=e.height||e.size||2,n=e.subdivisions||64,a=new Float32Array(n*3*3*2),o=new Float32Array(n*3*3*2),l=new Float32Array(n*2*3*2),h=2*Math.PI/n,c=null,u=r/s,p=0;p<n;++p){var f=p*h;c=[Math.sin(f+h*.5),u,Math.cos(f+h*.5)],vec3.normalize(c,c),a.set([0,s,0],p*6*3),o.set(c,p*6*3),l.set([p/n,1],p*6*2),c=[Math.sin(f),u,Math.cos(f)],a.set([c[0]*r,0,c[2]*r],p*6*3+3),vec3.normalize(c,c),o.set(c,p*6*3+3),l.set([p/n,0],p*6*2+2),c=[Math.sin(f+h),u,Math.cos(f+h)],a.set([c[0]*r,0,c[2]*r],p*6*3+6),vec3.normalize(c,c),o.set(c,p*6*3+6),l.set([(p+1)/n,0],p*6*2+4)}for(var d=0,g=0,m=vec3.fromValues(0,0,0),b=vec3.fromValues(0,-1,0),p=0;p<n;++p){var f=p*h,E=vec3.fromValues(Math.sin(f),0,Math.cos(f)),L=vec3.fromValues(Math.sin(f+h),0,Math.cos(f+h));a.set([L[0]*r,0,L[2]*r],d+p*6*3+9),o.set(b,d+p*6*3+9),l.set([L[0]*.5+.5,L[2]*.5+.5],g+p*6*2+6),a.set([E[0]*r,0,E[2]*r],d+p*6*3+12),o.set(b,d+p*6*3+12),l.set([E[0]*.5+.5,E[2]*.5+.5],g+p*6*2+8),a.set(m,d+p*6*3+15),o.set(b,d+p*6*3+15),l.set([.5,.5],g+p*6*2+10)}var T={vertices:a,normals:o,coords:l};return e.bounding=global$1.BBox.fromCenterHalfsize([0,s*.5,0],[r,s*.5,r]),Mesh.load(T,e,t)},Mesh.torus=function(e,t){e=e||{};var r=e.outerradius||e.radius||1,s=Math.ceil(e.outerslices||e.slices||24),n=e.innerradius||r*.1,a=Math.ceil(e.innerslices||s),o=e.angle||Math.PI*2,l=Math.PI*2/a,h=o/s,c=1;vec3.create();var u=vec3.create(),p=vec3.fromValues(0,0,1);vec2.fromValues(.5,.5);for(var f=vec2.create(),d=o==Math.PI*2,g=new Float32Array(3*a),m=new Float32Array(3*a),_=0,I=0,b=0;b<a;++b)_=Math.sin(l*b),I=Math.cos(l*b),u[0]=_*n,u[c]=I*n,f[0]=_*.5+.5,f[1]=I*.5+.5,g.set(u,b*3),vec3.normalize(p,u),m.set(p,b*3);var E=new Float32Array(3*s*a),L=new Float32Array(3*s*a),T=new Float32Array(2*s*a),C=null,_=0,I=0,A=mat4.create(),M=vec3.fromValues(-r,0,0),O=vec3.fromValues(0,1,0);vec3.create();for(var C=[],P=a,b=0;b<s;++b){mat4.identity(A),mat4.rotate(A,A,b*h,O),mat4.translate(A,A,M);var N=b*a,P=a;b>=s-1&&(P=(s-1)*-a,d||(P=0));for(var k=0;k<a;++k){var B=g.subarray(k*3,k*3+3),S=m.subarray(k*3,k*3+3);mat4.multiplyVec3(u,A,B),mat4.rotateVec3(p,A,S),E.set(u,k*3+b*3*a),L.set(p,k*3+b*3*a),T.set([b/s,k/a],k*2+b*2*a);var U=N+k,W=N+(k+1)%a;C.push(W,U,U+P,W,U+P,W+P)}}var z=n+r;e.bounding=global$1.BBox.fromCenterHalfsize([0,0,0],[z,z,n]);var q={vertices:E,normals:L,coords:T,triangles:C};return GL$1.Mesh.load(q,e,t)},Mesh.sphere=function(e,t){e=e||{};for(var r=e.radius||e.size||1,s=e.lat||e.subdivisions||16,n=e.long||e.subdivisions||16,a=new Float32Array((s+1)*(n+1)*3),o=new Float32Array((s+1)*(n+1)*3),l=new Float32Array((s+1)*(n+1)*2),h=new Uint16Array(s*n*6),c=e.hemi?Math.PI*.5:Math.PI,u=0,p=0,f=0;f<=s;f++)for(var d=f*c/s,g=Math.sin(d),m=Math.cos(d),b=0;b<=n;b++){var E=b*2*Math.PI/n,L=Math.sin(E),T=Math.cos(E),_=T*g,I=m,A=L*g,M=1-b/n,O=1-f/s;a.set([r*_,r*I,r*A],u),o.set([_,I,A],u),l.set([M,O],p),u+=3,p+=2}u=0;for(var f=0;f<s;f++)for(var b=0;b<n;b++){var C=f*(n+1)+b,P=C+n+1;h.set([P,C,C+1],u),h.set([P+1,P,C+1],u+3),u+=6}var N={vertices:a,normals:o,coords:l,triangles:h};if(e.wireframe){for(var k=new Uint16Array(n*s*4),B=0,u=0;u<s;u++){for(var S=0;S<n;S++)k[B]=u*(n+1)+S,k[B+1]=u*(n+1)+S+1,B+=2;k[B-n*2]=u*(n+1)+S}for(var u=0;u<n;u++)for(var S=0;S<s;S++)k[B]=S*(n+1)+u,k[B+1]=(S+1)*(n+1)+u,B+=2;N.wireframe=k}return e.hemi?e.bounding=global$1.BBox.fromCenterHalfsize([0,r*.5,0],[r,r*.5,r],r):e.bounding=global$1.BBox.fromCenterHalfsize([0,0,0],[r,r,r],r),GL$1.Mesh.load(N,e,t)},Mesh.grid=function(e,t){e=e||{};var r=e.lines||11;r<0&&(r=1);for(var s=e.size||10,n=new Float32Array(r*2*2*3),a=s*.5,o=0,l=-a,h=s/(r-1),c=0;c<r;c++)n[o]=l,n[o+2]=-a,n[o+3]=l,n[o+5]=a,n[o+6]=a,n[o+8]=l,n[o+9]=-a,n[o+11]=l,l+=h,o+=12;return new GL$1.Mesh({vertices:n},e,t)},Mesh.icosahedron=function(e,t){e=e||{};var r=e.radius||e.size||1,s=e.subdivisions===void 0?0:e.subdivisions;s>6&&(s=6);for(var n=(1+Math.sqrt(5))/2,a=[-1,n,0,1,n,0,-1,-n,0,1,-n,0,0,-1,n,0,1,n,0,-1,-n,0,1,-n,n,0,-1,n,0,1,-n,0,-1,-n,0,1],o=[],l=[],h=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],c=a.length,u=0;u<c;u+=3){var p=Math.sqrt(a[u]*a[u]+a[u+1]*a[u+1]+a[u+2]*a[u+2]),f=a[u]/p,d=a[u+1]/p,g=a[u+2]/p;o.push(f,d,g),l.push(Math.atan2(f,g),Math.acos(d)),a[u]*=r/p,a[u+1]*=r/p,a[u+2]*=r/p}var m={};function b(A,M){var O=h[A]<h[M]?h[A]+":"+h[M]:h[M]+":"+h[A],C=m[O];if(C)return C;var P=a.length/3;a.push((a[h[A]*3]+a[h[M]*3])*.5,(a[h[A]*3+1]+a[h[M]*3+1])*.5,(a[h[A]*3+2]+a[h[M]*3+2])*.5);var N=Math.sqrt(a[P*3]*a[P*3]+a[P*3+1]*a[P*3+1]+a[P*3+2]*a[P*3+2]),k=a[P*3]/N,B=a[P*3+1]/N,S=a[P*3+2]/N;return o.push(k,B,S),l.push(Math.atan2(k,S)/Math.PI*.5,Math.acos(B)/Math.PI),a[P*3]*=r/N,a[P*3+1]*=r/N,a[P*3+2]*=r/N,m[O]=P,P}for(var E=0;E<s;++E){for(var L=[],c=h.length,u=0;u<c;u+=3){var T=b(u,u+1),_=b(u+1,u+2),I=b(u+2,u);L.push(h[u],T,I),L.push(h[u+1],_,T),L.push(h[u+2],I,_),L.push(T,_,I)}h=L}return e.bounding=global$1.BBox.fromCenterHalfsize([0,0,0],[r,r,r],r),new GL$1.Mesh.load({vertices:a,coords:l,normals:o,triangles:h},e,t)},Mesh.shape=function(e,t,r){if(t=t||{},typeof earcut>"u")throw"To use GL.Mesh.shape you must download and include earcut.js (do not link it directly!): https://raw.githubusercontent.com/mapbox/earcut/master/src/earcut.js";if(!e||!e.length||e.length%2==1)throw"GL.Mesh.shape line missing, must be an array of 2D vertices";var s=t.extrude||0;e[0].constructor===Array&&(e=earcut.flatten(e));var n=earcut(e).reverse();console.log(n);for(var a=[],o=[],l=[],h=[e[0],e[1]],c=[e[0],e[1]],u=0;u<e.length;u+=2)h[0]=Math.min(h[0],e[u]),h[1]=Math.max(h[1],e[u]),c[0]=Math.min(c[0],e[u+1]),c[1]=Math.max(c[1],e[u+1]);var p=h[1]-h[0],f=c[1]-c[0],d=[],g=null;if(s){g=[];for(var m=vec3.create(),b=e.length,u=0;u<e.length;u+=2){var E=e[u],L=e[u+1],T=e[(u+2)%b],_=e[(u+3)%b],I=a.length/3;a.push(E,s*.5,L),a.push(E,s*-.5,L),a.push(T,s*.5,_),a.push(T,s*-.5,_),vec3.normalize(m,vec3.cross(m,[0,1,0],[T-E,0,_-L])),o.push(m[0],m[1],m[2],m[0],m[1],m[2],m[0],m[1],m[2],m[0],m[1],m[2]);var A=(E-h[0])/p,M=(L-c[0])/f,O=(T-h[0])/p,C=(_-c[0])/f;l.push(A,M,A,M,O,C,O,C),g.push(I,I+2,I+1,I+2,I+3,I+1)}d.push({name:"side",start:0,length:g.length});for(var P=a.length/3,N=g.length,u=0;u<e.length;u+=2){var E=e[u],L=e[u+1],A=(E-h[0])/p,M=(L-c[0])/f;a.push(E,s*.5,L),a.push(E,s*-.5,L),o.push(0,1,0,0,-1,0),l.push(A,M,A,M)}for(var u=0;u<n.length;u+=3)g.push(P+n[u]*2,P+n[u+1]*2,P+n[u+2]*2),g.push(P+n[u]*2+1,P+n[u+2]*2+1,P+n[u+1]*2+1);d.push({name:"caps",start:N,length:g.length}),t.bounding=global$1.BBox.fromCenterHalfsize([(h[0]+h[1])*.5,0,(c[0]+c[1])*.5],[p*.5,s*.5,f*.5],vec2.len([p*.5,s*.5,f*.5]))}else{for(var u=0;u<e.length;u+=2)a.push(e[u],0,e[u+1]),o.push(0,1,0),l.push((e[u]-h[0])/p,(e[u+1]-c[0])/f);g=n,d.push({name:"side",start:0,length:g.length}),t.bounding=global$1.BBox.fromCenterHalfsize([(h[0]+h[1])*.5,0,(c[0]+c[1])*.5],[p*.5,0,f*.5],vec2.len([p*.5,0,f*.5]))}if(t.xy){for(var u=0;u<a.length;u+=3)k(a,u),k(o,u);s?t.bounding=global$1.BBox.fromCenterHalfsize([(h[0]+h[1])*.5,(c[0]+c[1])*.5,0],[p*.5,f*.5,s*.5],vec2.len([p*.5,f*.5,s*.5])):t.bounding=global$1.BBox.fromCenterHalfsize([(h[0]+h[1])*.5,(c[0]+c[1])*.5,0],[p*.5,f*.5,0],vec2.len([p*.5,f*.5,0]))}return t.info={groups:d},new GL$1.Mesh.load({vertices:a,coords:l,normals:o,triangles:g},t,r);function k(B,S){var U=B[S+1];B[S+1]=B[S+2],B[S+2]=-U}},global$1.Texture=GL$1.Texture=function e(t,r,s,n){if(s=s||{},n=n||global$1.gl,this.gl=n,this._context_id=n.context_id,t=parseInt(t),r=parseInt(r),GL$1.debug&&console.log("GL.Texture created: ",t,r),this.handler=n.createTexture(),this.width=t,this.height=r,s.depth&&(this.depth=s.depth),this.texture_type=s.texture_type||n.TEXTURE_2D,this.format=s.format||e.DEFAULT_FORMAT,this.internalFormat=s.internalFormat,this.type=s.type||e.DEFAULT_TYPE,this.magFilter=s.magFilter||s.filter||e.DEFAULT_MAG_FILTER,this.minFilter=s.minFilter||s.filter||e.DEFAULT_MIN_FILTER,this.wrapS=s.wrap||s.wrapS||e.DEFAULT_WRAP_S,this.wrapT=s.wrap||s.wrapT||e.DEFAULT_WRAP_T,this.data=null,e.MAX_TEXTURE_IMAGE_UNITS||(e.MAX_TEXTURE_IMAGE_UNITS=n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS)),this.has_mipmaps=!1,this.format==n.DEPTH_COMPONENT&&n.webgl_version==1&&!n.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==n.FLOAT&&!n.extensions.OES_texture_float&&n.webgl_version==1)throw"Float Texture not supported";if(this.type==n.HALF_FLOAT_OES){if(!n.extensions.OES_texture_half_float&&n.webgl_version==1)throw"Half Float Texture extension not supported.";n.webgl_version>1&&(console.warn("using HALF_FLOAT_OES in WebGL2 is deprecated, suing HALF_FLOAT instead"),this.type=this.format==n.RGB?n.RGB16F:n.RGBA16F)}if((!isPowerOfTwo(this.width)||!isPowerOfTwo(this.height))&&(this.minFilter!=n.NEAREST&&this.minFilter!=n.LINEAR||this.wrapS!=n.CLAMP_TO_EDGE||this.wrapT!=n.CLAMP_TO_EDGE))if(s.ignore_pot)this.minFilter=this.magFilter=n.LINEAR,this.wrapS=this.wrapT=n.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(!t||!r)return;this.internalFormat||this.computeInternalFormat(),n.activeTexture(n.TEXTURE0+e.MAX_TEXTURE_IMAGE_UNITS-1),n.bindTexture(this.texture_type,this.handler),n.texParameteri(this.texture_type,n.TEXTURE_MAG_FILTER,this.magFilter),n.texParameteri(this.texture_type,n.TEXTURE_MIN_FILTER,this.minFilter),n.texParameteri(this.texture_type,n.TEXTURE_WRAP_S,this.wrapS),n.texParameteri(this.texture_type,n.TEXTURE_WRAP_T,this.wrapT),s.anisotropic&&n.extensions.EXT_texture_filter_anisotropic&&n.texParameterf(GL$1.TEXTURE_2D,n.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,s.anisotropic);var a=this.type,o=s.pixel_data;if(o&&!o.buffer){if(this.texture_type==GL$1.TEXTURE_CUBE_MAP)if(o[0].constructor===Number)o=h(o),o=[o,o,o,o,o,o];else for(var l=0;l<o.length;++l)o[l]=h(o[l]);else o=h(o);this.data=o}function h(p){return p.constructor!==Array?p:a==GL$1.FLOAT?new Float32Array(p):a==GL$1.HALF_FLOAT_OES?new Uint16Array(p):new Uint8Array(p)}if(e.setUploadOptions(s),this.texture_type==GL$1.TEXTURE_2D)n.texImage2D(GL$1.TEXTURE_2D,0,this.internalFormat,t,r,0,this.format,this.type,o||null),GL$1.isPowerOfTwo(t)&&GL$1.isPowerOfTwo(r)&&s.minFilter&&s.minFilter!=n.NEAREST&&s.minFilter!=n.LINEAR&&(n.generateMipmap(this.texture_type),this.has_mipmaps=!0);else if(this.texture_type==GL$1.TEXTURE_CUBE_MAP)for(var c=t*t*(this.format==GL$1.RGBA?4:3),l=0;l<6;++l){var u=o;u&&(u.constructor===Array?u=u[l]:u.subarray(c*l,c*(l+1))),n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this.internalFormat,this.width,this.height,0,this.format,this.type,u||null)}else if(this.texture_type==GL$1.TEXTURE_3D){if(this.gl.webgl_version==1)throw"TEXTURE_3D not supported in WebGL 1. Enable WebGL 2 in the context by passing webgl2:true to the context";if(!s.depth)throw"3d texture depth must be set in the options.depth";n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1),n.texImage3D(GL$1.TEXTURE_3D,0,this.internalFormat,t,r,s.depth,0,this.format,this.type,o||null)}n.bindTexture(this.texture_type,null),n.activeTexture(n.TEXTURE0)},GL$1.Texture.DEFAULT_TYPE=GL$1.UNSIGNED_BYTE,GL$1.Texture.DEFAULT_FORMAT=GL$1.RGBA,GL$1.Texture.DEFAULT_MAG_FILTER=GL$1.LINEAR,GL$1.Texture.DEFAULT_MIN_FILTER=GL$1.LINEAR,GL$1.Texture.DEFAULT_WRAP_S=GL$1.CLAMP_TO_EDGE,GL$1.Texture.DEFAULT_WRAP_T=GL$1.CLAMP_TO_EDGE,GL$1.Texture.EXTENSION="png",GL$1.Texture.framebuffer=null,GL$1.Texture.renderbuffer=null,GL$1.Texture.loading_color=new Uint8Array([0,0,0,0]),GL$1.Texture.use_renderbuffer_pool=!0,GL$1.Texture.CROSS_ORIGIN_CREDENTIALS="Anonymous",GL$1.Texture.prototype.computeInternalFormat=function(){if(this.internalFormat=this.format,gl.webgl_version==1?this.type==GL$1.HALF_FLOAT&&(console.warn("webgl 1 does not use HALF_FLOAT, converting to HALF_FLOAT_OES"),this.type=GL$1.HALF_FLOAT_OES):this.type==GL$1.HALF_FLOAT_OES&&(console.warn("webgl 2 does not use HALF_FLOAT_OES, converting to HALF_FLOAT"),this.type=GL$1.HALF_FLOAT),this.format==GL$1.DEPTH_COMPONENT||this.format===GL$1.DEPTH_STENCIL){if(this.minFilter=GL$1.NEAREST,gl.webgl_version==2)if(this.type===GL$1.UNSIGNED_INT_24_8&&this.format===GL$1.DEPTH_STENCIL)this.internalFormat=GL$1.DEPTH24_STENCIL8;else if(this.type===GL$1.FLOAT&&this.format===GL$1.DEPTH_STENCIL)this.internalFormat=gl.FLOAT_32_UNSIGNED_INT_24_8_REV;else if(this.type==GL$1.UNSIGNED_SHORT)this.internalFormat=GL$1.DEPTH_COMPONENT16;else if(this.type==GL$1.UNSIGNED_INT)this.internalFormat=GL$1.DEPTH_COMPONENT24;else if(this.type==GL$1.FLOAT)this.internalFormat=GL$1.DEPTH_COMPONENT32F;else throw"unsupported type for a depth texture";else if(gl.webgl_version==1){if(this.type==GL$1.FLOAT)throw"WebGL 1.0 does not support float depth textures";this.internalFormat=GL$1.DEPTH_COMPONENT}}else if(this.format==gl.RGBA)gl.webgl_version==2&&(this.type==GL$1.FLOAT?this.internalFormat=GL$1.RGBA32F:this.type==GL$1.HALF_FLOAT&&(this.internalFormat=GL$1.RGBA16F));else if(this.format==gl.RGB&&gl.webgl_version==2){if(this.type==GL$1.FLOAT)this.internalFormat=GL$1.RGB32F;else if(this.type==GL$1.HALF_FLOAT)throw"GL.RGB HALF_FLOAT is not supported, use RGBA instead"}},GL$1.Texture.prototype.delete=function(){gl.deleteTexture(this.handler),this.handler=null},GL$1.Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}},GL$1.Texture.prototype.hasSameProperties=function(e){return e?e.width==this.width&&e.height==this.height&&e.type==this.type&&e.format==this.format&&e.texture_type==this.texture_type:!1},GL$1.Texture.prototype.hasSameSize=function(e){return e?e.width==this.width&&e.height==this.height:!1},GL$1.Texture.prototype.toJSON=function(){return""},GL$1.Texture.isDepthSupported=function(){return gl.extensions.WEBGL_depth_texture!=null},GL$1.Texture.prototype.bind=function(e){e==null&&(e=0);var t=this.gl;return t.activeTexture(t.TEXTURE0+e),t.bindTexture(this.texture_type,this.handler),e},GL$1.Texture.prototype.unbind=function(e){e===void 0&&(e=0);var t=this.gl;t.activeTexture(t.TEXTURE0+e),t.bindTexture(this.texture_type,null)},GL$1.Texture.prototype.setParameter=function(e,t){switch(this.bind(0),this.gl.texParameteri(this.texture_type,e,t),e){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=t;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=t;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=t;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=t;break}},GL$1.Texture.setUploadOptions=function(e,t){t=t||global$1.gl,GL$1.Texture.disable_deprecated||(e?(t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!e.premultiply_alpha),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!e.no_flip)):(t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0))),t.pixelStorei(t.UNPACK_ALIGNMENT,1)},GL$1.Texture.flipYData=function(e,t,r,s){for(var n=new e.constructor(t*s),a=0,o=t*(r-1)*s,l=Math.floor(r*.5),h=0;h<l;++h){var c=e.subarray(a,a+t*s),u=e.subarray(o,o+t*s);if(n.set(c),c.set(u),u.set(n),a+=t*s,o-=t*s,a>o)break}},GL$1.Texture.prototype.uploadImage=function(e,t){this.bind();var r=this.gl;if(!e)throw"uploadImage parameter must be Image";GL$1.Texture.setUploadOptions(t,r);try{if(t&&t.subimage)r.webgl_version==1?r.texSubImage2D(r.TEXTURE_2D,0,0,0,this.format,this.type,e):r.texSubImage2D(r.TEXTURE_2D,0,0,0,e.videoWidth||e.width,e.videoHeight||e.height,this.format,this.type,e);else{var s=e.videoWidth||e.width,n=e.videoHeight||e.height;(s!=this.width||n!=this.height)&&this.width!=1&&this.height!=1&&console.warn("image uploaded has a different size than texture, resizing it."),r.texImage2D(r.TEXTURE_2D,0,this.format,this.format,this.type,e),this.width=s,this.height=n}this.data=e}catch(a){throw console.error(a),location.protocol=="file:"?'image not loaded for security reasons (serve this page over "http://" instead)':"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}this.minFilter&&this.minFilter!=r.NEAREST&&this.minFilter!=r.LINEAR&&(r.generateMipmap(this.texture_type),this.has_mipmaps=!0),r.bindTexture(this.texture_type,null)},GL$1.Texture.prototype.uploadData=function(e,t,r){if(t=t||{},!e)throw"no data passed";var s=this.gl;this.bind(),GL$1.Texture.setUploadOptions(t,s);var n=t.mipmap_level||0,a=this.width,o=this.height;a=a>>n,o=o>>n;var l=this.internalFormat||this.format;if(this.type==GL$1.HALF_FLOAT_OES&&e.constructor===Float32Array&&console.warn("cannot uploadData to a HALF_FLOAT texture from a Float32Array, must be Uint16Array. To upload it we recomment to create a FLOAT texture, upload data there and copy to your HALF_FLOAT."),this.texture_type==GL$1.TEXTURE_2D)s.webgl_version==1?e.buffer&&e.buffer.constructor==ArrayBuffer?s.texImage2D(this.texture_type,n,l,a,o,0,this.format,this.type,e):s.texImage2D(this.texture_type,n,l,this.format,this.type,e):s.webgl_version==2&&(e.buffer&&e.buffer.constructor==ArrayBuffer?s.texImage2D(this.texture_type,n,l,a,o,0,this.format,this.type,e):s.texImage2D(this.texture_type,n,l,a,o,0,this.format,this.type,e));else if(this.texture_type==GL$1.TEXTURE_3D)s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),s.texImage3D(this.texture_type,n,l,a,o,this.depth>>n,0,this.format,this.type,e);else if(this.texture_type==GL$1.TEXTURE_CUBE_MAP)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+(t.cubemap_face||0),n,l,a,o,0,this.format,this.type,e);else throw"cannot uploadData for this texture type";this.data=e,!r&&this.minFilter&&this.minFilter!=s.NEAREST&&this.minFilter!=s.LINEAR&&(s.generateMipmap(this.texture_type),this.has_mipmaps=!0),s.bindTexture(this.texture_type,null)},GL$1.Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,0,0)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}],GL$1.Texture.prototype.drawTo=function(e,t){var r=this.gl,s=r.getViewport(),n=GL$1.getTime(),a=r.getParameter(r.FRAMEBUFFER_BINDING),o=r._framebuffer=r._framebuffer||r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,o);var l=null;if(GL$1.Texture.use_renderbuffer_pool){r._renderbuffers_pool||(r._renderbuffers_pool={});var h=this.width+":"+this.height;r._renderbuffers_pool[h]?(l=r._renderbuffers_pool[h],l.time=n,r.bindRenderbuffer(r.RENDERBUFFER,l)):(r._renderbuffers_pool[h]=l=r.createRenderbuffer(),l.time=n,l.width=this.width,l.height=this.height,r.bindRenderbuffer(r.RENDERBUFFER,l),setTimeout(c.bind(l),1e3*60))}else l=r._renderbuffer=r._renderbuffer||r.createRenderbuffer(),l.width=this.width,l.height=this.height,r.bindRenderbuffer(r.RENDERBUFFER,l);this.format===r.DEPTH_COMPONENT?r.renderbufferStorage(r.RENDERBUFFER,r.RGBA4,this.width,this.height):r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,this.width,this.height);function c(){GL$1.getTime()-this.time>=1e3*60?(r.deleteRenderbuffer(r._renderbuffers_pool[h]),delete r._renderbuffers_pool[h]):setTimeout(c.bind(this),1e3*60)}if(r.viewport(0,0,this.width,this.height),r._current_texture_drawto=this,r._current_fbo_color=o,r._current_fbo_depth=l,this.texture_type==r.TEXTURE_2D)this.format!==r.DEPTH_COMPONENT?(r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.handler,0),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,l)):(r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,l),r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_2D,this.handler,0)),e(this,t);else if(this.texture_type==r.TEXTURE_CUBE_MAP){this.format!==r.DEPTH_COMPONENT?r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,l):r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,l);for(var u=0;u<6;u++)this.format!==r.DEPTH_COMPONENT?r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+u,this.handler,0):r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_CUBE_MAP_POSITIVE_X+u,this.handler,0),e(this,u,t)}return this.data=null,r._current_texture_drawto=null,r._current_fbo_color=null,r._current_fbo_depth=null,r.bindFramebuffer(r.FRAMEBUFFER,a),r.bindRenderbuffer(r.RENDERBUFFER,null),r.viewport(s[0],s[1],s[2],s[3]),this},GL$1.Texture.prototype.copyTo=function(e,t,r){var s=this.gl;if(!e)throw"target_texture required";var n=s.getParameter(s.FRAMEBUFFER_BINDING),a=s.getViewport();t||(t=this.texture_type==s.TEXTURE_2D?GL$1.Shader.getScreenShader():GL$1.Shader.getCubemapCopyShader()),s.disable(s.BLEND),s.disable(s.DEPTH_TEST),t&&r&&t.uniforms(r);var o=s.__copy_fbo;if(o||(o=s.__copy_fbo=s.createFramebuffer()),s.bindFramebuffer(s.FRAMEBUFFER,o),s.viewport(0,0,e.width,e.height),this.texture_type==s.TEXTURE_2D)if(this.format!==s.DEPTH_COMPONENT&&this.format!==s.DEPTH_STENCIL)s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,e.handler,0),this.toViewport(t);else{var l=s._color_renderbuffer=s._color_renderbuffer||s.createRenderbuffer(),h=l.width=e.width,c=l.height=e.height;s.bindRenderbuffer(s.RENDERBUFFER,l),s.renderbufferStorage(s.RENDERBUFFER,s.RGBA4,h,c),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,l);var u=e.format==s.DEPTH_STENCIL?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;s.framebufferTexture2D(s.FRAMEBUFFER,u,s.TEXTURE_2D,e.handler,0);var p=s.checkFramebufferStatus(s.FRAMEBUFFER);if(p!==s.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+p;s.enable(s.DEPTH_TEST),s.depthFunc(s.ALWAYS),s.colorMask(!1,!1,!1,!1),t=GL$1.Shader.getCopyDepthShader(),this.toViewport(t),s.colorMask(!0,!0,!0,!0),s.disable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,null),s.framebufferTexture2D(s.FRAMEBUFFER,u,s.TEXTURE_2D,null,0)}else if(this.texture_type==s.TEXTURE_CUBE_MAP){t.uniforms({u_texture:0});for(var f=GL$1.temp_mat3,d=0;d<6;d++){s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+d,e.handler,0);var g=GL$1.Texture.cubemap_camera_parameters[d];mat3.identity(f),f.set(g.right,0),f.set(g.up,3),f.set(g.dir,6),this.toViewport(t,{u_rotation:f})}}return s.setViewport(a),s.bindFramebuffer(s.FRAMEBUFFER,n),e.minFilter&&e.minFilter!=s.NEAREST&&e.minFilter!=s.LINEAR&&(e.bind(),s.generateMipmap(e.texture_type),e.has_mipmaps=!0),e.data=null,s.bindTexture(e.texture_type,null),this},GL$1.Texture.prototype.blit=function(){var e=new Float32Array(4);return function(t,r,s){var n=this.gl;if(this.texture_type!=n.TEXTURE_2D||this.format===n.DEPTH_COMPONENT||this.format===n.DEPTH_STENCIL)throw"blit only support TEXTURE_2D of RGB or RGBA. use copyTo instead";var a=n.getParameter(n.FRAMEBUFFER_BINDING);e.set(n.viewport_data),r=r||GL$1.Shader.getScreenShader(),r&&s&&r.uniforms(s);var o=n.__copy_fbo;return o||(o=n.__copy_fbo=n.createFramebuffer()),n.bindFramebuffer(n.FRAMEBUFFER,o),n.viewport(0,0,t.width,t.height),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t.handler,0),this.bind(0),r.draw(GL$1.Mesh.getScreenQuad(),n.TRIANGLES),n.setViewport(e),n.bindFramebuffer(n.FRAMEBUFFER,a),t.data=null,n.bindTexture(t.texture_type,null),this}}(),GL$1.Texture.prototype.toViewport=function(e,t){e=e||Shader.getScreenShader();var r=Mesh.getScreenQuad();this.bind(0),t&&e.uniforms(t),e.draw(r,gl.TRIANGLES)},GL$1.Texture.prototype.fill=function(e,t){if(e.constructor===GL$1.Shader){var r=e;this.drawTo(function(){r.toViewport()})}else{var s=e,n=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(s[0],s[1],s[2],s[3]),this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)}),gl.clearColor(n[0],n[1],n[2],n[3])}!t&&this.minFilter&&this.minFilter!=gl.NEAREST&&this.minFilter!=gl.LINEAR&&(this.bind(),gl.generateMipmap(this.texture_type),this.has_mipmaps=!0)},GL$1.Texture.prototype.renderQuad=function(){var e=mat3.create(),t=vec2.create(),r=vec2.create(),s=vec4.fromValues(1,1,1,1);return function(n,a,o,l,h,c){t[0]=n,t[1]=a,r[0]=o,r[1]=l,h=h||Shader.getQuadShader(this.gl);var u=Mesh.getScreenQuad(this.gl);this.bind(0),h.uniforms({u_texture:0,u_position:t,u_color:s,u_size:r,u_viewport:gl.viewport_data.subarray(2,4),u_transform:e}),c&&h.uniforms(c),h.draw(u,gl.TRIANGLES)}}(),GL$1.Texture.prototype.applyBlur=function(e,t,r,s,n){var a=this.gl;e===void 0&&(e=1),t===void 0&&(t=1),a.disable(a.DEPTH_TEST),a.disable(a.BLEND),s=s||this;var o=!n;if(n===s)throw"cannot use applyBlur in a texture using as temporary itself";if(s&&this.texture_type!==s.texture_type)throw"cannot use applyBlur with textures of different texture_type";var l=a.getParameter(a.FRAMEBUFFER_BINDING),h=a.getViewport(),c=a.__copy_fbo;if(c||(c=a.__copy_fbo=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,c),a.viewport(0,0,this.width,this.height),this.texture_type===a.TEXTURE_2D){var u=GL$1.Shader.getBlurShader();n||(n=GL$1.Texture.getTemporary(this.width,this.height,this)),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,n.handler,0),this.toViewport(u,{u_texture:0,u_intensity:r,u_offset:[0,t/this.height]}),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,s.handler,0),a.viewport(0,0,s.width,s.height),n.toViewport(u,{u_intensity:r,u_offset:[e/n.width,0]}),o&&GL$1.Texture.releaseTemporary(n)}else if(this.texture_type===a.TEXTURE_CUBE_MAP){var u=GL$1.Shader.getCubemapBlurShader();u.uniforms({u_texture:0,u_intensity:r,u_offset:[e/this.width,t/this.height]}),this.bind(0);var p=Mesh.getScreenQuad();p.bindBuffers(u),u.bind();var f=null;!n&&s==this?f=n=GL$1.Texture.getTemporary(s.width,s.height,s):f=s;for(var d=GL$1.temp_mat3,g=0;g<6;++g){a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+g,f.handler,0);var m=GL$1.Texture.cubemap_camera_parameters[g];mat3.identity(d),d.set(m.right,0),d.set(m.up,3),d.set(m.dir,6),u._setUniform("u_rotation",d),a.drawArrays(a.TRIANGLES,0,6)}p.unbindBuffers(u),n&&n.copyTo(s),n&&o&&GL$1.Texture.releaseTemporary(n)}a.setViewport(h),a.bindFramebuffer(a.FRAMEBUFFER,l),s.data=null,s.minFilter&&s.minFilter!=a.NEAREST&&s.minFilter!=a.LINEAR&&(s.bind(),a.generateMipmap(s.texture_type),s.has_mipmaps=!0),a.bindTexture(s.texture_type,null)},GL$1.Texture.fromURL=function(e,t,r,s){s=s||global$1.gl,t=t||{},t=Object.create(t);var n=t.texture||new GL$1.Texture(1,1,t,s);e.length<64&&(n.url=e),n.bind();var a=t.temp_color||GL$1.Texture.loading_color;s.pixelStorei(s.UNPACK_ALIGNMENT,4);var o=t.type==s.FLOAT?new Float32Array(a):new Uint8Array(a);s.texImage2D(s.TEXTURE_2D,0,n.format,n.width,n.height,0,n.format,n.type,o),s.bindTexture(n.texture_type,null),n.ready=!1;var l=null;if(t.extension&&(l=t.extension),!l&&e.length<512){var h=e,c=e.indexOf("?");c!=-1&&(h=e.substr(0,c)),c=h.lastIndexOf("."),c!=-1&&(l=h.substr(c+1).toLowerCase())}if(l=="dds"){var l=s.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||s.getExtension("WEBGL_compressed_texture_s3tc"),u=new GL$1.Texture(0,0,t,s);DDS.loadDDSTextureEx(s,l,e,u.handler,!0,function(d){n.texture_type=d.texture_type,n.handler=d,delete n.ready,r&&r(n,e)})}else if(l=="tga")global$1.HttpRequest(e,null,function(f){var d=GL$1.Texture.parseTGA(f);d&&(t.texture=n,d.flipY&&(t.no_flip=!0),d.format=="RGB"&&(n.format=s.RGB),n=GL$1.Texture.fromMemory(d.width,d.height,d.pixels,t),delete n.ready,r&&r(n,e))},null,{binary:!0});else{var p=new Image;p.src=e,p.crossOrigin=GL$1.Texture.CROSS_ORIGIN_CREDENTIALS,p.onload=function(){t.texture=n,GL$1.Texture.fromImage(this,t),delete n.ready,r&&r(n,e)},p.onerror=function(){r&&r(null)}}return n},GL$1.Texture.parseTGA=function(e){if(!e||e.constructor!==ArrayBuffer)throw"TGA: data must be ArrayBuffer";e=new Uint8Array(e);for(var t=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),r=e.subarray(0,12),s=0;s<r.length;s++)if(t[s]!=r[s])return console.error("TGA header is not valid"),null;var n=e.subarray(12,18),a={};a.width=n[1]*256+n[0],a.height=n[3]*256+n[2],a.bpp=n[4],a.bytesPerPixel=a.bpp/8,a.imageSize=a.width*a.height*a.bytesPerPixel,a.pixels=e.subarray(18,18+a.imageSize),a.pixels=new Uint8Array(a.pixels),a.flipY=(n[5]&32)==0;for(var s=0;s<a.imageSize;s+=a.bytesPerPixel){var o=a.pixels[s];a.pixels[s]=a.pixels[s+2],a.pixels[s+2]=o}return a.format=a.bpp==32?"RGBA":"RGB",a},GL$1.Texture.fromImage=function(e,t){t=t||{};var r=t.texture||new GL$1.Texture(e.width,e.height,t);return r.uploadImage(e,t),r.bind(),gl.texParameteri(r.texture_type,gl.TEXTURE_MAG_FILTER,r.magFilter||GL$1.Texture.DEFAULT_MAG_FILTER),gl.texParameteri(r.texture_type,gl.TEXTURE_MIN_FILTER,r.minFilter||GL$1.Texture.DEFAULT_MIN_FILTER),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_S,r.wrapS||GL$1.Texture.DEFAULT_WRAP_S),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_T,r.wrapT||GL$1.Texture.DEFAULT_WRAP_T),GL$1.isPowerOfTwo(r.width)&&GL$1.isPowerOfTwo(r.height)||gl.webgl_version>1?t.minFilter&&t.minFilter!=gl.NEAREST&&t.minFilter!=gl.LINEAR&&(r.bind(),gl.generateMipmap(r.texture_type),r.has_mipmaps=!0):(gl.texParameteri(r.texture_type,gl.TEXTURE_MIN_FILTER,GL$1.LINEAR),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_S,GL$1.CLAMP_TO_EDGE),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_T,GL$1.CLAMP_TO_EDGE),r.has_mipmaps=!1),gl.bindTexture(r.texture_type,null),r.data=e,t.keep_image&&(r.img=e),r},GL$1.Texture.fromVideo=function(e,t){t=t||{};var r=t.texture||new GL$1.Texture(e.videoWidth,e.videoHeight,t);return r.bind(),r.uploadImage(e,t),t.minFilter&&t.minFilter!=gl.NEAREST&&t.minFilter!=gl.LINEAR&&(r.bind(),gl.generateMipmap(r.texture_type),r.has_mipmaps=!0,r.data=e),gl.bindTexture(r.texture_type,null),r},GL$1.Texture.fromTexture=function(e,t){t=t||{};var r=new GL$1.Texture(e.width,e.height,t);return e.copyTo(r),r},GL$1.Texture.prototype.clone=function(e){var t=this.getProperties();if(e)for(var r in e)t[r]=e[r];return GL$1.Texture.fromTexture(this,t)},GL$1.Texture.fromMemory=function(e,t,r,s){s=s||{};var n=s.texture||new GL$1.Texture(e,t,s);return GL$1.Texture.setUploadOptions(s),n.bind(),r.constructor===Array&&(s.type==gl.FLOAT?r=new Float32Array(r):s.type==GL$1.HALF_FLOAT||s.type==GL$1.HALF_FLOAT_OES?r=new Uint16Array(r):r=new Uint8Array(r)),gl.texImage2D(gl.TEXTURE_2D,0,n.format,e,t,0,n.format,n.type,r),n.width=e,n.height=t,n.data=r,s.minFilter&&s.minFilter!=gl.NEAREST&&s.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),n.has_mipmaps=!0),gl.bindTexture(n.texture_type,null),n},GL$1.Texture.fromDDSInMemory=function(e,t){t=t||{};var r=t.texture||new GL$1.Texture(0,0,t);GL$1.Texture.setUploadOptions(t),r.bind();var s=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");return DDS.loadDDSTextureFromMemoryEx(gl,s,e,r,!0),gl.bindTexture(r.texture_type,null),r},GL$1.Texture.fromShader=function(e,t,r,s){s=s||{};var n=new GL$1.Texture(e,t,s);return n.drawTo(function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE);var a=Mesh.getScreenQuad();r.draw(a)}),n},GL$1.Texture.cubemapFromImages=function(e,t){if(t=t||{},e.length!=6)throw"missing images to create cubemap";var r=e[0].width,s=e[0].height;t.texture_type=gl.TEXTURE_CUBE_MAP;var n=null;t.texture?(n=t.texture,n.width=r,n.height=s):n=new GL$1.Texture(r,s,t),GL$1.Texture.setUploadOptions(t),n.bind();try{for(var a=0;a<6;a++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,n.format,n.format,n.type,e[a]);n.data=e}catch{throw location.protocol=="file:"?'image not loaded for security reasons (serve this page over "http://" instead)':"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}return t.minFilter&&t.minFilter!=gl.NEAREST&&t.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),n.has_mipmaps=!0),n.unbind(),n},GL$1.Texture.cubemapFromImage=function(e,t){if(t=t||{},e.width!=e.height/6&&e.height%6!=0&&!t.faces&&!t.is_polar)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",e.width,e.height),null;var r=e.width,s=e.height;if(t.is_polar){var p=t.size||GL$1.nearestPowerOfTwo(e.height),n=GL$1.Texture.fromImage(e,{ignore_pot:!0,wrap:gl.REPEAT,filter:gl.LINEAR}),a=new GL$1.Texture(p,p,{texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGBA});if(t.texture){var o=t.texture;for(var l in a)o[l]=a[l];a=o}var h=mat3.create(),c={u_texture:0,u_rotation:h};gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND);var u=GL$1.Shader.getPolarToCubemapShader();return a.drawTo(function(E,L){var T=GL$1.Texture.cubemap_camera_parameters[L];mat3.identity(h),h.set(T.right,0),h.set(T.up,3),h.set(T.dir,6),n.toViewport(u,c)}),t.keep_image&&(a.img=e),a}else t.is_cross!==void 0?(t.faces=GL$1.Texture.generateCubemapCrossFacesInfo(e.width,t.is_cross),r=s=e.width/4):t.faces?(r=t.width||t.faces[0].width,s=t.height||t.faces[0].height):s/=6;if(r!=s)return console.log("Texture not valid, width and height for every face must be square"),null;var p=r;t.no_flip=!0;for(var f=[],l=0;l<6;l++){var d=createCanvas(p,p),g=d.getContext("2d");t.faces?g.drawImage(e,t.faces[l].x,t.faces[l].y,t.faces[l].width||p,t.faces[l].height||p,0,0,p,p):g.drawImage(e,0,s*l,r,s,0,0,p,p),f.push(d)}var m=GL$1.Texture.cubemapFromImages(f,t);return t.keep_image&&(m.img=e),m},GL$1.Texture.generateCubemapCrossFacesInfo=function(e,t){t===void 0&&(t=1);var r=e/4;return[{x:2*r,y:r,width:r,height:r},{x:0,y:r,width:r,height:r},{x:t*r,y:0,width:r,height:r},{x:t*r,y:2*r,width:r,height:r},{x:r,y:r,width:r,height:r},{x:3*r,y:r,width:r,height:r}]},GL$1.Texture.cubemapFromURL=function(e,t,r){t=t||{},t=Object.create(t),t.texture_type=gl.TEXTURE_CUBE_MAP;var s=t.texture||new GL$1.Texture(1,1,t);s.bind(),GL$1.Texture.setUploadOptions(t);for(var n=t.temp_color||[0,0,0,255],a=t.type==gl.FLOAT?new Float32Array(n):new Uint8Array(n),o=0;o<6;o++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,s.format,1,1,0,s.format,s.type,a);gl.bindTexture(s.texture_type,null),s.ready=!1;var l=new Image;return l.src=e,l.onload=function(){t.texture=s,s=GL$1.Texture.cubemapFromImage(this,t),s&&delete s.ready,r&&r(s)},s},GL$1.Texture.prototype.getPixels=function(e,t){t=t||0;var r=this.gl,s=r.getViewport(),n=r.getParameter(r.FRAMEBUFFER_BINDING);if(this.format==r.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";r.disable(r.DEPTH_TEST);var a=r.__copy_fbo;a||(a=r.__copy_fbo=r.createFramebuffer()),r.bindFramebuffer(r.FRAMEBUFFER,a);var o=null,l=this.width>>t,h=this.height>>t;r.viewport(0,0,l,h),this.texture_type==r.TEXTURE_2D?r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.handler,t):this.texture_type==r.TEXTURE_CUBE_MAP&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+(e||0),this.handler,t);var c=this.format==r.RGB?3:4;c=4;var u=this.type;return u==r.UNSIGNED_BYTE?o=new Uint8Array(l*h*c):u==GL$1.HALF_FLOAT||u==GL$1.HALF_FLOAT_OES?o=new Uint16Array(l*h*c):o=new Float32Array(l*h*c),r.readPixels(0,0,l,h,c==3?r.RGB:r.RGBA,u,o),r.bindFramebuffer(r.FRAMEBUFFER,n),r.viewport(s[0],s[1],s[2],s[3]),o},GL$1.Texture.prototype.setPixels=function(e,t,r,s){var n={no_flip:t};s&&(n.cubemap_face=s),this.uploadData(e,n,r)},GL$1.Texture.prototype.getCubemapPixels=function(){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap";return[this.getPixels(0),this.getPixels(1),this.getPixels(2),this.getPixels(3),this.getPixels(4),this.getPixels(5)]},GL$1.Texture.prototype.setCubemapPixels=function(e,t){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap, it should be created with { texture_type: gl.TEXTURE_CUBE_MAP }";for(var r=0;r<6;++r)this.setPixels(e[r],t,r!=5,r)},GL$1.Texture.prototype.toCanvas=function(e,t,r){r=r||8192;var s=this.gl,n=Math.min(this.width,r),a=Math.min(this.height,r);this.texture_type==s.TEXTURE_CUBE_MAP&&(n=n*4,a=a*3),e=e||createCanvas(n,a),e.width!=n&&(e.width=n),e.height!=a&&(e.height=a);var o=null;if(this.texture_type==s.TEXTURE_2D){if(this.width!=n||this.height!=a||this.type!=s.UNSIGNED_BYTE){var l=new GL$1.Texture(n,a,{format:s.RGBA,filter:s.NEAREST});this.copyTo(l),o=l.getPixels()}else o=this.getPixels();var h=e.getContext("2d"),c=h.getImageData(0,0,n,a);if(c.data.set(o),h.putImageData(c,0,0),t){var l=createCanvas(n,a),u=l.getContext("2d");u.translate(0,l.height),u.scale(1,-1),u.drawImage(e,0,0,l.width,l.height),h.clearRect(0,0,h.canvas.width,h.canvas.height),h.drawImage(l,0,0)}}else if(this.texture_type==s.TEXTURE_CUBE_MAP){var p=createCanvas(this.width,this.height),u=p.getContext("2d"),f=GL$1.Texture.generateCubemapCrossFacesInfo(e.width,1),h=e.getContext("2d");h.fillStyle="black",h.fillRect(0,0,e.width,e.height);var d=this;this.type!=s.UNSIGNED_BYTE&&(d=new GL$1.Texture(this.width,this.height,{format:s.RGBA,texture_type:s.TEXTURE_CUBE_MAP,filter:s.NEAREST,type:s.UNSIGNED_BYTE}),this.copyTo(d));for(var g=0;g<6;g++){var c=u.getImageData(0,0,p.width,p.height);o=d.getPixels(g),c.data.set(o),u.putImageData(c,0,0),h.drawImage(p,f[g].x,f[g].y,p.width,p.height)}}return e},GL$1.Texture.binary_extension="png",GL$1.Texture.prototype.toBinary=function(e,t){for(var r=this.toCanvas(null,e),s=r.toDataURL(t),n=s.indexOf(","),a=s.substr(n+1),o=atob(a),l=o.length,h=new Uint8Array(l),c=0;c<l;++c)h[c]=o.charCodeAt(c);return h},GL$1.Texture.prototype.toBlob=function(e,t){var r=this.toBinary(e),s=new Blob([r],{type:t||"image/png"});return s},GL$1.Texture.prototype.toBlobAsync=function(e,t,r){var s=this.toCanvas(null,e);if(s.toBlob){s.toBlob(r,t);return}var n=this.toBlob(e,t);r&&r(n)},GL$1.Texture.prototype.toBase64=function(e){var t=this.width,r=this.height,s=this.getPixels(),n=createCanvas(t,r),a=n.getContext("2d"),o=a.getImageData(0,0,t,r);if(o.data.set(s),a.putImageData(o,0,0),e){var l=createCanvas(t,r),h=l.getContext("2d");h.translate(0,r),h.scale(1,-1),h.drawImage(n,0,0),n=l}var c=n.toDataURL("image/png");return c},GL$1.Texture.prototype.generateMetadata=function(){var e={};e.width=this.width,e.height=this.height,this.metadata=e},GL$1.Texture.compareFormats=function(e,t){return!e||!t?!1:e==t?!0:!(e.width!=t.width||e.height!=t.height||e.type!=t.type||e.format!=t.format||e.texture_type!=t.texture_type)},GL$1.Texture.blend=function(e,t,r,s){if(!e||!t)return!1;if(e==t)return s?e.copyTo(s):e.toViewport(),!0;gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE);var n=GL$1.Shader.getBlendShader(),a=GL$1.Mesh.getScreenQuad();return t.bind(1),n.uniforms({u_texture:0,u_texture2:1,u_factor:r}),s?(s.drawTo(function(){if(e==s||t==s)throw"Blend output cannot be the same as the input";e.bind(0),n.draw(a,gl.TRIANGLES)}),!0):(e.bind(0),n.draw(a,gl.TRIANGLES),!0)},GL$1.Texture.cubemapToTexture2D=function(e,t,r,s,n){if(!e||e.texture_type!=gl.TEXTURE_CUBE_MAP)throw"No cubemap in convert";t=t||e.width;var a=s?e.type:gl.UNSIGNED_BYTE;n=n||0,r||(r=new GL$1.Texture(t*2,t,{minFilter:gl.NEAREST,type:a}));var o=gl.shaders.cubemap_to_texture2D;return o||(o=gl.shaders.cubemap_to_texture2D=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,`		precision mediump float;
		#define PI 3.14159265358979323846264
		uniform samplerCube texture;		varying vec2 v_coord;		uniform float u_yaw;
		void main() {			float alpha = ((1.0 - v_coord.x) * 2.0) * PI + u_yaw;			float beta = (v_coord.y * 2.0 - 1.0) * PI * 0.5;			vec3 N = vec3( -cos(alpha) * cos(beta), sin(beta), sin(alpha) * cos(beta) );			gl_FragColor = textureCube(texture,N);		}`)),o.setUniform("u_yaw",n),r.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),e.toViewport(o)}),r},GL$1.Texture.getWhiteTexture=function(e){e=e||global$1.gl;var t=e.textures[":white"];if(t)return t;var r=new Uint8Array([255,255,255,255]);return e.textures[":white"]=new GL$1.Texture(1,1,{pixel_data:r})},GL$1.Texture.getBlackTexture=function(e){e=e||global$1.gl;var t=e.textures[":black"];if(t)return t;var r=new Uint8Array([0,0,0,255]);return e.textures[":black"]=new GL$1.Texture(1,1,{pixel_data:r})},GL$1.Texture.getTemporary=function(e,t,r,s){s=s||global$1.gl,s._texture_pool||(s._texture_pool=[]);var n=GL$1.TEXTURE_2D,a=GL$1.Texture.DEFAULT_TYPE,o=GL$1.Texture.DEFAULT_FORMAT;r&&(r.texture_type&&(n=r.texture_type),r.type&&(a=r.type),r.format&&(o=r.format));for(var l=n+":"+a+":"+e+"x"+t+":"+o,h=s._texture_pool,c=0;c<h.length;++c){var u=h[c];if(u._key==l)return h.splice(c,1),u._pool=0,u}var u=new GL$1.Texture(e,t,{type:a,texture_type:n,format:o,filter:s.LINEAR});return u._key=l,u._pool=0,u},GL$1.Texture.releaseTemporary=function(e,t){t=t||global$1.gl,t._texture_pool||(t._texture_pool=[]),e._pool>0&&console.warn("this texture is already in the textures pool");var r=t._texture_pool;if(r||(r=t._texture_pool=[]),e._pool=global$1.getTime(),r.push(e),r.length>20){r.sort(function(n,a){return a._pool-n._pool});var e=r.pop();e._pool=0,e.delete()}},GL$1.Texture.nextPOT=function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.log(2)))};function FBO(e,t,r,s){if(s=s||global$1.gl,this.gl=s,this._context_id=s.context_id,e&&e.constructor!==Array)throw"FBO textures must be an Array";this.handler=null,this.width=-1,this.height=-1,this.color_textures=[],this.depth_texture=null,this.stencil=!!r,this._stencil_enabled=!1,this._num_binded_textures=0,this.order=null,(e&&e.length||t)&&this.setTextures(e,t),this._old_fbo_handler=null,this._old_viewport=new Float32Array(4)}GL$1.FBO=FBO,FBO.prototype.setTextures=function(e,t,r){if(t&&t.constructor===GL$1.Texture){if(t.format!==GL$1.DEPTH_COMPONENT&&t.format!==GL$1.DEPTH_STENCIL&&t.format!==GL$1.DEPTH_COMPONENT16&&t.format!==GL$1.DEPTH_COMPONENT24&&t.format!==GL$1.DEPTH_COMPONENT32F)throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT, gl.DEPTH_STENCIL or gl.DEPTH_COMPONENT16/24/32F (only in webgl2)";if(t.type!=GL$1.UNSIGNED_SHORT&&t.type!=GL$1.UNSIGNED_INT&&t.type!=GL$1.UNSIGNED_INT_24_8_WEBGL&&t.type!=GL$1.FLOAT)throw"FBO Depth texture must be of type: gl.UNSIGNED_SHORT, gl.UNSIGNED_INT, gl.UNSIGNED_INT_24_8_WEBGL"}var s=this.depth_texture==t;if(s&&e){if(e.constructor!==Array)throw"FBO: color_textures parameter must be an array containing all the textures to be binded in the color";if(e.length==this.color_textures.length){for(var n=0;n<e.length;++n)if(e[n]!=this.color_textures[n]){s=!1;break}}else s=!1}if(this._stencil_enabled!==this.stencil&&(s=!1),!s){if(this.color_textures.length=e?e.length:0,e)for(var n=0;n<e.length;++n)this.color_textures[n]=e[n];this.depth_texture=t,this.update(r)}},FBO.prototype.update=function(e){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING),this.handler||(this.handler=gl.createFramebuffer());var t=-1,r=-1,s=null,n=null,a=this.color_textures,o=this.depth_texture;if(a&&a.length)for(var l=0;l<a.length;l++){var h=a[l];if(h.constructor!==GL$1.Texture)throw"FBO can only bind instances of GL.Texture";if(t==-1)t=h.width;else if(t!=h.width)throw"Cannot bind textures with different dimensions";if(r==-1)r=h.height;else if(r!=h.height)throw"Cannot bind textures with different dimensions";if(s==null)s=h.type,n=h.format;else if(s!=h.type)throw"Cannot bind textures to a FBO with different pixel formats";if(h.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO"}else t=o.width,r=o.height;this.width=t,this.height=r,gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);var c=gl.extensions.WEBGL_draw_buffers;if(gl.webgl_version==1&&!c&&a&&a.length>1)throw"Rendering to several textures not supported by your browser";var u=gl.webgl_version==1?gl.FRAMEBUFFER:gl.DRAW_FRAMEBUFFER;if(gl.framebufferRenderbuffer(u,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,null),gl.framebufferRenderbuffer(u,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,null),o&&o.constructor===GL$1.Texture){if(gl.webgl_version==1&&!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";this.stencil&&o.format!==gl.DEPTH_STENCIL&&console.warn("Stencil cannot be enabled if there is a depth texture with a DEPTH_STENCIL format"),o.format==gl.DEPTH_STENCIL?gl.framebufferTexture2D(u,gl.DEPTH_STENCIL_ATTACHMENT,gl.TEXTURE_2D,o.handler,0):gl.framebufferTexture2D(u,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,o.handler,0)}else{var p=null;o&&o.constructor===WebGLRenderbuffer&&o.width==t&&o.height==r?p=this._depth_renderbuffer=o:(p=this._depth_renderbuffer=this._depth_renderbuffer||gl.createRenderbuffer(),p.width=t,p.height=r),gl.bindRenderbuffer(gl.RENDERBUFFER,p),this.stencil?(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,t,r),gl.framebufferRenderbuffer(u,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,p)):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,t,r),gl.framebufferRenderbuffer(u,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,p))}if(a&&a.length){this.order=[];for(var l=0;l<a.length;l++){var h=a[l];gl.framebufferTexture2D(u,gl.COLOR_ATTACHMENT0+l,gl.TEXTURE_2D,h.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+l)}}else{var f=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer();f.width=t,f.height=r,gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,t,r),gl.framebufferRenderbuffer(u,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,f)}for(var d=a?a.length:0,l=d;l<this._num_binded_textures;++l)gl.framebufferTexture2D(u,gl.COLOR_ATTACHMENT0+l,gl.TEXTURE_2D,null,0);this._num_binded_textures=d,this._stencil_enabled=this.stencil,a&&a.length>1&&(c?c.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order));var g=gl.checkFramebufferStatus(u);if(g!==gl.FRAMEBUFFER_COMPLETE)throw n==GL$1.RGB&&(s==GL$1.FLOAT||s==GL$1.HALF_FLOAT_OES)&&console.error("Tip: Firefox does not support RGB channel float/half_float textures, you must use RGBA"),"FBO not complete: "+g;gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),e||gl.bindFramebuffer(u,this._old_fbo_handler)},FBO.prototype.bind=function(e){if(this.multi_sample){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING),this._old_viewport.set(gl.viewport_data),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,this.colorRenderbuffer),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer),gl.viewport(0,0,this.width,this.height),FBO.current=this;return}if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data),e?this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING):this._old_fbo_handler=null,this._old_fbo_handler!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);for(var t=0;t<this.color_textures.length;++t)this.color_textures[t]._in_current_fbo=!0;this.depth_texture&&(this.depth_texture._in_current_fbo=!0),gl.viewport(0,0,this.width,this.height),FBO.current=this},FBO.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler),this._old_fbo_handler=null,gl.setViewport(this._old_viewport);for(var e=0;e<this.color_textures.length;++e)this.color_textures[e]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1),FBO.current=null},FBO.prototype.switchTo=function(e){e._old_fbo_handler=this._old_fbo_handler,e._old_viewport.set(this._old_viewport),gl.bindFramebuffer(gl.FRAMEBUFFER,e.handler),this._old_fbo_handler=null,gl.viewport(0,0,this.width,this.height);for(var t=0;t<this.color_textures.length;++t)this.color_textures[t]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);for(var t=0;t<e.color_textures.length;++t)e.color_textures[t]._in_current_fbo=!0;e.depth_texture&&(e.depth_texture._in_current_fbo=!0),FBO.current=e},FBO.prototype.delete=function(){gl.deleteFramebuffer(this.handler),this.handler=null},FBO.supported={},FBO.testSupport=function(e,t){var r=e+":"+t;if(FBO.supported[r]!=null)return FBO.supported[r];var s=new GL$1.Texture(1,1,{format:t,type:e});try{var n=new GL$1.FBO([s])}catch{return console.warn("This browser WEBGL implementation doesn't support this FBO format: "+GL$1.reverse[e]+" "+GL$1.reverse[t]),FBO.supported[r]=!1}return FBO.supported[r]=!0,!0},FBO.prototype.toSingle=function(e){if(e=e||0,!(this.color_textures.length<2)){var t=gl.extensions.WEBGL_draw_buffers;t?t.drawBuffersWEBGL([this.order[e]]):gl.drawBuffers([this.order[e]])}},FBO.prototype.toMulti=function(){if(!(this.color_textures.length<2)){var e=gl.extensions.WEBGL_draw_buffers;e?e.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}},FBO.prototype.clearSecondary=function(e){if(!(!this.order||this.order.length<2)){for(var t=gl.extensions.WEBGL_draw_buffers,r=[gl.NONE],s=1;s<this.order.length;++s)r.push(this.order[s]);t?t.drawBuffersWEBGL(r):gl.drawBuffers(r),gl.clearColor(e[0],e[1],e[2],e[3]),gl.clear(gl.COLOR_BUFFER_BIT),t?t.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}},FBO.prototype.makeMultiSample=function(e,t,r,s){if(this.gl.webgl_version==1)throw"cannot use makeMultiSample in webgl 1.0";this.width=e,this.height=t,r=r||4,s=s||{};var n=s.format||gl.RGBA8,a=gl.DEPTH_COMPONENT16;this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING),this.handler=gl.createFramebuffer(),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),this.colorRenderbuffer=gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,this.colorRenderbuffer),gl.renderbufferStorageMultisample(gl.RENDERBUFFER,r,n,this.width,this.height),this.depthRenderbuffer=gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthRenderbuffer),gl.renderbufferStorageMultisample(gl.RENDERBUFFER,r,a,this.width,this.height),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,this.colorRenderbuffer),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer),gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler),this._old_fbo_handler=null,this.multi_sample=!0},FBO.prototype.blitMultisample=function(e){if(!e||e.constructor!==GL$1.FBO)throw"parameter must be GL.FBO";gl.bindFramebuffer(gl.READ_FRAMEBUFFER,this.handler),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,e.handler),gl.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,gl.COLOR_BUFFER_BIT,gl.LINEAR),gl.bindFramebuffer(gl.READ_FRAMEBUFFER,null),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler),this._old_fbo_handler=null,gl.setViewport(this._old_viewport)},global$1.Shader=GL$1.Shader=function e(t,r,s){if(GL$1.debug&&console.log("GL.Shader created"),!t||!r)throw"GL.Shader source code parameter missing";this._context_id=global$1.gl.context_id;var n=this.gl=global$1.gl,a=e.expandMacros(s),o=t.constructor===String?e.injectCode(a,t,n):t,l=r.constructor===String?e.injectCode(a,r,n):r;this.program=n.createProgram();var h=t.constructor===String?GL$1.Shader.compileSource(n.VERTEX_SHADER,o):t,c=r.constructor===String?GL$1.Shader.compileSource(n.FRAGMENT_SHADER,l):r;n.attachShader(this.program,h,n),n.attachShader(this.program,c,n),n.linkProgram(this.program),this.vs_shader=h,this.fs_shader=c,this.attributes={},this.uniformInfo={},this.samplers={},e.use_async?this._first_use=!0:this.checkLink()},Shader.use_async=!0,Shader.expandMacros=function(e){var t="";if(e)for(var r in e)t+="#define "+r+" "+(e[r]?e[r]:"")+`
`;return t},Shader.injectCode=function(e,t,r){var s=t.indexOf(`
`),n=r?"#define WEBGL"+r.webgl_version+`
`:"",a=t.substr(0,s).trim();return a.indexOf("#version")==-1?n+e+t:a+`
`+n+e+t.substr(s)},Shader.compileSource=function(e,t,r,s){return r=r||global$1.gl,s=s||r.createShader(e),r.shaderSource(s,t),r.compileShader(s),s},Shader.parseError=function(e,t,r){if(!e)return null;var s=e.split(" "),n=s[5].split(":");return{type:s[0],line_number:parseInt(n[1]),line_pos:parseInt(n[0]),line_code:(s[0]=="Fragment"?r:t).split(`
`)[parseInt(n[1])],err:e}},Shader.prototype.delete=function(){this.program&&this.gl.deleteProgram(this.program),this.vs_shader&&this.gl.deleteShader(this.vs_shader),this.fs_shader&&this.gl.deleteShader(this.fs_shader),this.gl=null,this.attributes={},this.uniformInfo={},this.samplers={}},Shader.prototype.updateShader=function(e,t,r){var s=this.gl||global$1.gl,n=Shader.expandMacros(r);this.program?(s.detachShader(this.program,this.vs_shader),s.detachShader(this.program,this.fs_shader)):this.program=s.createProgram();var n=Shader.expandMacros(r),a=e.constructor===String?Shader.injectCode(n,e,s):e,o=t.constructor===String?Shader.injectCode(n,t,s):t,l=e.constructor===String?GL$1.Shader.compileSource(s.VERTEX_SHADER,a):e,h=t.constructor===String?GL$1.Shader.compileSource(s.FRAGMENT_SHADER,o):t;s.attachShader(this.program,l,s),s.attachShader(this.program,h,s),s.linkProgram(this.program),this.vs_shader=l,this.fs_shader=h,this.attributes={},this.uniformInfo={},this.samplers={},Shader.use_async?this._first_use=!0:this.checkLink()},Shader.prototype.extractShaderInfo=function(){for(var e=this.gl,t=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS),r=0;r<t;++r){var s=e.getActiveUniform(this.program,r);if(!s)break;var n=s.name,a=n.indexOf("[");if(a!=-1){var o=n.indexOf("].");o==-1&&(n=n.substr(0,a))}(s.type==GL$1.SAMPLER_2D||s.type==GL$1.SAMPLER_CUBE||s.type==GL$1.SAMPLER_3D||s.type==GL$1.INT_SAMPLER_2D||s.type==GL$1.INT_SAMPLER_CUBE||s.type==GL$1.INT_SAMPLER_3D||s.type==GL$1.UNSIGNED_INT_SAMPLER_2D||s.type==GL$1.UNSIGNED_INT_SAMPLER_CUBE||s.type==GL$1.UNSIGNED_INT_SAMPLER_3D)&&(this.samplers[n]=s.type);var l=Shader.getUniformFunc(s),h=!1;(s.type==e.FLOAT_MAT2||s.type==e.FLOAT_MAT3||s.type==e.FLOAT_MAT4)&&(h=!0);var c=GL$1.TYPE_LENGTH[s.type]||1;this.uniformInfo[n]={type:s.type,func:l,size:s.size,type_length:c,is_matrix:h,loc:e.getUniformLocation(this.program,n),data:new Float32Array(c*s.size)}}for(var r=0,t=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES);r<t;++r){var s=e.getActiveAttrib(this.program,r);if(!s)break;var l=Shader.getUniformFunc(s),c=GL$1.TYPE_LENGTH[s.type]||1;this.uniformInfo[s.name]={type:s.type,func:l,type_length:c,size:s.size,loc:null},s.name!=="gl_VertexID"&&(this.attributes[s.name]=e.getAttribLocation(this.program,s.name))}},Shader.prototype.hasUniform=function(e){return this.uniformInfo[e]},Shader.prototype.hasAttribute=function(e){return this.attributes[e]},Shader.getUniformFunc=function(e){var t=null;switch(e.type){case GL$1.FLOAT:e.size==1?t=gl.uniform1f:t=gl.uniform1fv;break;case GL$1.FLOAT_MAT2:t=gl.uniformMatrix2fv;break;case GL$1.FLOAT_MAT3:t=gl.uniformMatrix3fv;break;case GL$1.FLOAT_MAT4:t=gl.uniformMatrix4fv;break;case GL$1.FLOAT_VEC2:t=gl.uniform2fv;break;case GL$1.FLOAT_VEC3:t=gl.uniform3fv;break;case GL$1.FLOAT_VEC4:t=gl.uniform4fv;break;case GL$1.UNSIGNED_INT:case GL$1.INT:e.size==1?t=gl.uniform1i:t=gl.uniform1iv;break;case GL$1.INT_VEC2:t=gl.uniform2iv;break;case GL$1.INT_VEC3:t=gl.uniform3iv;break;case GL$1.INT_VEC4:t=gl.uniform4iv;break;case GL$1.SAMPLER_2D:case GL$1.SAMPLER_3D:case GL$1.SAMPLER_CUBE:case GL$1.INT_SAMPLER_2D:case GL$1.INT_SAMPLER_3D:case GL$1.INT_SAMPLER_CUBE:case GL$1.UNSIGNED_INT_SAMPLER_2D:case GL$1.UNSIGNED_INT_SAMPLER_3D:case GL$1.UNSIGNED_INT_SAMPLER_CUBE:t=gl.uniform1i;break;default:t=gl.uniform1f;break}return t},Shader.fromURL=function(e,t,r){var s=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute mat4 u_mvp;
			void main() { 
				gl_Position = u_mvp * vec4(a_vertex,1.0); 
			}
		`,n=`
			precision highp float;
			void main() {
				gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
			`,a=new GL$1.Shader(s,n);a.ready=!1;var o=null,l=null;global$1.HttpRequest(e,null,function(c){o=c,l&&h()}),global$1.HttpRequest(t,null,function(c){l=c,o&&h()});function h(){var c=new GL$1.Shader(o,l);for(var u in c)a[u]=c[u];a.ready=!0}return a},Shader.prototype.checkLink=function(){if(this._first_use=!1,!gl.getShaderParameter(this.vs_shader,gl.COMPILE_STATUS))throw"Vertex shader compile error: "+gl.getShaderInfoLog(this.vs_shader);if(!gl.getShaderParameter(this.fs_shader,gl.COMPILE_STATUS))throw"Fragment shader compile error: "+gl.getShaderInfoLog(this.fs_shader);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS))throw"link error: "+gl.getProgramInfoLog(this.program);this.extractShaderInfo()},Shader.prototype.bind=function(){var e=this.gl;Shader.use_async&&this._first_use&&(this.checkLink(),this._first_use=!1),e.useProgram(this.program),e._current_shader=this},Shader.prototype.getLocation=function(e){var t=this.uniformInfo[e];return t?this.uniformInfo[e].loc:null},Shader._temp_uniform=new Float32Array(16),Shader.prototype.uniforms=function(e){var t=this.gl;this._first_use&&this.checkLink(),t.useProgram(this.program),t._current_shader=this;for(var r in e){var s=this.uniformInfo[r];s&&this._setUniform(r,e[r])}return this},Shader.prototype.uniformsArray=function(e){var t=this.gl;this._first_use&&this.checkLink(),t.useProgram(this.program),t._current_shader=this;for(var r=0,s=e.length;r<s;++r){var n=e[r];for(var a in n)this._setUniform(a,n[a])}return this},Shader.prototype.setUniform=function(){return function(e,t){this.gl._current_shader!=this&&this.bind();var r=this.uniformInfo[e];r&&r.loc!==null&&t!=null&&(t.constructor===Array&&(r.data.set(t),t=r.data),r.is_matrix?r.func.call(this.gl,r.loc,!1,t):r.func.call(this.gl,r.loc,t))}}(),Shader.prototype._setUniform=function(){return function(e,t){this._first_use&&this.checkLink();var r=this.uniformInfo[e];r&&r.loc!==null&&t!=null&&(t.constructor===Array&&(r.data.set(t),t=r.data),r.is_matrix?r.func.call(this.gl,r.loc,!1,t):r.func.call(this.gl,r.loc,t))}}(),Shader.prototype.draw=function(e,t,r){r=r===void 0?t==gl.LINES?"lines":"triangles":r,this.drawBuffers(e.vertexBuffers,r?e.indexBuffers[r]:null,arguments.length<2?gl.TRIANGLES:t)},Shader.prototype.drawRange=function(e,t,r,s,n){n=n===void 0?t==gl.LINES?"lines":"triangles":n,this.drawBuffers(e.vertexBuffers,n?e.indexBuffers[n]:null,t,r,s)};var temp_attribs_array=new Uint8Array(16),temp_attribs_array_zero=new Uint8Array(16);Shader.prototype.drawBuffers=function(e,t,r,s,n){if(n!=0){var a=this.gl;this._first_use&&this.checkLink(),a.useProgram(this.program);var o=0,l=temp_attribs_array;l.set(temp_attribs_array_zero);for(var h in e){var c=e[h],u=c.attribute||h,p=this.attributes[u];p==null||!c.buffer||(l[p]=1,a.bindBuffer(a.ARRAY_BUFFER,c.buffer),a.enableVertexAttribArray(p),a.vertexAttribPointer(p,c.buffer.spacing,c.buffer.gl_type,c.normalize,0,0),o=c.buffer.length/c.buffer.spacing)}var f=0;s>0&&(f=s),t&&(o=t.buffer.length-f),n>0&&n<o&&(o=n);var d=t&&t.data?t.data.constructor.BYTES_PER_ELEMENT:1;f*=d;for(var u in this.attributes){var p=this.attributes[u];l[p]||a.disableVertexAttribArray(this.attributes[u])}return o&&(!t||t.buffer)&&(t?(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,t.buffer),a.drawElements(r,o,t.buffer.gl_type,f),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null)):a.drawArrays(r,f,o),a.draw_calls++),this}},Shader._instancing_arrays=[],Shader.prototype.drawInstanced=function(e,t,r,s,n,a,o){if(a!==0){var l=this.gl;if(l.webgl_version==1&&!l.extensions.ANGLE_instanced_arrays)throw"instancing not supported";this._first_use&&this.checkLink(),l.useProgram(this.program);var h=0,c=temp_attribs_array;c.set(temp_attribs_array_zero);var u=e.vertexBuffers;for(var p in u){var f=u[p],d=f.attribute||p,g=this.attributes[d];g==null||!f.buffer||(c[g]=1,l.bindBuffer(l.ARRAY_BUFFER,f.buffer),l.enableVertexAttribArray(g),l.vertexAttribPointer(g,f.buffer.spacing,f.buffer.gl_type,f.normalize,0,0),h=f.buffer.length/f.buffer.spacing)}var m=null;r&&(r.constructor===String?m=e.getIndexBuffer(r):r.constructor===GL$1.Buffer&&(m=r));var b=0;n>0&&(b=n),m&&(h=m.buffer.length-b),a>0&&a<h&&(h=a);var E=m&&m.data?m.data.constructor.BYTES_PER_ELEMENT:1;b*=E;for(var d in this.attributes){var g=this.attributes[d];c[g]||l.disableVertexAttribArray(this.attributes[d])}var L=l.extensions.ANGLE_instanced_arrays,T=0,_=0;for(var I in s){var A=s[I];T=A.length;var M=this.attributes[I];if(M==null)return;var O=0,C=0;A.constructor===Array?(O=A[0].constructor===Number?1:A[0].length,C=O*A.length):(O=this.uniformInfo[I].type_length,C=A.length,T=C/O);var P=Shader._instancing_arrays[_];if((!P||P.data.length<C)&&(P=Shader._instancing_arrays[_]={data:new Float32Array(C),buffer:l.createBuffer()}),P.uniform=I,P.element_size=O,A.constructor===Array)for(var N=0;N<A.length;++N)P.data.set(A[N],N*O);else P.data.set(A);if(l.bindBuffer(l.ARRAY_BUFFER,P.buffer),l.bufferData(l.ARRAY_BUFFER,P.data,l.STREAM_DRAW),O==16)for(var k=0;k<4;++k)l.enableVertexAttribArray(M+k),l.vertexAttribPointer(M+k,4,l.FLOAT,!1,16*4,k*4*4),L?L.vertexAttribDivisorANGLE(M+k,1):l.vertexAttribDivisor(M+k,1);else l.enableVertexAttribArray(M),l.vertexAttribPointer(M,O,l.FLOAT,!1,O*4,0),L?L.vertexAttribDivisorANGLE(M,1):l.vertexAttribDivisor(M,1);_+=1}o&&(T=o),L?m?(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,m.buffer),L.drawElementsInstancedANGLE(t,h,m.buffer.gl_type,b,T),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null)):L.drawArraysInstancedANGLE(t,b,h,T):m?(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,m.buffer),l.drawElementsInstanced(t,h,m.buffer.gl_type,b,T),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null)):l.drawArraysInstanced(t,b,h,T);for(var B=0;B<_;++B){var S=Shader._instancing_arrays[B],M=this.attributes[S.uniform],O=S.element_size;if(O==16)for(var k=0;k<4;++k)l.disableVertexAttribArray(M+k),L?L.vertexAttribDivisorANGLE(M+k,0):l.vertexAttribDivisor(M+k,0);else l.enableVertexAttribArray(M),L?L.vertexAttribDivisorANGLE(M,0):l.vertexAttribDivisor(M,0)}return this}},Shader.expandImports=function(e,t){t=t||Shader.files;var r={};if(!t)throw"Shader.files not initialized, assign files there";var s=function(n){var a=n.split('"'),o=a[1];if(r[o])return"//already imported: "+o+`
`;var l=t[o];return r[o]=!0,l?l+`
`:"//import code not found: "+o+`
`};return e.replace(/#import\s+"([a-zA-Z0-9_.]+)"\s*\n/g,s)},Shader.dumpErrorToConsole=function(e,t,r){console.error(e),e.msg;var s=null;e.indexOf("Fragment")!=-1?s=r:s=t;var n=s.split(`
`);for(var a in n)n[a]=a+"| "+n[a];console.groupCollapsed("Shader code"),console.log(n.join(`
`)),console.groupEnd()},Shader.convertTo100=function(e,t){},Shader.convertTo300=function(e,t){},Shader.validateValue=function(e,t){if(e==null)return!1;switch(t.type){case GL$1.INT:case GL$1.FLOAT:case GL$1.SAMPLER_2D:case GL$1.SAMPLER_3D:case GL$1.SAMPLER_CUBE:case GL$1.INT_SAMPLER_2D:case GL$1.INT_SAMPLER_3D:case GL$1.INT_SAMPLER_CUBE:case GL$1.UNSIGNED_INT_SAMPLER_2D:case GL$1.UNSIGNED_INT_SAMPLER_3D:case GL$1.UNSIGNED_INT_SAMPLER_CUBE:return global$1.isNumber(e);case GL$1.INT_VEC2:case GL$1.FLOAT_VEC2:return e.length===2;case GL$1.INT_VEC3:case GL$1.FLOAT_VEC3:return e.length===3;case GL$1.INT_VEC4:case GL$1.FLOAT_VEC4:case GL$1.FLOAT_MAT2:return e.length===4;case GL$1.FLOAT_MAT3:return e.length===8;case GL$1.FLOAT_MAT4:return e.length===16}return!0},Shader.DEFAULT_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec3 a_normal;
			attribute vec2 a_coord;
			varying vec3 v_position;
			varying vec3 v_normal;
			varying vec2 v_coord;
			uniform mat4 u_model;
			uniform mat4 u_mvp;
			void main() {
				v_position = (u_model * vec4(a_vertex,1.0)).xyz;
				v_normal = (u_model * vec4(a_normal,0.0)).xyz;
				v_coord = a_coord;
				gl_Position = u_mvp * vec4(a_vertex,1.0);
			}
			`,Shader.SCREEN_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			void main() { 
				v_coord = a_coord; 
				gl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); 
			}
			`,Shader.SCREEN_300_VERTEX_SHADER=`#version 300 es
			precision highp float;
			in vec3 a_vertex;
			in vec2 a_coord;
			out vec2 v_coord;
			void main() { 
				v_coord = a_coord; 
				gl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); 
			}
			`,Shader.SCREEN_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = texture2D(u_texture, v_coord);
			}
			`,Shader.SCREEN_FRAGMENT_FX=`
			precision highp float;
			uniform sampler2D u_texture;
			varying vec2 v_coord;
			#ifdef FX_UNIFORMS
				FX_UNIFORMS
			#endif
			void main() {
				vec2 uv = v_coord;
				vec4 color = texture2D(u_texture, uv);
				#ifdef FX_CODE
					FX_CODE ;
				#endif
				gl_FragColor = color;
			}
			`,Shader.SCREEN_COLORED_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = u_color * texture2D(u_texture, v_coord);
			}
			`,Shader.BLEND_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform sampler2D u_texture2;
			uniform float u_factor;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);
			}
			`,Shader.QUAD_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			uniform vec2 u_position;
			uniform vec2 u_size;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			void main() { 
				vec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);
				v_coord = a_coord; 
				pos = u_transform * pos;
				pos.z = 0.0;
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
			}
			`,Shader.QUAD_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = u_color * texture2D(u_texture, v_coord);
			}
			`,Shader.QUAD2_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			uniform vec4 u_texture_area;
			varying vec2 v_coord;
			void main() {
			    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );
				gl_FragColor = u_color * texture2D(u_texture, uv);
			}
			`,Shader.PRIMITIVE2D_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			void main() { 
				vec3 pos = a_vertex;
				pos = u_transform * pos;
				pos.z = 0.0;
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
			}
			`,Shader.FLAT_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			uniform mat4 u_mvp;
			void main() { 
				gl_Position = u_mvp * vec4(a_vertex,1.0); 
			}
			`,Shader.FLAT_FRAGMENT_SHADER=`
			precision highp float;
			uniform vec4 u_color;
			void main() {
				gl_FragColor = u_color;
			}
			`,Shader.SCREEN_FLAT_FRAGMENT_SHADER=Shader.FLAT_FRAGMENT_SHADER,Shader.createFX=function(e,t,r){e=GL$1.Shader.removeComments(e,!0),t=GL$1.Shader.removeComments(t,!0);var s={FX_CODE:e,FX_UNIFORMS:t||""};return r?(r.updateShader(GL$1.Shader.SCREEN_VERTEX_SHADER,GL$1.Shader.SCREEN_FRAGMENT_FX,s),r):new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,GL$1.Shader.SCREEN_FRAGMENT_FX,s)},Shader.replaceCodeUsingContext=function(e,t){return e.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(r){return r=r.replace(/[{}]/g,""),t[r]||""})},Shader.removeComments=function(s,t){if(!s)return"";for(var r=/(\/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+\/)|(\/\/.*)/g,s=s.replace(r,""),n=s.split(`
`),a=[],o=0;o<n.length;++o){var l=n[o],h=l.indexOf("//");h!=-1&&(l=n[o].substr(0,h)),l=l.trim(),l.length&&a.push(l)}return a.join(t?"":`
`)},Shader.prototype.toViewport=function(e){var t=GL$1.Mesh.getScreenQuad();e&&this.uniforms(e),this.draw(t)},Shader.getScreenShader=function(e){e=e||global$1.gl;var t=e.shaders[":screen"];return t||(t=e.shaders[":screen"]=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER),t.uniforms({u_texture:0}))},Shader.getFlatScreenShader=function(e){e=e||global$1.gl;var t=e.shaders[":flat_screen"];return t||(t=e.shaders[":flat_screen"]=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER),t.uniforms({u_color:[1,1,1,1]}))},Shader.getColoredScreenShader=function(e){e=e||global$1.gl;var t=e.shaders[":colored_screen"];return t||(t=e.shaders[":colored_screen"]=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER),t.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)}))},Shader.getQuadShader=function(e){e=e||global$1.gl;var t=e.shaders[":quad"];return t||(e.shaders[":quad"]=new GL$1.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER))},Shader.getPartialQuadShader=function(e){e=e||global$1.gl;var t=e.shaders[":quad2"];return t||(e.shaders[":quad2"]=new GL$1.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER))},Shader.getBlendShader=function(e){e=e||global$1.gl;var t=e.shaders[":blend"];return t||(e.shaders[":blend"]=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.BLEND_FRAGMENT_SHADER))},Shader.getBlurShader=function(e){e=e||global$1.gl;var t=e.shaders[":blur"];if(t)return t;var t=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_offset;
			uniform float u_intensity;
			void main() {
			   vec4 sum = vec4(0.0);
			   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;
			   sum += texture2D(u_texture, v_coord) * 0.16/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;
			   gl_FragColor = u_intensity * sum;
			}
			`);return e.shaders[":blur"]=t},Shader.getCopyDepthShader=function(e){e=e||global$1.gl;var t=e.shaders[":copy_depth"];if(t)return t;var t=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,`
			#extension GL_EXT_frag_depth : enable
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			void main() {
			   gl_FragDepthEXT = texture2D( u_texture, v_coord ).x;
			   gl_FragColor = vec4(1.0);
			}
			`);return e.shaders[":copy_depth"]=t},Shader.getCubemapShowShader=function(e){e=e||global$1.gl;var t=e.shaders[":show_cubemap"];if(t)return t;var t=new GL$1.Shader(Shader.DEFAULT_VERTEX_SHADER,`
			precision highp float;
			varying vec3 v_normal;
			uniform samplerCube u_texture;
			void main() {
			   gl_FragColor = textureCube( u_texture, v_normal );
			}
			`);return t.uniforms({u_texture:0}),e.shaders[":show_cubemap"]=t},Shader.getPolarToCubemapShader=function(e){e=e||global$1.gl;var t=e.shaders[":polar_to_cubemap"];if(t)return t;var t=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform mat3 u_rotation;
			void main() {
				vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );
				vec3 dir = normalize( vec3( uv - vec2(0.5), 0.5 ));
				dir = u_rotation * dir;
				float u = atan(dir.x,dir.z) / 6.28318531;
				float v = (asin(dir.y) / 1.57079633) * 0.5 + 0.5;
				u = mod(u,1.0);
				v = mod(v,1.0);
			   gl_FragColor = texture2D( u_texture, vec2(u,v) );
			}
			`);return e.shaders[":polar_to_cubemap"]=t},Shader.getCubemapCopyShader=function(e){e=e||global$1.gl;var t=e.shaders[":copy_cubemap"];if(t)return t;var t=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform samplerCube u_texture;
			uniform mat3 u_rotation;
			void main() {
				vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );
				vec3 dir = vec3( uv - vec2(0.5), 0.5 );
				dir = u_rotation * dir;
			   gl_FragColor = textureCube( u_texture, dir );
			}
			`);return e.shaders[":copy_cubemap"]=t},Shader.getCubemapBlurShader=function(e){e=e||global$1.gl;var t=e.shaders[":blur_cubemap"];if(t)return t;var t=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,`
			#ifndef NUM_SAMPLES
				#define NUM_SAMPLES 4
			#endif
			
			precision highp float;
			varying vec2 v_coord;
			uniform samplerCube u_texture;
			uniform mat3 u_rotation;
			uniform vec2 u_offset;
			uniform float u_intensity;
			void main() {
				vec4 sum = vec4(0.0);
				vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);
				vec3 dir = vec3(0.0);
				vec4 color = vec4(0.0);
				for( int x = -2; x <= 2; x++ )
				{
					for( int y = -2; y <= 2; y++ )
					{
						dir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;
						dir.z = 0.5;
						dir = u_rotation * dir;
						color = textureCube( u_texture, dir );
						color.xyz = color.xyz * color.xyz;/*linearize*/
						sum += color;
					}
				}
				sum /= 25.0;
			   gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;
			}
			`);return e.shaders[":blur_cubemap"]=t},Shader.FXAA_FUNC=`
	uniform vec2 u_viewportSize;
	uniform vec2 u_iViewportSize;
	#define FXAA_REDUCE_MIN   (1.0/ 128.0)
	#define FXAA_REDUCE_MUL   (1.0 / 8.0)
	#define FXAA_SPAN_MAX     8.0
	
	/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */
	/* fragCoord MUST BE IN PIXELS */
	vec4 applyFXAA(sampler2D tex, vec2 fragCoord)
	{
		vec4 color = vec4(0.0);
		/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/
		vec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;
		vec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;
		vec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;
		vec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;
		vec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;
		vec3 luma = vec3(0.299, 0.587, 0.114);
		float lumaNW = dot(rgbNW, luma);
		float lumaNE = dot(rgbNE, luma);
		float lumaSW = dot(rgbSW, luma);
		float lumaSE = dot(rgbSE, luma);
		float lumaM  = dot(rgbM,  luma);
		float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
		float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));
		
		vec2 dir;
		dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
		dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));
		
		float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
		
		float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
		dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;
		
		vec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + 
			texture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);
		vec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + 
			texture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);
		
		//return vec4(rgbA,1.0);
		float lumaB = dot(rgbB, luma);
		if ((lumaB < lumaMin) || (lumaB > lumaMax))
			color = vec4(rgbA, 1.0);
		else
			color = vec4(rgbB, 1.0);
		return color;
	}
`,Shader.getFXAAShader=function(e){e=e||global$1.gl;var t=e.shaders[":fxaa"];if(t)return t;var t=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			`+Shader.FXAA_FUNC+`
			
			void main() {
			   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;
			}
			`),r=vec2.fromValues(e.viewport_data[2],e.viewport_data[3]),s=vec2.fromValues(1/e.viewport_data[2],1/e.viewport_data[3]);return t.setup=function(){r[0]=e.viewport_data[2],r[1]=e.viewport_data[3],s[0]=1/e.viewport_data[2],s[1]=1/e.viewport_data[3],this.uniforms({u_viewportSize:r,u_iViewportSize:s})},e.shaders[":fxaa"]=t},Shader.getFlatShader=function(e){e=e||global$1.gl;var t=e.shaders[":flat"];if(t)return t;var t=new GL$1.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);return t.uniforms({u_color:[1,1,1,1]}),e.shaders[":flat"]=t},GL$1.create=function(e){e=e||{};var t=null;if(e.canvas)if(typeof e.canvas=="string"){if(t=document.getElementById(e.canvas),!t)throw"Canvas element not found: "+e.canvas}else t=e.canvas;else{var r=null;if(e.container&&(r=e.container.constructor===String?document.querySelector(e.container):e.container),r&&!e.width){var s=r.getBoundingClientRect();e.width=s.width,e.height=s.height}t=createCanvas(e.width||800,e.height||600),r&&r.appendChild(t)}"alpha"in e||(e.alpha=!1);var n=null,a=null;if(e.version==2?a=["webgl2","experimental-webgl2"]:e.version==1||e.version===void 0?a=["webgl","experimental-webgl"]:e.version===0&&(a=["webgl2","experimental-webgl2","webgl","experimental-webgl"]),!a)throw"Incorrect WebGL version, must be 1 or 2";for(var o={alpha:e.alpha===void 0?!0:e.alpha,depth:e.depth===void 0?!0:e.depth,stencil:e.stencil===void 0?!0:e.stencil,antialias:e.antialias===void 0?!0:e.antialias,premultipliedAlpha:e.premultipliedAlpha===void 0?!0:e.premultipliedAlpha,preserveDrawingBuffer:e.preserveDrawingBuffer===void 0?!0:e.preserveDrawingBuffer},l=0;l<a.length;++l){try{n=t.getContext(a[l],o)}catch{}if(n)break}if(!n)throw t.getContext("webgl")?"WebGL supported but not with those parameters":"WebGL not supported";n.webgl_version=n.constructor.name==="WebGL2RenderingContext"?2:1,global$1.gl=n,t.is_webgl=!0,t.gl=n,n.context_id=this.last_context_id++,n.extensions={};for(var h=n.getSupportedExtensions(),l=0;l<h.length;++l)n.extensions[h[l]]=n.getExtension(h[l]);if(n.webgl_version==1?n.HIGH_PRECISION_FORMAT=n.extensions.OES_texture_half_float?GL$1.HALF_FLOAT_OES:n.extensions.OES_texture_float?GL$1.FLOAT:GL$1.UNSIGNED_BYTE:n.HIGH_PRECISION_FORMAT=GL$1.HALF_FLOAT_OES,n.max_texture_units=n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS),n._viewport_func?console.warn("Creating LiteGL context over the same canvas twice"):(n._viewport_func=n.viewport,n.viewport_data=new Float32Array([0,0,n.canvas.width,n.canvas.height]),n.viewport=function(_,I,A,M){var O=this.viewport_data;O[0]=_|0,O[1]=I|0,O[2]=A|0,O[3]=M|0,this._viewport_func(_,I,A,M)},n.getViewport=function(_){return _?(_[0]=n.viewport_data[0],_[1]=n.viewport_data[1],_[2]=n.viewport_data[2],_[3]=n.viewport_data[3],_):new Float32Array(n.viewport_data)},n.setViewport=function(_,I){n.viewport_data.set(_),I&&(n.viewport_data[1]=this.drawingBufferHeight-_[1]-_[3]),this._viewport_func(_[0],n.viewport_data[1],_[2],_[3])}),!GL$1.reverse){GL$1.reverse={};for(var l in n)n[l]&&n[l].constructor===Number&&(GL$1.reverse[n[l]]=l)}if(glMatrix==null)throw"glMatrix not found, LiteGL requires glMatrix to be included";var c=0;n.shaders={},n.textures={},n.meshes={},n.draw_calls=0,n.makeCurrent=function(){global$1.gl=this},n.execute=function(_){var I=global$1.gl;global$1.gl=this,_(),global$1.gl=I},n.animate=function(_){if(_===!1){global$1.cancelAnimationFrame(this._requestFrame_id),this._requestFrame_id=null;return}var I=global$1.requestAnimationFrame,A=global$1.getTime(),M=this,O=0;function C(){if(!n.destroyed){M._requestFrame_id=I(C);var P=global$1.getTime(),N=(P-A)*.001;if(M.mouse&&(M.mouse.last_buttons=O),O=M.mouse.buttons,M.onupdate&&M.onupdate(N),LEvent.trigger(M,"update",N),M.ondraw){var k=global$1.gl;global$1.gl=M,M.ondraw(),LEvent.trigger(M,"draw"),global$1.gl=k}A=P}}this._requestFrame_id=I(C)},n.destroy=function(){b&&(document.removeEventListener("keydown",b),document.removeEventListener("keyup",b)),f&&(this.canvas.removeEventListener("mousedown",f),this.canvas.removeEventListener("mousemove",f),this.canvas.removeEventListener("mouseup",f),this.canvas.addEventListener("drag",f),this.canvas.addEventListener("dragstart",f),this.canvas.addEventListener("wheel",f));for(var _ in this.shaders)this.shaders[_].delete(),this.shaders[_]=null;this.shaders={};for(var _ in this.meshes)this.meshes[_].deleteBuffers(),this.meshes[_]=null;this.meshes={};for(var _ in this.textures)this.textures[_].delete(),this.textures[_]=null;this.textures={},this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.destroyed=!0,global$1.gl==this&&(global$1.gl=null)};var u=n.mouse={buttons:0,last_buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,clientx:0,clienty:0,isInsideRect:function(_,I,A,M,O){var C=this.y;return O&&(C=n.canvas.height-C),this.x>_&&this.x<_+A&&C>I&&C<I+M},isButtonPressed:function(_){if(_==GL$1.LEFT_MOUSE_BUTTON)return this.buttons&GL$1.LEFT_MOUSE_BUTTON_MASK;if(_==GL$1.MIDDLE_MOUSE_BUTTON)return this.buttons&GL$1.MIDDLE_MOUSE_BUTTON_MASK;if(_==GL$1.RIGHT_MOUSE_BUTTON)return this.buttons&GL$1.RIGHT_MOUSE_BUTTON_MASK},wasButtonPressed:function(_){var I=0;return _==GL$1.LEFT_MOUSE_BUTTON?I=GL$1.LEFT_MOUSE_BUTTON_MASK:_==GL$1.MIDDLE_MOUSE_BUTTON?I=GL$1.MIDDLE_MOUSE_BUTTON_MASK:_==GL$1.RIGHT_MOUSE_BUTTON&&(I=GL$1.RIGHT_MOUSE_BUTTON_MASK),this.buttons&I&&!(this.last_buttons&I)}};n.captureMouse=function(_,I){t.addEventListener("mousedown",p),t.addEventListener("mousemove",p),t.addEventListener("drag",p),t.addEventListener("dragstart",p),_&&(t.addEventListener("mousewheel",p,!1),t.addEventListener("wheel",p,!1)),t.addEventListener("contextmenu",function(A){return A.preventDefault(),!1}),I&&this.captureTouch(!0)};function p(_){if(!n.ignore_events){var I=n.mouse.buttons;GL$1.augmentEvent(_,t),_.eventType=_.eventType||_.type;var A=global$1.getTime();if(u.dragging=_.dragging,u.position[0]=_.canvasx,u.position[1]=_.canvasy,u.x=_.canvasx,u.y=_.canvasy,u.mousex=_.mousex,u.mousey=_.mousey,u.canvasx=_.canvasx,u.canvasy=_.canvasy,u.clientx=_.mousex,u.clienty=_.mousey,u.buttons=_.buttons,u.left_button=!!(u.buttons&GL$1.LEFT_MOUSE_BUTTON_MASK),u.middle_button=!!(u.buttons&GL$1.MIDDLE_MOUSE_BUTTON_MASK),u.right_button=!!(u.buttons&GL$1.RIGHT_MOUSE_BUTTON_MASK),_.eventType=="mousedown"){if(I==0){t.removeEventListener("mousemove",p);var M=t.ownerDocument;M.addEventListener("mousemove",p),M.addEventListener("mouseup",p)}c=A,n.onmousedown&&n.onmousedown(_),LEvent.trigger(n,"mousedown")}else if(_.eventType=="mousemove")n.onmousemove&&n.onmousemove(_),LEvent.trigger(n,"mousemove",_);else if(_.eventType=="mouseup"){if(n.mouse.buttons==0){t.addEventListener("mousemove",p);var M=t.ownerDocument;M.removeEventListener("mousemove",p),M.removeEventListener("mouseup",p)}_.click_time=A-c,n.onmouseup&&n.onmouseup(_),LEvent.trigger(n,"mouseup",_)}else _.eventType=="mousewheel"||_.eventType=="wheel"||_.eventType=="DOMMouseScroll"?(_.eventType="mousewheel",_.type=="wheel"?_.wheel=-_.deltaY:_.wheel=_.wheelDeltaY!=null?_.wheelDeltaY:_.detail*-60,_.delta=_.wheelDelta!==void 0?_.wheelDelta/40:_.deltaY?-_.deltaY/3:0,n.onmousewheel&&n.onmousewheel(_),LEvent.trigger(n,"mousewheel",_)):_.eventType=="dragstart"&&(n.ondragstart&&n.ondragstart(_),LEvent.trigger(n,"dragstart",_));if(n.onmouse&&n.onmouse(_),!_.skip_preventDefault)return _.eventType!="mousemove"&&_.stopPropagation(),_.preventDefault(),!1}}var f=p,d=!1;n.captureTouch=function(_){d=_,t.addEventListener("touchstart",g,!0),t.addEventListener("touchmove",g,!0),t.addEventListener("touchend",g,!0),t.addEventListener("touchcancel",g,!0),t.addEventListener("gesturestart",m),t.addEventListener("gesturechange",m),t.addEventListener("gestureend",m)};function g(_){var I=_.changedTouches,A=I[0],M="";if(!(n.ontouch&&n.ontouch(_)===!0)&&LEvent.trigger(n,_.type,_)!==!0&&d&&!(_.touches.length&&_.changedTouches[0].identifier!==_.touches[0].identifier)&&!(I>1)){switch(_.type){case"touchstart":M="mousedown";break;case"touchmove":M="mousemove";break;case"touchend":M="mouseup";break;default:return}var O=document.createEvent("MouseEvent");O.initMouseEvent(M,!0,!0,window,1,A.screenX,A.screenY,A.clientX,A.clientY,!1,!1,!1,!1,0,null),O.originalEvent=O,O.is_touch=!0,A.target.dispatchEvent(O),_.preventDefault()}}function m(_){_.eventType=_.type,!(n.ongesture&&n.ongesture(_)===!1)&&LEvent.trigger(n,_.type,_)!==!1&&_.preventDefault()}n.keys={};var b=null;n.captureKeys=function(_,I){if(b)return;n.keys={},I&&n.canvas,document.addEventListener("keydown",A),document.addEventListener("keyup",A);function A(M){E(M,_)}b=A};function E(_,I){_.eventType=_.type;var A=_.target.nodeName.toLowerCase();if(!(A==="input"||A==="textarea"||A==="select"||_.target.contentEditable==="true")){_.character=String.fromCharCode(_.keyCode).toLowerCase();var M=!1,O=GL$1.mapKeyCode(_.keyCode);O||(O=_.character);var C=_.altKey||_.ctrlKey||_.metaKey;C||(O&&(n.keys[O]=_.type=="keydown"),M=n.keys[_.keyCode],n.keys[_.keyCode]=_.type=="keydown"),(M!=n.keys[_.keyCode]||C)&&(_.type=="keydown"&&n.onkeydown?n.onkeydown(_):_.type=="keyup"&&n.onkeyup&&n.onkeyup(_),LEvent.trigger(n,_.type,_)),n.onkey&&n.onkey(_),I&&(_.isChar||GL$1.blockable_keys[_.keyIdentifier||_.key])&&_.preventDefault()}}n.gamepads=null,n.captureGamepads=function(){var _=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;_&&(this.gamepads=_.call(navigator))},n.getGamepads=function(_){var I=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(I){var A=I.call(navigator);this.gamepads||(this.gamepads=[]);for(var M=0;M<4;M++){var O=A[M];if(O&&!_&&L(O),O&&!O.prev_buttons){O.prev_buttons=new Uint8Array(32);var C=new CustomEvent("gamepadconnected");C.eventType=C.type,C.gamepad=O,this.ongamepadconnected&&this.ongamepadconnected(C),LEvent.trigger(n,"gamepadconnected",C)}if(O)for(var P=0;P<O.buttons.length;++P){var N=O.buttons[P];if(N.was_pressed=!1,N.pressed&&!O.prev_buttons[P]){N.was_pressed=!0;var C=new CustomEvent("gamepadButtonDown");C.eventType=C.type,C.button=N,C.which=P,C.gamepad=O,n.onbuttondown&&n.onbuttondown(C),LEvent.trigger(n,"buttondown",C)}else if(!N.pressed&&O.prev_buttons[P]){var C=new CustomEvent("gamepadButtonUp");C.eventType=C.type,C.button=N,C.which=P,C.gamepad=O,n.onbuttondown&&n.onbuttondown(C),LEvent.trigger(n,"buttonup",C)}O.prev_buttons[P]=N.pressed?1:0}}return this.gamepads=A,A}};function L(_){var I=_.xbox||{axes:[],buttons:{},hat:""};I.axes.lx=_.axes[0],I.axes.ly=_.axes[1],I.axes.rx=_.axes[2],I.axes.ry=_.axes[3],I.axes.triggers=_.axes[4];for(var A=0;A<_.buttons.length;A++)switch(A){case 0:I.buttons.a=_.buttons[A].pressed;break;case 1:I.buttons.b=_.buttons[A].pressed;break;case 2:I.buttons.x=_.buttons[A].pressed;break;case 3:I.buttons.y=_.buttons[A].pressed;break;case 4:I.buttons.lb=_.buttons[A].pressed;break;case 5:I.buttons.rb=_.buttons[A].pressed;break;case 6:I.buttons.lt=_.buttons[A].pressed;break;case 7:I.buttons.rt=_.buttons[A].pressed;break;case 8:I.buttons.back=_.buttons[A].pressed;break;case 9:I.buttons.start=_.buttons[A].pressed;break;case 10:I.buttons.ls=_.buttons[A].pressed;break;case 11:I.buttons.rs=_.buttons[A].pressed;break;case 12:_.buttons[A].pressed&&(I.hat+="up");break;case 13:_.buttons[A].pressed&&(I.hat+="down");break;case 14:_.buttons[A].pressed&&(I.hat+="left");break;case 15:_.buttons[A].pressed&&(I.hat+="right");break;case 16:I.buttons.home=_.buttons[A].pressed;break}_.xbox=I}n.fullscreen=function(){var _=this.canvas;_.requestFullScreen?_.requestFullScreen():_.webkitRequestFullScreen?_.webkitRequestFullScreen():_.mozRequestFullScreen?_.mozRequestFullScreen():console.error("Fullscreen not supported")},n.snapshot=function(_,I,A,M,O){var C=createCanvas(A,M),B=C.getContext("2d"),P=B.getImageData(0,0,C.width,C.height),N=new Uint8Array(A*M*4);if(n.readPixels(_,I,C.width,C.height,n.RGBA,n.UNSIGNED_BYTE,N),P.data.set(N),B.putImageData(P,0,0),O)return C;var k=createCanvas(A,M),B=k.getContext("2d");return B.translate(0,M),B.scale(1,-1),B.drawImage(C,0,0),k};var T={};return n.loadTexture=function(_,I,A){if(this.textures[_])return this.textures[_];if(T[_])return null;var M=new Image;return M.url=_,M.onload=function(){var O=GL$1.Texture.fromImage(this,I);O.img=this,n.textures[this.url]=O,delete T[this.url],A&&A(O)},M.src=_,T[_]=!0,null},n.drawTexture=function(){var _=mat3.create(),I=vec2.create(),A=vec2.create(),M=vec4.create(),O=vec4.fromValues(1,1,1,1),C=vec2.create(),P={u_texture:0,u_position:I,u_color:O,u_size:A,u_texture_area:M,u_viewport:C,u_transform:_};return function(N,k,B,S,U,W,z,q,Y,H,Z){I[0]=k,I[1]=B,S===void 0&&(S=N.width),U===void 0&&(U=N.height),A[0]=S,A[1]=U,W===void 0&&(W=0),z===void 0&&(z=0),q===void 0&&(q=N.width),Y===void 0&&(Y=N.height),M[0]=W/N.width,M[1]=z/N.height,M[2]=(W+q)/N.width,M[3]=(z+Y)/N.height,C[0]=this.viewport_data[2],C[1]=this.viewport_data[3],H=H||Shader.getPartialQuadShader(this);var oe=Mesh.getScreenQuad(this);N.bind(0),H.uniforms(P),Z&&H.uniforms(Z),H.draw(oe,n.TRIANGLES)}}(),n.canvas.addEventListener("webglcontextlost",function(_){_.preventDefault(),n.context_lost=!0,n.onlosecontext&&n.onlosecontext(_)},!1),n.reset=function(){n.viewport(0,0,this.canvas.width,this.canvas.height),n.disable(n.BLEND),n.disable(n.CULL_FACE),n.disable(n.DEPTH_TEST),n.frontFace(n.CCW),n._current_texture_drawto=null,n._current_fbo_color=null,n._current_fbo_depth=null},n.dump=function(){console.log("userAgent: ",navigator.userAgent),console.log("Supported extensions:");var _=n.getSupportedExtensions();console.log(_.join(","));var I=["VENDOR","VERSION","MAX_VERTEX_ATTRIBS","MAX_VARYING_VECTORS","MAX_VERTEX_UNIFORM_VECTORS","MAX_VERTEX_TEXTURE_IMAGE_UNITS","MAX_FRAGMENT_UNIFORM_VECTORS","MAX_TEXTURE_SIZE","MAX_TEXTURE_IMAGE_UNITS"];console.log("WebGL info:");for(var A in I)console.log(" * "+I[A]+": "+n.getParameter(n[I[A]]));console.log("*************************************************")},n.reset(),n},GL$1.mapKeyCode=function(e){var t={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",33:"PAGEUP",34:"PAGEDOWN",35:"END",36:"HOME",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};return t[e]||(e>=65&&e<=90?String.fromCharCode(e):null)},GL$1.dragging=!1,GL$1.last_pos=[0,0],GL$1.augmentEvent=function(e,t){var r=null;t=t||e.target||gl.canvas,r=t.getBoundingClientRect(),e.mousex=e.clientX-r.left,e.mousey=e.clientY-r.top,e.canvasx=e.mousex,e.canvasy=r.height-e.mousey,e.deltax=0,e.deltay=0,e.is_touch&&(gl.mouse.buttons=e.which),document.pointerLockElement===t&&(e.canvasx=e.mousex=r.width*.5,e.canvasy=e.mousey=r.height*.5),e.type=="mousedown"?this.dragging=!0:e.type=="mousemove"||e.type=="mouseup"&&e.buttons==0&&(this.dragging=!1),e.movementX!==void 0&&!e.is_touch&&!GL$1.isMobile()?(e.deltax=e.movementX,e.deltay=e.movementY):(e.deltax=e.mousex-this.last_pos[0],e.deltay=e.mousey-this.last_pos[1]),this.last_pos[0]=e.mousex,this.last_pos[1]=e.mousey,e.dragging=this.dragging,e.leftButton=!!(gl.mouse.buttons&GL$1.LEFT_MOUSE_BUTTON_MASK),e.middleButton=!!(gl.mouse.buttons&GL$1.MIDDLE_MOUSE_BUTTON_MASK),e.rightButton=!!(gl.mouse.buttons&GL$1.RIGHT_MOUSE_BUTTON_MASK),e.buttons_mask=0,e.leftButton&&(e.buttons_mask=1),e.middleButton&&(e.buttons_mask|=2),e.rightButton&&(e.buttons_mask|=4),e.isButtonPressed=function(s){return this.buttons_mask&1<<s}},GL$1.isMobile=function(){return this.mobile!==void 0?this.mobile:global$1.navigator?navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/SamsungBrowser/i)||navigator.userAgent.match(/Mobile VR/i)||navigator.userAgent.match(/Android/i)?this.mobile=!0:this.mobile=!1:this.mobile=!1};var LEvent=global$1.LEvent=GL$1.LEvent={bind:function(e,t,r,s){if(!e)throw"cannot bind event to null";if(!r)throw"cannot bind to null callback";if(e.constructor===String)throw"cannot bind event to a string";this.target_instance=s,this.callback=r,this.instance=e;var n=e.__levents;n||(Object.defineProperty(e,"__levents",{value:{},enumerable:!1}),n=e.__levents),Object.prototype.hasOwnProperty.call(n,t)?n[t].push([r,s]):n[t]=[[r,s]],e.onLEventBinded&&e.onLEventBinded(t,r,s)},unbind:function(e,t,r,s){if(!e)throw"cannot unbind event to null";if(!r)throw"cannot unbind from null callback";if(e.constructor===String)throw"cannot bind event to a string";var n=e.__levents;if(n&&Object.prototype.hasOwnProperty.call(n,t)){for(var a=0,o=n[t].length;a<o;++a){var l=n[t][a];if(l[0]===r&&l[1]===s){n[t].splice(a,1);break}}n[t].length==0&&delete n[t],e.onLEventUnbinded&&e.onLEventUnbinded(t,r,s)}},unbindAll:function(e,t,r){if(!e)throw"cannot unbind events in null";var s=e.__levents;if(s){if(e.onLEventUnbindAll&&e.onLEventUnbindAll(t,r),!t){delete e.__levents;return}for(var n in s)for(var a=s[n],o=a.length-1;o>=0;--o)a[o][1]!=t||r&&r!==a[o][0]||a.splice(o,1)}},unbindAllEvent:function(e,t){if(!e)throw"cannot unbind events in null";var r=e.__levents;r&&(delete r[t],e.onLEventUnbindAll&&e.onLEventUnbindAll(t,this.target_instance,this.callback))},isBind:function(e,t,r,s){if(!e)throw"LEvent cannot have null as instance";var n=e.__levents;if(n){if(!Object.prototype.hasOwnProperty.call(n,t))return!1;for(var a=0,o=n[t].length;a<o;++a){var l=n[t][a];if(l[0]===r&&l[1]===s)return!0}return!1}},hasBind:function(e,t){if(!e)throw"LEvent cannot have null as instance";var r=e.__levents;return!(!r||!Object.prototype.hasOwnProperty.call(r,t)||!r[t].length)},hasBindTo:function(e,t){if(!e)throw"LEvent cannot have null as instance";var r=e.__levents;if(!r)return!1;for(var s in r)for(var n=r[s],a=0;a<n.length;++a)if(n[a][1]===t)return!0;return!1},trigger:function(e,t,r,s,n){if(!e)throw"cannot trigger event from null";if(e.constructor===String)throw"cannot bind event to a string";var a=e.__levents;if(!a||!Object.prototype.hasOwnProperty.call(a,t))return!1;var o=a[t];if(s)for(var l=o.length-1;l>=0;--l){var h=o[l];if(n){if(h&&h[0].apply(h[1],r)===!0)return!0}else if(h&&h[0].call(h[1],t,r)===!0)return!0}else for(var l=0,c=o.length;l<c;++l){var h=o[l];if(n){if(h&&h[0].apply(h[1],r)===!0)return!0}else if(h&&h[0].call(h[1],t,r)===!0)return!0}return!1},triggerArray:function(e,t,r,s,n){for(var a=!1,o=0,l=e.length;o<l;++o){var h=e[o];if(!h)throw"cannot trigger event from null";if(h.constructor===String)throw"cannot bind event to a string";var c=h.__levents;if(!(!c||!Object.prototype.hasOwnProperty.call(c,t)))if(s)for(var u=c[t].length-1;u>=0;--u){var p=c[t][u];if(n){if(p[0].apply(p[1],r)===!0){a=!0;break}}else if(p[0].call(p[1],t,r)===!0){a=!0;break}}else for(var u=0,f=c[t].length;u<f;++u){var p=c[t][u];if(n){if(p[0].apply(p[1],r)===!0){a=!0;break}}else if(p[0].call(p[1],t,r)===!0){a=!0;break}}}return a},extendObject:function(e){e.bind=function(t,r,s){return LEvent.bind(this,t,r,s)},e.trigger=function(t,r){return LEvent.trigger(this,t,r)},e.unbind=function(t,r,s){return LEvent.unbind(this,t,r,this.instance)},e.unbindAll=function(t,r){return LEvent.unbindAll(this,t,r)}},extendClass:function(e){this.extendObject(e.prototype)}};global$1.CLIP_INSIDE=GL$1.CLIP_INSIDE=0,global$1.CLIP_OUTSIDE=GL$1.CLIP_OUTSIDE=1,global$1.CLIP_OVERLAP=GL$1.CLIP_OVERLAP=2,global$1.geo={last_t:-1,createPlane:function(e,t){return new Float32Array([t[0],t[1],t[2],-vec3.dot(e,t)])},planeFromTriangle:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s,n,a,o){return vec3.sub(e,a,n),vec3.sub(t,o,n),vec3.cross(r,e,t),vec3.normalize(r,r),s[0]=r[0],s[1]=r[1],s[2]=r[2],s[3]=-vec3.dot(n,r),s}}(),computeTriangleNormal:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s,n,a,o){return vec3.sub(e,a,n),vec3.sub(t,o,n),vec3.cross(r,e,t),vec3.normalize(r,r),s[0]=r[0],s[1]=r[1],s[2]=r[2],s}}(),distancePointToPlane:function(e,t){return(vec3.dot(e,t)+t[3])/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},distance2PointToPlane:function(e,t){return(vec3.dot(e,t)+t[3])/(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},projectPointOnLine:function(){var e=vec3.create(),t=vec3.create();return function(r,s,n,a){a=a||vec3.create(),vec3.sub(e,r,s),vec3.sub(t,n,s);var o=vec3.dot(e,t)/vec3.dot(t,t);return a[0]=s[0]+o*t[0],a[1]=s[1]+o*t[1],a[2]=s[2]+o*t[2],a}}(),project2DPointOnLine:function(e,t,r,s){s=s||vec2.create();var n=vec2.fromValues(e[0]-t[0],e[1]-t[1]),a=vec2.fromValues(r[0]-t[0],r[1]-t[1]),o=vec2.dot(n,a)/vec2.dot(a,a);return s[0]=t[0]+o*a[0],s[1]=t[1]+o*a[1],s},closestPointToSegment:function(){var e=vec3.create(),t=vec3.create();return function(r,s,n,a){a=a||vec3.create(),vec3.sub(e,r,s),vec3.sub(t,n,s);var o=vec3.dot(e,t)/vec3.dot(t,t);return o=Math.min(1,Math.max(0,o)),a[0]=s[0]+o*t[0],a[1]=s[1]+o*t[1],a[2]=s[2]+o*t[2],a}}(),projectPointOnPlane:function(){var e=vec3.create();return function(t,r,s,n){n=n||vec3.create(),vec3.sub(e,t,r);var a=vec3.dot(e,s);return vec3.scale(e,s,a),vec3.sub(n,t,e)}}(),isPointInsideTriangle:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),n=vec3.create(),a=vec3.create();return function(o,l,h,c){return vec3.sub(e,l,o),vec3.sub(t,h,o),vec3.sub(r,c,o),vec3.cross(s,t,r),vec3.cross(n,r,e),vec3.cross(a,e,t),!(vec3.dot(s,n)<0||vec3.dot(s,a)<0)}}(),reflectPointInPlane:function(e,t,r){var s=-1*(t[0]*r[0]+t[1]*r[1]+t[2]*r[2]),n=-(s+r[0]*e[0]+r[1]*e[1]+r[2]*e[2])/(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);return vec3.fromValues(e[0]+n*r[0]*2,e[1]+n*r[1]*2,e[2]+n*r[2]*2)},testRayPlane:function(e,t,r,s,n){var a=vec3.dot(r,s),o=a-vec3.dot(s,e),l=vec3.dot(s,t);if(Math.abs(l)<global$1.EPSILON)return!1;var h=this.last_t=o/l;return h<0?!1:(n&&vec3.add(n,e,vec3.scale(n,t,h)),!0)},testSegmentPlane:function(){var e=vec3.create();return function(t,r,s,n,a){var o=vec3.dot(s,n),l=o-vec3.dot(n,t),h=vec3.sub(e,r,t),c=vec3.dot(n,h);if(Math.abs(c)<global$1.EPSILON)return!1;var u=this.last_t=l/c;return u<0||u>1?!1:(a&&vec3.add(a,t,vec3.scale(a,h,u)),!0)}}(),testRaySphere:function(){var e=vec3.create();return function(t,r,s,n,a,o){var l=vec3.subtract(e,t,s),h=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],c=2*l[0]*r[0]+2*l[1]*r[1]+2*l[2]*r[2],u=l[0]*l[0]+l[1]*l[1]+l[2]*l[2]-n*n,p=c*c-4*h*u;if(p<0)return!1;if(a){var f=Math.sqrt(p),d=1/(2*h),g=(-c+f)*d,m=(-c-f)*d,b=g<m?g:m;if(o!==void 0&&b>o)return!1;this.last_t=b,vec3.add(a,t,vec3.scale(a,r,b))}return!0}}(),hitTestTriangle:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),n=vec3.create();return function(a,o,l,h,c,u){vec3.subtract(e,h,l),vec3.subtract(t,c,l),vec3.cross(r,e,t),vec3.normalize(r,r);var p=vec3.dot(r,vec3.subtract(s,l,a))/vec3.dot(r,o);if(p>0){vec3.add(n,a,vec3.scale(s,o,p));var f=vec3.subtract(s,s,l),d=vec3.dot(t,t),g=vec3.dot(t,e),m=vec3.dot(t,f),b=vec3.dot(e,e),E=vec3.dot(e,f),L=d*b-g*g,T=(b*m-g*E)/L,_=(d*E-g*m)/L;if(T>=0&&_>=0&&T+_<=1)return this.last_t=p,u&&vec3.add(u,a,vec3.scale(s,o,p)),!0}return!1}}(),testRayCylinder:function(e,t,r,s,n,a){var o=vec3.clone(e),l=vec3.add(vec3.create(),e,vec3.scale(vec3.create(),t,1e5)),h=0,c=vec3.subtract(vec3.create(),s,r),u=vec3.subtract(vec3.create(),o,r),p=vec3.subtract(vec3.create(),l,o),f=vec3.dot(u,c),d=vec3.dot(p,c),g=vec3.dot(c,c);if(f<0&&f+d<0||f>g&&f+d>g)return!1;var m=vec3.dot(p,p),b=vec3.dot(u,p),E=g*m-d*d,L=vec3.dot(u,u)-n*n,T=g*L-f*f;if(Math.abs(E)<global$1.EPSILON)return T>0?!1:(f<0?h=-b/m:f>g?h=(d-b)/m:h=0,a&&vec3.add(a,o,vec3.scale(a,p,h)),!0);var _=g*b-d*f,I=_*_-E*T;return I<0||(h=(-_-Math.sqrt(I))/E,h<0||h>1)?!1:f+h*d<0?d<=0?!1:(h=-f/d,a&&vec3.add(a,o,vec3.scale(a,p,h)),L+2*h*(b+h*m)<=0):f+h*d>g?d>=0?!1:(h=(g-f)/d,a&&vec3.add(a,o,vec3.scale(a,p,h)),L+g-2*f+h*(2*(b-d)+h*m)<=0):(this.last_t=h,a&&vec3.add(a,o,vec3.scale(a,p,h)),!0)},testRayBox:function(){var e=new Float32Array(3),t=new Float32Array(3),r=new Float32Array(3);return function(s,n,a,o,l,h){h=h||Number.MAX_VALUE;var c=!0,u=0,p;for(e.fill(0),r.fill(0),t.fill(0),u=0;u<3;++u)s[u]<a[u]?(e[u]=1,t[u]=a[u],c=!1):s[u]>o[u]?(e[u]=0,t[u]=o[u],c=!1):e[u]=2;if(c)return this.last_t=0,l&&vec3.copy(l,s),!0;for(u=0;u<3;++u)e[u]!=2&&n[u]!=0?r[u]=(t[u]-s[u])/n[u]:r[u]=-1;for(p=0,u=1;u<3;u++)r[p]<r[u]&&(p=u);if(r[p]<0||r[p]>h)return!1;for(this.last_t=r[p],u=0;u<3;++u)if(p!=u){var f=s[u]+r[p]*n[u];if(f<a[u]||f>o[u])return!1;l&&(l[u]=f)}else l&&(l[u]=t[u]);return!0}}(),testRayBBox:function(){var e=mat4.create(),t=vec3.create(),r=vec3.create();return function(s,n,a,o,l,h,c){if(!s||!n||!a)throw"parameters missing";o&&(mat4.invert(e,o),vec3.add(t,s,n),s=vec3.transformMat4(r,s,e),vec3.transformMat4(t,t,e),vec3.sub(t,t,s),n=vec3.normalize(t,t));var u=this.testRayBox(s,n,a.subarray(6,9),a.subarray(9,12),l,h);return!c&&o&&l&&vec3.transformMat4(l,l,o),u}}(),testPointBBox:function(e,t){return!(e[0]<t[6]||e[0]>t[9]||e[1]<t[7]||e[0]>t[10]||e[2]<t[8]||e[0]>t[11])},testBBoxBBox:function(e,t){var r=Math.abs(t[0]-e[0]);if(r>e[3]+t[3])return!1;var s=Math.abs(t[1]-e[1]);if(s>e[4]+t[4])return!1;var n=Math.abs(t[2]-e[2]);if(n>e[5]+t[5])return!1;var a=global$1.BBox.getMin(t);if(global$1.geo.testPointBBox(a,e)){var o=global$1.BBox.getMax(t);if(global$1.geo.testPointBBox(o,e))return!0}return!0},testSphereBBox:function(e,t,r){for(var s,n=0,a=global$1.BBox.getMin(r),o=global$1.BBox.getMax(r),l=0;l<3;++l)e[l]<a[l]?(s=e[l]-a[l],n+=s*s):e[l]>o[l]&&(s=e[l]-o[l],n+=s*s);var h=t*t;return n<=h},closestPointBetweenLines:function(e,t,r,s,n,a){var o=vec3.subtract(vec3.create(),t,e),l=vec3.subtract(vec3.create(),s,r),h=vec3.subtract(vec3.create(),e,r),c=vec3.dot(o,o),u=vec3.dot(o,l),p=vec3.dot(l,l),f=vec3.dot(o,h),d=vec3.dot(l,h),g=c*p-u*u,m,b;g<global$1.EPSILON?(m=0,b=u>p?f/u:d/p):(m=(u*d-p*f)/g,b=(c*d-u*f)/g),n&&vec3.add(n,e,vec3.scale(vec3.create(),o,m)),a&&vec3.add(a,r,vec3.scale(vec3.create(),l,b));var E=vec3.add(vec3.create(),h,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),o,m),vec3.scale(vec3.create(),l,b)));return vec3.length(E)},extractPlanes:function(e,r){var r=r||new Float32Array(24);return r.set([e[3]-e[0],e[7]-e[4],e[11]-e[8],e[15]-e[12]],0),s(0),r.set([e[3]+e[0],e[7]+e[4],e[11]+e[8],e[15]+e[12]],4),s(4),r.set([e[3]+e[1],e[7]+e[5],e[11]+e[9],e[15]+e[13]],8),s(8),r.set([e[3]-e[1],e[7]-e[5],e[11]-e[9],e[15]-e[13]],12),s(12),r.set([e[3]-e[2],e[7]-e[6],e[11]-e[10],e[15]-e[14]],16),s(16),r.set([e[3]+e[2],e[7]+e[6],e[11]+e[10],e[15]+e[14]],20),s(20),r;function s(n){var a=r.subarray(n,n+3),o=vec3.length(a);o!==0&&(o=1/o,r[n]*=o,r[n+1]*=o,r[n+2]*=o,r[n+3]*=o)}},frustumTestBox:function(e,t){var r=0,s=0;return r=global$1.planeBoxOverlap(e.subarray(0,4),t),r==global$1.CLIP_OUTSIDE||(s+=r,r=global$1.planeBoxOverlap(e.subarray(4,8),t),r==global$1.CLIP_OUTSIDE)||(s+=r,r=global$1.planeBoxOverlap(e.subarray(8,12),t),r==global$1.CLIP_OUTSIDE)||(s+=r,r=global$1.planeBoxOverlap(e.subarray(12,16),t),r==global$1.CLIP_OUTSIDE)||(s+=r,r=global$1.planeBoxOverlap(e.subarray(16,20),t),r==global$1.CLIP_OUTSIDE)||(s+=r,r=global$1.planeBoxOverlap(e.subarray(20,24),t),r==global$1.CLIP_OUTSIDE)?global$1.CLIP_OUTSIDE:(s+=r,s==0?global$1.CLIP_INSIDE:global$1.CLIP_OVERLAP)},frustumTestSphere:function(e,t,r){var s,n=!1;return s=global$1.distanceToPlane(e.subarray(0,4),t),s<-r||(s>=-r&&s<=r&&(n=!0),s=global$1.distanceToPlane(e.subarray(4,8),t),s<-r)||(s>=-r&&s<=r&&(n=!0),s=global$1.distanceToPlane(e.subarray(8,12),t),s<-r)||(s>=-r&&s<=r&&(n=!0),s=global$1.distanceToPlane(e.subarray(12,16),t),s<-r)||(s>=-r&&s<=r&&(n=!0),s=global$1.distanceToPlane(e.subarray(16,20),t),s<-r)||(s>=-r&&s<=r&&(n=!0),s=global$1.distanceToPlane(e.subarray(20,24),t),s<-r)?global$1.CLIP_OUTSIDE:(s>=-r&&s<=r&&(n=!0),n?global$1.CLIP_OVERLAP:global$1.CLIP_INSIDE)},testPoint2DInPolygon:function(e,t){for(var r=!1,s=-1,n=e.length,a=n-1;++s<n;a=s)(e[s][1]<=t[1]&&t[1]<e[a][1]||e[a][1]<=t[1]&&t[1]<e[s][1])&&t[0]<(e[a][0]-e[s][0])*(t[1]-e[s][1])/(e[a][1]-e[s][1])+e[s][0]&&(r=!r);return r}},global$1.BBox=GL$1.BBox={center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:[vec3.fromValues(1,1,1),vec3.fromValues(1,1,-1),vec3.fromValues(1,-1,1),vec3.fromValues(1,-1,-1),vec3.fromValues(-1,1,1),vec3.fromValues(-1,1,-1),vec3.fromValues(-1,-1,1),vec3.fromValues(-1,-1,-1)],create:function(){return new Float32Array(13)},clone:function(e){return new Float32Array(e)},copy:function(e,t){return e.set(t),e},fromPoint:function(e){var t=this.create();return t.set(e,0),t.set(e,6),t.set(e,9),t},fromMinMax:function(e,t){var r=this.create();return this.setMinMax(r,e,t),r},fromCenterHalfsize:function(e,t){var r=this.create();return this.setCenterHalfsize(r,e,t),r},fromPoints:function(e){var t=this.create();return this.setFromPoints(t,e),t},setFromPoints:function(e,t){var r=e.subarray(6,9),s=e.subarray(9,12);r[0]=t[0],r[1]=t[1],r[2]=t[2],s.set(r);for(var n=3,a=t.length;n<a;n+=3){var o=t[n],l=t[n+1],h=t[n+2];o<r[0]?r[0]=o:o>s[0]&&(s[0]=o),l<r[1]?r[1]=l:l>s[1]&&(s[1]=l),h<r[2]?r[2]=h:h>s[2]&&(s[2]=h)}return e[0]=(r[0]+s[0])*.5,e[1]=(r[1]+s[1])*.5,e[2]=(r[2]+s[2])*.5,e[3]=s[0]-e[0],e[4]=s[1]-e[1],e[5]=s[2]-e[2],e[12]=Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]),e},setMinMax:function(e,t,r){e[6]=t[0],e[7]=t[1],e[8]=t[2],e[9]=r[0],e[10]=r[1],e[11]=r[2];var s=e.subarray(3,6);return vec3.sub(s,r,t),vec3.scale(s,s,.5),e[0]=r[0]-s[0],e[1]=r[1]-s[1],e[2]=r[2]-s[2],e[12]=vec3.length(e.subarray(3,6)),e},setCenterHalfsize:function(e,t,r,s){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=r[0],e[4]=r[1],e[5]=r[2],e[6]=e[0]-e[3],e[7]=e[1]-e[4],e[8]=e[2]-e[5],e[9]=e[0]+e[3],e[10]=e[1]+e[4],e[11]=e[2]+e[5],s?e[12]=s:e[12]=vec3.length(r),e},transformMat4:function(){for(var e=0,t=0,r=0,s=new Float32Array(8*3),n=[],a=0;a<24;a+=3)n.push(s.subarray(a,a+3));return function(o,l,h){var c=l[0],u=l[1],p=l[2];e=l[3],t=l[4],r=l[5];for(var f=this.corners,d=0;d<8;++d){var g=f[d],m=n[d];m[0]=e*g[0]+c,m[1]=t*g[1]+u,m[2]=r*g[2]+p,mat4.multiplyVec3(m,h,m)}return this.setFromPoints(o,s)}}(),getCorners:function(e,t){var r=e,s=e.subarray(3,6),n=null;t?(t.set(this.corners),n=t):n=new Float32Array(this.corners);for(var a=0;a<8;++a){var o=n.subarray(a*3,a*3+3);vec3.multiply(o,s,o),vec3.add(o,o,r)}return n},merge:function(e,t,r){var s=e.subarray(6,9),n=e.subarray(9,12);return vec3.min(s,t.subarray(6,9),r.subarray(6,9)),vec3.max(n,t.subarray(9,12),r.subarray(9,12)),global$1.BBox.setMinMax(e,s,n)},extendToPoint:function(e,t){t[0]<e[6]?e[6]=t[0]:t[0]>e[9]&&(e[9]=t[0]),t[1]<e[7]?e[7]=t[1]:t[1]>e[10]&&(e[10]=t[1]),t[2]<e[8]?e[8]=t[2]:t[2]>e[11]&&(e[11]=t[2]);var r=e.subarray(6,9),s=e.subarray(9,12),n=vec3.add(e.subarray(0,3),r,s);return vec3.scale(n,n,.5),vec3.subtract(e.subarray(3,6),s,n),e[12]=vec3.length(e.subarray(3,6)),e},clampPoint:function(e,t,r){e[0]=Math.clamp(r[0],t[0]-t[3],t[0]+t[3]),e[1]=Math.clamp(r[1],t[1]-t[4],t[1]+t[4]),e[2]=Math.clamp(r[2],t[2]-t[5],t[2]+t[5])},isPointInside:function(e,t){return!(e[0]-e[3]>t[0]||e[1]-e[4]>t[1]||e[2]-e[5]>t[2]||e[0]+e[3]<t[0]||e[1]+e[4]<t[1]||e[2]+e[5]<t[2])},getCenter:function(e){return e.subarray(0,3)},getHalfsize:function(e){return e.subarray(3,6)},getMin:function(e){return e.subarray(6,9)},getMax:function(e){return e.subarray(9,12)},getRadius:function(e){return e[12]}},global$1.distanceToPlane=GL$1.distanceToPlane=function(t,r){return vec3.dot(t,r)+t[3]},global$1.planeBoxOverlap=GL$1.planeBoxOverlap=function(t,r){var s=t,n=t[3],a=r,o=r,l=Math.abs(o[3]*s[0])+Math.abs(o[4]*s[1])+Math.abs(o[5]*s[2]),h=vec3.dot(s,a)+n;return h<=-l?global$1.CLIP_OUTSIDE:h<=l?global$1.CLIP_OVERLAP:global$1.CLIP_INSIDE};class OctreeNode{constructor(t,r){R(this,"min",null);R(this,"max",null);R(this,"size",null);R(this,"faces",null);R(this,"inside",0);R(this,"c",null);this.min=t,this.max=r,this.size=vec3.sub(vec3.create(),r,t)}}class Octree{constructor(t,r,s){this.root=null,this.total_depth=0,this.total_nodes=0,t&&this.buildFromMesh(t,r,s)}}global$1.Octree=GL$1.Octree=Octree,Octree.MAX_NODE_TRIANGLES_RATIO=.05,Octree.MAX_OCTREE_DEPTH=8,Octree.OCTREE_MARGIN_RATIO=.01,Octree.OCTREE_MIN_MARGIN=.1,Octree.NEAREST=0,Octree.FIRST=1,Octree.ALL=2,Octree.prototype.buildFromMesh=function(e,t,r){this.total_depth=0,this.total_nodes=0,t=t||0;var s=e.getBuffer("vertices").data,n=e.getIndexBuffer("triangles");n&&(n=n.data),r||(r=n?n.length:s.length/3);var a;n?a=this.computeAABBFromIndices(s,n,t,r):a=this.computeAABB(s);var o=new OctreeNode(a.min,a.max);this.root=o,this.total_nodes=1,this.total_triangles=n?n.length/3:s.length/9,this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var l=vec3.create();vec3.scale(l,o.size,Octree.OCTREE_MARGIN_RATIO),l[0]<Octree.OCTREE_MIN_MARGIN&&(l[0]=Octree.OCTREE_MIN_MARGIN),l[1]<Octree.OCTREE_MIN_MARGIN&&(l[1]=Octree.OCTREE_MIN_MARGIN),l[2]<Octree.OCTREE_MIN_MARGIN&&(l[2]=Octree.OCTREE_MIN_MARGIN),vec3.sub(o.min,o.min,l),vec3.add(o.max,o.max,l),o.faces=[];var h=t+r;if(n)for(var c=t;c<h;c+=3){var u=new Float32Array([s[n[c]*3],s[n[c]*3+1],s[n[c]*3+2],s[n[c+1]*3],s[n[c+1]*3+1],s[n[c+1]*3+2],s[n[c+2]*3],s[n[c+2]*3+1],s[n[c+2]*3+2],c/3]);Octree.isValidFace(u)&&this.addToNode(u,o,0)}else for(var c=t*3;c<r*3;c+=9){var u=new Float32Array(10);u.set(s.subarray(c,c+9)),u[9]=c/9,Octree.isValidFace(u)&&this.addToNode(u,o,0)}return this.total_nodes=this.trim(),o},Octree.isValidFace=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s){var n=s.subarray(0,3),a=s.subarray(3,6),o=s.subarray(6,9);return vec3.sub(e,a,n),vec3.sub(t,o,n),vec3.cross(r,e,t),vec3.length(r)>0}}(),Octree.prototype.addToNode=function(e,t,r){if(t.inside+=1,t.c){for(var s=this.computeAABB(e),n=!1,a=0;a<t.c.length;++a){var o=t.c[a];if(Octree.isInsideAABB(s,o)){this.addToNode(e,o,r+1),n=!0;break}}n||(t.faces==null&&(t.faces=[]),t.faces.push(e))}else if(t.faces==null&&(t.faces=[]),t.faces.push(e),t.faces.length>this.max_node_triangles&&r<Octree.MAX_OCTREE_DEPTH){this.splitNode(t),this.total_depth<r+1&&(this.total_depth=r+1);var l=t.faces;t.faces=null;for(var a=0;a<l.length;++a){for(var e=l[a],s=this.computeAABB(e),n=!1,h=0;h<t.c.length;++h){var o=t.c[h];if(Octree.isInsideAABB(s,o)){this.addToNode(e,o,r+1),n=!0;break}}n||(t.faces==null&&(t.faces=[]),t.faces.push(e))}}},Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]],Octree.prototype.splitNode=function(e){e.c=[];for(var t=[(e.max[0]-e.min[0])*.5,(e.max[1]-e.min[1])*.5,(e.max[2]-e.min[2])*.5],r=0;r<this.octree_pos_ref.length;++r){var s=this.octree_pos_ref[r],n=[e.min[0]+t[0]*s[0],e.min[1]+t[1]*s[1],e.min[2]+t[2]*s[2]],a=[n[0]+t[0],n[1]+t[1],n[2]+t[2]],o=new OctreeNode(n,a);this.total_nodes+=1,o.faces=null,o.inside=0,e.c.push(o)}},Octree.prototype.computeAABB=function(e){for(var t=new Float32Array([e[0],e[1],e[2]]),r=new Float32Array(t),s=3;s<e.length-1;s+=3)for(var n=0;n<3;n++)t[n]>e[s+n]&&(t[n]=e[s+n]),r[n]<e[s+n]&&(r[n]=e[s+n]);return{min:t,max:r}},Octree.prototype.computeAABBFromIndices=function(e,t,r,s){r=r||0,s=s||t.length;for(var n=t[r],a=new Float32Array([e[n*3],e[n*3+1],e[n*3+2]]),o=new Float32Array([e[n*3],e[n*3+1],e[n*3+2]]),l=r+1;l<r+s;++l)for(var n=t[l]*3,h=0;h<3;h++)a[h]>e[n+h]&&(a[h]=e[n+h]),o[h]<e[n+h]&&(o[h]=e[n+h]);return{min:a,max:o}},Octree.prototype.trim=function(e){if(e=e||this.root,!e.c)return 1;for(var t=1,r=[],s=e.c,n=0;n<s.length;++n)s[n].inside&&(r.push(s[n]),t+=this.trim(s[n]));return e.c=r,t},Octree.prototype.testRay=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create();return function(n,a,o,l,h,c){if(c=c||Octree.NEAREST,!this.root)throw"Error: octree not build";e.set(n),t.set(a),r.set(this.root.min),s.set(this.root.max);var u=Octree.hitTestBox(e,t,r,s);if(!u)return null;var u=Octree.testRayInNode(this.root,e,t,h,c);if(u==null)return null;if(c==Octree.ALL)return u;var p=vec3.scale(vec3.create(),a,u.t);return vec3.add(p,p,n),u.pos=p,u}}(),Octree.testRayInNode=function(e,t,r,s,n){var a=null,o=null;if(e.faces)for(var l=0,h=e.faces.length;l<h;++l){var c=e.faces[l];if(a=Octree.hitTestTriangle(t,r,c.subarray(0,3),c.subarray(3,6),c.subarray(6,9),s),a!=null){if(a.index=c[9],n==Octree.FIRST)return a;n==Octree.ALL?(o||(o=[]),o.push(a)):(a.face=c,o?o.mergeWith(a):o=a)}}var u=vec3.create(),p=vec3.create(),f;if(e.c){for(var l=0;l<e.c.length;++l)if(f=e.c[l],u.set(f.min),p.set(f.max),a=Octree.hitTestBox(t,r,u,p),a!=null&&!(n!=Octree.ALL&&o&&a.t>o.t)&&(a=Octree.testRayInNode(f,t,r,s,n),a!=null)){if(n==Octree.FIRST)return a;n==Octree.ALL?(o||(o=[]),o.push(a)):o?o.mergeWith(a):o=a}}return o},Octree.prototype.testSphere=function(e,t){if(e=vec3.clone(e),!this.root)throw"Error: octree not build";var r=t*t;return Octree.testSphereBox(e,r,vec3.clone(this.root.min),vec3.clone(this.root.max))?Octree.testSphereInNode(this.root,e,r):!1},Octree.testSphereInNode=function(e,t,r){if(e.faces)for(var s=0,n=e.faces.length;s<n;++s){var a=e.faces[s];if(Octree.testSphereTriangle(t,r,a.subarray(0,3),a.subarray(3,6),a.subarray(6,9)))return!0}var o=vec3.create(),l=vec3.create(),h;if(e.c){for(var s=0;s<e.c.length;++s)if(h=e.c[s],o.set(h.min),l.set(h.max),!!Octree.testSphereBox(t,r,o,l)&&Octree.testSphereInNode(h,t,r))return!0}return!1},Octree.prototype.findNearestPoint=function(e,t,r,s){if(r=r||1/0,e===t)throw"findNearestPoint input point and output cannot be the same";return Octree.nearestInNode(this.root,e,t,r,s)},Octree.nearestInNode=function(e,t,r,s,n){var a=vec3.create(),o;if(n&&(o=vec3.create()),e.faces)for(var l=0,h=e.faces.length;l<h;++l){var c=e.faces[l],u=c.subarray(0,3),p=c.subarray(3,6),f=c.subarray(6,9);Octree.closestPointOnTriangle(t,u,p,f,a);var d=vec3.dist(a,t);d<s&&(s=d,vec3.copy(r,a),n&&global$1.geo.computeTriangleNormal(n,u,p,f))}if(!e.c)return s;for(var l=0;l<e.c.length;++l){var g=e.c[l],m=Octree.distanceToBox(t,g.min,g.max);if(!(m>s)){var d=Octree.nearestInNode(g,t,a,s,o);d<s&&(s=d,vec3.copy(r,a),n&&vec3.copy(n,o))}}return s},Octree.closestPointOnTriangle=function(){var e=new Float32Array(4),t=vec3.create(),r=vec3.create(),s=vec3.create(),n=vec3.create();return function(a,o,l,h,c){if(global$1.geo.planeFromTriangle(e,o,l,h),vec3.length(e)>1e-8&&(global$1.geo.projectPointOnPlane(a,o,e,t),global$1.geo.isPointInsideTriangle(t,o,l,h)))return vec3.copy(c,t),c;global$1.geo.closestPointToSegment(t,o,l,r),global$1.geo.closestPointToSegment(t,l,h,s),global$1.geo.closestPointToSegment(t,h,o,n);var u=vec3.sqrDist(t,r),p=vec3.sqrDist(t,s),f=vec3.sqrDist(t,n),d=Math.min(u,p,f);return d===u?vec3.copy(c,r):d===p?vec3.copy(c,s):vec3.copy(c,n),c}}(),Octree.isInsideAABB=function(e,t){return!(e.min[0]<t.min[0]||e.min[1]<t.min[1]||e.min[2]<t.min[2]||e.max[0]>t.max[0]||e.max[1]>t.max[1]||e.max[2]>t.max[2])},Octree.distanceToBox=function(e,t,r){var s=(r[0]+t[0])*.5,n=(r[1]+t[1])*.5,a=(r[2]+t[2])*.5,o=r[0]-s,l=r[1]-n,h=r[2]-a,c=Math.abs(e[0]-s)-o,u=Math.abs(e[1]-n)-l,p=Math.abs(e[2]-a)-h,f=Math.min(Math.max(c,u,p),0);return c=Math.max(c,0),u=Math.max(u,0),p=Math.max(p,0),Math.sqrt(c*c+u*u+p*p)+f},Octree.hitTestBox=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),n=vec3.create(),a=vec3.create(),o=1e-6,l=vec3.fromValues(o,o,o);return function(h,c,u,p){if(vec3.subtract(e,u,h),vec3.subtract(t,p,h),vec3.maxValue(e)<0&&vec3.minValue(t)>0)return new HitTest(0,h,c);r[0]=1/c[0],r[1]=1/c[1],r[2]=1/c[2],vec3.multiply(e,e,r),vec3.multiply(t,t,r),vec3.min(s,e,t),vec3.max(n,e,t);var f=vec3.maxValue(s),d=vec3.minValue(n);if(f>0&&f<d){var g=vec3.add(vec3.create(),vec3.scale(a,c,f),h);return vec3.add(u,u,l),vec3.subtract(u,u,l),new HitTest(f,g,vec3.fromValues((g[0]>p[0])-(g[0]<u[0]),(g[1]>p[1])-(g[1]<u[1]),(g[2]>p[2])-(g[2]<u[2])))}return null}}(),Octree.hitTestTriangle=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create();return function(n,a,o,l,h,c){vec3.subtract(e,l,o),vec3.subtract(t,h,o);var u=vec3.cross(vec3.create(),e,t);if(vec3.normalize(u,u),!c&&vec3.dot(u,a)>0)return null;var p=vec3.dot(u,vec3.subtract(s,o,n))/vec3.dot(u,a);if(p>0){var f=vec3.scale(vec3.create(),a,p);vec3.add(f,f,n),vec3.subtract(r,f,o);var d=vec3.dot(t,t),g=vec3.dot(t,e),m=vec3.dot(t,r),b=vec3.dot(e,e),E=vec3.dot(e,r),L=d*b-g*g,T=(b*m-g*E)/L,_=(d*E-g*m)/L;if(T>=0&&_>=0&&T+_<=1)return new HitTest(p,f,u)}return null}}(),Octree.testSphereTriangle=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),n=vec3.create(),a=vec3.create(),o=vec3.create(),l=vec3.create();return function(h,c,u,p,f){vec3.sub(e,u,h),vec3.sub(t,p,h),vec3.sub(r,f,h),vec3.sub(s,t,e),vec3.sub(n,r,e),vec3.cross(l,s,n);var d=vec3.dot(e,l),g=vec3.dot(l,l),m=d*d>c*g,b=vec3.dot(e,e),E=vec3.dot(e,t),L=vec3.dot(e,r),T=vec3.dot(t,t),_=vec3.dot(t,r),I=vec3.dot(r,r),A=b>c&E>b&L>b,M=T>c&E>T&_>T,O=I>c&L>I&_>I,C=E-b,P=_-T,N=L-I;vec3.sub(a,r,t),vec3.sub(o,e,r);var k=vec3.dot(s,s),B=vec3.dot(a,a),S=vec3.dot(o,o),U=vec3.scale(vec3.create(),e,k);vec3.sub(U,U,vec3.scale(vec3.create(),s,C));var W=vec3.scale(vec3.create(),t,B);vec3.sub(W,W,vec3.scale(vec3.create(),a,P));var z=vec3.scale(vec3.create(),r,S);vec3.sub(z,z,vec3.scale(vec3.create(),o,N));var q=vec3.scale(vec3.create(),r,k);q=vec3.sub(q,q,U);var Y=vec3.scale(vec3.create(),e,B);Y=vec3.sub(Y,Y,W);var H=vec3.scale(vec3.create(),t,S);H=vec3.sub(H,H,z);var Z=vec3.dot(U,U)>c*k*k&vec3.dot(U,q)>0,oe=vec3.dot(W,W)>c*B*B&vec3.dot(W,Y)>0,ue=vec3.dot(z,z)>c*S*S&vec3.dot(z,H)>0,he=m|A|M|O|Z|oe|ue;return!he}}(),Octree.testSphereBox=function(e,t,r,s){for(var n,a=0,o=0;o<3;++o)e[o]<r[o]?(n=e[o]-r[o],a+=n*n):e[o]>s[o]&&(n=e[o]-s[o],a+=n*n);return a<=t};class HitTest{constructor(t,r,s,n){this.t=arguments.length?t:Number.MAX_VALUE,this.hit=r,this.normal=s,this.face=null,this.index=n}}global$1.HitTest=GL$1.HitTest=HitTest,HitTest.prototype.mergeWith=function(e){e.t>0&&e.t<this.t&&(this.t=e.t,this.hit=e.hit,this.normal=e.normal,this.face=e.face,this.index=e.index)},global$1.Ray=GL$1.Ray=function(t,r){this.origin=vec3.create(),this.direction=vec3.create(),this.collision_point=vec3.create(),this.t=-1,t&&this.origin.set(t),r&&this.direction.set(r)},GL$1.Ray.prototype.testPlane=function(e,t){var r=global$1.geo.testRayPlane(this.origin,this.direction,e,t,this.collision_point);return this.t=global$1.geo.last_t,r},GL$1.Ray.prototype.testSphere=function(e,t,r){var s=global$1.geo.testRaySphere(this.origin,this.direction,e,t,this.collision_point,r);return this.t=global$1.geo.last_t,s},GL$1.Ray.prototype.testBBox=function(e,t,r,s){var n=global$1.geo.testRayBBox(this.origin,this.direction,e,r,this.collision_point,t,s);return this.t=global$1.geo.last_t,n},global$1.Raytracer=GL$1.Raytracer=function(t,r){this.viewport=vec4.create(),this.ray00=vec3.create(),this.ray10=vec3.create(),this.ray01=vec3.create(),this.ray11=vec3.create(),this.eye=vec3.create(),this.setup(t,r)},GL$1.Raytracer.prototype.setup=function(e,t){t=t||gl.viewport_data,this.viewport.set(t);var r=t[0],s=r+t[2],n=t[1],a=n+t[3];vec3.set(this.ray00,r,n,1),vec3.set(this.ray10,s,n,1),vec3.set(this.ray01,r,a,1),vec3.set(this.ray11,s,a,1),vec3.unproject(this.ray00,this.ray00,e,t),vec3.unproject(this.ray10,this.ray10,e,t),vec3.unproject(this.ray01,this.ray01,e,t),vec3.unproject(this.ray11,this.ray11,e,t);var o=this.eye;vec3.unproject(o,o,e,t),vec3.subtract(this.ray00,this.ray00,o),vec3.subtract(this.ray10,this.ray10,o),vec3.subtract(this.ray01,this.ray01,o),vec3.subtract(this.ray11,this.ray11,o)},GL$1.Raytracer.prototype.getRayForPixel=function(){var e=vec3.create(),t=vec3.create();return function(r,s,n){return n=n||vec3.create(),r=(r-this.viewport[0])/this.viewport[2],s=1-(s-this.viewport[1])/this.viewport[3],vec3.lerp(e,this.ray00,this.ray10,r),vec3.lerp(t,this.ray01,this.ray11,r),vec3.lerp(n,e,t,s),vec3.normalize(n,n)}}();var _hittest_inv=mat4.create();GL$1.Raytracer.hitTestBox=function(e,t,r,s,n){var a=new Float32Array(30);if(n){var o=mat4.invert(_hittest_inv,n);e=mat4.multiplyVec3(a.subarray(3,6),o,e),t=mat4.rotateVec3(a.subarray(6,9),o,t)}var l=vec3.subtract(a.subarray(9,12),r,e);vec3.divide(l,l,t);var h=vec3.subtract(a.subarray(12,15),s,e);vec3.divide(h,h,t);var c=vec3.min(a.subarray(15,18),l,h),u=vec3.max(a.subarray(18,21),l,h),p=vec3.maxValue(c),f=vec3.minValue(u);if(p>0&&p<=f){var d=1e-6,g=vec3.scale(a.subarray(21,24),t,p);return vec3.add(g,e,g),vec3.addValue(a.subarray(24,27),r,d),vec3.subValue(a.subarray(27,30),s,d),new HitTest(p,g,vec3.fromValues((g[0]>s[0])-(g[0]<r[0]),(g[1]>s[1])-(g[1]<r[1]),(g[2]>s[2])-(g[2]<r[2])))}return null},GL$1.Raytracer.hitTestSphere=function(e,t,r,s){var n=vec3.subtract(vec3.create(),e,r),a=vec3.dot(t,t),o=2*vec3.dot(t,n),l=vec3.dot(n,n)-s*s,h=o*o-4*a*l;if(h>0){var c=(-o-Math.sqrt(h))/(2*a),u=vec3.add(vec3.create(),e,vec3.scale(vec3.create(),t,c));return new HitTest(c,u,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),u,r),1/s))}return null},GL$1.Raytracer.hitTestTriangle=function(e,t,r,s,n){var a=vec3.subtract(vec3.create(),s,r),o=vec3.subtract(vec3.create(),n,r),l=vec3.cross(vec3.create(),a,o);vec3.normalize(l,l);var h=vec3.dot(l,vec3.subtract(vec3.create(),r,e))/vec3.dot(l,t);if(h>0){var c=vec3.add(vec3.create(),e,vec3.scale(vec3.create(),t,h)),u=vec3.subtract(vec3.create(),c,r),p=vec3.dot(o,o),f=vec3.dot(o,a),d=vec3.dot(o,u),g=vec3.dot(a,a),m=vec3.dot(a,u),b=p*g-f*f,E=(g*d-f*m)/b,L=(p*m-f*d)/b;if(E>=0&&L>=0&&E+L<=1)return new HitTest(h,c,l)}return null},Mesh.parseOBJ=function(e,t){t=t||{};var r=t.matextension||"",s=[],n=[],a=[],o=[],l=[],h=[],c=[],u={},p=null,f=Ae(),d=new Map,g=0,m=1;t.scale&&(m=t.scale);for(var b=1,E=2,L=3,T=4,_=5,I=6,A=7,M=8,O={v:b,vt:E,vn:L,f:T,g:_,o:I,usemtl:A,mtllib:M},C,P,N,k=e.split(`
`),B=k.length,S=0;S<B;++S){var U=k[S];if(U=U.replace(/[ \t]+/g," ").replace(/\s\s*$/,""),U[U.length-1]=="\\"){S+=1;var W=k[S].replace(/[ \t]+/g," ").replace(/\s\s*$/,"");U=(U.substr(0,U.length-1)+W).replace(/[ \t]+/g," ").replace(/\s\s*$/,"")}if(U[0]!="#"&&U!=""){var z=U.split(" "),q=O[z[0]];switch(q<=L&&(C=parseFloat(z[1]),P=parseFloat(z[2]),q!=E&&(N=parseFloat(z[3]))),q){case b:C*=m,P*=m,N*=m,s.push(C,P,N);break;case E:a.push(C,P);break;case L:n.push(C,P,N);break;case T:if(z.length<4)continue;for(var Y=[],H=1;H<z.length;++H)Y.push(me(z[H]));f.indices.push(Y[0],Y[1],Y[2]);for(var H=2;H<Y.length-1;++H)f.indices.push(Y[0],Y[H],Y[H+1]);break;case _:case I:var Z=z[1];p=Z,f.name?(u={},f=Ae(Z)):f.name=Z;break;case A:ze(z[1]);break;case M:z[1];break}}}for(var oe=[],ue=0,he=[],H=0;H<c.length;++H){var f=c[H];f.indices&&(f.start=ue,f.length=f.indices.length,oe=oe.concat(f.indices),delete f.indices,ue+=f.length,he.push(f))}c=he;var se={};if(!s.length)return console.error("mesh without vertices"),null;if(t.flip_normals&&l.length)for(var n=l,H=0;H<n.length;++H)n[H]*=-1;se.vertices=new Float32Array(o),l.length&&(se.normals=new Float32Array(l)),h.length&&(se.coords=new Float32Array(h)),oe&&oe.length>0&&(se.triangles=new(ue>256*256?Uint32Array:Uint16Array)(oe)),se.bounding=GL$1.Mesh.computeBoundingBox(se.vertices);var ve={};if(c.length>1&&(ve.groups=c),se.info=ve,!se.bounding)return console.log("empty mesh"),null;if(t.only_data)return se;var fe=null;return fe=Mesh.load(se,null,t.mesh),fe;function me(ge){var ce,Ee,Te,Le,G=!1;if(ge.indexOf("-")==-1){var F=d.get(ge);if(F!==void 0)return F}else G=!0;if(Le||(Le=ge.split("/")),Le.length==1)ce=parseInt(Le[0]),Ee=ce,Te=ce;else if(Le.length==2)ce=parseInt(Le[0]),Ee=parseInt(Le[1]),Te=ce;else if(Le.length==3)ce=parseInt(Le[0]),Ee=parseInt(Le[1]),Te=parseInt(Le[2]);else return console.log("Problem parsing: unknown number of values per face"),-1;if(ce<0&&(ce=s.length/3+ce+1),Te<0&&(Te=n.length/2+Te+1),Ee<0&&(Ee=a.length/2+Ee+1),G){ge=ce+"/"+Ee+"/"+Te;var F=d.get(ge);if(F!==void 0)return F}ce-=1,Ee-=1,Te-=1,o.push(s[ce*3+0],s[ce*3+1],s[ce*3+2]),a.length&&h.push(a[Ee*2+0],a[Ee*2+1]),n.length&&l.push(n[Te*3+0],n[Te*3+1],n[Te*3+2]);var F=g;return d.set(ge,F),++g,F}function Ae(ge){var ce={name:ge||"",material:"",start:-1,length:-1,indices:[]};return c.push(ce),ce}function ze(ge){if(!f.material)return f.material=ge+r,u[ge]=f,f;var ce=u[ge];return ce||(ce=Ae(p+"_"+ge),ce.material=ge+r,u[ge]=ce),f=ce,ce}},Mesh.parsers.obj=Mesh.parseOBJ,Mesh.encoders.obj=function(e,t){var r=e.getBuffer("vertices");if(!r)return null;var s=[];s.push(`# Generated with liteGL.js by Javi Agenjo
`);for(var n=r.data,a=0;a<n.length;a+=3)s.push("v "+n[a].toFixed(4)+" "+n[a+1].toFixed(4)+" "+n[a+2].toFixed(4));var o=e.getBuffer("normals");if(o){s.push("");for(var l=o.data,a=0;a<l.length;a+=3)s.push("vn "+l[a].toFixed(4)+" "+l[a+1].toFixed(4)+" "+l[a+2].toFixed(4))}var h=e.getBuffer("coords");if(h){s.push("");for(var c=h.data,a=0;a<c.length;a+=2)s.push("vt "+c[a].toFixed(4)+" "+c[a+1].toFixed(4)+"  0.0000")}var u=e.info.groups,p=e.getIndexBuffer("triangles");if(p){var f=p.data;(!u||!u.length)&&(u=[{start:0,length:f.length,name:"mesh"}]);for(var d=0;d<u.length;++d){var g=u[d];s.push("g "+g.name);var m=g.material||"mat_"+d;m.indexOf(".json")!=-1&&(m=m.substr(0,m.indexOf(".json"))),s.push("usemtl "+m);for(var b=g.start,E=b+g.length,a=b;a<E;a+=3)s.push("f "+(f[a]+1)+"/"+(f[a]+1)+"/"+(f[a]+1)+" "+(f[a+1]+1)+"/"+(f[a+1]+1)+"/"+(f[a+1]+1)+" "+(f[a+2]+1)+"/"+(f[a+2]+1)+"/"+(f[a+2]+1))}}else{(!u||!u.length)&&(u=[{start:0,length:n.length/3,name:"mesh"}]);for(var d=0;d<u.length;++d){var g=u[d];s.push("g "+g.name),s.push("usemtl "+(g.material||"mat_"+d));for(var b=g.start,E=b+g.length,a=b;a<E;a+=3)s.push("f "+(a+1)+"/"+(a+1)+"/"+(a+1)+" "+(a+2)+"/"+(a+2)+"/"+(a+2)+" "+(a+3)+"/"+(a+3)+"/"+(a+3))}}return s.join(`
`)},Mesh.parsers.mesh=function(e,t){for(var r={},s=e.split(`
`),n=0;n<s.length;++n){var a=s[n],o=a[0],l=a.substr(1).split(","),h=l[0];if(o=="-"){var c=1,u=Float32Array;(h=="weights"||h=="bone_indices")&&(u=Uint8Array),h=="weights"&&(c=255);for(var p=new u(Number(l[1])),f=0;f<p.length;++f)p[f]=Number(l[f+2])*c;r[h]=p}else if(o=="*"){var u=Uint16Array;Number(l[1])>256*256&&(u=Uint32Array);for(var p=new u(Number(l[1])),f=0;f<p.length;++f)p[f]=Number(l[f+2]);r[h]=p}else if(o=="@"){if(h=="bones"){for(var d=[],g=Number(l[1]),f=0;f<g;++f){var m=l.slice(3+f*17,3+(f+1)*17-1).map(Number);d.push([l[2+f*17],m])}r.bones=d}else if(h=="bind_matrix")r.bind_matrix=l.slice(1,17).map(Number);else if(h=="groups"){r.info={groups:[]};for(var b=Number(l[1]),f=0;f<b;++f){var E={name:l[2+f*4],material:l[2+f*4+1],start:Number(l[2+f*4+2]),length:Number(l[2+f*4+3])};r.info.groups.push(E)}}}else console.warn("type unknown: "+l[0])}if(t.only_data)return r;var L=null;return L=Mesh.load(r,null,t.mesh),L.updateBoundingBox(),L},Mesh.encoders.mesh=function(e,t){var r=[];for(var s in e.vertexBuffers){var n=e.vertexBuffers[s],a=global$1.typedArrayToArray(n.data);if(n.normalize&&n.data.constructor==Uint8Array)for(var o=0;o<a.length;++o)a[o]/=255;var l=["-"+s,n.data.length,n.data,a];r.push(l.join(","))}for(var s in e.indexBuffers){var n=e.indexBuffers[s],a=global$1.typedArrayToArray(n.data),l=["*"+s,n.data.length,n.data,a];r.push(l.join(","))}if(e.bounding&&r.push(["@bounding",global$1.typedArrayToArray(e.bounding.subarray(0,6))].join(",")),e.info&&e.info.groups){for(var h=[],o=0;o<e.info.groups.length;++o){var c=e.info.groups[o];h.push(c.name,c.material,c.start,c.length)}r.push(["@groups",e.info.groups.length].concat(h).join(","))}return e.bones&&r.push(["@bones",e.bones.length,e.bones.flat()].join(",")),e.bind_matrix&&r.push(["@bind_matrix",global$1.typedArrayToArray(e.bind_matrix)].join(",")),r.join(`
`)},global$1.WBin&&(global$1.WBin.classes.Mesh=Mesh),Mesh.binary_file_formats.wbin=!0,Mesh.parsers.wbin=Mesh.fromBinary=function(e,t){t=t||{};var r=null;if(e.constructor==ArrayBuffer){if(!global$1.WBin)throw"To use binary meshes you need to install WBin.js from https://github.com/jagenjo/litescene.js/blob/master/src/utils/wbin.js ";r=global$1.WBin.load(e,!0)}else r=e;r.info||console.warn("This WBin doesn't seem to contain a mesh. Classname: ",r["@classname"]),r.format&&GL$1.Mesh.decompress(r);var s={};if(r.vertex_buffers)for(var n in r.vertex_buffers)s[r.vertex_buffers[n]]=r[r.vertex_buffers[n]];else r.vertices&&(s.vertices=r.vertices),r.normals&&(s.normals=r.normals),r.coords&&(s.coords=r.coords),r.weights&&(s.weights=r.weights),r.bone_indices&&(s.bone_indices=r.bone_indices);var a={};if(r.index_buffers)for(var n in r.index_buffers)a[r.index_buffers[n]]=r[r.index_buffers[n]];else r.triangles&&(a.triangles=r.triangles),r.wireframe&&(a.wireframe=r.wireframe);var o={vertex_buffers:s,index_buffers:a,bounding:r.bounding,info:r.info};if(r.bones){o.bones=r.bones;for(var n=0;n<o.bones.length;++n)o.bones[n][1]=mat4.clone(o.bones[n][1]);r.bind_matrix&&(o.bind_matrix=mat4.clone(r.bind_matrix))}if(r.morph_targets&&(o.morph_targets=r.morph_targets),t.only_data)return o;var l=t.mesh||new GL$1.Mesh;return l.configure(o),l},Mesh.encoders.wbin=function(e,t){return e.updateBoundingBox(),e.toBinary(t)},Mesh.prototype.toBinary=function(e){if(!global$1.WBin)throw"to use Mesh.toBinary you need to have WBin included. Check the repository for wbin.js";this.info||(this.info={});var t={object_class:"Mesh",info:this.info,groups:this.groups};if(this.bones){for(var r=[],s=0;s<this.bones.length;++s)r.push([this.bones[s][0],mat4.toArray(this.bones[s][1])]);t.bones=r,this.bind_matrix&&(t.bind_matrix=this.bind_matrix)}this.bounding||this.updateBoundingBox(),t.bounding=this.bounding;var n=[],a=[];for(var s in this.vertexBuffers){var o=this.vertexBuffers[s];t[o.name]=o.data,n.push(o.name),o.name=="vertices"&&(t.info.num_vertices=o.data.length/3)}for(var s in this.indexBuffers){var o=this.indexBuffers[s];t[s]=o.data,a.push(s)}t.vertex_buffers=n,t.index_buffers=a,GL$1.Mesh.enable_wbin_compression&&GL$1.Mesh.compress(t);var l=global$1.WBin.create(t,"Mesh");return l},Mesh.compress=function(e,t){t=t||"bounding_compressed",e.format={type:t};var r=Mesh.compressors[t];if(!r)throw"compression format not supported:"+t;return r(e)},Mesh.decompress=function(e){if(e.format){var t=Mesh.decompressors[e.format.type];if(!t)throw"decompression format not supported:"+e.format.type;return t(e)}},Mesh.compressors.bounding_compressed=function(e){if(!e.vertex_buffers)throw"buffers not found";for(var t=global$1.BBox.getMin(e.bounding),r=global$1.BBox.getMax(e.bounding),s=vec3.sub(vec3.create(),r,t),n=e.vertices,a=new Uint16Array(n.length),o=0;o<n.length;o+=3)a[o]=(n[o]-t[0])/s[0]*65535,a[o+1]=(n[o+1]-t[1])/s[1]*65535,a[o+2]=(n[o+2]-t[2])/s[2]*65535;if(e.vertices=a,e.normals){for(var l=e.normals,h=new Uint8Array(l.length),c=h.constructor==Uint8Array?255:65535,o=0;o<l.length;o+=3)h[o]=(l[o]*.5+.5)*c,h[o+1]=(l[o+1]*.5+.5)*c,h[o+2]=(l[o+2]*.5+.5)*c;e.normals=h}if(e.coords){for(var u=e.coords,p=[1e4,1e4,-1e4,-1e4],o=0;o<u.length;o+=2){var f=u[o];p[0]>f?p[0]=f:p[2]<f&&(p[2]=f);var d=u[o+1];p[1]>d?p[1]=d:p[3]<d&&(p[3]=d)}e.format.uvs_bounding=p;for(var g=new Uint16Array(u.length),s=[p[2]-p[0],p[3]-p[1]],o=0;o<u.length;o+=2)g[o]=(u[o]-p[0])/s[0]*65535,g[o+1]=(u[o+1]-p[1])/s[1]*65535;e.coords=g}if(e.weights){for(var m=e.weights,b=new Uint16Array(m.length),E=b.constructor==Uint8Array?255:65535,o=0;o<m.length;o+=4)b[o]=m[o]*E,b[o+1]=m[o+1]*E,b[o+2]=m[o+2]*E,b[o+3]=m[o+3]*E;e.weights=b}},Mesh.decompressors.bounding_compressed=function(e){var t=e.bounding;if(!t)throw"error in mesh decompressing data: bounding not found, cannot use the bounding decompression.";for(var r=global$1.BBox.getMin(t),s=global$1.BBox.getMax(t),n=vec3.sub(vec3.create(),s,r),a=e.format,o=1/255,l=1/65535,h=e.vertices,c=new Float32Array(h.length),u=0,p=h.length;u<p;u+=3)c[u]=h[u]*l*n[0]+r[0],c[u+1]=h[u+1]*l*n[1]+r[1],c[u+2]=h[u+2]*l*n[2]+r[2];if(e.vertices=c,e.normals&&e.normals.constructor!=Float32Array){for(var f=e.normals,d=new Float32Array(f.length),g=f.constructor==Uint8Array?o:l,u=0,p=f.length;u<p;u+=3){d[u]=f[u]*g*2-1,d[u+1]=f[u+1]*g*2-1,d[u+2]=f[u+2]*g*2-1;var m=d.subarray(u,u+3);vec3.normalize(m,m)}e.normals=d}if(e.coords&&a.uvs_bounding&&e.coords.constructor!=Float32Array){for(var b=e.coords,E=a.uvs_bounding,n=[E[2]-E[0],E[3]-E[1]],L=new Float32Array(b.length),u=0,p=b.length;u<p;u+=2)L[u]=b[u]*l*n[0]+E[0],L[u+1]=b[u+1]*l*n[1]+E[1];e.coords=L}if(e.weights&&e.weights.constructor!=Float32Array){for(var T=e.weights,_=new Float32Array(T.length),I=T.constructor==Uint8Array?o:l,u=0,p=T.length;u<p;u+=4)_[u]=T[u]*I,_[u+1]=T[u+1]*I,_[u+2]=T[u+2]*I,_[u+3]=T[u+3]*I;e.weights=_}};const{hexColorToRGBA}=global$1;if(typeof GL$1>"u")throw"litegl.js must be included to use enableWebGLCanvas";function enableWebGLCanvas(e,t){var r;if(t=t||{},e.is_webgl)r=e.gl;else{t.canvas=e,t.alpha=!0,t.stencil=!0;try{r=GL$1.create(t)}catch{return console.log("This canvas cannot be used as WebGL, maybe WebGL is not supported or this canvas has already a 2D context associated"),r=e.getContext("2d",t),r}}const s=r.getError();if(s!==r.NO_ERROR&&console.error("WebGL error:",s),e.canvas2DtoWebGL_enabled)return r;var n=50,a=1e4,o=1e3;e.canvas2DtoWebGL_enabled=!0;var l=null,h=e.ctx=r;h.WebGLCanvas={},fromValues$2(1,1,1,1);var c=0,u=new Float32Array(a*3),p=new GL$1.Mesh,f=p.createVertexBuffer("vertices",null,null,u,r.STREAM_DRAW),d=GL$1.Mesh.getScreenQuad(),g=GL$1.Mesh.circle({size:1}),m=create$4(),b=t.anisotropic!==void 0?t.anisotropic:2,E={u_texture:0},L={};t.allow3D&&(L.EXTRA_PROJECTION="");var T=r.WebGLCanvas.textures_atlas={};r.WebGLCanvas.clearAtlas=function(){T=r.WebGLCanvas.textures_atlas={}};var _=null,I=null,A=null,M=null,O=null,C=null,P=null,N=null,k=null,B=null;r.WebGLCanvas.set3DMatrix=function(G){G?m.set(G):identity$1(m),L.EXTRA_PROJECTION==null&&(L.EXTRA_PROJECTION="",S(),E.u_projection=m),E.u_projection_enabled=!!G},S();function S(){_=`
				precision highp float;
				attribute vec3 a_vertex;
				uniform vec2 u_viewport;
				uniform mat3 u_transform;
				#ifdef EXTRA_PROJECTION
					uniform bool u_projection_enabled;
					uniform mat4 u_projection;
				#endif
				varying float v_visible;
				void main() { 
					vec3 pos = a_vertex;
					v_visible = pos.z;
					pos = u_transform * vec3(pos.xy,1.0);
					pos.z = 0.0;
					#ifdef EXTRA_PROJECTION
						if(u_projection_enabled)
						{
							gl_Position = u_projection * vec4(pos.xy,0.0,1.0);
							return;
						}
					#endif
					//normalize
					pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
					pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
					gl_Position = vec4(pos, 1.0); 
				}
				`,I=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			uniform vec2 u_position;
			uniform vec2 u_size;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			#ifdef EXTRA_PROJECTION
				uniform bool u_projection_enabled;
				uniform mat4 u_projection;
			#endif
			void main() { 
				vec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);
				v_coord = a_coord; 
				pos = u_transform * pos;
				pos.z = 0.0;
				#ifdef EXTRA_PROJECTION
					if(u_projection_enabled)
					{
						gl_Position = u_projection * vec4(pos.xy,0.0,1.0);
						return;
					}
				#endif
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
			}
		`,A=new GL$1.Shader(I,`
				precision highp float;
				uniform vec4 u_color;
				void main() {
					gl_FragColor = u_color;
				}
			`,L),M=new GL$1.Shader(I,`
				precision highp float;
				varying vec2 v_coord;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				void main() {
					gl_FragColor = u_color * texture2D( u_texture, v_coord );
				}
			`,L),O=new GL$1.Shader(I,`
				precision highp float;
				varying vec2 v_coord;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				void main() {
					vec4 color = u_color * texture2D( u_texture, v_coord );
					if(color.a <= 0.0)
						discard;
					gl_FragColor = color;
				}
			`,L),C=new GL$1.Shader(_,`
				precision highp float;
				varying float v_visible;
				uniform vec4 u_color;
				void main() {
					if (v_visible == 0.0)
						discard;
					gl_FragColor = u_color;
				}
			`,L),P=new GL$1.Shader(GL$1.Shader.QUAD_VERTEX_SHADER,`
				precision highp float;
				uniform sampler2D u_texture;
				uniform vec4 u_color;
				uniform vec4 u_texture_transform;
				varying vec2 v_coord;
				void main() {
					vec2 uv = v_coord * u_texture_transform.zw + vec2(u_texture_transform.x,0.0);
					uv.y = uv.y - u_texture_transform.y + (1.0 - u_texture_transform.w);
					uv = clamp(uv,vec2(0.0),vec2(1.0));
					gl_FragColor = u_color * texture2D(u_texture, uv);
				}
			`,L),N=new GL$1.Shader(_,`
				precision highp float;
				varying float v_visible;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				uniform vec4 u_texture_transform;
				uniform vec2 u_viewport;
				uniform mat3 u_itransform;
				void main() {
					vec2 pos = (u_itransform * vec3( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t,1.0)).xy;
					pos *= vec2( (u_viewport.x * u_texture_transform.z), (u_viewport.y * u_texture_transform.w) );
					vec2 uv = fract(pos / u_viewport) + u_texture_transform.xy;
					uv.y = 1.0 - uv.y;
					gl_FragColor = u_color * texture2D( u_texture, uv);
				}
			`,L),k=new GL$1.Shader(_,`
				precision highp float;
				varying float v_visible;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				uniform vec4 u_gradient;
				uniform vec2 u_viewport;
				uniform mat3 u_itransform;
				void main() {
					vec2 pos = (u_itransform * vec3( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t,1.0)).xy;
					//vec2 pos = vec2( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t);
					vec2 AP = pos - u_gradient.xy;
					vec2 AB = u_gradient.zw - u_gradient.xy;
					float dotAPAB = dot(AP,AB);
					float dotABAB = dot(AB,AB);
					float x = dotAPAB / dotABAB;
					vec2 uv = vec2( x, 0.0 );
					gl_FragColor = u_color * texture2D( u_texture, uv );
				}
			`,L);var G=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			#ifdef EXTRA_PROJECTION
				uniform bool u_projection_enabled;
				uniform mat4 u_projection;
			#endif
			uniform float u_pointSize;
			void main() { 
				vec3 pos = a_vertex;
				pos = u_transform * pos;
				pos.z = 0.0;
				#ifdef EXTRA_PROJECTION
					if(u_projection_enabled)
					{
						gl_Position = u_projection * vec4(pos.xy,0.0,1.0);
						return;
					}
				#endif
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
				gl_PointSize = ceil(u_pointSize);
				v_coord = a_coord;
			}
			`,F=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform float u_iCharSize;
			uniform vec4 u_color;
			uniform float u_pointSize;
			uniform vec2 u_viewport;
			uniform vec2 u_angle_sincos;
			varying vec2 v_coord;
			void main() {
				vec2 uv = vec2(1.0 - gl_PointCoord.s, gl_PointCoord.t);
				uv = vec2( ((uv.y - 0.5) * u_angle_sincos.y - (uv.x - 0.5) * u_angle_sincos.x) + 0.5, ((uv.x - 0.5) * u_angle_sincos.y + (uv.y - 0.5) * u_angle_sincos.x) + 0.5);
				uv = v_coord - uv * u_iCharSize + vec2(u_iCharSize*0.5);
				uv.y = 1.0 - uv.y;
				gl_FragColor = vec4(u_color.xyz, u_color.a * texture2D(u_texture, uv, -1.0  ).a);
      }
			`;B=new GL$1.Shader(G,F,L)}h.createImageShader=function(G){return new GL$1.Shader(GL$1.Shader.QUAD_VERTEX_SHADER,`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			uniform vec4 u_texture_transform;
			uniform vec2 u_viewport;
			varying vec2 v_coord;
			void main() {
				vec2 uv = v_coord * u_texture_transform.zw + vec2(u_texture_transform.x,0.0);
				uv.y = uv.y - u_texture_transform.y + (1.0 - u_texture_transform.w);
				uv = clamp(uv,vec2(0.0),vec2(1.0));
				vec4 color = u_color * texture2D(u_texture, uv);
				`+G+`;
				gl_FragColor = color;
			}
		`,L)},h.WebGLCanvas.vertex_shader=_,h._matrix=create$5();var U=create$5(),W=create(),z=create$2(),q=create$2(),Y=create();h._stack=[],h._stack_size=0;var H=0,Z=h.viewport_data.subarray(2,4);h.translate=function(G,F){W[0]=G,W[1]=F,translate$1(this._matrix,this._matrix,W)},h.rotate=function(G){rotate$2(this._matrix,this._matrix,G),H+=G},h.scale=function(G,F){W[0]=G,W[1]=F,scale$5(this._matrix,this._matrix,W)},h.resetTransform=function(){r._stack_size=0,this._matrix.set([1,0,0,0,1,0,0,0,1]),H=0},h.save=function(){if(!(this._stack_size>=32)){var G=null;this._stack_size==this._stack.length?G=this._stack[this._stack_size]={matrix:create$5(),fillColor:create$2(),strokeColor:create$2(),shadowColor:create$2(),globalAlpha:1,font:"",fontFamily:"",fontSize:14,fontMode:"",textAlign:"",clip_level:0}:G=this._stack[this._stack_size],this._stack_size++,G.matrix.set(this._matrix),G.fillColor.set(this._fillcolor),G.strokeColor.set(this._strokecolor),G.shadowColor.set(this._shadowcolor),G.globalAlpha=this._globalAlpha,G.font=this._font,G.fontFamily=this._font_family,G.fontSize=this._font_size,G.fontMode=this._font_mode,G.textAlign=this.textAlign,G.clip_level=this.clip_level}},h.restore=function(){if(this._stack_size==0){identity$2(this._matrix),H=0;return}this._stack_size--;var G=this._stack[this._stack_size];this._matrix.set(G.matrix),this._fillcolor.set(G.fillColor),this._strokecolor.set(G.strokeColor),this._shadowcolor.set(G.shadowColor),this._globalAlpha=G.globalAlpha,this._font=G.font,this._font_family=G.fontFamily,this._font_size=parseInt(G.fontSize),this._font_mode=G.fontMode,this.textAlign=G.textAlign;var F=this.clip_level;this.clip_level=G.clip_level,H=Math.atan2(this._matrix[3],this._matrix[4]),F==this.clip_level||(this.clip_level==0?(r.enable(r.STENCIL_TEST),r.clearStencil(0),r.clear(r.STENCIL_BUFFER_BIT),r.disable(r.STENCIL_TEST)):(r.stencilFunc(r.LEQUAL,this.clip_level,255),r.stencilOp(r.KEEP,r.KEEP,r.KEEP)))},h.clip=function(){this.clip_level==0,this.clip_level++,r.colorMask(!1,!1,!1,!1),r.depthMask(!1),r.enable(r.STENCIL_TEST),r.stencilFunc(r.EQUAL,this.clip_level-1,255),r.stencilOp(r.KEEP,r.KEEP,r.INCR),this.fill(),r.colorMask(!0,!0,!0,!0),r.depthMask(!0),r.stencilFunc(r.EQUAL,this.clip_level,255),r.stencilOp(r.KEEP,r.KEEP,r.KEEP)},h.clipImage=function(G,F,V,$,X){this.clip_level++,r.colorMask(!1,!1,!1,!1),r.depthMask(!1),r.enable(r.STENCIL_TEST),r.stencilFunc(r.EQUAL,this.clip_level-1,255),r.stencilOp(r.KEEP,r.KEEP,r.INCR),this.drawImage(G,F,V,$,X,O),r.colorMask(!0,!0,!0,!0),r.depthMask(!0),r.stencilFunc(r.EQUAL,this.clip_level,255),r.stencilOp(r.KEEP,r.KEEP,r.KEEP)},h.transform=function(G,F,V,$,X,J){var j=U;j[0]=G,j[1]=F,j[2]=0,j[3]=V,j[4]=$,j[5]=0,j[6]=X,j[7]=J,j[8]=1,multiply$5(this._matrix,this._matrix,j),H=Math.atan2(this._matrix[0],this._matrix[1])},h.setTransform=function(G,F,V,$,X,J){var j=this._matrix;j[0]=G,j[1]=F,j[2]=0,j[3]=V,j[4]=$,j[5]=0,j[6]=X,j[7]=J,j[8]=1,H=Math.atan2(this._matrix[0],this._matrix[1])};function oe(G){var F=null;if(G.constructor===GL$1.Texture)return G._context_id==r.context_id?G:null;if(G.gl||(G.gl={}),G.src){var V=r.REPEAT;return F=G.gl[r.context_id],F?(G.mustUpdate&&(F.uploadData(G),G.mustUpdate=!1),F):G.gl[r.context_id]=GL$1.Texture.fromImage(G,{magFilter:r.LINEAR,minFilter:r.LINEAR_MIPMAP_LINEAR,wrap:V,ignore_pot:!0,premultipliedAlpha:!0,anisotropic:b})}else return F=G.gl[r.context_id],F?(G.mustUpdate&&(F.uploadData(G),G.mustUpdate=!1),F):G.gl[r.context_id]=GL$1.Texture.fromImage(G,{minFilter:r.LINEAR,magFilter:r.LINEAR,anisotropic:b})}h.drawImage=function(G,F,V,$,X,J){if(G){var j=G.videoWidth||G.width,ie=G.videoHeight||G.height;if(!(j==0||ie==0)){var K=oe(G);K&&(arguments.length==9?(q.set([F/j,V/ie,$/j,X/ie]),F=arguments[5],V=arguments[6],$=arguments[7],X=arguments[8],J=P):q.set([0,0,1,1]),W[0]=F,W[1]=V,Y[0]=$===void 0?K.width:$,Y[1]=X===void 0?K.height:X,K.bind(0),K!==G&&r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,this.imageSmoothingEnabled?r.LINEAR:r.NEAREST),this.tintImages||(z[0]=z[1]=z[2]=1,z[3]=this._globalAlpha),E.u_color=this.tintImages?this._fillcolor:z,E.u_position=W,E.u_size=Y,E.u_transform=this._matrix,E.u_texture_transform=q,E.u_viewport=Z,J=J||M,J.uniforms(E).draw(d),m[14]-=.001)}}},h.createPattern=function(G){return oe(G)};function ue(G,F,V,$){this.id=h._last_gradient_id++%h._max_gradients,this.points=new Float32Array([G,F,V,$]),this.stops=[],this._must_update=!0}h._last_gradient_id=0,h._max_gradients=16,h._gradients_pool=[],ue.prototype.addColorStop=function(G,F){var V=hexColorToRGBA(F),$=new Uint8Array(4);$[0]=Math.clamp(V[0],0,1)*255,$[1]=Math.clamp(V[1],0,1)*255,$[2]=Math.clamp(V[2],0,1)*255,$[3]=Math.clamp(V[3],0,1)*255,this.stops.push([G,$]),this.stops.sort(function(X,J){return X[0]>J[0]?1:J[0]>X[0]?-1:0}),this._must_update=!0},ue.prototype.toTexture=function(){if(this._texture||(this.id!=-1&&(this._texture=h._gradients_pool[this.id]),this._texture||(this._texture=new GL$1.Texture(128,1,{format:r.RGBA,magFilter:r.LINEAR,wrap:r.CLAMP_TO_EDGE,minFilter:r.NEAREST}),this.id!=-1&&(h._gradients_pool[this.id]=this._texture))),!this._must_update)return this._texture;if(this._must_update=!1,this.stops.length<1)return this._texture;if(this.stops.length<2)return this._texture.fill(this.stops[0][1]),this._texture;for(var G=0,F=this.stops[G],V=this.stops[G+1],$=new Uint8Array(128*4),X=0;X<128;X+=1){var J=$.subarray(X*4,X*4+4),j=X/128;if(F[0]>j)if(G==0)J.set(F[1]);else{if(G+=1,F=this.stops[G],V=this.stops[G+1],!V)break;X-=1}else if(F[0]<=j&&j<V[0]){var ie=(j-F[0])/(V[0]-F[0]);lerp$2(J,F[1],V[1],ie)}else if(V[0]<=j){if(G+=1,F=this.stops[G],V=this.stops[G+1],!V)break;X-=1}}if(X<128)for(var K=X;K<128;K+=1)$.set(F[1],K*4);return this._texture.uploadData($),this._texture},h.createLinearGradient=function(G,F,V,$){return new ue(G,F,V,$)},h.beginPath=function(){c=0},h.closePath=function(){c<3||(u[c]=u[0],u[c+1]=u[1],u[c+2]=1,c+=3)},h.moveTo=function(G,F){c==0?(u[c]=G,u[c+1]=F,u[c+2]=1,c+=3):(u[c]=u[c-3],u[c+1]=u[c-2],u[c+2]=0,c+=3,u[c]=G,u[c+1]=F,u[c+2]=0,c+=3)},h.lineTo=function(G,F){u[c]=G,u[c+1]=F,u[c+2]=1,c+=3},h.bezierCurveTo=function(G,F,V,$,X,J){if(!(c<3))for(var j=[u[c-3],u[c-2]],ie=[j,[G,F],[V,$],[X,J]],K=0;K<=n;K++){var Q=K/n,te,ee,ne,ae,le,_e,Ie,Ge;ne=3*(ie[1][0]-ie[0][0]),ee=3*(ie[2][0]-ie[1][0])-ne,te=ie[3][0]-ie[0][0]-ne-ee,_e=3*(ie[1][1]-ie[0][1]),le=3*(ie[2][1]-ie[1][1])-_e,ae=ie[3][1]-ie[0][1]-_e-le,Ie=Q*Q,Ge=Ie*Q;var Re=te*Ge+ee*Ie+ne*Q+ie[0][0],Me=ae*Ge+le*Ie+_e*Q+ie[0][1];u[c]=Re,u[c+1]=Me,u[c+2]=1,c+=3}},h.quadraticCurveTo=function(G,F,V,$){if(!(c<3))for(var X=u[c-3],J=u[c-2],j=0;j<=n;j++){var ie=j/n,K=1-ie,Q=X*K+G*ie,te=J*K+F*ie,ee=G*K+V*ie,ne=F*K+$*ie;u[c]=Q*K+ee*ie,u[c+1]=te*K+ne*ie,u[c+2]=1,c+=3}},h.fill=function(){if(!(c<9)){f.uploadRange(0,c*4),E.u_viewport=Z;var G=C;this._shadowcolor[3]>0&&(E.u_color=this._shadowcolor,this.save(),this.translate(this.shadowOffsetX,this.shadowOffsetY),G.uniforms(E).drawRange(p,r.TRIANGLE_FAN,0,c/3),this.restore()),E.u_color=this._fillcolor,E.u_transform=this._matrix;var F=this._fillStyle;if(F.constructor===ue){var V=F,$=V.toTexture();E.u_color=[1,1,1,this.globalAlpha],E.u_gradient=V.points,E.u_texture=0,E.u_itransform=invert$2(U,this._matrix),$.bind(0),G=k}else if(F.constructor===GL$1.Texture){var $=F;E.u_color=[1,1,1,this._globalAlpha],E.u_texture=0,z.set([0,0,1/$.width,1/$.height]),E.u_texture_transform=z,E.u_itransform=invert$2(U,this._matrix),$.bind(0),G=N}G.uniforms(E).drawRange(p,r.TRIANGLE_FAN,0,c/3),m[14]-=.001}},h.strokeThin=function(){c<6||(f.uploadRange(0,c*4),r.setLineWidth(this.lineWidth),E.u_color=this._strokecolor,E.u_transform=this._matrix,E.u_viewport=Z,C.uniforms(E).drawRange(p,r.LINE_STRIP,0,c/3))};var he=new Float32Array(a*3),se=new GL$1.Mesh,ve=se.createVertexBuffer("vertices",null,null,he,r.STREAM_DRAW);h.stroke=function(){if(!(c<6)){if(W[0]=this._matrix[0],W[1]=this._matrix[1],this.lineWidth*length(W)<=1)return this.strokeThin();var G=he,F=c,V=this.lineWidth*.5,$=u,X=0,J=0,j=0,ie=0,K=0,Q=0,te=0,ee=0;if($[0]==$[c-3]&&$[1]==$[c-2]){X=$[c-3]-$[c-6],J=$[c-2]-$[c-5];var ne=Math.sqrt(X*X+J*J);ne!=0&&(X=X/ne,J=J/ne)}var ae,le=0;for(ae=0;ae<F-3;ae+=3){j=X,ie=J,X=$[ae+3]-$[ae],J=$[ae+4]-$[ae+1];var ne=Math.sqrt(X*X+J*J);ne!=0&&(X=X/ne,J=J/ne),ae==0&&(te=X,ee=J),K=X+j,Q=J+ie;var ne=Math.sqrt(K*K+Q*Q);ne!=0&&(K=K/ne,Q=Q/ne),G[le+0]=$[ae]-Q*V,G[le+1]=$[ae+1]+K*V,G[le+2]=1,G[le+3]=$[ae]+Q*V,G[le+4]=$[ae+1]-K*V,G[le+5]=1,le+=6}if($[0]==$[c-3]&&$[1]==$[c-2]){K=X+te,Q=J+ee;var ne=Math.sqrt(K*K+Q*Q);ne!=0&&(K=K/ne,Q=Q/ne),G[le+0]=$[ae]-Q*V,G[le+1]=$[ae+1]+K*V,G[le+2]=1,G[le+3]=$[ae]+Q*V,G[le+4]=$[ae+1]-K*V,G[le+5]=1}else{var ne=Math.sqrt(X*X+J*J);ne!=0&&(K=X/ne,Q=J/ne),G[le+0]=$[ae]-(Q-K)*V,G[le+1]=$[ae+1]+(K+Q)*V,G[le+2]=1,G[le+3]=$[ae]+(Q+K)*V,G[le+4]=$[ae+1]-(K-Q)*V,G[le+5]=1}le+=6,ve.upload(r.STREAM_DRAW),ve.uploadRange(0,le*4),E.u_transform=this._matrix,E.u_viewport=Z,this._shadowcolor[3]>0&&(E.u_color=this._shadowcolor,this.save(),this.translate(this.shadowOffsetX,this.shadowOffsetY),C.uniforms(E).drawRange(p,r.TRIANGLE_STRIP,0,le/3),this.restore()),E.u_color=this._strokecolor,C.uniforms(E).drawRange(se,r.TRIANGLE_STRIP,0,le/3),m[14]-=.001}},h.rect=function(G,F,V,$){u[c]=G,u[c+1]=F,u[c+2]=1,u[c+3]=G+V,u[c+4]=F,u[c+5]=1,u[c+6]=G+V,u[c+7]=F+$,u[c+8]=1,u[c+9]=G,u[c+10]=F+$,u[c+11]=1,u[c+12]=G,u[c+13]=F,u[c+14]=1,c+=15},h.roundRect=function(G,F,V,$,X,J){var j=0,ie=0,K=0,Q=0;if(X===0){this.rect(G,F,V,$);return}if(J===void 0&&(J=X),X!=null&&X.constructor===Array)if(X.length==1)j=ie=K=Q=X[0];else if(X.length==2)j=Q=X[0],ie=K=X[1];else if(X.length==4)j=X[0],ie=X[1],K=X[2],Q=X[3];else return;else j=X||0,ie=X||0,K=J||0,Q=J||0;var te=u,ee=c;if(j>0)for(var ne=0;ne<10;++ne){var ae=ne/10*Math.PI*.5;te[ee]=G+j*(1-Math.cos(ae)),te[ee+1]=F+j*(1-Math.sin(ae)),te[ee+2]=1,ee+=3}if(te[ee+0]=G+j,te[ee+1]=F,te[ee+2]=1,te[ee+3]=G+V-ie,te[ee+4]=F,te[ee+5]=1,ee+=6,ie>0)for(var ne=0;ne<10;++ne){var ae=ne/10*Math.PI*.5;te[ee+0]=G+V-ie*(1-Math.sin(ae)),te[ee+1]=F+ie*(1-Math.cos(ae)),te[ee+2]=1,ee+=3}if(te[ee+0]=G+V,te[ee+1]=F+ie,te[ee+2]=1,te[ee+3]=G+V,te[ee+4]=F+$-Q,te[ee+5]=1,ee+=6,Q>0)for(var ne=0;ne<10;++ne){var ae=ne/10*Math.PI*.5;te[ee+0]=G+V-Q*(1-Math.cos(ae)),te[ee+1]=F+$-Q*(1-Math.sin(ae)),te[ee+2]=1,ee+=3}if(te[ee+0]=G+V-Q,te[ee+1]=F+$,te[ee+2]=1,te[ee+3]=G+K,te[ee+4]=F+$,te[ee+5]=1,ee+=6,K>0)for(var ne=0;ne<10;++ne){var ae=ne/10*Math.PI*.5;te[ee+0]=G+K*(1-Math.sin(ae)),te[ee+1]=F+$-K*(1-Math.cos(ae)),te[ee+2]=1,ee+=3}te[ee+0]=G,te[ee+1]=F+j,te[ee+2]=1,c=ee+3},h.arc=function(G,F,V,$,X){var J=Math.max(Math.abs(this._matrix[0]),Math.abs(this._matrix[1]),Math.abs(this._matrix[3]),Math.abs(this._matrix[4])),j=Math.ceil(V*2*J+1);if(!(j<1)){j=Math.min(j,1024),$=$===void 0?0:$,X=X===void 0?Math.PI*2:X;for(var ie=(X-$)/j,K=0;K<=j;K++){var Q=$+K*ie;this.lineTo(G+Math.cos(Q)*V,F+Math.sin(Q)*V)}}},h.strokeRect=function(G,F,V,$){this.beginPath(),this.rect(G,F,V,$),this.stroke()},h.fillRect=function(G,F,V,$){if(c=0,this._fillStyle.constructor==GL$1.Texture||this._fillStyle.constructor===ue){this.beginPath(),this.rect(G,F,V,$),this.fill();return}E.u_color=this._fillcolor,W[0]=G,W[1]=F,Y[0]=V,Y[1]=$,E.u_position=W,E.u_size=Y,E.u_transform=this._matrix,E.u_viewport=Z,A.uniforms(E).draw(d),m[14]-=.001},h.clearRect=function(G,F,V,$){(G!=0||F!=0||V!=e.width||$!=e.height)&&(r.enable(r.SCISSOR_TEST),r.scissor(G,F,V,$)),r.clear(r.COLOR_BUFFER_BIT);var X=r.viewport_data;r.scissor(X[0],X[1],X[2],X[3]),r.disable(r.SCISSOR_TEST)},h.fillCircle=function(G,F,V){if(c=0,this._fillStyle.constructor==GL$1.Texture||this._fillStyle.constructor===ue){this.beginPath(),this.arc(G,F,V,0,Math.PI*2),this.fill();return}E.u_color=this._fillcolor,W[0]=G,W[1]=F,Y[0]=V,Y[1]=V,E.u_position=W,E.u_size=Y,E.u_transform=this._matrix,E.u_viewport=Z,A.uniforms(E).draw(g),m[14]-=.001},h.start2D=function(){l=window.gl,window.gl=this;var G=this;G.disable(G.CULL_FACE),G.disable(G.DEPTH_TEST),G.disable(G.STENCIL_TEST),G.enable(G.BLEND),G.blendFunc(G.SRC_ALPHA,G.ONE_MINUS_SRC_ALPHA),G.blendEquation(G.FUNC_ADD),G.lineWidth=1,c=0,identity$1(m),this.clip_level=0},h.finish2D=function(){c=0,r.lineWidth=1,window.gl=l,r.disable(r.STENCIL_TEST)};var fe=new Float32Array(o*3),me=new Float32Array(o*2),Ae=new GL$1.Mesh,ze=Ae.createVertexBuffer("vertices",null,null,fe,r.STREAM_DRAW),ge=Ae.createVertexBuffer("coords",null,null,me,r.STREAM_DRAW);h.fillText=h.strokeText=function(G,F,V){if(G==null)return;G.constructor!==String&&(G=String(G));let $=0;const{textures:X,info:J}=ce.call(this,this._font_family,this._font_mode),j=fe,ie=me;let K=this._font_size*1.1;K<1&&(K=1);let Q=0,te=0;const ee=G.length,ne=J.spacing,ae=J.kernings;let le=!0,_e=0,Ie=0,Ge=-1;function Re(){if(_e===0||Ie===0||Ge===-1)return;ze.uploadRange(0,_e*4),ge.uploadRange(0,Ie*4),E.u_color=this._fillcolor,E.u_pointSize=K*length(this._matrix),E.u_iCharSize=J.char_size/$,E.u_transform=this._matrix,E.u_viewport=Z,E.u_angle_sincos||(E.u_angle_sincos=create());const re=H;H=0,E.u_angle_sincos[1]=Math.sin(-H),E.u_angle_sincos[0]=-Math.cos(-H),H=re,B.uniforms(E).drawRange(Ae,r.POINTS,0,_e/3),_e=0,Ie=0}for(let re=0;re<ee;re++){const we=G.charCodeAt(re),ye=J.pages[we];if(!ye){we===10?(Q=0,te+=K,le=!0):Q+=K*.5;continue}const[Se,Pe,Oe,Ve]=ye;if(Oe!==Ge)if(Re.call(this),Ge=Oe,X[Oe])X[Oe].bind(0),$=X[Oe].width;else{console.error(`Page ${Oe} not found in textures.`);continue}const ke=ae[G[re]];le&&(Q-=K*((ke==null?void 0:ke.nwidth)||0)*.25,le=!1),j[_e+0]=F+Q+K*.5,j[_e+1]=V+te-K*.25,j[_e+2]=1,_e+=3,ie[Ie+0]=Se,ie[Ie+1]=Pe,Ie+=2;const Be=ae[G[re+1]]?ae[G[re+1]].nwidth:ne/J.char_size;Q+=K*Be}Re.call(this);let Me=0;if(this.textAlign==="right"?Me=Q+K*.5:this.textAlign==="center"&&(Me=(Q+K*.5)*.5),Me)for(let re=0;re<_e;re+=3)j[re]-=Me;return{x:Q,y:te}},h.measureText=function(G){const{info:F}=ce.call(this,this._font_family,this._font_mode),V=Math.ceil(this._font_size*(F.line_height||1));let $=0;const X=V*(F.spacing/F.char_size);for(let J=0;J<G.length;++J){const j=F.kernings[G[J]];j?$+=j.nwidth:$+=X}return $*=V,{width:$,height:V}},h.cacheFontAtlas=function(G="monospace",F="normal",V=!1){const $=`:font_${G}:${F}:${enableWebGLCanvas.useInternationalFont}`;if(!V&&T[$])return T[$];const X=ce.call(this,G,F,V);return T[$]=X,X},h.loadCachedTextures=async function(){const G=await getAllData();if(G&&(G==null?void 0:G.length)>0)for(let F in G){const V=G[F];T[V.name]=V}};function ce(G="monospace",F="normal",V=!1){const $=`:font_${G}:${F}:${enableWebGLCanvas.useInternationalFont}`;if(!V&&T[$])return T[$];const X=enableWebGLCanvas.useInternationalFont;let J=1024,j=10,ie=200;X&&(ie=55203,j=20,J=2048);const K=this.imageSmoothingEnabled,Q=Math.floor(J/j),te=Math.floor(Q*.95);let ee=.5,ne=te*-.15;const ae=[],le={font_size:te,char_size:Q,spacing:Q*.6,space:null,kernings:{},pages:[]},_e=re=>re>=32&&re<=47||re>=58&&re<=64||re>=91&&re<=96||re>=123&&re<=126,Ie=re=>re>=65&&re<=90||re>=97&&re<=122||re>=48&&re<=57||re>=32&&re<=47||re>=58&&re<=64||re>=91&&re<=96||re>=123&&re<=126||re>=44032&&re<=55203||re>=127744&&re<=128767,Ge=[];for(let re=32;re<=ie;re++)Ie(re)&&Ge.push(re);const Re=Math.ceil(Ge.length/(j*j));for(let re=0;re<Re;re++){const we=createCanvas(J,J),ye=we.getContext("2d");ye.fillStyle="white",ye.imageSmoothingEnabled=K,ye.clearRect(0,0,we.width,we.height),ye.font=`${F} ${te}px ${G}`,ye.textAlign="center";let Se=0,Pe=0;const Oe=re*j*j,Ve=Math.min(Ge.length,Oe+j*j);for(let Be=Oe;Be<Ve;Be++){const He=Ge[Be],$e=String.fromCharCode(He);let Ue=ye.measureText($e).width;_e(He)&&Ue<50&&(Ue*=1.8),le.kernings[$e]={width:Ue,nwidth:Ue/te},le.pages[He]=[(Se+Q*.5)/we.width,(Pe+Q*.5)/we.height,re,$e],ye.save(),ye.beginPath(),ye.rect(Math.floor(Se)+.5,Math.floor(Pe)+.5,Q-2,Q-2),ye.clip(),ye.fillText($e,Math.floor(Se+Q*ee),Math.floor(Pe+Q+ne),Q),ye.restore(),Se+=Q,Se+Q>we.width&&(Se=0,Pe+=Q)}const ke=GL$1.Texture.fromImage(we,{format:r.RGBA,magFilter:r.LINEAR,minFilter:r.LINEAR_MIPMAP_LINEAR,premultiply_alpha:!1,anisotropic:1});ae.push(ke)}le.space=le.kernings[" "]?le.kernings[" "].width/te:0;const Me={textures:ae,info:le,name:$};return T[$]=Me,saveComplexData(Me,1),T[$]}h.getImageData=function(G,F,V,$){var X=new Uint8Array(V*$*4);return r.readPixels(G,F,V,$,r.RGBA,r.UNSIGNED_BYTE,X),{data:X,width:V,height:$,resolution:1}},h.putImageData=function(G,F,V){var $=new GL$1.Texture(G.width,G.height,{filter:r.NEAREST,pixel_data:G.data});$.renderQuad(F,V,$.width,$.height)},Object.defineProperty(r,"fillStyle",{get:function(){return this._fillStyle},set:function(G){G&&(this._fillStyle=G,hexColorToRGBA(G,this._fillcolor,this._globalAlpha))}}),Object.defineProperty(r,"strokeStyle",{get:function(){return this._strokeStyle},set:function(G){G&&(this._strokeStyle=G,hexColorToRGBA(G,this._strokecolor,this._globalAlpha))}}),Object.defineProperty(r,"fillColor",{get:function(){return this._fillcolor},set:function(G){G&&(G.length<5?this._fillcolor.set(G):console.error("fillColor value has more than 4 components"))}}),Object.defineProperty(r,"strokeColor",{get:function(){return this._strokecolor},set:function(G){G&&(G.length<5?this._strokecolor.set(G):console.error("strokeColor value has more than 4 components"))}}),Object.defineProperty(r,"shadowColor",{get:function(){return this._shadowcolor},set:function(G){G&&hexColorToRGBA(G,this._shadowcolor,this._globalAlpha)}}),Object.defineProperty(r,"globalAlpha",{get:function(){return this._globalAlpha},set:function(G){this._globalAlpha=G,this._strokecolor[3]=this._fillcolor[3]=G}}),Object.defineProperty(r,"globalCompositeOperation",{get:function(){return this._globalCompositeOperation},set:function(G){switch(this._globalCompositeOperation=G,r.blendEquation(r.FUNC_ADD),G){case"source-over":r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);break;case"difference":r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.blendEquation(r.FUNC_REVERSE_SUBTRACT);break}}}),Object.defineProperty(r,"font",{get:function(){return this._font},set:function(G){this._font=G;var F=G.split(" ");F.length>=3?(this._font_mode=F[0],this._font_size=parseFloat(F[1]),Number.isNaN(this._font_size)&&(this._font_size=14),this._font_size<5&&(this._font_size=5),this._font_family=F[2]):F.length==2?(this._font_mode="normal",this._font_size=parseFloat(F[0]),Number.isNaN(this._font_size)&&(this._font_size=14),this._font_size<5&&(this._font_size=5),this._font_family=F[1]):(this._font_mode="normal",this._font_family=F[0])}}),h._fillcolor=fromValues$2(0,0,0,1),h._strokecolor=fromValues$2(0,0,0,1),h._shadowcolor=fromValues$2(0,0,0,0),h._globalAlpha=1,h._font="14px monospace",h._font_family="monospace",h._font_size="14px",h._font_mode="normal",h.clip_level=0,h.strokeStyle="rgba(0,0,0,1)",h.fillStyle="rgba(0,0,0,1)",h.shadowColor="transparent",h.shadowOffsetX=h.shadowOffsetY=0,h.globalAlpha=1,h.globalCompositeOperation="source-over",h.setLineWidth=h.lineWidth,h.lineWidth=4,h.imageSmoothingEnabled=!0,h.tintImages=!1;var Ee=["arcTo","isPointInPath","createImageData"],Te=function(){};for(var Le in Ee)h[Ee[Le]]=Te;return h}function openDatabase(){return new Promise((e,t)=>{const r=indexedDB.open("WebglContextDB",2);r.onupgradeneeded=function(s){var a;const n=s.target.result;(a=n.objectStoreNames)!=null&&a.contains("fontTexture")||n.createObjectStore("fontTexture",{keyPath:"name"})},r.onsuccess=function(s){e(s.target.result)},r.onerror=function(s){t(s.target.error)}})}async function makeTexture(e){const t=base64ToBlob(e.data),r=await blobToImage(t),s=GL$1.Texture.fromImage(r);return s.wrapS=e.wrapS||s.gl.CLAMP_TO_EDGE,s.wrapT=e.wrapT||s.gl.CLAMP_TO_EDGE,s.minFilter=e.minFilter||s.gl.LINEAR,s.magFilter=e.magFilter||s.gl.LINEAR,s.format=e.format||s.format,s.internalFormat=e.internalFormat||s.internalFormat,s.type=e.type||s.type,s.texture_type=e.texture_type||s.texture_type,s.width=e.width||s.width,s.height=e.height||s.height,e=s,e}function base64ToBlob(e){const t=atob(e.split(",")[1]),r=e.split(",")[0].split(":")[1].split(";")[0],s=new Array(t.length);for(let a=0;a<t.length;a++)s[a]=t.charCodeAt(a);const n=new Uint8Array(s);return new Blob([n],{type:r})}function blobToImage(e){return new Promise((t,r)=>{const s=new Image;s.onload=()=>t(s),s.onerror=r,s.src=URL.createObjectURL(e)})}function textureToBase64(e){const t=e.gl,r=e.handler,s=e.width,n=e.height,a=t.createFramebuffer();if(t.bindFramebuffer(t.FRAMEBUFFER,a),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE)return console.error("Framebuffer is not complete."),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(a),null;const o=new Uint8Array(s*n*4),l=e.format||t.RGBA,h=e.type||t.UNSIGNED_BYTE;try{t.readPixels(0,0,s,n,l,h,o)}catch(d){return console.error("Error reading pixels from framebuffer:",d),null}const c=document.createElement("canvas");c.width=s,c.height=n;const u=c.getContext("2d"),p=u.createImageData(s,n);for(let d=0;d<n;d++){const g=d*s*4,m=(n-d-1)*s*4;p.data.set(o.subarray(g,g+s*4),m)}u.putImageData(p,0,0);const f=c.toDataURL("image/png");return t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(a),f}async function saveComplexData(e,t=1){var r;try{const a=(await openDatabase()).transaction("fontTexture","readwrite").objectStore("fontTexture"),l=(r=e.textures)==null?void 0:r.map(p=>{const{width:f,height:d,format:g,internalFormat:m,type:b,wrapS:E,wrapT:L,minFilter:T,magFilter:_,has_mipmaps:I,texture_type:A}=p,M=textureToBase64(p);return{width:f,height:d,format:g,internalFormat:m,type:b,wrapS:E,wrapT:L,minFilter:T,magFilter:_,has_mipmaps:I,texture_type:A,data:M}}),h=new Date;h.setDate(h.getDate()+t);const c={info:e.info,textures:l,name:e.name,expiresAt:h.toISOString()},u=a.put(c);u.onsuccess=function(){},u.onerror=function(p){console.error("Error saving data:",p)}}catch(s){console.error("Error in saveComplexData:",s)}}async function getAllData(){const e=await openDatabase();return new Promise((t,r)=>{const n=e.transaction("fontTexture","readwrite").objectStore("fontTexture"),a=n.getAll();a.onsuccess=async function(o){const h=o.target.result.filter(c=>{const u=new Date,p=new Date(c.expiresAt);return u<p?!0:(n.delete(c.name),!1)});if((h==null?void 0:h.length)===0){t([]);return}for(const c of h)c.textures=await Promise.all(c.textures.map(async u=>makeTexture(u)));t(h)},a.onerror=function(o){console.error("Error retrieving data:",o.target.error),r(o.target.error)}})}enableWebGLCanvas.useInternationalFont=!0,enableWebGLCanvas.fontOffsetY=0;const D=class D{constructor(){}static distance(t,r){return Math.sqrt((r[0]-t[0])*(r[0]-t[0])+(r[1]-t[1])*(r[1]-t[1]))}static isInsideRectangle(t,r,s,n,a,o){return s<t&&s+a>t&&n<r&&n+o>r}static closeAllContextMenus(t){t=t||window;let r=t.document.querySelectorAll(".litecontextmenu");if(!r.length)return;let s=[];for(let n=0;n<r.length;n++)s.push(r[n]);for(let n=0;n<s.length;n++)s[n].close?s[n].close():s[n].parentNode&&s[n].parentNode.removeChild(s[n])}static extendClass(t,r){var s,n,a,o;for(const l in r)Object.prototype.hasOwnProperty.call(t,l)||(t[l]=r[l]);if(r.prototype)for(const l in r.prototype){if(!Object.prototype.hasOwnProperty.call(r.prototype,l)||Object.prototype.hasOwnProperty.call(t.prototype,l))continue;const h=(n=(s=r.prototype).__lookupGetter__)==null?void 0:n.call(s,l),c=(o=(a=r.prototype).__lookupSetter__)==null?void 0:o.call(a,l);h?t.prototype.__defineGetter__(l,h):t.prototype[l]=r.prototype[l],c&&t.prototype.__defineSetter__(l,c)}}static getParameterNames(t){return(t+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)}static pointerListenerAdd(t,r,s,n=!1){if(!t||!t.addEventListener||!r||typeof s!="function")return;let a=D.pointerevents_method,o=r;if(a==="pointer"&&!window.PointerEvent){console.warn("PointerEvent not supported. Converting to touch event.");const h={down:"start",move:"move",up:"end",cancel:"cancel"};h[o]?(a="touch",o=h[o]):o==="enter"?console.log("debug: Should I send a move event?"):console.warn(`Event ${o} will not be called`)}if(["down","up","move","over","out","enter","leave","cancel","gotpointercapture","lostpointercapture"].includes(o)&&(a!=="mouse"||["down","up","move","over","out","enter"].includes(o))){t.addEventListener(a+o,s,n);return}t.addEventListener(o,s,n)}static pointerListenerRemove(t,r,s,n=!1){if(!t||!t.removeEventListener||!r||typeof s!="function")return;const a=D.pointerevents_method,o=["down","up","move","over","out","enter"],l=["leave","cancel","gotpointercapture","lostpointercapture"];if(o.includes(r)&&(a==="pointer"||a==="mouse")){t.removeEventListener(a+r,s,n);return}if(l.includes(r)&&a==="pointer"){t.removeEventListener(a+r,s,n);return}t.removeEventListener(r,s,n)}static overlapBounding(t,r){let s=t[0]+t[2],n=t[1]+t[3],a=r[0]+r[2],o=r[1]+r[3];return!(t[0]>a||t[1]>o||s<r[0]||n<r[1])}static registerNodeType(t,r){if(!r.prototype)throw"Cannot register a simple object, it must be a class with a prototype";r.type=t,D.debug&&console.log("Node registered: "+t);const s=r.name,n=t.lastIndexOf("/");r.category=t.substring(0,n),r.title||(r.title=s);for(let o in LGraphNode.prototype)r.prototype[o]||(r.prototype[o]=LGraphNode.prototype[o]);const a=D.registered_node_types[t];if(a&&console.log("replacing node type: "+t),!Object.prototype.hasOwnProperty.call(r.prototype,"shape")&&(Object.defineProperty(r.prototype,"shape",{set:function(o){switch(o){case"default":delete this._shape;break;case"box":this._shape=D.BOX_SHAPE;break;case"round":this._shape=D.ROUND_SHAPE;break;case"circle":this._shape=D.CIRCLE_SHAPE;break;case"card":this._shape=D.CARD_SHAPE;break;default:this._shape=o}},get:function(){return this._shape},enumerable:!0,configurable:!0}),r.supported_extensions))for(let o in r.supported_extensions){const l=r.supported_extensions[o];l&&l.constructor===String&&(this.node_types_by_file_extension[l.toLowerCase()]=r)}D.registered_node_types[t]=r,r.constructor.name&&(this.Nodes[s]=r),D.onNodeTypeRegistered&&D.onNodeTypeRegistered(t,r),a&&D.onNodeTypeReplaced&&D.onNodeTypeReplaced(t,r,a),r.prototype.onPropertyChange&&console.warn("LiteGraph node class "+t+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),this.auto_load_slot_types&&new r(r.title||"tmpnode")}static unregisterNodeType(t){const r=t.constructor===String?D.registered_node_types[t]:t;if(!r)throw"node type not found: "+t;delete D.registered_node_types[r.type],r.constructor.name&&delete this.Nodes[r.constructor.name]}static registerNodeAndSlotType(t,r,s){s=s||!1;const a=(t.constructor===String&&D.registered_node_types[t]!=="anonymous"?D.registered_node_types[t]:t).constructor.type;let o=[];typeof r=="string"?o=r.split(","):r==this.EVENT||r==this.ACTION?o=["_event_"]:o=["*"];for(let l=0;l<o.length;++l){let h=o[l];h===""&&(h="*");const c=s?"registered_slot_out_types":"registered_slot_in_types";this[c][h]===void 0&&(this[c][h]={nodes:[]}),this[c][h].nodes.includes(a)||this[c][h].nodes.push(a),s?this.slot_types_out.includes(h.toLowerCase())||(this.slot_types_out.push(h.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(h.toLowerCase())||(this.slot_types_in.push(h.toLowerCase()),this.slot_types_in.sort())}}static buildNodeClassFromObject(t,r){let s="";if(r.inputs)for(let a=0;a<r.inputs.length;++a){let o=r.inputs[a][0],l=r.inputs[a][1];l&&l.constructor===String&&(l='"'+l+'"'),s+="this.addInput('"+o+"',"+l+`);
`}if(r.outputs)for(let a=0;a<r.outputs.length;++a){let o=r.outputs[a][0],l=r.outputs[a][1];l&&l.constructor===String&&(l='"'+l+'"'),s+="this.addOutput('"+o+"',"+l+`);
`}if(r.properties)for(let a in r.properties){let o=r.properties[a];o&&o.constructor===String&&(o='"'+o+'"'),s+="this.addProperty('"+a+"',"+o+`);
`}s+="if(this.onCreate)this.onCreate()";let n=Function(s);for(let a in r)a!="inputs"&&a!="outputs"&&a!="properties"&&(n.prototype[a]=r[a]);return n.title=r.title||t.split("/").pop(),n.desc=r.desc||"Generated from object",D.registerNodeType(t,n),n}static wrapFunctionAsNode(t,r,s,n,a){let o=Array(r.length),l="";if(s!==null){let c=D.getParameterNames(r);for(let u=0;u<c.length;++u){let p=0;s&&(s[u]!=null&&s[u].constructor===String?p="'"+s[u]+"'":s[u]!=null&&(p=s[u])),l+="this.addInput('"+c[u]+"',"+p+`);
`}}n!==null&&(l+="this.addOutput('out',"+(n!=null?n.constructor===String?"'"+n+"'":n:0)+`);
`),a&&(l+="this.properties = "+JSON.stringify(a)+`;
`);let h=Function(l);return h.title=t.split("/").pop(),h.desc="Generated from "+r.name,h.prototype.onExecute=function(){for(let p=0;p<o.length;++p)o[p]=this.getInputData(p);let u=r.apply(this,o);this.setOutputData(0,u)},this.registerNodeType(t,h),h}static clearRegisteredTypes(){D.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}static addNodeMethod(t,r){LGraphNode.prototype[t]=r;for(let s in D.registered_node_types){let n=D.registered_node_types[s];n.prototype[t]&&(n.prototype["_"+t]=n.prototype[t]),n.prototype[t]=r}}static createNode(t,r,s){let n=D.registered_node_types[t];if(!n)return D.debug&&console.log('GraphNode type "'+t+'" not registered.'),null;n.prototype,r=r||n.title||t;let a=null;if(D.catch_exceptions)try{a=new n(r)}catch(o){return console.error(o),null}else a=new n(r);if(a.type=t,!a.title&&r&&(a.title=r),a.properties||(a.properties={}),a.properties_info||(a.properties_info=[]),a.flags||(a.flags={}),a.size||(a.size=a.computeSize()),a.pos||(a.pos=D.DEFAULT_POSITION.concat()),a.mode||(a.mode=D.ALWAYS),s)for(let o in s)a[o]=s[o];return a.onNodeCreated&&a.onNodeCreated(),a}static getNodeType(t){return D.registered_node_types[t]}static getNodeTypesInCategory(t,r){let s=[];for(let n in D.registered_node_types){let a=D.registered_node_types[n];a.filter==r&&(t==""?a.category==null&&s.push(a):a.category==t&&s.push(a))}return this.auto_sort_node_types&&s.sort(function(n,a){return n.title.localeCompare(a.title)}),s}static getNodeTypesCategories(t){let r={"":1};for(let n in D.registered_node_types){let a=D.registered_node_types[n];if(a.category&&!a.skip_list){if(a.filter!=t)continue;r[a.category]=1}}let s=[];for(let n in r)s.push(n);return this.auto_sort_node_types?s.sort():s}static reloadNodes(t){let r=document.getElementsByTagName("script"),s=[];for(let a=0;a<r.length;a++)s.push(r[a]);let n=document.getElementsByTagName("head")[0];t=document.location.href+t;for(let a=0;a<s.length;a++){let o=s[a].src;if(!(!o||o.substr(0,t.length)!=t))try{D.debug&&console.log("Reloading: "+o);let l=document.createElement("script");l.type="text/javascript",l.src=o,n.appendChild(l),n.removeChild(s[a])}catch(l){if(D.throw_errors)throw l;D.debug&&console.log("Error while reloading "+o)}}D.debug&&console.log("Nodes reloaded")}static cloneObject(t,r){if(t==null)return null;let s=JSON.parse(JSON.stringify(t));if(!r)return s;for(let n in s)r[n]=s[n];return r}static uuidv4(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,t=>(t^Math.random()*16>>t/4).toString(16))}static isValidConnection(t,r){if((t==""||t==="*")&&(t=0),(r==""||r==="*")&&(r=0),!t||!r||t==r||t==D.EVENT&&r==D.ACTION)return!0;if(t=String(t),r=String(r),t=t.toLowerCase(),r=r.toLowerCase(),t.indexOf(",")==-1&&r.indexOf(",")==-1)return t==r;let s=t.split(","),n=r.split(",");for(let a=0;a<s.length;++a)for(let o=0;o<n.length;++o)if(this.isValidConnection(s[a],n[o]))return!0;return!1}static registerSearchboxExtra(t,r,s){this.searchbox_extras[r.toLowerCase()]={type:t,desc:r,data:s}}static fetchFile(t,r,s,n){if(!t)return null;if(r=r||"text",t.constructor===String)return t.substr(0,4)=="http"&&D.proxy&&(t=D.proxy+t.substr(t.indexOf(":")+3)),fetch(t).then(function(a){if(!a.ok)throw new Error("File not found");if(r=="arraybuffer")return a.arrayBuffer();if(r=="text"||r=="string")return a.text();if(r=="json")return a.json();if(r=="blob")return a.blob()}).then(function(a){s&&s(a)}).catch(function(a){console.error("error fetching file:",t),n&&n(a)});if(t.constructor===File||t.constructor===Blob){let a=new FileReader;if(a.onload=function(o){let l=o.target.result;r=="json"&&(l=JSON.parse(l)),s&&s(l)},r=="arraybuffer")return a.readAsArrayBuffer(t);if(r=="text"||r=="json")return a.readAsText(t);if(r=="blob")return a.readAsBinaryString(t)}return null}};R(D,"VERSION",.4),R(D,"CANVAS_GRID_SIZE",10),R(D,"NODE_TITLE_HEIGHT",30),R(D,"NODE_TITLE_TEXT_Y",20),R(D,"NODE_SLOT_HEIGHT",20),R(D,"NODE_WIDGET_HEIGHT",20),R(D,"NODE_WIDTH",140),R(D,"NODE_MIN_WIDTH",50),R(D,"NODE_COLLAPSED_RADIUS",10),R(D,"NODE_COLLAPSED_WIDTH",80),R(D,"NODE_TITLE_COLOR","#999"),R(D,"NODE_SELECTED_TITLE_COLOR","#FFF"),R(D,"NODE_TEXT_SIZE",14),R(D,"NODE_TEXT_COLOR","#AAA"),R(D,"NODE_SUBTEXT_SIZE",12),R(D,"NODE_DEFAULT_COLOR","#333"),R(D,"NODE_DEFAULT_BGCOLOR","#353535"),R(D,"NODE_DEFAULT_BOXCOLOR","#666"),R(D,"NODE_DEFAULT_SHAPE","box"),R(D,"NODE_BOX_OUTLINE_COLOR","#FFF"),R(D,"DEFAULT_SHADOW_COLOR","rgba(0,0,0,0.5)"),R(D,"DEFAULT_GROUP_FONT",24),R(D,"WIDGET_BGCOLOR","#222"),R(D,"WIDGET_OUTLINE_COLOR","#666"),R(D,"WIDGET_TEXT_COLOR","#DDD"),R(D,"WIDGET_SECONDARY_TEXT_COLOR","#999"),R(D,"LINK_COLOR","#9A9"),R(D,"EVENT_LINK_COLOR","#A86"),R(D,"CONNECTING_LINK_COLOR","#AFA"),R(D,"MAX_NUMBER_OF_NODES",1e3),R(D,"DEFAULT_POSITION",[100,100]),R(D,"VALID_SHAPES",["default","box","round","card"]),R(D,"BOX_SHAPE",1),R(D,"ROUND_SHAPE",2),R(D,"CIRCLE_SHAPE",3),R(D,"CARD_SHAPE",4),R(D,"ARROW_SHAPE",5),R(D,"GRID_SHAPE",6),R(D,"INPUT",1),R(D,"OUTPUT",2),R(D,"EVENT",-1),R(D,"ACTION",-1),R(D,"NODE_MODES",["Always","On Event","Never","On Trigger"]),R(D,"NODE_MODES_COLORS",["#666","#422","#333","#224","#626"]),R(D,"ALWAYS",0),R(D,"ON_EVENT",1),R(D,"NEVER",2),R(D,"ON_TRIGGER",3),R(D,"UP",1),R(D,"DOWN",2),R(D,"LEFT",3),R(D,"RIGHT",4),R(D,"CENTER",5),R(D,"LINK_RENDER_MODES",["Straight","Linear","Spline"]),R(D,"STRAIGHT_LINK",0),R(D,"LINEAR_LINK",1),R(D,"SPLINE_LINK",2),R(D,"NORMAL_TITLE",0),R(D,"NO_TITLE",1),R(D,"TRANSPARENT_TITLE",2),R(D,"AUTOHIDE_TITLE",3),R(D,"VERTICAL_LAYOUT","vertical"),R(D,"proxy",null),R(D,"node_images_path",""),R(D,"debug",!1),R(D,"catch_exceptions",!0),R(D,"throw_errors",!0),R(D,"allow_scripts",!1),R(D,"use_deferred_actions",!0),R(D,"registered_node_types",{}),R(D,"node_types_by_file_extension",{}),R(D,"Nodes",{}),R(D,"Globals",{}),R(D,"searchbox_extras",{}),R(D,"auto_sort_node_types",!1),R(D,"node_box_coloured_when_on",!1),R(D,"node_box_coloured_by_mode",!1),R(D,"dialog_close_on_mouse_leave",!0),R(D,"dialog_close_on_mouse_leave_delay",500),R(D,"shift_click_do_break_link_from",!1),R(D,"click_do_break_link_to",!1),R(D,"search_hide_on_mouse_leave",!0),R(D,"search_filter_enabled",!1),R(D,"search_show_all_on_open",!0),R(D,"auto_load_slot_types",!1),R(D,"registered_slot_in_types",{}),R(D,"registered_slot_out_types",{}),R(D,"slot_types_in",[]),R(D,"slot_types_out",[]),R(D,"slot_types_default_in",[]),R(D,"slot_types_default_out",[]),R(D,"alt_drag_do_clone_nodes",!1),R(D,"do_add_triggers_slots",!1),R(D,"allow_multi_output_for_events",!0),R(D,"middle_click_slot_add_default_node",!1),R(D,"release_link_on_empty_shows_menu",!1),R(D,"pointerevents_method","mouse"),R(D,"ctrl_shift_v_paste_connect_unselected_outputs",!1),R(D,"use_uuids",!1);let LiteGraph=D;typeof performance<"u"?LiteGraph.getTime=performance.now.bind(performance):typeof Date<"u"&&Date.now?LiteGraph.getTime=Date.now.bind(Date):typeof process<"u"?LiteGraph.getTime=function(){let e=process.hrtime();return e[0]*.001+e[1]*1e-6}:LiteGraph.getTime=function(){return new Date().getTime()};const pe=class pe{constructor(t){LiteGraph.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}clear(){if(this.stop(),this.status=pe.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(let t=0;t<this._nodes.length;++t){const r=this._nodes[t];r.onRemoved&&r.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.consts={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")}attachCanvas(t){if(t.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";t.graph&&t.graph!=this&&t.graph.detachCanvas(t),t.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)}detachCanvas(t){if(!this.list_of_graphcanvas)return;const r=this.list_of_graphcanvas.indexOf(t);r!=-1&&(t.graph=null,this.list_of_graphcanvas.splice(r,1))}start(t){if(this.status==pe.STATUS_RUNNING)return;this.status=pe.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,t=t||0;const r=this;if(t==0&&typeof window<"u"&&window.requestAnimationFrame){let s=function(){r.execution_timer_id==-1&&(window.requestAnimationFrame(s),r.onBeforeStep&&r.onBeforeStep(),r.runStep(1,!r.catch_errors),r.onAfterStep&&r.onAfterStep())};this.execution_timer_id=-1,s()}else this.execution_timer_id=setInterval(function(){r.onBeforeStep&&r.onBeforeStep(),r.runStep(1,!r.catch_errors),r.onAfterStep&&r.onAfterStep()},t)}stop(){this.status!=pe.STATUS_STOPPED&&(this.status=pe.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),this.execution_timer_id!=null&&(this.execution_timer_id!=-1&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}runStep(t,r,s){t=t||1;const n=LiteGraph.getTime();this.globaltime=.001*(n-this.starttime);const a=this._nodes_executable?this._nodes_executable:this._nodes;if(!a)return;if(s=s||a.length,r){for(let h=0;h<t;h++){for(let c=0;c<s;++c){const u=a[c];LiteGraph.use_deferred_actions&&u._waiting_actions&&u._waiting_actions.length&&u.executePendingActions(),u.mode==LiteGraph.ALWAYS&&u.onExecute&&u.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(let h=0;h<t;h++){for(let c=0;c<s;++c){const u=a[c];LiteGraph.use_deferred_actions&&u._waiting_actions&&u._waiting_actions.length&&u.executePendingActions(),u.mode==LiteGraph.ALWAYS&&u.onExecute&&u.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(h){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw h;LiteGraph.debug&&console.log("Error during execution: "+h),this.stop()}const o=LiteGraph.getTime();let l=o-n;l==0&&(l=1),this.execution_time=.001*l,this.globaltime+=.001*l,this.iteration+=1,this.elapsed_time=(o-this.last_update_time)*.001,this.last_update_time=o,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}updateExecutionOrder(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(let t=0;t<this._nodes_in_order.length;++t)this._nodes_in_order[t].onExecute&&this._nodes_executable.push(this._nodes_in_order[t])}computeExecutionOrder(t,r){let s=[],n=[],a={};const o={},l={};for(let c=0,u=this._nodes.length;c<u;++c){const p=this._nodes[c];if(t&&!p.onExecute)continue;a[p.id]=p;let f=0;if(p.inputs)for(let d=0,g=p.inputs.length;d<g;d++)p.inputs[d]&&p.inputs[d].link!=null&&(f+=1);f==0?(n.push(p),r&&(p._level=1)):(r&&(p._level=0),l[p.id]=f)}for(;n.length!=0;){const c=n.shift();if(s.push(c),delete a[c.id],!!c.outputs)for(let u=0;u<c.outputs.length;u++){const p=c.outputs[u];if(!(p==null||p.links==null||p.links.length==0))for(let f=0;f<p.links.length;f++){const d=p.links[f],g=this.links[d];if(!g||o[g.id])continue;const m=this.getNodeById(g.target_id);if(m==null){o[g.id]=!0;continue}r&&(!m._level||m._level<=c._level)&&(m._level=c._level+1),o[g.id]=!0,l[m.id]-=1,l[m.id]==0&&n.push(m)}}}for(const c in a)s.push(a[c]);s.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");const h=s.length;for(let c=0;c<h;++c)s[c].order=c;s=s.sort(function(c,u){const p=c.constructor.priority||c.priority||0,f=u.constructor.priority||u.priority||0;return p==f?c.order-u.order:p-f});for(let c=0;c<h;++c)s[c].order=c;return s}getAncestors(t){const r=[],s=[t],n={};for(;s.length;){const a=s.shift();if(a.inputs){!n[a.id]&&a!=t&&(n[a.id]=!0,r.push(a));for(let o=0;o<a.inputs.length;++o){const l=a.getInputNode(o);l&&r.indexOf(l)==-1&&s.push(l)}}}return r.sort(function(a,o){return a.order-o.order}),r}arrange(t,r){t=t||100;const s=this.computeExecutionOrder(!1,!0),n=[];for(let o=0;o<s.length;++o){const l=s[o],h=l._level||1;n[h]||(n[h]=[]),n[h].push(l)}let a=t;for(let o=0;o<n.length;++o){const l=n[o];if(!l)continue;let h=100,c=t+LiteGraph.NODE_TITLE_HEIGHT;for(let u=0;u<l.length;++u){const p=l[u];p.pos[0]=r==LiteGraph.VERTICAL_LAYOUT?c:a,p.pos[1]=r==LiteGraph.VERTICAL_LAYOUT?a:c;const f=r==LiteGraph.VERTICAL_LAYOUT?1:0;p.size[f]>h&&(h=p.size[f]);const d=r==LiteGraph.VERTICAL_LAYOUT?0:1;c+=p.size[d]+t+LiteGraph.NODE_TITLE_HEIGHT}a+=h+t}this.setDirtyCanvas(!0,!0)}getTime(){return this.globaltime}getFixedTime(){return this.fixedtime}getElapsedTime(){return this.elapsed_time}sendEventToAllNodes(t,r,s){s=s||LiteGraph.ALWAYS;const n=this._nodes_in_order?this._nodes_in_order:this._nodes;if(n)for(let a=0,o=n.length;a<o;++a){const l=n[a];if(l.constructor===LiteGraph.Subgraph&&t!="onExecute"){l.mode==s&&l.sendEventToAllNodes(t,r,s);continue}!l[t]||l.mode!=s||(r===void 0?l[t]():r&&r.constructor===Array?l[t].apply(l,r):l[t](r))}}sendActionToCanvas(t,r){if(this.list_of_graphcanvas)for(let s=0;s<this.list_of_graphcanvas.length;++s){const n=this.list_of_graphcanvas[s];n[t]&&n[t].apply(n,r)}}add(t,r){if(t){if(t.constructor===LGraphGroup){this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,this._version++;return}if(t.id!=-1&&this._nodes_by_id[t.id]!=null&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),LiteGraph.use_uuids?t.id=LiteGraph.uuidv4():t.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?(t.id==null||t.id==-1)&&(t.id=LiteGraph.uuidv4()):t.id==null||t.id==-1?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,t.onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),r||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.change(),t}}remove(t){if(t.constructor===LGraphGroup){const s=this._groups.indexOf(t);s!=-1&&this._groups.splice(s,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),this.change();return}if(this._nodes_by_id[t.id]==null||t.ignore_remove)return;if(this.beforeChange(),t.inputs)for(let s=0;s<t.inputs.length;s++){const n=t.inputs[s];n.link!=null&&(this.removeLink(n.link),t.disconnectInput(s))}if(t.outputs)for(let s=0;s<t.outputs.length;s++){const n=t.outputs[s];n.links!=null&&n.links.length&&([...n.links].forEach(a=>{this.removeLink(a)}),t.disconnectOutput(s))}if(t.onRemoved&&t.onRemoved(),t.graph=null,this._version++,this.list_of_graphcanvas)for(let s=0;s<this.list_of_graphcanvas.length;++s){const n=this.list_of_graphcanvas[s];n.selected_nodes[t.id]&&delete n.selected_nodes[t.id],n.node_dragged==t&&(n.node_dragged=null)}const r=this._nodes.indexOf(t);r!=-1&&this._nodes.splice(r,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}getNodeById(t){return t==null?null:this._nodes_by_id[t]}findNodesByClass(t,r){r=r||[],r.length=0;for(let s=0,n=this._nodes.length;s<n;++s)this._nodes[s].constructor===t&&r.push(this._nodes[s]);return r}findNodesByType(t,r){const s=t.toLowerCase();r=r||[],r.length=0;for(let n=0,a=this._nodes.length;n<a;++n)this._nodes[n].type.toLowerCase()==s&&r.push(this._nodes[n]);return r}findNodeByTitle(t){for(let r=0,s=this._nodes.length;r<s;++r)if(this._nodes[r].title==t)return this._nodes[r];return null}findNodesByTitle(t){const r=[];for(let s=0,n=this._nodes.length;s<n;++s)this._nodes[s].title==t&&r.push(this._nodes[s]);return r}getNodeOnPos(t,r,s,n){s=s||this._nodes;const a=null;for(let o=s.length-1;o>=0;o--){const l=s[o];if(l.isPointInside(t,r,n))return l}return a}getGroupOnPos(t,r){for(let s=this._groups.length-1;s>=0;s--){const n=this._groups[s];if(n.isPointInside(t,r,2,!0))return n}return null}checkNodeTypes(){for(let t=0;t<this._nodes.length;t++){const r=this._nodes[t],s=LiteGraph.registered_node_types[r.type];if(r.constructor==s)continue;console.log("node being replaced by newer version: "+r.type);const n=LiteGraph.createNode(r.type);this._nodes[t]=n,n.configure(r.serialize()),n.graph=this,this._nodes_by_id[n.id]=n,r.inputs&&(n.inputs=r.inputs.concat()),r.outputs&&(n.outputs=r.outputs.concat())}this.updateExecutionOrder()}onAction(t,r,s){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);for(let n=0;n<this._input_nodes.length;++n){const a=this._input_nodes[n];if(a.properties.name==t){a.actionDo(t,r,s);break}}}trigger(t,r){this.onTrigger&&this.onTrigger(t,r)}addInput(t,r,s){this.inputs[t]||(this.beforeChange(),this.inputs[t]={name:t,type:r,value:s},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(t,r),this.onInputsOutputsChange&&this.onInputsOutputsChange())}setInputData(t,r){const s=this.inputs[t];s&&(s.value=r)}getInputData(t){const r=this.inputs[t];return r?r.value:null}renameInput(t,r){if(r!=t){if(!this.inputs[t])return!1;if(this.inputs[r])return console.error("there is already one input with that name"),!1;this.inputs[r]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,r),this.onInputsOutputsChange&&this.onInputsOutputsChange()}}changeInputType(t,r){if(!this.inputs[t])return!1;this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()==String(r).toLowerCase()||(this.inputs[t].type=r,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,r))}removeInput(t){return this.inputs[t]?(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1}addOutput(t,r,s){this.outputs[t]={name:t,type:r,value:s},this._version++,this.onOutputAdded&&this.onOutputAdded(t,r),this.onInputsOutputsChange&&this.onInputsOutputsChange()}setOutputData(t,r){const s=this.outputs[t];s&&(s.value=r)}getOutputData(t){const r=this.outputs[t];return r?r.value:null}renameOutput(t,r){if(!this.outputs[t])return!1;if(this.outputs[r])return console.error("there is already one output with that name"),!1;this.outputs[r]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,r),this.onInputsOutputsChange&&this.onInputsOutputsChange()}changeOutputType(t,r){if(!this.outputs[t])return!1;this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()==String(r).toLowerCase()||(this.outputs[t].type=r,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,r))}removeOutput(t){return this.outputs[t]?(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1}triggerInput(t,r){const s=this.findNodesByTitle(t);for(let n=0;n<s.length;++n)s[n].onTrigger(r)}setCallback(t,r){const s=this.findNodesByTitle(t);for(let n=0;n<s.length;++n)s[n].setTrigger(r)}beforeChange(t){this.onBeforeChange&&this.onBeforeChange(this,t),this.sendActionToCanvas("onBeforeChange",this)}afterChange(t){this.onAfterChange&&this.onAfterChange(this,t),this.sendActionToCanvas("onAfterChange",this)}connectionChange(t,r){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")}isLive(){if(!this.list_of_graphcanvas)return!1;for(let t=0;t<this.list_of_graphcanvas.length;++t)if(this.list_of_graphcanvas[t].live_mode)return!0;return!1}clearTriggeredSlots(){for(const t in this.links){const r=this.links[t];r&&r._last_time&&(r._last_time=0)}}change(){LiteGraph.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)}setDirtyCanvas(t,r){this.sendActionToCanvas("setDirty",[t,r])}removeLink(t){const r=this.links[t];if(!r)return;const s=this.getNodeById(r.target_id);s&&s.disconnectInput(r.target_slot)}serialize(){const t=[];for(let a=0,o=this._nodes.length;a<o;++a)t.push(this._nodes[a].serialize());const r=[];for(const a in this.links){let o=this.links[a];if(!o.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");const l=new LLink;for(const h in o)l[h]=o[h];this.links[a]=l,o=l}r.push(o.serialize())}const s=[];for(let a=0;a<this._groups.length;++a)s.push(this._groups[a].serialize());const n={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:t,links:r,groups:s,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.onSerialize&&this.onSerialize(n),n}configure(t,r){if(!t)return;r||this.clear();const s=t.nodes;if(t.links&&t.links.constructor===Array){const a=[];for(let o=0;o<t.links.length;++o){const l=t.links[o];if(!l){console.warn("serialized graph link data contains errors, skipping.");continue}const h=new LLink;h.configure(l),a[h.id]=h}t.links=a}for(const a in t)a=="nodes"||a=="groups"||(this[a]=t[a]);let n=!1;if(this._nodes=[],s){for(let a=0,o=s.length;a<o;++a){const l=s[a];let h=LiteGraph.createNode(l.type,l.title);h||(LiteGraph.debug&&console.log("Node not found or has errors: "+l.type),h=new LGraphNode,h.last_serialization=l,h.has_errors=!0,n=!0),h.id=l.id,this.add(h,!0)}for(let a=0,o=s.length;a<o;++a){const l=s[a],h=this.getNodeById(l.id);h&&h.configure(l)}}if(this._groups.length=0,t.groups)for(let a=0;a<t.groups.length;++a){const o=new LGraphGroup;o.configure(t.groups[a]),this.add(o)}return this.updateExecutionOrder(),this.extra=t.extra||{},this.onConfigure&&this.onConfigure(t),this._version++,this.setDirtyCanvas(!0,!0),n}load(t,r){const s=this;if(t.constructor===File||t.constructor===Blob){const a=new FileReader;a.addEventListener("load",function(o){const l=JSON.parse(o.target.result);s.configure(l),r&&r()}),a.readAsText(t);return}const n=new XMLHttpRequest;n.open("GET",t,!0),n.send(null),n.onload=function(a){if(n.status!==200){console.error("Error loading graph:",n.status,n.response);return}const o=JSON.parse(n.response);s.configure(o),r&&r()},n.onerror=function(a){console.error("Error loading graph:",a)}}onNodeTrace(t,r,s){}getSupportedTypes(){return this.supported_types||pe.supported_types}};R(pe,"supported_types",["number","string","boolean"]),R(pe,"STATUS_STOPPED",1),R(pe,"STATUS_RUNNING",2);let LGraph=pe;class LLink{constructor(t,r,s,n,a,o){this.id=t,this.type=r,this.origin_id=s,this.origin_slot=n,this.target_id=a,this.target_slot=o,this._data=null,this._pos=new Float32Array(2)}configure(t){t.constructor===Array?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot)}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}class LGraphNode{constructor(t){this._ctor(t)}_ctor(t){this.title=t||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(r){!r||r.length<2||(this._pos[0]=r[0],this._pos[1]=r[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={},this._overlay_element=null,this._overlay_enabled=!1}configure(t){this.graph&&this.graph._version++;for(const r in t){if(r=="properties"){for(const s in t.properties)this.properties[s]=t.properties[s],this.onPropertyChanged&&this.onPropertyChanged(s,t.properties[s]);continue}t[r]!=null&&(typeof t[r]=="object"?this[r]&&this[r].configure?this[r].configure(t[r]):this[r]=LiteGraph.cloneObject(t[r],this[r]):this[r]=t[r])}if(t.title||(this.title=this.constructor.title),this.inputs)for(let r=0;r<this.inputs.length;++r){const s=this.inputs[r],n=this.graph?this.graph.links[s.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,r,!0,n,s),this.onInputAdded&&this.onInputAdded(s)}if(this.outputs)for(let r=0;r<this.outputs.length;++r){const s=this.outputs[r];if(s.links){for(let n=0;n<s.links.length;++n){const a=this.graph?this.graph.links[s.links[n]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,r,!0,a,s)}this.onOutputAdded&&this.onOutputAdded(s)}}if(this.widgets){for(let r=0;r<this.widgets.length;++r){const s=this.widgets[r];s&&s.options&&s.options.property&&this.properties[s.options.property]!=null&&(s.value=JSON.parse(JSON.stringify(this.properties[s.options.property])))}if(t.widgets_values)for(let r=0;r<t.widgets_values.length;++r)this.widgets[r]&&(this.widgets[r].value=t.widgets_values[r])}this.onConfigure&&this.onConfigure(t)}serialize(){const t={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;if(this.inputs&&(t.inputs=this.inputs),this.outputs){for(let r=0;r<this.outputs.length;r++)delete this.outputs[r]._data;t.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){t.widgets_values=[];for(let r=0;r<this.widgets.length;++r)this.widgets[r]?t.widgets_values[r]=this.widgets[r].value:t.widgets_values[r]=null}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t}clone(){const t=LiteGraph.createNode(this.type);if(!t)return null;const r=LiteGraph.cloneObject(this.serialize());if(r.inputs)for(let s=0;s<r.inputs.length;++s)r.inputs[s].link=null;if(r.outputs)for(let s=0;s<r.outputs.length;++s)r.outputs[s].links&&(r.outputs[s].links.length=0);return delete r.id,LiteGraph.use_uuids&&(r.id=LiteGraph.uuidv4()),t.configure(r),t}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title||this.constructor.title}setProperty(t,r){if(this.properties||(this.properties={}),r===this.properties[t])return;const s=this.properties[t];if(this.properties[t]=r,this.onPropertyChanged&&this.onPropertyChanged(t,r,s)===!1&&(this.properties[t]=s),this.widgets)for(let n=0;n<this.widgets.length;++n){const a=this.widgets[n];if(a&&a.options.property==t){a.value=r;break}}}createPropertyOverlay(){return null}updateOverlayFromProperties(){if(!this._overlay_element)return;this._overlay_element.querySelectorAll("[data-property]").forEach(r=>{const s=r.getAttribute("data-property");if(s&&this.properties[s]!==void 0){const n=this.properties[s];r.type==="checkbox"?r.checked=!!n:r.type==="number"||r.type==="range"||r.tagName==="INPUT"||r.tagName==="TEXTAREA"||r.tagName==="SELECT"?r.value=n:r.textContent=n}})}updatePropertyFromOverlay(t,r){this.properties||(this.properties={});const s=this.properties[t];if(this.properties[t]=r,this.onPropertyChanged&&this.onPropertyChanged(t,r,s)===!1){this.properties[t]=s;return}if(this.graph&&(this.graph._version++,this.graph.setDirtyCanvas(!0,!0)),this.widgets)for(let n=0;n<this.widgets.length;++n){const a=this.widgets[n];if(a&&a.options&&a.options.property==t){a.value=r;break}}}setPropertyOverlayVisibility(t){this._overlay_element&&(this._overlay_element.style.display=t?"block":"none")}getOrCreateOverlayElement(){return this._overlay_element||(this._overlay_element=this.createPropertyOverlay(),this._overlay_element&&(this._overlay_enabled=!0,this.updateOverlayFromProperties())),this._overlay_element}setOutputData(t,r){if(!this.outputs||t==-1||t>=this.outputs.length)return;const s=this.outputs[t];if(s&&(s._data=r,this.outputs[t].links))for(let n=0;n<this.outputs[t].links.length;n++){const a=this.outputs[t].links[n],o=this.graph.links[a];o&&(o.data=r)}}setInputName(t,r){t!==-1&&(this.inputs[t].name=r)}setOutputName(t,r){t!==-1&&(this.outputs[t].name=r)}setOutputDataType(t,r){if(!this.outputs||t==-1||t>=this.outputs.length)return;const s=this.outputs[t];if(s&&(s.type=r,this.outputs[t].links))for(let n=0;n<this.outputs[t].links.length;n++){const a=this.outputs[t].links[n];this.graph.links[a].type=r}}getInputData(t,r){if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return;const s=this.inputs[t].link,n=this.graph.links[s];if(!n)return null;if(!r)return n.data;const a=this.graph.getNodeById(n.origin_id);return a&&(a.updateOutputData?a.updateOutputData(n.origin_slot):a.onExecute&&a.onExecute()),n.data}getInputDataType(t){if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return null;const r=this.inputs[t].link,s=this.graph.links[r];if(!s)return null;const n=this.graph.getNodeById(s.origin_id);if(!n)return s.type;const a=n.outputs[s.origin_slot];return a?a.type:null}getInputDataByName(t,r){const s=this.findInputSlot(t);return s==-1?null:this.getInputData(s,r)}isInputConnected(t){return this.inputs?t<this.inputs.length&&this.inputs[t].link!=null:!1}getInputInfo(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null}getInputLink(t){if(!this.inputs)return null;if(t<this.inputs.length){const r=this.inputs[t];return this.graph.links[r.link]}return null}getInputNode(t){if(!this.inputs||t>=this.inputs.length)return null;const r=this.inputs[t];if(!r||r.link===null)return null;const s=this.graph.links[r.link];return s?this.graph.getNodeById(s.origin_id):null}getInputOrProperty(t){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[t]:null;for(let r=0,s=this.inputs.length;r<s;++r){const n=this.inputs[r];if(t==n.name&&n.link!=null){const a=this.graph.links[n.link];if(a)return a.data}}return this.properties[t]}getOutputData(t){return!this.outputs||t>=this.outputs.length?null:this.outputs[t]._data}getOutputInfo(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null}isOutputConnected(t){return this.outputs?t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length:!1}isAnyOutputConnected(){if(!this.outputs)return!1;for(let t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1}getOutputNodes(t){if(!this.outputs||this.outputs.length==0||t>=this.outputs.length)return null;const r=this.outputs[t];if(!r.links||r.links.length==0)return null;const s=[];for(let n=0;n<r.links.length;n++){const a=r.links[n],o=this.graph.links[a];if(o){const l=this.graph.getNodeById(o.target_id);l&&s.push(l)}}return s}addOnTriggerInput(){const t=this.findInputSlot("onTrigger");if(t==-1){//!trigS ||
return this.addInput("onTrigger",LiteGraph.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")}return t}addOnExecutedOutput(){const t=this.findOutputSlot("onExecuted");if(t==-1){//!trigS ||
return this.addOutput("onExecuted",LiteGraph.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")}return t}onAfterExecuteNode(t,r){const s=this.findOutputSlot("onExecuted");s!=-1&&this.triggerSlot(s,t,null,r)}changeMode(t){switch(t){case LiteGraph.ON_EVENT:break;case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.NEVER:break;case LiteGraph.ALWAYS:break;case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=t,!0}executePendingActions(){if(!(!this._waiting_actions||!this._waiting_actions.length)){for(let t=0;t<this._waiting_actions.length;++t){const r=this._waiting_actions[t];this.onAction(r[0],r[1],r[2],r[3],r[4])}this._waiting_actions.length=0}}doExecute(t,r){r=r||{},this.onExecute&&(r.action_call||(r.action_call=this.id+"_exec_"+Math.floor(Math.random()*9999)),this.graph.nodes_executing[this.id]=!0,this.onExecute(t,r),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,r&&r.action_call&&(this.action_call=r.action_call,this.graph.nodes_executedAction[this.id]=r.action_call)),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(t,r)}actionDo(t,r,s,n){s=s||{},this.onAction&&(s.action_call||(s.action_call=this.id+"_"+(t||"action")+"_"+Math.floor(Math.random()*9999)),this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,r,s,n),this.graph.nodes_actioning[this.id]=!1,s&&s.action_call&&(this.action_call=s.action_call,this.graph.nodes_executedAction[this.id]=s.action_call)),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(r,s)}trigger(t,r,s){if(!(!this.outputs||!this.outputs.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(let n=0;n<this.outputs.length;++n){const a=this.outputs[n];!a||a.type!==LiteGraph.EVENT||t&&a.name!=t||this.triggerSlot(n,r,null,s)}}}triggerSlot(t,r,s,n){if(n=n||{},!this.outputs)return;if(t==null){console.error("slot must be a number");return}t.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");const a=this.outputs[t];if(!a)return;const o=a.links;if(!(!o||!o.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(let l=0;l<o.length;++l){const h=o[l];if(s!=null&&s!=h)continue;const c=this.graph.links[o[l]];if(!c)continue;c._last_time=LiteGraph.getTime();const u=this.graph.getNodeById(c.target_id);if(u){if(u.inputs[c.target_slot],u.mode===LiteGraph.ON_TRIGGER)n.action_call||(n.action_call=this.id+"_trigg_"+Math.floor(Math.random()*9999)),u.onExecute&&u.doExecute(r,n);else if(u.onAction){n.action_call||(n.action_call=this.id+"_act_"+Math.floor(Math.random()*9999));const p=u.inputs[c.target_slot];LiteGraph.use_deferred_actions&&u.onExecute?(u._waiting_actions||(u._waiting_actions=[]),u._waiting_actions.push([p.name,r,n,c.target_slot])):u.actionDo(p.name,r,n,c.target_slot)}}}}}clearTriggeredSlot(t,r){if(!this.outputs)return;const s=this.outputs[t];if(!s)return;const n=s.links;if(!(!n||!n.length))for(let a=0;a<n.length;++a){const o=n[a];if(r!=null&&r!=o)continue;const l=this.graph.links[n[a]];l&&(l._last_time=0)}}setSize(t){this.size=t,this.onResize&&this.onResize(this.size)}addProperty(t,r,s,n){const a={name:t,type:s,default_value:r};if(n)for(const o in n)a[o]=n[o];return this.properties_info||(this.properties_info=[]),this.properties_info.push(a),this.properties||(this.properties={}),this.properties[t]=r,a}addOutput(t,r,s){const n={name:t,type:r,links:null};if(s)for(const a in s)n[a]=s[a];return this.outputs||(this.outputs=[]),this.outputs.push(n),this.onOutputAdded&&this.onOutputAdded(n),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,r,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),n}addOutputs(t){for(let r=0;r<t.length;++r){const s=t[r],n={name:s[0],type:s[1],link:null};if(t[2])for(const a in s[2])n[a]=s[2][a];this.outputs||(this.outputs=[]),this.outputs.push(n),this.onOutputAdded&&this.onOutputAdded(n),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,s[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}removeOutput(t){this.disconnectOutput(t),this.outputs.splice(t,1);for(let r=t;r<this.outputs.length;++r){if(!this.outputs[r]||!this.outputs[r].links)continue;const s=this.outputs[r].links;for(let n=0;n<s.length;++n){const a=this.graph.links[s[n]];a&&(a.origin_slot-=1)}}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(t),this.setDirtyCanvas(!0,!0)}addInput(t,r,s){r=r||0;const n={name:t,type:r,link:null};if(s)for(const a in s)n[a]=s[a];return this.inputs||(this.inputs=[]),this.inputs.push(n),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(n),LiteGraph.registerNodeAndSlotType(this,r),this.setDirtyCanvas(!0,!0),n}addInputs(t){for(let r=0;r<t.length;++r){const s=t[r],n={name:s[0],type:s[1],link:null};if(t[2])for(const a in s[2])n[a]=s[2][a];this.inputs||(this.inputs=[]),this.inputs.push(n),this.onInputAdded&&this.onInputAdded(n),LiteGraph.registerNodeAndSlotType(this,s[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}removeInput(t){this.disconnectInput(t);const r=this.inputs.splice(t,1);for(let s=t;s<this.inputs.length;++s){if(!this.inputs[s])continue;const n=this.graph.links[this.inputs[s].link];n&&(n.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(t,r[0]),this.setDirtyCanvas(!0,!0)}addConnection(t,r,s,n){const a={name:t,type:r,pos:s,direction:n,links:null};return this.connections.push(a),a}computeSize(t){if(this.constructor.size)return this.constructor.size.concat();let r=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1);const s=t||new Float32Array([0,0]);r=Math.max(r,1);const n=LiteGraph.NODE_TEXT_SIZE,a=c(this.title);let o=0,l=0;if(this.inputs)for(let u=0,p=this.inputs.length;u<p;++u){const f=this.inputs[u],d=f.label||f.name||"",g=c(d);o<g&&(o=g)}if(this.outputs)for(let u=0,p=this.outputs.length;u<p;++u){const f=this.outputs[u],d=f.label||f.name||"",g=c(d);l<g&&(l=g)}s[0]=Math.max(o+l+10,a),s[0]=Math.max(s[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(s[0]=Math.max(s[0],LiteGraph.NODE_WIDTH*1.5)),s[1]=(this.constructor.slot_start_y||0)+r*LiteGraph.NODE_SLOT_HEIGHT;let h=0;if(this.widgets&&this.widgets.length){for(let u=0,p=this.widgets.length;u<p;++u)this.widgets[u].computeSize?h+=this.widgets[u].computeSize(s[0])[1]+4:h+=LiteGraph.NODE_WIDGET_HEIGHT+4;h+=8}this.widgets_up?s[1]=Math.max(s[1],h):this.widgets_start_y!=null?s[1]=Math.max(s[1],h+this.widgets_start_y):s[1]+=h;function c(u){return u?n*u.length*.6:0}return this.constructor.min_height&&s[1]<this.constructor.min_height&&(s[1]=this.constructor.min_height),s[1]+=6,s}getPropertyInfo(t){let r=null;if(this.properties_info){for(let s=0;s<this.properties_info.length;++s)if(this.properties_info[s].name==t){r=this.properties_info[s];break}}return this.constructor["@"+t]&&(r=this.constructor["@"+t]),this.constructor.widgets_info&&this.constructor.widgets_info[t]&&(r=this.constructor.widgets_info[t]),!r&&this.onGetPropertyInfo&&(r=this.onGetPropertyInfo(t)),r||(r={}),r.type||(r.type=typeof this.properties[t]),r.widget=="combo"&&(r.type="enum"),r}addWidget(t,r,s,n,a){this.widgets||(this.widgets=[]),!a&&n&&n.constructor===Object&&(a=n,n=null),a&&a.constructor===String&&(a={property:a}),n&&n.constructor===String&&(a||(a={}),a.property=n,n=null),n&&n.constructor!==Function&&(console.warn("addWidget: callback must be a function"),n=null);const o={type:t.toLowerCase(),name:r,value:s,callback:n,options:a||{}};if(o.options.y!==void 0&&(o.y=o.options.y),!n&&!o.options.callback&&!o.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),t=="combo"&&!o.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(o),this.setSize(this.computeSize()),o}addCustomWidget(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),t}getBounding(t,r){t=t||new Float32Array(4);const s=this.pos,n=this.flags.collapsed,a=this.size;let o=0,l=1,h=0,c=0;return r&&(o=4,l=6+o,h=4,c=5+h),t[0]=s[0]-o,t[1]=s[1]-LiteGraph.NODE_TITLE_HEIGHT-h,t[2]=n?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+l:a[0]+l,t[3]=n?LiteGraph.NODE_TITLE_HEIGHT+c:a[1]+LiteGraph.NODE_TITLE_HEIGHT+c,this.onBounding&&this.onBounding(t),t}isPointInside(t,r,s,n){s=s||0;let a=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(n&&(a=0),this.flags&&this.flags.collapsed){if(LiteGraph.isInsideRectangle(t,r,this.pos[0]-s,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-s,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*s,LiteGraph.NODE_TITLE_HEIGHT+2*s))return!0}else if(this.pos[0]-4-s<t&&this.pos[0]+this.size[0]+4+s>t&&this.pos[1]-a-s<r&&this.pos[1]+this.size[1]+s>r)return!0;return!1}getSlotInPosition(t,r){const s=new Float32Array(2);if(this.inputs)for(let n=0,a=this.inputs.length;n<a;++n){const o=this.inputs[n];if(this.getConnectionPos(!0,n,s),LiteGraph.isInsideRectangle(t,r,s[0]-10,s[1]-5,20,10))return{input:o,slot:n,link_pos:s}}if(this.outputs)for(let n=0,a=this.outputs.length;n<a;++n){const o=this.outputs[n];if(this.getConnectionPos(!1,n,s),LiteGraph.isInsideRectangle(t,r,s[0]-10,s[1]-5,20,10))return{output:o,slot:n,link_pos:s}}return null}findInputSlot(t,r){if(!this.inputs)return-1;for(let s=0,n=this.inputs.length;s<n;++s)if(t==this.inputs[s].name)return r?this.inputs[s]:s;return-1}findOutputSlot(t,r){if(r=r||!1,!this.outputs)return-1;for(let s=0,n=this.outputs.length;s<n;++s)if(t==this.outputs[s].name)return r?this.outputs[s]:s;return-1}findInputSlotFree(t){const n=Object.assign({returnObj:!1,typesNotAccepted:[]},t||{});if(!this.inputs)return-1;for(let a=0,o=this.inputs.length;a<o;++a)if(!(this.inputs[a].link&&this.inputs[a].link!=null)&&!(n.typesNotAccepted&&n.typesNotAccepted.includes&&n.typesNotAccepted.includes(this.inputs[a].type)))return n.returnObj?this.inputs[a]:a;return-1}findOutputSlotFree(t){const n=Object.assign({returnObj:!1,typesNotAccepted:[]},t||{});if(!this.outputs)return-1;for(let a=0,o=this.outputs.length;a<o;++a)if(!(this.outputs[a].links&&this.outputs[a].links!=null)&&!(n.typesNotAccepted&&n.typesNotAccepted.includes&&n.typesNotAccepted.includes(this.outputs[a].type)))return n.returnObj?this.outputs[a]:a;return-1}findInputSlotByType(t,r,s,n){return this.findSlotByType(!0,t,r,s,n)}findOutputSlotByType(t,r,s,n){return this.findSlotByType(!1,t,r,s,n)}findSlotByType(t,r,s,n,a){t=t||!1,s=s||!1,n=n||!1,a=a||!1;const o=t?this.inputs:this.outputs;if(!o)return-1;(r==""||r=="*")&&(r=0);for(let l=0,h=o.length;l<h;++l){const c=(r+"").toLowerCase().split(",");let u=o[l].type=="0"||o[l].type=="*"?"0":o[l].type;u=(u+"").toLowerCase().split(",");for(let p=0;p<c.length;p++)for(let f=0;f<u.length;f++)if(c[p]=="_event_"&&(c[p]=LiteGraph.EVENT),u[p]=="_event_"&&(u[p]=LiteGraph.EVENT),c[p]=="*"&&(c[p]=0),u[p]=="*"&&(u[p]=0),c[p]==u[f]){if(n&&o[l].links&&o[l].links!==null)continue;return s?o[l]:l}}if(n&&!a)for(let l=0,h=o.length;l<h;++l){const c=(r+"").toLowerCase().split(",");let u=o[l].type=="0"||o[l].type=="*"?"0":o[l].type;u=(u+"").toLowerCase().split(",");for(let p=0;p<c.length;p++)for(let f=0;f<u.length;f++)if(c[p]=="*"&&(c[p]=0),u[p]=="*"&&(u[p]=0),c[p]==u[f])return s?o[l]:l}return-1}connectByType(t,r,s,n){const l=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},n||{});r&&r.constructor===Number&&(r=this.graph.getNodeById(r));const h=r.findInputSlotByType(s,!1,!0);if(h>=0&&h!==null)return this.connect(t,r,h);if(l.createEventInCase&&s==LiteGraph.EVENT)return this.connect(t,r,-1);if(l.generalTypeInCase){const c=r.findInputSlotByType(0,!1,!0,!0);if(c>=0)return this.connect(t,r,c)}if(l.firstFreeIfOutputGeneralInCase&&(s==0||s=="*"||s=="")){const c=r.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(c>=0)return this.connect(t,r,c)}return console.debug("no way to connect type: ",s," to targetNODE ",r),null}connectByTypeOutput(t,r,s,n){const l=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},n||{});r&&r.constructor===Number&&(r=this.graph.getNodeById(r));const h=r.findOutputSlotByType(s,!1,!0);if(h>=0&&h!==null)return r.connect(h,this,t);if(l.generalTypeInCase){const c=r.findOutputSlotByType(0,!1,!0,!0);if(c>=0)return r.connect(c,this,t)}if(l.createEventInCase&&s==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots){const c=r.addOnExecutedOutput();return r.connect(c,this,t)}if(l.firstFreeIfInputGeneralInCase&&(s==0||s=="*"||s=="")){const c=r.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(c>=0)return r.connect(c,this,t)}return console.debug("no way to connect byOUT type: ",s," to sourceNODE ",r),null}connect(t,r,s){if(s=s||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(t.constructor===String){if(t=this.findOutputSlot(t),t==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),null}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(r&&r.constructor===Number&&(r=this.graph.getNodeById(r)),!r)throw"target node is null";if(r==this)return null;if(s.constructor===String){if(s=r.findInputSlot(s),s==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+s),null}else if(s===LiteGraph.EVENT)if(LiteGraph.do_add_triggers_slots)r.changeMode(LiteGraph.ON_TRIGGER),s=r.findInputSlot("onTrigger");else return null;else if(!r.inputs||s>=r.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;let n=!1;const a=r.inputs[s];let o=null;const l=this.outputs[t];if(!this.outputs[t])return null;if(r.onBeforeConnectInput&&(s=r.onBeforeConnectInput(s)),s===!1||s===null||!LiteGraph.isValidConnection(l.type,a.type))return this.setDirtyCanvas(!1,!0),n&&this.graph.connectionChange(this,o),null;if(r.onConnectInput&&r.onConnectInput(s,l.type,l,this,t)===!1||this.onConnectOutput&&this.onConnectOutput(t,a.type,a,r,s)===!1)return null;if(r.inputs[s]&&r.inputs[s].link!=null&&(this.graph.beforeChange(),r.disconnectInput(s,{doProcessChange:!1}),n=!0),l.links!==null&&l.links.length)switch(l.type){case LiteGraph.EVENT:LiteGraph.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(t,!1,{doProcessChange:!1}),n=!0);break}let h;return LiteGraph.use_uuids?h=LiteGraph.uuidv4():h=++this.graph.last_link_id,o=new LLink(h,a.type||l.type,this.id,t,r.id,s),this.graph.links[o.id]=o,l.links==null&&(l.links=[]),l.links.push(o.id),r.inputs[s].link=o.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!0,o,l),r.onConnectionsChange&&r.onConnectionsChange(LiteGraph.INPUT,s,!0,o,a),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,r,s,this,t),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t,r,s)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,o),o}disconnectOutput(t,r){if(t.constructor===String){if(t=this.findOutputSlot(t),t==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const s=this.outputs[t];if(!s||!s.links||s.links.length==0)return!1;if(r){if(r.constructor===Number&&(r=this.graph.getNodeById(r)),!r)throw"Target Node not found";for(let n=0,a=s.links.length;n<a;n++){const o=s.links[n],l=this.graph.links[o];if(l.target_id==r.id){s.links.splice(n,1);const h=r.inputs[l.target_slot];h.link=null,delete this.graph.links[o],this.graph&&this.graph._version++,r.onConnectionsChange&&r.onConnectionsChange(LiteGraph.INPUT,l.target_slot,!1,l,h),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!1,l,s),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,r,l.target_slot));break}}}else{for(let n=0,a=s.links.length;n<a;n++){const o=s.links[n],l=this.graph.links[o];if(!l)continue;const h=this.graph.getNodeById(l.target_id);let c=null;this.graph&&this.graph._version++,h&&(c=h.inputs[l.target_slot],c.link=null,h.onConnectionsChange&&h.onConnectionsChange(LiteGraph.INPUT,l.target_slot,!1,l,c),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,h,l.target_slot)),delete this.graph.links[o],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!1,l,s),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,h,l.target_slot))}s.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}disconnectInput(t){if(t.constructor===String){if(t=this.findInputSlot(t),t==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.inputs||t>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;const r=this.inputs[t];if(!r)return!1;const s=this.inputs[t].link;if(s!=null){this.inputs[t].link=null;const n=this.graph.links[s];if(n){const a=this.graph.getNodeById(n.origin_id);if(!a)return!1;const o=a.outputs[n.origin_slot];if(!o||!o.links||o.links.length==0)return!1;let l=null;for(let h=0,c=o.links.length;h<c;h++)if(l=h,o.links[h]==s){o.links.splice(h,1);break}delete this.graph.links[s],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,t,!1,n,r),a.onConnectionsChange&&a.onConnectionsChange(LiteGraph.OUTPUT,l,!1,n,o),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,a,l),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}getConnectionPos(t,r,s){s=s||new Float32Array(2);let n=0;t&&this.inputs&&(n=this.inputs.length),!t&&this.outputs&&(n=this.outputs.length);const a=LiteGraph.NODE_SLOT_HEIGHT*.5;if(this.flags.collapsed){const o=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return this.horizontal?(s[0]=this.pos[0]+o*.5,t?s[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:s[1]=this.pos[1]):(t?s[0]=this.pos[0]:s[0]=this.pos[0]+o,s[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT*.5),s}return t&&r==-1?(s[0]=this.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*.5,s[1]=this.pos[1]+LiteGraph.NODE_TITLE_HEIGHT*.5,s):t&&n>r&&this.inputs[r].pos?(s[0]=this.pos[0]+this.inputs[r].pos[0],s[1]=this.pos[1]+this.inputs[r].pos[1],s):!t&&n>r&&this.outputs[r].pos?(s[0]=this.pos[0]+this.outputs[r].pos[0],s[1]=this.pos[1]+this.outputs[r].pos[1],s):this.horizontal?(s[0]=this.pos[0]+(r+.5)*(this.size[0]/n),t?s[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:s[1]=this.pos[1]+this.size[1],s):(t?s[0]=this.pos[0]+a:s[0]=this.pos[0]+this.size[0]+1-a,s[1]=this.pos[1]+(r+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),s)}alignToGrid(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)}trace(t){this.console||(this.console=[]),this.console.push(t),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,t)}setDirtyCanvas(t,r){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,r])}loadImage(t){const r=new Image;r.src=LiteGraph.node_images_path+t,r.ready=!1;const s=this;return r.onload=function(){this.ready=!0,s.setDirtyCanvas(!0)},r}captureInput(t){if(!this.graph||!this.graph.list_of_graphcanvas)return;const r=this.graph.list_of_graphcanvas;for(let s=0;s<r.length;++s){const n=r[s];!t&&n.node_capturing_input!=this||(n.node_capturing_input=t?this:null)}}collapse(t){this.graph._version++,!(this.constructor.collapsable===!1&&!t)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))}pin(t){this.graph._version++,t===void 0?this.flags.pinned=!this.flags.pinned:this.flags.pinned=t}localToScreen(t,r,s){return[(t+this.pos[0])*s.scale+s.offset[0],(r+this.pos[1])*s.scale+s.offset[1]]}}class LGraphGroup{constructor(t){this._ctor(t)}_ctor(t){this.title=t||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,this.id=LiteGraph.uuidv4(),this.group_id=null,Object.defineProperty(this,"pos",{set:function(r){!r||r.length<2||(this._pos[0]=Math.round(r[0]),this._pos[1]=Math.round(r[1]))},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(r){!r||r.length<2||(this._size[0]=Math.max(140,Math.round(r[0])),this._size[1]=Math.max(80,r[1]))},get:function(){return this._size},enumerable:!0})}configure(t){this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.font_size=t.font_size,this.id=t.id,this.group_id=t.group_id,this.status=t.status}serialize(){let t=this._bounding;return{title:this.title,bounding:[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])],color:this.color,font_size:this.font_size,id:this.id,status:this.status,group_id:this.group_id}}move(t,r,s,n=!1){if(this._pos[0]+=t,this._pos[1]+=r,!s&&n===!1)for(let a=0;a<this._nodes.length;++a){let o=this._nodes[a];o.pos[0]+=t,o.pos[1]+=r}}recomputeInsideNodes(){this._nodes.length=0;let t=this.graph._nodes,r=new Float32Array(4);for(let s=0;s<t.length;++s){let n=t[s];n.getBounding(r),LiteGraph.overlapBounding(this._bounding,r)&&this._nodes.push(n)}}isPointInside(t,r,s,n){s=s||0;let a=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(n&&(a=0),this.flags&&this.flags.collapsed){if(LiteGraph.isInsideRectangle(t,r,this.pos[0]-s,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-s,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*s,LiteGraph.NODE_TITLE_HEIGHT+2*s))return!0}else if(this.pos[0]-4-s<t&&this.pos[0]+this.size[0]+4+s>t&&this.pos[1]-a-s<r&&this.pos[1]+this.size[1]+s>r)return!0;return!1}setDirtyCanvas(t,r){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,r])}}class DragAndScale{constructor(t,r){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,r||this.bindEvents(t))}bindEvents(t){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph.pointerListenerAdd(t,"down",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"up",this._binded_mouse_callback),t.addEventListener("mousewheel",this._binded_mouse_callback,!1),t.addEventListener("wheel",this._binded_mouse_callback,!1)}computeVisibleArea(t){if(!this.element){this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0;return}let r=this.element.width,s=this.element.height,n=-this.offset[0],a=-this.offset[1];t&&(n+=t[0]/this.scale,a+=t[1]/this.scale,r=t[2],s=t[3]);const o=n+r/this.scale,l=a+s/this.scale;this.visible_area[0]=n,this.visible_area[1]=a,this.visible_area[2]=o-n,this.visible_area[3]=l-a}onMouse(t){if(!this.enabled)return;const r=this.element,s=r.getBoundingClientRect(),n=t.clientX-s.left,a=t.clientY-s.top;t.canvasx=n,t.canvasy=a,t.dragging=this.dragging;const o=!this.viewport||this.viewport&&n>=this.viewport[0]&&n<this.viewport[0]+this.viewport[2]&&a>=this.viewport[1]&&a<this.viewport[1]+this.viewport[3];let l=!1;if(this.onmouse&&(l=this.onmouse(t)),t.type==LiteGraph.pointerevents_method+"down"&&o)this.dragging=!0,LiteGraph.pointerListenerRemove(r,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"up",this._binded_mouse_callback);else if(t.type==LiteGraph.pointerevents_method+"move"){if(!l){const h=n-this.last_mouse[0],c=a-this.last_mouse[1];this.dragging&&this.mouseDrag(h,c)}}else t.type==LiteGraph.pointerevents_method+"up"?(this.dragging=!1,LiteGraph.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(r,"move",this._binded_mouse_callback)):o&&(t.type=="mousewheel"||t.type=="wheel"||t.type=="DOMMouseScroll")&&(t.eventType="mousewheel",t.type=="wheel"?t.wheel=-t.deltaY:t.wheel=t.wheelDeltaY!=null?t.wheelDeltaY:t.detail*-60,t.delta=t.wheelDelta?t.wheelDelta/40:t.deltaY?-t.deltaY/3:0,this.changeDeltaScale(1+t.delta*.05));if(this.last_mouse[0]=n,this.last_mouse[1]=a,o)return t.preventDefault(),t.stopPropagation(),!1}toCanvasContext(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]}convertCanvasToOffset(t,r){return r=r||[0,0],r[0]=t[0]/this.scale-this.offset[0],r[1]=t[1]/this.scale-this.offset[1],r}mouseDrag(t,r){this.offset[0]+=t/this.scale,this.offset[1]+=r/this.scale,this.onredraw&&this.onredraw(this)}changeScale(t,r){if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t==this.scale||!this.element)return;const s=this.element.getBoundingClientRect();if(!s)return;r=r||[s.width*.5,s.height*.5];const n=this.convertCanvasToOffset(r);this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1);const a=this.convertCanvasToOffset(r),o=[a[0]-n[0],a[1]-n[1]];this.offset[0]+=o[0],this.offset[1]+=o[1],this.onredraw&&this.onredraw(this)}changeDeltaScale(t,r){this.changeScale(this.scale*t,r)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}const _LGraphCanvas=class _LGraphCanvas{constructor(e,t,r){R(this,"saveUndoStack",async function(){var r,s;const e=this.graph.serialize(),t=this.tempDeepClone(e);(((r=this.undoStack)==null?void 0:r.length)===0||((s=this.undoStack)==null?void 0:s.length)>0&&!this.checkObjectEqual(t,this.undoStack[this.undoStack.length-1]))&&this.undoStack.push(t),this.undoStack.length>this.maxStackSize&&this.undoStack.shift(),this.redoStack.length=0});this.graph=t,this.options=r=r||{},this.move_grp_alone=!1,this.ALWAYS_FLOW=!1,this.isKeyPressed=!1,this._menus=[],this.maxStackSize=r.maxStackSize||1e3,this.undoStack=[],this.redoStack=[],this.saveUndoStackEvt=this.debounceTime(this.saveUndoStack.bind(this),50),this.background_image=_LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,e&&e.constructor===String&&(e=document.querySelector(e)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=""+LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=r.viewport||null,t&&t.attachCanvas(this),this.clear(),this.autoresize=r.autoresize,this.fps=0}async _init(e){await this.setCanvas(e,this.options.skip_events),this.clear(),this.options.skip_render||this.startRendering()}clear(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()}setGraph(e,t){if(this.graph!=e){if(t||this.clear(),!e&&this.graph){this.graph.detachCanvas(this);return}e.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)}}getTopGraph(){return this._graph_stack.length?this._graph_stack[0]:this.graph}openSubgraph(e){if(!e)throw"graph cannot be null";if(this.graph==e)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),e.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)}closeSubgraph(){if(!this._graph_stack||this._graph_stack.length==0)return;const e=this.graph._subgraph_node,t=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},t.attachCanvas(this),this.setDirty(!0,!0),e&&(this.centerOnNode(e),this.selectNodes([e])),this.ds.offset=[0,0],this.ds.scale=1}getCurrentGraph(){return this.graph}async setCanvas(e,t){if(e&&e.constructor===String&&(e=document.getElementById(e),!e))throw"Error creating LiteGraph canvas: Canvas not found";if(e===this.canvas)return;!e&&this.canvas&&(t||this.unbindEvents());const r=e.parentElement,{width:s,height:n}=r.getBoundingClientRect();if(e.width=s,e.height=n,this.canvas=e,this.ds.element=e,!!e){if(e.className+=" lgraphcanvas",e.data=this,e.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),this._overlay_container||(this._overlay_container=document.createElement("div"),this._overlay_container.className="lgraph-overlay-container",this._overlay_container.style.position="absolute",this._overlay_container.style.top="0",this._overlay_container.style.left="0",this._overlay_container.style.width="100%",this._overlay_container.style.height="100%",this._overlay_container.style.pointerEvents="none",this._overlay_container.style.overflow="hidden",this._overlay_container.style.zIndex="10",r&&r.appendChild(this._overlay_container)),e.getContext==null)throw e.localName!="canvas"?"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+e.localName:"This browser doesn't support Canvas";this.options.useWebgl?await this.enableWebGL():(this.ctx=e.getContext("2d"))==null&&(e.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),await this.enableWebGL()),t||this.bindEvents(),this.draw(!0,!0)}}_doNothing(e){return e.preventDefault(),!1}_doReturnTrue(e){return e.preventDefault(),!0}bindEvents(){if(this._events_binded){console.warn("LGraphCanvas: events already binded");return}const e=this.canvas,r=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph.pointerListenerAdd(e,"down",this._mousedown_callback,!0),e.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph.pointerListenerAdd(e,"up",this._mouseup_callback,!0),LiteGraph.pointerListenerAdd(e,"move",this._mousemove_callback),e.addEventListener("contextmenu",this._doNothing),e.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),e.setAttribute("tabindex",1),e.addEventListener("keydown",this._key_callback,!0),r.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),e.addEventListener("dragover",this._doNothing,!1),e.addEventListener("dragend",this._doNothing,!1),e.addEventListener("drop",this._ondrop_callback,!1),e.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}unbindEvents(){if(!this._events_binded){console.warn("LGraphCanvas: no events binded");return}const t=this.getCanvasWindow().document;LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}createNodeOverlay(e){if(!e||!this._overlay_container)return;const t=e.getOrCreateOverlayElement();t&&(t.style.position="absolute",t.style.pointerEvents="auto",t.className=(t.className||"")+" lgraph-node-overlay",this._overlay_container.appendChild(t),e._overlay_element=t,this.updateNodeOverlayPosition(e),e._overlay_initial_size||(e._overlay_initial_size=[e.size[0],e.size[1]]))}removeNodeOverlay(e){!e||!e._overlay_element||(this._overlay_container&&e._overlay_element.parentNode===this._overlay_container&&this._overlay_container.removeChild(e._overlay_element),e._overlay_element=null,e._overlay_enabled=!1)}updateNodeOverlayPosition(e){if(!e||!e._overlay_element)return;const t=e._overlay_element,r=this.ds.scale,s=this.ds.offset;let n=LiteGraph.NODE_TITLE_HEIGHT;if(!e.flags.collapsed){const u=Math.max(e.inputs?e.inputs.length:0,e.outputs?e.outputs.length:0);u>0&&!e.horizontal&&(n=LiteGraph.NODE_TITLE_HEIGHT+(u-.3)*LiteGraph.NODE_SLOT_HEIGHT)}const a=t.style.display;t.style.display="block",t.style.visibility="hidden",t.style.position="absolute",t.style.width=e.size[0]+"px",t.style.transform="";const o=t.scrollHeight;t.style.visibility="";const l=n+o+20;e.size[1]<l&&(e.size[1]=l);const h=(e.pos[0]+s[0])*r,c=(e.pos[1]+n+s[1])*r;t.style.left=h+"px",t.style.top=c+"px",t.style.width=e.size[0]+"px",t.style.height="auto",t.style.maxHeight="200px",t.style.transform=`scale(${r})`,t.style.transformOrigin="top left",t.style.display=a}updateNodeOverlays(){if(!this.graph||!this._overlay_container)return;const e=this.graph._nodes;for(let t=0;t<e.length;t++){const r=e[t];r._overlay_enabled&&r._overlay_element&&this.updateNodeOverlayPosition(r)}}ensureNodeOverlay(e){e&&!e._overlay_element&&typeof e.createPropertyOverlay=="function"&&e.createPropertyOverlay()&&this.createNodeOverlay(e)}static getFileExtension(e){const t=e.indexOf("?");t!=-1&&(e=e.substr(0,t));const r=e.lastIndexOf(".");return r==-1?"":e.substr(r+1).toLowerCase()}async enableWebGL(){var t;if(typeof GL>"u")throw"litegl.js must be included to use a WebGL canvas";if(typeof enableWebGLCanvas>"u")throw"webglCanvas.js must be included to use this feature";const e=enableWebGLCanvas(this.canvas);e instanceof WebGLRenderingContext&&(await e.loadCachedTextures(),e.cacheFontAtlas("Arial","normal"),e.cacheFontAtlas("Arial","Bold")),this.gl=e,this.ctx=e,this.bgctx=e,(t=this.gl)==null||t.viewport(0,0,this.canvas.width,this.canvas.height),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.canvas.webgl_enabled=!0}setDirty(e,t){e&&(this.dirty_canvas=!0),t&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){if(!this.canvas)return window;const e=this.canvas.ownerDocument;return e.defaultView||e.parentWindow}startRendering(){if(this.is_rendering)return;this.is_rendering=!0,e.call(this);function e(){this.pause_rendering||this.draw();const t=this.getCanvasWindow();this.is_rendering&&t.requestAnimationFrame(e.bind(this))}}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}processMouseDown(e){let t=!1;if(this.block_drag_grp=!1,this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;this.adjustMouseEvent(e);const r=this.getCanvasWindow();r.document,_LGraphCanvas.active_canvas=this;const s=e.clientX,n=e.clientY;this.ds.viewport=this.viewport;const a=!this.viewport||this.viewport&&s>=this.viewport[0]&&s<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph.pointerListenerAdd(r.document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(r.document,"up",this._mouseup_callback,!0)),!a)return;this.graph.getGroupOnPos(e.canvasX,e.canvasY)&&e.which==1&&e.altKey&&(this.move_grp_alone=!0);let l=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),h=!1;const c=LiteGraph.getTime(),u=e.isPrimary===void 0||!e.isPrimary,p=c-this.last_mouseclick<300&&u;if(this.mouse[0]=e.clientX,this.mouse[1]=e.clientY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&u?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(r),!(this.onMouse&&this.onMouse(e)==!0)){if(l||this.closePanels(),e.which==1&&!this.pointer_is_double){if(this.saveUndoStack(),e.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,h=!0),LiteGraph.alt_drag_do_clone_nodes&&e.altKey&&l&&this.allow_interaction&&!h&&!this.read_only){let d=l.clone();(d=l.clone())&&(d.pos[0]+=5,d.pos[1]+=5,this.graph.add(d,!1,{doCalcSize:!1}),l=d,h=!0,t||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=l),this.selected_nodes[l.id]||this.processNodeSelected(l,e)))}let f=!1;if(l&&(this.allow_interaction||l.flags.allow_interaction)&&!h&&!this.read_only){if(!this.live_mode&&!l.flags.pinned&&this.bringToFront(l),this.allow_interaction&&!this.connecting_node&&!l.flags.collapsed&&!this.live_mode)if(!h&&l.resizable!==!1&&LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,l.pos[0]+l.size[0]-5,l.pos[1]+l.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=l,this.canvas.style.cursor="se-resize",h=!0;else{if(l.outputs)for(let d=0,g=l.outputs.length;d<g;++d){const m=l.outputs[d],b=l.getConnectionPos(!1,d);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,b[0]-15,b[1]-10,30,20)){this.connecting_node=l,this.connecting_output=m,this.connecting_output.slot_index=d,this.connecting_pos=l.getConnectionPos(!1,d),this.connecting_slot=d,LiteGraph.shift_click_do_break_link_from&&e.shiftKey&&l.disconnectOutput(d),p?l.onOutputDblClick&&l.onOutputDblClick(d,e):l.onOutputClick&&l.onOutputClick(d,e),h=!0;break}}if(l.inputs)for(let d=0,g=l.inputs.length;d<g;++d){const m=l.inputs[d],b=l.getConnectionPos(!0,d);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,b[0]-15,b[1]-10,30,20)){if(p?l.onInputDblClick&&l.onInputDblClick(d,e):l.onInputClick&&l.onInputClick(d,e),m.link!==null){const E=this.graph.links[m.link];LiteGraph.click_do_break_link_to&&(l.disconnectInput(d),this.dirty_bgcanvas=!0,h=!0),(this.allow_reconnect_links||e.shiftKey)&&(LiteGraph.click_do_break_link_to||l.disconnectInput(d),this.connecting_node=this.graph._nodes_by_id[E.origin_id],this.connecting_slot=E.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),this.dirty_bgcanvas=!0,h=!0)}h||(this.connecting_node=l,this.connecting_input=m,this.connecting_input.slot_index=d,this.connecting_pos=l.getConnectionPos(!0,d),this.connecting_slot=d,this.dirty_bgcanvas=!0,h=!0)}}}if(!h){const d=[e.canvasX-l.pos[0],e.canvasY-l.pos[1]],g=this.processNodeWidgets(l,this.graph_mouse,e);if(g&&(t=!0,this.node_widget=[l,g]),this.allow_interaction&&p&&this.selected_nodes[l.id]&&(l.onDblClick&&l.onDblClick(e,d,this),this.processNodeDblClicked(l),t=!0),l.onMouseDown&&l.onMouseDown(e,d,this))t=!0;else{if(l.subgraph&&!l.skip_subgraph_button&&!l.flags.collapsed&&d[0]>l.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&d[1]<0){const m=this;setTimeout(function(){m.openSubgraph(l.subgraph)},10)}this.live_mode&&(f=!0,t=!0)}t?l.is_selected||this.processNodeSelected(l,e):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=l),this.processNodeSelected(l,e)),this.dirty_canvas=!0}}else if(!h){if(!this.read_only)for(let d=0;d<this.visible_links.length;++d){const g=this.visible_links[d],m=g._pos;if(!(!m||e.canvasX<m[0]-4||e.canvasX>m[0]+4||e.canvasY<m[1]-4||e.canvasY>m[1]+4)){_LGraphCanvas.showLinkMenu(g,e,this),this.over_link_center=null;break}}this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&p&&(e.preventDefault(),e.stopPropagation(),this.showGrpPanel(this.selected_group),this.block_drag_grp=!0),this.selected_group&&!this.read_only&&!p&&(this.block_drag_grp=!1,e.ctrlKey&&(this.dragging_rectangle=null),LiteGraph.distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()),f=!0}!h&&f&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else if(e.which==2)if(this.saveUndoStack(),LiteGraph.middle_click_slot_add_default_node){if(l&&this.allow_interaction&&!h&&!this.read_only&&!this.connecting_node&&!l.flags.collapsed&&!this.live_mode){let f=!1,d=!1,g=!1;if(l.outputs)for(let m=0,b=l.outputs.length;m<b;++m){const E=l.outputs[m],L=l.getConnectionPos(!1,m);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,L[0]-15,L[1]-10,30,20)){f=E,d=m,g=!0;break}}if(l.inputs)for(let m=0,b=l.inputs.length;m<b;++m){const E=l.inputs[m],L=l.getConnectionPos(!0,m);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,L[0]-15,L[1]-10,30,20)){f=E,d=m,g=!1;break}}if(f&&d!==!1){const m=.5-(d+1)/(g?l.outputs.length:l.inputs.length),b=l.getBounding(),E=[g?b[0]+b[2]:b[0],e.canvasY-80];this.createDefaultNodeForSlot({nodeFrom:g?l:null,slotFrom:g?d:null,nodeTo:g?null:l,slotTo:g?null:d,position:E,nodeType:"AUTO",posAdd:[g?30:-30,-m*130],posSizeFix:[g?0:-1,0]})}}}else!h&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else(e.which==3||this.pointer_is_double)&&(this.saveUndoStack(),this.allow_interaction&&!h&&!this.read_only&&(l&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[l.id]||e.shiftKey||e.ctrlKey||e.metaKey)?this.selected_nodes[l.id]||this.selectNodes([l],!0):this.selectNodes([l])),this.processContextMenu(l,e)));return this.last_mouse[0]=e.clientX,this.last_mouse[1]=e.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!r.document.activeElement||r.document.activeElement.nodeName.toLowerCase()!="input"&&r.document.activeElement.nodeName.toLowerCase()!="textarea")&&e.preventDefault(),e.stopPropagation(),this.onMouseDown&&this.onMouseDown(e),!1}}getGroupMenuOptions(e){return[{content:"Title",callback:_LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:_LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:_LGraphCanvas.onMenuNodeRemove}]}processMouseMove(e){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;_LGraphCanvas.active_canvas=this,this.adjustMouseEvent(e);const t=[e.clientX,e.clientY];this.mouse[0]=t[0],this.mouse[1]=t[1];const r=[t[0]-this.last_mouse[0],t[1]-this.last_mouse[1]];if(this.last_mouse=t,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.block_click)return e.preventDefault(),!1;e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0);const s=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]];else{const n=r[0]/this.ds.scale,a=r[1]/this.ds.scale;this.selected_group.move(n,a,e.ctrlKey,this.move_grp_alone),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=r[0]/this.ds.scale,this.ds.offset[1]+=r[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||s&&s.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(let n=0,a=this.graph._nodes.length;n<a;++n)this.graph._nodes[n].mouseOver&&s!=this.graph._nodes[n]&&(this.graph._nodes[n].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(e),this.node_over=null,this.dirty_canvas=!0);if(s){if(s.redraw_on_mouse&&(this.dirty_canvas=!0),s.mouseOver||(s.mouseOver=!0,this.node_over=s,this.dirty_canvas=!0,s.onMouseEnter&&s.onMouseEnter(e)),s.onMouseMove&&s.onMouseMove(e,[e.canvasX-s.pos[0],e.canvasY-s.pos[1]],this),this.connecting_node){if(this.connecting_output){const n=this._highlight_input||[0,0];if(!this.isOverNodeBox(s,e.canvasX,e.canvasY)){const a=this.isOverNodeInput(s,e.canvasX,e.canvasY,n);if(a!=-1&&s.inputs[a]){const o=s.inputs[a].type;LiteGraph.isValidConnection(this.connecting_output.type,o)&&(this._highlight_input=n,this._highlight_input_slot=s.inputs[a])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input){const n=this._highlight_output||[0,0];if(!this.isOverNodeBox(s,e.canvasX,e.canvasY)){const a=this.isOverNodeOutput(s,e.canvasX,e.canvasY,n);if(a!=-1&&s.outputs[a]){const o=s.outputs[a].type;LiteGraph.isValidConnection(this.connecting_input.type,o)&&(this._highlight_output=n)}else this._highlight_output=null}}}this.canvas&&(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,s.pos[0]+s.size[0]-5,s.pos[1]+s.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{let n=null;for(let a=0;a<this.visible_links.length;++a){const o=this.visible_links[a],l=o._pos;if(!(!l||e.canvasX<l[0]-4||e.canvasX>l[0]+4||e.canvasY<l[1]-4||e.canvasY>l[1]+4)){n=o;break}}n!=this.over_link_center&&(this.over_link_center=n,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=s&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(const n in this.selected_nodes){const a=this.selected_nodes[n];a.pos[0]+=r[0]/this.ds.scale,a.pos[1]+=r[1]/this.ds.scale,a.is_selected||this.processNodeSelected(a,e)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){const n=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]];let a=this.resizing_node.computeSize();this.resizing_node._overlay_initial_size&&(a[0]=Math.max(a[0],this.resizing_node._overlay_initial_size[0]),a[1]=Math.max(a[1],this.resizing_node._overlay_initial_size[1])),n[0]=Math.max(a[0],n[0]),n[1]=Math.max(a[1],n[1]),this.resizing_node.setSize(n),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return e.preventDefault(),!1}processMouseUp(e){const t=e.isPrimary===void 0||e.isPrimary;if(!t)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;const s=this.getCanvasWindow().document;_LGraphCanvas.active_canvas=this,this.options.skip_events||(LiteGraph.pointerListenerRemove(s,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerRemove(s,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(e);const n=LiteGraph.getTime();if(e.click_time=n-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),e.which==1){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e),this.node_widget=null,this.selected_group){const o=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),l=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(o,l,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null,this.move_grp_alone=!1}this.selected_group_resizing=!1;const a=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){const o=this.graph._nodes,l=new Float32Array(4),h=Math.abs(this.dragging_rectangle[2]),c=Math.abs(this.dragging_rectangle[3]),u=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-h:this.dragging_rectangle[0],p=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-c:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=u,this.dragging_rectangle[1]=p,this.dragging_rectangle[2]=h,this.dragging_rectangle[3]=c,!a||h>10&&c>10){const f=[];for(let d=0;d<o.length;++d){const g=o[d];g.getBounding(l),LiteGraph.overlapBounding(this.dragging_rectangle,l)&&f.push(g)}f.length&&this.selectNodes(f,e.shiftKey)}else this.selectNodes([a],e.shiftKey||e.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;const l=(this.connecting_output||this.connecting_input).type;if(a){if(this.connecting_output){const h=this.isOverNodeInput(a,e.canvasX,e.canvasY);h!=-1?this.connecting_node.connect(this.connecting_slot,a,h):this.connecting_node.connectByType(this.connecting_slot,a,l)}else if(this.connecting_input){const h=this.isOverNodeOutput(a,e.canvasX,e.canvasY);h!=-1?a.connect(h,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,a,l)}}else LiteGraph.release_link_on_empty_shows_menu&&(e.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(e,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(e,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){const o=this.node_dragged;o&&e.click_time<300&&LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,o.pos[0],o.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&o.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else!this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes)&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]])}else e.which==2?(this.dirty_canvas=!0,this.dragging_canvas=!1):e.which==3&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return t&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),e.stopPropagation(),e.preventDefault(),!1}processMouseWheel(e){if(!this.graph||!this.allow_dragcanvas)return;const t=e.wheelDeltaY!=null?e.wheelDeltaY:e.detail*-60;this.adjustMouseEvent(e);const r=e.clientX,s=e.clientY;if(!(!this.viewport||this.viewport&&r>=this.viewport[0]&&r<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3]))return;let a=this.ds.scale;return t>0?a*=1.1:t<0&&(a*=1/1.1),this.ds.changeScale(a,[e.clientX,e.clientY]),this.graph.change(),e.preventDefault(),!1}isOverNodeBox(e,t,r){const s=LiteGraph.NODE_TITLE_HEIGHT;return!!LiteGraph.isInsideRectangle(t,r,e.pos[0]+2,e.pos[1]+2-s,s-4,s-4)}isOverNodeInput(e,t,r,s){if(e.inputs)for(let n=0,a=e.inputs.length;n<a;++n){e.inputs[n];const o=e.getConnectionPos(!0,n);let l=!1;if(e.horizontal?l=LiteGraph.isInsideRectangle(t,r,o[0]-5,o[1]-10,10,20):l=LiteGraph.isInsideRectangle(t,r,o[0]-10,o[1]-5,40,10),l)return s&&(s[0]=o[0],s[1]=o[1]),n}return-1}isOverNodeOutput(e,t,r,s){if(e.outputs)for(let n=0,a=e.outputs.length;n<a;++n){e.outputs[n];const o=e.getConnectionPos(!1,n);let l=!1;if(e.horizontal?l=LiteGraph.isInsideRectangle(t,r,o[0]-5,o[1]-10,10,20):l=LiteGraph.isInsideRectangle(t,r,o[0]-10,o[1]-5,40,10),l)return s&&(s[0]=o[0],s[1]=o[1]),n}return-1}processKey(e){if(!this.graph)return;let t=!1;if(e.target.localName!="input"){if(e.type=="keydown"){this.isKeyPressed=!0,e.keyCode==32&&(this.saveUndoStack(),this.dragging_canvas=!0,t=!0),e.keyCode==27&&(this.saveUndoStack(),this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),t=!0),e.keyCode==65&&e.ctrlKey&&(this.saveUndoStack(),this.selectNodes(),t=!0),e.keyCode===67&&(e.metaKey||e.ctrlKey)&&!e.shiftKey&&this.selected_nodes&&(this.saveUndoStack(),this.copyToClipboard(),t=!0),e.keyCode===86&&(e.metaKey||e.ctrlKey)&&(this.saveUndoStack(),this.pasteFromClipboard(e.shiftKey),t=!0);const r=s=>{if(this.selected_nodes&&s.key==="ArrowUp"){this.saveUndoStackEvt();for(let n in this.selected_nodes)this.selected_nodes[n].pos[1]-=1}if(this.selected_nodes&&s.key==="ArrowDown"){this.saveUndoStackEvt();for(let n in this.selected_nodes)this.selected_nodes[n].pos[1]+=1}if(this.selected_nodes&&s.key==="ArrowLeft"){this.saveUndoStackEvt();for(let n in this.selected_nodes)this.selected_nodes[n].pos[0]-=1}if(this.selected_nodes&&s.key==="ArrowRight"){this.saveUndoStackEvt();for(let n in this.selected_nodes)this.selected_nodes[n].pos[0]+=1}};if(this.isKeyPressed?r(e):this.isKeyPressed=!1,(e.keyCode==46||e.keyCode==8)&&e.target.localName!="input"&&e.target.localName!="textarea"&&(this.saveUndoStack(),this.deleteSelectedNodes(),t=!0),this.selected_nodes)for(const s in this.selected_nodes)this.selected_nodes[s].onKeyDown&&this.selected_nodes[s].onKeyDown(e)}else if(e.type=="keyup"){if(e.keyCode==32&&(this.dragging_canvas=!1),this.selected_nodes)for(const r in this.selected_nodes)this.selected_nodes[r].onKeyUp&&this.selected_nodes[r].onKeyUp(e);e.ctrlKey&&e.key==="z"&&!this.read_only&&this.undo(),e.ctrlKey&&e.key==="y"&&!this.read_only&&this.redo()}if(this.graph.change(),t)return e.preventDefault(),e.stopImmediatePropagation(),!1}}checkObjectEqual(e,t){const r=JSON.stringify(e),s=JSON.stringify(t);return r===s}undo(){if(this.undoStack.length===0)return;const e=this.graph.serialize();this.redoStack.push(this.tempDeepClone(e));const t=this.undoStack.pop();this.graph.configure(this.tempDeepClone(t)),this.draw(!0,!0)}redo(){if(this.redoStack.length===0)return;const e=this.graph.serialize();this.undoStack.push(this.tempDeepClone(e));const t=this.redoStack.pop();this.graph.configure(this.tempDeepClone(t)),this.draw(!0,!0)}debounceTime(e,t){let r=null;return function(...s){const n=this;clearTimeout(r),r=setTimeout(()=>e.apply(n,s),t)}}tempDeepClone(e){return JSON.parse(JSON.stringify(e))}copyToClipboard(){const e={nodes:[],links:[]};let t=0;const r=[];for(const s in this.selected_nodes){const n=this.selected_nodes[s];n.clonable!==!1&&(n._relative_id=t,r.push(n),t+=1)}for(let s=0;s<r.length;++s){const n=r[s];if(n.clonable===!1)continue;const a=n.clone();if(!a){console.warn("node type not found: "+n.type);continue}if(e.nodes.push(a.serialize()),n.inputs&&n.inputs.length)for(let o=0;o<n.inputs.length;++o){const l=n.inputs[o];if(!l||l.link==null)continue;const h=this.graph.links[l.link];if(!h)continue;const c=this.graph.getNodeById(h.origin_id);c&&e.links.push([c._relative_id,h.origin_slot,n._relative_id,h.target_slot,c.id])}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(e))}pasteFromClipboard(e=!1){if(!LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&e)return;const t=localStorage.getItem("litegrapheditor_clipboard");if(!t)return;this.graph.beforeChange();const r=JSON.parse(t);let s=!1,n=!1;for(let o=0;o<r.nodes.length;++o)s?(s[0]>r.nodes[o].pos[0]&&(s[0]=r.nodes[o].pos[0],n[0]=o),s[1]>r.nodes[o].pos[1]&&(s[1]=r.nodes[o].pos[1],n[1]=o)):(s=[r.nodes[o].pos[0],r.nodes[o].pos[1]],n=[o,o]);const a=[];for(let o=0;o<r.nodes.length;++o){const l=r.nodes[o],h=LiteGraph.createNode(l.type);h&&(h.configure(l),h.pos[0]+=this.graph_mouse[0]-s[0],h.pos[1]+=this.graph_mouse[1]-s[1],this.graph.add(h,{doProcessChange:!1}),a.push(h))}for(let o=0;o<r.links.length;++o){const l=r.links[o];let h;const c=l[0];if(c!=null)h=a[c];else if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&e){const p=l[4];p&&(h=this.graph.getNodeById(p))}const u=a[l[2]];h&&u?h.connect(l[1],u,l[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(a),this.graph.afterChange()}processDrop(e){e.preventDefault(),this.adjustMouseEvent(e);const t=e.clientX,r=e.clientY;if(!(!this.viewport||this.viewport&&t>=this.viewport[0]&&t<this.viewport[0]+this.viewport[2]&&r>=this.viewport[1]&&r<this.viewport[1]+this.viewport[3]))return;const n=[e.canvasX,e.canvasY],a=this.graph?this.graph.getNodeOnPos(n[0],n[1]):null;if(!a){let o=null;this.onDropItem&&(o=this.onDropItem(event)),o||this.checkDropItem(e);return}if(a.onDropFile||a.onDropData){const o=e.dataTransfer.files;if(o&&o.length)for(let l=0;l<o.length;l++){const h=e.dataTransfer.files[0],c=h.name;if(_LGraphCanvas.getFileExtension(c),a.onDropFile&&a.onDropFile(h),a.onDropData){const u=new FileReader;u.onload=function(f){const d=f.target.result;a.onDropData(d,c,h)};const p=h.type.split("/")[0];p=="text"||p==""?u.readAsText(h):p=="image"?u.readAsDataURL(h):u.readAsArrayBuffer(h)}}}return a.onDropItem&&a.onDropItem(event)?!0:this.onDropItem?this.onDropItem(event):!1}checkDropItem(e){if(e.dataTransfer.files.length){const t=e.dataTransfer.files[0],r=_LGraphCanvas.getFileExtension(t.name).toLowerCase(),s=LiteGraph.node_types_by_file_extension[r];if(s){this.graph.beforeChange();const n=LiteGraph.createNode(s.type);n.pos=[e.canvasX,e.canvasY],this.graph.add(n),n.onDropFile&&n.onDropFile(t),this.graph.afterChange()}}}processNodeDblClicked(e){this.onShowNodePanel?this.onShowNodePanel(e):this.showShowNodePanel(e),this.onNodeDblClicked&&this.onNodeDblClicked(e),this.setDirty(!0)}processNodeSelected(e,t){this.selectNode(e,t&&(t.shiftKey||t.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(e)}selectNode(e,t){e==null?this.deselectAllNodes():this.selectNodes([e],t)}selectNodes(e,t){t||this.deselectAllNodes(),e=e||this.graph._nodes,typeof e=="string"&&(e=[e]);for(const r in e){const s=e[r];if(s.is_selected){this.deselectNode(s);continue}if(!s.is_selected&&s.onSelected&&s.onSelected(),s.is_selected=!0,this.selected_nodes[s.id]=s,s.inputs)for(let n=0;n<s.inputs.length;++n)this.highlighted_links[s.inputs[n].link]=!0;if(s.outputs)for(let n=0;n<s.outputs.length;++n){const a=s.outputs[n];if(a.links)for(let o=0;o<a.links.length;++o)this.highlighted_links[a.links[o]]=!0}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}deselectNode(e){if(e.is_selected){if(e.onDeselected&&e.onDeselected(),e.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(e),e.inputs)for(let t=0;t<e.inputs.length;++t)delete this.highlighted_links[e.inputs[t].link];if(e.outputs)for(let t=0;t<e.outputs.length;++t){const r=e.outputs[t];if(r.links)for(let s=0;s<r.links.length;++s)delete this.highlighted_links[r.links[s]]}}}deselectAllNodes(){if(!this.graph)return;const e=this.graph._nodes;for(let t=0,r=e.length;t<r;++t){const s=e[t];s.is_selected&&(s.onDeselected&&s.onDeselected(),s.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(s))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}deleteSelectedNodes(){this.graph.beforeChange();for(const e in this.selected_nodes){const t=this.selected_nodes[e];if(!t.block_delete){if(t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&LiteGraph.isValidConnection(t.inputs[0].type,t.outputs[0].type)&&t.inputs[0].link&&t.outputs[0].links&&t.outputs[0].links.length){const r=t.graph.links[t.inputs[0].link],s=t.graph.links[t.outputs[0].links[0]],n=t.getInputNode(0),a=t.getOutputNodes(0)[0];n&&a&&n.connect(r.origin_slot,a,s.target_slot)}this.graph.remove(t),this.onNodeDeselected&&this.onNodeDeselected(t)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}centerOnNode(e){this.ds.offset[0]=-e.pos[0]-e.size[0]*.5+this.canvas.width*.5/this.ds.scale,this.ds.offset[1]=-e.pos[1]-e.size[1]*.5+this.canvas.height*.5/this.ds.scale,this.setDirty(!0,!0)}adjustMouseEvent(e){let t=0,r=0;if(this.canvas){const s=this.canvas.getBoundingClientRect();t=e.clientX-s.left,r=e.clientY-s.top}else t=e.clientX,r=e.clientY;this.last_mouse_position[0]=t,this.last_mouse_position[1]=r,e.canvasX=t/this.ds.scale-this.ds.offset[0],e.canvasY=r/this.ds.scale-this.ds.offset[1]}setZoom(e,t){this.ds.changeScale(e,t),this.dirty_canvas=!0,this.dirty_bgcanvas=!0}convertOffsetToCanvas(e,t){return this.ds.convertOffsetToCanvas(e,t)}convertCanvasToOffset(e,t){return this.ds.convertCanvasToOffset(e,t)}convertEventToCanvasOffset(e){const t=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([e.clientX-t.left,e.clientY-t.top])}bringToFront(e){const t=this.graph._nodes.indexOf(e);t!=-1&&(this.graph._nodes.splice(t,1),this.graph._nodes.push(e))}sendToBack(e){const t=this.graph._nodes.indexOf(e);t!=-1&&(this.graph._nodes.splice(t,1),this.graph._nodes.unshift(e))}computeVisibleNodes(e,t){const r=new Float32Array(4),s=t||[];s.length=0,e=e||this.graph._nodes;for(let n=0,a=e.length;n<a;++n){const o=e[n];this.live_mode&&!o.onDrawBackground&&!o.onDrawForeground||o.getBounding&&LiteGraph.overlapBounding(this.visible_area,o.getBounding(r,!0))&&s.push(o)}return this.visible_nodes=s,s}draw(e,t){if(!this.canvas||this.canvas.width==0||this.canvas.height==0)return;const r=LiteGraph.getTime();this.render_time=(r-this.last_draw_time)*.001,this.last_draw_time=r,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||t||this.always_render_background||this.graph&&this.graph._last_trigger_time&&r-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||e)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}drawFrontCanvas(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));const e=this.ctx;if(!e)return;const t=this.canvas;e.start2D&&!this.viewport&&(e.start2D(),e.restore(),e.setTransform(1,0,0,1,0,0));const r=this.viewport||this.dirty_area;if(r&&(e.save(),e.beginPath(),e.rect(r[0],r[1],r[2],r[3]),e.clip()),this.clear_background&&(r?e.clearRect(r[0],r[1],r[2],r[3]):e.clearRect(0,0,t.width,t.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():e.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(t,e),this.show_info&&this.renderInfo(e,r?r[0]:0,r?r[1]:0),this.graph){e.save(),this.ds.toCanvasContext(e);const s=this.computeVisibleNodes(null,this.visible_nodes);for(let n=0;n<s.length;++n){const a=s[n];e.save(),e.translate(a.pos[0],a.pos[1]),this.drawNode(a,e),e.restore()}if(this.addNodeGuideLines(e),this.render_execution_order&&this.drawExecutionOrder(e),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(e)),this.connecting_pos!=null){e.lineWidth=this.connections_width;let n=null;const a=this.connecting_output||this.connecting_input,o=a.type;let l=a.dir;l==null&&(this.connecting_output?l=this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:l=this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT);const h=a.shape;switch(o){case LiteGraph.EVENT:n=LiteGraph.EVENT_LINK_COLOR;break;default:n=LiteGraph.CONNECTING_LINK_COLOR}if(this.renderLink(e,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,n,l,LiteGraph.CENTER),e.beginPath(),o===LiteGraph.EVENT||h===LiteGraph.BOX_SHAPE?(e.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),e.fill(),e.beginPath(),e.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):h===LiteGraph.ARROW_SHAPE?(e.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),e.closePath()):(e.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,Math.PI*2)),e.fill(),e.fillStyle="#ffcc00",this._highlight_input&&(e.beginPath(),this._highlight_input_slot.shape===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),e.closePath()):e.arc(this._highlight_input[0],this._highlight_input[1],6,0,Math.PI*2),e.fill()),this._highlight_output){let c=this._highlight_output.shape;e.beginPath(),c===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),e.closePath()):e.arc(this._highlight_output[0],this._highlight_output[1],6,0,Math.PI*2),e.fill()}}this.dragging_rectangle&&(e.strokeStyle="#FFF",e.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(e,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(e,null),this.onDrawForeground&&this.onDrawForeground(e,this.visible_rect),this.updateNodeOverlays(),e.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(e),this.onDrawOverlay&&this.onDrawOverlay(e),this.showPopover&&this.drawPopoverLine(e),r&&e.restore(),e.finish2D&&e.finish2D()}drawSubgraphPanel(e){const t=this.graph,r=t._subgraph_node;if(!r){console.warn("subgraph without subnode");return}this.drawSubgraphPanelLeft(t,r,e),this.drawSubgraphPanelRight(t,r,e)}drawSubgraphPanelLeft(e,t,r){const s=t.inputs?t.inputs.length:0,n=200,a=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);if(r.fillStyle="#111",r.globalAlpha=.8,r.beginPath(),r.roundRect(10,10,n,(s+1)*a+50,[8]),r.fill(),r.globalAlpha=1,r.fillStyle="#888",r.font="14px Arial",r.textAlign="left",r.fillText("Graph Inputs",20,34),this.drawButton(n-20,20,20,20,"X","#151515")){this.closeSubgraph();return}let o=50;if(r.font="14px Arial",t.inputs)for(let l=0;l<t.inputs.length;++l){const h=t.inputs[l];if(!h.not_subgraph_input){if(this.drawButton(20,o+2,n-20,a-2)){const c=t.constructor.input_node_type||"graph/input";this.graph.beforeChange();const u=LiteGraph.createNode(c);u?(e.add(u),this.block_click=!1,this.last_click_position=null,this.selectNodes([u]),this.node_dragged=u,this.dragging_canvas=!1,u.setProperty("name",h.name),u.setProperty("type",h.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",c)}r.fillStyle="#9C9",r.beginPath(),r.arc(n-16,o+a*.5,5,0,2*Math.PI),r.fill(),r.fillStyle="#AAA",r.fillText(h.name,30,o+a*.75),r.fillStyle="#777",r.fillText(h.type,130,o+a*.75),o+=a}}this.drawButton(20,o+2,n-20,a-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(t)}drawSubgraphPanelRight(e,t,r){const s=t.outputs?t.outputs.length:0,n=this.bgcanvas.width,a=200,o=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);r.fillStyle="#111",r.globalAlpha=.8,r.beginPath(),r.roundRect(n-a-10,10,a,(s+1)*o+50,[8]),r.fill(),r.globalAlpha=1,r.fillStyle="#888",r.font="14px Arial",r.textAlign="left";const l="Graph Outputs",h=r.measureText(l).width;if(r.fillText(l,n-h-20,34),this.drawButton(n-a,20,20,20,"X","#151515")){this.closeSubgraph();return}let c=50;if(r.font="14px Arial",t.outputs)for(let u=0;u<t.outputs.length;++u){const p=t.outputs[u];if(!p.not_subgraph_input){if(this.drawButton(n-a,c+2,a-20,o-2)){const f=t.constructor.output_node_type||"graph/output";this.graph.beforeChange();const d=LiteGraph.createNode(f);d?(e.add(d),this.block_click=!1,this.last_click_position=null,this.selectNodes([d]),this.node_dragged=d,this.dragging_canvas=!1,d.setProperty("name",p.name),d.setProperty("type",p.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",f)}r.fillStyle="#9C9",r.beginPath(),r.arc(n-a+16,c+o*.5,5,0,2*Math.PI),r.fill(),r.fillStyle="#AAA",r.fillText(p.name,n-a+30,c+o*.75),r.fillStyle="#777",r.fillText(p.type,n-a+130,c+o*.75),c+=o}}this.drawButton(n-a,c+2,a-20,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(t)}drawButton(e,t,r,s,n,a,o,l){const h=this.ctx;a=a||LiteGraph.NODE_DEFAULT_COLOR,o=o||"#555",l=l||LiteGraph.NODE_TEXT_COLOR;let c=this.ds.convertOffsetToCanvas(this.graph_mouse);const u=LiteGraph.isInsideRectangle(c[0],c[1],e,t,r,s);if(c=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null,c){const d=this.canvas.getBoundingClientRect();c[0]-=d.left,c[1]-=d.top}const p=c&&LiteGraph.isInsideRectangle(c[0],c[1],e,t,r,s);h.fillStyle=u?o:a,p&&(h.fillStyle="#AAA"),h.beginPath(),h.roundRect(e,t,r,s,[4]),h.fill(),n!=null&&n.constructor==String&&(h.fillStyle=l,h.textAlign="center",h.font=(s*.65|0)+"px Arial",h.fillText(n,e+r*.5,t+s*.75),h.textAlign="left");const f=p&&!this.block_click;return p&&this.blockClick(),f}isAreaClicked(e,t,r,s,n){let a=this.mouse;LiteGraph.isInsideRectangle(a[0],a[1],e,t,r,s),a=this.last_click_position;const o=a&&LiteGraph.isInsideRectangle(a[0],a[1],e,t,r,s),l=o&&!this.block_click;return o&&n&&this.blockClick(),l}renderInfo(e,t,r){var a,o;t=t||10,r=r||this.canvas.height-80;const s=((a=this.visible_nodes)==null?void 0:a.length)||0,n=((o=this.graph._nodes)==null?void 0:o.length)||0;e.save(),e.translate(t,r),e.font="10px Arial",e.fillStyle="#888",e.textAlign="left",this.graph?(e.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13*1),e.fillText("I: "+this.graph.iteration,5,13*2),e.fillText("N: "+n+" ["+s+"]",5,13*3),e.fillText("V: "+this.graph._version,5,13*4),e.fillText("FPS:"+this.fps.toFixed(2),5,13*5)):e.fillText("No graph selected",5,13*1),e.restore()}drawBackCanvas(){const e=this.bgcanvas;(e.width!=this.canvas.width||e.height!=this.canvas.height)&&(e.width=this.canvas.width,e.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));const t=this.bgctx;t.start&&t.start();const r=this.viewport||[0,0,t.canvas.width,t.canvas.height];if(this.clear_background&&t.clearRect(r[0],r[1],r[2],r[3]),this._graph_stack&&this._graph_stack.length){t.save(),this._graph_stack[this._graph_stack.length-1];const n=this.graph._subgraph_node;t.strokeStyle=n.bgcolor,t.lineWidth=10,t.strokeRect(1,1,e.width-2,e.height-2),t.lineWidth=1,t.font="40px Arial",t.textAlign="center",t.fillStyle=n.bgcolor||"#AAA";let a="";for(let o=1;o<this._graph_stack.length;++o)a+=this._graph_stack[o]._subgraph_node.getTitle()+" >> ";t.fillText(a+n.getTitle(),e.width*.5,40),t.restore()}let s=!1;if(this.onRenderBackground&&(s=this.onRenderBackground(e,t)),this.viewport||(t.restore(),t.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(t.save(),this.ds.toCanvasContext(t),this.ds.scale<1.5&&!s&&this.clear_background_color&&(t.fillStyle=this.clear_background_color,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!s){if(this.zoom_modify_alpha?t.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:t.globalAlpha=this.editor_alpha,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;const a=this;this._bg_img.onload=function(){a.draw(!0,!0)}}let n=null;this._pattern==null&&this._bg_img.width>0?(n=t.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=n):n=this._pattern,n&&(t.fillStyle=n,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),t.fillStyle="transparent"),t.globalAlpha=1,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(e,t),this.onDrawBackground&&this.onDrawBackground(t,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(t.strokeStyle="#235",t.strokeRect(0,0,e.width,e.height)),this.render_connections_shadows?(t.shadowColor="#000",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=6):t.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(t),t.shadowColor="rgba(0,0,0,0)",t.restore()}t.finish&&t.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(e,t){var m;const r=new Float32Array(2);this.current_node=e;const s=e.color||e.constructor.color||LiteGraph.NODE_DEFAULT_COLOR;let n=e.bgcolor||e.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR;e.mouseOver;const a=this.ds.scale<.6;if(this.live_mode){e.flags.collapsed||(t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas));return}const o=this.editor_alpha;if(t.globalAlpha=o,this.render_shadows&&!a?(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,t.shadowOffsetX=2*this.ds.scale,t.shadowOffsetY=2*this.ds.scale,t.shadowBlur=3*this.ds.scale):t.shadowColor="transparent",e.flags.collapsed&&e.onDrawCollapsed&&e.onDrawCollapsed(t,this)==!0)return;const l=e._shape||LiteGraph.BOX_SHAPE,h=r;r.set(e.size);const c=e.horizontal;if(e.flags.collapsed){t.font=this.inner_text_font;const b=e.getTitle?e.getTitle():e.title;b!=null&&(e._collapsed_width=Math.min(e.size[0],t.measureText(b).width+LiteGraph.NODE_TITLE_HEIGHT*2),h[0]=e._collapsed_width,h[1]=0)}e.clip_area&&(t.save(),t.beginPath(),l==LiteGraph.BOX_SHAPE?t.rect(0,0,h[0],h[1]):l==LiteGraph.ROUND_SHAPE?t.roundRect(0,0,h[0],h[1],[10]):l==LiteGraph.CIRCLE_SHAPE&&t.arc(h[0]*.5,h[1]*.5,h[0]*.5,0,Math.PI*2),t.clip()),e.has_errors&&(n="red"),this.drawNodeShape(e,t,h,s,n,e.is_selected,e.mouseOver),t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas),t.textAlign=c?"center":"left",t.font=this.inner_text_font;const u=!a,p=this.connecting_output,f=this.connecting_input;t.lineWidth=1;let d=0;const g=new Float32Array(2);if(e.flags.collapsed){if(this.render_collapsed_slots){let b=null,E=null;if(e.inputs)for(let L=0;L<e.inputs.length;L++){const T=e.inputs[L];if(T.link!=null){b=T;break}}if(e.outputs)for(let L=0;L<e.outputs.length;L++){const T=e.outputs[L];T.links&&T.links.length&&(E=T)}if(b){let L=0,T=LiteGraph.NODE_TITLE_HEIGHT*-.5;c&&(L=e._collapsed_width*.5,T=-LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#686",t.beginPath(),b.type===LiteGraph.EVENT||b.shape===LiteGraph.BOX_SHAPE?t.rect(L-7+.5,T-4,14,8):b.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(L+8,T),t.lineTo(L-4,T-4),t.lineTo(L-4,T+4),t.closePath()):t.arc(L,T,4,0,Math.PI*2),t.fill()}if(E){let L=e._collapsed_width,T=LiteGraph.NODE_TITLE_HEIGHT*-.5;c&&(L=e._collapsed_width*.5,T=0),t.fillStyle="#686",t.strokeStyle="black",t.beginPath(),E.type===LiteGraph.EVENT||E.shape===LiteGraph.BOX_SHAPE?t.rect(L-7+.5,T-4,14,8):E.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(L+6,T),t.lineTo(L-6,T-4),t.lineTo(L-6,T+4),t.closePath()):t.arc(L,T,4,0,Math.PI*2),t.fill()}}}else{if(e.inputs)for(let b=0;b<e.inputs.length;b++){const E=e.inputs[b],L=E.type;let T=E.shape;t.globalAlpha=o,this.connecting_output&&!LiteGraph.isValidConnection(E.type,p.type)&&(t.globalAlpha=.4*o),t.fillStyle=E.link!=null?E.color_on||this.default_connection_color_byType[L]||this.default_connection_color.input_on:E.color_off||this.default_connection_color_byTypeOff[L]||this.default_connection_color_byType[L]||this.default_connection_color.input_off;const _=e.getConnectionPos(!0,b,g);if(_[0]-=e.pos[0],_[1]-=e.pos[1],d<_[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(d=_[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),t.beginPath(),L=="array"&&(T=LiteGraph.GRID_SHAPE),E.type===LiteGraph.EVENT||E.shape===LiteGraph.BOX_SHAPE?c?t.rect(_[0]-5+.5,_[1]-8+.5,10,14):t.rect(_[0]-6+.5,_[1]-5+.5,14,10):T===LiteGraph.ARROW_SHAPE?(t.moveTo(_[0]+8,_[1]+.5),t.lineTo(_[0]-4,_[1]+6+.5),t.lineTo(_[0]-4,_[1]-6+.5),t.closePath()):T===LiteGraph.GRID_SHAPE?(t.rect(_[0]-4,_[1]-4,2,2),t.rect(_[0]-1,_[1]-4,2,2),t.rect(_[0]+2,_[1]-4,2,2),t.rect(_[0]-4,_[1]-1,2,2),t.rect(_[0]-1,_[1]-1,2,2),t.rect(_[0]+2,_[1]-1,2,2),t.rect(_[0]-4,_[1]+2,2,2),t.rect(_[0]-1,_[1]+2,2,2),t.rect(_[0]+2,_[1]+2,2,2)):a?t.rect(_[0]-4,_[1]-4,8,8):t.arc(_[0],_[1],4,0,Math.PI*2),t.fill(),u){const I=E.label!=null?E.label:E.name;I&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,c||E.dir==LiteGraph.UP?t.fillText(I,_[0],_[1]-10):this.options.useWebgl?t.fillText(I,_[0]+10,_[1]+2):t.fillText(I,_[0]+10,_[1]+5))}}if(t.textAlign=c?"center":"right",t.strokeStyle="black",e.outputs)for(let b=0;b<e.outputs.length;b++){const E=e.outputs[b],L=E.type;let T=E.shape;this.connecting_input&&!LiteGraph.isValidConnection(L,f.type)&&(t.globalAlpha=.4*o);const _=e.getConnectionPos(!1,b,g);_[0]-=e.pos[0],_[1]-=e.pos[1],d<_[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(d=_[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),t.fillStyle=E.links&&E.links.length?E.color_on||this.default_connection_color_byType[L]||this.default_connection_color.output_on:E.color_off||this.default_connection_color_byTypeOff[L]||this.default_connection_color_byType[L]||this.default_connection_color.output_off,t.beginPath(),L=="array"&&(T=LiteGraph.GRID_SHAPE);let I=!0;if(L===LiteGraph.EVENT||T===LiteGraph.BOX_SHAPE?c?t.rect(_[0]-5+.5,_[1]-8+.5,10,14):t.rect(_[0]-6+.5,_[1]-5+.5,14,10):T===LiteGraph.ARROW_SHAPE?(t.moveTo(_[0]+8,_[1]+.5),t.lineTo(_[0]-4,_[1]+6+.5),t.lineTo(_[0]-4,_[1]-6+.5),t.closePath()):T===LiteGraph.GRID_SHAPE?(t.rect(_[0]-4,_[1]-4,2,2),t.rect(_[0]-1,_[1]-4,2,2),t.rect(_[0]+2,_[1]-4,2,2),t.rect(_[0]-4,_[1]-1,2,2),t.rect(_[0]-1,_[1]-1,2,2),t.rect(_[0]+2,_[1]-1,2,2),t.rect(_[0]-4,_[1]+2,2,2),t.rect(_[0]-1,_[1]+2,2,2),t.rect(_[0]+2,_[1]+2,2,2),I=!1):a?t.rect(_[0]-4,_[1]-4,8,8):t.arc(_[0],_[1],4,0,Math.PI*2),t.fill(),!a&&I&&t.stroke(),u){const A=E.label!=null?E.label:E.name;if(A)if(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,c||E.dir==LiteGraph.DOWN)t.fillText(A,_[0],_[1]-8);else if(this.options.useWebgl){t.textBaseline="middle";const M=((m=t.measureText(A))==null?void 0:m.width)||0;t.fillText(A,_[0]-M-10,_[1]+2)}else t.fillText(A,_[0]-10,_[1]+5)}}if(t.textAlign="left",t.globalAlpha=1,e.widgets){let b=d;(c||e.widgets_up)&&(b=2),e.widgets_start_y!=null&&(b=e.widgets_start_y),this.drawNodeWidgets(e,b,t,this.node_widget&&this.node_widget[0]==e?this.node_widget[1]:null)}}e.clip_area&&t.restore(),t.globalAlpha=1}drawLinkTooltip(e,t){const r=t._pos;if(e.fillStyle="black",e.beginPath(),e.arc(r[0],r[1],3,0,Math.PI*2),e.fill(),t.data==null||this.onDrawLinkTooltip&&this.onDrawLinkTooltip(e,t,this)==!0)return;const s=t.data;let n=null;if(s.constructor===Number?n=s.toFixed(2):s.constructor===String?n='"'+s+'"':s.constructor===Boolean?n=String(s):s.toToolTip?n=s.toToolTip():n="["+s.constructor.name+"]",n==null)return;n=n.substr(0,30),e.font="14px Courier New";const o=e.measureText(n).width+20,l=24;e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=3,e.fillStyle="#454",e.beginPath(),e.roundRect(r[0]-o*.5,r[1]-15-l,o,l,[3]),e.moveTo(r[0]-10,r[1]-15),e.lineTo(r[0]+10,r[1]-15),e.lineTo(r[0],r[1]-5),e.fill(),e.shadowColor="transparent",e.textAlign="center",e.fillStyle="#CEC",e.fillText(n,r[0],r[1]-15-l*.3)}drawNodeShape(e,t,r,s,n,a,o){const l=new Float32Array(4);t.strokeStyle=s,t.fillStyle=n;const h=LiteGraph.NODE_TITLE_HEIGHT,c=this.ds.scale<.5,u=e._shape||e.constructor.shape||LiteGraph.ROUND_SHAPE,p=e.constructor.title_mode;let f=!0;p==LiteGraph.TRANSPARENT_TITLE||p==LiteGraph.NO_TITLE?f=!1:p==LiteGraph.AUTOHIDE_TITLE&&o&&(f=!0);const d=l;d[0]=0,d[1]=f?-h:0,d[2]=r[0]+1,d[3]=f?r[1]+h:r[1];const g=t.globalAlpha;if(t.beginPath(),u==LiteGraph.BOX_SHAPE||c?t.fillRect(d[0],d[1],d[2],d[3]):u==LiteGraph.ROUND_SHAPE||u==LiteGraph.CARD_SHAPE?t.roundRect(d[0],d[1],d[2],d[3],u==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):u==LiteGraph.CIRCLE_SHAPE&&t.arc(r[0]*.5,r[1]*.5,r[0]*.5,0,Math.PI*2),t.fill(),!e.flags.collapsed&&f&&(t.shadowColor="transparent",t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(0,-1,d[2],2)),t.shadowColor="transparent",e.onDrawBackground&&e.onDrawBackground(t,this,this.canvas,this.graph_mouse),f||p==LiteGraph.TRANSPARENT_TITLE){if(e.onDrawTitleBar)e.onDrawTitleBar(t,h,r,this.ds.scale,s);else if(p!=LiteGraph.TRANSPARENT_TITLE&&(e.constructor.title_color||this.render_title_colored)){const E=e.constructor.title_color||s;if(e.flags.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients){let L=_LGraphCanvas.gradients[E];L||(L=_LGraphCanvas.gradients[E]=t.createLinearGradient(0,0,400,0),L.addColorStop(0,E),L.addColorStop(1,"#000")),t.fillStyle=L}else t.fillStyle=E;t.beginPath(),u==LiteGraph.BOX_SHAPE||c?t.rect(0,-h,r[0]+1,h):(u==LiteGraph.ROUND_SHAPE||u==LiteGraph.CARD_SHAPE)&&t.roundRect(0,-h,r[0]+1,h,e.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),t.fill(),t.shadowColor="transparent"}let m=!1;LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[e.mode]&&(m=LiteGraph.NODE_MODES_COLORS[e.mode]),LiteGraph.node_box_coloured_when_on&&(m=e.action_triggered?"#FFF":e.execute_triggered?"#AAA":m);const b=10;if(e.onDrawTitleBox?e.onDrawTitleBox(t,h,r,this.ds.scale):u==LiteGraph.ROUND_SHAPE||u==LiteGraph.CIRCLE_SHAPE||u==LiteGraph.CARD_SHAPE?(c&&(t.fillStyle="black",t.beginPath(),t.arc(h*.5,h*-.5,b*.5+1,0,Math.PI*2),t.fill()),t.fillStyle=e.boxcolor||m||LiteGraph.NODE_DEFAULT_BOXCOLOR,c?t.fillRect(h*.5-b*.5,h*-.5-b*.5,b,b):(t.beginPath(),t.arc(h*.5,h*-.5,b*.5,0,Math.PI*2),t.fill())):(c&&(t.fillStyle="black",t.fillRect((h-b)*.5-1,(h+b)*-.5-1,b+2,b+2)),t.fillStyle=e.boxcolor||m||LiteGraph.NODE_DEFAULT_BOXCOLOR,t.fillRect((h-b)*.5,(h+b)*-.5,b,b)),t.globalAlpha=g,e.onDrawTitleText&&e.onDrawTitleText(t,h,r,this.ds.scale,this.title_text_font,a),!c){t.font=this.title_text_font;const E=String(e.getTitle());E&&(a?t.fillStyle=LiteGraph.NODE_SELECTED_TITLE_COLOR:t.fillStyle=e.constructor.title_text_color||this.node_title_color,e.flags.collapsed?(t.textAlign="left",t.measureText(E),t.fillText(E.substr(0,20),h,LiteGraph.NODE_TITLE_TEXT_Y-h),t.textAlign="left"):(t.textAlign="left",t.fillText(E,h,LiteGraph.NODE_TITLE_TEXT_Y-h)))}if(!e.flags.collapsed&&e.subgraph&&!e.skip_subgraph_button){const E=LiteGraph.NODE_TITLE_HEIGHT,L=e.size[0]-E,T=LiteGraph.isInsideRectangle(this.graph_mouse[0]-e.pos[0],this.graph_mouse[1]-e.pos[1],L+2,-E+2,E-4,E-4);t.fillStyle=T?"#888":"#555",u==LiteGraph.BOX_SHAPE||c?t.fillRect(L+2,-E+2,E-4,E-4):(t.beginPath(),t.roundRect(L+2,-E+2,E-4,E-4,[4]),t.fill()),t.fillStyle="#333",t.beginPath(),t.moveTo(L+E*.2,-E*.6),t.lineTo(L+E*.8,-E*.6),t.lineTo(L+E*.5,-E*.3),t.fill()}e.onDrawTitle&&e.onDrawTitle(t)}a&&(e.onBounding&&e.onBounding(d),p==LiteGraph.TRANSPARENT_TITLE&&(d[1]-=h,d[3]+=h),t.lineWidth=1,t.globalAlpha=.8,t.beginPath(),u==LiteGraph.BOX_SHAPE?t.rect(-6+d[0],-6+d[1],12+d[2],12+d[3]):u==LiteGraph.ROUND_SHAPE||u==LiteGraph.CARD_SHAPE&&e.flags.collapsed?t.roundRect(-6+d[0],-6+d[1],12+d[2],12+d[3],[this.round_radius*2]):u==LiteGraph.CARD_SHAPE?t.roundRect(-6+d[0],-6+d[1],12+d[2],12+d[3],[this.round_radius*2,2,this.round_radius*2,2]):u==LiteGraph.CIRCLE_SHAPE&&t.arc(r[0]*.5,r[1]*.5,r[0]*.5+6,0,Math.PI*2),t.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,t.stroke(),t.strokeStyle=s,t.globalAlpha=1),e.execute_triggered>0&&e.execute_triggered--,e.action_triggered>0&&e.action_triggered--}drawConnections(e){const t=new Float32Array(4),r=new Float32Array(4),s=new Float32Array(2),n=new Float32Array(2),a=LiteGraph.getTime(),o=this.visible_area;t[0]=o[0]-20,t[1]=o[1]-20,t[2]=o[2]+40,t[3]=o[3]+40,e.lineWidth=this.connections_width,e.fillStyle="#AAA",e.strokeStyle="#AAA",e.globalAlpha=this.editor_alpha;const l=this.graph._nodes;for(let h=0,c=l.length;h<c;++h){const u=l[h];if(!(!u.inputs||!u.inputs.length))for(let p=0;p<u.inputs.length;++p){const f=u.inputs[p];if(!f||f.link==null)continue;const d=f.link,g=this.graph.links[d];if(!g)continue;const m=this.graph.getNodeById(g.origin_id);if(m==null)continue;let b=g.origin_slot,E=null;b==-1?E=[m.pos[0]+10,m.pos[1]+10]:E=m.getConnectionPos(!1,b,s);const L=u.getConnectionPos(!0,p,n);if(r[0]=E[0],r[1]=E[1],r[2]=L[0]-E[0],r[3]=L[1]-E[1],r[2]<0&&(r[0]+=r[2],r[2]=Math.abs(r[2])),r[3]<0&&(r[1]+=r[3],r[3]=Math.abs(r[3])),!LiteGraph.overlapBounding(r,t))continue;const T=m.outputs[b],_=u.inputs[p];if(!T||!_)continue;const I=T.dir||(m.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),A=_.dir||(u.horizontal?LiteGraph.UP:LiteGraph.LEFT);if(this.ALWAYS_FLOW)this.renderLink(e,E,L,g,!0,1,"white",I,A);else if(this.renderLink(e,E,L,g,!1,0,null,I,A),g&&g._last_time&&a-g._last_time<1e3){const M=2-(a-g._last_time)*.002,O=e.globalAlpha;e.globalAlpha=O*M,this.renderLink(e,E,L,g,!0,M,"white",I,A),e.globalAlpha=O}}}e.globalAlpha=1}showGrpPanel(e){this.closePanels();const t=this.getCanvasWindow(),r=this,s=this.createPanel(e.title||"",{closable:!0,window:t,onOpen:function(){r.NODEPANEL_IS_OPEN=!0},onClose:function(){r.NODEPANEL_IS_OPEN=!1,r.node_panel=null}});r.node_panel=s,s.id="node-panel",s.node=e,s.classList.add("settings");function n(){s.content.innerHTML="",s.addHTML("<h4>Attributes</h4>","panel-section");const a=(o,l)=>{switch(r.graph.beforeChange(e),r.saveUndoStack(),o){case"Title":e.title=l;break;case"Color":_LGraphCanvas.node_colors[l]?e.color=_LGraphCanvas.node_colors[l].groupcolor:console.warn("unexpected color: "+l);break;case"X":e.move(parseInt(l)-e.pos[0],0);break;case"Y":e.move(0,parseInt(l)-e.pos[1]);break;case"Width":e.size[0]=parseInt(l);break;case"Height":e.size[1]=parseInt(l);break}r.graph.afterChange(),r.dirty_canvas=!0};s.addWidget("string","Title",e.title,{},a),e.id&&s.addWidget("string","Group ID",e.id,{},a),e.status&&s.addWidget("string","Status",e.status,{disabled:!0},a),s.addWidget("number","X",e.pos[0],{min:0},a),s.addWidget("number","Y",e.pos[1],{min:0},a),s.addWidget("number","Width",e.size[0],{min:0},a),s.addWidget("number","Height",e.size[1],{min:0},a),s.addSeparator()}n(),this.canvas.parentNode.appendChild(s)}drawGuideLines(e,{roundX:t,roundY:r,roundWidth:s,roundHeight:n,otherRoundX:a,otherRoundY:o,otherRoundWidth:l,otherRoundHeight:h}){l===s&&(e.beginPath(),e.moveTo(t,r-10),e.lineTo(t,r+n+10),e.stroke(),e.beginPath(),e.moveTo(t+ +s,r-10),e.lineTo(t+s,r+n+10),e.stroke(),e.beginPath(),e.moveTo(a,o-10),e.lineTo(a,o+h+10),e.stroke(),e.beginPath(),e.moveTo(a+l,o-10),e.lineTo(a+l,o+h+10),e.stroke()),h===n&&(e.beginPath(),e.moveTo(t-10,r),e.lineTo(t+s+10,r),e.stroke(),e.beginPath(),e.moveTo(t-10,r+n),e.lineTo(t+s+10,r+n),e.stroke(),e.beginPath(),e.moveTo(a-10,o),e.lineTo(a+l+10,o),e.stroke(),e.beginPath(),e.moveTo(a-10,o+h),e.lineTo(a+l+10,o+h),e.stroke()),a===t&&(r<o?(e.beginPath(),e.moveTo(t,r),e.lineTo(a,o+h),e.stroke()):(e.beginPath(),e.moveTo(a,o),e.lineTo(t,r+n),e.stroke())),a+l===t+s&&(r<o?(e.beginPath(),e.moveTo(t+s,r),e.lineTo(a+l,o+h),e.stroke()):(e.beginPath(),e.moveTo(a+l,o),e.lineTo(t+s,r+n),e.stroke())),o===r&&(t<a?(e.beginPath(),e.moveTo(t,r),e.lineTo(a+l,o),e.stroke()):(e.beginPath(),e.moveTo(a,o),e.lineTo(t+s,r),e.stroke())),o+h===r+n&&(t<a?(e.beginPath(),e.moveTo(t,r+n),e.lineTo(a+l,o+h),e.stroke()):(e.beginPath(),e.moveTo(a,o+h),e.lineTo(t+s,r+n),e.stroke()))}drawGroups(e,t){var s,n,a,o,l;if(!this.graph)return;const r=this.graph._groups;t.save(),t.globalAlpha=.5*this.editor_alpha;for(let h=0;h<r.length;++h){const c=r[h];if(!LiteGraph.overlapBounding(this.visible_area,c._bounding))continue;const u=c._pos,p=c._size,f=c.color||_LGraphCanvas.node_colors.black.groupcolor;t.fillStyle=f,t.globalAlpha=.75,t.beginPath();const d=10;t.fillStyle=f||"#333",t.beginPath(),t.moveTo(u[0]+d,u[1]),t.lineTo(u[0]+p[0]-d,u[1]),t.quadraticCurveTo(u[0]+p[0],u[1],u[0]+p[0],u[1]+d),t.lineTo(u[0]+p[0],u[1]+p[1]-d),t.quadraticCurveTo(u[0]+p[0],u[1]+p[1],u[0]+p[0]-d,u[1]+p[1]),t.lineTo(u[0]+d,u[1]+p[1]),t.quadraticCurveTo(u[0],u[1]+p[1],u[0],u[1]+p[1]-d),t.lineTo(u[0],u[1]+d),t.quadraticCurveTo(u[0],u[1],u[0]+d,u[1]),t.closePath(),t.fill(),this.read_only||(t.fillStyle="#0085FF",t.beginPath(),t.moveTo(u[0]+p[0]-7,u[1]+p[1]),t.lineTo(u[0]+p[0],u[1]+p[1]),t.lineTo(u[0]+p[0],u[1]+p[1]-7),t.closePath(),t.fill());const g=LiteGraph.DEFAULT_GROUP_FONT_SIZE||20,m=c.font_size||g;if(t.fillStyle="#ffffff",t.font="Bold "+m+"px Arial",t.textAlign="left",t.fillText(c.title,u[0]+12,u[1]+m+8),!this.read_only){const b=c.font_size*.6;t.font=`${b}px Arial`,t.fillStyle="#c6c6c6";const E=`x / y /  / : ${parseInt(c.pos[0])} /${parseInt(c.pos[1])}/${parseInt(c.size[0])}/${parseInt(c.size[1])}`;let L="";for(let T=0;T<E.length;T++){const _=L+E[T]+"";if(t.measureText(_).width>c.size[0]-30&&T>0){L=L.slice(0,L.length-2),L+=" ..";break}else L=_}t.fillText(L,u[0]+10,u[1]+c.size[1]-12)}if(this.selected_group&&(c==null?void 0:c.id)!==((s=this.selected_group)==null?void 0:s.id)&&!this.read_only){t.strokeStyle="#c4c4c4",t.lineWidth=1;const b=(n=this.selected_group)==null?void 0:n.size[0],E=(a=this.selected_group)==null?void 0:a.size[1],L=(o=this.selected_group)==null?void 0:o.pos[0],T=(l=this.selected_group)==null?void 0:l.pos[1],_=c.size[0],I=c.size[1],A=c.pos[0],M=c.pos[1],O=Math.round(L),C=Math.round(T),P=Math.round(b),N=Math.round(E),k=Math.round(A),B=Math.round(M),S=Math.round(_),U=Math.round(I);this.drawGuideLines(t,{roundX:O,roundY:C,roundWidth:P,roundHeight:N,otherRoundX:k,otherRoundY:B,otherRoundWidth:S,otherRoundHeight:U})}}t.restore()}scaleFit(){this.canvas&&(this.ds.scale=1,this.ds.max_scale=1,this.ds.min_scale=1,window.innerWidth>=3840&&(this.ds.scale=2,this.ds.max_scale=2,this.ds.min_scale=2))}checkLineSegmentIntersectsRect(e,t,r,s=10){const[n,a,o,l]=r,h=n-s,c=n+o+s,u=a-s,p=a+l+s,f=e[0],d=e[1],g=t[0],m=t[1],b=(O,C)=>{let P=0;return O<h?P|=1:O>c&&(P|=2),C<u?P|=4:C>p&&(P|=8),P};let E=b(f,d),L=b(g,m);if(E&L)return!1;if(!E||!L)return!0;let T=0,_=1;const I=g-f,A=m-d,M=(O,C)=>{if(O===0)return C>=0;const P=C/O;if(O<0){if(P>_)return!1;P>T&&(T=P)}else{if(P<T)return!1;P<_&&(_=P)}return!0};return!!(M(-I,f-h)&&M(I,c-f)&&M(-A,d-u)&&M(A,p-d))}findObstructingNodes(e,t,r){if(!this.graph||!r)return[];const s=[],n=this.graph._nodes,a=r.origin_id,o=r.target_id,l=LiteGraph.RIGHT,h=LiteGraph.LEFT,c=this.computeDefaultPath(e,t,l,h);console.log("[DEBUG] Checking obstruction for link",r.id,"with",n.length,"nodes"),console.log("[DEBUG] Path points:",c);for(let u=0;u<n.length;u++){const p=n[u];if(p.id===a||p.id===o)continue;const f=[p.pos[0],p.pos[1],p.size[0],p.size[1]];let d=!1;for(let g=0;g<c.length-1;g++)if(this.checkLineSegmentIntersectsRect(c[g],c[g+1],f)){d=!0,console.log("[DEBUG] Node",p.id,p.title,"obstructs segment",g);break}d&&s.push(p)}return console.log("[DEBUG] Found",s.length,"obstructing nodes"),s}computeAvoidancePath(e,t,r,s,n){if(!r||r.length===0)return this.computeDefaultPath(e,t,s,n);const a=15,o=[e];let l=[...e];for(let h=0;h<r.length;h++){const c=r[h],u=[c.pos[0]-a,c.pos[1]-a,c.size[0]+a*2,c.size[1]+a*2],p=u[1],f=u[1]+u[3],d=u[0],g=u[0]+u[2],m=Math.abs(l[1]-p),b=Math.abs(l[1]-f),L=m<b?p:f,T=Math.abs(l[0]-d),_=Math.abs(l[0]-g);if(Math.min(T,_)<Math.min(m,b)){const A=T<_?d:g;o.push([A,l[1]]),o.push([A,t[1]])}else o.push([l[0],L]),o.push([t[0],L]);l=o[o.length-1]}return o.push(t),o}computeDefaultPath(e,t,r,s){const n=[];let a=e[0],o=e[1],l=t[0],h=t[1];r==LiteGraph.RIGHT?a+=10:r==LiteGraph.LEFT?a-=10:r==LiteGraph.DOWN?o+=10:r==LiteGraph.UP&&(o-=10),s==LiteGraph.LEFT?l-=10:s==LiteGraph.RIGHT?l+=10:s==LiteGraph.UP?h-=10:s==LiteGraph.DOWN&&(h+=10);const c=(a+l)*.5;return n.push([e[0],e[1]]),n.push([a,o]),n.push([c,o]),n.push([c,h]),n.push([l,h]),n.push([t[0],t[1]]),n}renderLink(e,t,r,s,n,a,o,l,h,c){if(o="#3b3b3b",s){const f=this.graph.getNodeById(s.origin_id),d=this.graph.getNodeById(s.target_id),g=f.properties.status,m=d.properties.status,b=f.properties.resultIndex;typeof b=="number"&&s.origin_slot===b&&(g===1&&m===1?o="#34c38f":g===-1||m===-1?o="#f46a6a":(g===0||m===0)&&(o="#3b3b3b"))}s&&this.visible_links.push(s),!o&&s&&(o=s.color||_LGraphCanvas.link_type_colors[s.type]),o||(o=this.default_link_color),s!=null&&this.highlighted_links[s.id]&&(o="#FFF"),l=l||LiteGraph.RIGHT,h=h||LiteGraph.LEFT;const u=LiteGraph.distance(t,r);this.render_connections_border&&this.ds.scale>.6&&(e.lineWidth=this.connections_width+4),e.lineJoin="round",c=c||1,c>1&&(e.lineWidth=.5),e.beginPath();for(let f=0;f<c;f+=1){const d=(f-(c-1)*.5)*5;if(this.links_render_mode==LiteGraph.SPLINE_LINK){e.moveTo(t[0],t[1]+d);let g=0,m=0,b=0,E=0;switch(l){case LiteGraph.LEFT:g=u*-.25;break;case LiteGraph.RIGHT:g=u*.25;break;case LiteGraph.UP:m=u*-.25;break;case LiteGraph.DOWN:m=u*.25;break}switch(h){case LiteGraph.LEFT:b=u*-.25;break;case LiteGraph.RIGHT:b=u*.25;break;case LiteGraph.UP:E=u*-.25;break;case LiteGraph.DOWN:E=u*.25;break}e.bezierCurveTo(t[0]+g,t[1]+m+d,r[0]+b,r[1]+E+d,r[0],r[1]+d)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){e.moveTo(t[0],t[1]+d);let g=0,m=0,b=0,E=0;switch(l){case LiteGraph.LEFT:g=u*-.25;break;case LiteGraph.RIGHT:g=u*.25;break;case LiteGraph.UP:m=u*-.25;break;case LiteGraph.DOWN:m=u*.25;break}switch(h){case LiteGraph.LEFT:b=u*-.25;break;case LiteGraph.RIGHT:b=u*.25;break;case LiteGraph.UP:E=u*-.25;break;case LiteGraph.DOWN:E=u*.25;break}e.lineTo(t[0]+g,t[1]+m+d),e.lineTo(r[0]+b,r[1]+E+d),e.lineTo(r[0],r[1]+d)}else if(this.links_render_mode==LiteGraph.STRAIGHT_LINK){e.moveTo(t[0],t[1]);let g;if(s){const m=this.findObstructingNodes(t,r,s);g=this.computeAvoidancePath(t,r,m,l,h)}else g=this.computeDefaultPath(t,r,l,h);for(let m=1;m<g.length;m++)e.lineTo(g[m][0],g[m][1]+d)}else return}this.render_connections_border&&this.ds.scale>.6&&!n&&(e.strokeStyle="rgba(0,0,0,0.5)",e.stroke()),e.lineWidth=this.connections_width,e.fillStyle=e.strokeStyle=o,e.stroke();let p=this.links_render_mode===LiteGraph.STRAIGHT_LINK?this.computeStraightLinkPoint(t,r,.5,l,h):this.computeConnectionPoint(t,r,.5,l,h);if(s&&s._pos&&(s._pos[0]=p[0],s._pos[1]=p[1]),this.ds.scale>=.6&&this.highquality_render&&h!=LiteGraph.CENTER&&!this.read_only){if(this.render_connection_arrows){const f=this.computeConnectionPoint(t,r,.25,l,h),d=this.computeConnectionPoint(t,r,.26,l,h),g=this.computeConnectionPoint(t,r,.75,l,h),m=this.computeConnectionPoint(t,r,.76,l,h);let b=0,E=0;this.render_curved_connections?(b=-Math.atan2(d[0]-f[0],d[1]-f[1]),E=-Math.atan2(m[0]-g[0],m[1]-g[1])):E=b=r[1]>t[1]?0:Math.PI,e.save(),e.translate(f[0],f[1]),e.rotate(b),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore(),e.save(),e.translate(g[0],g[1]),e.rotate(E),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore()}e.beginPath(),e.arc(p[0],p[1],5,0,Math.PI*2),e.fill()}if(a){e.fillStyle=o;for(let f=0;f<3;++f){let d=(LiteGraph.getTime()*2e-4+f*.2)%1,g;if(this.links_render_mode===LiteGraph.STRAIGHT_LINK){let m;if(s){const _=this.findObstructingNodes(t,r,s);m=this.computeAvoidancePath(t,r,_,l,h)}else m=this.computeDefaultPath(t,r,l,h);let b=0;const E=[];for(let _=1;_<m.length;_++){const I=m[_][0]-m[_-1][0],A=m[_][1]-m[_-1][1],M=Math.sqrt(I*I+A*A);E.push(M),b+=M}const L=d*b;let T=0;g=m[0];for(let _=0;_<E.length;_++){if(T+E[_]>=L){const I=(L-T)/E[_],A=m[_],M=m[_+1];g=[A[0]+(M[0]-A[0])*I,A[1]+(M[1]-A[1])*I];break}T+=E[_]}e.beginPath(),e.arc(g[0],g[1],5,0,2*Math.PI),e.fill()}else g=this.computeConnectionPoint(t,r,d,l,h),e.beginPath(),e.arc(g[0],g[1],5,0,2*Math.PI),e.fill()}}}computeStraightLinkPoint(e,t,r,s,n){let a=e[0],o=e[1],l=t[0],h=t[1];s===LiteGraph.RIGHT?a+=10:s===LiteGraph.LEFT?a-=10:s===LiteGraph.DOWN?o+=10:s===LiteGraph.UP&&(o-=10),n===LiteGraph.LEFT?l-=10:n===LiteGraph.RIGHT?l+=10:n===LiteGraph.UP?h-=10:n===LiteGraph.DOWN&&(h+=10);const c=(a+l)*.5,u=Math.abs(c-a),p=Math.abs(h-o),f=Math.abs(l-c),d=u+p+f;let g=r*d;return g<=u?[a+(c>a?g:-g),o]:(g-=u,g<=p?[c,o+(h>o?g:-g)]:(g-=p,[c+(l>c?g:-g),h]))}computeConnectionPoint(e,t,r,s,n){s=s||LiteGraph.RIGHT,n=n||LiteGraph.LEFT;const a=LiteGraph.distance(e,t),o=e,l=[e[0],e[1]],h=[t[0],t[1]],c=t;switch(s){case LiteGraph.LEFT:l[0]+=a*-.25;break;case LiteGraph.RIGHT:l[0]+=a*.25;break;case LiteGraph.UP:l[1]+=a*-.25;break;case LiteGraph.DOWN:l[1]+=a*.25;break}switch(n){case LiteGraph.LEFT:h[0]+=a*-.25;break;case LiteGraph.RIGHT:h[0]+=a*.25;break;case LiteGraph.UP:h[1]+=a*-.25;break;case LiteGraph.DOWN:h[1]+=a*.25;break}const u=(1-r)*(1-r)*(1-r),p=3*((1-r)*(1-r))*r,f=3*(1-r)*(r*r),d=r*r*r,g=u*o[0]+p*l[0]+f*h[0]+d*c[0],m=u*o[1]+p*l[1]+f*h[1]+d*c[1];return[g,m]}drawExecutionOrder(e){e.shadowColor="transparent",e.globalAlpha=.25,e.textAlign="center",e.strokeStyle="white",e.globalAlpha=.75;const t=this.visible_nodes;for(let r=0;r<t.length;++r){const s=t[r];e.fillStyle="black",e.fillRect(s.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,s.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),s.order==0&&e.strokeRect(s.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,s.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),e.fillStyle="#FFF",e.fillText(s.order,s.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*-.5,s.pos[1]-6)}e.globalAlpha=1}drawNodeWidgets(e,t,r,s){if(!e.widgets||!e.widgets.length)return 0;const n=e.size[0],a=e.widgets;t+=2;const o=LiteGraph.NODE_WIDGET_HEIGHT,l=this.ds.scale>.5;r.save(),r.globalAlpha=this.editor_alpha;const h=LiteGraph.WIDGET_OUTLINE_COLOR,c=LiteGraph.WIDGET_BGCOLOR,u=LiteGraph.WIDGET_TEXT_COLOR,p=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,f=15;for(let d=0;d<a.length;++d){let g=a[d],m=t;g.y&&(m=g.y),g.last_y=m,r.strokeStyle=h,r.fillStyle="#222",r.textAlign="left",g.disabled&&(r.globalAlpha*=.5);const b=g.width||n;let E=g.options.max-g.options.min,L=(g.value-g.options.min)/E;switch(g.type){case"button":g.clicked&&(r.fillStyle="#AAA",g.clicked=!1,this.dirty_canvas=!0),r.fillRect(f,m,b-f*2,o),l&&!g.disabled&&r.strokeRect(f,m,b-f*2,o),l&&(r.textAlign="center",r.fillStyle=u,r.fillText(g.label||g.name,b*.5,m+o*.7));break;case"toggle":if(r.textAlign="left",r.strokeStyle=h,r.fillStyle=c,r.beginPath(),l?r.roundRect(f,m,b-f*2,o,[o*.5]):r.rect(f,m,b-f*2,o),r.fill(),l&&!g.disabled&&r.stroke(),r.fillStyle=g.value?"#89A":"#333",r.beginPath(),r.arc(b-f*2,m+o*.5,o*.36,0,Math.PI*2),r.fill(),l){r.fillStyle=p;const T=g.label||g.name;T!=null&&r.fillText(T,f*2,m+o*.7),r.fillStyle=g.value?u:p,r.textAlign="right",r.fillText(g.value?g.options.on||"true":g.options.off||"false",b-40,m+o*.7)}break;case"slider":if(r.fillStyle=c,r.fillRect(f,m,b-f*2,o),L<0&&(L=0),L>1&&(L=1),r.fillStyle=Object.prototype.hasOwnProperty.call(g.options,"slider_color")?g.options.slider_color:s==g?"#89A":"#678",r.fillRect(f,m,L*(b-f*2),o),l&&!g.disabled&&r.strokeRect(f,m,b-f*2,o),g.marker){let T=(g.marker-g.options.min)/E;T<0&&(T=0),T>1&&(T=1),r.fillStyle=Object.prototype.hasOwnProperty.call(g.options,"marker_color")?g.options.marker_color:"#AA9",r.fillRect(f+T*(b-f*2),m,2,o)}l&&(r.textAlign="center",r.fillStyle=u,r.fillText(g.label||g.name+"  "+Number(g.value).toFixed(g.options.precision!=null?g.options.precision:3),b*.5,m+o*.7));break;case"number":case"combo":if(r.textAlign="left",r.strokeStyle=h,r.fillStyle=c,r.beginPath(),l?r.roundRect(f,m,b-f*2,o,[o*.5]):r.rect(f,m,b-f*2,o),r.fill(),l)if(g.disabled||r.stroke(),r.fillStyle=u,g.disabled||(r.beginPath(),r.moveTo(f+16,m+5),r.lineTo(f+6,m+o*.5),r.lineTo(f+16,m+o-5),r.fill(),r.beginPath(),r.moveTo(b-f-16,m+5),r.lineTo(b-f-6,m+o*.5),r.lineTo(b-f-16,m+o-5),r.fill()),r.fillStyle=p,r.fillText(g.label||g.name,f*2+5,m+o*.7),r.fillStyle=u,r.textAlign="right",g.type=="number")r.fillText(Number(g.value).toFixed(g.options.precision!==void 0?g.options.precision:3),b-f*2-20,m+o*.7);else{let T=g.value;if(g.options.values){let _=g.options.values;_.constructor===Function&&(_=_()),_&&_.constructor!==Array&&(T=_[g.value])}r.fillText(T,b-f*2-20,m+o*.7)}break;case"string":case"text":if(r.textAlign="left",r.strokeStyle=h,r.fillStyle=c,r.beginPath(),l?r.roundRect(f,m,b-f*2,o,[o*.5]):r.rect(f,m,b-f*2,o),r.fill(),l){g.disabled||r.stroke(),r.save(),r.beginPath(),r.rect(f,m,b-f*2,o),r.clip(),r.fillStyle=p;const T=g.label||g.name;T!=null&&r.fillText(T,f*2,m+o*.7),r.fillStyle=u,r.textAlign="right",r.fillText(String(g.value).substr(0,30),b-f*2,m+o*.7),r.restore()}break;default:g.draw&&g.draw(r,e,b,m,o);break}t+=(g.computeSize?g.computeSize(b)[1]:o)+4,r.globalAlpha=this.editor_alpha}r.restore(),r.textAlign="left"}processNodeWidgets(node,pos,event,active_widget){if(!node.widgets||!node.widgets.length||!this.allow_interaction&&!node.flags.allow_interaction)return null;const x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow();for(let i=0;i<node.widgets.length;++i){const w=node.widgets[i];if(!w||w.disabled)continue;const widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(w!=active_widget&&(x<6||x>widget_width-12||y<w.last_y||y>w.last_y+widget_height||w.last_y===void 0))continue;const old_value=w.value;let _old_value=w.value,nvalue=clamp$1((x-15)/(widget_width-30),0,1);switch(w.type){case"button":event.type===LiteGraph.pointerevents_method+"down"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":if(w.options.read_only)break;w.value=w.options.min+(w.options.max-w.options.min)*nvalue,_old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value)},20),this.dirty_canvas=!0;break;case"number":case"combo":if(event.type==LiteGraph.pointerevents_method+"move"&&w.type=="number")deltaX&&(w.value+=deltaX*.1*(w.options.step||1)),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(event.type==LiteGraph.pointerevents_method+"down"){let e=w.options.values;e&&e.constructor===Function&&(e=w.options.values(w,node));let t=null;w.type!="number"&&(t=e.constructor===Array?e:Object.keys(e));const r=x<40?-1:x>widget_width-40?1:0;if(w.type=="number")w.value+=r*.1*(w.options.step||1),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(r){let s=-1;this.last_mouseclick=0,e.constructor===Object?s=t.indexOf(String(w.value))+r:s=t.indexOf(w.value)+r,s>=t.length&&(s=t.length-1),s<0&&(s=0),e.constructor===Array?w.value=e[s]:w.value=s}else{let n=function(a,o,l){return e!=t&&(a=s.indexOf(a)),this.value=a,inner_value_change(this,a),that.dirty_canvas=!0,!1};const s=e!=t?Object.values(e):e;new ContextMenu(s,{scale:Math.max(1,this.ds.scale),event,className:"dark",callback:n.bind(w)},ref_window)}}else if(event.type==LiteGraph.pointerevents_method+"up"&&w.type=="number"){const delta=x<40?-1:x>widget_width-40?1:0;event.click_time<200&&delta==0&&this.prompt("Value",w.value,(function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){}this.value=Number(v),inner_value_change(this,this.value)}).bind(w),event)}old_value!=w.value&&setTimeout((function(){inner_value_change(this,this.value)}).bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph.pointerevents_method+"down"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type==LiteGraph.pointerevents_method+"down"&&this.prompt("Value",w.value,(function(e){inner_value_change(this,e)}).bind(w),event,w.options?w.options.multiline:!1);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node));break}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),w}function inner_value_change(e,t){e.type=="number"&&(t=Number(t)),e.value=t,e.options&&e.options.property&&node.properties[e.options.property]!==void 0&&node.setProperty(e.options.property,t),e.callback&&e.callback(e.value,that,node,pos,event)}return null}adjustNodesSize(){const e=this.graph._nodes;for(let t=0;t<e.length;++t)e[t].size=e[t].computeSize();this.setDirty(!0,!0)}resize(e,t){if(!e&&!t){const r=this.canvas.parentNode;e=r.offsetWidth,t=r.offsetHeight}this.canvas.width==e&&this.canvas.height==t||(this.canvas.width=e,this.canvas.height=t,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}switchLiveMode(e){if(!e){this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;return}const t=this,r=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);const s=setInterval(function(){t.editor_alpha*=r,t.dirty_canvas=!0,t.dirty_bgcanvas=!0,r<1&&t.editor_alpha<.01&&(clearInterval(s),r<1&&(t.live_mode=!0)),r>1&&t.editor_alpha>.99&&(clearInterval(s),t.editor_alpha=1)},1)}onNodeSelectionChange(e){}static onGroupAdd(e,t,r){const s=_LGraphCanvas.active_canvas;s.getCanvasWindow();const n=new LGraphGroup;n.pos=s.convertEventToCanvasOffset(r),s.graph.add(n)}static getBoundaryNodes(e){let t=null,r=null,s=null,n=null;for(const a in e){const o=e[a],[l,h]=o.pos,[c,u]=o.size;(t===null||h<t.pos[1])&&(t=o),(r===null||l+c>r.pos[0]+r.size[0])&&(r=o),(s===null||h+u>s.pos[1]+s.size[1])&&(s=o),(n===null||l<n.pos[0])&&(n=o)}return{top:t,right:r,bottom:s,left:n}}boundaryNodesForSelection(){return _LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))}static alignNodes(e,t,r){if(!e)return;const s=_LGraphCanvas.active_canvas;let n=[];r===void 0?n=_LGraphCanvas.getBoundaryNodes(e):n={top:r,right:r,bottom:r,left:r};for(const[a,o]of Object.entries(s.selected_nodes))switch(t){case"right":o.pos[0]=n.right.pos[0]+n.right.size[0]-o.size[0];break;case"left":o.pos[0]=n.left.pos[0];break;case"top":o.pos[1]=n.top.pos[1];break;case"bottom":o.pos[1]=n.bottom.pos[1]+n.bottom.size[1]-o.size[1];break}s.dirty_canvas=!0,s.dirty_bgcanvas=!0}static onNodeAlign(e,t,r,s,n){new ContextMenu(["Top","Bottom","Left","Right"],{event:r,callback:a,parentMenu:s});function a(o){_LGraphCanvas.alignNodes(_LGraphCanvas.active_canvas.selected_nodes,o.toLowerCase(),n)}}static onGroupAlign(e,t,r,s){new ContextMenu(["Top","Bottom","Left","Right"],{event:r,callback:n,parentMenu:s});function n(a){_LGraphCanvas.alignNodes(_LGraphCanvas.active_canvas.selected_nodes,a.toLowerCase())}}static onMenuAdd(e,t,r,s,n){const a=_LGraphCanvas.active_canvas,o=a.getCanvasWindow(),l=a.graph;if(!l)return;function h(c,u){const p=LiteGraph.getNodeTypesCategories(a.filter||l.filter).filter(function(g){return g.startsWith(c)}),f=[];p.map(function(g){if(!g)return;const m=new RegExp("^("+c+")"),b=g.replace(m,"").split("/")[0],E=c===""?b+"/":c+b+"/";let L=b;L.indexOf("::")!=-1&&(L=L.split("::")[1]),f.findIndex(function(_){return _.value===E})===-1&&f.push({value:E,content:L,has_submenu:!0,callback:function(_,I,A,M){h(_.value,M)}})}),LiteGraph.getNodeTypesInCategory(c.slice(0,-1),a.filter||l.filter).map(function(g){if(g.skip_list)return;const m={value:g.type,content:g.title,has_submenu:!1,callback:function(b,E,L,T){const _=T.getFirstEvent();a.graph.beforeChange();const I=LiteGraph.createNode(b.value);I&&(I.pos=a.convertEventToCanvasOffset(_),a.graph.add(I)),n&&n(I),a.graph.afterChange()}};f.push(m)}),new ContextMenu(f,{event:r,parentMenu:u},o)}return h("",s),!1}static onMenuCollapseAll(){}static onMenuNodeEdit(){}static showMenuNodeOptionalInputs(e,t,r,s,n){if(!n)return;const a=this,l=_LGraphCanvas.active_canvas.getCanvasWindow();let h=n.optional_inputs;n.onGetInputs&&(h=n.onGetInputs());let c=[];if(h)for(let p=0;p<h.length;p++){const f=h[p];if(!f){c.push(null);continue}let d=f[0];f[2]||(f[2]={}),f[2].label&&(d=f[2].label),f[2].removable=!0;const g={content:d,value:f};f[1]==LiteGraph.ACTION&&(g.className="event"),c.push(g)}if(n.onMenuNodeInputs){const p=n.onMenuNodeInputs(c);p&&(c=p)}if(!c.length){console.log("no input entries");return}new ContextMenu(c,{event:r,callback:u,parentMenu:s,node:n},l);function u(p,f,d){n&&(p.callback&&p.callback.call(a,n,p,f,d),p.value&&(n.graph.beforeChange(),n.addInput(p.value[0],p.value[1],p.value[2]),n.onNodeInputAdd&&n.onNodeInputAdd(p.value),n.setDirtyCanvas(!0,!0),n.graph.afterChange()))}return!1}static showMenuNodeOptionalOutputs(e,t,r,s,n){if(!n)return;const a=this,l=_LGraphCanvas.active_canvas.getCanvasWindow();let h=n.optional_outputs;n.onGetOutputs&&(h=n.onGetOutputs());let c=[];if(h)for(let p=0;p<h.length;p++){const f=h[p];if(!f){c.push(null);continue}if(n.flags&&n.flags.skip_repeated_outputs&&n.findOutputSlot(f[0])!=-1)continue;let d=f[0];f[2]||(f[2]={}),f[2].label&&(d=f[2].label),f[2].removable=!0;const g={content:d,value:f};f[1]==LiteGraph.EVENT&&(g.className="event"),c.push(g)}if(this.onMenuNodeOutputs&&(c=this.onMenuNodeOutputs(c)),LiteGraph.do_add_triggers_slots&&n.findOutputSlot("onExecuted")==-1&&c.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"}),n.onMenuNodeOutputs){const p=n.onMenuNodeOutputs(c);p&&(c=p)}if(!c.length)return;new ContextMenu(c,{event:r,callback:u,parentMenu:s,node:n},l);function u(p,f,d){if(!n||(p.callback&&p.callback.call(a,n,p,f,d),!p.value))return;const g=p.value[1];if(g&&(g.constructor===Object||g.constructor===Array)){const m=[];for(const b in g)m.push({content:b,value:g[b]});return new ContextMenu(m,{event:f,callback:u,parentMenu:s,node:n}),!1}else n.graph.beforeChange(),n.addOutput(p.value[0],p.value[1],p.value[2]),n.onNodeOutputAdd&&n.onNodeOutputAdd(p.value),n.setDirtyCanvas(!0,!0),n.graph.afterChange()}return!1}static onShowMenuNodeProperties(e,t,r,s,n){if(!n||!n.properties)return;const a=_LGraphCanvas.active_canvas,o=a.getCanvasWindow(),l=[];for(const c in n.properties){let u=n.properties[c]!==void 0?n.properties[c]:" ";typeof u=="object"&&(u=JSON.stringify(u));const p=n.getPropertyInfo(c);(p.type=="enum"||p.type=="combo")&&(u=_LGraphCanvas.getPropertyPrintableValue(u,p.values)),u=_LGraphCanvas.decodeHTML(u),l.push({content:"<span class='property_name'>"+(p.label?p.label:c)+"</span><span class='property_value'>"+u+"</span>",value:c})}if(!l.length)return;new ContextMenu(l,{event:r,callback:h,parentMenu:s,allow_html:!0,node:n},o);function h(c,u,p,f){if(!n)return;const d=this.getBoundingClientRect();a.showEditPropertyValue(n,c.value,{position:[d.left,d.top]})}return!1}static decodeHTML(e){const t=document.createElement("div");return t.innerText=e,t.innerHTML}static onMenuResizeNode(e,t,r,s,n){if(!n)return;const a=function(l){l.size=l.computeSize(),l.onResize&&l.onResize(l.size)},o=_LGraphCanvas.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)a(n);else for(const l in o.selected_nodes)a(o.selected_nodes[l]);n.setDirtyCanvas(!0,!0)}static showLinkMenu(e,t,r){const s=r,n=s.graph.getNodeById(e.origin_id),a=s.graph.getNodeById(e.target_id);let o=!1;n&&n.outputs&&n.outputs[e.origin_slot]&&(o=n.outputs[e.origin_slot].type);let l=!1;a&&a.outputs&&a.outputs[e.target_slot]&&(l=a.inputs[e.target_slot].type);const h=["Add Node",null,"Delete",null],c=new ContextMenu(h,{event:t,title:e.data!=null?e.data.constructor.name:null,callback:u});function u(p,f,d){switch(p){case"Add Node":_LGraphCanvas.onMenuAdd(null,null,d,c,function(g){!g.inputs||!g.inputs.length||!g.outputs||!g.outputs.length||n.connectByType(e.origin_slot,g,o)&&(g.connectByType(e.target_slot,a,l),g.pos[0]-=g.size[0]*.5)});break;case"Delete":s.graph.removeLink(e.id);break}}return!1}createDefaultNodeForSlot(e){const r=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},e||{}),s=this,n=r.nodeFrom&&r.slotFrom!==null,a=!n&&r.nodeTo&&r.slotTo!==null;if(!n&&!a)return console.warn("No data passed to createDefaultNodeForSlot "+r.nodeFrom+" "+r.slotFrom+" "+r.nodeTo+" "+r.slotTo),!1;if(!r.nodeType)return console.warn("No type to createDefaultNodeForSlot"),!1;const o=n?r.nodeFrom:r.nodeTo;let l=n?r.slotFrom:r.slotTo,h=!1;switch(typeof l){case"string":h=n?o.findOutputSlot(l,!1):o.findInputSlot(l,!1),l=n?o.outputs[l]:o.inputs[l];break;case"object":h=n?o.findOutputSlot(l.name):o.findInputSlot(l.name);break;case"number":h=l,l=n?o.outputs[l]:o.inputs[l];break;case"undefined":default:return console.warn("Cant get slot information "+l),!1}(l===!1||h===!1)&&console.warn("createDefaultNodeForSlot bad slotX "+l+" "+h);const c=l.type==LiteGraph.EVENT?"_event_":l.type,u=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(u&&u[c]){l.link;let p=!1;if(typeof u[c]=="object"||Array.isArray(u[c])){for(const f in u[c])if(r.nodeType==u[c][f]||r.nodeType=="AUTO"){p=u[c][f];break}}else(r.nodeType==u[c]||r.nodeType=="AUTO")&&(p=u[c]);if(p){let f=!1;typeof p=="object"&&p.node&&(f=p,p=p.node);const d=LiteGraph.createNode(p);if(d){if(f){if(f.properties)for(const g in f.properties)d.addProperty(g,f.properties[g]);if(f.inputs){d.inputs=[];for(const g in f.inputs)d.addOutput(f.inputs[g][0],f.inputs[g][1])}if(f.outputs){d.outputs=[];for(const g in f.outputs)d.addOutput(f.outputs[g][0],f.outputs[g][1])}f.title&&(d.title=f.title),f.json&&d.configure(f.json)}return s.graph.add(d),d.pos=[r.position[0]+r.posAdd[0]+(r.posSizeFix[0]?r.posSizeFix[0]*d.size[0]:0),r.position[1]+r.posAdd[1]+(r.posSizeFix[1]?r.posSizeFix[1]*d.size[1]:0)],n?r.nodeFrom.connectByType(h,d,c):r.nodeTo.connectByTypeOutput(h,d,c),!0}else console.log("failed creating "+p)}}return!1}showConnectionMenu(e){const r=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},e||{}),s=this,n=r.nodeFrom&&r.slotFrom,a=!n&&r.nodeTo&&r.slotTo;if(!n&&!a)return console.warn("No data passed to showConnectionMenu"),!1;const o=n?r.nodeFrom:r.nodeTo;let l=n?r.slotFrom:r.slotTo,h=!1;switch(typeof l){case"string":h=n?o.findOutputSlot(l,!1):o.findInputSlot(l,!1),l=n?o.outputs[l]:o.inputs[l];break;case"object":h=n?o.findOutputSlot(l.name):o.findInputSlot(l.name);break;case"number":h=l,l=n?o.outputs[l]:o.inputs[l];break;default:return console.warn("Cant get slot information "+l),!1}const c=["Add Node",null];s.allow_searchbox&&(c.push("Search"),c.push(null));const u=l.type==LiteGraph.EVENT?"_event_":l.type,p=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(p&&p[u])if(typeof p[u]=="object"||Array.isArray(p[u]))for(const g in p[u])c.push(p[u][g]);else c.push(p[u]);const f=new ContextMenu(c,{event:r.e,title:(l&&l.name!=""?l.name+(u?" | ":""):"")+(l&&u?u:""),callback:d});function d(g,m,b){switch(s.createDefaultNodeForSlot(Object.assign(r,{position:[r.e.canvasX,r.e.canvasY],nodeType:g})),g){case"Add Node":_LGraphCanvas.onMenuAdd(null,null,b,f,function(E){n?r.nodeFrom.connectByType(h,E,u):r.nodeTo.connectByTypeOutput(h,E,u)});break;case"Search":n?s.showSearchBox(b,{node_from:r.nodeFrom,slot_from:l,type_filter_in:u}):s.showSearchBox(b,{node_to:r.nodeTo,slot_from:l,type_filter_out:u});break}}return!1}static onShowPropertyEditor(e,t,r,s,n){const a=e.property||"title",o=n[a],l=document.createElement("div");l.is_modified=!1,l.className="graphdialog",l.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",l.close=function(){l.parentNode&&l.parentNode.removeChild(l)};const h=l.querySelector(".name");h.innerText=a;let c=l.querySelector(".value");c&&(c.value=o,c.addEventListener("blur",function(T){this.focus()}),c.addEventListener("keydown",function(T){if(l.is_modified=!0,T.keyCode==27)l.close();else if(T.keyCode==13)E();else if(T.keyCode!=13&&T.target.localName!="textarea")return;T.preventDefault(),T.stopPropagation()}));const p=_LGraphCanvas.active_canvas.canvas,f=p.getBoundingClientRect();let d=-20,g=-20;f&&(d-=f.left,g-=f.top),event?(l.style.left=event.clientX+d+"px",l.style.top=event.clientY+g+"px"):(l.style.left=p.width*.5+d+"px",l.style.top=p.height*.5+g+"px"),l.querySelector("button").addEventListener("click",E),p.parentNode.appendChild(l),c&&c.focus();let b=null;l.addEventListener("mouseleave",function(T){LiteGraph.dialog_close_on_mouse_leave&&!l.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(b=setTimeout(l.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),l.addEventListener("mouseenter",function(T){LiteGraph.dialog_close_on_mouse_leave&&b&&clearTimeout(b)});function E(){c&&L(c.value)}function L(T){e.type=="Number"?T=Number(T):e.type=="Boolean"&&(T=!!T),n[a]=T,l.parentNode&&l.parentNode.removeChild(l),n.setDirtyCanvas(!0,!0)}}prompt(e,t,r,s,n){const a=this;e=e||"";const o=document.createElement("div");o.is_modified=!1,o.className="graphdialog rounded",n?o.innerHTML="<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":o.innerHTML="<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",o.close=function(){a.prompt_box=null,o.parentNode&&o.parentNode.removeChild(o)};const h=_LGraphCanvas.active_canvas.canvas;h.parentNode.appendChild(o),this.ds.scale>1&&(o.style.transform="scale("+this.ds.scale+")");let c=null,u=!1;LiteGraph.pointerListenerAdd(o,"leave",function(T){u||LiteGraph.dialog_close_on_mouse_leave&&!o.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(c=setTimeout(o.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(o,"enter",function(T){LiteGraph.dialog_close_on_mouse_leave&&c&&clearTimeout(c)});const p=o.querySelectorAll("select");p&&p.forEach(function(T){T.addEventListener("click",function(_){u++}),T.addEventListener("blur",function(_){u=0}),T.addEventListener("change",function(_){u=-1})}),a.prompt_box&&a.prompt_box.close(),a.prompt_box=o;const f=o.querySelector(".name");f.innerText=e;const d=o.querySelector(".value");d.value=t;const g=d;g.addEventListener("keydown",function(T){if(o.is_modified=!0,T.keyCode==27)o.close();else if(T.keyCode==13&&T.target.localName!="textarea")r&&r(this.value),o.close();else return;T.preventDefault(),T.stopPropagation()}),o.querySelector("button").addEventListener("click",function(T){r&&r(g.value),a.setDirty(!0),o.close()});const b=h.getBoundingClientRect();let E=-20,L=-20;return b&&(E-=b.left,L-=b.top),s?(o.style.left=s.clientX+E+"px",o.style.top=s.clientY+L+"px"):(o.style.left=h.width*.5+E+"px",o.style.top=h.height*.5+L+"px"),setTimeout(function(){g.focus()},10),o}showSearchBox(e,t){const r={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};t=Object.assign(r,t||{});const s=this,n=_LGraphCanvas.active_canvas,a=n.canvas,o=a.ownerDocument||document,l=document.createElement("div");l.className="litegraph litesearchbox graphdialog rounded",l.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",t.do_type_filter&&(l.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",l.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),l.innerHTML+="<div class='helper'></div>",o.fullscreenElement?o.fullscreenElement.appendChild(l):(o.body.appendChild(l),o.body.style.overflow="hidden");let h,c;if(t.do_type_filter&&(h=l.querySelector(".slot_in_type_filter"),c=l.querySelector(".slot_out_type_filter")),l.close=function(){s.search_box=null,this.blur(),a.focus(),o.body.style.overflow="",setTimeout(function(){s.canvas.focus()},20),l.parentNode&&l.parentNode.removeChild(l)},this.ds.scale>1&&(l.style.transform="scale("+this.ds.scale+")"),t.hide_on_mouse_leave){let I=!1,A=null;LiteGraph.pointerListenerAdd(l,"enter",function(M){A&&(clearTimeout(A),A=null)}),LiteGraph.pointerListenerAdd(l,"leave",function(M){I||(A=setTimeout(function(){l.close()},500))}),t.do_type_filter&&(h.addEventListener("click",function(M){I++}),h.addEventListener("blur",function(M){I=0}),h.addEventListener("change",function(M){I=-1}),c.addEventListener("click",function(M){I++}),c.addEventListener("blur",function(M){I=0}),c.addEventListener("change",function(M){I=-1}))}s.search_box&&s.search_box.close(),s.search_box=l;const u=l.querySelector(".helper");let p=null,f=null,d=null,g=l.querySelector("input");if(g&&(g.addEventListener("blur",function(I){s.search_box&&this.focus()}),g.addEventListener("keydown",function(I){if(I.keyCode==38)T(!1);else if(I.keyCode==40)T(!0);else if(I.keyCode==27)l.close();else if(I.keyCode==13)_(),d?L(d.innerHTML):p?L(p):l.close();else{f&&clearInterval(f),f=setTimeout(_,250);return}return I.preventDefault(),I.stopPropagation(),I.stopImmediatePropagation(),!0})),t.do_type_filter){if(h){const I=LiteGraph.slot_types_in,A=I.length;(t.type_filter_in==LiteGraph.EVENT||t.type_filter_in==LiteGraph.ACTION)&&(t.type_filter_in="_event_");for(let M=0;M<A;M++){const O=document.createElement("option");O.value=I[M],O.innerHTML=I[M],h.appendChild(O),t.type_filter_in!==!1&&(t.type_filter_in+"").toLowerCase()==(I[M]+"").toLowerCase()&&(O.selected=!0)}h.addEventListener("change",function(){_()})}if(c){const I=LiteGraph.slot_types_out,A=I.length;(t.type_filter_out==LiteGraph.EVENT||t.type_filter_out==LiteGraph.ACTION)&&(t.type_filter_out="_event_");for(let M=0;M<A;M++){const O=document.createElement("option");O.value=I[M],O.innerHTML=I[M],c.appendChild(O),t.type_filter_out!==!1&&(t.type_filter_out+"").toLowerCase()==(I[M]+"").toLowerCase()&&(O.selected=!0)}c.addEventListener("change",function(){_()})}}const m=a.getBoundingClientRect(),b=(e?e.clientX:m.left+m.width*.5)-80,E=(e?e.clientY:m.top+m.height*.5)-20;l.style.left=b+"px",l.style.top=E+"px",e.layerY>m.height-200&&(u.style.maxHeight=m.height-e.layerY-20+"px"),g.focus(),t.show_all_on_open&&_();function L(I){if(I)if(s.onSearchBoxSelection)s.onSearchBoxSelection(I,e,n);else{const A=LiteGraph.searchbox_extras[I.toLowerCase()];A&&(I=A.type),n.graph.beforeChange();const M=LiteGraph.createNode(I);if(M&&(M.pos=n.convertEventToCanvasOffset(e),n.graph.add(M,!1)),A&&A.data){if(A.data.properties)for(const O in A.data.properties)M.addProperty(O,A.data.properties[O]);if(A.data.inputs){M.inputs=[];for(const O in A.data.inputs)M.addOutput(A.data.inputs[O][0],A.data.inputs[O][1])}if(A.data.outputs){M.outputs=[];for(const O in A.data.outputs)M.addOutput(A.data.outputs[O][0],A.data.outputs[O][1])}A.data.title&&(M.title=A.data.title),A.data.json&&M.configure(A.data.json)}if(t.node_from){let O=!1;switch(typeof t.slot_from){case"string":O=t.node_from.findOutputSlot(t.slot_from);break;case"object":t.slot_from.name?O=t.node_from.findOutputSlot(t.slot_from.name):O=-1,O==-1&&typeof t.slot_from.slot_index<"u"&&(O=t.slot_from.slot_index);break;case"number":O=t.slot_from;break;default:O=0}typeof t.node_from.outputs[O]<"u"&&O!==!1&&O>-1&&t.node_from.connectByType(O,M,t.node_from.outputs[O].type)}if(t.node_to){let O=!1;switch(typeof t.slot_from){case"string":O=t.node_to.findInputSlot(t.slot_from);break;case"object":t.slot_from.name?O=t.node_to.findInputSlot(t.slot_from.name):O=-1,O==-1&&typeof t.slot_from.slot_index<"u"&&(O=t.slot_from.slot_index);break;case"number":O=t.slot_from;break;default:O=0}typeof t.node_to.inputs[O]<"u"&&O!==!1&&O>-1&&t.node_to.connectByTypeOutput(O,M,t.node_to.inputs[O].type)}n.graph.afterChange()}l.close()}function T(I){const A=d;d&&d.classList.remove("selected"),d?(d=I?d.nextSibling:d.previousSibling,d||(d=A)):d=I?u.childNodes[0]:u.childNodes[u.childNodes.length],d&&(d.classList.add("selected"),d.scrollIntoView({block:"end",behavior:"smooth"}))}function _(){f=null;let I=g.value;if(p=null,u.innerHTML="",!I&&!t.show_all_if_empty)return;if(s.onSearchBox){const M=s.onSearchBox(u,I,n);if(M)for(let O=0;O<M.length;++O)A(M[O])}else{let k=function(B,S){const z=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},S||{}),q=LiteGraph.registered_node_types[B];if(O&&q.filter!=O||(!t.show_all_if_empty||I)&&B.toLowerCase().indexOf(I)===-1)return!1;if(t.do_type_filter&&!z.skipFilter){const Y=B;let H=C.value;if(z.inTypeOverride!==!1&&(H=z.inTypeOverride),C&&H&&LiteGraph.registered_slot_in_types[H]&&LiteGraph.registered_slot_in_types[H].nodes&&LiteGraph.registered_slot_in_types[H].nodes.includes(Y)===!1)return!1;let Z=P.value;if(z.outTypeOverride!==!1&&(Z=z.outTypeOverride),P&&Z&&LiteGraph.registered_slot_out_types[Z]&&LiteGraph.registered_slot_out_types[Z].nodes&&LiteGraph.registered_slot_out_types[Z].nodes.includes(Y)===!1)return!1}return!0},M=0;I=I.toLowerCase();const O=n.filter||n.graph.filter;let C=null,P=null;t.do_type_filter&&s.search_box?(C=s.search_box.querySelector(".slot_in_type_filter"),P=s.search_box.querySelector(".slot_out_type_filter")):(C=!1,P=!1);for(const B in LiteGraph.searchbox_extras){const S=LiteGraph.searchbox_extras[B];if((!t.show_all_if_empty||I)&&S.desc.toLowerCase().indexOf(I)===-1)continue;const U=LiteGraph.registered_node_types[S.type];if(!(U&&U.filter!=O)&&k(S.type)&&(A(S.desc,"searchbox_extra"),_LGraphCanvas.search_limit!==-1&&M++>_LGraphCanvas.search_limit))break}let N=null;if(Array.prototype.filter)N=Object.keys(LiteGraph.registered_node_types).filter(k);else{N=[];for(const B in LiteGraph.registered_node_types)k(B)&&N.push(B)}for(let B=0;B<N.length&&(A(N[B]),!(_LGraphCanvas.search_limit!==-1&&M++>_LGraphCanvas.search_limit));B++);if(t.show_general_after_typefiltered&&(C.value||P.value)){const B=[];for(const S in LiteGraph.registered_node_types)k(S,{inTypeOverride:C&&C.value?"*":!1,outTypeOverride:P&&P.value?"*":!1})&&B.push(S);for(let S=0;S<B.length&&(A(B[S],"generic_type"),!(_LGraphCanvas.search_limit!==-1&&M++>_LGraphCanvas.search_limit));S++);}if((C.value||P.value)&&u.childNodes.length==0&&t.show_general_if_none_on_typefilter){const B=[];for(const S in LiteGraph.registered_node_types)k(S,{skipFilter:!0})&&B.push(S);for(let S=0;S<B.length&&(A(B[S],"not_in_filter"),!(_LGraphCanvas.search_limit!==-1&&M++>_LGraphCanvas.search_limit));S++);}}function A(M,O){const C=document.createElement("div");p||(p=M),C.innerText=M,C.dataset.type=escape(M),C.className="litegraph lite-search-item",O&&(C.className+=" "+O),C.addEventListener("click",function(P){L(unescape(this.dataset.type))}),u.appendChild(C)}}return l}showEditPropertyValue(e,t,r){if(!e||e.properties[t]===void 0)return;r=r||{};const s=e.getPropertyInfo(t),n=s.type;let a="";if(n=="string"||n=="number"||n=="array"||n=="object")a="<input autofocus type='text' class='value'/>";else if((n=="enum"||n=="combo")&&s.values){a="<select autofocus type='text' class='value'>";for(const p in s.values){let f=p;s.values.constructor===Array&&(f=s.values[p]),a+="<option value='"+f+"' "+(f==e.properties[t]?"selected":"")+">"+s.values[p]+"</option>"}a+="</select>"}else if(n=="boolean"||n=="toggle")a="<input autofocus type='checkbox' class='value' "+(e.properties[t]?"checked":"")+"/>";else{console.warn("unknown type: "+n);return}const o=this.createDialog("<span class='name'>"+(s.label?s.label:t)+"</span>"+a+"<button>OK</button>",r);let l=!1;if((n=="enum"||n=="combo")&&s.values)l=o.querySelector("select"),l.addEventListener("change",function(p){o.modified(),u(p.target.value)});else if(n=="boolean"||n=="toggle")l=o.querySelector("input"),l&&l.addEventListener("click",function(p){o.modified(),u(!!l.checked)});else if(l=o.querySelector("input"),l){l.addEventListener("blur",function(f){this.focus()});let p=e.properties[t]!==void 0?e.properties[t]:"";n!=="string"&&(p=JSON.stringify(p)),l.value=p,l.addEventListener("keydown",function(f){if(f.keyCode==27)o.close();else if(f.keyCode==13)c();else if(f.keyCode!=13){o.modified();return}f.preventDefault(),f.stopPropagation()})}l&&l.focus(),o.querySelector("button").addEventListener("click",c);function c(){u(l.value)}function u(p){s&&s.values&&s.values.constructor===Object&&s.values[p]!=null&&(p=s.values[p]),typeof e.properties[t]=="number"&&(p=Number(p)),(n=="array"||n=="object")&&(p=JSON.parse(p)),e.properties[t]=p,e.graph&&e.graph._version++,e.onPropertyChanged&&e.onPropertyChanged(t,p),r.onclose&&r.onclose(),o.close(),e.setDirtyCanvas(!0,!0)}return o}createDialog(e,t){t=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},t||{});const s=document.createElement("div");s.className="graphdialog",s.innerHTML=e,s.is_modified=!1;const n=this.canvas.getBoundingClientRect();let a=-20,o=-20;if(n&&(a-=n.left,o-=n.top),t.position?(a+=t.position[0],o+=t.position[1]):t.event?(a+=t.event.clientX,o+=t.event.clientY):(a+=this.canvas.width*.5,o+=this.canvas.height*.5),s.style.left=a+"px",s.style.top=o+"px",this.canvas.parentNode.appendChild(s),t.checkForInput){let u=[];(u=s.querySelectorAll("input"))&&u.forEach(function(p){p.addEventListener("keydown",function(f){if(s.modified(),f.keyCode==27)s.close();else if(f.keyCode!=13)return;f.preventDefault(),f.stopPropagation()}),p.focus()})}s.modified=function(){s.is_modified=!0},s.close=function(){s.parentNode&&s.parentNode.removeChild(s)};let l=null,h=!1;s.addEventListener("mouseleave",function(u){h||(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!s.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(l=setTimeout(s.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),s.addEventListener("mouseenter",function(u){(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&l&&clearTimeout(l)});const c=s.querySelectorAll("select");return c&&c.forEach(function(u){u.addEventListener("click",function(p){h++}),u.addEventListener("blur",function(p){h=0}),u.addEventListener("change",function(p){h=-1})}),s}createPanel(e,t){t=t||{};const r=t.window||window,s=document.createElement("div");if(s.className="litegraph dialog",s.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",s.header=s.querySelector(".dialog-header"),t.width&&(s.style.width=t.width+(t.width.constructor===Number?"px":"")),t.height&&(s.style.height=t.height+(t.height.constructor===Number?"px":"")),t.closable){const n=document.createElement("span");n.innerHTML="&#10005;",n.classList.add("close"),n.addEventListener("click",function(){s.close()}),s.header.appendChild(n)}return s.title_element=s.querySelector(".dialog-title"),s.title_element.innerText=e,s.content=s.querySelector(".dialog-content"),s.alt_content=s.querySelector(".dialog-alt-content"),s.footer=s.querySelector(".dialog-footer"),s.close=()=>{s.onClose&&typeof s.onClose=="function"&&s.onClose(),s.parentNode&&s.parentNode.removeChild(s),s.parentNode&&s.parentNode.removeChild(this)},s.toggleAltContent=n=>{let a,o;typeof n<"u"?(a=n?"block":"none",o=n?"none":"block"):(a=s.alt_content.style.display!="block"?"block":"none",o=s.alt_content.style.display!="block"?"none":"block"),s.alt_content.style.display=a,s.content.style.display=o},s.toggleFooterVisibility=n=>{let a;typeof n<"u"?a=n?"block":"none":a=s.footer.style.display!="block"?"block":"none",s.footer.style.display=a},s.clear=()=>{s.content.innerHTML=""},s.addHTML=(n,a,o)=>{const l=document.createElement("div");return a&&(l.className=a),l.innerHTML=n,o?s.footer.appendChild(l):s.content.appendChild(l),l},s.addButton=(n,a,o)=>{const l=document.createElement("button");return l.innerText=n,l.options=o,l.classList.add("btn"),l.addEventListener("click",a),s.footer.appendChild(l),l},s.addSeparator=()=>{const n=document.createElement("div");n.className="separator",s.content.appendChild(n)},s.addWidget=(n,a,o,l,h)=>{l=l||{};let c=String(o);n=n.toLowerCase(),n=="number"&&(c=parseFloat(o).toFixed(3));const u=document.createElement("div");u.className="property",u.innerHTML="<span class='property_name'></span><span class='property_value'></span>",u.querySelector(".property_name").innerText=l.label||a;const p=u.querySelector(".property_value");p.innerText=c,u.dataset.property=a,u.dataset.type=l.type||n,u.options=l,u.value=o;const f=l.disabled||!1;if(f&&p.classList.add("disabled"),n=="code")u.addEventListener("click",function(g){g.preventDefault(),!f&&s.inner_showCodePad(this.dataset.property)});else if(n=="boolean")u.classList.add("boolean"),o&&u.classList.add("bool-on"),u.addEventListener("click",function(g){if(g.preventDefault(),f)return;const m=this.dataset.property||a;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",d(m,this.value)});else if(n=="string"||n=="number"){const g=document.createElement("input"),m=n==="string"?"string":"number";l.id&&g.setAttribute("id",l.id),g.setAttribute("type",m),l.min&&g.setAttribute("min",l.min),l.max&&g.setAttribute("max",l.max),g.classList.add("property_value_input"),f&&(g.setAttribute("disabled",f),g.classList.add("disabled")),p.innerText="",g.value=n==="string"?c:Number(c),p.appendChild(g),g.addEventListener("input",function(E){if(E.preventDefault(),f)return;const L=s.parentNode.dataset.property||a,T=s.parentNode.dataset.type;let _=E.target.value;T=="number"&&(_=Number(_)),d(L,_)})}else if(n=="enum"||n=="combo"){const g=_LGraphCanvas.getPropertyPrintableValue(o,l.values);p.innerText=g,p.addEventListener("click",m=>{if(m.preventDefault(),f)return;this.closeAllContextmenu();const b=l.values||[],E=s.parentNode.dataset.property||a,L=p,T=new ContextMenu(b,{event:m,className:"dark",callback:_},r);this._menus.push(T);function _(I,A,M){return L.innerText=I,d(E,I),!1}})}else if(n==="button"){u.innerHTML=`
                  <span class='property_name'></span>
                  <span class='property_value_img'>
                    <span class="property_img_src"></span>
                    
                  </span>`,u.querySelector(".property_name").innerText=l.label||a;const g=u.querySelector(".property_value_img");g.setAttribute("contenteditable",!0),g.innerText=c,u.dataset.property=a,u.dataset.type=l.type||n,u.options=l,u.value=o;const m=l.disabled,b=document.createElement("btn");b.classList.add("btn","btn-save-image"),b.textContent="Add Image",b.addEventListener("click",function(E){if(E.preventDefault(),m)return;const L=document.createElement("input");L.type="file",L.setAttribute("accept",".png,.jpg,.jpeg,.gif,.webp,"),L.click()}),g.appendChild(b)}s.content.appendChild(u);function d(g,m){l.callback&&l.callback(g,m,l),h&&h(g,m,l)}return u},s.onOpen&&typeof s.onOpen=="function"&&s.onOpen(),s}static getPropertyPrintableValue(e,t){if(!t||t.constructor===Array)return String(e);if(t.constructor===Object){let r="";for(const s in t)if(t[s]==e){r=s;break}return String(e)+" ("+r+")"}}closePanels(){const e=document.querySelector("#node-panel");e&&e.close();const t=document.querySelector("#option-panel");t&&t.close()}showShowGraphOptionsPanel(e,t,r,s){let n=document.querySelector("#node-panel"),a;if(this.constructor&&this.constructor.name=="HTMLDivElement"){if(!t||!t.event||!t.event.target||!t.event.target.lgraphcanvas){console.warn("Canvas not found");return}a=t.event.target.lgraphcanvas}else a=this;a.closePanels();const o=a.getCanvasWindow();n=a.createPanel("Options",{closable:!0,window:o,onOpen:function(){a.OPTIONPANEL_IS_OPEN=!0},onClose:function(){a.OPTIONPANEL_IS_OPEN=!1,a.options_panel=null}}),a.options_panel=n,n.id="option-panel",n.classList.add("settings");function l(){n.content.innerHTML="";const h=function(u,p,f){f&&f.key&&(u=f.key),f.values&&(p=Object.values(f.values).indexOf(p)),a[u]=p},c=LiteGraph.availableCanvasOptions;c.sort();for(const u in c){const p=c[u];n.addWidget("boolean",p,a[p],{key:p,on:"True",off:"False"},h)}a.links_render_mode,n.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[a.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},h),n.addSeparator(),n.footer.innerHTML=""}l(),a.canvas.parentNode.appendChild(n)}showShowNodePanel(e){this.SELECTED_NODE=e,this.closePanels();const t=this.getCanvasWindow(),r=this,s=this.createPanel(e.title||"",{closable:!0,window:t,onOpen:function(){r.NODEPANEL_IS_OPEN=!0},onClose:function(){r.NODEPANEL_IS_OPEN=!1,r.node_panel=null}});r.node_panel=s,s.id="node-panel",s.node=e,s.classList.add("settings");function n(){var h;s.content.innerHTML="",s.addHTML("<span class='node_type'>"+e.type+"</span><span class='node_desc'>"+(e.constructor.desc||"")+"</span><span class='separator'></span>"),s.addHTML("<h4>Properties</h4>");const a=(c,u)=>{r.graph.beforeChange(e);const p=Object.values(LiteGraph.NODE_MODES).indexOf(u);if(c.includes("inputName")){const f=e.properties[`editable-${c}`];e.setInputName(f.index,u),e.properties[`editable-${c}`].value=u}else if(c.includes("outputName")){const f=e.properties[`editable-${c}`];e.setOutputName(f.index,u),e.properties[`editable-${c}`].value=u}else switch(c){case"Title":e.title=u;break;case"Mode":p>=0&&LiteGraph.NODE_MODES[p]?e.changeMode(p):console.warn("unexpected mode: "+u);break;case"Color":_LGraphCanvas.node_colors[u]?(e.color=_LGraphCanvas.node_colors[u].color,e.bgcolor=_LGraphCanvas.node_colors[u].bgcolor):console.warn("unexpected color: "+u);break;case"x":e.pos=[parseInt(u),e.pos[1]];break;case"y":e.pos=[e.pos[0],parseInt(u)];break;case"Width":e.size=[parseInt(u),e.size[1]];break;case"Height":e.size=[e.size[0],parseInt(u)];break;default:e.setProperty(c,u);break}r.graph.afterChange(),r.dirty_canvas=!0};s.addWidget("string","Title",e.title,{disabled:!1},a);const o=["font_size","status","message"];for(let c in e.properties){if(o.includes(c)||c.includes("editable-"))continue;const u=e.properties[c],p=e.getPropertyInfo(c);p.type,!(e.onAddPropertyToPanel&&e.onAddPropertyToPanel(c,s))&&s.addWidget(p.widget||p.type,c,u,p,a)}if(s.addSeparator(),e.onShowCustomPanelInfo&&e.onShowCustomPanelInfo(s),(h=Object.keys(e.properties))==null?void 0:h.some(c=>c.includes("editable-"))){s.addHTML("<h4>Editable-Properties</h4>");for(let c in e.properties)if(c.includes("editable-")){const u=e.properties[c].value,p=e.getPropertyInfo(c);p.type;const f=c.split("-")[1];if(e.onAddPropertyToPanel&&e.onAddPropertyToPanel(c,s))continue;s.addWidget(p.widget||p.type,f,u,p,a)}}s.footer.innerHTML="",s.addButton("Delete",function(){e.block_delete||(e.graph.remove(e),s.close())}).classList.add("delete")}s.inner_showCodePad=a=>{s.classList.remove("settings"),s.classList.add("centered"),s.alt_content.innerHTML="<textarea class='code'></textarea>";const o=s.alt_content.querySelector("textarea"),l=()=>{s.toggleAltContent(!1),s.toggleFooterVisibility(!0),o.parentNode.removeChild(o),s.classList.add("settings"),s.classList.remove("centered"),n()};o.value=e.properties[a],o.addEventListener("keydown",function(u){u.code=="Enter"&&u.ctrlKey&&(e.setProperty(a,o.value),l())}),s.toggleAltContent(!0),s.toggleFooterVisibility(!1),o.style.height="calc(100% - 40px)";const h=s.addButton("Assign",function(){e.setProperty(a,o.value),l()});s.alt_content.appendChild(h);const c=s.addButton("Close",l);c.style.float="right",s.alt_content.appendChild(c)},n(),this.canvas.parentNode.appendChild(s)}showSubgraphPropertiesDialog(e){console.log("showing subgraph properties dialog");const t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();const r=this.createPanel("Subgraph Inputs",{closable:!0,width:500});r.node=e,r.classList.add("subgraph_dialog");function s(){if(r.clear(),e.inputs)for(let o=0;o<e.inputs.length;++o){const l=e.inputs[o];if(l.not_subgraph_input)continue;const c=r.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");c.dataset.name=l.name,c.dataset.slot=o,c.querySelector(".name").innerText=l.name,c.querySelector(".type").innerText=l.type,c.querySelector("button").addEventListener("click",function(u){e.removeInput(Number(this.parentNode.dataset.slot)),s()})}}return r.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",function(o){const l=this.parentNode,h=l.querySelector(".name").value,c=l.querySelector(".type").value;!h||e.findInputSlot(h)!=-1||(e.addInput(h,c),l.querySelector(".name").value="",l.querySelector(".type").value="",s())}),s(),this.canvas.parentNode.appendChild(r),r}showSubgraphPropertiesDialogRight(e){const t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();const r=this.createPanel("Subgraph Outputs",{closable:!0,width:500});r.node=e,r.classList.add("subgraph_dialog");function s(){if(r.clear(),e.outputs)for(let l=0;l<e.outputs.length;++l){const h=e.outputs[l];if(h.not_subgraph_output)continue;const u=r.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");u.dataset.name=h.name,u.dataset.slot=l,u.querySelector(".name").innerText=h.name,u.querySelector(".type").innerText=h.type,u.querySelector("button").addEventListener("click",function(p){e.removeOutput(Number(this.parentNode.dataset.slot)),s()})}}const a=r.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);a.querySelector(".name").addEventListener("keydown",function(l){l.keyCode==13&&o.apply(this)}),a.querySelector("button").addEventListener("click",function(l){o.apply(this)});function o(){const l=this.parentNode,h=l.querySelector(".name").value,c=l.querySelector(".type").value;!h||e.findOutputSlot(h)!=-1||(e.addOutput(h,c),l.querySelector(".name").value="",l.querySelector(".type").value="",s())}return s(),this.canvas.parentNode.appendChild(r),r}checkPanels(){if(!this.canvas)return;const e=this.canvas.parentNode.querySelectorAll(".litegraph.dialog");for(let t=0;t<e.length;++t){const r=e[t];r.node&&(!r.node.graph||r.graph!=this.graph)&&r.close()}}static onMenuNodeCollapse(e,t,r,s,n){n.graph.beforeChange();const a=function(l){l.collapse()},o=_LGraphCanvas.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)a(n);else for(const l in o.selected_nodes)a(o.selected_nodes[l]);n.graph.afterChange()}static onMenuNodePin(e,t,r,s,n){n.pin()}static onMenuNodeMode(e,t,r,s,n){new ContextMenu(LiteGraph.NODE_MODES,{event:r,callback:a,parentMenu:s,node:n});function a(o){if(!n)return;const l=Object.values(LiteGraph.NODE_MODES).indexOf(o),h=function(u){l>=0&&LiteGraph.NODE_MODES[l]?u.changeMode(l):(console.warn("unexpected mode: "+o),u.changeMode(LiteGraph.ALWAYS))},c=_LGraphCanvas.active_canvas;if(!c.selected_nodes||Object.keys(c.selected_nodes).length<=1)h(n);else for(const u in c.selected_nodes)h(c.selected_nodes[u])}return!1}static onMenuNodeColors(e,t,r,s,n){if(!n)throw"no node for color";const a=[];a.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(const l in _LGraphCanvas.node_colors){const h=_LGraphCanvas.node_colors[l],c={value:l,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+h.color+"; background-color:"+h.bgcolor+"'>"+l+"</span>"};a.push(c)}new ContextMenu(a,{event:r,callback:o,parentMenu:s,node:n});function o(l){if(!n)return;const h=l.value?_LGraphCanvas.node_colors[l.value]:null,c=function(p){h?p.constructor===LGraphGroup?p.color=h.groupcolor:(p.color=h.color,p.bgcolor=h.bgcolor):(delete p.color,delete p.bgcolor)},u=_LGraphCanvas.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)c(n);else for(const p in u.selected_nodes)c(u.selected_nodes[p]);n.setDirtyCanvas(!0,!0)}return!1}static onMenuNodeShapes(e,t,r,s,n){if(!n)throw"no node passed";new ContextMenu(LiteGraph.VALID_SHAPES,{event:r,callback:a,parentMenu:s,node:n});function a(o){if(!n)return;n.graph.beforeChange();const l=function(c){c.shape=o},h=_LGraphCanvas.active_canvas;if(!h.selected_nodes||Object.keys(h.selected_nodes).length<=1)l(n);else for(const c in h.selected_nodes)l(h.selected_nodes[c]);n.graph.afterChange(),n.setDirtyCanvas(!0)}return!1}static onMenuNodeRemove(e,t,r,s,n){if(!n)throw"no node passed";const a=n.graph;a.beforeChange();const o=function(h){h.removable!==!1&&a.remove(h)},l=_LGraphCanvas.active_canvas;if(!l.selected_nodes||Object.keys(l.selected_nodes).length<=1)o(n);else for(const h in l.selected_nodes)o(l.selected_nodes[h]);a.afterChange(),n.setDirtyCanvas(!0,!0)}static onMenuNodeToSubgraph(e,t,r,s,n){const a=n.graph,o=_LGraphCanvas.active_canvas;if(!o)return;let l=Object.values(o.selected_nodes||{});l.length||(l=[n]);const h=LiteGraph.createNode("graph/subgraph");h.pos=n.pos.concat(),a.add(h),h.buildFromNodes(l),o.deselectAllNodes(),n.setDirtyCanvas(!0,!0)}static onMenuNodeClone(e,t,r,s,n){n.graph.beforeChange();const a={},o=function(h){if(h.clonable===!1)return;const c=h.clone();c&&(c.pos=[h.pos[0]+5,h.pos[1]+5],h.graph.add(c),a[c.id]=c)},l=_LGraphCanvas.active_canvas;if(!l.selected_nodes||Object.keys(l.selected_nodes).length<=1)o(n);else for(const h in l.selected_nodes)o(l.selected_nodes[h]);Object.keys(a).length&&l.selectNodes(a),n.graph.afterChange(),n.setDirtyCanvas(!0,!0)}getNodeMenuOptions(e){let t=null;if(e.getMenuOptions?t=e.getMenuOptions(this):(t=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:_LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:_LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:_LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:_LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeMode}],e.resizable!==!1&&t.push({content:"Resize",callback:_LGraphCanvas.onMenuResizeNode}),t.push({content:"Collapse",callback:_LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:_LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeShapes},null)),e.onGetInputs){const r=e.onGetInputs();r&&r.length&&(t[0].disabled=!1)}if(e.onGetOutputs){const r=e.onGetOutputs();r&&r.length&&(t[1].disabled=!1)}if(e.getExtraMenuOptions){const r=e.getExtraMenuOptions(this,t);r&&(r.push(null),t=r.concat(t))}return e.clonable!==!1&&t.push({content:"Clone",callback:_LGraphCanvas.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&t.push({content:"Align Selected To",has_submenu:!0,callback:_LGraphCanvas.onNodeAlign}),t.push(null,{content:"Remove",disabled:!(e.removable!==!1&&!e.block_delete),callback:_LGraphCanvas.onMenuNodeRemove}),e.graph&&e.graph.onGetNodeMenuOptions&&e.graph.onGetNodeMenuOptions(t,e),t}bringGroupToFront(e){const t=this.graph._groups,r=this.findGroupIndexById(e.id);Number(r)!==-1&&(t.splice(Number(r),1),t.push(e),this.setDirty(!0,!0))}onGrpSizeEditor(e,t,r,s,n){e.property;const a=document.createElement("div");a.is_modified=!1,a.className="graphdialog",a.innerHTML=`
                <div class="d-flex flex-column align-items-start p-2" id="grpSizeDialog">
                  <div> <div><span class='main-tit p-1'>Group Size</span> </div>
                  <div class="p-1"><span class='sub-prop'>Width</span><input  type='number' class='value' id="widthValue" /></div>
                  <div class="p-1"><span class='sub-prop'>Height</span><input type='number' class='value' id="heightValue"  /></div>
                  <div class="d-flex align-items-center justify-content-end p-1"><button class="okBtn">OK</button></div>
                </div>
               
                
                `,a.close=function(){a.parentNode&&a.parentNode.removeChild(a)};const l=_LGraphCanvas.active_canvas.canvas,h=l.getBoundingClientRect();let c=-20,u=-20;h&&(c-=h.left,u-=h.top),event?(a.style.left=event.clientX+c+"px",a.style.top=event.clientY+u+"px"):(a.style.left=l.width*.5+c+"px",a.style.top=l.height*.5+u+"px"),a.querySelector(".okBtn").addEventListener("click",m),l.parentNode.appendChild(a);const f=document.querySelector("#widthValue"),d=document.querySelector("#heightValue");f&&(f.value=Number(n.size[0]),f.addEventListener("keydown",function(E){if(a.is_modified=!0,E.keyCode==27)a.close();else if(E.keyCode==13)m();else if(E.keyCode!=13&&E.target.localName!="textarea")return;E.preventDefault(),E.stopPropagation()})),d&&(d.value=Number(n.size[1]),d.addEventListener("keydown",function(E){if(a.is_modified=!0,E.keyCode==27)a.close();else if(E.keyCode==13)m();else if(E.keyCode!=13&&E.target.localName!="textarea")return;E.preventDefault(),E.stopPropagation()}));let g=null;a.addEventListener("mouseleave",function(E){LiteGraph.dialog_close_on_mouse_leave&&!a.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(g=setTimeout(a.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),a.addEventListener("mouseenter",function(E){LiteGraph.dialog_close_on_mouse_leave&&g&&clearTimeout(g)});function m(){b(f==null?void 0:f.value,d==null?void 0:d.value)}function b(E,L){const T=E||n.size[0],_=L||n.size[1];n.size=[T,_],a.parentNode&&a.parentNode.removeChild(a),n.setDirtyCanvas(!0,!0)}}onShowPropertyEditor(e,t,r,s,n){const a=e.property||"title",o=n[a],l=document.createElement("div");l.is_modified=!1,l.className="graphdialog",l.innerHTML="<span class='name'></span><input type='text' class='value '/><button>OK</button>",l.close=function(){l.parentNode&&l.parentNode.removeChild(l)};const h=l.querySelector(".name");h.innerText=a;let c=l.querySelector(".value");c&&(c.value=o,c.addEventListener("keydown",function(T){if(l.is_modified=!0,T.keyCode==27)l.close();else if(T.keyCode==13)E();else if(T.keyCode!=13&&T.target.localName!="textarea")return;T.preventDefault(),T.stopPropagation()}));const p=_LGraphCanvas.active_canvas.canvas,f=p.getBoundingClientRect();let d=-20,g=-20;f&&(d-=f.left,g-=f.top),event?(l.style.left=event.clientX+d+"px",l.style.top=event.clientY+g+"px"):(l.style.left=p.width*.5+d+"px",l.style.top=p.height*.5+g+"px"),l.querySelector("button").addEventListener("click",E),p.parentNode.appendChild(l);let b=null;l.addEventListener("mouseleave",function(T){LiteGraph.dialog_close_on_mouse_leave&&!l.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(b=setTimeout(l.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),l.addEventListener("mouseenter",function(T){LiteGraph.dialog_close_on_mouse_leave&&b&&clearTimeout(b)});function E(){c&&L(c.value)}function L(T){e.type=="Number"?T=Number(T):e.type=="Boolean"&&(T=!!T),n[a]=T,l.parentNode&&l.parentNode.removeChild(l),n.setDirtyCanvas(!0,!0)}}onGrpPositionEditor(e,t,r,s,n){const a=document.createElement("div");a.is_modified=!1,a.className="graphdialog",a.innerHTML=`
                <div class="d-flex flex-column align-items-start p-2" id="grpSizeDialog">
                  <div> <div><span class='main-tit p-1'>Group Position</span> </div>
                  <div class="p-1"><span class='sub-prop'>X</span><input  type='number' class='value' id="xValue" /></div>
                  <div class="p-1"><span class='sub-prop'>Y</span><input type='number' class='value' id="yValue" /></div>
                  <div class="d-flex align-items-center justify-content-end p-1"><button class="okBtn">OK</button></div>
                </div>
                `,a.close=function(){a.parentNode&&a.parentNode.removeChild(a)};const l=_LGraphCanvas.active_canvas.canvas,h=l.getBoundingClientRect();let c=-20,u=-20;h&&(c-=h.left,u-=h.top),event?(a.style.left=event.clientX+c+"px",a.style.top=event.clientY+u+"px"):(a.style.left=l.width*.5+c+"px",a.style.top=l.height*.5+u+"px"),a.querySelector(".okBtn").addEventListener("click",m),l.parentNode.appendChild(a);const f=document.querySelector("#xValue"),d=document.querySelector("#yValue");f&&(f.value=Number(n.pos[0]),f.addEventListener("keydown",function(E){if(a.is_modified=!0,E.keyCode==27)a.close();else if(E.keyCode==13)m();else if(E.keyCode!=13&&E.target.localName!="textarea")return;E.preventDefault(),E.stopPropagation()})),d&&(d.value=Number(n.pos[1]),d.addEventListener("keydown",function(E){if(a.is_modified=!0,E.keyCode==27)a.close();else if(E.keyCode==13)m();else if(E.keyCode!=13&&E.target.localName!="textarea")return;E.preventDefault(),E.stopPropagation()}));let g=null;a.addEventListener("mouseleave",function(E){LiteGraph.dialog_close_on_mouse_leave&&!a.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(g=setTimeout(a.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),a.addEventListener("mouseenter",function(E){LiteGraph.dialog_close_on_mouse_leave&&g&&clearTimeout(g)});function m(){b(f==null?void 0:f.value,d==null?void 0:d.value)}function b(E,L){const T=E||n.pos[0],_=L||n.pos[1];n.recomputeInsideNodes();const I=[T-n.pos[0],_-n.pos[1]];n.move(I[0],I[1]),a.parentNode&&a.parentNode.removeChild(a),n.setDirtyCanvas(!0,!0)}}sendGroupToBack(e){const t=this.graph._groups,r=this.findGroupIndexById(e.id);Number(r)!==-1&&(t.splice(Number(r),1),t.unshift(e),this.setDirty(!0,!0))}findGroupIndexById(e){const t=this.graph._groups;for(let r in t)if(t[r].id===e)return r;return-1}addNodeGuideLines(e){var r;const t=this.selected_nodes?Object.keys(this.selected_nodes):[];if((t==null?void 0:t.length)===1&&!this.read_only&&((r=this.graph._nodes)==null?void 0:r.length)>=2){const s=this.selected_nodes[t[0]],a=s.constructor.title_mode?0:LiteGraph.NODE_TITLE_HEIGHT,o=this.graph._nodes.map(p=>({x:p.pos[0],y:p.pos[1]-a,width:p.size[0],height:p.size[1],id:p.id})).filter(p=>(p==null?void 0:p.id)!==(s==null?void 0:s.id)),l=s.size[0],h=s.size[1],c=s.pos[0],u=s.pos[1]-a;e.strokeStyle="#c4c4c4",e.lineWidth=1;for(let p in o){e.strokeStyle=16711680;const f=o[p],d=f.width,g=f.height,m=f.x,b=f.y,E=Math.round(c),L=Math.round(u),T=Math.round(l),_=Math.round(h),I=Math.round(m),A=Math.round(b),M=Math.round(d),O=Math.round(g);I===E&&(L<A?(e.beginPath(),e.moveTo(E,L),e.lineTo(I,A+O+a),e.stroke()):(e.beginPath(),e.moveTo(I,A),e.lineTo(E,L+_+a),e.stroke())),I+M===E+T&&(L<A?(e.beginPath(),e.moveTo(E+T,L),e.lineTo(I+M,A+O+a),e.stroke()):(e.beginPath(),e.moveTo(I+M,A),e.lineTo(E+T,L+_+a),e.stroke())),A===L&&(E<I?(e.beginPath(),e.moveTo(E,L),e.lineTo(I+M,A),e.stroke()):(e.beginPath(),e.moveTo(I,A),e.lineTo(E+T,L),e.stroke())),A+O===L+_&&(E<I?(e.beginPath(),e.moveTo(E,L+_+a),e.lineTo(I+M,A+O+a),e.stroke()):(e.beginPath(),e.moveTo(I,A+O+a),e.lineTo(E+T,L+_+a),e.stroke()))}}}getCanvasMenuOptions(){let e=null;if(this.getMenuOptions?e=this.getMenuOptions():(e=[{content:"Add Node",has_submenu:!0,callback:_LGraphCanvas.onMenuAdd},{content:"Add Group",callback:_LGraphCanvas.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&e.push({content:"Align",has_submenu:!0,callback:_LGraphCanvas.onGroupAlign}),this._graph_stack&&this._graph_stack.length>0&&e.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){const t=this.getExtraMenuOptions(this,e);t&&(e=e.concat(t))}return e}processContextMenu(e,t){const r=this,n=_LGraphCanvas.active_canvas.getCanvasWindow();if(!n)return;let a=null;const o={event:t,callback:h,extra:e};e&&(o.title=e.type);let l=null;if(e&&(l=e.getSlotInPosition(t.canvasX,t.canvasY),_LGraphCanvas.active_node=e),l){if(a=[],e.getSlotMenuOptions)a=e.getSlotMenuOptions(l);else{l&&l.output&&l.output.links&&l.output.links.length&&a.push({content:"Disconnect Links",slot:l});const c=l.input||l.output;c.removable&&a.push(c.locked?"Cannot remove":{content:"Remove Slot",slot:l}),c.nameLocked||a.push({content:"Rename Slot",slot:l})}o.title=(l.input?l.input.type:l.output.type)||"*",l.input&&l.input.type==LiteGraph.ACTION&&(o.title="Action"),l.output&&l.output.type==LiteGraph.EVENT&&(o.title="Event")}else if(e)a=this.getNodeMenuOptions(e);else{a=this.getCanvasMenuOptions();const c=this.graph.getGroupOnPos(t.canvasX,t.canvasY);c&&a.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:c,options:this.getGroupMenuOptions(c)}})}if(!a)return;new ContextMenu(a,o,n);function h(c,u,p){if(c){if(c.content=="Remove Slot"){const f=c.slot;e.graph.beforeChange(),f.input?e.removeInput(f.slot):f.output&&e.removeOutput(f.slot),e.graph.afterChange();return}else if(c.content=="Disconnect Links"){const f=c.slot;e.graph.beforeChange(),f.output?e.disconnectOutput(f.slot):f.input&&e.disconnectInput(f.slot),e.graph.afterChange();return}else if(c.content=="Rename Slot"){const f=c.slot,d=f.input?e.getInputInfo(f.slot):e.getOutputInfo(f.slot),g=r.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",u),m=g.querySelector("input");m&&d&&(m.value=d.label||"");const b=function(){e.graph.beforeChange(),m.value&&(d&&(d.label=m.value),r.setDirty(!0)),g.close(),e.graph.afterChange()};g.querySelector("button").addEventListener("click",b),m.addEventListener("keydown",function(E){if(g.is_modified=!0,E.keyCode==27)g.close();else if(E.keyCode==13)b();else if(E.keyCode!=13&&E.target.localName!="textarea")return;E.preventDefault(),E.stopPropagation()}),m.focus()}}}}};R(_LGraphCanvas,"DEFAULT_BACKGROUND_IMAGE","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII="),R(_LGraphCanvas,"link_type_colors",{"-1":LiteGraph.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"}),R(_LGraphCanvas,"gradients",{}),R(_LGraphCanvas,"search_limit",-1),R(_LGraphCanvas,"node_colors",{red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}});let LGraphCanvas=_LGraphCanvas;class ContextMenu{constructor(t,r){r=r||{},this.options=r;const s=this;r.parentMenu&&(r.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),r.parentMenu=null):(this.parentMenu=r.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));let n=null;r.event&&(n=r.event.constructor.name),n!=="MouseEvent"&&n!=="CustomEvent"&&n!=="PointerEvent"&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+n+")"),r.event=null);const a=document.createElement("div");a.className="litegraph litecontextmenu litemenubar-panel",r.className&&(a.className+=" "+r.className),a.style.minWidth=100,a.style.minHeight=100,a.style.pointerEvents="none",setTimeout(function(){a.style.pointerEvents="auto"},100),LiteGraph.pointerListenerAdd(a,"up",function(f){return f.preventDefault(),!0},!0),a.addEventListener("contextmenu",function(f){return f.button!=2||f.preventDefault(),!1},!0),LiteGraph.pointerListenerAdd(a,"down",function(f){if(f.button==2)return s.close(),f.preventDefault(),!0},!0);function o(f){const d=parseInt(a.style.top);return a.style.top=(d+f.deltaY*r.scroll_speed).toFixed()+"px",f.preventDefault(),!0}if(r.scroll_speed||(r.scroll_speed=.1),a.addEventListener("wheel",o,!0),a.addEventListener("mousewheel",o,!0),this.root=a,r.title){const f=document.createElement("div");f.className="litemenu-title",f.innerHTML=r.title,a.appendChild(f)}for(let f=0;f<t.length;f++){let d=t.constructor==Array?t[f]:f;d!=null&&d.constructor!==String&&(d=d.content===void 0?String(d):d.content);const g=t[f];this.addItem(d,g,r)}LiteGraph.pointerListenerAdd(a,"enter",function(f){a.closing_timer&&clearTimeout(a.closing_timer)});let l=document;r.event&&(l=r.event.target.ownerDocument),l||(l=document),l.fullscreenElement?l.fullscreenElement.appendChild(a):l.body.appendChild(a);let h=r.left||0,c=r.top||0;if(r.event){if(h=r.event.clientX-10,c=r.event.clientY-10,r.title&&(c-=20),r.parentMenu){const g=r.parentMenu.root.getBoundingClientRect();h=g.left+g.width}const f=document.body.getBoundingClientRect(),d=a.getBoundingClientRect();f.height==0&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),f.width&&h>f.width-d.width-10&&(h=f.width-d.width-10),f.height&&c>f.height-d.height-10&&(c=f.height-d.height-10)}a.style.left=h+"px",a.style.top=c+"px",r.scale&&(a.style.transform="scale("+r.scale+")");const p=LGraphCanvas.active_canvas.canvas;this.parent=p.parentElement||document}addItem(t,r,s){const n=this;s=s||{};const a=document.createElement("div");a.className="litemenu-entry submenu";let o=!1;r===null?a.classList.add("separator"):(a.innerHTML=r&&r.title?r.title:t,a.value=r,r&&(r.disabled&&(o=!0,a.classList.add("disabled")),(r.submenu||r.has_submenu)&&a.classList.add("has_submenu")),typeof r=="function"?(a.dataset.value=t,a.onclick_callback=r):a.dataset.value=r,r.className&&(a.className+=" "+r.className)),this.root.appendChild(a),o||a.addEventListener("click",h),!o&&s.autoopen&&LiteGraph.pointerListenerAdd(a,"enter",l);function l(c){const u=this.value;!u||!u.has_submenu||h.call(this,c)}function h(c){const u=this.value;let p=!0;if(n.current_submenu&&n.current_submenu.close(c),s.callback&&s.callback.call(this,u,s,c,n,s.node)===!0&&(p=!1),u&&(u.callback&&!s.ignore_item_callbacks&&u.disabled!==!0&&u.callback.call(this,u,s,c,n,s.extra)===!0&&(p=!1),u.submenu)){if(!u.submenu.options)throw"ContextMenu submenu needs options";new n.constructor(u.submenu.options,{callback:u.submenu.callback,event:c,parentMenu:n,ignore_item_callbacks:u.submenu.ignore_item_callbacks,title:u.submenu.title,extra:u.submenu.extra,autoopen:s.autoopen}),p=!1}p&&!n.lock&&n.close()}return a}close(t,r){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!r&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,t===void 0?this.parentMenu.close():t&&!ContextMenu.isCursorOverElement(t,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,LiteGraph.pointerevents_method+"leave",t)),this.current_submenu&&this.current_submenu.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)}static trigger(t,r,s,n){const a=document.createEvent("CustomEvent");return a.initCustomEvent(r,!0,!0,s),a.srcElement=n,t.dispatchEvent?t.dispatchEvent(a):t.__events&&t.__events.dispatchEvent(a),a}getTopMenu(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this}getFirstEvent(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event}static isCursorOverElement(t,r){const s=t.clientX,n=t.clientY,a=r.getBoundingClientRect();return a?n>a.top&&n<a.top+a.height&&s>a.left&&s<a.left+a.width:!1}}function clamp$1(e,t,r){return t>e?t:r<e?r:e}typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}),typeof exports<"u"&&(exports.LiteGraph=(void 0).LiteGraph,exports.LGraph=(void 0).LGraph,exports.LLink=(void 0).LLink,exports.LGraphNode=(void 0).LGraphNode,exports.LGraphGroup=(void 0).LGraphGroup,exports.DragAndScale=(void 0).DragAndScale,exports.LGraphCanvas=(void 0).LGraphCanvas,exports.ContextMenu=(void 0).ContextMenu);class Editor{constructor(t,r){this.options=r||{},this.container_id=t}async init(){let t="<div class='header'><div class='tools tools-left'></div><div class='tools tools-right'></div></div>";t+="<div class='content'><div class='editor-area'><canvas class='graphcanvas' width='1000' height='500' tabindex=10></canvas></div></div>",t+="<div class='footer'><div class='tools tools-left'></div><div class='tools tools-right'></div></div>";const r=document.createElement("div");this.root=r,r.className="litegraph litegraph-editor",r.innerHTML=t,this.tools=r.querySelector(".tools"),this.content=r.querySelector(".content"),this.footer=r.querySelector(".footer");const s=this.canvas=r.querySelector(".graphcanvas");this.canvas=s,this.graph=new LGraph,this.graphcanvas=new LGraphCanvas(s,this.graph,{useWebgl:!1}),await this.graphcanvas._init(s),this.graphcanvas.links_render_mode=0,this.graphcanvas.background_image="/editor/imgs/grid.png",this.graph.onAfterExecute=()=>{this.graphcanvas.draw(!0)},this.graphcanvas.onDropItem=this.onDropItem.bind(this),this.addLoadCounter(),this.addToolsButton("playnode_button","Play","/editor/imgs/icon-play.png",this.onPlayButton.bind(this),".tools-right"),this.addToolsButton("playstepnode_button","Step","/editor/imgs/icon-playstep.png",this.onPlayStepButton.bind(this),".tools-right"),this.options.skip_livemode||this.addToolsButton("livemode_button","Live","/editor/imgs/icon-record.png",this.onLiveButton.bind(this),".tools-right"),this.options.skip_maximize||this.addToolsButton("maximize_button","","/editor/imgs/icon-maximize.png",this.onFullscreenButton.bind(this),".tools-right"),this.options.miniwindow&&this.addMiniWindow(300,200);var n=document.getElementById(this.container_id);n&&n.appendChild(r),this.graphcanvas.resize()}addLoadCounter(){let t=document.createElement("div");t.className="headerpanel loadmeter toolbar-widget";let r="<div class='cpuload'><strong>CPU</strong> <div class='bgload'><div class='fgload'></div></div></div>";r+="<div class='gpuload'><strong>GFX</strong> <div class='bgload'><div class='fgload'></div></div></div>",t.innerHTML=r,this.root.querySelector(".header .tools-left").appendChild(t);const s=this.graph.execution_time||0,n=this;setInterval(function(){t.querySelector(".cpuload .fgload").style.width=2*s*90+"px",n.graph.status==LGraph.STATUS_RUNNING?t.querySelector(".gpuload .fgload").style.width=n.graphcanvas.render_time*10*90+"px":t.querySelector(".gpuload .fgload").style.width="4px"},200)}addToolsButton(t,r,s,n,a){a||(a=".tools");const o=this.createButton(r,s,n);o.id=t,this.root.querySelector(a).appendChild(o)}createButton(t,r,s){const n=document.createElement("button");return r&&(n.innerHTML="<img src='"+r+"'/> "),n.classList.add("btn"),n.innerHTML+=t,s&&n.addEventListener("click",s),n}onLoadButton(){const t=this.graphcanvas.createPanel("Load session",{closable:!0});this.root.appendChild(t)}onSaveButton(){}onPlayButton(){const t=this.graph,r=this.root.querySelector("#playnode_button");t.status==LGraph.STATUS_STOPPED?(r.innerHTML="<img src='/editor/imgs/icon-stop.png'/> Stop",t.start()):(r.innerHTML="<img src='/editor/imgs/icon-play.png'/> Play",t.stop())}onPlayStepButton(){this.graph.runStep(1),this.graphcanvas.draw(!0,!0)}onLiveButton(){const t=!this.graphcanvas.live_mode;this.graphcanvas.switchLiveMode(!0),this.graphcanvas.draw(),this.graphcanvas.live_mode;const r=this.root.querySelector("#livemode_button");r.innerHTML=t?"<img src='/editor/imgs/icon-gear.png'/> Edit":"<img src='/editor/imgs/icon-record.png'/> Live"}onDropItem(t){const r=this;for(let s=0;s<t.dataTransfer.files.length;++s){const n=t.dataTransfer.files[s],a=LGraphCanvas.getFileExtension(n.name),o=new FileReader;a=="json"&&(o.onload=function(l){const h=JSON.parse(l.target.result);r.graph.configure(h)},o.readAsText(n))}}goFullscreen(){if(this.root.requestFullscreen)this.root.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT);else if(this.root.mozRequestFullscreen)this.root.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT);else if(this.root.webkitRequestFullscreen)this.root.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);else throw"Fullscreen not supported";const t=this;setTimeout(function(){t.graphcanvas.resize()},100)}onFullscreenButton(){this.goFullscreen()}addMiniWindow(t,r){const s=document.createElement("div");s.className="litegraph miniwindow",s.innerHTML="<canvas class='graphcanvas' width='"+t+"' height='"+r+"' tabindex=10></canvas>";const n=s.querySelector("canvas"),a=this,o=new LGraphCanvas(n,this.graph);o.show_info=!1,o.background_image="/editor/imgs/grid.png",o.scale=.25,o.allow_dragnodes=!1,o.allow_interaction=!1,o.render_shadows=!1,o.max_zoom=.25,this.miniwindow_graphcanvas=o,o.onClear=function(){o.scale=.25,o.allow_dragnodes=!1,o.allow_interaction=!1},o.onRenderBackground=function(h,c){c.strokeStyle="#567";let u=a.graphcanvas.convertOffsetToCanvas([0,0]),p=a.graphcanvas.convertOffsetToCanvas([a.graphcanvas.canvas.width,a.graphcanvas.canvas.height]);u=this.convertCanvasToOffset(u),p=this.convertCanvasToOffset(p),c.lineWidth=1,c.strokeRect(Math.floor(u[0])+.5,Math.floor(u[1])+.5,Math.floor(p[0]-u[0]),Math.floor(p[1]-u[1]))},s.style.position="absolute",s.style.top="4px",s.style.right="4px";const l=document.createElement("div");l.className="corner-button",l.innerHTML="&#10060;",l.addEventListener("click",function(h){o.setGraph(null),s.parentNode.removeChild(s)}),s.appendChild(l),this.root.querySelector(".content").appendChild(s)}async addMultiview(){const t=this.canvas;this.graphcanvas.background_image="imgs/grid.png",this.graphcanvas.viewport=[0,0,t.width*.5-2,t.height];const r=new LGraphCanvas(t,this.graph);await r._init(t),r.background_image="imgs/grid.png",this.graphcanvas2=r,this.graphcanvas2.viewport=[t.width*.5,0,t.width*.5,t.height],this.graphcanvas.draw(!0,!0),this.graphcanvas2.draw(!0,!0)}subMultiview(){const t=this.canvas;this.graphcanvas.background_image="imgs/grid.png",this.graphcanvas.viewport=[0,0,t.width,t.height],this.graphcanvas2.viewport=[0,0,0,0],this.graphcanvas.draw(!0,!0),this.graphcanvas2.draw(!0,!0)}}class RootNode extends LGraphNode{constructor(){super(),this.mode=0,this.addProperty("status",0,"number"),this.addProperty("message","","string")}}class ManualTrigger extends RootNode{constructor(){super(),this.title=" "}onExecute(){}}LiteGraph.registerNodeType("trigger/manualTrigger",ManualTrigger);const de=class de{constructor(){}static getAudioContext(){if(!this._audio_context){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return console.error("AudioContext not supported by browser"),null;this._audio_context=new AudioContext,this._audio_context.onmessage=function(t){console.log("msg",t)},this._audio_context.onended=function(t){console.log("ended",t)},this._audio_context.oncomplete=function(t){console.log("complete",t)}}return this._audio_context}static connect(t,r){try{t.connect(r)}catch(s){console.warn("LGraphAudio:",s)}}static disconnect(t,r){try{t.disconnect(r)}catch(s){console.warn("LGraphAudio:",s)}}static changeAllAudiosConnections(t,r){if(t.inputs)for(var s=0;s<t.inputs.length;++s){var n=t.inputs[s],a=t.graph.links[n.link];if(a){var o=t.graph.getNodeById(a.origin_id),l=null;o.getAudioNodeInOutputSlot?l=o.getAudioNodeInOutputSlot(a.origin_slot):l=o.audionode;var h=null;t.getAudioNodeInInputSlot?h=t.getAudioNodeInInputSlot(s):h=t.audionode,r?de.connect(l,h):de.disconnect(l,h)}}if(t.outputs)for(var s=0;s<t.outputs.length;++s)for(var c=t.outputs[s],u=0;u<c.links.length;++u){var a=t.graph.links[c.links[u]];if(a){var l=null;t.getAudioNodeInOutputSlot?l=t.getAudioNodeInOutputSlot(s):l=t.audionode;var p=t.graph.getNodeById(a.target_id),h=null;p.getAudioNodeInInputSlot?h=p.getAudioNodeInInputSlot(a.target_slot):h=p.audionode,r?de.connect(l,h):de.disconnect(l,h)}}}static onConnectionsChange(t,r,s,n){if(t==LiteGraph.OUTPUT){var a=null;if(n&&(a=this.graph.getNodeById(n.target_id)),!!a){var o=null;this.getAudioNodeInOutputSlot?o=this.getAudioNodeInOutputSlot(r):o=this.audionode;var l=null;a.getAudioNodeInInputSlot?l=a.getAudioNodeInInputSlot(n.target_slot):l=a.audionode,s?de.connect(o,l):de.disconnect(o,l)}}}static createAudioNodeWrapper(t){var r=t.prototype.onPropertyChanged;t.prototype.onPropertyChanged=function(s,n){r&&r.call(this,s,n),this.audionode&&this.audionode[s]!==void 0&&(this.audionode[s].value!==void 0?this.audionode[s].value=n:this.audionode[s]=n)},t.prototype.onConnectionsChange=de.onConnectionsChange}static loadSound(t,r,s){if(de.cached_audios[t]&&t.indexOf("blob:")==-1){r&&r(de.cached_audios[t]);return}de.onProcessAudioURL&&(t=de.onProcessAudioURL(t));var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer";var a=de.getAudioContext();n.onload=function(){console.log("AudioSource loaded"),a.decodeAudioData(n.response,function(l){console.log("AudioSource decoded"),de.cached_audios[t]=l,r&&r(l)},o)},n.send();function o(l){console.log("Audio loading sample error:",l),s&&s(l)}return n}};R(de,"cached_audios",{});let LGAudio=de;class LGAudioSource extends LGraphNode{constructor(){super();R(this,"onConnectionsChange",LGAudio.onConnectionsChange);this.title="Source",this.desc="Plays audio",this.properties={src:"",gain:.5,loop:!0,autoplay:!0,playbackRate:1},this._loading_audio=!1,this._audiobuffer=null,this._audionodes=[],this._last_sourcenode=null,this.addOutput("out","audio"),this.addInput("gain","number");var r=LGAudio.getAudioContext();this.audionode=r.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain,this.properties.src&&this.loadSound(this.properties.src)}onAdded(r){r.status===LGraph.STATUS_RUNNING&&this.onStart()}onStart(){this._audiobuffer&&this.properties.autoplay&&this.playBuffer(this._audiobuffer)}onStop(){this.stopAllSounds()}onPause(){this.pauseAllSounds()}onUnpause(){this.unpauseAllSounds()}onRemoved(){this.stopAllSounds(),this._dropped_url&&URL.revokeObjectURL(this._url)}stopAllSounds(){for(var r=0;r<this._audionodes.length;++r)this._audionodes[r].started&&(this._audionodes[r].started=!1,this._audionodes[r].stop());this._audionodes.length=0}pauseAllSounds(){LGAudio.getAudioContext().suspend()}unpauseAllSounds(){LGAudio.getAudioContext().resume()}onExecute(){if(this.inputs)for(var r=0;r<this.inputs.length;++r){var s=this.inputs[r];if(s.link!=null){var n=this.getInputData(r);if(n!==void 0){if(s.name=="gain")this.audionode.gain.value=n;else if(s.name=="src")this.setProperty("src",n);else if(s.name=="playbackRate"){this.properties.playbackRate=n;for(var a=0;a<this._audionodes.length;++a)this._audionodes[a].playbackRate.value=n}}}}if(this.outputs)for(var r=0;r<this.outputs.length;++r){var o=this.outputs[r];o.name=="buffer"&&this._audiobuffer&&this.setOutputData(r,this._audiobuffer)}}onAction(r){this._audiobuffer&&(r=="Play"?this.playBuffer(this._audiobuffer):r=="Stop"&&this.stopAllSounds())}onPropertyChanged(r,s){if(r=="src")this.loadSound(s);else if(r=="gain")this.audionode.gain.value=s;else if(r=="playbackRate")for(var n=0;n<this._audionodes.length;++n)this._audionodes[n].playbackRate.value=s}playBuffer(r){var s=this,n=LGAudio.getAudioContext(),a=n.createBufferSource();return this._last_sourcenode=a,a.graphnode=this,a.buffer=r,a.loop=this.properties.loop,a.playbackRate.value=this.properties.playbackRate,this._audionodes.push(a),a.connect(this.audionode),this._audionodes.push(a),this.trigger("start"),a.onended=function(){s.trigger("ended");var o=s._audionodes.indexOf(a);o!=-1&&s._audionodes.splice(o,1)},a.started||(a.started=!0,a.start()),a}loadSound(r){var s=this;if(this._request&&(this._request.abort(),this._request=null),this._audiobuffer=null,this._loading_audio=!1,!r)return;this._request=LGAudio.loadSound(r,n),this._loading_audio=!0,this.boxcolor="#AA4";function n(a){this.boxcolor=LiteGraph.NODE_DEFAULT_BOXCOLOR,s._audiobuffer=a,s._loading_audio=!1,s.graph&&s.graph.status===LGraph.STATUS_RUNNING&&s.onStart()}}onGetInputs(){return[["playbackRate","number"],["src","string"],["Play",LiteGraph.ACTION],["Stop",LiteGraph.ACTION]]}onGetOutputs(){return[["buffer","audiobuffer"],["start",LiteGraph.EVENT],["ended",LiteGraph.EVENT]]}onDropFile(r){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);var s=URL.createObjectURL(r);this.properties.src=s,this.loadSound(s),this._dropped_url=s}}R(LGAudioSource,"desc","Plays an audio file"),R(LGAudioSource,"src",{widget:"resource"}),R(LGAudioSource,"supported_extensions",["wav","ogg","mp3"]);class LGAudioMediaSource extends LGraphNode{constructor(){super();R(this,"onConnectionsChange",LGAudio.onConnectionsChange);this.title="MediaSource",this.desc="Plays microphone",this.properties={gain:.5},this._audionodes=[],this._media_stream=null,this.addOutput("out","audio"),this.addInput("gain","number");var r=LGAudio.getAudioContext();this.audionode=r.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain}onAdded(r){r.status===LGraph.STATUS_RUNNING&&this.onStart()}onStart(){this._media_stream==null&&!this._waiting_confirmation&&this.openStream()}onStop(){this.audionode.gain.value=0}onPause(){this.audionode.gain.value=0}onUnpause(){this.audionode.gain.value=this.properties.gain}onRemoved(){if(this.audionode.gain.value=0,this.audiosource_node&&(this.audiosource_node.disconnect(this.audionode),this.audiosource_node=null),this._media_stream){var r=this._media_stream.getTracks();r.length&&r[0].stop()}}openStream(){if(!navigator.mediaDevices){console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.streamReady.bind(this)).catch(s);var r=this;function s(n){console.log("Media rejected",n),r._media_stream=!1,r.boxcolor="red"}}streamReady(r){this._media_stream=r,this.audiosource_node&&this.audiosource_node.disconnect(this.audionode);var s=LGAudio.getAudioContext();this.audiosource_node=s.createMediaStreamSource(r),this.audiosource_node.graphnode=this,this.audiosource_node.connect(this.audionode),this.boxcolor="white"}onExecute(){if(this._media_stream==null&&!this._waiting_confirmation&&this.openStream(),this.inputs)for(var r=0;r<this.inputs.length;++r){var s=this.inputs[r];if(s.link!=null){var n=this.getInputData(r);n!==void 0&&s.name=="gain"&&(this.audionode.gain.value=this.properties.gain=n)}}}onAction(r){r=="Play"?this.audionode.gain.value=this.properties.gain:r=="Stop"&&(this.audionode.gain.value=0)}onPropertyChanged(r,s){r=="gain"&&(this.audionode.gain.value=s)}onGetInputs(){return[["playbackRate","number"],["Play",LiteGraph.ACTION],["Stop",LiteGraph.ACTION]]}}class LGAudioAnalyser extends LGraphNode{constructor(){super(),this.title="Analyser",this.desc="Audio Analyser",this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,smoothingTimeConstant:.5};var t=LGAudio.getAudioContext();this.audionode=t.createAnalyser(),this.audionode.graphnode=this,this.audionode.fftSize=this.properties.fftSize,this.audionode.minDecibels=this.properties.minDecibels,this.audionode.maxDecibels=this.properties.maxDecibels,this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant,this.addInput("in","audio"),this.addOutput("freqs","array"),this.addOutput("samples","array"),this._freq_bin=null,this._time_bin=null}onPropertyChanged(t,r){this.audionode[t]=r}onExecute(){if(this.isOutputConnected(0)){var t=this.audionode.frequencyBinCount;(!this._freq_bin||this._freq_bin.length!=t)&&(this._freq_bin=new Uint8Array(t)),this.audionode.getByteFrequencyData(this._freq_bin),this.setOutputData(0,this._freq_bin)}if(this.isOutputConnected(1)){var t=this.audionode.frequencyBinCount;(!this._time_bin||this._time_bin.length!=t)&&(this._time_bin=new Uint8Array(t)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin)}for(var r=1;r<this.inputs.length;++r){var s=this.inputs[r];if(s.link!=null){var n=this.getInputData(r);n!==void 0&&(this.audionode[s.name].value=n)}}}onGetInputs(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]}onGetOutputs(){return[["freqs","array"],["samples","array"]]}}class LGAudioGain extends LGraphNode{constructor(){super(),this.properties={gain:1},this.audionode=LGAudio.getAudioContext().createGain(),this.addInput("in","audio"),this.addInput("gain","number"),this.addOutput("out","audio"),this.title="Gain",this.desc="Audio gain"}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var r=this.inputs[t],s=this.getInputData(t);s!==void 0&&(this.audionode[r.name].value=s)}}}class LGAudioConvolver extends LGraphNode{constructor(){super(),this.properties={impulse_src:"",normalize:!0},this.audionode=LGAudio.getAudioContext().createConvolver(),this.addInput("in","audio"),this.addOutput("out","audio"),this.title="Convolver",this.desc="Convolves the signal (used for reverb)"}onRemove(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)}onPropertyChanged(t,r){t=="impulse_src"?this.loadImpulse(r):t=="normalize"&&(this.audionode.normalize=r)}onDropFile(t){this._dropped_url&&URL.revokeObjectURL(this._dropped_url),this._dropped_url=URL.createObjectURL(t),this.properties.impulse_src=this._dropped_url,this.loadImpulse(this._dropped_url)}loadImpulse(t){var r=this;if(this._request&&(this._request.abort(),this._request=null),this._impulse_buffer=null,this._loading_impulse=!1,!t)return;this._request=LGAudio.loadSound(t,s),this._loading_impulse=!0;function s(n){r._impulse_buffer=n,r.audionode.buffer=n,console.log("Impulse signal set"),r._loading_impulse=!1}}}class LGAudioDynamicsCompressor extends LGraphNode{constructor(){super(),this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:.25},this.audionode=LGAudio.getAudioContext().createDynamicsCompressor(),this.addInput("in","audio"),this.addOutput("out","audio"),this.title="DynamicsCompressor",this.desc="Dynamics Compressor"}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var r=this.inputs[t];if(r.link!=null){var s=this.getInputData(t);s!==void 0&&(this.audionode[r.name].value=s)}}}onGetInputs(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]}}class LGAudioWaveShaper extends LGraphNode{constructor(){super(),this.properties={},this.audionode=LGAudio.getAudioContext().createWaveShaper(),this.addInput("in","audio"),this.addInput("shape","waveshape"),this.addOutput("out","audio")}onExecute(){if(!(!this.inputs||!this.inputs.length)){var t=this.getInputData(1);t!==void 0&&(this.audionode.curve=t)}}setWaveShape(t){this.audionode.curve=t}}class LGAudioMixer extends LGraphNode{constructor(){super(),this.properties={gain1:.5,gain2:.5},this.audionode=LGAudio.getAudioContext().createGain(),this.audionode1=LGAudio.getAudioContext().createGain(),this.audionode1.gain.value=this.properties.gain1,this.audionode2=LGAudio.getAudioContext().createGain(),this.audionode2.gain.value=this.properties.gain2,this.audionode1.connect(this.audionode),this.audionode2.connect(this.audionode),this.addInput("in1","audio"),this.addInput("in1 gain","number"),this.addInput("in2","audio"),this.addInput("in2 gain","number"),this.addOutput("out","audio"),this.title="Mixer",this.desc="Audio mixer"}getAudioNodeInInputSlot(t){if(t==0)return this.audionode1;if(t==2)return this.audionode2}onPropertyChanged(t,r){t=="gain1"?this.audionode1.gain.value=r:t=="gain2"&&(this.audionode2.gain.value=r)}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var r=this.inputs[t];if(!(r.link==null||r.type=="audio")){var s=this.getInputData(t);s!==void 0&&(t==1?this.audionode1.gain.value=s:t==3&&(this.audionode2.gain.value=s))}}}}class LGAudioADSR extends LGraphNode{constructor(){super(),this.properties={A:.1,D:.1,S:.1,R:.1},this.audionode=LGAudio.getAudioContext().createGain(),this.audionode.gain.value=0,this.addInput("in","audio"),this.addInput("gate","boolean"),this.addOutput("out","audio"),this.gate=!1,this.title="ADSR",this.desc="Audio envelope"}onExecute(){var t=LGAudio.getAudioContext(),r=t.currentTime,s=this.audionode,n=s.gain,a=this.getInputData(1),o=this.getInputOrProperty("A"),l=this.getInputOrProperty("D"),h=this.getInputOrProperty("S"),c=this.getInputOrProperty("R");!this.gate&&a?(n.cancelScheduledValues(0),n.setValueAtTime(0,r),n.linearRampToValueAtTime(1,r+o),n.linearRampToValueAtTime(h,r+o+l)):this.gate&&!a&&(n.cancelScheduledValues(0),n.setValueAtTime(n.value,r),n.linearRampToValueAtTime(0,r+c)),this.gate=a}onGetInputs(){return[["A","number"],["D","number"],["S","number"],["R","number"]]}}class LGAudioDelay extends LGraphNode{constructor(){super(),this.properties={delayTime:.5},this.audionode=LGAudio.getAudioContext().createDelay(10),this.audionode.delayTime.value=this.properties.delayTime,this.addInput("in","audio"),this.addInput("time","number"),this.addOutput("out","audio"),this.title="Delay",this.desc="Audio delay"}onExecute(){var t=this.getInputData(1);t!==void 0&&(this.audionode.delayTime.value=t)}}class LGAudioBiquadFilter extends LGraphNode{constructor(){super(),this.properties={frequency:350,detune:0,Q:1},this.addProperty("type","lowpass","enum",{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}),this.audionode=LGAudio.getAudioContext().createBiquadFilter(),this.addInput("in","audio"),this.addOutput("out","audio"),this.title="BiquadFilter",this.desc="Audio filter"}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var r=this.inputs[t];if(r.link!=null){var s=this.getInputData(t);s!==void 0&&(this.audionode[r.name].value=s)}}}onGetInputs(){return[["frequency","number"],["detune","number"],["Q","number"]]}}class LGAudioOscillatorNode extends LGraphNode{constructor(){super(),this.properties={frequency:440,detune:0,type:"sine"},this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]}),this.audionode=LGAudio.getAudioContext().createOscillator(),this.addOutput("out","audio"),this.title="Oscillator",this.desc="Oscillator"}onStart(){if(!this.audionode.started){this.audionode.started=!0;try{this.audionode.start()}catch{}}}onStop(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())}onPause(){this.onStop()}onUnpause(){this.onStart()}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=0;t<this.inputs.length;++t){var r=this.inputs[t];if(r.link!=null){var s=this.getInputData(t);s!==void 0&&(this.audionode[r.name].value=s)}}}onGetInputs(){return[["frequency","number"],["detune","number"],["type","string"]]}}class LGAudioVisualization extends LGraphNode{constructor(){super(),this.properties={continuous:!0,mark:-1},this.addInput("data","array"),this.addInput("mark","number"),this.size=[300,200],this._last_buffer=null,this.title="Visualization",this.desc="Audio Visualization"}onExecute(){this._last_buffer=this.getInputData(0);var t=this.getInputData(1);t!==void 0&&(this.properties.mark=t),this.setDirtyCanvas(!0,!1)}onDrawForeground(t){if(this._last_buffer){var r=this._last_buffer,s=r.length/this.size[0],n=this.size[1];t.fillStyle="black",t.fillRect(0,0,this.size[0],this.size[1]),t.strokeStyle="white",t.beginPath();var a=0;if(this.properties.continuous){t.moveTo(a,n);for(var o=0;o<r.length;o+=s)t.lineTo(a,n-r[o|0]/255*n),a++}else for(var o=0;o<r.length;o+=s)t.moveTo(a+.5,n),t.lineTo(a+.5,n-r[o|0]/255*n),a++;if(t.stroke(),this.properties.mark>=0){var l=LGAudio.getAudioContext().sampleRate,h=l/r.length,a=2*(this.properties.mark/h)/s;a>=this.size[0]&&(a=this.size[0]-1),t.strokeStyle="red",t.beginPath(),t.moveTo(a,n),t.lineTo(a,0),t.stroke()}}}}class LGAudioBandSignal extends LGraphNode{constructor(){super(),this.properties={band:440,amplitude:1},this.addInput("freqs","array"),this.addOutput("signal","number"),this.title="Signal",this.desc="extract the signal of some frequency"}onExecute(){if(this._freqs=this.getInputData(0),!!this._freqs){var t=this.properties.band,a=this.getInputData(1);a!==void 0&&(t=a);var r=LGAudio.getAudioContext().sampleRate,s=r/this._freqs.length,n=2*(t/s),a=0;if(n<0&&(a=this._freqs[0]),n>=this._freqs.length)a=this._freqs[this._freqs.length-1];else{var o=n|0,l=this._freqs[o],h=this._freqs[o+1],c=n-o;a=l*(1-c)+h*c}this.setOutputData(0,a/255*this.properties.amplitude)}}onGetInputs(){return[["band","number"]]}}const be=class be extends LGraphNode{constructor(){if(super(),this.title="Script",this.desc="apply script to signal",!be.default_code){var t=be.default_function.toString(),r=t.indexOf("{")+1,s=t.lastIndexOf("}");be.default_code=t.substr(r,s-r)}this.properties={code:be.default_code};var n=LGAudio.getAudioContext();n.createScriptProcessor?this.audionode=n.createScriptProcessor(4096,1,1):(console.warn("ScriptProcessorNode deprecated"),this.audionode=n.createGain()),this.processCode(),be._bypass_function||(be._bypass_function=this.audionode.onaudioprocess),this.addInput("in","audio"),this.addOutput("out","audio")}onAdded(t){t.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)}onStart(){this.audionode.onaudioprocess=this._callback}onStop(){this.audionode.onaudioprocess=be._bypass_function}onPause(){this.audionode.onaudioprocess=be._bypass_function}onUnpause(){this.audionode.onaudioprocess=this._callback}onExecute(){}onRemoved(){this.audionode.onaudioprocess=be._bypass_function}processCode(){try{var t=new Function("properties",this.properties.code);this._script=new t(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(r){console.error("Error in onaudioprocess code",r),this._callback=be._bypass_function,this.audionode.onaudioprocess=this._callback}}onPropertyChanged(t,r){t=="code"&&(this.properties.code=r,this.processCode(),this.graph&&this.graph.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback))}static default_function(){this.onaudioprocess=function(t){for(var r=t.inputBuffer,s=t.outputBuffer,n=0;n<s.numberOfChannels;n++)for(var a=r.getChannelData(n),o=s.getChannelData(n),l=0;l<r.length;l++)o[l]=a[l]}}};R(be,"code",{widget:"code",type:"code"});let LGAudioScript=be;class LGAudioDestination extends LGraphNode{constructor(){super(),this.audionode=LGAudio.getAudioContext().destination,this.addInput("in","audio"),this.title="Destination",this.desc="Audio output"}}LiteGraph.registerNodeType("audio/source",LGAudioSource),LiteGraph.registerNodeType("audio/media_source",LGAudioMediaSource),LiteGraph.registerNodeType("audio/analyser",LGAudioAnalyser),LGAudio.createAudioNodeWrapper(LGAudioGain),LiteGraph.registerNodeType("audio/gain",LGAudioGain),LGAudio.createAudioNodeWrapper(LGAudioConvolver),LiteGraph.registerNodeType("audio/convolver",LGAudioConvolver),LGAudio.createAudioNodeWrapper(LGAudioDynamicsCompressor),LiteGraph.registerNodeType("audio/dynamicsCompressor",LGAudioDynamicsCompressor),LGAudio.createAudioNodeWrapper(LGAudioWaveShaper),LGAudio.createAudioNodeWrapper(LGAudioMixer),LiteGraph.registerNodeType("audio/mixer",LGAudioMixer),LGAudio.createAudioNodeWrapper(LGAudioADSR),LiteGraph.registerNodeType("audio/adsr",LGAudioADSR),LGAudio.createAudioNodeWrapper(LGAudioDelay),LiteGraph.registerNodeType("audio/delay",LGAudioDelay),LGAudio.createAudioNodeWrapper(LGAudioBiquadFilter),LiteGraph.registerNodeType("audio/biquadfilter",LGAudioBiquadFilter),LGAudio.createAudioNodeWrapper(LGAudioOscillatorNode),LiteGraph.registerNodeType("audio/oscillator",LGAudioOscillatorNode),LiteGraph.registerNodeType("audio/visualization",LGAudioVisualization),LiteGraph.registerNodeType("audio/signal",LGAudioBandSignal),LGAudio.createAudioNodeWrapper(LGAudioScript),LiteGraph.registerNodeType("audio/script",LGAudioScript),LiteGraph.registerNodeType("audio/destination",LGAudioDestination);class Time extends LGraphNode{constructor(){super(),this.addOutput("in ms","number"),this.addOutput("in sec","number"),this.title="Time",this.desc="Time"}onExecute(){this.setOutputData(0,this.graph.globaltime*1e3),this.setOutputData(1,this.graph.globaltime)}}class Subgraph extends LGraphNode{constructor(){super(),this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this),this.title="Subgraph",this.desc="Graph inside a node",this.title_color="#334"}reassignGraphUUIDs(t){const r={nodeIDs:{},linkIDs:{}};for(const s of t.nodes){const n=s.id,a=LiteGraph.uuidv4();s.id=a,r.nodeIDs[n]=a}for(const s of t.links){const n=s[0],a=LiteGraph.uuidv4();s[0]=a,r.linkIDs[n]=a,s[1]=r.nodeIDs[s[1]]??s[1],s[3]=r.nodeIDs[s[3]]??s[3]}for(const s of t.nodes){if(s.inputs)for(const n of s.inputs)n.link&&(n.link=r.linkIDs[n.link]);if(s.outputs)for(const n of s.outputs)n.links&&(n.links=n.links.map(a=>r.linkIDs[a]));if(s.type==="graph/subgraph"&&s.subgraph){const n=this.reassignGraphUUIDs(s.subgraph);Object.assign(r.nodeIDs,n.nodeIDs),Object.assign(r.linkIDs,n.linkIDs)}}return r}onGetInputs(){return[["enabled","boolean"]]}onDblClick(t,r,s){var n=this;setTimeout(function(){s.openSubgraph(n.subgraph)},10)}onAction(t,r){this.subgraph.onAction(t,r)}onExecute(){if(this.enabled=this.getInputOrProperty("enabled"),!!this.enabled){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var r=this.inputs[t],s=this.getInputData(t);this.subgraph.setInputData(r.name,s)}if(this.subgraph.runStep(),this.outputs)for(var t=0;t<this.outputs.length;t++){var n=this.outputs[t],s=this.subgraph.getOutputData(n.name);this.setOutputData(t,s)}}}sendEventToAllNodes(t,r,s){this.enabled&&this.subgraph.sendEventToAllNodes(t,r,s)}onDrawBackground(t,r,s,n){if(this.flags.collapsed)return;var a=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,o=LiteGraph.isInsideRectangle(n[0],n[1],this.pos[0],this.pos[1]+a,this.size[0],LiteGraph.NODE_TITLE_HEIGHT);let l=LiteGraph.isInsideRectangle(n[0],n[1],this.pos[0],this.pos[1]+a,this.size[0]/2,LiteGraph.NODE_TITLE_HEIGHT);t.fillStyle=o?"#555":"#222",t.beginPath(),this._shape==LiteGraph.BOX_SHAPE?l?t.rect(0,a,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT):t.rect(this.size[0]/2,a,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT):l?t.roundRect(0,a,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT,[0,0,8,8]):t.roundRect(this.size[0]/2,a,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT,[0,0,8,8]),o?t.fill():t.fillRect(0,a,this.size[0]+1,LiteGraph.NODE_TITLE_HEIGHT),t.textAlign="center",t.font="24px Arial",t.fillStyle=o?"#DDD":"#999",t.fillText("+",this.size[0]*.25,a+24),t.fillText("+",this.size[0]*.75,a+24)}onMouseDown(t,r,s){var n=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5;console.log(0),r[1]>n&&(r[0]<this.size[0]/2?(console.log(1),s.showSubgraphPropertiesDialog(this)):(console.log(2),s.showSubgraphPropertiesDialogRight(this)))}computeSize(){var t=this.inputs?this.inputs.length:0,r=this.outputs?this.outputs.length:0;return[200,Math.max(t,r)*LiteGraph.NODE_SLOT_HEIGHT+LiteGraph.NODE_TITLE_HEIGHT]}onSubgraphTrigger(t,r){var s=this.findOutputSlot(t);s!=-1&&this.triggerSlot(s)}onSubgraphNewInput(t,r){var s=this.findInputSlot(t);s==-1&&this.addInput(t,r)}onSubgraphRenamedInput(t,r){var s=this.findInputSlot(t);if(s!=-1){var n=this.getInputInfo(s);n.name=r}}onSubgraphTypeChangeInput(t,r){var s=this.findInputSlot(t);if(s!=-1){var n=this.getInputInfo(s);n.type=r}}onSubgraphRemovedInput(t){var r=this.findInputSlot(t);r!=-1&&this.removeInput(r)}onSubgraphNewOutput(t,r){var s=this.findOutputSlot(t);s==-1&&this.addOutput(t,r)}onSubgraphRenamedOutput(t,r){var s=this.findOutputSlot(t);if(s!=-1){var n=this.getOutputInfo(s);n.name=r}}onSubgraphTypeChangeOutput(t,r){var s=this.findOutputSlot(t);if(s!=-1){var n=this.getOutputInfo(s);n.type=r}}onSubgraphRemovedOutput(t){var r=this.findOutputSlot(t);r!=-1&&this.removeOutput(r)}getExtraMenuOptions(t){var r=this;return[{content:"Open",callback:function(){t.openSubgraph(r.subgraph)}}]}onResize(t){t[1]+=20}serialize(){var t=LGraphNode.prototype.serialize.call(this);return t.subgraph=this.subgraph.serialize(),t}reassignSubgraphUUIDs(t){const r={nodeIDs:{},linkIDs:{}};for(const s of t.nodes){const n=s.id,a=LiteGraph.uuidv4();if(s.id=a,r.nodeIDs[n]||r.nodeIDs[a])throw new Error(`New/old node UUID wasn't unique in changed map! ${n} ${a}`);r.nodeIDs[n]=a,r.nodeIDs[a]=n}for(const s of t.links){const n=s[0],a=LiteGraph.uuidv4();if(s[0]=a,r.linkIDs[n]||r.linkIDs[a])throw new Error(`New/old link UUID wasn't unique in changed map! ${n} ${a}`);r.linkIDs[n]=a,r.linkIDs[a]=n;const o=s[1],l=s[3];if(!r.nodeIDs[o])throw new Error(`Old node UUID not found in mapping! ${o}`);if(s[1]=r.nodeIDs[o],!r.nodeIDs[l])throw new Error(`Old node UUID not found in mapping! ${l}`);s[3]=r.nodeIDs[l]}for(const s of t.nodes){if(s.inputs)for(const n of s.inputs)n.link&&(n.link=r.linkIDs[n.link]);if(s.outputs)for(const n of s.outputs)n.links&&(n.links=n.links.map(a=>r.linkIDs[a]))}for(const s of t.nodes)if(s.type==="graph/subgraph"){const n=this.reassignGraphUUIDs(s.subgraph);r.nodeIDs.assign(n.nodeIDs),r.linkIDs.assign(n.linkIDs)}}clone(){var t=LiteGraph.createNode(this.type),r=this.serialize();if(LiteGraph.use_uuids){const s=LiteGraph.cloneObject(r.subgraph);this.reassignSubgraphUUIDs(s),r.subgraph=s}return delete r.id,delete r.inputs,delete r.outputs,t.configure(r),t}buildFromNodes(t){for(var r={},s=0,n=0;n<t.length;++n){var a=t[n];r[a.id]=a,s=Math.min(a.pos[0],s),Math.max(a.pos[0],s)}for(var n=0;n<t.length;++n){var a=t[n];if(a.inputs)for(var o=0;o<a.inputs.length;++o){var l=a.inputs[o];if(!(!l||!l.link)){var h=a.graph.links[l.link];h&&(r[h.origin_id]||this.subgraph.addInput(l.name,h.type))}}if(a.outputs)for(var o=0;o<a.outputs.length;++o){var c=a.outputs[o];if(!(!c||!c.links||!c.links.length))for(var u=!1,p=0;p<c.links.length;++p){var h=a.graph.links[c.links[p]];if(h&&!r[h.target_id]){u=!0;break}}}}}}class GraphInput extends LGraphNode{constructor(){super(),this.title="Input",this.desc="Input of the graph",this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var t=this;this.name_widget=this.addWidget("text","Name",this.properties.name,function(r){r&&t.setProperty("name",r)}),this.type_widget=this.addWidget("text","Type",this.properties.type,function(r){t.setProperty("type",r)}),this.value_widget=this.addWidget("number","Value",this.properties.value,function(r){t.setProperty("value",r)}),this.widgets_up=!0,this.size=[180,90]}onConfigure(){this.updateType()}updateType(){var t=this.properties.type;this.type_widget.value=t,this.outputs[0].type!=t&&(LiteGraph.isValidConnection(this.outputs[0].type,t)||this.disconnectOutput(0),this.outputs[0].type=t),t=="number"?(this.value_widget.type="number",this.value_widget.value=0):t=="boolean"?(this.value_widget.type="toggle",this.value_widget.value=!0):t=="string"?(this.value_widget.type="text",this.value_widget.value=""):(this.value_widget.type=null,this.value_widget.value=null),this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,t)}onPropertyChanged(t,r){if(t=="name"){if(r==""||r==this.name_in_graph||r=="enabled")return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,r):this.graph.addInput(r,this.properties.type)),this.name_widget.value=r,this.name_in_graph=r}else t=="type"&&this.updateType()}getTitle(){return this.flags.collapsed?this.properties.name:this.title}onAction(t,r){this.properties.type==LiteGraph.EVENT&&this.triggerSlot(0,r)}onExecute(){var t=this.properties.name,r=this.graph.inputs[t];if(!r){this.setOutputData(0,this.properties.value);return}this.setOutputData(0,r.value!==void 0?r.value:this.properties.value)}onRemoved(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)}}class GraphOutput extends LGraphNode{constructor(){super(),this.title="Output",this.desc="Output of the graph",this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""},this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}onPropertyChanged(t,r){if(t=="name"){if(r==""||r==this.name_in_graph||r=="enabled")return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,r):this.graph.addOutput(r,this.properties.type)),this.name_widget.value=r,this.name_in_graph=r}else t=="type"&&this.updateType()}updateType(){var t=this.properties.type;this.type_widget&&(this.type_widget.value=t),this.inputs[0].type!=t&&((t=="action"||t=="event")&&(t=LiteGraph.EVENT),LiteGraph.isValidConnection(this.inputs[0].type,t)||this.disconnectInput(0),this.inputs[0].type=t),this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,t)}onExecute(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)}onAction(t,r){this.properties.type==LiteGraph.ACTION&&this.graph.trigger(this.properties.name,r)}onRemoved(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)}getTitle(){return this.flags.collapsed?this.properties.name:this.title}}class ConstantNumber extends LGraphNode{constructor(){super(),this.addOutput("value","number"),this.addProperty("value",1),this.widget=this.addWidget("number","value",1,"value"),this.widgets_up=!0,this.size=[180,30],this.title="Const Number",this.desc="Constant number"}onExecute(){this.setOutputData(0,parseFloat(this.properties.value))}getTitle(){return this.flags.collapsed?this.properties.value:this.title}setValue(t){this.setProperty("value",t)}onDrawBackground(t){this.outputs[0].label=this.properties.value.toFixed(3)}}class ConstantBoolean extends LGraphNode{constructor(){super(),this.addOutput("bool","boolean"),this.addProperty("value",!0),this.widget=this.addWidget("toggle","value",!0,"value"),this.serialize_widgets=!0,this.widgets_up=!0,this.size=[140,30],this.title="Const Boolean",this.desc="Constant boolean"}getTitle(){return this.flags.collapsed?this.properties.value:this.title}setValue(t){this.setProperty("value",t)}onExecute(){this.setOutputData(0,this.properties.value)}onGetInputs(){return[["toggle",LiteGraph.ACTION]]}onAction(t){this.setValue(!this.properties.value)}}class ConstantString extends LGraphNode{constructor(){super(),this.addOutput("string","string"),this.addProperty("value",""),this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0,this.size=[180,30],this.title="Const String",this.desc="Constant string"}getTitle(){return this.flags.collapsed?this.properties.value:this.title}setValue(t){this.setProperty("value",t)}onExecute(){this.setOutputData(0,this.properties.value)}onDropFile(t){var r=this,s=new FileReader;s.onload=function(n){r.setProperty("value",n.target.result)},s.readAsText(t)}}class ConstantObject extends LGraphNode{constructor(){super(),this.addOutput("obj","object"),this.size=[120,30],this._object={},this.title="Const Object",this.desc="Constant Object"}onExecute(){this.setOutputData(0,this._object)}}const Fe=class Fe extends LGraphNode{constructor(){super(),this.addInput("url","string"),this.addOutput("file","string"),this.addProperty("url",""),this.addProperty("type","text"),this.widget=this.addWidget("text","url","","url"),this._data=null,Fe.title="Const File",Fe.desc="Fetches a file from an url"}setValue(t){this.setProperty("value",t)}onPropertyChanged(t,r){t=="url"&&(r==null||r==""?this._data=null:this.fetchFile(r))}onExecute(){var t=this.getInputData(0)||this.properties.url;t&&(t!=this._url||this._type!=this.properties.type)&&this.fetchFile(t),this.setOutputData(0,this._data)}fetchFile(t){var r=this;if(!t||t.constructor!==String){r._data=null,r.boxcolor=null;return}this._url=t,this._type=this.properties.type,t.substr(0,4)=="http"&&LiteGraph.proxy&&(t=LiteGraph.proxy+t.substr(t.indexOf(":")+3)),fetch(t).then(function(s){if(!s.ok)throw new Error("File not found");if(r.properties.type=="arraybuffer")return s.arrayBuffer();if(r.properties.type=="text")return s.text();if(r.properties.type=="json")return s.json();if(r.properties.type=="blob")return s.blob()}).then(function(s){r._data=s,r.boxcolor="#AEA"}).catch(function(s){r._data=null,r.boxcolor="red",console.error("error fetching file:",t)})}onDropFile(t){var r=this;this._url=t.name,this._type=this.properties.type,this.properties.url=t.name;var s=new FileReader;if(s.onload=function(n){r.boxcolor="#AEA";var a=n.target.result;r.properties.type=="json"&&(a=JSON.parse(a)),r._data=a},r.properties.type=="arraybuffer")s.readAsArrayBuffer(t);else if(r.properties.type=="text"||r.properties.type=="json")s.readAsText(t);else if(r.properties.type=="blob")return s.readAsBinaryString(t)}};R(Fe,"type",{type:"enum",values:["text","arraybuffer","blob","json"]});let ConstantFile=Fe;class JSONParse extends LGraphNode{constructor(){super(),this.addInput("parse",LiteGraph.ACTION),this.addInput("json","string"),this.addOutput("done",LiteGraph.EVENT),this.addOutput("object","object"),this.widget=this.addWidget("button","parse","",this.parse.bind(this)),this._str=null,this._obj=null,this.title="JSON Parse",this.desc="Parses JSON String into object"}parse(){if(this._str)try{this._str=this.getInputData(1),this._obj=JSON.parse(this._str),this.boxcolor="#AEA",this.triggerSlot(0)}catch{this.boxcolor="red"}}onExecute(){this._str=this.getInputData(1),this.setOutputData(1,this._obj)}onAction(t){t=="parse"&&this.parse()}}class ConstantData extends LGraphNode{constructor(){super(),this.addOutput("data","object"),this.addProperty("value",""),this.widget=this.addWidget("text","json","","value"),this.widgets_up=!0,this.size=[140,30],this._value=null,this.title="Const Data",this.desc="Constant Data"}onPropertyChanged(t,r){if(this.widget.value=r,!(r==null||r==""))try{this._value=JSON.parse(r),this.boxcolor="#AEA"}catch{this.boxcolor="red"}}onExecute(){this.setOutputData(0,this._value)}setValue(t){this.setProperty("value",t)}}class ConstantArray extends LGraphNode{constructor(){super(),this._value=[],this.addInput("json",""),this.addOutput("arrayOut","array"),this.addOutput("length","number"),this.addProperty("value","[]"),this.widget=this.addWidget("text","array",this.properties.value,"value"),this.widgets_up=!0,this.size=[140,50],this.title="Const Array",this.desc="Constant Array"}onPropertyChanged(t,r){if(this.widget.value=r,!(r==null||r==""))try{r[0]!="["?this._value=JSON.parse("["+r+"]"):this._value=JSON.parse(r),this.boxcolor="#AEA"}catch{this.boxcolor="red"}}onExecute(){var t=this.getInputData(0);if(t&&t.length){this._value||(this._value=new Array),this._value.length=t.length;for(var r=0;r<t.length;++r)this._value[r]=t[r]}this.setOutputData(0,this._value),this.setOutputData(1,this._value&&this._value.length||0)}setValue(t){this.setProperty("value",t)}}class SetArray extends LGraphNode{constructor(){super(),this.addInput("arr","array"),this.addInput("value",""),this.addOutput("arr","array"),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties.index,"index",{precision:0,step:10,min:0}),this.title="Set Array",this.desc="Sets index of array"}onExecute(){var t=this.getInputData(0);if(t){var r=this.getInputData(1);r!==void 0&&(this.properties.index&&(t[Math.floor(this.properties.index)]=r),this.setOutputData(0,t))}}}class ArrayElement extends LGraphNode{constructor(){super(),this.addInput("array","array,table,string"),this.addInput("index","number"),this.addOutput("value",""),this.addProperty("index",0),this.title="Array[i]",this.desc="Returns an element from an array"}onExecute(){var t=this.getInputData(0),r=this.getInputData(1);r==null&&(r=this.properties.index),!(t==null||r==null)&&this.setOutputData(0,t[Math.floor(Number(r))])}}class TableElement extends LGraphNode{constructor(){super(),this.addInput("table","table"),this.addInput("row","number"),this.addInput("col","number"),this.addOutput("value",""),this.addProperty("row",0),this.addProperty("column",0),this.title="Table[row][col]",this.desc="Returns an element from a table"}onExecute(){var t=this.getInputData(0),s=this.getInputData(1),r=this.getInputData(2);if(s==null&&(s=this.properties.row),r==null&&(r=this.properties.column),!(t==null||s==null||r==null)){var s=t[Math.floor(Number(s))];s?this.setOutputData(0,s[Math.floor(Number(r))]):this.setOutputData(0,null)}}}class ObjectProperty extends LGraphNode{constructor(){super(),this.addInput("obj","object"),this.addOutput("property",0),this.addProperty("value",0),this.widget=this.addWidget("text","prop.","",this.setValue.bind(this)),this.widgets_up=!0,this.size=[140,30],this._value=null,this.title="Object property",this.desc="Outputs the property of an object"}setValue(t){this.properties.value=t,this.widget.value=t}getTitle(){return this.flags.collapsed?"in."+this.properties.value:this.title}onPropertyChanged(t,r){this.widget.value=r}onExecute(){var t=this.getInputData(0);t!=null&&this.setOutputData(0,t[this.properties.value])}}class ObjectKeys extends LGraphNode{constructor(){super(),this.addInput("obj",""),this.addOutput("keys","array"),this.size=[140,30],this.title="Object keys",this.desc="Outputs an array with the keys of an object"}onExecute(){var t=this.getInputData(0);t!=null&&this.setOutputData(0,Object.keys(t))}}class SetObject extends LGraphNode{constructor(){super(),this.addInput("obj",""),this.addInput("value",""),this.addOutput("obj",""),this.properties={property:""},this.name_widget=this.addWidget("text","prop.",this.properties.property,"property"),this.title="Set Object",this.desc="Adds propertiesrty to object"}onExecute(){var t=this.getInputData(0);if(t){var r=this.getInputData(1);r!==void 0&&(this.properties.property&&(t[this.properties.property]=r),this.setOutputData(0,t))}}}class MergeObjects extends LGraphNode{constructor(){super(),this.addInput("A","object"),this.addInput("B","object"),this.addOutput("out","object"),this._result={};var t=this;this.addWidget("button","clear","",function(){t._result={}}),this.size=this.computeSize(),this.title="Merge Objects",this.desc="Creates an object copying properties from others"}onExecute(){var t=this.getInputData(0),r=this.getInputData(1),s=this._result;if(t)for(var n in t)s[n]=t[n];if(r)for(var n in r)s[n]=r[n];this.setOutputData(0,s)}}const xe=class xe extends LGraphNode{constructor(){super();R(this,"staticLITEGRAPH",0);R(this,"staticGRAPH",1);R(this,"staticGLOBALSCOPE",2);this.size=[60,30],this.addInput("in"),this.addOutput("out"),this.properties={varname:"myname",container:xe.LITEGRAPH},this.value=null,this.title="Variable",this.desc="store/read variable value"}onExecute(){var r=this.getContainer();if(this.isInputConnected(0)){this.value=this.getInputData(0),r[this.properties.varname]=this.value,this.setOutputData(0,this.value);return}this.setOutputData(0,r[this.properties.varname])}getContainer(){switch(this.properties.container){case xe.GRAPH:return this.graph?this.graph.vars:{};case xe.GLOBALSCOPE:return global;case xe.LITEGRAPH:default:return LiteGraph.Globals}}getTitle(){return this.properties.varname}};R(xe,"container",{type:"enum",values:{litegraph:xe.LITEGRAPH,graph:xe.GRAPH,global:xe.GLOBALSCOPE}});let Variable=xe;class DownloadData extends LGraphNode{constructor(){super(),this.size=[60,30],this.addInput("data",0),this.addInput("download",LiteGraph.ACTION),this.properties={filename:"data.json"},this.value=null;var t=this;this.addWidget("button","Download","",function(r){t.value&&t.downloadAsFile()}),this.title="Download",this.desc="Download some data"}downloadAsFile(){if(this.value!=null){var t=null;this.value.constructor===String?t=this.value:t=JSON.stringify(this.value);var r=new Blob([t]),s=URL.createObjectURL(r),n=document.createElement("a");n.setAttribute("href",s),n.setAttribute("download",this.properties.filename),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout(function(){URL.revokeObjectURL(s)},1e3*60)}}onAction(t,r){var s=this;setTimeout(function(){s.downloadAsFile()},100)}onExecute(){this.inputs[0]&&(this.value=this.getInputData(0))}getTitle(){return this.flags.collapsed?this.properties.filename:this.title}}class Watch extends LGraphNode{constructor(){super(),this.size=[60,30],this.addInput("value",0,{label:""}),this.value=0,this.title="Watch",this.desc="Show value of input"}onExecute(){this.inputs[0]&&(this.value=this.getInputData(0))}getTitle(){return this.flags.collapsed?this.inputs[0].label:this.title}static toString(t){if(t==null)return"null";if(t.constructor===Number)return t.toFixed(3);if(t.constructor===Array){for(var r="[",s=0;s<t.length;++s)r+=Watch.toString(t[s])+(s+1!=t.length?",":"");return r+="]",r}else return String(t)}onDrawBackground(t){this.inputs[0].label=Watch.toString(this.value)}}class Cast extends LGraphNode{constructor(){super(),this.addInput("in",0),this.addOutput("out",0),this.size=[40,30],this.title="Cast",this.desc="Allows to connect different types"}onExecute(){this.setOutputData(0,this.getInputData(0))}}class Console extends LGraphNode{constructor(){super(),this.mode=LiteGraph.ON_EVENT,this.size=[80,30],this.addProperty("msg",""),this.addInput("log",LiteGraph.EVENT),this.addInput("msg",0),this.title="Console",this.desc="Show value inside the console"}onAction(t,r){var s=this.getInputData(1);s||(s=this.properties.msg),s||(s="Event: "+r),t=="log"?console.log(s):t=="warn"?console.warn(s):t=="error"&&console.error(s)}onExecute(){var t=this.getInputData(1);t||(t=this.properties.msg),t!=null&&typeof t<"u"&&(this.properties.msg=t,console.log(t))}onGetInputs(){return[["log",LiteGraph.ACTION],["warn",LiteGraph.ACTION],["error",LiteGraph.ACTION]]}}class Alert extends LGraphNode{constructor(){super(),this.mode=LiteGraph.ON_EVENT,this.addProperty("msg",""),this.addInput("",LiteGraph.EVENT),this.widget=this.addWidget("text","Text","","msg"),this.widgets_up=!0,this.size=[200,30],this.title="Alert",this.desc="Show an alert window",this.color="#510"}onConfigure(t){this.widget.value=t.properties.msg}onAction(t,r){var s=this.properties.msg;setTimeout(function(){alert(s)},10)}}class NodeScript extends LGraphNode{constructor(){super(),this.size=[60,30],this.addProperty("onExecute","return A;"),this.addInput("A",0),this.addInput("B",0),this.addOutput("out",0),this._func=null,this.data={},this.title="Script",this.desc="executes a code (max 256 characters)",this.widgets_info={onExecute:{type:"code"}}}onConfigure(t){t.properties.onExecute&&LiteGraph.allow_scripts?this.compileCode(t.properties.onExecute):console.warn("Script not compiled, LiteGraph.allow_scripts is false")}onPropertyChanged(t,r){t=="onExecute"&&LiteGraph.allow_scripts?this.compileCode(r):console.warn("Script not compiled, LiteGraph.allow_scripts is false")}compileCode(t){if(this._func=null,t.length>256)console.warn("Script too long, max 256 chars");else{for(var r=t.toLowerCase(),s=["script","body","document","eval","nodescript","function"],n=0;n<s.length;++n)if(r.indexOf(s[n])!=-1){console.warn("invalid script");return}try{this._func=new Function("A","B","C","DATA","node",t)}catch(a){console.error("Error parsing script"),console.error(a)}}}onExecute(){if(this._func)try{var t=this.getInputData(0),r=this.getInputData(1),s=this.getInputData(2);this.setOutputData(0,this._func(t,r,s,this.data,this))}catch(n){console.error("Error in script"),console.error(n)}}onGetOutputs(){return[["C",""]]}}const De=class De extends LGraphNode{constructor(){super(),this.addInput("A",0),this.addInput("B",0),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","==","enum",{values:De.values}),this.addWidget("combo","Op.",this.properties.OP,{property:"OP",values:De.values}),this.size=[80,60],this.title="Compare *",this.desc="evaluates condition between A and B"}getTitle(){return"*A "+this.properties.OP+" *B"}onExecute(){var t=this.getInputData(0);t===void 0?t=this.properties.A:this.properties.A=t;var r=this.getInputData(1);r===void 0?r=this.properties.B:this.properties.B=r;var s=!1;if(typeof t==typeof r)switch(this.properties.OP){case"==":case"!=":switch(s=!0,typeof t){case"object":var n=Object.getOwnPropertyNames(t),a=Object.getOwnPropertyNames(r);if(n.length!=a.length){s=!1;break}for(var o=0;o<n.length;o++){var l=n[o];if(t[l]!==r[l]){s=!1;break}}break;default:s=t==r}this.properties.OP=="!="&&(s=!s);break}this.setOutputData(0,s),this.setOutputData(1,!s)}};R(De,"values",["==","!="]),R(De,"OP",{type:"enum",title:"operation",values:De.values});let GenericCompare=De;LiteGraph.registerNodeType("basic/time",Time),LiteGraph.registerNodeType("graph/subgraph",Subgraph),LiteGraph.registerNodeType("graph/input",GraphInput),LiteGraph.registerNodeType("graph/output",GraphOutput),LiteGraph.registerNodeType("basic/const",ConstantNumber),LiteGraph.registerNodeType("basic/boolean",ConstantBoolean),LiteGraph.registerNodeType("basic/string",ConstantString),LiteGraph.registerNodeType("basic/object",ConstantObject),LiteGraph.registerNodeType("basic/file",ConstantFile),LiteGraph.registerNodeType("basic/jsonparse",JSONParse),LiteGraph.registerNodeType("basic/data",ConstantData),LiteGraph.registerNodeType("basic/array",ConstantArray),LiteGraph.registerNodeType("basic/array[]",ArrayElement),LiteGraph.registerNodeType("basic/set_array",SetArray),LiteGraph.registerNodeType("basic/table[][]",TableElement),LiteGraph.registerNodeType("basic/object_property",ObjectProperty),LiteGraph.registerNodeType("basic/object_keys",ObjectKeys),LiteGraph.registerNodeType("basic/set_object",SetObject),LiteGraph.registerNodeType("basic/merge_objects",MergeObjects),LiteGraph.registerNodeType("basic/variable",Variable),LiteGraph.registerNodeType("basic/download",DownloadData),LiteGraph.registerNodeType("basic/watch",Watch),LiteGraph.registerNodeType("basic/cast",Cast),LiteGraph.registerNodeType("basic/console",Console),LiteGraph.registerNodeType("basic/alert",Alert),LiteGraph.registerNodeType("basic/script",NodeScript),LiteGraph.registerNodeType("basic/CompareValues",GenericCompare);function LogEvent(){this.size=[60,30],this.addInput("event",LiteGraph.ACTION)}LogEvent.title="Log Event",LogEvent.desc="Log event in console",LogEvent.prototype.onAction=function(e,t,r){console.log(e,t)},LiteGraph.registerNodeType("events/log",LogEvent);function TriggerEvent(){this.size=[60,30],this.addInput("if",""),this.addOutput("true",LiteGraph.EVENT),this.addOutput("change",LiteGraph.EVENT),this.addOutput("false",LiteGraph.EVENT),this.properties={only_on_change:!0},this.prev=0}TriggerEvent.title="TriggerEvent",TriggerEvent.desc="Triggers event if input evaluates to true",TriggerEvent.prototype.onExecute=function(e,t){var r=this.getInputData(0),s=r!=this.prev;this.prev===0&&(s=!1);var n=s&&this.properties.only_on_change||!s&&!this.properties.only_on_change;r&&n&&this.triggerSlot(0,e,null,t),!r&&n&&this.triggerSlot(2,e,null,t),s&&this.triggerSlot(1,e,null,t),this.prev=r},LiteGraph.registerNodeType("events/trigger",TriggerEvent);function Sequence$1(){var e=this;this.addInput("",LiteGraph.ACTION),this.addInput("",LiteGraph.ACTION),this.addInput("",LiteGraph.ACTION),this.addOutput("",LiteGraph.EVENT),this.addOutput("",LiteGraph.EVENT),this.addOutput("",LiteGraph.EVENT),this.addWidget("button","+",null,function(){e.addInput("",LiteGraph.ACTION),e.addOutput("",LiteGraph.EVENT)}),this.size=[90,70],this.flags={horizontal:!0,render_box:!1}}Sequence$1.title="Sequence",Sequence$1.desc="Triggers a sequence of events when an event arrives",Sequence$1.prototype.getTitle=function(){return""},Sequence$1.prototype.onAction=function(e,t,r){if(this.outputs){r=r||{};for(var s=0;s<this.outputs.length;++s)this.outputs[s],r.action_call?r.action_call=r.action_call+"_seq_"+s:r.action_call=this.id+"_"+(e||"action")+"_seq_"+s+"_"+Math.floor(Math.random()*9999),this.triggerSlot(s,t,null,r)}},LiteGraph.registerNodeType("events/sequence",Sequence$1);function WaitAll(){var e=this;this.addInput("",LiteGraph.ACTION),this.addInput("",LiteGraph.ACTION),this.addOutput("",LiteGraph.EVENT),this.addWidget("button","+",null,function(){e.addInput("",LiteGraph.ACTION),e.size[0]=90}),this.size=[90,70],this.ready=[]}WaitAll.title="WaitAll",WaitAll.desc="Wait until all input events arrive then triggers output",WaitAll.prototype.getTitle=function(){return""},WaitAll.prototype.onDrawBackground=function(e){if(!this.flags.collapsed)for(var t=0;t<this.inputs.length;++t){var r=t*LiteGraph.NODE_SLOT_HEIGHT+10;e.fillStyle=this.ready[t]?"#AFB":"#000",e.fillRect(20,r,10,10)}},WaitAll.prototype.onAction=function(e,t,r,s){if(s!=null){this.ready.length=this.outputs.length,this.ready[s]=!0;for(var n=0;n<this.ready.length;++n)if(!this.ready[n])return;this.reset(),this.triggerSlot(0)}},WaitAll.prototype.reset=function(){this.ready.length=0},LiteGraph.registerNodeType("events/waitAll",WaitAll);function Stepper(){var e=this;this.properties={index:0},this.addInput("index","number"),this.addInput("step",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("index","number"),this.addOutput("",LiteGraph.EVENT),this.addOutput("",LiteGraph.EVENT),this.addOutput("",LiteGraph.EVENT,{removable:!0}),this.addWidget("button","+",null,function(){e.addOutput("",LiteGraph.EVENT,{removable:!0})}),this.size=[120,120],this.flags={render_box:!1}}Stepper.title="Stepper",Stepper.desc="Trigger events sequentially when an tick arrives",Stepper.prototype.onDrawBackground=function(e){if(!this.flags.collapsed){var t=this.properties.index||0;e.fillStyle="#AFB";var r=this.size[0],s=(t+1)*LiteGraph.NODE_SLOT_HEIGHT+4;e.beginPath(),e.moveTo(r-30,s),e.lineTo(r-30,s+LiteGraph.NODE_SLOT_HEIGHT),e.lineTo(r-15,s+LiteGraph.NODE_SLOT_HEIGHT*.5),e.fill()}},Stepper.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&(e=Math.floor(e),e=clamp(e,0,this.outputs?this.outputs.length-2:0),e!=this.properties.index&&(this.properties.index=e,this.triggerSlot(e+1))),this.setOutputData(0,this.properties.index)},Stepper.prototype.onAction=function(e,t){if(e=="reset")this.properties.index=0;else if(e=="step"){this.triggerSlot(this.properties.index+1,t);var r=this.outputs?this.outputs.length-1:0;this.properties.index=(this.properties.index+1)%r}},LiteGraph.registerNodeType("events/stepper",Stepper);function FilterEvent(){this.size=[60,30],this.addInput("event",LiteGraph.ACTION),this.addOutput("event",LiteGraph.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}FilterEvent.title="Filter Event",FilterEvent.desc="Blocks events that do not match the filter",FilterEvent.prototype.onAction=function(e,t,r){if(t!=null&&!(this.properties.equal_to&&this.properties.equal_to!=t)){if(this.properties.has_property){var s=t[this.properties.has_property];if(s==null||this.properties.property_equal_to&&this.properties.property_equal_to!=s)return}this.triggerSlot(0,t,null,r)}},LiteGraph.registerNodeType("events/filter",FilterEvent);function EventBranch(){this.addInput("in",LiteGraph.ACTION),this.addInput("cond","boolean"),this.addOutput("true",LiteGraph.EVENT),this.addOutput("false",LiteGraph.EVENT),this.size=[120,60],this._value=!1}EventBranch.title="Branch",EventBranch.desc="If condition is true, outputs triggers true, otherwise false",EventBranch.prototype.onExecute=function(){this._value=this.getInputData(1)},EventBranch.prototype.onAction=function(e,t,r){this._value=this.getInputData(1),this.triggerSlot(this._value?0:1,t,null,r)},LiteGraph.registerNodeType("events/branch",EventBranch);function EventCounter(){this.addInput("inc",LiteGraph.ACTION),this.addInput("dec",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("change",LiteGraph.EVENT),this.addOutput("num","number"),this.addProperty("doCountExecution",!1,"boolean",{name:"Count Executions"}),this.addWidget("toggle","Count Exec.",this.properties.doCountExecution,"doCountExecution"),this.num=0}EventCounter.title="Counter",EventCounter.desc="Counts events",EventCounter.prototype.getTitle=function(){return this.flags.collapsed?String(this.num):this.title},EventCounter.prototype.onAction=function(e,t,r){var s=this.num;e=="inc"?this.num+=1:e=="dec"?this.num-=1:e=="reset"&&(this.num=0),this.num!=s&&this.trigger("change",this.num)},EventCounter.prototype.onDrawBackground=function(e){this.flags.collapsed||(e.fillStyle="#AAA",e.font="20px Arial",e.textAlign="center",e.fillText(this.num,this.size[0]*.5,this.size[1]*.5))},EventCounter.prototype.onExecute=function(){this.properties.doCountExecution&&(this.num+=1),this.setOutputData(1,this.num)},LiteGraph.registerNodeType("events/counter",EventCounter);function DelayEvent(){this.size=[60,30],this.addProperty("time_in_ms",1e3),this.addInput("event",LiteGraph.ACTION),this.addOutput("on_time",LiteGraph.EVENT),this._pending=[]}DelayEvent.title="Delay",DelayEvent.desc="Delays one event",DelayEvent.prototype.onAction=function(e,t,r){var s=this.properties.time_in_ms;s<=0?this.trigger(null,t,r):this._pending.push([s,t])},DelayEvent.prototype.onExecute=function(e,t){var r=this.graph.elapsed_time*1e3;console.log("??"),this.isInputConnected(1)&&(this.properties.time_in_ms=this.getInputData(1));for(var s=0;s<this._pending.length;++s){var n=this._pending[s];n[0]-=r,!(n[0]>0)&&(this._pending.splice(s,1),--s,this.trigger(null,n[1],t))}},DelayEvent.prototype.onGetInputs=function(){return[["event",LiteGraph.ACTION],["time_in_ms","number"]]},LiteGraph.registerNodeType("events/delay",DelayEvent);function TimerEvent(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",LiteGraph.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}TimerEvent.title="Timer",TimerEvent.desc="Sends an event every N milliseconds",TimerEvent.prototype.onStart=function(){this.time=0},TimerEvent.prototype.getTitle=function(){return"Timer: "+this.last_interval.toString()+"ms"},TimerEvent.on_color="#AAA",TimerEvent.off_color="#222",TimerEvent.prototype.onDrawBackground=function(){this.boxcolor=this.triggered?TimerEvent.on_color:TimerEvent.off_color,this.triggered=!1},TimerEvent.prototype.onExecute=function(){var e=this.graph.elapsed_time*1e3,t=this.time==0;if(this.time+=e,this.last_interval=Math.max(1,this.getInputOrProperty("interval")|0),!t&&(this.time<this.last_interval||isNaN(this.last_interval))){this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!1);return}this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!0)},TimerEvent.prototype.onGetInputs=function(){return[["interval","number"]]},TimerEvent.prototype.onGetOutputs=function(){return[["tick","boolean"]]},LiteGraph.registerNodeType("events/timer",TimerEvent);function SemaphoreEvent(){this.addInput("go",LiteGraph.ACTION),this.addInput("green",LiteGraph.ACTION),this.addInput("red",LiteGraph.ACTION),this.addOutput("continue",LiteGraph.EVENT),this.addOutput("blocked",LiteGraph.EVENT),this.addOutput("is_green","boolean"),this._ready=!1,this.properties={};var e=this;this.addWidget("button","reset","",function(){e._ready=!1})}SemaphoreEvent.title="Semaphore Event",SemaphoreEvent.desc="Until both events are not triggered, it doesnt continue.",SemaphoreEvent.prototype.onExecute=function(){this.setOutputData(1,this._ready),this.boxcolor=this._ready?"#9F9":"#FA5"},SemaphoreEvent.prototype.onAction=function(e,t){e=="go"?this.triggerSlot(this._ready?0:1):e=="green"?this._ready=!0:e=="red"&&(this._ready=!1)},LiteGraph.registerNodeType("events/semaphore",SemaphoreEvent);function OnceEvent(){this.addInput("in",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("out",LiteGraph.EVENT),this._once=!1,this.properties={};var e=this;this.addWidget("button","reset","",function(){e._once=!1})}OnceEvent.title="Once",OnceEvent.desc="Only passes an event once, then gets locked",OnceEvent.prototype.onAction=function(e,t){e=="in"&&!this._once?(this._once=!0,this.triggerSlot(0,t)):e=="reset"&&(this._once=!1)},LiteGraph.registerNodeType("events/once",OnceEvent);function DataStore(){this.addInput("data",0),this.addInput("assign",LiteGraph.ACTION),this.addOutput("data",0),this._last_value=null,this.properties={data:null,serialize:!0};var e=this;this.addWidget("button","store","",function(){e.properties.data=e._last_value})}DataStore.title="Data Store",DataStore.desc="Stores data and only changes when event is received",DataStore.prototype.onExecute=function(){this._last_value=this.getInputData(0),this.setOutputData(0,this.properties.data)},DataStore.prototype.onAction=function(e,t,r){this.properties.data=this._last_value},DataStore.prototype.onSerialize=function(e){e.data!=null&&(this.properties.serialize==!1||e.data.constructor!==String&&e.data.constructor!==Number&&e.data.constructor!==Boolean&&e.data.constructor!==Array&&e.data.constructor!==Object)&&(e.data=null)},LiteGraph.registerNodeType("basic/data_store",DataStore);function GraphicsPlot(){this.addInput("A","Number"),this.addInput("B","Number"),this.addInput("C","Number"),this.addInput("D","Number"),this.values=[[],[],[],[]],this.properties={scale:2}}GraphicsPlot.title="Plot",GraphicsPlot.desc="Plots data over time",GraphicsPlot.colors=["#FFF","#F99","#9F9","#99F"],GraphicsPlot.prototype.onExecute=function(e){if(!this.flags.collapsed)for(var t=this.size,r=0;r<4;++r){var s=this.getInputData(r);if(s!=null){var n=this.values[r];n.push(s),n.length>t[0]&&n.shift()}}},GraphicsPlot.prototype.onDrawBackground=function(e){if(!this.flags.collapsed){var t=this.size,r=.5*t[1]/this.properties.scale,s=GraphicsPlot.colors,n=t[1]*.5;if(e.fillStyle="#000",e.fillRect(0,0,t[0],t[1]),e.strokeStyle="#555",e.beginPath(),e.moveTo(0,n),e.lineTo(t[0],n),e.stroke(),this.inputs)for(var a=0;a<4;++a){var o=this.values[a];if(!(!this.inputs[a]||!this.inputs[a].link)){e.strokeStyle=s[a],e.beginPath();var l=o[0]*r*-1+n;e.moveTo(0,clamp(l,0,t[1]));for(var h=1;h<o.length&&h<t[0];++h){var l=o[h]*r*-1+n;e.lineTo(h,clamp(l,0,t[1]))}e.stroke()}}}},LiteGraph.registerNodeType("graphics/plot",GraphicsPlot);function GraphicsImage(){this.addOutput("frame","image"),this.properties={url:""}}GraphicsImage.title="Image",GraphicsImage.desc="Image loader",GraphicsImage.widgets=[{name:"load",text:"Load",type:"button"}],GraphicsImage.supported_extensions=["jpg","jpeg","png","gif"],GraphicsImage.prototype.onAdded=function(){this.properties.url!=""&&this.img==null&&this.loadImage(this.properties.url)},GraphicsImage.prototype.onDrawBackground=function(e){this.flags.collapsed||this.img&&this.size[0]>5&&this.size[1]>5&&this.img.width&&e.drawImage(this.img,0,0,this.size[0],this.size[1])},GraphicsImage.prototype.onExecute=function(){this.img||(this.boxcolor="#000"),this.img&&this.img.width?this.setOutputData(0,this.img):this.setOutputData(0,null),this.img&&this.img.dirty&&(this.img.dirty=!1)},GraphicsImage.prototype.onPropertyChanged=function(e,t){return this.properties[e]=t,e=="url"&&t!=""&&this.loadImage(t),!0},GraphicsImage.prototype.loadImage=function(e,t){if(e==""){this.img=null;return}this.img=document.createElement("img"),e.substr(0,4)=="http"&&LiteGraph.proxy&&(e=LiteGraph.proxy+e.substr(e.indexOf(":")+3)),this.img.src=e,this.boxcolor="#F95";var r=this;this.img.onload=function(){t&&t(this),console.log("Image loaded, size: "+r.img.width+"x"+r.img.height),this.dirty=!0,r.boxcolor="#9F9",r.setDirtyCanvas(!0)},this.img.onerror=function(){console.log("error loading the image:"+e)}},GraphicsImage.prototype.onWidget=function(e,t){t.name=="load"&&this.loadImage(this.properties.url)},GraphicsImage.prototype.onDropFile=function(e){var t=this;this._url&&URL.revokeObjectURL(this._url),this._url=URL.createObjectURL(e),this.properties.url=this._url,this.loadImage(this._url,function(r){t.size[1]=r.height/r.width*t.size[0]})},LiteGraph.registerNodeType("graphics/image",GraphicsImage);function ColorPalette(){this.addInput("f","number"),this.addOutput("Color","color"),this.properties={colorA:"#444444",colorB:"#44AAFF",colorC:"#44FFAA",colorD:"#FFFFFF"}}ColorPalette.title="Palette",ColorPalette.desc="Generates a color",ColorPalette.prototype.onExecute=function(){var e=[];this.properties.colorA!=null&&e.push(hex2num(this.properties.colorA)),this.properties.colorB!=null&&e.push(hex2num(this.properties.colorB)),this.properties.colorC!=null&&e.push(hex2num(this.properties.colorC)),this.properties.colorD!=null&&e.push(hex2num(this.properties.colorD));var t=this.getInputData(0);if(t==null&&(t=.5),t>1?t=1:t<0&&(t=0),e.length!=0){var r=[0,0,0];if(t==0)r=e[0];else if(t==1)r=e[e.length-1];else{var s=(e.length-1)*t,n=e[Math.floor(s)],a=e[Math.floor(s)+1],o=s-Math.floor(s);r[0]=n[0]*(1-o)+a[0]*o,r[1]=n[1]*(1-o)+a[1]*o,r[2]=n[2]*(1-o)+a[2]*o}for(var l=0;l<r.length;l++)r[l]/=255;this.boxcolor=colorToString(r),this.setOutputData(0,r)}},LiteGraph.registerNodeType("color/palette",ColorPalette);function ImageFrame(){this.addInput("","image,canvas"),this.size=[200,200]}ImageFrame.title="Frame",ImageFrame.desc="Frame viewerew",ImageFrame.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"view",text:"View Image",type:"button"}],ImageFrame.prototype.onDrawBackground=function(e){this.frame&&!this.flags.collapsed&&e.drawImage(this.frame,0,0,this.size[0],this.size[1])},ImageFrame.prototype.onExecute=function(){this.frame=this.getInputData(0),this.setDirtyCanvas(!0)},ImageFrame.prototype.onWidget=function(e,t){if(t.name=="resize"&&this.frame){var r=this.frame.width,s=this.frame.height;!r&&this.frame.videoWidth!=null&&(r=this.frame.videoWidth,s=this.frame.videoHeight),r&&s&&(this.size=[r,s]),this.setDirtyCanvas(!0,!0)}else t.name=="view"&&this.show()},ImageFrame.prototype.show=function(){showElement&&this.frame&&showElement(this.frame)},LiteGraph.registerNodeType("graphics/frame",ImageFrame);function ImageFade(){this.addInputs([["img1","image"],["img2","image"],["fade","number"]]),this.addOutput("","image"),this.properties={fade:.5,width:512,height:512}}ImageFade.title="Image fade",ImageFade.desc="Fades between images",ImageFade.widgets=[{name:"resizeA",text:"Resize to A",type:"button"},{name:"resizeB",text:"Resize to B",type:"button"}],ImageFade.prototype.onAdded=function(){this.createCanvas();var e=this.canvas.getContext("2d");e.fillStyle="#000",e.fillRect(0,0,this.properties.width,this.properties.height)},ImageFade.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},ImageFade.prototype.onExecute=function(){var e=this.canvas.getContext("2d");this.canvas.width=this.canvas.width;var t=this.getInputData(0);t!=null&&e.drawImage(t,0,0,this.canvas.width,this.canvas.height);var r=this.getInputData(2);r==null?r=this.properties.fade:this.properties.fade=r,e.globalAlpha=r;var s=this.getInputData(1);s!=null&&e.drawImage(s,0,0,this.canvas.width,this.canvas.height),e.globalAlpha=1,this.setOutputData(0,this.canvas),this.setDirtyCanvas(!0)},LiteGraph.registerNodeType("graphics/imagefade",ImageFade);function ImageCrop(){this.addInput("","image"),this.addOutput("","image"),this.properties={width:256,height:256,x:0,y:0,scale:1},this.size=[50,20]}ImageCrop.title="Crop",ImageCrop.desc="Crop Image",ImageCrop.prototype.onAdded=function(){this.createCanvas()},ImageCrop.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},ImageCrop.prototype.onExecute=function(){var e=this.getInputData(0);if(e)if(e.width){var t=this.canvas.getContext("2d");t.drawImage(e,-this.properties.x,-this.properties.y,e.width*this.properties.scale,e.height*this.properties.scale),this.setOutputData(0,this.canvas)}else this.setOutputData(0,null)},ImageCrop.prototype.onDrawBackground=function(e){this.flags.collapsed||this.canvas&&e.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.size[0],this.size[1])},ImageCrop.prototype.onPropertyChanged=function(e,t){return this.properties[e]=t,e=="scale"?(this.properties[e]=parseFloat(t),this.properties[e]==0&&(console.error("Error in scale"),this.properties[e]=1)):this.properties[e]=parseInt(t),this.createCanvas(),!0},LiteGraph.registerNodeType("graphics/cropImage",ImageCrop);function CanvasNode(){this.addInput("clear",LiteGraph.ACTION),this.addOutput("","canvas"),this.properties={width:512,height:512,autoclear:!0},this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}CanvasNode.title="Canvas",CanvasNode.desc="Canvas to render stuff",CanvasNode.prototype.onExecute=function(){var e=this.canvas,t=this.properties.width|0,r=this.properties.height|0;e.width!=t&&(e.width=t),e.height!=r&&(e.height=r),this.properties.autoclear&&this.ctx.clearRect(0,0,e.width,e.height),this.setOutputData(0,e)},CanvasNode.prototype.onAction=function(e,t){e=="clear"&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},LiteGraph.registerNodeType("graphics/canvas",CanvasNode);function DrawImageNode(){this.addInput("canvas","canvas"),this.addInput("img","image,canvas"),this.addInput("x","number"),this.addInput("y","number"),this.properties={x:0,y:0,opacity:1}}DrawImageNode.title="DrawImage",DrawImageNode.desc="Draws image into a canvas",DrawImageNode.prototype.onExecute=function(){var e=this.getInputData(0);if(e){var t=this.getInputOrProperty("img");if(t){var r=this.getInputOrProperty("x"),s=this.getInputOrProperty("y"),n=e.getContext("2d");n.drawImage(t,r,s)}}},LiteGraph.registerNodeType("graphics/drawImage",DrawImageNode);function DrawRectangleNode(){this.addInput("canvas","canvas"),this.addInput("x","number"),this.addInput("y","number"),this.addInput("w","number"),this.addInput("h","number"),this.properties={x:0,y:0,w:10,h:10,color:"white",opacity:1}}DrawRectangleNode.title="DrawRectangle",DrawRectangleNode.desc="Draws rectangle in canvas",DrawRectangleNode.prototype.onExecute=function(){var e=this.getInputData(0);if(e){var t=this.getInputOrProperty("x"),r=this.getInputOrProperty("y"),s=this.getInputOrProperty("w"),n=this.getInputOrProperty("h"),a=e.getContext("2d");a.fillRect(t,r,s,n)}},LiteGraph.registerNodeType("graphics/drawRectangle",DrawRectangleNode);function ImageVideo(){this.addInput("t","number"),this.addOutputs([["frame","image"],["t","number"],["d","number"]]),this.properties={url:"",use_proxy:!0}}ImageVideo.title="Video",ImageVideo.desc="Video playback",ImageVideo.widgets=[{name:"play",text:"PLAY",type:"minibutton"},{name:"stop",text:"STOP",type:"minibutton"},{name:"demo",text:"Demo video",type:"button"},{name:"mute",text:"Mute video",type:"button"}],ImageVideo.prototype.onExecute=function(){if(this.properties.url&&(this.properties.url!=this._video_url&&this.loadVideo(this.properties.url),!(!this._video||this._video.width==0))){var e=this.getInputData(0);e&&e>=0&&e<=1&&(this._video.currentTime=e*this._video.duration,this._video.pause()),this._video.dirty=!0,this.setOutputData(0,this._video),this.setOutputData(1,this._video.currentTime),this.setOutputData(2,this._video.duration),this.setDirtyCanvas(!0)}},ImageVideo.prototype.onStart=function(){this.play()},ImageVideo.prototype.onStop=function(){this.stop()},ImageVideo.prototype.loadVideo=function(e){this._video_url=e;var t=e.substr(0,10).indexOf(":"),r="";t!=-1&&(r=e.substr(0,t));var s="";r&&(s=e.substr(0,e.indexOf("/",r.length+3)),s=s.substr(r.length+3)),this.properties.use_proxy&&r&&LiteGraph.proxy&&s!=location.host&&(e=LiteGraph.proxy+e.substr(e.indexOf(":")+3)),this._video=document.createElement("video"),this._video.src=e,this._video.type="type=video/mp4",this._video.muted=!0,this._video.autoplay=!0;var n=this;this._video.addEventListener("loadedmetadata",function(a){console.log("Duration: "+this.duration+" seconds"),console.log("Size: "+this.videoWidth+","+this.videoHeight),n.setDirtyCanvas(!0),this.width=this.videoWidth,this.height=this.videoHeight}),this._video.addEventListener("progress",function(a){console.log("video loading...")}),this._video.addEventListener("error",function(a){if(console.error("Error loading video: "+this.src),this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:console.error("You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:console.error("Network error - please try again later.");break;case this.error.MEDIA_ERR_DECODE:console.error("Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:console.error("Sorry, your browser can't play this video.");break}}),this._video.addEventListener("ended",function(a){console.log("Video Ended."),this.play()})},ImageVideo.prototype.onPropertyChanged=function(e,t){return this.properties[e]=t,e=="url"&&t!=""&&this.loadVideo(t),!0},ImageVideo.prototype.play=function(){this._video&&this._video.videoWidth&&this._video.play()},ImageVideo.prototype.playPause=function(){this._video&&(this._video.paused?this.play():this.pause())},ImageVideo.prototype.stop=function(){this._video&&(this._video.pause(),this._video.currentTime=0)},ImageVideo.prototype.pause=function(){this._video&&(console.log("Video paused"),this._video.pause())},ImageVideo.prototype.onWidget=function(e,t){},LiteGraph.registerNodeType("graphics/video",ImageVideo);function ImageWebcam(){this.addOutput("Webcam","image"),this.properties={filterFacingMode:!1,facingMode:"user"},this.boxcolor="black",this.frame=0}ImageWebcam.title="Webcam",ImageWebcam.desc="Webcam image",ImageWebcam.is_webcam_open=!1,ImageWebcam.prototype.openStream=function(){if(!navigator.mediaDevices.getUserMedia){console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0;var e={audio:!1,video:this.properties.filterFacingMode?{facingMode:this.properties.facingMode}:!0};navigator.mediaDevices.getUserMedia(e).then(this.streamReady.bind(this)).catch(r);var t=this;function r(s){console.log("Webcam rejected",s),t._webcam_stream=!1,ImageWebcam.is_webcam_open=!1,t.boxcolor="red",t.trigger("stream_error")}},ImageWebcam.prototype.closeStream=function(){if(this._webcam_stream){var e=this._webcam_stream.getTracks();if(e.length)for(var t=0;t<e.length;++t)e[t].stop();ImageWebcam.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},ImageWebcam.prototype.onPropertyChanged=function(e,t){e=="facingMode"&&(this.properties.facingMode=t,this.closeStream(),this.openStream())},ImageWebcam.prototype.onRemoved=function(){this.closeStream()},ImageWebcam.prototype.streamReady=function(e){this._webcam_stream=e,this.boxcolor="green";var t=this._video;t||(t=document.createElement("video"),t.autoplay=!0,t.srcObject=e,this._video=t,t.onloadedmetadata=function(r){console.log(r),ImageWebcam.is_webcam_open=!0}),this.trigger("stream_ready",t)},ImageWebcam.prototype.onExecute=function(){if(this._webcam_stream==null&&!this._waiting_confirmation&&this.openStream(),!(!this._video||!this._video.videoWidth)){this._video.frame=++this.frame,this._video.width=this._video.videoWidth,this._video.height=this._video.videoHeight,this.setOutputData(0,this._video);for(var e=1;e<this.outputs.length;++e)if(this.outputs[e])switch(this.outputs[e].name){case"width":this.setOutputData(e,this._video.videoWidth);break;case"height":this.setOutputData(e,this._video.videoHeight);break}}},ImageWebcam.prototype.getExtraMenuOptions=function(e){var t=this,r=t.properties.show?"Hide Frame":"Show Frame";return[{content:r,callback:function(){t.properties.show=!t.properties.show}}]},ImageWebcam.prototype.onDrawBackground=function(e){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._video&&(e.save(),e.drawImage(this._video,0,0,this.size[0],this.size[1]),e.restore())},ImageWebcam.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",LiteGraph.EVENT],["stream_closed",LiteGraph.EVENT],["stream_error",LiteGraph.EVENT]]},LiteGraph.registerNodeType("graphics/webcam",ImageWebcam);function GamepadInput(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",LiteGraph.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}GamepadInput.title="Gamepad",GamepadInput.desc="gets the input of the gamepad",GamepadInput.CENTER=0,GamepadInput.LEFT=1,GamepadInput.RIGHT=2,GamepadInput.UP=4,GamepadInput.DOWN=8,GamepadInput.zero=new Float32Array(2),GamepadInput.buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"],GamepadInput.prototype.onExecute=function(){var e=this.getGamepad(),t=this.properties.threshold||0;if(e&&(this._left_axis[0]=Math.abs(e.xbox.axes.lx)>t?e.xbox.axes.lx:0,this._left_axis[1]=Math.abs(e.xbox.axes.ly)>t?e.xbox.axes.ly:0,this._right_axis[0]=Math.abs(e.xbox.axes.rx)>t?e.xbox.axes.rx:0,this._right_axis[1]=Math.abs(e.xbox.axes.ry)>t?e.xbox.axes.ry:0,this._triggers[0]=Math.abs(e.xbox.axes.ltrigger)>t?e.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(e.xbox.axes.rtrigger)>t?e.xbox.axes.rtrigger:0),this.outputs)for(var r=0;r<this.outputs.length;r++){var s=this.outputs[r];if(!(!s.links||!s.links.length)){var n=null;if(e)switch(s.name){case"left_axis":n=this._left_axis;break;case"right_axis":n=this._right_axis;break;case"left_x_axis":n=this._left_axis[0];break;case"left_y_axis":n=this._left_axis[1];break;case"right_x_axis":n=this._right_axis[0];break;case"right_y_axis":n=this._right_axis[1];break;case"trigger_left":n=this._triggers[0];break;case"trigger_right":n=this._triggers[1];break;case"a_button":n=e.xbox.buttons.a?1:0;break;case"b_button":n=e.xbox.buttons.b?1:0;break;case"x_button":n=e.xbox.buttons.x?1:0;break;case"y_button":n=e.xbox.buttons.y?1:0;break;case"lb_button":n=e.xbox.buttons.lb?1:0;break;case"rb_button":n=e.xbox.buttons.rb?1:0;break;case"ls_button":n=e.xbox.buttons.ls?1:0;break;case"rs_button":n=e.xbox.buttons.rs?1:0;break;case"hat_left":n=e.xbox.hatmap&GamepadInput.LEFT;break;case"hat_right":n=e.xbox.hatmap&GamepadInput.RIGHT;break;case"hat_up":n=e.xbox.hatmap&GamepadInput.UP;break;case"hat_down":n=e.xbox.hatmap&GamepadInput.DOWN;break;case"hat":n=e.xbox.hatmap;break;case"start_button":n=e.xbox.buttons.start?1:0;break;case"back_button":n=e.xbox.buttons.back?1:0;break;case"button_pressed":for(var a=0;a<this._current_buttons.length;++a)this._current_buttons[a]&&!this._previous_buttons[a]&&this.triggerSlot(r,GamepadInput.buttons[a]);break}else switch(s.name){case"button_pressed":break;case"left_axis":case"right_axis":n=GamepadInput.zero;break;default:n=0}this.setOutputData(r,n)}}},GamepadInput.mapping={a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11},GamepadInput.mapping_array=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"],GamepadInput.prototype.getGamepad=function(){var e=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!e)return null;var t=e.call(navigator),r=null;this._previous_buttons.set(this._current_buttons);for(var s=this.properties.gamepad_index;s<4;s++)if(t[s]){r=t[s];var n=this.xbox_mapping;n||(n=this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:GamepadInput.CENTER}),n.axes.lx=r.axes[0],n.axes.ly=r.axes[1],n.axes.rx=r.axes[2],n.axes.ry=r.axes[3],n.axes.ltrigger=r.buttons[6].value,n.axes.rtrigger=r.buttons[7].value,n.hat="",n.hatmap=GamepadInput.CENTER;for(var a=0;a<r.buttons.length;a++)if(this._current_buttons[a]=r.buttons[a].pressed,a<12)n.buttons[GamepadInput.mapping_array[a]]=r.buttons[a].pressed,r.buttons[a].was_pressed&&this.trigger(GamepadInput.mapping_array[a]+"_button_event");else switch(a){case 12:r.buttons[a].pressed&&(n.hat+="up",n.hatmap|=GamepadInput.UP);break;case 13:r.buttons[a].pressed&&(n.hat+="down",n.hatmap|=GamepadInput.DOWN);break;case 14:r.buttons[a].pressed&&(n.hat+="left",n.hatmap|=GamepadInput.LEFT);break;case 15:r.buttons[a].pressed&&(n.hat+="right",n.hatmap|=GamepadInput.RIGHT);break;case 16:n.buttons.home=r.buttons[a].pressed;break}return r.xbox=n,r}},GamepadInput.prototype.onDrawBackground=function(e){if(!this.flags.collapsed){var t=this._left_axis,r=this._right_axis;e.strokeStyle="#88A",e.strokeRect((t[0]+1)*.5*this.size[0]-4,(t[1]+1)*.5*this.size[1]-4,8,8),e.strokeStyle="#8A8",e.strokeRect((r[0]+1)*.5*this.size[0]-4,(r[1]+1)*.5*this.size[1]-4,8,8);var s=this.size[1]/this._current_buttons.length;e.fillStyle="#AEB";for(var n=0;n<this._current_buttons.length;++n)this._current_buttons[n]&&e.fillRect(0,s*n,6,s)}},GamepadInput.prototype.onGetOutputs=function(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",LiteGraph.EVENT],["b_button_event",LiteGraph.EVENT],["x_button_event",LiteGraph.EVENT],["y_button_event",LiteGraph.EVENT],["lb_button_event",LiteGraph.EVENT],["rb_button_event",LiteGraph.EVENT],["ls_button_event",LiteGraph.EVENT],["rs_button_event",LiteGraph.EVENT],["start_button_event",LiteGraph.EVENT],["back_button_event",LiteGraph.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",LiteGraph.EVENT]]},LiteGraph.registerNodeType("input/gamepad",GamepadInput);function WidgetButton(){this.addOutput("",LiteGraph.EVENT),this.addOutput("","boolean"),this.addProperty("text","click me"),this.addProperty("font_size",30),this.addProperty("message",""),this.size=[164,84],this.clicked=!1}WidgetButton.title="Button",WidgetButton.desc="Triggers an event",WidgetButton.font="Arial",WidgetButton.prototype.onDrawForeground=function(e){if(!this.flags.collapsed){var t=10;if(e.fillStyle="black",e.fillRect(t+1,t+1,this.size[0]-t*2,this.size[1]-t*2),e.fillStyle="#AAF",e.fillRect(t-1,t-1,this.size[0]-t*2,this.size[1]-t*2),e.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",e.fillRect(t,t,this.size[0]-t*2,this.size[1]-t*2),this.properties.text||this.properties.text===0){var r=this.properties.font_size||30;e.textAlign="center",e.fillStyle=this.clicked?"black":"white",e.font=r+"px "+WidgetButton.font,e.fillText(this.properties.text,this.size[0]*.5,this.size[1]*.5+r*.3),e.textAlign="left"}}},WidgetButton.prototype.onMouseDown=function(e,t){if(t[0]>1&&t[1]>1&&t[0]<this.size[0]-2&&t[1]<this.size[1]-2)return this.clicked=!0,this.setOutputData(1,this.clicked),this.triggerSlot(0,this.properties.message),!0},WidgetButton.prototype.onExecute=function(){this.setOutputData(1,this.clicked)},WidgetButton.prototype.onMouseUp=function(e){this.clicked=!1},LiteGraph.registerNodeType("widget/button",WidgetButton);function WidgetToggle(){this.addInput("","boolean"),this.addInput("e",LiteGraph.ACTION),this.addOutput("v","boolean"),this.addOutput("e",LiteGraph.EVENT),this.properties={font:"",value:!1},this.size=[160,44]}WidgetToggle.title="Toggle",WidgetToggle.desc="Toggles between true or false",WidgetToggle.prototype.onDrawForeground=function(e){if(!this.flags.collapsed){var t=this.size[1]*.5,r=.25,s=this.size[1]*.8;e.font=this.properties.font||(t*.8).toFixed(0)+"px Arial";var n=e.measureText(this.title).width,a=(this.size[0]-(n+t))*.5;e.fillStyle="#AAA",e.fillRect(a,s-t,t,t),e.fillStyle=this.properties.value?"#AEF":"#000",e.fillRect(a+t*r,s-t+t*r,t*(1-r*2),t*(1-r*2)),e.textAlign="left",e.fillStyle="#AAA",e.fillText(this.title,t*1.2+a,s*.85),e.textAlign="left"}},WidgetToggle.prototype.onAction=function(e){this.properties.value=!this.properties.value,this.trigger("e",this.properties.value)},WidgetToggle.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&(this.properties.value=e),this.setOutputData(0,this.properties.value)},WidgetToggle.prototype.onMouseDown=function(e,t){if(t[0]>1&&t[1]>1&&t[0]<this.size[0]-2&&t[1]<this.size[1]-2)return this.properties.value=!this.properties.value,this.graph._version++,this.trigger("e",this.properties.value),!0},LiteGraph.registerNodeType("widget/toggle",WidgetToggle);function WidgetNumber(){this.addOutput("","number"),this.size=[80,60],this.properties={min:-1e3,max:1e3,value:1,step:1},this.old_y=-1,this._remainder=0,this._precision=0,this.mouse_captured=!1}WidgetNumber.title="Number",WidgetNumber.desc="Widget to select number value",WidgetNumber.pixels_threshold=10,WidgetNumber.markers_color="#666",WidgetNumber.prototype.onDrawForeground=function(e){var t=this.size[0]*.5,r=this.size[1];r>30?(e.fillStyle=WidgetNumber.markers_color,e.beginPath(),e.moveTo(t,r*.1),e.lineTo(t+r*.1,r*.2),e.lineTo(t+r*-.1,r*.2),e.fill(),e.beginPath(),e.moveTo(t,r*.9),e.lineTo(t+r*.1,r*.8),e.lineTo(t+r*-.1,r*.8),e.fill(),e.font=(r*.7).toFixed(1)+"px Arial"):e.font=(r*.8).toFixed(1)+"px Arial",e.textAlign="center",e.font=(r*.7).toFixed(1)+"px Arial",e.fillStyle="#EEE",e.fillText(this.properties.value.toFixed(this._precision),t,r*.75)},WidgetNumber.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},WidgetNumber.prototype.onPropertyChanged=function(e,t){var r=(this.properties.step+"").split(".");this._precision=r.length>1?r[1].length:0},WidgetNumber.prototype.onMouseDown=function(e,t){if(!(t[1]<0))return this.old_y=e.canvasY,this.captureInput(!0),this.mouse_captured=!0,!0},WidgetNumber.prototype.onMouseMove=function(e){if(this.mouse_captured){var t=this.old_y-e.canvasY;e.shiftKey&&(t*=10),(e.metaKey||e.altKey)&&(t*=.1),this.old_y=e.canvasY;var r=this._remainder+t/WidgetNumber.pixels_threshold;this._remainder=r%1,r=r|0;var s=clamp(this.properties.value+r*this.properties.step,this.properties.min,this.properties.max);this.properties.value=s,this.graph._version++,this.setDirtyCanvas(!0)}},WidgetNumber.prototype.onMouseUp=function(e,t){if(e.click_time<200){var r=t[1]>this.size[1]*.5?-1:1;this.properties.value=clamp(this.properties.value+r*this.properties.step,this.properties.min,this.properties.max),this.graph._version++,this.setDirtyCanvas(!0)}this.mouse_captured&&(this.mouse_captured=!1,this.captureInput(!1))},LiteGraph.registerNodeType("widget/number",WidgetNumber);function WidgetCombo(){this.addOutput("","string"),this.addOutput("change",LiteGraph.EVENT),this.size=[80,60],this.properties={value:"A",values:"A;B;C"},this.old_y=-1,this.mouse_captured=!1,this._values=this.properties.values.split(";");var e=this;this.widgets_up=!0,this.widget=this.addWidget("combo","",this.properties.value,function(t){e.properties.value=t,e.triggerSlot(1,t)},{property:"value",values:this._values})}WidgetCombo.title="Combo",WidgetCombo.desc="Widget to select from a list",WidgetCombo.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},WidgetCombo.prototype.onPropertyChanged=function(e,t){e=="values"?(this._values=t.split(";"),this.widget.options.values=this._values):e=="value"&&(this.widget.value=t)},LiteGraph.registerNodeType("widget/combo",WidgetCombo);function WidgetKnob(){this.addOutput("","number"),this.size=[64,84],this.properties={min:0,max:1,value:.5,color:"#7AF",precision:2},this.value=-1}WidgetKnob.title="Knob",WidgetKnob.desc="Circular controller",WidgetKnob.size=[80,100],WidgetKnob.prototype.onDrawForeground=function(e){if(!this.flags.collapsed){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min));var t=this.size[0]*.5,r=this.size[1]*.5,s=Math.min(this.size[0],this.size[1])*.5-5;e.globalAlpha=1,e.save(),e.translate(t,r),e.rotate(Math.PI*.75),e.fillStyle="rgba(0,0,0,0.5)",e.beginPath(),e.moveTo(0,0),e.arc(0,0,s,0,Math.PI*1.5),e.fill(),e.strokeStyle="black",e.fillStyle=this.properties.color,e.lineWidth=2,e.beginPath(),e.moveTo(0,0),e.arc(0,0,s-4,0,Math.PI*1.5*Math.max(.01,this.value)),e.closePath(),e.fill(),e.lineWidth=1,e.globalAlpha=1,e.restore(),e.fillStyle="black",e.beginPath(),e.arc(t,r,s*.75,0,Math.PI*2,!0),e.fill(),e.fillStyle=this.mouseOver?"white":this.properties.color,e.beginPath();var n=this.value*Math.PI*1.5+Math.PI*.75;e.arc(t+Math.cos(n)*s*.65,r+Math.sin(n)*s*.65,s*.05,0,Math.PI*2,!0),e.fill(),e.fillStyle=this.mouseOver?"white":"#AAA",e.font=Math.floor(s*.5)+"px Arial",e.textAlign="center",e.fillText(this.properties.value.toFixed(this.properties.precision),t,r+s*.15)}},WidgetKnob.prototype.onExecute=function(){this.setOutputData(0,this.properties.value),this.boxcolor=LiteGraph.colorToString([this.value,this.value,this.value])},WidgetKnob.prototype.onMouseDown=function(e){return this.center=[this.size[0]*.5,this.size[1]*.5+20],this.radius=this.size[0]*.5,e.canvasY-this.pos[1]<20||LiteGraph.distance([e.canvasX,e.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius?!1:(this.oldmouse=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],this.captureInput(!0),!0)},WidgetKnob.prototype.onMouseMove=function(e){if(this.oldmouse){var t=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],r=this.value;r-=(t[1]-this.oldmouse[1])*.01,r>1?r=1:r<0&&(r=0),this.value=r,this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.oldmouse=t,this.setDirtyCanvas(!0)}},WidgetKnob.prototype.onMouseUp=function(e){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))},WidgetKnob.prototype.onPropertyChanged=function(e,t){if(e=="min"||e=="max"||e=="value")return this.properties[e]=parseFloat(t),!0},LiteGraph.registerNodeType("widget/knob",WidgetKnob);function WidgetSliderGUI(){this.addOutput("","number"),this.properties={value:.5,min:0,max:1,text:"V"};var e=this;this.size=[140,40],this.slider=this.addWidget("slider","V",this.properties.value,function(t){e.properties.value=t},this.properties),this.widgets_up=!0}WidgetSliderGUI.title="Inner Slider",WidgetSliderGUI.prototype.onPropertyChanged=function(e,t){e=="value"&&(this.slider.value=t)},WidgetSliderGUI.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},LiteGraph.registerNodeType("widget/internal_slider",WidgetSliderGUI);function WidgetHSlider(){this.size=[160,26],this.addOutput("","number"),this.properties={color:"#7AF",min:0,max:1,value:.5},this.value=-1}WidgetHSlider.title="H.Slider",WidgetHSlider.desc="Linear slider controller",WidgetHSlider.prototype.onDrawForeground=function(e){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),e.globalAlpha=1,e.lineWidth=1,e.fillStyle="#000",e.fillRect(2,2,this.size[0]-4,this.size[1]-4),e.fillStyle=this.properties.color,e.beginPath(),e.rect(4,4,(this.size[0]-8)*this.value,this.size[1]-8),e.fill()},WidgetHSlider.prototype.onExecute=function(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.setOutputData(0,this.properties.value),this.boxcolor=LiteGraph.colorToString([this.value,this.value,this.value])},WidgetHSlider.prototype.onMouseDown=function(e){return e.canvasY-this.pos[1]<0?!1:(this.oldmouse=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],this.captureInput(!0),!0)},WidgetHSlider.prototype.onMouseMove=function(e){if(this.oldmouse){var t=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],r=this.value,s=t[0]-this.oldmouse[0];r+=s/this.size[0],r>1?r=1:r<0&&(r=0),this.value=r,this.oldmouse=t,this.setDirtyCanvas(!0)}},WidgetHSlider.prototype.onMouseUp=function(e){this.oldmouse=null,this.captureInput(!1)},WidgetHSlider.prototype.onMouseLeave=function(e){},LiteGraph.registerNodeType("widget/hslider",WidgetHSlider);function WidgetProgress(){this.size=[160,26],this.addInput("","number"),this.properties={min:0,max:1,value:0,color:"#AAF"}}WidgetProgress.title="Progress",WidgetProgress.desc="Shows data in linear progress",WidgetProgress.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&(this.properties.value=e)},WidgetProgress.prototype.onDrawForeground=function(e){e.lineWidth=1,e.fillStyle=this.properties.color;var t=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min);t=Math.min(1,t),t=Math.max(0,t),e.fillRect(2,2,(this.size[0]-4)*t,this.size[1]-4)},LiteGraph.registerNodeType("widget/progress",WidgetProgress);function WidgetText(){this.addInputs("",0),this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}WidgetText.title="Text",WidgetText.desc="Shows the input value",WidgetText.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}],WidgetText.prototype.onDrawForeground=function(e){e.fillStyle=this.properties.color;var t=this.properties.value;this.properties.glowSize?(e.shadowColor=this.properties.color,e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=this.properties.glowSize):e.shadowColor="transparent";var r=this.properties.fontsize;if(e.textAlign=this.properties.align,e.font=r.toString()+"px "+this.properties.font,this.str=typeof t=="number"?t.toFixed(this.properties.decimals):t,typeof this.str=="string")for(var s=this.str.replace(/[\r\n]/g,"\\n").split("\\n"),n=0;n<s.length;n++)e.fillText(s[n],this.properties.align=="left"?15:this.size[0]-15,r*-.15+r*(parseInt(n)+1));e.shadowColor="transparent",this.last_ctx=e,e.textAlign="left"},WidgetText.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&(this.properties.value=e)},WidgetText.prototype.resize=function(){if(this.last_ctx){var e=this.str.split("\\n");this.last_ctx.font=this.properties.fontsize+"px "+this.properties.font;for(var t=0,r=0;r<e.length;r++){var s=this.last_ctx.measureText(e[r]).width;t<s&&(t=s)}this.size[0]=t+20,this.size[1]=4+e.length*this.properties.fontsize,this.setDirtyCanvas(!0)}},WidgetText.prototype.onPropertyChanged=function(e,t){return this.properties[e]=t,this.str=typeof t=="number"?t.toFixed(3):t,!0},LiteGraph.registerNodeType("widget/text",WidgetText);function WidgetPanel(){this.size=[200,100],this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}WidgetPanel.title="Panel",WidgetPanel.desc="Non interactive panel",WidgetPanel.widgets=[{name:"update",text:"Update",type:"button"}],WidgetPanel.prototype.createGradient=function(e){if(this.properties.bgcolorTop==""||this.properties.bgcolorBottom==""){this.lineargradient=0;return}this.lineargradient=e.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,this.properties.bgcolorBottom)},WidgetPanel.prototype.onDrawForeground=function(e){this.flags.collapsed||(this.lineargradient==null&&this.createGradient(e),this.lineargradient&&(e.lineWidth=1,e.strokeStyle=this.properties.borderColor,e.fillStyle=this.lineargradient,this.properties.shadowSize?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=this.properties.shadowSize):e.shadowColor="transparent",e.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),e.fill(),e.shadowColor="transparent",e.stroke()))},LiteGraph.registerNodeType("widget/panel",WidgetPanel);class Selector extends LGraphNode{constructor(){super(),this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0,this.title="Selector",this.desc="selects an output"}onDrawBackground(t){if(!this.flags.collapsed){t.fillStyle="#AFB";var r=(this.selected+1)*LiteGraph.NODE_SLOT_HEIGHT+6;t.beginPath(),t.moveTo(50,r),t.lineTo(50,r+LiteGraph.NODE_SLOT_HEIGHT),t.lineTo(34,r+LiteGraph.NODE_SLOT_HEIGHT*.5),t.fill()}}onExecute(){var t=this.getInputData(0);(t==null||t.constructor!==Number)&&(t=0),this.selected=t=Math.round(t)%(this.inputs.length-1);var r=this.getInputData(t+1);r!==void 0&&this.setOutputData(0,r)}onGetInputs(){return[["E",0],["F",0],["G",0],["H",0]]}}class Sequence extends LGraphNode{constructor(){super(),this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(","),this.title="Sequence",this.desc="select one element from a sequence from a string"}onPropertyChanged(t,r){t=="sequence"&&(this.values=r.split(","))}onExecute(){var t=this.getInputData(1);t&&t!=this.current_sequence&&(this.values=t.split(","),this.current_sequence=t);var r=this.getInputData(0);r==null&&(r=0),this.index=r=Math.round(r)%this.values.length,this.setOutputData(0,this.values[r])}}class LogicAnd extends LGraphNode{constructor(){super(),this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean"),this.title="AND",this.desc="Return true if all inputs are true"}onExecute(){var t=!0;for(var r in this.inputs)if(!this.getInputData(r)){var t=!1;break}this.setOutputData(0,t)}onGetInputs(){return[["and","boolean"]]}}class LogicOr extends LGraphNode{constructor(){super(),this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean"),this.title="OR",this.desc="Return true if at least one input is true"}onExecute(){var t=!1;for(var r in this.inputs)if(this.getInputData(r)){t=!0;break}this.setOutputData(0,t)}onGetInputs(){return[["or","boolean"]]}}class LogicNot extends LGraphNode{constructor(){super(),this.properties={},this.addInput("in","boolean"),this.addOutput("out","boolean"),this.title="NOT",this.desc="Return the logical negation"}onExecute(){var t=!this.getInputData(0);this.setOutputData(0,t)}}class LogicCompare extends LGraphNode{constructor(){super(),this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean"),this.title="bool == bool",this.desc="Compare for logical equality"}onExecute(){var t=null,r=!0;for(var s in this.inputs)if(t===null)t=this.getInputData(s);else if(t!=this.getInputData(s)){r=!1;break}this.setOutputData(0,r)}onGetInputs(){return[["bool","boolean"]]}}class LogicBranch extends LGraphNode{constructor(){super(),this.properties={},this.addInput("onTrigger",LiteGraph.ACTION),this.addInput("condition","boolean"),this.addOutput("true",LiteGraph.EVENT),this.addOutput("false",LiteGraph.EVENT),this.mode=LiteGraph.ON_TRIGGER,this.title="Branch",this.desc="Branch execution on condition"}onExecute(t,r){var s=this.getInputData(1);s?this.triggerSlot(0):this.triggerSlot(1)}}LiteGraph.registerNodeType("logic/CompareBool",LogicCompare),LiteGraph.registerNodeType("logic/NOT",LogicNot),LiteGraph.registerNodeType("logic/OR",LogicOr),LiteGraph.registerNodeType("logic/AND",LogicAnd),LiteGraph.registerNodeType("logic/sequence",Sequence),LiteGraph.registerNodeType("logic/selector",Selector),LiteGraph.registerNodeType("logic/IF",LogicBranch);function Converter(){this.addInput("in",0),this.addOutput("out",0),this.size=[80,30]}Converter.title="Converter",Converter.desc="type A to type B",Converter.prototype.onExecute=function(){var e=this.getInputData(0);if(e!=null&&this.outputs)for(var t=0;t<this.outputs.length;t++){var r=this.outputs[t];if(!(!r.links||!r.links.length)){var s=null;switch(r.name){case"number":s=e.length?e[0]:parseFloat(e);break;case"vec2":case"vec3":case"vec4":var s=null,n=1;switch(r.name){case"vec2":n=2;break;case"vec3":n=3;break;case"vec4":n=4;break}var s=new Float32Array(n);if(e.length)for(var a=0;a<e.length&&a<s.length;a++)s[a]=e[a];else s[0]=parseFloat(e);break}this.setOutputData(t,s)}}},Converter.prototype.onGetOutputs=function(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]},LiteGraph.registerNodeType("math/converter",Converter);function Bypass(){this.addInput("in"),this.addOutput("out"),this.size=[80,30]}Bypass.title="Bypass",Bypass.desc="removes the type",Bypass.prototype.onExecute=function(){var e=this.getInputData(0);this.setOutputData(0,e)},LiteGraph.registerNodeType("math/bypass",Bypass);function ToNumber(){this.addInput("in"),this.addOutput("out")}ToNumber.title="to Number",ToNumber.desc="Cast to number",ToNumber.prototype.onExecute=function(){var e=this.getInputData(0);this.setOutputData(0,Number(e))},LiteGraph.registerNodeType("math/to_number",ToNumber);function MathRange(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addOutput("clamped","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[120,50]}MathRange.title="Range",MathRange.desc="Convert a number from one range to another",MathRange.prototype.getTitle=function(){return this.flags.collapsed?(this._last_v||0).toFixed(2):this.title},MathRange.prototype.onExecute=function(){if(this.inputs)for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],r=this.getInputData(e);r!==void 0&&(this.properties[t.name]=r)}var r=this.properties.in;(r==null||r.constructor!==Number)&&(r=0);var s=this.properties.in_min,n=this.properties.in_max,a=this.properties.out_min,o=this.properties.out_max;this._last_v=(r-s)/(n-s)*(o-a)+a,this.setOutputData(0,this._last_v),this.setOutputData(1,clamp(this._last_v,a,o))},MathRange.prototype.onDrawBackground=function(e){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"},MathRange.prototype.onGetInputs=function(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]},LiteGraph.registerNodeType("math/range",MathRange);function MathRand(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}MathRand.title="Rand",MathRand.desc="Random number",MathRand.prototype.onExecute=function(){if(this.inputs)for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],r=this.getInputData(e);r!==void 0&&(this.properties[t.name]=r)}var s=this.properties.min,n=this.properties.max;this._last_v=Math.random()*(n-s)+s,this.setOutputData(0,this._last_v)},MathRand.prototype.onDrawBackground=function(e){this.outputs[0].label=(this._last_v||0).toFixed(3)},MathRand.prototype.onGetInputs=function(){return[["min","number"],["max","number"]]},LiteGraph.registerNodeType("math/rand",MathRand);function MathNoise(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}MathNoise.title="Noise",MathNoise.desc="Random number with temporal continuity",MathNoise.data=null,MathNoise.getValue=function(n,t){if(!MathNoise.data){MathNoise.data=new Float32Array(1024);for(var r=0;r<MathNoise.data.length;++r)MathNoise.data[r]=Math.random()}n=n%1024,n<0&&(n+=1024);var s=Math.floor(n),n=n-s,a=MathNoise.data[s],o=MathNoise.data[s==1023?0:s+1];return t&&(n=n*n*n*(n*(n*6-15)+10)),a*(1-n)+o*n},MathNoise.prototype.onExecute=function(){var e=this.getInputData(0)||0,t=this.properties.octaves||1,r=0,s=1,n=this.properties.seed||0;e+=n;for(var a=this.properties.speed||1,o=0,l=0;l<t&&(r+=MathNoise.getValue(e*(1+l)*a,this.properties.smooth)*s,o+=s,s*=this.properties.persistence,!(s<.001));++l);r/=o;var h=this.properties.min,c=this.properties.max;this._last_v=r*(c-h)+h,this.setOutputData(0,this._last_v)},MathNoise.prototype.onDrawBackground=function(e){this.outputs[0].label=(this._last_v||0).toFixed(3)},LiteGraph.registerNodeType("math/noise",MathNoise);function MathSpikes(){this.addOutput("out","number"),this.addProperty("min_time",1),this.addProperty("max_time",2),this.addProperty("duration",.2),this.size=[90,30],this._remaining_time=0,this._blink_time=0}MathSpikes.title="Spikes",MathSpikes.desc="spike every random time",MathSpikes.prototype.onExecute=function(){var e=this.graph.elapsed_time;this._remaining_time-=e,this._blink_time-=e;var t=0;if(this._blink_time>0){var r=this._blink_time/this.properties.duration;t=1/(Math.pow(r*8-4,4)+1)}this._remaining_time<0?(this._remaining_time=Math.random()*(this.properties.max_time-this.properties.min_time)+this.properties.min_time,this._blink_time=this.properties.duration,this.boxcolor="#FFF"):this.boxcolor="#000",this.setOutputData(0,t)},LiteGraph.registerNodeType("math/spikes",MathSpikes);function MathClamp(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("min",0),this.addProperty("max",1)}MathClamp.title="Clamp",MathClamp.desc="Clamp number between min and max",MathClamp.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&(e=Math.max(this.properties.min,e),e=Math.min(this.properties.max,e),this.setOutputData(0,e))},MathClamp.prototype.getCode=function(e){var t="";return this.isInputConnected(0)&&(t+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),t},LiteGraph.registerNodeType("math/clamp",MathClamp);function MathLerp(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}MathLerp.title="Lerp",MathLerp.desc="Linear Interpolation",MathLerp.prototype.onExecute=function(){var e=this.getInputData(0);e==null&&(e=0);var t=this.getInputData(1);t==null&&(t=0);var r=this.properties.f,s=this.getInputData(2);s!==void 0&&(r=s),this.setOutputData(0,e*(1-r)+t*r)},MathLerp.prototype.onGetInputs=function(){return[["f","number"]]},LiteGraph.registerNodeType("math/lerp",MathLerp);function MathAbs(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}MathAbs.title="Abs",MathAbs.desc="Absolute",MathAbs.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&this.setOutputData(0,Math.abs(e))},LiteGraph.registerNodeType("math/abs",MathAbs);function MathFloor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}MathFloor.title="Floor",MathFloor.desc="Floor number to remove fractional part",MathFloor.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&this.setOutputData(0,Math.floor(e))},LiteGraph.registerNodeType("math/floor",MathFloor);function MathFrac(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}MathFrac.title="Frac",MathFrac.desc="Returns fractional part",MathFrac.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&this.setOutputData(0,e%1)},LiteGraph.registerNodeType("math/frac",MathFrac);function MathSmoothStep(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.properties={A:0,B:1}}MathSmoothStep.title="Smoothstep",MathSmoothStep.desc="Smoothstep",MathSmoothStep.prototype.onExecute=function(){var e=this.getInputData(0);if(e!==void 0){var t=this.properties.A,r=this.properties.B;e=clamp((e-t)/(r-t),0,1),e=e*e*(3-2*e),this.setOutputData(0,e)}},LiteGraph.registerNodeType("math/smoothstep",MathSmoothStep);function MathScale(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[80,30],this.addProperty("factor",1)}MathScale.title="Scale",MathScale.desc="v * factor",MathScale.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&this.setOutputData(0,e*this.properties.factor)},LiteGraph.registerNodeType("math/scale",MathScale);function Gate(){this.addInput("v","boolean"),this.addInput("A"),this.addInput("B"),this.addOutput("out")}Gate.title="Gate",Gate.desc="if v is true, then outputs A, otherwise B",Gate.prototype.onExecute=function(){var e=this.getInputData(0);this.setOutputData(0,this.getInputData(e?1:2))},LiteGraph.registerNodeType("math/gate",Gate);function MathAverageFilter(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}MathAverageFilter.title="Average",MathAverageFilter.desc="Average Filter",MathAverageFilter.prototype.onExecute=function(){var e=this.getInputData(0);e==null&&(e=0);var t=this._values.length;this._values[this._current%t]=e,this._current+=1,this._current>t&&(this._current=0);for(var r=0,s=0;s<t;++s)r+=this._values[s];this.setOutputData(0,r/t)},MathAverageFilter.prototype.onPropertyChanged=function(e,t){t<1&&(t=1),this.properties.samples=Math.round(t);var r=this._values;this._values=new Float32Array(this.properties.samples),r.length<=this._values.length?this._values.set(r):this._values.set(r.subarray(0,this._values.length))},LiteGraph.registerNodeType("math/average",MathAverageFilter);function MathTendTo(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[80,30],this._value=null}MathTendTo.title="TendTo",MathTendTo.desc="moves the output value always closer to the input",MathTendTo.prototype.onExecute=function(){var e=this.getInputData(0);e==null&&(e=0);var t=this.properties.factor;this._value==null?this._value=e:this._value=this._value*(1-t)+e*t,this.setOutputData(0,this._value)},LiteGraph.registerNodeType("math/tendTo",MathTendTo);function MathOperation(){this.addInput("A","number,array,object"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:MathOperation.values}),this._func=MathOperation.funcs[this.properties.OP],this._result=[]}MathOperation.values=["+","-","*","/","%","^","max","min"],MathOperation.funcs={"+":function(e,t){return e+t},"-":function(e,t){return e-t},x:function(e,t){return e*t},X:function(e,t){return e*t},"*":function(e,t){return e*t},"/":function(e,t){return e/t},"%":function(e,t){return e%t},"^":function(e,t){return Math.pow(e,t)},max:function(e,t){return Math.max(e,t)},min:function(e,t){return Math.min(e,t)}},MathOperation.title="Operation",MathOperation.desc="Easy math operators",MathOperation["@OP"]={type:"enum",title:"operation",values:MathOperation.values},MathOperation.size=[100,60],MathOperation.prototype.getTitle=function(){return this.properties.OP=="max"||this.properties.OP=="min"?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},MathOperation.prototype.setValue=function(e){typeof e=="string"&&(e=parseFloat(e)),this.properties.value=e},MathOperation.prototype.onPropertyChanged=function(e,t){e=="OP"&&(this._func=MathOperation.funcs[this.properties.OP],this._func||(console.warn("Unknown operation: "+this.properties.OP),this._func=function(r){return r}))},MathOperation.prototype.onExecute=function(){var e=this.getInputData(0),t=this.getInputData(1);e!=null?e.constructor===Number&&(this.properties.A=e):e=this.properties.A,t!=null?this.properties.B=t:t=this.properties.B;var r=MathOperation.funcs[this.properties.OP],s;if(e.constructor===Number)s=0,s=r(e,t);else if(e.constructor===Array){s=this._result,s.length=e.length;for(var n=0;n<e.length;++n)s[n]=r(e[n],t)}else{s={};for(var n in e)s[n]=r(e[n],t)}this.setOutputData(0,s)},MathOperation.prototype.onDrawBackground=function(e){this.flags.collapsed||(e.font="40px Arial",e.fillStyle="#666",e.textAlign="center",e.fillText(this.properties.OP,this.size[0]*.5,(this.size[1]+LiteGraph.NODE_TITLE_HEIGHT)*.5),e.textAlign="left")},LiteGraph.registerNodeType("math/operation",MathOperation),LiteGraph.registerSearchboxExtra("math/operation","MAX",{properties:{OP:"max"},title:"MAX()"}),LiteGraph.registerSearchboxExtra("math/operation","MIN",{properties:{OP:"min"},title:"MIN()"});function MathCompare(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}MathCompare.title="Compare",MathCompare.desc="compares between two values",MathCompare.prototype.onExecute=function(){var e=this.getInputData(0),t=this.getInputData(1);e!==void 0?this.properties.A=e:e=this.properties.A,t!==void 0?this.properties.B=t:t=this.properties.B;for(var r=0,s=this.outputs.length;r<s;++r){var n=this.outputs[r];if(!(!n.links||!n.links.length)){var a;switch(n.name){case"A==B":a=e==t;break;case"A!=B":a=e!=t;break;case"A>B":a=e>t;break;case"A<B":a=e<t;break;case"A<=B":a=e<=t;break;case"A>=B":a=e>=t;break}this.setOutputData(r,a)}}},MathCompare.prototype.onGetOutputs=function(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]},LiteGraph.registerNodeType("math/compare",MathCompare),LiteGraph.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),LiteGraph.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),LiteGraph.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),LiteGraph.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),LiteGraph.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),LiteGraph.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"});function MathCondition(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","enum",{values:MathCondition.values}),this.addWidget("combo","Cond.",this.properties.OP,{property:"OP",values:MathCondition.values}),this.size=[80,60]}MathCondition.values=[">","<","==","!=","<=",">=","||","&&"],MathCondition["@OP"]={type:"enum",title:"operation",values:MathCondition.values},MathCondition.title="Condition",MathCondition.desc="evaluates condition between A and B",MathCondition.prototype.getTitle=function(){return"A "+this.properties.OP+" B"},MathCondition.prototype.onExecute=function(){var e=this.getInputData(0);e===void 0?e=this.properties.A:this.properties.A=e;var t=this.getInputData(1);t===void 0?t=this.properties.B:this.properties.B=t;var r=!0;switch(this.properties.OP){case">":r=e>t;break;case"<":r=e<t;break;case"==":r=e==t;break;case"!=":r=e!=t;break;case"<=":r=e<=t;break;case">=":r=e>=t;break;case"||":r=e||t;break;case"&&":r=e&&t;break}this.setOutputData(0,r),this.setOutputData(1,!r)},LiteGraph.registerNodeType("math/condition",MathCondition);function MathBranch(){this.addInput("in",0),this.addInput("cond","boolean"),this.addOutput("true",0),this.addOutput("false",0),this.size=[80,60]}MathBranch.title="Branch",MathBranch.desc="If condition is true, outputs IN in true, otherwise in false",MathBranch.prototype.onExecute=function(){var e=this.getInputData(0),t=this.getInputData(1);t?(this.setOutputData(0,e),this.setOutputData(1,null)):(this.setOutputData(0,null),this.setOutputData(1,e))},LiteGraph.registerNodeType("math/branch",MathBranch);function MathAccumulate(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}MathAccumulate.title="Accumulate",MathAccumulate.desc="Increments a value every time",MathAccumulate.prototype.onExecute=function(){this.properties.value===null&&(this.properties.value=0);var e=this.getInputData(0);e!==null?this.properties.value+=e:this.properties.value+=this.properties.increment,this.setOutputData(0,this.properties.value)},LiteGraph.registerNodeType("math/accumulate",MathAccumulate);function MathTrigonometry(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}MathTrigonometry.title="Trigonometry",MathTrigonometry.desc="Sin Cos Tan",MathTrigonometry.prototype.onExecute=function(){var e=this.getInputData(0);e==null&&(e=0);var t=this.properties.amplitude,r=this.findInputSlot("amplitude");r!=-1&&(t=this.getInputData(r));var s=this.properties.offset;r=this.findInputSlot("offset"),r!=-1&&(s=this.getInputData(r));for(var n=0,a=this.outputs.length;n<a;++n){var o=this.outputs[n],l;switch(o.name){case"sin":l=Math.sin(e);break;case"cos":l=Math.cos(e);break;case"tan":l=Math.tan(e);break;case"asin":l=Math.asin(e);break;case"acos":l=Math.acos(e);break;case"atan":l=Math.atan(e);break}this.setOutputData(n,t*l+s)}},MathTrigonometry.prototype.onGetInputs=function(){return[["v","number"],["amplitude","number"],["offset","number"]]},MathTrigonometry.prototype.onGetOutputs=function(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]},LiteGraph.registerNodeType("math/trigonometry",MathTrigonometry),LiteGraph.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),LiteGraph.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),LiteGraph.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"});function MathFormula(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.code_widget=this.addWidget("text","F(x,y)",this.properties.formula,function(e,t,r){r.properties.formula=e}),this.addWidget("toggle","allow",LiteGraph.allow_scripts,function(e){LiteGraph.allow_scripts=e}),this._func=null}MathFormula.title="Formula",MathFormula.desc="Compute formula",MathFormula.size=[160,100],MathAverageFilter.prototype.onPropertyChanged=function(e,t){e=="formula"&&(this.code_widget.value=t)},MathFormula.prototype.onExecute=function(){if(LiteGraph.allow_scripts){var e=this.getInputData(0),t=this.getInputData(1);e!=null?this.properties.x=e:e=this.properties.x,t!=null?this.properties.y=t:t=this.properties.y,this.properties.formula;var r;try{(!this._func||this._func_code!=this.properties.formula)&&(this._func=new Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula),r=this._func(e,t,this.graph.globaltime),this.boxcolor=null}catch{this.boxcolor="red"}this.setOutputData(0,r)}},MathFormula.prototype.getTitle=function(){return this._func_code||"Formula"},MathFormula.prototype.onDrawBackground=function(){var e=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=e)},LiteGraph.registerNodeType("math/formula",MathFormula);function Math3DVec2ToXY(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}Math3DVec2ToXY.title="Vec2->XY",Math3DVec2ToXY.desc="vector 2 to components",Math3DVec2ToXY.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&(this.setOutputData(0,e[0]),this.setOutputData(1,e[1]))},LiteGraph.registerNodeType("math3d/vec2-to-xy",Math3DVec2ToXY);function Math3DXYToVec2(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}Math3DXYToVec2.title="XY->Vec2",Math3DXYToVec2.desc="components to vector2",Math3DXYToVec2.prototype.onExecute=function(){var e=this.getInputData(0);e==null&&(e=this.properties.x);var t=this.getInputData(1);t==null&&(t=this.properties.y);var r=this._data;r[0]=e,r[1]=t,this.setOutputData(0,r)},LiteGraph.registerNodeType("math3d/xy-to-vec2",Math3DXYToVec2);function Math3DVec3ToXYZ(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}Math3DVec3ToXYZ.title="Vec3->XYZ",Math3DVec3ToXYZ.desc="vector 3 to components",Math3DVec3ToXYZ.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&(this.setOutputData(0,e[0]),this.setOutputData(1,e[1]),this.setOutputData(2,e[2]))},LiteGraph.registerNodeType("math3d/vec3-to-xyz",Math3DVec3ToXYZ);function Math3DXYZToVec3(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}Math3DXYZToVec3.title="XYZ->Vec3",Math3DXYZToVec3.desc="components to vector3",Math3DXYZToVec3.prototype.onExecute=function(){var e=this.getInputData(0);e==null&&(e=this.properties.x);var t=this.getInputData(1);t==null&&(t=this.properties.y);var r=this.getInputData(2);r==null&&(r=this.properties.z);var s=this._data;s[0]=e,s[1]=t,s[2]=r,this.setOutputData(0,s)},LiteGraph.registerNodeType("math3d/xyz-to-vec3",Math3DXYZToVec3);function Math3DVec4ToXYZW(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}Math3DVec4ToXYZW.title="Vec4->XYZW",Math3DVec4ToXYZW.desc="vector 4 to components",Math3DVec4ToXYZW.prototype.onExecute=function(){var e=this.getInputData(0);e!=null&&(this.setOutputData(0,e[0]),this.setOutputData(1,e[1]),this.setOutputData(2,e[2]),this.setOutputData(3,e[3]))},LiteGraph.registerNodeType("math3d/vec4-to-xyzw",Math3DVec4ToXYZW);function Math3DXYZWToVec4(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}Math3DXYZWToVec4.title="XYZW->Vec4",Math3DXYZWToVec4.desc="components to vector4",Math3DXYZWToVec4.prototype.onExecute=function(){var e=this.getInputData(0);e==null&&(e=this.properties.x);var t=this.getInputData(1);t==null&&(t=this.properties.y);var r=this.getInputData(2);r==null&&(r=this.properties.z);var s=this.getInputData(3);s==null&&(s=this.properties.w);var n=this._data;n[0]=e,n[1]=t,n[2]=r,n[3]=s,this.setOutputData(0,n)},LiteGraph.registerNodeType("math3d/xyzw-to-vec4",Math3DXYZWToVec4);const Ne=class Ne extends LGraphNode{constructor(){super(),this.title="mat4",this.addInput("T","vec3"),this.addInput("R","vec3"),this.addInput("S","vec3"),this.addOutput("mat4","mat4"),this.properties={T:[0,0,0],R:[0,0,0],S:[1,1,1],R_in_degrees:!0},this._result=create$4(),this._must_update=!0}onPropertyChanged(t,r){this._must_update=!0}onExecute(){var t=this._result,r=Ne.temp_quat,s=Ne.temp_mat4,n=Ne.temp_vec3,a=this.getInputData(0),o=this.getInputData(1),l=this.getInputData(2);(this._must_update||a||o||l)&&(a=a||this.properties.T,o=o||this.properties.R,l=l||this.properties.S,identity$1(t),translate(t,t,a),this.properties.R_in_degrees?(n.set(o),scale$3(n,n,DEG2RAD),fromEuler(r,n)):fromEuler(r,o),fromQuat(s,r),multiply$4(t,t,s),scale$4(t,t,l)),this.setOutputData(0,t)}};R(Ne,"temp_quat",new Float32Array([0,0,0,1])),R(Ne,"temp_mat4",new Float32Array(16)),R(Ne,"temp_vec3",new Float32Array(3));let Math3DMat4=Ne;const Ce=class Ce extends LGraphNode{constructor(){super(),this.title="Operation",this.desc="Easy math 3D operators",this.addInput("A","number,vec3"),this.addInput("B","number,vec3"),this.addOutput("=","number,vec3"),this.addProperty("OP","+","enum",{values:Ce.values}),this._result=create$3()}getTitle(){return this.properties.OP=="max"||this.properties.OP=="min"?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"}onExecute(){var t=this.getInputData(0),r=this.getInputData(1);if(!(t==null||r==null)){t.constructor===Number&&(t=[t,t,t]),r.constructor===Number&&(r=[r,r,r]);var s=this._result;switch(this.properties.OP){case"+":s=add$3(s,t,r);break;case"-":s=sub$2(s,t,r);break;case"x":case"X":case"*":s=mul$3(s,t,r);break;case"/":s=div$2(s,t,r);break;case"%":s[0]=t[0]%r[0],s[1]=t[1]%r[1],s[2]=t[2]%r[2];break;case"^":s[0]=Math.pow(t[0],r[0]),s[1]=Math.pow(t[1],r[1]),s[2]=Math.pow(t[2],r[2]);break;case"max":s[0]=Math.max(t[0],r[0]),s[1]=Math.max(t[1],r[1]),s[2]=Math.max(t[2],r[2]);break;case"min":s[0]=Math.min(t[0],r[0]),s[1]=Math.min(t[1],r[1]),s[2]=Math.min(t[2],r[2]);break;case"dot":s=dot$3(t,r);break;case"cross":cross$2(s,t,r);break;default:console.warn("Unknown operation: "+this.properties.OP)}this.setOutputData(0,s)}}onDrawBackground(t){this.flags.collapsed||(t.font="40px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(this.properties.OP,this.size[0]*.5,(this.size[1]+LiteGraph.NODE_TITLE_HEIGHT)*.5),t.textAlign="left")}};R(Ce,"values",["+","-","*","/","%","^","max","min","dot","cross"]),R(Ce,"@OP",{type:"enum",title:"operation",values:Ce.values}),R(Ce,"size",[100,60]);let Math3DOperation=Ce;LiteGraph.registerSearchboxExtra("math3d/operation","CROSS()",{properties:{OP:"cross"},title:"CROSS()"}),LiteGraph.registerSearchboxExtra("math3d/operation","DOT()",{properties:{OP:"dot"},title:"DOT()"});class Math3DVec3Scale extends LGraphNode{constructor(){super(),this.addInput("in","vec3"),this.addInput("f","number"),this.addOutput("out","vec3"),this.properties={f:1},this._data=new Float32Array(3),this.title="vec3_scale",this.desc="scales the components of a vec3"}onExecute(){var t=this.getInputData(0);if(t!=null){var r=this.getInputData(1);r==null&&(r=this.properties.f);var s=this._data;s[0]=t[0]*r,s[1]=t[1]*r,s[2]=t[2]*r,this.setOutputData(0,s)}}}class Math3DVec3Length extends LGraphNode{constructor(){super(),this.addInput("in","vec3"),this.addOutput("out","number"),this.title="vec3_length",this.desc="returns the module of a vector"}onExecute(){var t=this.getInputData(0);if(t!=null){var r=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);this.setOutputData(0,r)}}}class Math3DVec3Normalize extends LGraphNode{constructor(){super(),this.addInput("in","vec3"),this.addOutput("out","vec3"),this._data=new Float32Array(3),this.title="vec3_normalize",this.desc="returns the vector normalized"}onExecute(){var t=this.getInputData(0);if(t!=null){var r=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),s=this._data;s[0]=t[0]/r,s[1]=t[1]/r,s[2]=t[2]/r,this.setOutputData(0,s)}}}class Math3DVec3Lerp extends LGraphNode{constructor(){super();R(this,"onExecute",function(){var r=this.getInputData(0);if(r!=null){var s=this.getInputData(1);if(s!=null){var n=this.getInputOrProperty("f"),a=this._data;a[0]=r[0]*(1-n)+s[0]*n,a[1]=r[1]*(1-n)+s[1]*n,a[2]=r[2]*(1-n)+s[2]*n,this.setOutputData(0,a)}}});this.addInput("A","vec3"),this.addInput("B","vec3"),this.addInput("f","vec3"),this.addOutput("out","vec3"),this.properties={f:.5},this._data=new Float32Array(3),this.title="vec3_lerp",this.desc="returns the interpolated vector"}}class Math3DVec3Dot extends LGraphNode{constructor(){super(),this.addInput("A","vec3"),this.addInput("B","vec3"),this.addOutput("out","number"),this.title="vec3_dot",this.desc="returns the dot product"}onExecute(){var t=this.getInputData(0);if(t!=null){var r=this.getInputData(1);if(r!=null){var s=t[0]*r[0]+t[1]*r[1]+t[2]*r[2];this.setOutputData(0,s)}}}}class Math3DQuaternion extends LGraphNode{constructor(){super(),this.addOutput("quat","quat"),this.properties={x:0,y:0,z:0,w:1,normalize:!1},this._value=create$1(),this.title="Quaternion",this.desc="quaternion"}onExecute(){this._value[0]=this.getInputOrProperty("x"),this._value[1]=this.getInputOrProperty("y"),this._value[2]=this.getInputOrProperty("z"),this._value[3]=this.getInputOrProperty("w"),this.properties.normalize&&normalize$1(this._value,this._value),this.setOutputData(0,this._value)}onGetInputs(){return[["x","number"],["y","number"],["z","number"],["w","number"]]}}class Math3DRotation extends LGraphNode{constructor(){super(),this.addInputs([["degrees","number"],["axis","vec3"]]),this.addOutput("quat","quat"),this.properties={angle:90,axis:fromValues$3(0,1,0)},this._value=create$1(),this.title="Rotation",this.desc="quaternion rotation"}onExecute(){var t=this.getInputData(0);t==null&&(t=this.properties.angle);var r=this.getInputData(1);r==null&&(r=this.properties.axis);var s=setAxisAngle(this._value,r,t*.0174532925);this.setOutputData(0,s)}}class MathEulerToQuat extends LGraphNode{constructor(){super(),this.addInput("euler","vec3"),this.addOutput("quat","quat"),this.properties={euler:[0,0,0],use_yaw_pitch_roll:!1},this._degs=create$3(),this._value=create$1(),this.title="Euler->Quat",this.desc="Converts euler angles (in degrees) to quaternion"}onExecute(){var t=this.getInputData(0);t==null&&(t=this.properties.euler),scale$3(this._degs,t,DEG2RAD),this.properties.use_yaw_pitch_roll&&(this._degs=[this._degs[2],this._degs[0],this._degs[1]]);var r=fromEuler(this._value,this._degs);this.setOutputData(0,r)}}class MathQuatToEuler extends LGraphNode{constructor(){super(),this.addInput(["quat","quat"]),this.addOutput("euler","vec3"),this._value=create$3(),this.title="Euler->Quat",this.desc="Converts rotX,rotY,rotZ in degrees to quat"}onExecute(){var t=this.getInputData(0);t&&((void 0)(this._value,t),scale$3(this._value,this._value,DEG2RAD),this.setOutputData(0,this._value))}}class Math3DRotateVec3 extends LGraphNode{constructor(){super(),this.addInputs([["vec3","vec3"],["quat","quat"]]),this.addOutput("result","vec3"),this.properties={vec:[0,0,1]},this.title="Rot. Vec3",this.desc="rotate a point"}onExecute(){var t=this.getInputData(0);t==null&&(t=this.properties.vec);var r=this.getInputData(1);r==null?this.setOutputData(t):this.setOutputData(0,transformQuat$1(create$3(),t,r))}}class Math3DMultQuat extends LGraphNode{constructor(){super(),this.addInputs([["A","quat"],["B","quat"]]),this.addOutput("A*B","quat"),this._value=create$1(),this.title="Mult. Quat",this.desc="rotate quaternion"}onExecute(){var t=this.getInputData(0);if(t!=null){var r=this.getInputData(1);if(r!=null){var s=multiply$1(this._value,t,r);this.setOutputData(0,s)}}}}class Math3DQuatSlerp extends LGraphNode{constructor(){super(),this.addInputs([["A","quat"],["B","quat"],["factor","number"]]),this.addOutput("slerp","quat"),this.addProperty("factor",.5),this._value=create$1(),this.title="Quat Slerp",this.desc="quaternion spherical interpolation"}onExecute(){var t=this.getInputData(0);if(t!=null){var r=this.getInputData(1);if(r!=null){var s=this.properties.factor;this.getInputData(2)!=null&&(s=this.getInputData(2));var n=slerp(this._value,t,r,s);this.setOutputData(0,n)}}}}class Math3DRemapRange extends LGraphNode{constructor(){super(),this.addInput("vec3","vec3"),this.addOutput("remap","vec3"),this.addOutput("clamped","vec3"),this.properties={clamp:!0,range_min:[-1,-1,0],range_max:[1,1,0],target_min:[-1,-1,0],target_max:[1,1,0]},this._value=create$3(),this._clamped=create$3(),this.title="Remap Range",this.desc="remap a 3D range"}onExecute(){var t=this.getInputData(0);t&&this._value.set(t);for(var r=this.properties.range_min,s=this.properties.range_max,n=this.properties.target_min,a=this.properties.target_max,o=0;o<3;++o){var l=s[o]-r[o];if(this._clamped[o]=clamp$1(this._value[o],r[o],s[o]),l==0){this._value[o]=(n[o]+a[o])*.5;continue}var h=(this._value[o]-r[o])/l;this.properties.clamp&&(h=clamp$1(h,0,1));var c=a[o]-n[o];this._value[o]=n[o]+h*c}this.setOutputData(0,this._value),this.setOutputData(1,this._clamped)}}LiteGraph.registerNodeType("math3d/remap_range",Math3DRemapRange),LiteGraph.registerNodeType("math3d/mat4",Math3DMat4),LiteGraph.registerNodeType("math3d/operation",Math3DOperation),LiteGraph.registerNodeType("math3d/vec3-scale",Math3DVec3Scale),LiteGraph.registerNodeType("math3d/vec3-length",Math3DVec3Length),LiteGraph.registerNodeType("math3d/vec3-normalize",Math3DVec3Normalize),LiteGraph.registerNodeType("math3d/vec3-lerp",Math3DVec3Lerp),LiteGraph.registerNodeType("math3d/vec3-dot",Math3DVec3Dot),LiteGraph.registerNodeType("math3d/quaternion",Math3DQuaternion),LiteGraph.registerNodeType("math3d/rotation",Math3DRotation),LiteGraph.registerNodeType("math3d/euler_to_quat",MathEulerToQuat),LiteGraph.registerNodeType("math3d/quat_to_euler",MathQuatToEuler),LiteGraph.registerNodeType("math3d/rotate_vec3",Math3DRotateVec3),LiteGraph.registerNodeType("math3d/mult-quat",Math3DMultQuat),LiteGraph.registerNodeType("math3d/quat-slerp",Math3DQuatSlerp);var MIDI_COLOR="#243";function MIDIEvent(e){this.channel=0,this.cmd=0,this.data=new Uint32Array(3),e&&this.setup(e)}LiteGraph.MIDIEvent=MIDIEvent,MIDIEvent.prototype.fromJSON=function(e){this.setup(e.data)},MIDIEvent.prototype.setup=function(e){var t=e;e.constructor===Object&&(t=e.data),this.data.set(t);var r=t[0];this.status=r;var s=r&240;r>=240?this.cmd=r:this.cmd=s,this.cmd==MIDIEvent.NOTEON&&this.velocity==0&&(this.cmd=MIDIEvent.NOTEOFF),this.cmd_str=MIDIEvent.commands[this.cmd]||"",(s>=MIDIEvent.NOTEON||s<=MIDIEvent.NOTEOFF)&&(this.channel=r&15)},Object.defineProperty(MIDIEvent.prototype,"velocity",{get:function(){return this.cmd==MIDIEvent.NOTEON?this.data[2]:-1},set:function(e){this.data[2]=e},enumerable:!0}),MIDIEvent.notes=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],MIDIEvent.note_to_index={A:0,"A#":1,B:2,C:3,"C#":4,D:5,"D#":6,E:7,F:8,"F#":9,G:10,"G#":11},Object.defineProperty(MIDIEvent.prototype,"note",{get:function(){return this.cmd!=MIDIEvent.NOTEON?-1:MIDIEvent.toNoteString(this.data[1],!0)},set:function(e){throw"notes cannot be assigned this way, must modify the data[1]"},enumerable:!0}),Object.defineProperty(MIDIEvent.prototype,"octave",{get:function(){if(this.cmd!=MIDIEvent.NOTEON)return-1;var e=this.data[1]-24;return Math.floor(e/12+1)},set:function(e){throw"octave cannot be assigned this way, must modify the data[1]"},enumerable:!0}),MIDIEvent.prototype.getPitch=function(){return Math.pow(2,(this.data[1]-69)/12)*440},MIDIEvent.computePitch=function(e){return Math.pow(2,(e-69)/12)*440},MIDIEvent.prototype.getCC=function(){return this.data[1]},MIDIEvent.prototype.getCCValue=function(){return this.data[2]},MIDIEvent.prototype.getPitchBend=function(){return this.data[1]+(this.data[2]<<7)-8192},MIDIEvent.computePitchBend=function(e,t){return e+(t<<7)-8192},MIDIEvent.prototype.setCommandFromString=function(e){this.cmd=MIDIEvent.computeCommandFromString(e)},MIDIEvent.computeCommandFromString=function(e){if(!e)return 0;if(e&&e.constructor===Number)return e;switch(e=e.toUpperCase(),e){case"NOTE ON":case"NOTEON":return MIDIEvent.NOTEON;case"NOTE OFF":case"NOTEOFF":return MIDIEvent.NOTEON;case"KEY PRESSURE":case"KEYPRESSURE":return MIDIEvent.KEYPRESSURE;case"CONTROLLER CHANGE":case"CONTROLLERCHANGE":case"CC":return MIDIEvent.CONTROLLERCHANGE;case"PROGRAM CHANGE":case"PROGRAMCHANGE":case"PC":return MIDIEvent.PROGRAMCHANGE;case"CHANNEL PRESSURE":case"CHANNELPRESSURE":return MIDIEvent.CHANNELPRESSURE;case"PITCH BEND":case"PITCHBEND":return MIDIEvent.PITCHBEND;case"TIME TICK":case"TIMETICK":return MIDIEvent.TIMETICK;default:return Number(e)}},MIDIEvent.toNoteString=function(e,t){e=Math.round(e);var r=e-21,s=Math.floor((e-24)/12+1);return r=r%12,r<0&&(r=12+r),MIDIEvent.notes[r]+(t?"":s)},MIDIEvent.NoteStringToPitch=function(e){e=e.toUpperCase();var t=e[0],r=4;e[1]=="#"?(t+="#",e.length>2&&(r=Number(e[2]))):e.length>1&&(r=Number(e[1]));var s=MIDIEvent.note_to_index[t];return s==null?null:(r-1)*12+s+21},MIDIEvent.prototype.toString=function(){var e=""+this.channel+". ";switch(this.cmd){case MIDIEvent.NOTEON:e+="NOTEON "+MIDIEvent.toNoteString(this.data[1]);break;case MIDIEvent.NOTEOFF:e+="NOTEOFF "+MIDIEvent.toNoteString(this.data[1]);break;case MIDIEvent.CONTROLLERCHANGE:e+="CC "+this.data[1]+" "+this.data[2];break;case MIDIEvent.PROGRAMCHANGE:e+="PC "+this.data[1];break;case MIDIEvent.PITCHBEND:e+="PITCHBEND "+this.getPitchBend();break;case MIDIEvent.KEYPRESSURE:e+="KEYPRESS "+this.data[1];break}return e},MIDIEvent.prototype.toHexString=function(){for(var e="",t=0;t<this.data.length;t++)e+=this.data[t].toString(16)+" "},MIDIEvent.prototype.toJSON=function(){return{data:[this.data[0],this.data[1],this.data[2]],object_class:"MIDIEvent"}},MIDIEvent.NOTEOFF=128,MIDIEvent.NOTEON=144,MIDIEvent.KEYPRESSURE=160,MIDIEvent.CONTROLLERCHANGE=176,MIDIEvent.PROGRAMCHANGE=192,MIDIEvent.CHANNELPRESSURE=208,MIDIEvent.PITCHBEND=224,MIDIEvent.TIMETICK=248,MIDIEvent.commands={128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"},MIDIEvent.commands_short={128:"NOTEOFF",144:"NOTEOFF",160:"KEYP",176:"CC",192:"PC",208:"CP",224:"PB",240:"SYS",242:"POS",243:"SELECT",246:"TUNEREQ",248:"TT",250:"START",251:"CONTINUE",252:"STOP",254:"SENS",255:"RESET"},MIDIEvent.commands_reversed={};for(var i in MIDIEvent.commands)MIDIEvent.commands_reversed[MIDIEvent.commands[i]]=i;function MIDIInterface(e,t){if(!navigator.requestMIDIAccess){this.error="not suppoorted",t?t("Not supported"):console.error("MIDI NOT SUPPORTED, enable by chrome://flags");return}this.on_ready=e,this.state={note:[],cc:[]},this.input_ports=null,this.input_ports_info=[],this.output_ports=null,this.output_ports_info=[],navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))}MIDIInterface.input=null,MIDIInterface.MIDIEvent=MIDIEvent,MIDIInterface.prototype.onMIDISuccess=function(e){console.log("MIDI ready!"),console.log(e),this.midi=e,this.updatePorts(),this.on_ready&&this.on_ready(this)},MIDIInterface.prototype.updatePorts=function(){var e=this.midi;this.input_ports=e.inputs,this.input_ports_info=[],this.output_ports=e.outputs,this.output_ports_info=[];for(var t=0,s=this.input_ports.values(),n=s.next();n&&n.done===!1;){var r=n.value;this.input_ports_info.push(r),console.log("Input port [type:'"+r.type+"'] id:'"+r.id+"' manufacturer:'"+r.manufacturer+"' name:'"+r.name+"' version:'"+r.version+"'"),t++,n=s.next()}this.num_input_ports=t,t=0;for(var s=this.output_ports.values(),n=s.next();n&&n.done===!1;){var r=n.value;this.output_ports_info.push(r),console.log("Output port [type:'"+r.type+"'] id:'"+r.id+"' manufacturer:'"+r.manufacturer+"' name:'"+r.name+"' version:'"+r.version+"'"),t++,n=s.next()}this.num_output_ports=t},MIDIInterface.prototype.onMIDIFailure=function(e){console.error("Failed to get MIDI access - "+e)},MIDIInterface.prototype.openInputPort=function(e,t){var r=this.input_ports.get("input-"+e);if(!r)return!1;MIDIInterface.input=this;var s=this;return r.onmidimessage=function(n){var a=new MIDIEvent(n.data);s.updateState(a),t&&t(n.data,a),MIDIInterface.on_message&&MIDIInterface.on_message(n.data,a)},console.log("port open: ",r),!0},MIDIInterface.parseMsg=function(e){},MIDIInterface.prototype.updateState=function(e){switch(e.cmd){case MIDIEvent.NOTEON:this.state.note[e.value1|0]=e.value2;break;case MIDIEvent.NOTEOFF:this.state.note[e.value1|0]=0;break;case MIDIEvent.CONTROLLERCHANGE:this.state.cc[e.getCC()]=e.getCCValue();break}},MIDIInterface.prototype.sendMIDI=function(e,t){if(t){var r=this.output_ports_info[e];r&&(MIDIInterface.output=this,t.constructor===MIDIEvent?r.send(t.data):r.send(t))}};function LGMIDIIn(){this.addOutput("on_midi",LiteGraph.EVENT),this.addOutput("out","midi"),this.properties={port:0},this._last_midi_event=null,this._current_midi_event=null,this.boxcolor="#AAA",this._last_time=0;var e=this;new MIDIInterface(function(t){e._midi=t,e._waiting&&e.onStart(),e._waiting=!1})}LGMIDIIn.MIDIInterface=MIDIInterface,LGMIDIIn.title="MIDI Input",LGMIDIIn.desc="Reads MIDI from a input port",LGMIDIIn.color=MIDI_COLOR,LGMIDIIn.prototype.getPropertyInfo=function(e){if(this._midi&&e=="port"){for(var t={},r=0;r<this._midi.input_ports_info.length;++r){var s=this._midi.input_ports_info[r];t[r]=r+".- "+s.name+" version:"+s.version}return{type:"enum",values:t}}},LGMIDIIn.prototype.onStart=function(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0},LGMIDIIn.prototype.onMIDIEvent=function(e,t){this._last_midi_event=t,this.boxcolor="#AFA",this._last_time=LiteGraph.getTime(),this.trigger("on_midi",t),t.cmd==MIDIEvent.NOTEON?this.trigger("on_noteon",t):t.cmd==MIDIEvent.NOTEOFF?this.trigger("on_noteoff",t):t.cmd==MIDIEvent.CONTROLLERCHANGE?this.trigger("on_cc",t):t.cmd==MIDIEvent.PROGRAMCHANGE?this.trigger("on_pc",t):t.cmd==MIDIEvent.PITCHBEND&&this.trigger("on_pitchbend",t)},LGMIDIIn.prototype.onDrawBackground=function(e){if(this.boxcolor="#AAA",!this.flags.collapsed&&this._last_midi_event){e.fillStyle="white";var t=LiteGraph.getTime(),r=1-Math.max(0,(t-this._last_time)*.001);if(r>0){var s=e.globalAlpha;e.globalAlpha*=r,e.font="12px Tahoma",e.fillText(this._last_midi_event.toString(),2,this.size[1]*.5+3),e.globalAlpha=s}}},LGMIDIIn.prototype.onExecute=function(){if(this.outputs)for(var e=this._last_midi_event,t=0;t<this.outputs.length;++t){var r=this.outputs[t],s=null;switch(r.name){case"midi":s=this._midi;break;case"last_midi":s=e;break;default:continue}this.setOutputData(t,s)}},LGMIDIIn.prototype.onGetOutputs=function(){return[["last_midi","midi"],["on_midi",LiteGraph.EVENT],["on_noteon",LiteGraph.EVENT],["on_noteoff",LiteGraph.EVENT],["on_cc",LiteGraph.EVENT],["on_pc",LiteGraph.EVENT],["on_pitchbend",LiteGraph.EVENT]]},LiteGraph.registerNodeType("midi/input",LGMIDIIn);function LGMIDIOut(){this.addInput("send",LiteGraph.EVENT),this.properties={port:0};var e=this;new MIDIInterface(function(t){e._midi=t,e.widget.options.values=e.getMIDIOutputs()}),this.widget=this.addWidget("combo","Device",this.properties.port,{property:"port",values:this.getMIDIOutputs.bind(this)}),this.size=[340,60]}LGMIDIOut.MIDIInterface=MIDIInterface,LGMIDIOut.title="MIDI Output",LGMIDIOut.desc="Sends MIDI to output channel",LGMIDIOut.color=MIDI_COLOR,LGMIDIOut.prototype.onGetPropertyInfo=function(e){if(this._midi&&e=="port"){var t=this.getMIDIOutputs();return{type:"enum",values:t}}},LGMIDIOut.default_ports={0:"unknown"},LGMIDIOut.prototype.getMIDIOutputs=function(){var e={};if(!this._midi)return LGMIDIOut.default_ports;if(this._midi.output_ports_info)for(var t=0;t<this._midi.output_ports_info.length;++t){var r=this._midi.output_ports_info[t];if(r){var s=t+".- "+r.name+" version:"+r.version;e[t]=s}}return e},LGMIDIOut.prototype.onAction=function(e,t){this._midi&&(e=="send"&&this._midi.sendMIDI(this.properties.port,t),this.trigger("midi",t))},LGMIDIOut.prototype.onGetInputs=function(){return[["send",LiteGraph.ACTION]]},LGMIDIOut.prototype.onGetOutputs=function(){return[["on_midi",LiteGraph.EVENT]]},LiteGraph.registerNodeType("midi/output",LGMIDIOut);function LGMIDIShow(){this.addInput("on_midi",LiteGraph.EVENT),this._str="",this.size=[200,40]}LGMIDIShow.title="MIDI Show",LGMIDIShow.desc="Shows MIDI in the graph",LGMIDIShow.color=MIDI_COLOR,LGMIDIShow.prototype.getTitle=function(){return this.flags.collapsed?this._str:this.title},LGMIDIShow.prototype.onAction=function(e,t){t&&(t.constructor===MIDIEvent?this._str=t.toString():this._str="???")},LGMIDIShow.prototype.onDrawForeground=function(e){!this._str||this.flags.collapsed||(e.font="30px Arial",e.fillText(this._str,10,this.size[1]*.8))},LGMIDIShow.prototype.onGetInputs=function(){return[["in",LiteGraph.ACTION]]},LGMIDIShow.prototype.onGetOutputs=function(){return[["on_midi",LiteGraph.EVENT]]},LiteGraph.registerNodeType("midi/show",LGMIDIShow);function LGMIDIFilter(){this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1};var e=this;this._learning=!1,this.addWidget("button","Learn","",function(){e._learning=!0,e.boxcolor="#FA3"}),this.addInput("in",LiteGraph.EVENT),this.addOutput("on_midi",LiteGraph.EVENT),this.boxcolor="#AAA"}LGMIDIFilter.title="MIDI Filter",LGMIDIFilter.desc="Filters MIDI messages",LGMIDIFilter.color=MIDI_COLOR,LGMIDIFilter["@cmd"]={type:"enum",title:"Command",values:MIDIEvent.commands_reversed},LGMIDIFilter.prototype.getTitle=function(){var e=null;return this.properties.cmd==-1?e="Nothing":e=MIDIEvent.commands_short[this.properties.cmd]||"Unknown",this.properties.min_value!=-1&&this.properties.max_value!=-1&&(e+=" "+(this.properties.min_value==this.properties.max_value?this.properties.max_value:this.properties.min_value+".."+this.properties.max_value)),"Filter: "+e},LGMIDIFilter.prototype.onPropertyChanged=function(e,t){if(e=="cmd"){var r=Number(t);isNaN(r)&&(r=MIDIEvent.commands[t]||0),this.properties.cmd=r}},LGMIDIFilter.prototype.onAction=function(e,t){if(!(!t||t.constructor!==MIDIEvent)){if(this._learning)this._learning=!1,this.boxcolor="#AAA",this.properties.channel=t.channel,this.properties.cmd=t.cmd,this.properties.min_value=this.properties.max_value=t.data[1];else if(this.properties.channel!=-1&&t.channel!=this.properties.channel||this.properties.cmd!=-1&&t.cmd!=this.properties.cmd||this.properties.min_value!=-1&&t.data[1]<this.properties.min_value||this.properties.max_value!=-1&&t.data[1]>this.properties.max_value)return;this.trigger("on_midi",t)}},LiteGraph.registerNodeType("midi/filter",LGMIDIFilter);function LGMIDIEvent(){this.properties={channel:0,cmd:144,value1:1,value2:1},this.addInput("send",LiteGraph.EVENT),this.addInput("assign",LiteGraph.EVENT),this.addOutput("on_midi",LiteGraph.EVENT),this.midi_event=new MIDIEvent,this.gate=!1}LGMIDIEvent.title="MIDIEvent",LGMIDIEvent.desc="Create a MIDI Event",LGMIDIEvent.color=MIDI_COLOR,LGMIDIEvent.prototype.onAction=function(e,r){if(e=="assign"){this.properties.channel=r.channel,this.properties.cmd=r.cmd,this.properties.value1=r.data[1],this.properties.value2=r.data[2],r.cmd==MIDIEvent.NOTEON?this.gate=!0:r.cmd==MIDIEvent.NOTEOFF&&(this.gate=!1);return}var r=this.midi_event;r.channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?r.setCommandFromString(this.properties.cmd):r.cmd=this.properties.cmd,r.data[0]=r.cmd|r.channel,r.data[1]=Number(this.properties.value1),r.data[2]=Number(this.properties.value2),this.trigger("on_midi",r)},LGMIDIEvent.prototype.onExecute=function(){var e=this.properties;if(this.inputs)for(var t=0;t<this.inputs.length;++t){var r=this.inputs[t];if(r.link!=-1)switch(r.name){case"note":var s=this.getInputData(t);s!=null&&(s.constructor===String&&(s=MIDIEvent.NoteStringToPitch(s)),this.properties.value1=(s|0)%255);break;case"cmd":var s=this.getInputData(t);s!=null&&(this.properties.cmd=s);break;case"value1":var s=this.getInputData(t);s!=null&&(this.properties.value1=clamp(s|0,0,127));break;case"value2":var s=this.getInputData(t);s!=null&&(this.properties.value2=clamp(s|0,0,127));break}}if(this.outputs)for(var t=0;t<this.outputs.length;++t){var n=this.outputs[t],s=null;switch(n.name){case"midi":s=new MIDIEvent,s.setup([e.cmd,e.value1,e.value2]),s.channel=e.channel;break;case"command":s=e.cmd;break;case"cc":s=e.value1;break;case"cc_value":s=e.value2;break;case"note":s=e.cmd==MIDIEvent.NOTEON||e.cmd==MIDIEvent.NOTEOFF?e.value1:null;break;case"velocity":s=e.cmd==MIDIEvent.NOTEON?e.value2:null;break;case"pitch":s=e.cmd==MIDIEvent.NOTEON?MIDIEvent.computePitch(e.value1):null;break;case"pitchbend":s=e.cmd==MIDIEvent.PITCHBEND?MIDIEvent.computePitchBend(e.value1,e.value2):null;break;case"gate":s=this.gate;break;default:continue}s!==null&&this.setOutputData(t,s)}},LGMIDIEvent.prototype.onPropertyChanged=function(e,t){e=="cmd"&&(this.properties.cmd=MIDIEvent.computeCommandFromString(t))},LGMIDIEvent.prototype.onGetInputs=function(){return[["cmd","number"],["note","number"],["value1","number"],["value2","number"]]},LGMIDIEvent.prototype.onGetOutputs=function(){return[["midi","midi"],["on_midi",LiteGraph.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["gate","bool"],["pitchbend","number"]]},LiteGraph.registerNodeType("midi/event",LGMIDIEvent);function LGMIDICC(){this.properties={cc:1,value:0},this.addOutput("value","number")}LGMIDICC.title="MIDICC",LGMIDICC.desc="gets a Controller Change",LGMIDICC.color=MIDI_COLOR,LGMIDICC.prototype.onExecute=function(){this.properties,MIDIInterface.input&&(this.properties.value=MIDIInterface.input.state.cc[this.properties.cc]),this.setOutputData(0,this.properties.value)},LiteGraph.registerNodeType("midi/cc",LGMIDICC);function LGMIDIGenerator(){this.addInput("generate",LiteGraph.ACTION),this.addInput("scale","string"),this.addInput("octave","number"),this.addOutput("note",LiteGraph.EVENT),this.properties={notes:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#",octave:2,duration:.5,mode:"sequence"},this.notes_pitches=LGMIDIGenerator.processScale(this.properties.notes),this.sequence_index=0}LGMIDIGenerator.title="MIDI Generator",LGMIDIGenerator.desc="Generates a random MIDI note",LGMIDIGenerator.color=MIDI_COLOR,LGMIDIGenerator.processScale=function(e){for(var t=e.split(","),r=0;r<t.length;++r){var s=t[r];s.length==2&&s[1]!="#"||s.length>2?t[r]=-LiteGraph.MIDIEvent.NoteStringToPitch(s):t[r]=MIDIEvent.note_to_index[s]||0}return t},LGMIDIGenerator.prototype.onPropertyChanged=function(e,t){e=="notes"&&(this.notes_pitches=LGMIDIGenerator.processScale(t))},LGMIDIGenerator.prototype.onExecute=function(){var e=this.getInputData(2);e!=null&&(this.properties.octave=e);var t=this.getInputData(1);t&&(this.notes_pitches=LGMIDIGenerator.processScale(t))},LGMIDIGenerator.prototype.onAction=function(e,o){var r=0,s=this.notes_pitches.length,n=0;this.properties.mode=="sequence"?n=this.sequence_index=(this.sequence_index+1)%s:this.properties.mode=="random"&&(n=Math.floor(Math.random()*s));var a=this.notes_pitches[n];a>=0?r=a+(this.properties.octave-1)*12+33:r=-a;var o=new MIDIEvent;o.setup([MIDIEvent.NOTEON,r,10]);var l=this.properties.duration||1;this.trigger("note",o),setTimeout((function(){var h=new MIDIEvent;h.setup([MIDIEvent.NOTEOFF,r,0]),this.trigger("note",h)}).bind(this),l*1e3)},LiteGraph.registerNodeType("midi/generator",LGMIDIGenerator);function LGMIDITranspose(){this.properties={amount:0},this.addInput("in",LiteGraph.ACTION),this.addInput("amount","number"),this.addOutput("out",LiteGraph.EVENT),this.midi_event=new MIDIEvent}LGMIDITranspose.title="MIDI Transpose",LGMIDITranspose.desc="Transpose a MIDI note",LGMIDITranspose.color=MIDI_COLOR,LGMIDITranspose.prototype.onAction=function(e,t){!t||t.constructor!==MIDIEvent||(t.data[0]==MIDIEvent.NOTEON||t.data[0]==MIDIEvent.NOTEOFF?(this.midi_event=new MIDIEvent,this.midi_event.setup(t.data),this.midi_event.data[1]=Math.round(this.midi_event.data[1]+this.properties.amount),this.trigger("out",this.midi_event)):this.trigger("out",t))},LGMIDITranspose.prototype.onExecute=function(){var e=this.getInputData(1);e!=null&&(this.properties.amount=e)},LiteGraph.registerNodeType("midi/transpose",LGMIDITranspose);function LGMIDIQuantize(){this.properties={scale:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#"},this.addInput("note",LiteGraph.ACTION),this.addInput("scale","string"),this.addOutput("out",LiteGraph.EVENT),this.valid_notes=new Array(12),this.offset_notes=new Array(12),this.processScale(this.properties.scale)}LGMIDIQuantize.title="MIDI Quantize Pitch",LGMIDIQuantize.desc="Transpose a MIDI note tp fit an scale",LGMIDIQuantize.color=MIDI_COLOR,LGMIDIQuantize.prototype.onPropertyChanged=function(e,t){e=="scale"&&this.processScale(t)},LGMIDIQuantize.prototype.processScale=function(e){this._current_scale=e,this.notes_pitches=LGMIDIGenerator.processScale(e);for(var t=0;t<12;++t)this.valid_notes[t]=this.notes_pitches.indexOf(t)!=-1;for(var t=0;t<12;++t){if(this.valid_notes[t]){this.offset_notes[t]=0;continue}for(var r=1;r<12;++r){if(this.valid_notes[(t-r)%12]){this.offset_notes[t]=-r;break}if(this.valid_notes[(t+r)%12]){this.offset_notes[t]=r;break}}}},LGMIDIQuantize.prototype.onAction=function(e,t){if(!(!t||t.constructor!==MIDIEvent))if(t.data[0]==MIDIEvent.NOTEON||t.data[0]==MIDIEvent.NOTEOFF){this.midi_event=new MIDIEvent,this.midi_event.setup(t.data);var r=t.note,s=MIDIEvent.note_to_index[r],n=this.offset_notes[s];this.midi_event.data[1]+=n,this.trigger("out",this.midi_event)}else this.trigger("out",t)},LGMIDIQuantize.prototype.onExecute=function(){var e=this.getInputData(1);e!=null&&e!=this._current_scale&&this.processScale(e)},LiteGraph.registerNodeType("midi/quantize",LGMIDIQuantize);function LGMIDIFromFile(){this.properties={url:"",autoplay:!0},this.addInput("play",LiteGraph.ACTION),this.addInput("pause",LiteGraph.ACTION),this.addOutput("note",LiteGraph.EVENT),this._midi=null,this._current_time=0,this._playing=!1,typeof MidiParser>"u"&&(console.error("midi-parser.js not included, LGMidiPlay requires that library: https://raw.githubusercontent.com/colxi/midi-parser-js/master/src/main.js"),this.boxcolor="red")}LGMIDIFromFile.title="MIDI fromFile",LGMIDIFromFile.desc="Plays a MIDI file",LGMIDIFromFile.color=MIDI_COLOR,LGMIDIFromFile.prototype.onAction=function(e){e=="play"?this.play():e=="pause"&&(this._playing=!this._playing)},LGMIDIFromFile.prototype.onPropertyChanged=function(e,t){e=="url"&&this.loadMIDIFile(t)},LGMIDIFromFile.prototype.onExecute=function(){if(this._midi&&this._playing){this._current_time+=this.graph.elapsed_time;for(var e=this._current_time*100,t=0;t<this._midi.tracks;++t){var r=this._midi.track[t];r._last_pos||(r._last_pos=0,r._time=0);var s=r.event[r._last_pos];if(s&&r._time+s.deltaTime<=e&&(r._last_pos++,r._time+=s.deltaTime,s.data)){var n=s.type<<4+s.channel,a=new MIDIEvent;a.setup([n,s.data[0],s.data[1]]),this.trigger("note",a)}}}},LGMIDIFromFile.prototype.play=function(){if(this._playing=!0,this._current_time=0,!!this._midi)for(var e=0;e<this._midi.tracks;++e){var t=this._midi.track[e];t._last_pos=0,t._time=0}},LGMIDIFromFile.prototype.loadMIDIFile=function(e){var t=this;LiteGraph.fetchFile(e,"arraybuffer",function(r){t.boxcolor="#AFA",t._midi=MidiParser.parse(new Uint8Array(r)),t.properties.autoplay&&t.play()},function(r){t.boxcolor="#FAA",t._midi=null})},LGMIDIFromFile.prototype.onDropFile=function(e){this.properties.url="",this.loadMIDIFile(e)},LiteGraph.registerNodeType("midi/fromFile",LGMIDIFromFile);function LGMIDIPlay(){if(this.properties={volume:.5,duration:1},this.addInput("note",LiteGraph.ACTION),this.addInput("volume","number"),this.addInput("duration","number"),this.addOutput("note",LiteGraph.EVENT),typeof AudioSynth>"u")console.error("Audiosynth.js not included, LGMidiPlay requires that library"),this.boxcolor="red";else{var e=this.synth=new AudioSynth;this.instrument=e.createInstrument("piano")}}LGMIDIPlay.title="MIDI Play",LGMIDIPlay.desc="Plays a MIDI note",LGMIDIPlay.color=MIDI_COLOR,LGMIDIPlay.prototype.onAction=function(e,t){if(!(!t||t.constructor!==MIDIEvent)){if(this.instrument&&t.data[0]==MIDIEvent.NOTEON){var r=t.note;if(!r||r=="undefined"||r.constructor!==String)return;this.instrument.play(r,t.octave,this.properties.duration,this.properties.volume)}this.trigger("note",t)}},LGMIDIPlay.prototype.onExecute=function(){var e=this.getInputData(1);e!=null&&(this.properties.volume=e);var t=this.getInputData(2);t!=null&&(this.properties.duration=t)},LiteGraph.registerNodeType("midi/play",LGMIDIPlay);function LGMIDIKeys(){this.properties={num_octaves:2,start_octave:2},this.addInput("note",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("note",LiteGraph.EVENT),this.size=[400,100],this.keys=[],this._last_key=-1}LGMIDIKeys.title="MIDI Keys",LGMIDIKeys.desc="Keyboard to play notes",LGMIDIKeys.color=MIDI_COLOR,LGMIDIKeys.keys=[{x:0,w:1,h:1,t:0},{x:.75,w:.5,h:.6,t:1},{x:1,w:1,h:1,t:0},{x:1.75,w:.5,h:.6,t:1},{x:2,w:1,h:1,t:0},{x:2.75,w:.5,h:.6,t:1},{x:3,w:1,h:1,t:0},{x:4,w:1,h:1,t:0},{x:4.75,w:.5,h:.6,t:1},{x:5,w:1,h:1,t:0},{x:5.75,w:.5,h:.6,t:1},{x:6,w:1,h:1,t:0}],LGMIDIKeys.prototype.onDrawForeground=function(e){if(!this.flags.collapsed){var t=this.properties.num_octaves*12;this.keys.length=t;var r=this.size[0]/(this.properties.num_octaves*7),s=this.size[1];e.globalAlpha=1;for(var n=0;n<2;n++)for(var a=0;a<t;++a){var o=LGMIDIKeys.keys[a%12];if(o.t==n){var l=Math.floor(a/12),h=l*7*r+o.x*r;n==0?e.fillStyle=this.keys[a]?"#CCC":"white":e.fillStyle=this.keys[a]?"#333":"black",e.fillRect(h+1,0,r*o.w-2,s*o.h)}}}},LGMIDIKeys.prototype.getKeyIndex=function(e){this.properties.num_octaves*12;for(var t=this.size[0]/(this.properties.num_octaves*7),r=this.size[1],s=1;s>=0;s--)for(var n=0;n<this.keys.length;++n){var a=LGMIDIKeys.keys[n%12];if(a.t==s){var o=Math.floor(n/12),l=o*7*t+a.x*t,h=t*a.w,c=r*a.h;if(!(e[0]<l||e[0]>l+h||e[1]>c))return n}}return-1},LGMIDIKeys.prototype.onAction=function(e,t){if(e=="reset"){for(var r=0;r<this.keys.length;++r)this.keys[r]=!1;return}if(!(!t||t.constructor!==MIDIEvent)){var s=t,n=(this.properties.start_octave-1)*12+29,a=s.data[1]-n;a>=0&&a<this.keys.length&&(s.data[0]==MIDIEvent.NOTEON?this.keys[a]=!0:s.data[0]==MIDIEvent.NOTEOFF&&(this.keys[a]=!1)),this.trigger("note",s)}},LGMIDIKeys.prototype.onMouseDown=function(e,t){if(!(t[1]<0)){var r=this.getKeyIndex(t);this.keys[r]=!0,this._last_key=r;var s=(this.properties.start_octave-1)*12+29+r,n=new MIDIEvent;return n.setup([MIDIEvent.NOTEON,s,100]),this.trigger("note",n),!0}},LGMIDIKeys.prototype.onMouseMove=function(e,t){if(!(t[1]<0||this._last_key==-1)){this.setDirtyCanvas(!0);var r=this.getKeyIndex(t);if(this._last_key==r)return!0;this.keys[this._last_key]=!1;var s=(this.properties.start_octave-1)*12+29+this._last_key,n=new MIDIEvent;n.setup([MIDIEvent.NOTEOFF,s,100]),this.trigger("note",n),this.keys[r]=!0;var s=(this.properties.start_octave-1)*12+29+r,n=new MIDIEvent;return n.setup([MIDIEvent.NOTEON,s,100]),this.trigger("note",n),this._last_key=r,!0}},LGMIDIKeys.prototype.onMouseUp=function(e,t){if(!(t[1]<0)){var r=this.getKeyIndex(t);this.keys[r]=!1,this._last_key=-1;var s=(this.properties.start_octave-1)*12+29+r,n=new MIDIEvent;return n.setup([MIDIEvent.NOTEOFF,s,100]),this.trigger("note",n),!0}},LiteGraph.registerNodeType("midi/keys",LGMIDIKeys);function LGWebSocket(){this.size=[60,20],this.addInput("send",LiteGraph.ACTION),this.addOutput("received",LiteGraph.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"",room:"lgraph",only_send_changes:!0},this._ws=null,this._last_sent_data=[],this._last_received_data=[]}LGWebSocket.title="WebSocket",LGWebSocket.desc="Send data through a websocket",LGWebSocket.prototype.onPropertyChanged=function(e,t){e=="url"&&this.connectSocket()},LGWebSocket.prototype.onExecute=function(){if(!this._ws&&this.properties.url&&this.connectSocket(),!(!this._ws||this._ws.readyState!=WebSocket.OPEN)){for(var e=this.properties.room,t=this.properties.only_send_changes,r=1;r<this.inputs.length;++r){var s=this.getInputData(r);if(s!=null){var n;try{n=JSON.stringify({type:0,room:e,channel:r,data:s})}catch{continue}t&&this._last_sent_data[r]==n||(this._last_sent_data[r]=n,this._ws.send(n))}}for(var r=1;r<this.outputs.length;++r)this.setOutputData(r,this._last_received_data[r]);this.boxcolor=="#AFA"&&(this.boxcolor="#6C6")}},LGWebSocket.prototype.connectSocket=function(){var e=this,t=this.properties.url;t.substr(0,2)!="ws"&&(t="ws://"+t),this._ws=new WebSocket(t),this._ws.onopen=function(){console.log("ready"),e.boxcolor="#6C6"},this._ws.onmessage=function(r){e.boxcolor="#AFA";var s=JSON.parse(r.data);if(!(s.room&&s.room!=e.properties.room))if(s.type==1)if(s.data.object_class&&LiteGraph[s.data.object_class]){var n=null;try{n=new LiteGraph[s.data.object_class](s.data),e.triggerSlot(0,n)}catch{return}}else e.triggerSlot(0,s.data);else e._last_received_data[s.channel||0]=s.data},this._ws.onerror=function(r){console.log("couldnt connect to websocket"),e.boxcolor="#E88"},this._ws.onclose=function(r){console.log("connection closed"),e.boxcolor="#000"}},LGWebSocket.prototype.send=function(e){!this._ws||this._ws.readyState!=WebSocket.OPEN||this._ws.send(JSON.stringify({type:1,msg:e}))},LGWebSocket.prototype.onAction=function(e,t){!this._ws||this._ws.readyState!=WebSocket.OPEN||this._ws.send({type:1,room:this.properties.room,action:e,data:t})},LGWebSocket.prototype.onGetInputs=function(){return[["in",0]]},LGWebSocket.prototype.onGetOutputs=function(){return[["out",0]]},LiteGraph.registerNodeType("network/websocket",LGWebSocket);function LGSillyClient(){this.room_widget=this.addWidget("text","Room","lgraph",this.setRoom.bind(this)),this.addWidget("button","Reconnect",null,this.connectSocket.bind(this)),this.addInput("send",LiteGraph.ACTION),this.addOutput("received",LiteGraph.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"tamats.com:55000",room:"lgraph",only_send_changes:!0},this._server=null,this.connectSocket(),this._last_sent_data=[],this._last_received_data=[],typeof SillyClient>"u"&&console.warn("remember to add SillyClient.js to your project: https://tamats.com/projects/sillyserver/src/sillyclient.js")}LGSillyClient.title="SillyClient",LGSillyClient.desc="Connects to SillyServer to broadcast messages",LGSillyClient.prototype.onPropertyChanged=function(e,t){e=="room"&&(this.room_widget.value=t),this.connectSocket()},LGSillyClient.prototype.setRoom=function(e){this.properties.room=e,this.room_widget.value=e,this.connectSocket()},LGSillyClient.prototype.onDrawForeground=function(){for(var e=1;e<this.inputs.length;++e){var t=this.inputs[e];t.label="in_"+e}for(var e=1;e<this.outputs.length;++e){var t=this.outputs[e];t.label="out_"+e}},LGSillyClient.prototype.onExecute=function(){if(!(!this._server||!this._server.is_connected)){for(var e=this.properties.only_send_changes,t=1;t<this.inputs.length;++t){var r=this.getInputData(t),s=this._last_sent_data[t];if(r!=null){if(e){var n=!0;if(r&&r.length&&s&&s.length==r.length&&r.constructor!==String){for(var a=0;a<r.length;++a)if(s[a]!=r[a]){n=!1;break}}else this._last_sent_data[t]!=r&&(n=!1);if(n)continue}if(this._server.sendMessage({type:0,channel:t,data:r}),r.length&&r.constructor!==String)if(this._last_sent_data[t]){this._last_sent_data[t].length=r.length;for(var a=0;a<r.length;++a)this._last_sent_data[t][a]=r[a]}else r.constructor===Array?this._last_sent_data[t]=r.concat():this._last_sent_data[t]=new r.constructor(r);else this._last_sent_data[t]=r}}for(var t=1;t<this.outputs.length;++t)this.setOutputData(t,this._last_received_data[t]);this.boxcolor=="#AFA"&&(this.boxcolor="#6C6")}},LGSillyClient.prototype.connectSocket=function(){var e=this;if(typeof SillyClient>"u"){this._error||console.error("SillyClient node cannot be used, you must include SillyServer.js"),this._error=!0;return}if(this._server=new SillyClient,this._server.on_ready=function(){console.log("ready"),e.boxcolor="#6C6"},this._server.on_message=function(t,r){var s=null;try{s=JSON.parse(r)}catch{return}if(s.type==1)if(s.data.object_class&&LiteGraph[s.data.object_class]){var n=null;try{n=new LiteGraph[s.data.object_class](s.data),e.triggerSlot(0,n)}catch{return}}else e.triggerSlot(0,s.data);else e._last_received_data[s.channel||0]=s.data;e.boxcolor="#AFA"},this._server.on_error=function(t){console.log("couldnt connect to websocket"),e.boxcolor="#E88"},this._server.on_close=function(t){console.log("connection closed"),e.boxcolor="#000"},this.properties.url&&this.properties.room){try{this._server.connect(this.properties.url,this.properties.room)}catch(t){console.error("SillyServer error: "+t),this._server=null;return}this._final_url=this.properties.url+"/"+this.properties.room}},LGSillyClient.prototype.send=function(e){!this._server||!this._server.is_connected||this._server.sendMessage({type:1,data:e})},LGSillyClient.prototype.onAction=function(e,t){!this._server||!this._server.is_connected||this._server.sendMessage({type:1,action:e,data:t})},LGSillyClient.prototype.onGetInputs=function(){return[["in",0]]},LGSillyClient.prototype.onGetOutputs=function(){return[["out",0]]},LiteGraph.registerNodeType("network/sillyclient",LGSillyClient);function HTTPRequestNode(){this.addInput("request",LiteGraph.ACTION),this.addInput("url","string"),this.addProperty("url",""),this.addOutput("ready",LiteGraph.EVENT),this.addOutput("data","string"),this.addWidget("button","Fetch",null,this.fetch.bind(this)),this._data=null,this._fetching=null}HTTPRequestNode.title="HTTP Request",HTTPRequestNode.desc="Fetch data through HTTP",HTTPRequestNode.prototype.fetch=function(){var e=this.properties.url;if(e){this.boxcolor="#FF0";var t=this;this._fetching=fetch(e).then(r=>{if(!r.ok)this.boxcolor="#F00",t.trigger("error");else return this.boxcolor="#0F0",r.text()}).then(r=>{t._data=r,t._fetching=null,t.trigger("ready")})}},HTTPRequestNode.prototype.onAction=function(e){e=="request"&&this.fetch()},HTTPRequestNode.prototype.onExecute=function(){this.setOutputData(1,this._data)},HTTPRequestNode.prototype.onGetOutputs=function(){return[["error",LiteGraph.EVENT]]},LiteGraph.registerNodeType("network/httprequest",HTTPRequestNode);function toString(e){if(e&&e.constructor===Object)try{return JSON.stringify(e)}catch{return String(e)}return String(e)}LiteGraph.wrapFunctionAsNode("string/toString",toString,[""],"string");function compare(e,t){return e==t}LiteGraph.wrapFunctionAsNode("string/compare",compare,["string","string"],"boolean");function concatenate(e,t){return e===void 0?t:t===void 0?e:e+t}LiteGraph.wrapFunctionAsNode("string/concatenate",concatenate,["string","string"],"string");function contains(e,t){return e===void 0||t===void 0?!1:e.indexOf(t)!=-1}LiteGraph.wrapFunctionAsNode("string/contains",contains,["string","string"],"boolean");function toUpperCase(e){return e!=null&&e.constructor===String?e.toUpperCase():e}LiteGraph.wrapFunctionAsNode("string/toUpperCase",toUpperCase,["string"],"string");function split(e,t){if(t==null&&(t=this.properties.separator),e==null)return[];if(e.constructor===String)return e.split(t||" ");if(e.constructor===Array){for(var r=[],s=0;s<e.length;++s)typeof e[s]=="string"&&(r[s]=e[s].split(t||" "));return r}return null}LiteGraph.wrapFunctionAsNode("string/split",split,["string,array","string"],"array",{separator:","});function toFixed(e){return e!=null&&e.constructor===Number?e.toFixed(this.properties.precision):e}LiteGraph.wrapFunctionAsNode("string/toFixed",toFixed,["number"],"string",{precision:0});function StringToTable(){this.addInput("","string"),this.addOutput("table","table"),this.addOutput("rows","number"),this.addProperty("value",""),this.addProperty("separator",","),this._table=null}StringToTable.title="toTable",StringToTable.desc="Splits a string to table",StringToTable.prototype.onExecute=function(){var e=this.getInputData(0);if(e){var t=this.properties.separator||",";(e!=this._str||t!=this._last_separator)&&(this._last_separator=t,this._str=e,this._table=e.split(`
`).map(function(r){return r.trim().split(t)})),this.setOutputData(0,this._table),this.setOutputData(1,this._table?this._table.length:0)}},LiteGraph.registerNodeType("string/toTable",StringToTable);function SimpleTextEditorNode(){this.properties={text:"Hello World",fontSize:14},this.size=[200,100]}SimpleTextEditorNode.title="Text Editor",SimpleTextEditorNode.desc="Simple text editor with overlay",SimpleTextEditorNode.prototype=Object.create(LGraphNode.prototype),SimpleTextEditorNode.prototype.constructor=SimpleTextEditorNode,SimpleTextEditorNode.prototype.createPropertyOverlay=function(){const e=document.createElement("div");e.style.padding="10px",e.style.backgroundColor="#353535",e.style.borderRadius="4px",e.style.boxSizing="border-box",e.style.color="#fff";const t=document.createElement("div");t.textContent="Text:",t.style.marginBottom="4px",t.style.fontSize="12px";const r=document.createElement("input");r.type="text",r.setAttribute("data-property","text"),r.value=this.properties.text,r.style.width="100%",r.style.padding="4px",r.style.marginBottom="8px",r.style.backgroundColor="#333",r.style.border="1px solid #666",r.style.color="#fff",r.style.borderRadius="3px";const s=document.createElement("div");s.textContent="Font Size:",s.style.marginBottom="4px",s.style.fontSize="12px";const n=document.createElement("input");n.type="number",n.setAttribute("data-property","fontSize"),n.value=this.properties.fontSize,n.min="8",n.max="48",n.style.width="100%",n.style.padding="4px",n.style.backgroundColor="#333",n.style.border="1px solid #666",n.style.color="#fff",n.style.borderRadius="3px";const a=this;return r.addEventListener("input",function(o){a.updatePropertyFromOverlay("text",o.target.value)}),n.addEventListener("input",function(o){a.updatePropertyFromOverlay("fontSize",parseInt(o.target.value))}),e.appendChild(t),e.appendChild(r),e.appendChild(s),e.appendChild(n),e},SimpleTextEditorNode.prototype.onPropertyChanged=function(e,t){console.log(`Property ${e} changed to:`,t),this.updateOverlayFromProperties()},LiteGraph.registerNodeType("examples/simple_text_editor",SimpleTextEditorNode);function ColorPickerNode(){this.properties={color:"#ff0000",opacity:1},this.size=[200,120]}ColorPickerNode.title="Color Picker",ColorPickerNode.desc="Color picker with opacity slider",ColorPickerNode.prototype=Object.create(LGraphNode.prototype),ColorPickerNode.prototype.constructor=ColorPickerNode,ColorPickerNode.prototype.createPropertyOverlay=function(){const e=document.createElement("div");e.style.padding="10px",e.style.backgroundColor="#353535",e.style.borderRadius="4px",e.style.boxSizing="border-box",e.style.color="#fff";const t=document.createElement("div");t.textContent="Color:",t.style.marginBottom="4px",t.style.fontSize="12px";const r=document.createElement("input");r.type="color",r.setAttribute("data-property","color"),r.value=this.properties.color,r.style.width="100%",r.style.height="30px",r.style.marginBottom="8px",r.style.border="1px solid #666",r.style.borderRadius="3px",r.style.cursor="pointer";const s=document.createElement("div");s.textContent=`Opacity: ${(this.properties.opacity*100).toFixed(0)}%`,s.style.marginBottom="4px",s.style.fontSize="12px";const n=document.createElement("input");n.type="range",n.setAttribute("data-property","opacity"),n.min="0",n.max="1",n.step="0.01",n.value=this.properties.opacity,n.style.width="100%";const a=this;return r.addEventListener("input",function(o){a.updatePropertyFromOverlay("color",o.target.value)}),n.addEventListener("input",function(o){const l=parseFloat(o.target.value);a.updatePropertyFromOverlay("opacity",l),s.textContent=`Opacity: ${(l*100).toFixed(0)}%`}),e.appendChild(t),e.appendChild(r),e.appendChild(s),e.appendChild(n),e},ColorPickerNode.prototype.onPropertyChanged=function(e,t){this.updateOverlayFromProperties()},LiteGraph.registerNodeType("examples/color_picker",ColorPickerNode);function FormEditorNode(){this.properties={name:"",email:"",age:0,subscribe:!1},this.size=[220,180]}FormEditorNode.title="Form Editor",FormEditorNode.desc="Complex form with multiple input types",FormEditorNode.prototype=Object.create(LGraphNode.prototype),FormEditorNode.prototype.constructor=FormEditorNode,FormEditorNode.prototype.createPropertyOverlay=function(){const e=document.createElement("div");e.style.padding="10px",e.style.backgroundColor="#353535",e.style.borderRadius="4px",e.style.boxSizing="border-box",e.style.color="#fff",e.style.fontSize="12px";const t=this;function r(s,n,a,o={}){const l=document.createElement("div");l.style.marginBottom="8px";const h=document.createElement("label");h.textContent=s,h.style.display="block",h.style.marginBottom="2px";const c=document.createElement("input");return c.type=n,c.setAttribute("data-property",a),n==="checkbox"?(c.checked=t.properties[a],c.style.marginLeft="4px",h.style.display="inline",h.style.cursor="pointer",c.addEventListener("change",function(u){t.updatePropertyFromOverlay(a,u.target.checked)}),l.appendChild(c),l.appendChild(h)):(c.value=t.properties[a],c.style.width="100%",c.style.padding="4px",c.style.backgroundColor="#333",c.style.border="1px solid #666",c.style.color="#fff",c.style.borderRadius="3px",o.min!==void 0&&(c.min=o.min),o.max!==void 0&&(c.max=o.max),c.addEventListener("input",function(u){let p=u.target.value;n==="number"&&(p=parseInt(p)||0),t.updatePropertyFromOverlay(a,p)}),l.appendChild(h),l.appendChild(c)),l}return e.appendChild(r("Name:","text","name")),e.appendChild(r("Email:","email","email")),e.appendChild(r("Age:","number","age",{min:0,max:120})),e.appendChild(r("Subscribe to newsletter","checkbox","subscribe")),e},FormEditorNode.prototype.onPropertyChanged=function(e,t){console.log(`Form property ${e} changed to:`,t),this.updateOverlayFromProperties()},LiteGraph.registerNodeType("examples/form_editor",FormEditorNode),exports.ContextMenu=ContextMenu,exports.DragAndScale=DragAndScale,exports.Editor=Editor,exports.LGraph=LGraph,exports.LGraphCanvas=LGraphCanvas,exports.LGraphGroup=LGraphGroup,exports.LGraphNode=LGraphNode,exports.LLink=LLink,exports.LiteGraph=LiteGraph,exports.clamp=clamp$1,Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"})});

var Pe=Object.defineProperty;var ke=(q,l,n)=>l in q?Pe(q,l,{enumerable:!0,configurable:!0,writable:!0,value:n}):q[l]=n;var ne=(q,l,n)=>ke(q,typeof l!="symbol"?l+"":l,n);(function(){"use strict";var q,_LGraphCanvas;(function(l){var n={};typeof exports>"u"?typeof define=="function"&&typeof define.amd=="object"&&define.amd?(n.exports={},define(function(){return n.exports})):n.exports=typeof window<"u"?window:l:n.exports=exports,function(u){if(!c)var c=1e-6;if(!d)var d=typeof Float32Array<"u"?Float32Array:Array;if(!g)var g=Math.random;var m={};m.setMatrixArrayType=function(e){d=e},typeof u<"u"&&(u.glMatrix=m);var E=Math.PI/180;m.toRadian=function(e){return e*E};var L={};L.create=function(){var e=new d(2);return e[0]=0,e[1]=0,e},L.clone=function(e){var t=new d(2);return t[0]=e[0],t[1]=e[1],t},L.fromValues=function(e,t){var r=new d(2);return r[0]=e,r[1]=t,r},L.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},L.set=function(e,t,r){return e[0]=t,e[1]=r,e},L.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e},L.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e},L.sub=L.subtract,L.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e},L.mul=L.multiply,L.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e},L.div=L.divide,L.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e},L.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e},L.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e},L.scaleAndAdd=function(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e},L.distance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(r*r+s*s)},L.dist=L.distance,L.squaredDistance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1];return r*r+s*s},L.sqrDist=L.squaredDistance,L.length=function(e){var t=e[0],r=e[1];return Math.sqrt(t*t+r*r)},L.len=L.length,L.squaredLength=function(e){var t=e[0],r=e[1];return t*t+r*r},L.sqrLen=L.squaredLength,L.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},L.normalize=function(e,t){var r=t[0],s=t[1],a=r*r+s*s;return a>0&&(a=1/Math.sqrt(a),e[0]=t[0]*a,e[1]=t[1]*a),e},L.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},L.cross=function(e,t,r){var s=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=s,e},L.lerp=function(e,t,r,s){var a=t[0],o=t[1];return e[0]=a+s*(r[0]-a),e[1]=o+s*(r[1]-o),e},L.random=function(e,t){t=t||1;var r=g()*2*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e},L.transformMat2=function(e,t,r){var s=t[0],a=t[1];return e[0]=r[0]*s+r[2]*a,e[1]=r[1]*s+r[3]*a,e},L.transformMat2d=function(e,t,r){var s=t[0],a=t[1];return e[0]=r[0]*s+r[2]*a+r[4],e[1]=r[1]*s+r[3]*a+r[5],e},L.transformMat3=function(e,t,r){var s=t[0],a=t[1];return e[0]=r[0]*s+r[3]*a+r[6],e[1]=r[1]*s+r[4]*a+r[7],e},L.transformMat4=function(e,t,r){var s=t[0],a=t[1];return e[0]=r[0]*s+r[4]*a+r[12],e[1]=r[1]*s+r[5]*a+r[13],e},L.forEach=function(){var e=L.create();return function(t,r,s,a,o,h){var f,p;for(r||(r=2),s||(s=0),a?p=Math.min(a*r+s,t.length):p=t.length,f=s;f<p;f+=r)e[0]=t[f],e[1]=t[f+1],o(e,e,h),t[f]=e[0],t[f+1]=e[1];return t}}(),L.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},typeof u<"u"&&(u.vec2=L);var A={};A.create=function(){var e=new d(3);return e[0]=0,e[1]=0,e[2]=0,e},A.clone=function(e){var t=new d(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},A.fromValues=function(e,t,r){var s=new d(3);return s[0]=e,s[1]=t,s[2]=r,s},A.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},A.set=function(e,t,r,s){return e[0]=t,e[1]=r,e[2]=s,e},A.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e},A.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e},A.sub=A.subtract,A.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e},A.mul=A.multiply,A.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e},A.div=A.divide,A.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e},A.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e},A.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e},A.scaleAndAdd=function(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e},A.distance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1],a=t[2]-e[2];return Math.sqrt(r*r+s*s+a*a)},A.dist=A.distance,A.squaredDistance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1],a=t[2]-e[2];return r*r+s*s+a*a},A.sqrDist=A.squaredDistance,A.length=function(e){var t=e[0],r=e[1],s=e[2];return Math.sqrt(t*t+r*r+s*s)},A.len=A.length,A.squaredLength=function(e){var t=e[0],r=e[1],s=e[2];return t*t+r*r+s*s},A.sqrLen=A.squaredLength,A.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},A.normalize=function(e,t){var r=t[0],s=t[1],a=t[2],o=r*r+s*s+a*a;return o>0&&(o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o),e},A.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},A.cross=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=r[0],f=r[1],p=r[2];return e[0]=a*p-o*f,e[1]=o*h-s*p,e[2]=s*f-a*h,e},A.lerp=function(e,t,r,s){var a=t[0],o=t[1],h=t[2];return e[0]=a+s*(r[0]-a),e[1]=o+s*(r[1]-o),e[2]=h+s*(r[2]-h),e},A.random=function(e,t){t=t||1;var r=g()*2*Math.PI,s=g()*2-1,a=Math.sqrt(1-s*s)*t;return e[0]=Math.cos(r)*a,e[1]=Math.sin(r)*a,e[2]=s*t,e},A.transformMat4=function(e,t,r){var s=t[0],a=t[1],o=t[2];return e[0]=r[0]*s+r[4]*a+r[8]*o+r[12],e[1]=r[1]*s+r[5]*a+r[9]*o+r[13],e[2]=r[2]*s+r[6]*a+r[10]*o+r[14],e},A.transformMat3=function(e,t,r){var s=t[0],a=t[1],o=t[2];return e[0]=s*r[0]+a*r[3]+o*r[6],e[1]=s*r[1]+a*r[4]+o*r[7],e[2]=s*r[2]+a*r[5]+o*r[8],e},A.transformQuat=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=r[0],f=r[1],p=r[2],T=r[3],_=T*s+f*o-p*a,S=T*a+p*s-h*o,b=T*o+h*a-f*s,M=-h*s-f*a-p*o;return e[0]=_*T+M*-h+S*-p-b*-f,e[1]=S*T+M*-f+b*-h-_*-p,e[2]=b*T+M*-p+_*-f-S*-h,e},A.rotateX=function(e,t,r,s){var a=[],o=[];return a[0]=t[0]-r[0],a[1]=t[1]-r[1],a[2]=t[2]-r[2],o[0]=a[0],o[1]=a[1]*Math.cos(s)-a[2]*Math.sin(s),o[2]=a[1]*Math.sin(s)+a[2]*Math.cos(s),e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e},A.rotateY=function(e,t,r,s){var a=[],o=[];return a[0]=t[0]-r[0],a[1]=t[1]-r[1],a[2]=t[2]-r[2],o[0]=a[2]*Math.sin(s)+a[0]*Math.cos(s),o[1]=a[1],o[2]=a[2]*Math.cos(s)-a[0]*Math.sin(s),e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e},A.rotateZ=function(e,t,r,s){var a=[],o=[];return a[0]=t[0]-r[0],a[1]=t[1]-r[1],a[2]=t[2]-r[2],o[0]=a[0]*Math.cos(s)-a[1]*Math.sin(s),o[1]=a[0]*Math.sin(s)+a[1]*Math.cos(s),o[2]=a[2],e[0]=o[0]+r[0],e[1]=o[1]+r[1],e[2]=o[2]+r[2],e},A.forEach=function(){var e=A.create();return function(t,r,s,a,o,h){var f,p;for(r||(r=3),s||(s=0),a?p=Math.min(a*r+s,t.length):p=t.length,f=s;f<p;f+=r)e[0]=t[f],e[1]=t[f+1],e[2]=t[f+2],o(e,e,h),t[f]=e[0],t[f+1]=e[1],t[f+2]=e[2];return t}}(),A.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},typeof u<"u"&&(u.vec3=A);var N={};N.create=function(){var e=new d(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},N.clone=function(e){var t=new d(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},N.fromValues=function(e,t,r,s){var a=new d(4);return a[0]=e,a[1]=t,a[2]=r,a[3]=s,a},N.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},N.set=function(e,t,r,s,a){return e[0]=t,e[1]=r,e[2]=s,e[3]=a,e},N.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},N.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e},N.sub=N.subtract,N.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e},N.mul=N.multiply,N.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e[3]=t[3]/r[3],e},N.div=N.divide,N.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e},N.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e},N.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},N.scaleAndAdd=function(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e[3]=t[3]+r[3]*s,e},N.distance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1],a=t[2]-e[2],o=t[3]-e[3];return Math.sqrt(r*r+s*s+a*a+o*o)},N.dist=N.distance,N.squaredDistance=function(e,t){var r=t[0]-e[0],s=t[1]-e[1],a=t[2]-e[2],o=t[3]-e[3];return r*r+s*s+a*a+o*o},N.sqrDist=N.squaredDistance,N.length=function(e){var t=e[0],r=e[1],s=e[2],a=e[3];return Math.sqrt(t*t+r*r+s*s+a*a)},N.len=N.length,N.squaredLength=function(e){var t=e[0],r=e[1],s=e[2],a=e[3];return t*t+r*r+s*s+a*a},N.sqrLen=N.squaredLength,N.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},N.normalize=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],h=r*r+s*s+a*a+o*o;return h>0&&(h=1/Math.sqrt(h),e[0]=t[0]*h,e[1]=t[1]*h,e[2]=t[2]*h,e[3]=t[3]*h),e},N.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},N.lerp=function(e,t,r,s){var a=t[0],o=t[1],h=t[2],f=t[3];return e[0]=a+s*(r[0]-a),e[1]=o+s*(r[1]-o),e[2]=h+s*(r[2]-h),e[3]=f+s*(r[3]-f),e},N.random=function(e,t){return t=t||1,e[0]=g(),e[1]=g(),e[2]=g(),e[3]=g(),N.normalize(e,e),N.scale(e,e,t),e},N.transformMat4=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3];return e[0]=r[0]*s+r[4]*a+r[8]*o+r[12]*h,e[1]=r[1]*s+r[5]*a+r[9]*o+r[13]*h,e[2]=r[2]*s+r[6]*a+r[10]*o+r[14]*h,e[3]=r[3]*s+r[7]*a+r[11]*o+r[15]*h,e},N.transformQuat=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=r[0],f=r[1],p=r[2],T=r[3],_=T*s+f*o-p*a,S=T*a+p*s-h*o,b=T*o+h*a-f*s,M=-h*s-f*a-p*o;return e[0]=_*T+M*-h+S*-p-b*-f,e[1]=S*T+M*-f+b*-h-_*-p,e[2]=b*T+M*-p+_*-f-S*-h,e},N.forEach=function(){var e=N.create();return function(t,r,s,a,o,h){var f,p;for(r||(r=4),s||(s=0),a?p=Math.min(a*r+s,t.length):p=t.length,f=s;f<p;f+=r)e[0]=t[f],e[1]=t[f+1],e[2]=t[f+2],e[3]=t[f+3],o(e,e,h),t[f]=e[0],t[f+1]=e[1],t[f+2]=e[2],t[f+3]=e[3];return t}}(),N.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},typeof u<"u"&&(u.vec4=N);var C={};C.create=function(){var e=new d(4);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},C.clone=function(e){var t=new d(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},C.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},C.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},C.transpose=function(e,t){if(e===t){var r=t[1];e[1]=t[2],e[2]=r}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},C.invert=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],h=r*o-a*s;return h?(h=1/h,e[0]=o*h,e[1]=-s*h,e[2]=-a*h,e[3]=r*h,e):null},C.adjoint=function(e,t){var r=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=r,e},C.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},C.multiply=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=r[0],p=r[1],T=r[2],_=r[3];return e[0]=s*f+o*p,e[1]=a*f+h*p,e[2]=s*T+o*_,e[3]=a*T+h*_,e},C.mul=C.multiply,C.rotate=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=Math.sin(r),p=Math.cos(r);return e[0]=s*p+o*f,e[1]=a*p+h*f,e[2]=s*-f+o*p,e[3]=a*-f+h*p,e},C.scale=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=r[0],p=r[1];return e[0]=s*f,e[1]=a*f,e[2]=o*p,e[3]=h*p,e},C.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},C.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2))},C.LDU=function(e,t,r,s){return e[2]=s[2]/s[0],r[0]=s[0],r[1]=s[1],r[3]=s[3]-e[2]*r[1],[e,t,r]},typeof u<"u"&&(u.mat2=C);var R={};R.create=function(){var e=new d(6);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},R.clone=function(e){var t=new d(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},R.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},R.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},R.invert=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],h=t[4],f=t[5],p=r*o-s*a;return p?(p=1/p,e[0]=o*p,e[1]=-s*p,e[2]=-a*p,e[3]=r*p,e[4]=(a*f-o*h)*p,e[5]=(s*h-r*f)*p,e):null},R.determinant=function(e){return e[0]*e[3]-e[1]*e[2]},R.multiply=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=t[4],p=t[5],T=r[0],_=r[1],S=r[2],b=r[3],M=r[4],G=r[5];return e[0]=s*T+o*_,e[1]=a*T+h*_,e[2]=s*S+o*b,e[3]=a*S+h*b,e[4]=s*M+o*G+f,e[5]=a*M+h*G+p,e},R.mul=R.multiply,R.rotate=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=t[4],p=t[5],T=Math.sin(r),_=Math.cos(r);return e[0]=s*_+o*T,e[1]=a*_+h*T,e[2]=s*-T+o*_,e[3]=a*-T+h*_,e[4]=f,e[5]=p,e},R.scale=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=t[4],p=t[5],T=r[0],_=r[1];return e[0]=s*T,e[1]=a*T,e[2]=o*_,e[3]=h*_,e[4]=f,e[5]=p,e},R.translate=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=t[4],p=t[5],T=r[0],_=r[1];return e[0]=s,e[1]=a,e[2]=o,e[3]=h,e[4]=s*T+o*_+f,e[5]=a*T+h*_+p,e},R.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},R.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+1)},typeof u<"u"&&(u.mat2d=R);var P={};P.create=function(){var e=new d(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},P.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},P.clone=function(e){var t=new d(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},P.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},P.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},P.transpose=function(e,t){if(e===t){var r=t[1],s=t[2],a=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=s,e[7]=a}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},P.invert=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],h=t[4],f=t[5],p=t[6],T=t[7],_=t[8],S=_*h-f*T,b=-_*o+f*p,M=T*o-h*p,G=r*S+s*b+a*M;return G?(G=1/G,e[0]=S*G,e[1]=(-_*s+a*T)*G,e[2]=(f*s-a*h)*G,e[3]=b*G,e[4]=(_*r-a*p)*G,e[5]=(-f*r+a*o)*G,e[6]=M*G,e[7]=(-T*r+s*p)*G,e[8]=(h*r-s*o)*G,e):null},P.adjoint=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],h=t[4],f=t[5],p=t[6],T=t[7],_=t[8];return e[0]=h*_-f*T,e[1]=a*T-s*_,e[2]=s*f-a*h,e[3]=f*p-o*_,e[4]=r*_-a*p,e[5]=a*o-r*f,e[6]=o*T-h*p,e[7]=s*p-r*T,e[8]=r*h-s*o,e},P.determinant=function(e){var t=e[0],r=e[1],s=e[2],a=e[3],o=e[4],h=e[5],f=e[6],p=e[7],T=e[8];return t*(T*o-h*p)+r*(-T*a+h*f)+s*(p*a-o*f)},P.multiply=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=t[4],p=t[5],T=t[6],_=t[7],S=t[8],b=r[0],M=r[1],G=r[2],O=r[3],B=r[4],H=r[5],z=r[6],k=r[7],X=r[8];return e[0]=b*s+M*h+G*T,e[1]=b*a+M*f+G*_,e[2]=b*o+M*p+G*S,e[3]=O*s+B*h+H*T,e[4]=O*a+B*f+H*_,e[5]=O*o+B*p+H*S,e[6]=z*s+k*h+X*T,e[7]=z*a+k*f+X*_,e[8]=z*o+k*p+X*S,e},P.mul=P.multiply,P.translate=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=t[4],p=t[5],T=t[6],_=t[7],S=t[8],b=r[0],M=r[1];return e[0]=s,e[1]=a,e[2]=o,e[3]=h,e[4]=f,e[5]=p,e[6]=b*s+M*h+T,e[7]=b*a+M*f+_,e[8]=b*o+M*p+S,e},P.rotate=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=t[4],p=t[5],T=t[6],_=t[7],S=t[8],b=Math.sin(r),M=Math.cos(r);return e[0]=M*s+b*h,e[1]=M*a+b*f,e[2]=M*o+b*p,e[3]=M*h-b*s,e[4]=M*f-b*a,e[5]=M*p-b*o,e[6]=T,e[7]=_,e[8]=S,e},P.scale=function(e,t,r){var s=r[0],a=r[1];return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=a*t[3],e[4]=a*t[4],e[5]=a*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},P.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},P.fromQuat=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],h=r+r,f=s+s,p=a+a,T=r*h,_=s*h,S=s*f,b=a*h,M=a*f,G=a*p,O=o*h,B=o*f,H=o*p;return e[0]=1-S-G,e[3]=_-H,e[6]=b+B,e[1]=_+H,e[4]=1-T-G,e[7]=M-O,e[2]=b-B,e[5]=M+O,e[8]=1-T-S,e},P.normalFromMat4=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],h=t[4],f=t[5],p=t[6],T=t[7],_=t[8],S=t[9],b=t[10],M=t[11],G=t[12],O=t[13],B=t[14],H=t[15],z=r*f-s*h,k=r*p-a*h,X=r*T-o*h,Q=s*p-a*f,te=s*T-o*f,D=a*T-o*p,J=_*O-S*G,ee=_*B-b*G,Y=_*H-M*G,$=S*B-b*O,W=S*H-M*O,ie=b*H-M*B,K=z*ie-k*W+X*$+Q*Y-te*ee+D*J;return K?(K=1/K,e[0]=(f*ie-p*W+T*$)*K,e[1]=(p*Y-h*ie-T*ee)*K,e[2]=(h*W-f*Y+T*J)*K,e[3]=(a*W-s*ie-o*$)*K,e[4]=(r*ie-a*Y+o*ee)*K,e[5]=(s*Y-r*W-o*J)*K,e[6]=(O*D-B*te+H*Q)*K,e[7]=(B*X-G*D-H*k)*K,e[8]=(G*te-O*X+H*z)*K,e):null},P.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},P.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2))},typeof u<"u"&&(u.mat3=P);var F={};F.create=function(){var e=new d(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},F.clone=function(e){var t=new d(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},F.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},F.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},F.transpose=function(e,t){if(e===t){var r=t[1],s=t[2],a=t[3],o=t[6],h=t[7],f=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=s,e[9]=o,e[11]=t[14],e[12]=a,e[13]=h,e[14]=f}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},F.invert=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],h=t[4],f=t[5],p=t[6],T=t[7],_=t[8],S=t[9],b=t[10],M=t[11],G=t[12],O=t[13],B=t[14],H=t[15],z=r*f-s*h,k=r*p-a*h,X=r*T-o*h,Q=s*p-a*f,te=s*T-o*f,D=a*T-o*p,J=_*O-S*G,ee=_*B-b*G,Y=_*H-M*G,$=S*B-b*O,W=S*H-M*O,ie=b*H-M*B,K=z*ie-k*W+X*$+Q*Y-te*ee+D*J;return K?(K=1/K,e[0]=(f*ie-p*W+T*$)*K,e[1]=(a*W-s*ie-o*$)*K,e[2]=(O*D-B*te+H*Q)*K,e[3]=(b*te-S*D-M*Q)*K,e[4]=(p*Y-h*ie-T*ee)*K,e[5]=(r*ie-a*Y+o*ee)*K,e[6]=(B*X-G*D-H*k)*K,e[7]=(_*D-b*X+M*k)*K,e[8]=(h*W-f*Y+T*J)*K,e[9]=(s*Y-r*W-o*J)*K,e[10]=(G*te-O*X+H*z)*K,e[11]=(S*X-_*te-M*z)*K,e[12]=(f*ee-h*$-p*J)*K,e[13]=(r*$-s*ee+a*J)*K,e[14]=(O*k-G*Q-B*z)*K,e[15]=(_*Q-S*k+b*z)*K,e):null},F.adjoint=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],h=t[4],f=t[5],p=t[6],T=t[7],_=t[8],S=t[9],b=t[10],M=t[11],G=t[12],O=t[13],B=t[14],H=t[15];return e[0]=f*(b*H-M*B)-S*(p*H-T*B)+O*(p*M-T*b),e[1]=-(s*(b*H-M*B)-S*(a*H-o*B)+O*(a*M-o*b)),e[2]=s*(p*H-T*B)-f*(a*H-o*B)+O*(a*T-o*p),e[3]=-(s*(p*M-T*b)-f*(a*M-o*b)+S*(a*T-o*p)),e[4]=-(h*(b*H-M*B)-_*(p*H-T*B)+G*(p*M-T*b)),e[5]=r*(b*H-M*B)-_*(a*H-o*B)+G*(a*M-o*b),e[6]=-(r*(p*H-T*B)-h*(a*H-o*B)+G*(a*T-o*p)),e[7]=r*(p*M-T*b)-h*(a*M-o*b)+_*(a*T-o*p),e[8]=h*(S*H-M*O)-_*(f*H-T*O)+G*(f*M-T*S),e[9]=-(r*(S*H-M*O)-_*(s*H-o*O)+G*(s*M-o*S)),e[10]=r*(f*H-T*O)-h*(s*H-o*O)+G*(s*T-o*f),e[11]=-(r*(f*M-T*S)-h*(s*M-o*S)+_*(s*T-o*f)),e[12]=-(h*(S*B-b*O)-_*(f*B-p*O)+G*(f*b-p*S)),e[13]=r*(S*B-b*O)-_*(s*B-a*O)+G*(s*b-a*S),e[14]=-(r*(f*B-p*O)-h*(s*B-a*O)+G*(s*p-a*f)),e[15]=r*(f*b-p*S)-h*(s*b-a*S)+_*(s*p-a*f),e},F.determinant=function(e){var t=e[0],r=e[1],s=e[2],a=e[3],o=e[4],h=e[5],f=e[6],p=e[7],T=e[8],_=e[9],S=e[10],b=e[11],M=e[12],G=e[13],O=e[14],B=e[15],H=t*h-r*o,z=t*f-s*o,k=t*p-a*o,X=r*f-s*h,Q=r*p-a*h,te=s*p-a*f,D=T*G-_*M,J=T*O-S*M,ee=T*B-b*M,Y=_*O-S*G,$=_*B-b*G,W=S*B-b*O;return H*W-z*$+k*Y+X*ee-Q*J+te*D},F.multiply=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=t[4],p=t[5],T=t[6],_=t[7],S=t[8],b=t[9],M=t[10],G=t[11],O=t[12],B=t[13],H=t[14],z=t[15],k=r[0],X=r[1],Q=r[2],te=r[3];return e[0]=k*s+X*f+Q*S+te*O,e[1]=k*a+X*p+Q*b+te*B,e[2]=k*o+X*T+Q*M+te*H,e[3]=k*h+X*_+Q*G+te*z,k=r[4],X=r[5],Q=r[6],te=r[7],e[4]=k*s+X*f+Q*S+te*O,e[5]=k*a+X*p+Q*b+te*B,e[6]=k*o+X*T+Q*M+te*H,e[7]=k*h+X*_+Q*G+te*z,k=r[8],X=r[9],Q=r[10],te=r[11],e[8]=k*s+X*f+Q*S+te*O,e[9]=k*a+X*p+Q*b+te*B,e[10]=k*o+X*T+Q*M+te*H,e[11]=k*h+X*_+Q*G+te*z,k=r[12],X=r[13],Q=r[14],te=r[15],e[12]=k*s+X*f+Q*S+te*O,e[13]=k*a+X*p+Q*b+te*B,e[14]=k*o+X*T+Q*M+te*H,e[15]=k*h+X*_+Q*G+te*z,e},F.mul=F.multiply,F.translate=function(e,t,r){var s=r[0],a=r[1],o=r[2],h,f,p,T,_,S,b,M,G,O,B,H;return t===e?(e[12]=t[0]*s+t[4]*a+t[8]*o+t[12],e[13]=t[1]*s+t[5]*a+t[9]*o+t[13],e[14]=t[2]*s+t[6]*a+t[10]*o+t[14],e[15]=t[3]*s+t[7]*a+t[11]*o+t[15]):(h=t[0],f=t[1],p=t[2],T=t[3],_=t[4],S=t[5],b=t[6],M=t[7],G=t[8],O=t[9],B=t[10],H=t[11],e[0]=h,e[1]=f,e[2]=p,e[3]=T,e[4]=_,e[5]=S,e[6]=b,e[7]=M,e[8]=G,e[9]=O,e[10]=B,e[11]=H,e[12]=h*s+_*a+G*o+t[12],e[13]=f*s+S*a+O*o+t[13],e[14]=p*s+b*a+B*o+t[14],e[15]=T*s+M*a+H*o+t[15]),e},F.scale=function(e,t,r){var s=r[0],a=r[1],o=r[2];return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*a,e[5]=t[5]*a,e[6]=t[6]*a,e[7]=t[7]*a,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},F.rotate=function(e,t,r,s){var a=s[0],o=s[1],h=s[2],f=Math.sqrt(a*a+o*o+h*h),p,T,_,S,b,M,G,O,B,H,z,k,X,Q,te,D,J,ee,Y,$,W,ie,K,se;return Math.abs(f)<c?null:(f=1/f,a*=f,o*=f,h*=f,p=Math.sin(r),T=Math.cos(r),_=1-T,S=t[0],b=t[1],M=t[2],G=t[3],O=t[4],B=t[5],H=t[6],z=t[7],k=t[8],X=t[9],Q=t[10],te=t[11],D=a*a*_+T,J=o*a*_+h*p,ee=h*a*_-o*p,Y=a*o*_-h*p,$=o*o*_+T,W=h*o*_+a*p,ie=a*h*_+o*p,K=o*h*_-a*p,se=h*h*_+T,e[0]=S*D+O*J+k*ee,e[1]=b*D+B*J+X*ee,e[2]=M*D+H*J+Q*ee,e[3]=G*D+z*J+te*ee,e[4]=S*Y+O*$+k*W,e[5]=b*Y+B*$+X*W,e[6]=M*Y+H*$+Q*W,e[7]=G*Y+z*$+te*W,e[8]=S*ie+O*K+k*se,e[9]=b*ie+B*K+X*se,e[10]=M*ie+H*K+Q*se,e[11]=G*ie+z*K+te*se,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},F.rotateX=function(e,t,r){var s=Math.sin(r),a=Math.cos(r),o=t[4],h=t[5],f=t[6],p=t[7],T=t[8],_=t[9],S=t[10],b=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*a+T*s,e[5]=h*a+_*s,e[6]=f*a+S*s,e[7]=p*a+b*s,e[8]=T*a-o*s,e[9]=_*a-h*s,e[10]=S*a-f*s,e[11]=b*a-p*s,e},F.rotateY=function(e,t,r){var s=Math.sin(r),a=Math.cos(r),o=t[0],h=t[1],f=t[2],p=t[3],T=t[8],_=t[9],S=t[10],b=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*a-T*s,e[1]=h*a-_*s,e[2]=f*a-S*s,e[3]=p*a-b*s,e[8]=o*s+T*a,e[9]=h*s+_*a,e[10]=f*s+S*a,e[11]=p*s+b*a,e},F.rotateZ=function(e,t,r){var s=Math.sin(r),a=Math.cos(r),o=t[0],h=t[1],f=t[2],p=t[3],T=t[4],_=t[5],S=t[6],b=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*a+T*s,e[1]=h*a+_*s,e[2]=f*a+S*s,e[3]=p*a+b*s,e[4]=T*a-o*s,e[5]=_*a-h*s,e[6]=S*a-f*s,e[7]=b*a-p*s,e},F.fromRotationTranslation=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=s+s,p=a+a,T=o+o,_=s*f,S=s*p,b=s*T,M=a*p,G=a*T,O=o*T,B=h*f,H=h*p,z=h*T;return e[0]=1-(M+O),e[1]=S+z,e[2]=b-H,e[3]=0,e[4]=S-z,e[5]=1-(_+O),e[6]=G+B,e[7]=0,e[8]=b+H,e[9]=G-B,e[10]=1-(_+M),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e},F.fromQuat=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],h=r+r,f=s+s,p=a+a,T=r*h,_=s*h,S=s*f,b=a*h,M=a*f,G=a*p,O=o*h,B=o*f,H=o*p;return e[0]=1-S-G,e[1]=_+H,e[2]=b-B,e[3]=0,e[4]=_-H,e[5]=1-T-G,e[6]=M+O,e[7]=0,e[8]=b+B,e[9]=M-O,e[10]=1-T-S,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},F.frustum=function(e,t,r,s,a,o,h){var f=1/(r-t),p=1/(a-s),T=1/(o-h);return e[0]=o*2*f,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o*2*p,e[6]=0,e[7]=0,e[8]=(r+t)*f,e[9]=(a+s)*p,e[10]=(h+o)*T,e[11]=-1,e[12]=0,e[13]=0,e[14]=h*o*2*T,e[15]=0,e},F.perspective=function(e,t,r,s,a){var o=1/Math.tan(t/2),h=1/(s-a);return e[0]=o/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(a+s)*h,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*a*s*h,e[15]=0,e},F.ortho=function(e,t,r,s,a,o,h){var f=1/(t-r),p=1/(s-a),T=1/(o-h);return e[0]=-2*f,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*p,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*T,e[11]=0,e[12]=(t+r)*f,e[13]=(a+s)*p,e[14]=(h+o)*T,e[15]=1,e},F.lookAt=function(e,t,r,s){var a,o,h,f,p,T,_,S,b,M,G=t[0],O=t[1],B=t[2],H=s[0],z=s[1],k=s[2],X=r[0],Q=r[1],te=r[2];return Math.abs(G-X)<c&&Math.abs(O-Q)<c&&Math.abs(B-te)<c?F.identity(e):(_=G-X,S=O-Q,b=B-te,M=1/Math.sqrt(_*_+S*S+b*b),_*=M,S*=M,b*=M,a=z*b-k*S,o=k*_-H*b,h=H*S-z*_,M=Math.sqrt(a*a+o*o+h*h),M?(M=1/M,a*=M,o*=M,h*=M):(a=0,o=0,h=0),f=S*h-b*o,p=b*a-_*h,T=_*o-S*a,M=Math.sqrt(f*f+p*p+T*T),M?(M=1/M,f*=M,p*=M,T*=M):(f=0,p=0,T=0),e[0]=a,e[1]=f,e[2]=_,e[3]=0,e[4]=o,e[5]=p,e[6]=S,e[7]=0,e[8]=h,e[9]=T,e[10]=b,e[11]=0,e[12]=-(a*G+o*O+h*B),e[13]=-(f*G+p*O+T*B),e[14]=-(_*G+S*O+b*B),e[15]=1,e)},F.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},F.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2)+Math.pow(e[9],2)+Math.pow(e[10],2)+Math.pow(e[11],2)+Math.pow(e[12],2)+Math.pow(e[13],2)+Math.pow(e[14],2)+Math.pow(e[15],2))},typeof u<"u"&&(u.mat4=F);var U={};U.create=function(){var e=new d(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},U.rotationTo=function(){var e=A.create(),t=A.fromValues(1,0,0),r=A.fromValues(0,1,0);return function(s,a,o){var h=A.dot(a,o);return h<-.999999?(A.cross(e,t,a),A.length(e)<1e-6&&A.cross(e,r,a),A.normalize(e,e),U.setAxisAngle(s,e,Math.PI),s):h>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(A.cross(e,a,o),s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1+h,U.normalize(s,s))}}(),U.setAxes=function(){var e=P.create();return function(t,r,s,a){return e[0]=s[0],e[3]=s[1],e[6]=s[2],e[1]=a[0],e[4]=a[1],e[7]=a[2],e[2]=-r[0],e[5]=-r[1],e[8]=-r[2],U.normalize(t,U.fromMat3(t,e))}}(),U.clone=N.clone,U.fromValues=N.fromValues,U.copy=N.copy,U.set=N.set,U.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},U.setAxisAngle=function(e,t,r){r*=.5;var s=Math.sin(r);return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=Math.cos(r),e},U.add=N.add,U.multiply=function(e,t,r){var s=t[0],a=t[1],o=t[2],h=t[3],f=r[0],p=r[1],T=r[2],_=r[3];return e[0]=s*_+h*f+a*T-o*p,e[1]=a*_+h*p+o*f-s*T,e[2]=o*_+h*T+s*p-a*f,e[3]=h*_-s*f-a*p-o*T,e},U.mul=U.multiply,U.scale=N.scale,U.rotateX=function(e,t,r){r*=.5;var s=t[0],a=t[1],o=t[2],h=t[3],f=Math.sin(r),p=Math.cos(r);return e[0]=s*p+h*f,e[1]=a*p+o*f,e[2]=o*p-a*f,e[3]=h*p-s*f,e},U.rotateY=function(e,t,r){r*=.5;var s=t[0],a=t[1],o=t[2],h=t[3],f=Math.sin(r),p=Math.cos(r);return e[0]=s*p-o*f,e[1]=a*p+h*f,e[2]=o*p+s*f,e[3]=h*p-a*f,e},U.rotateZ=function(e,t,r){r*=.5;var s=t[0],a=t[1],o=t[2],h=t[3],f=Math.sin(r),p=Math.cos(r);return e[0]=s*p+a*f,e[1]=a*p-s*f,e[2]=o*p+h*f,e[3]=h*p-o*f,e},U.calculateW=function(e,t){var r=t[0],s=t[1],a=t[2];return e[0]=r,e[1]=s,e[2]=a,e[3]=-Math.sqrt(Math.abs(1-r*r-s*s-a*a)),e},U.dot=N.dot,U.lerp=N.lerp,U.slerp=function(e,t,r,s){var a=t[0],o=t[1],h=t[2],f=t[3],p=r[0],T=r[1],_=r[2],S=r[3],b,M,G,O,B;return M=a*p+o*T+h*_+f*S,M<0&&(M=-M,p=-p,T=-T,_=-_,S=-S),1-M>1e-6?(b=Math.acos(M),G=Math.sin(b),O=Math.sin((1-s)*b)/G,B=Math.sin(s*b)/G):(O=1-s,B=s),e[0]=O*a+B*p,e[1]=O*o+B*T,e[2]=O*h+B*_,e[3]=O*f+B*S,e},U.invert=function(e,t){var r=t[0],s=t[1],a=t[2],o=t[3],h=r*r+s*s+a*a+o*o,f=h?1/h:0;return e[0]=-r*f,e[1]=-s*f,e[2]=-a*f,e[3]=o*f,e},U.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},U.length=N.length,U.len=U.length,U.squaredLength=N.squaredLength,U.sqrLen=U.squaredLength,U.normalize=N.normalize,U.fromMat3=function(e,t){var r=t[0]+t[4]+t[8],s;if(r>0)s=Math.sqrt(r+1),e[3]=.5*s,s=.5/s,e[0]=(t[7]-t[5])*s,e[1]=(t[2]-t[6])*s,e[2]=(t[3]-t[1])*s;else{var a=0;t[4]>t[0]&&(a=1),t[8]>t[a*3+a]&&(a=2);var o=(a+1)%3,h=(a+2)%3;s=Math.sqrt(t[a*3+a]-t[o*3+o]-t[h*3+h]+1),e[a]=.5*s,s=.5/s,e[3]=(t[h*3+o]-t[o*3+h])*s,e[o]=(t[o*3+a]+t[a*3+o])*s,e[h]=(t[h*3+a]+t[a*3+h])*s}return e},U.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},typeof u<"u"&&(u.quat=U)}(n.exports)})(void 0),function(l){var n=l.GL=l.LiteGL={};if(typeof u>"u"){if(!(typeof self<"u")){if(typeof window>"u"){console.log("importing glMatrix"),l.glMatrix=require("./gl-matrix-min.js");var u=l.glMatrix;for(var c in u)l[c]=u[c]}else if(typeof u>"u")throw"litegl.js requires gl-matrix to work. It must be included before litegl."}}else if(!l.vec2)throw"litegl.js does not support gl-matrix 3.0, download 2.8 https://github.com/toji/gl-matrix/releases/tag/v2.8.1";l.requestAnimationFrame=l.requestAnimationFrame||l.mozRequestAnimationFrame||l.webkitRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},n.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0},n.reverse=null,n.LEFT_MOUSE_BUTTON=0,n.MIDDLE_MOUSE_BUTTON=1,n.RIGHT_MOUSE_BUTTON=2,n.LEFT_MOUSE_BUTTON_MASK=1,n.RIGHT_MOUSE_BUTTON_MASK=2,n.MIDDLE_MOUSE_BUTTON_MASK=4,n.last_context_id=0,n.COLOR_BUFFER_BIT=16384,n.DEPTH_BUFFER_BIT=256,n.STENCIL_BUFFER_BIT=1024,n.TEXTURE_2D=3553,n.TEXTURE_CUBE_MAP=34067,n.TEXTURE_3D=32879,n.TEXTURE_MAG_FILTER=10240,n.TEXTURE_MIN_FILTER=10241,n.TEXTURE_WRAP_S=10242,n.TEXTURE_WRAP_T=10243,n.BYTE=5120,n.UNSIGNED_BYTE=5121,n.SHORT=5122,n.UNSIGNED_SHORT=5123,n.INT=5124,n.UNSIGNED_INT=5125,n.FLOAT=5126,n.HALF_FLOAT_OES=36193,n.HALF_FLOAT=5131,n.DEPTH_COMPONENT16=33189,n.DEPTH_COMPONENT24=33190,n.DEPTH_COMPONENT32F=36012,n.FLOAT_VEC2=35664,n.FLOAT_VEC3=35665,n.FLOAT_VEC4=35666,n.INT_VEC2=35667,n.INT_VEC3=35668,n.INT_VEC4=35669,n.BOOL=35670,n.BOOL_VEC2=35671,n.BOOL_VEC3=35672,n.BOOL_VEC4=35673,n.FLOAT_MAT2=35674,n.FLOAT_MAT3=35675,n.FLOAT_MAT4=35676,n.TYPE_LENGTH={},n.TYPE_LENGTH[n.FLOAT]=n.TYPE_LENGTH[n.INT]=n.TYPE_LENGTH[n.BYTE]=n.TYPE_LENGTH[n.BOOL]=1,n.TYPE_LENGTH[n.FLOAT_VEC2]=n.TYPE_LENGTH[n.INT_VEC2]=n.TYPE_LENGTH[n.BOOL_VEC2]=2,n.TYPE_LENGTH[n.FLOAT_VEC3]=n.TYPE_LENGTH[n.INT_VEC3]=n.TYPE_LENGTH[n.BOOL_VEC3]=3,n.TYPE_LENGTH[n.FLOAT_VEC4]=n.TYPE_LENGTH[n.INT_VEC4]=n.TYPE_LENGTH[n.BOOL_VEC4]=4,n.TYPE_LENGTH[n.FLOAT_MAT3]=9,n.TYPE_LENGTH[n.FLOAT_MAT4]=16,n.SAMPLER_2D=35678,n.SAMPLER_3D=35679,n.SAMPLER_CUBE=35680,n.INT_SAMPLER_2D=36298,n.INT_SAMPLER_3D=36299,n.INT_SAMPLER_CUBE=36300,n.UNSIGNED_INT_SAMPLER_2D=36306,n.UNSIGNED_INT_SAMPLER_3D=36307,n.UNSIGNED_INT_SAMPLER_CUBE=36308,n.DEPTH_COMPONENT=6402,n.ALPHA=6406,n.RGB=6407,n.RGBA=6408,n.LUMINANCE=6409,n.LUMINANCE_ALPHA=6410,n.DEPTH_STENCIL=34041,n.UNSIGNED_INT_24_8_WEBGL=34042,n.R8=33321,n.R16F=33325,n.R32F=33326,n.R8UI=33330,n.RG8=33323,n.RG16F=33327,n.RG32F=33328,n.RGB8=32849,n.SRGB8=35905,n.RGB565=36194,n.R11F_G11F_B10F=35898,n.RGB9_E5=35901,n.RGB16F=34843,n.RGB32F=34837,n.RGB8UI=36221,n.RGBA8=32856,n.RGB5_A1=32855,n.RGBA16F=34842,n.RGBA32F=34836,n.RGBA8UI=36220,n.RGBA16I=36232,n.RGBA16UI=36214,n.RGBA32I=36226,n.RGBA32UI=36208,n.NEAREST=9728,n.LINEAR=9729,n.NEAREST_MIPMAP_NEAREST=9984,n.LINEAR_MIPMAP_NEAREST=9985,n.NEAREST_MIPMAP_LINEAR=9986,n.LINEAR_MIPMAP_LINEAR=9987,n.REPEAT=10497,n.CLAMP_TO_EDGE=33071,n.MIRRORED_REPEAT=33648,n.ZERO=0,n.ONE=1,n.SRC_COLOR=768,n.ONE_MINUS_SRC_COLOR=769,n.SRC_ALPHA=770,n.ONE_MINUS_SRC_ALPHA=771,n.DST_ALPHA=772,n.ONE_MINUS_DST_ALPHA=773,n.DST_COLOR=774,n.ONE_MINUS_DST_COLOR=775,n.SRC_ALPHA_SATURATE=776,n.CONSTANT_COLOR=32769,n.ONE_MINUS_CONSTANT_COLOR=32770,n.CONSTANT_ALPHA=32771,n.ONE_MINUS_CONSTANT_ALPHA=32772,n.VERTEX_SHADER=35633,n.FRAGMENT_SHADER=35632,n.FRONT=1028,n.BACK=1029,n.FRONT_AND_BACK=1032,n.NEVER=512,n.LESS=513,n.EQUAL=514,n.LEQUAL=515,n.GREATER=516,n.NOTEQUAL=517,n.GEQUAL=518,n.ALWAYS=519,n.KEEP=7680,n.REPLACE=7681,n.INCR=7682,n.DECR=7683,n.INCR_WRAP=34055,n.DECR_WRAP=34056,n.INVERT=5386,n.STREAM_DRAW=35040,n.STATIC_DRAW=35044,n.DYNAMIC_DRAW=35048,n.ARRAY_BUFFER=34962,n.ELEMENT_ARRAY_BUFFER=34963,n.POINTS=0,n.LINES=1,n.LINE_LOOP=2,n.LINE_STRIP=3,n.TRIANGLES=4,n.TRIANGLE_STRIP=5,n.TRIANGLE_FAN=6,n.CW=2304,n.CCW=2305,n.CULL_FACE=2884,n.DEPTH_TEST=2929,n.BLEND=3042,n.temp_vec3=vec3.create(),n.temp2_vec3=vec3.create(),n.temp_vec4=vec4.create(),n.temp_quat=quat.create(),n.temp_mat3=mat3.create(),n.temp_mat4=mat4.create(),l.DEG2RAD=.0174532925,l.RAD2DEG=57.295779578552306,l.EPSILON=1e-6,l.isPowerOfTwo=n.isPowerOfTwo=function(t){return Math.log(t)/Math.log(2)%1==0},l.nearestPowerOfTwo=n.nearestPowerOfTwo=function(t){return Math.pow(2,Math.round(Math.log(t)/Math.log(2)))},l.nextPowerOfTwo=n.nextPowerOfTwo=function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)))};var d=[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array];function g(){return Array.prototype.slice.call(this)}d.forEach(function(e){e.prototype.toJSON||Object.defineProperty(e.prototype,"toJSON",{value:g,enumerable:!1,configurable:!0,writable:!0})}),typeof performance<"u"?l.getTime=performance.now.bind(performance):l.getTime=Date.now.bind(Date),n.getTime=l.getTime,l.isFunction=function(t){return!!(t&&t.constructor&&t.call&&t.apply)},l.isArray=function(t){return t&&t.constructor===Array},l.isNumber=function(t){return t!=null&&t.constructor===Number},l.getClassName=function(t){if(t){if(t.name)return t.name;if(t.toString){var r=t.toString().match(/function\s*(\w+)/);if(r&&r.length==2)return r[1]}}},l.cloneObject=n.cloneObject=function(e,t){if(e.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";t=t||{};for(var r in e){var s=e[r];if(s===null){t[r]=null;continue}switch(s.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:t[r]=new s.constructor(s);break;case Boolean:case Number:case String:t[r]=s;break;case Array:t[r]=s.concat();break;case Object:t[r]=n.cloneObject(s);break}}return t},l.regexMap=function(t,r,s){for(var a;(a=t.exec(r))!=null;)s(a)},l.createCanvas=n.createCanvas=function(t,r){var s=document.createElement("canvas");return s.width=t,s.height=r,s},l.cloneCanvas=n.cloneCanvas=function(t){var r=document.createElement("canvas");r.width=t.width,r.height=t.height;var s=r.getContext("2d");return s.drawImage(t,0,0),r},typeof Image<"u"&&(Image.prototype.getPixels=function(){var e=document.createElement("canvas");e.width=this.width,e.height=this.height;var t=e.getContext("2d");return t.drawImage(this,0,0),t.getImageData(0,0,this.width,this.height).data}),String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(e){var t=this;for(var r in e)t=t.split(r).join(e[r]);return t},enumerable:!1}),String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var e=0,t,r,s;if(this.length==0)return e;for(t=0,s=this.length;t<s;++t)r=this.charCodeAt(t),e=(e<<5)-e+r,e|=0;return e},enumerable:!1}),Array.prototype.hasOwnProperty("clone")||Object.defineProperty(Array.prototype,"clone",{value:Array.prototype.concat,enumerable:!1}),Float32Array.prototype.hasOwnProperty("clone")||Object.defineProperty(Float32Array.prototype,"clone",{value:function(){return new Float32Array(this)},enumerable:!1}),l.wipeObject=function(t){for(var r in t)t.hasOwnProperty(r)&&delete t[r]},l.extendClass=n.extendClass=function(t,r){for(var s in r)t.hasOwnProperty(s)||(t[s]=r[s]);if(r.prototype)for(var a=Object.getOwnPropertyNames(r.prototype),s=0;s<a.length;++s){var o=a[s];t.prototype.hasOwnProperty(o)||(r.prototype.__lookupGetter__(o)?t.prototype.__defineGetter__(o,r.prototype.__lookupGetter__(o)):t.prototype[o]=r.prototype[o],r.prototype.__lookupSetter__(o)&&t.prototype.__defineSetter__(o,r.prototype.__lookupSetter__(o)))}t.hasOwnProperty("superclass")||Object.defineProperty(t,"superclass",{get:function(){return r},enumerable:!1})},l.HttpRequest=n.request=function(t,r,s,a,o){var h=!0;if(o=o||{},o.async!==void 0&&(h=o.async),r){var f=null,p=[];for(var T in r)p.push(T+"="+r[T]);f=p.join("&"),t=t+"?"+f}var _=new XMLHttpRequest;if(_.open("GET",t,h),_.responseType=o.responseType||"text",_.onload=function(S){if(this.response,this.getResponseHeader("Content-Type"),this.status!=200){F.trigger(_,"fail",this.status),a&&a(this.status);return}F.trigger(_,"done",this.response),s&&s(this.response)},_.onerror=function(S){F.trigger(_,"fail",S)},o){for(var T in o)_[T]=o[T];o.binary&&(_.responseType="arraybuffer")}return _.send(),_},l.XMLHttpRequest&&(XMLHttpRequest.prototype.hasOwnProperty("done")||Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(e){return F.bind(this,"done",function(t,r){e(r)}),this}}),XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(e){return F.bind(this,"fail",function(t,r){e(r)}),this}})),l.getFileExtension=function(t){var r=t.indexOf("?");r!=-1&&(t=t.substr(0,r));var s=t.lastIndexOf(".");return s==-1?"":t.substr(s+1).toLowerCase()},l.loadFileAtlas=n.loadFileAtlas=function(t,r,s){var a=null;return HttpRequest(t,null,function(o){var h=n.processFileAtlas(o);r&&r(h),a&&a(h)},alert,s),{done:function(o){a=o}}},l.processFileAtlas=n.processFileAtlas=function(e,t){for(var r=e.split(`
`),s={},a=[],o="",h=0,f=r.length;h<f;h++){var p=t?r[h]:r[h].trim();if(p.length){if(p[0]!="\\"){a.push(p);continue}a.length&&(s[o]=a.join(`
`)),a.length=0,o=p.substr(1)}}return a.length&&(s[o]=a.join(`
`)),s},l.typedArrayToArray=function(e){var t=[];t.length=e.length;for(var r=0;r<e.length;r++)t[r]=e[r];return t},l.RGBToHex=function(e,t,r){return e=Math.min(255,e*255)|0,t=Math.min(255,t*255)|0,r=Math.min(255,r*255)|0,"#"+((1<<24)+(e<<16)+(t<<8)+r).toString(16).slice(1)},l.HUEToRGB=function(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+(t-e)*6*r:r<1/2?t:r<2/3?e+(t-e)*(2/3-r)*6:e},l.HSLToRGB=function(e,t,r,s){var a,o,h;if(s=s||vec3.create(),t==0)a=o=h=r;else{var f=r<.5?r*(1+t):r+t-r*t,p=2*r-f;a=HUEToRGB(p,f,e+1/3),o=HUEToRGB(p,f,e),h=HUEToRGB(p,f,e-1/3)}return s[0]=a,s[1]=o,s[2]=h,s},l.hexColorToRGBA=function(){var e={white:[1,1,1],black:[0,0,0],gray:[.501960813999176,.501960813999176,.501960813999176],red:[1,0,0],orange:[1,.6470588445663452,0],pink:[1,.7529411911964417,.7960784435272217],green:[0,.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[.9333333373069763,.5098039507865906,.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[.6470588445663452,.16470588743686676,.16470588743686676],silver:[.7529411911964417,.7529411911964417,.7529411911964417],gold:[1,.843137264251709,0],transparent:[0,0,0,0]};return function(t,r,s){if(s=s===void 0?1:s,r=r||new Float32Array(4),r[3]=s,typeof t!="string")return r;var a=e[t];if(a!==void 0)return r.set(a),r.length==3?r[3]=s:r[3]*=s,r;var h=t.indexOf("rgba(");if(h!=-1){var o=t.substr(5,t.length-2);return o=o.split(","),r[0]=parseInt(o[0])/255,r[1]=parseInt(o[1])/255,r[2]=parseInt(o[2])/255,r[3]=parseFloat(o[3])*s,r}var h=t.indexOf("hsla(");if(h!=-1){var o=t.substr(5,t.length-2);return o=o.split(","),HSLToRGB(parseInt(o[0])/360,parseInt(o[1])/100,parseInt(o[2])/100,r),r[3]=parseFloat(o[3])*s,r}r[3]=s;var h=t.indexOf("rgb(");if(h!=-1){var o=t.substr(4,t.length-2);return o=o.split(","),r[0]=parseInt(o[0])/255,r[1]=parseInt(o[1])/255,r[2]=parseInt(o[2])/255,r}var h=t.indexOf("hsl(");if(h!=-1){var o=t.substr(4,t.length-2);return o=o.split(","),HSLToRGB(parseInt(o[0])/360,parseInt(o[1])/100,parseInt(o[2])/100,r),r}var f=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(f,function(T,_,S,b){return _+_+S+S+b+b});var p=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return p&&(r[0]=parseInt(p[1],16)/255,r[1]=parseInt(p[2],16)/255,r[2]=parseInt(p[3],16)/255),r}}(),l.toHalfFloat=function(){var e=new Float32Array(1),t=new Int32Array(e.buffer);return function(s){e[0]=s;var a=t[0],o=a>>16&32768,h=(a&2147483647)+4096;return h>=1199570944?(a&2147483647)>=1199570944?h<2139095040?o|31744:o|31744|(a&8388607)>>13:o|31743:h>=947912704?o|h-939524096>>13:h<855638016?o:(h=(a&2147483647)>>23,o|(a&8388607|8388608)+(8388608>>>h-102)>>126-h)}}();var m=function(){var e=542327876,t=131072,r=512,s=4;function a($){return $.charCodeAt(0)+($.charCodeAt(1)<<8)+($.charCodeAt(2)<<16)+($.charCodeAt(3)<<24)}function o($){return String.fromCharCode($&255,$>>8&255,$>>16&255,$>>24&255)}var h=a("DXT1"),f=a("DXT3"),p=a("DXT5"),T=31,_=0,S=1,b=2,M=3,G=4,O=7,B=20,H=21,z=27;function k($,W,ie,K){for(var se=new Uint16Array(4),le=new Uint16Array(ie*K),ue=0,he=0,ve=0,I=0,V=0,Z=0,j=0,re=0,ae=0,oe=ie/4,_e=K/4,ce=0;ce<_e;ce++)for(var fe=0;fe<oe;fe++)ve=W+4*(ce*oe+fe),se[0]=$[ve],se[1]=$[ve+1],I=se[0]&31,V=se[0]&2016,Z=se[0]&63488,j=se[1]&31,re=se[1]&2016,ae=se[1]&63488,se[2]=5*I+3*j>>3|5*V+3*re>>3&2016|5*Z+3*ae>>3&63488,se[3]=5*j+3*I>>3|5*re+3*V>>3&2016|5*ae+3*Z>>3&63488,ue=$[ve+2],he=ce*4*ie+fe*4,le[he]=se[ue&3],le[he+1]=se[ue>>2&3],le[he+2]=se[ue>>4&3],le[he+3]=se[ue>>6&3],he+=ie,le[he]=se[ue>>8&3],le[he+1]=se[ue>>10&3],le[he+2]=se[ue>>12&3],le[he+3]=se[ue>>14],ue=$[ve+3],he+=ie,le[he]=se[ue&3],le[he+1]=se[ue>>2&3],le[he+2]=se[ue>>4&3],le[he+3]=se[ue>>6&3],he+=ie,le[he]=se[ue>>8&3],le[he+1]=se[ue>>10&3],le[he+2]=se[ue>>12&3],le[he+3]=se[ue>>14];return le}function X($){for(var W=0,ie=$.length,K=0;W<ie;W+=4)K=$[W],$[W]=$[W+2],$[W+2]=K}function Q($,W,ie,K){var se=new Int32Array(ie,0,T),le,ue,he,ve,I,V,Z,j,re,ae,oe,_e,ce;if(se[_]!=e)return console.error("Invalid magic number in DDS header"),0;if(!se[B]&s)return console.error("Unsupported format, must contain a FourCC code"),0;switch(le=se[H],le){case h:ue=8,he=W?W.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case f:ue=16,he=W?W.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case p:ue=16,he=W?W.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:ue=4,le=null,he=$.RGBA}if(oe=1,se[b]&t&&K!==!1&&(oe=Math.max(1,se[O])),ve=se[G],I=se[M],Z=se[S]+4,j=!!(se[z+1]&r),j)for(ce=0;ce<6;++ce){ve=se[G],I=se[M];for(var _e=0;_e<oe;++_e)le?(V=Math.max(4,ve)/4*Math.max(4,I)/4*ue,ae=new Uint8Array(ie,Z,V),$.compressedTexImage2D($.TEXTURE_CUBE_MAP_POSITIVE_X+ce,_e,he,ve,I,0,ae)):($.pixelStorei($.UNPACK_FLIP_Y_WEBGL,!1),V=ve*I*ue,ae=new Uint8Array(ie,Z,V),X(ae),$.texImage2D($.TEXTURE_CUBE_MAP_POSITIVE_X+ce,_e,he,ve,I,0,$.RGBA,$.UNSIGNED_BYTE,ae)),Z+=V,ve*=.5,I*=.5}else if(W){$.pixelStorei($.UNPACK_FLIP_Y_WEBGL,!0);for(var _e=0;_e<oe;++_e)le?(V=Math.max(4,ve)/4*Math.max(4,I)/4*ue,ae=new Uint8Array(ie,Z,V),$.compressedTexImage2D($.TEXTURE_2D,_e,he,ve,I,0,ae)):(V=ve*I*ue,ae=new Uint8Array(ie,Z,V),X(ae),$.texImage2D($.TEXTURE_2D,_e,he,ve,I,0,he,$.UNSIGNED_BYTE,ae)),Z+=V,ve*=.5,I*=.5}else if(le==h)V=Math.max(4,ve)/4*Math.max(4,I)/4*ue,ae=new Uint16Array(ie),re=k(ae,Z/2,ve,I),$.texImage2D($.TEXTURE_2D,0,$.RGB,ve,I,0,$.RGB,$.UNSIGNED_SHORT_5_6_5,re),K&&$.generateMipmap($.TEXTURE_2D);else return console.error("No manual decoder for",o(le),"and no native support"),0;return oe}function te($,W){var ie=new Int32Array($,0,T),K,se,le,ue,he,ve,I,V,Z,j,re,ae;if(ie[_]!=e)return console.error("Invalid magic number in DDS header"),0;if(!ie[B]&s)return console.error("Unsupported format, must contain a FourCC code"),0;switch(K=ie[H],K){case h:se=8,le="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case f:se=16,le="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case p:se=16,le="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:se=4,le="RGBA"}j=1,ie[b]&t&&loadMipmaps!==!1&&(j=Math.max(1,ie[O])),ue=ie[G],he=ie[M],I=ie[S]+4,V=!!(ie[z+1]&r);var oe=[];if(V)for(var ae=0;ae<6;++ae){ue=ie[G],he=ie[M];for(var re=0;re<j;++re)K?(ve=Math.max(4,ue)/4*Math.max(4,he)/4*se,Z=new Uint8Array($,I,ve),oe.push({tex:"TEXTURE_CUBE_MAP",face:ae,mipmap:re,internalFormat:le,width:ue,height:he,offset:0,dataOffset:I,dataLength:ve})):(ve=ue*he*se,Z=new Uint8Array($,I,ve),X(Z),oe.push({tex:"TEXTURE_CUBE_MAP",face:ae,mipmap:re,internalFormat:le,width:ue,height:he,offset:0,type:"UNSIGNED_BYTE",dataOffset:I,dataLength:ve})),I+=ve,ue*=.5,he*=.5}else for(var re=0;re<j;++re)ve=Math.max(4,ue)/4*Math.max(4,he)/4*se,Z=new Uint8Array($,I,ve),oe.push({tex:"TEXTURE_2D",mipmap:re,internalFormat:le,width:ue,height:he,offset:0,type:"UNSIGNED_BYTE",dataOffset:I,dataLength:ve}),I+=ve,ue*=.5,he*=.5;return oe}function D($,W,ie,K,se,le){var ue=new XMLHttpRequest;return ue.open("GET",ie,!0),ue.responseType="arraybuffer",ue.onload=function(){if(this.status==200){var he=new Int32Array(this.response,0,T),ve=!!(he[z+1]&r),I=ve?$.TEXTURE_CUBE_MAP:$.TEXTURE_2D;$.bindTexture(I,K);var V=Q($,W,this.response,se);$.texParameteri(I,$.TEXTURE_MAG_FILTER,$.LINEAR),$.texParameteri(I,$.TEXTURE_MIN_FILTER,V>1?$.LINEAR_MIPMAP_LINEAR:$.LINEAR),$.bindTexture(I,null),K.texture_type=I,K.width=he[G],K.height=he[M]}le&&le(K)},ue.send(null),K}function J($,W,ie,K,se){var le=new Int32Array(ie,0,T),ue=!!(le[z+1]&r),he=ue?$.TEXTURE_CUBE_MAP:$.TEXTURE_2D;K.handler,$.bindTexture(he,K.handler);var ve=Q($,W,ie,se);return $.texParameteri(he,$.TEXTURE_MAG_FILTER,$.LINEAR),$.texParameteri(he,$.TEXTURE_MIN_FILTER,ve>1?$.LINEAR_MIPMAP_LINEAR:$.LINEAR),ue&&($.texParameteri(he,$.TEXTURE_WRAP_S,$.CLAMP_TO_EDGE),$.texParameteri(he,$.TEXTURE_WRAP_T,$.CLAMP_TO_EDGE)),$.bindTexture(he,null),K.handler&&(K.texture_type=he,K.width=le[G],K.height=le[M]),K}function ee($){var W=new Int32Array($,0,T),ie=!!(W[z+1]&r),K=ie?"TEXTURE_CUBE_MAP":"TEXTURE_2D",se=te($),le={type:K,buffers:se,data:$,width:W[G],height:W[M]};return le}function Y($,le,ie,K){var se=$.createTexture(),le=$.getExtension("WEBGL_compressed_texture_s3tc");return D($,le,ie,se,!0,K),se}return{dxtToRgb565:k,uploadDDSLevels:Q,loadDDSTextureEx:D,loadDDSTexture:Y,loadDDSTextureFromMemoryEx:J,getDDSTextureFromMemoryEx:ee}}();if(typeof l<"u"&&(l.DDS=m),typeof u>"u"&&typeof exports<"u"&&typeof process!==void 0&&exports.vec3)for(var c in exports)l[c]=exports[c];Math.clamp=function(e,t,r){return t>e?t:r<e?r:e},Math.lerp=function(e,t,r){return e*(1-r)+t*r},Math.lerp01=function(e,t,r){return Math.clamp(e*(1-r)+t*r,0,1)},Math.iLerp=function(e,t,r){return(r-e)/(t-e)},Math.remap=function(e,t,r,s,a){return Math.lerp(s,a,Math.iLerp(t,r,e))},vec3.create,vec3.create,vec3.ZERO=vec3.fromValues(0,0,0),vec3.FRONT=vec3.fromValues(0,0,-1),vec3.UP=vec3.fromValues(0,1,0),vec3.RIGHT=vec3.fromValues(1,0,0),vec2.rotate=function(e,t,r){var s=t[0],a=t[1],o=Math.cos(r),h=Math.sin(r);return e[0]=s*o-a*h,e[1]=s*h+a*o,e},vec3.zero=function(e){return e[0]=e[1]=0,e},vec2.perpdot=function(e,t){return e[1]*t[0]+-e[0]*t[1]},vec2.computeSignedAngle=function(e,t){return Math.atan2(vec2.perpdot(e,t),vec2.dot(e,t))},vec2.random=function(e,t){return t=t||1,e[0]=Math.random()*t,e[1]=Math.random()*t,e},vec3.zero=function(e){return e[0]=e[1]=e[2]=0,e},vec3.minValue=function(e){return e[0]<e[1]&&e[0]<e[2]?e[0]:e[1]<e[2]?e[1]:e[2]},vec3.maxValue=function(e){return e[0]>e[1]&&e[0]>e[2]?e[0]:e[1]>e[2]?e[1]:e[2]},vec3.minValue=function(e){return e[0]<e[1]&&e[0]<e[2]?e[0]:e[1]<e[2]?e[1]:e[2]},vec3.addValue=function(e,t,r){e[0]=t[0]+r,e[1]=t[1]+r,e[2]=t[2]+r},vec3.subValue=function(e,t,r){e[0]=t[0]-r,e[1]=t[1]-r,e[2]=t[2]-r},vec3.toArray=function(e){return[e[0],e[1],e[2]]},vec3.rotateX=function(e,t,r){var s=t[1],a=t[2],o=Math.cos(r),h=Math.sin(r);return e[0]=t[0],e[1]=s*o-a*h,e[2]=s*h+a*o,e},vec3.rotateY=function(e,t,r){var s=t[0],a=t[2],o=Math.cos(r),h=Math.sin(r);return e[0]=s*o-a*h,e[1]=t[1],e[2]=s*h+a*o,e},vec3.rotateZ=function(e,t,r){var s=t[0],a=t[1],o=Math.cos(r),h=Math.sin(r);return e[0]=s*o-a*h,e[1]=s*h+a*o,e[2]=t[2],e},vec3.angle=function(e,t){return Math.acos(vec3.dot(e,t))},vec3.signedAngle=function(e,t,r){var s=vec3.angle(e,t),a=e[1]*t[2]-e[2]*t[1],o=e[2]*t[0]-e[0]*t[2],h=e[0]*t[1]-e[1]*t[0],f=Math.sign(r[0]*a+r[1]*o+r[2]*h);return s*f},vec3.random=function(e,t){return t=t||1,e[0]=Math.random()*t,e[1]=Math.random()*t,e[2]=Math.random()*t,e},vec3.cartesianToPolar=function(e,t){e=e||vec3.create();var r=t[0],s=t[1],a=t[2];return e[0]=Math.sqrt(r*r+s*s+a*a),e[1]=Math.asin(s/e[0]),e[2]=Math.atan2(r,a),e},vec3.polarToCartesian=function(e,t){var r=t[0],s=t[1],a=t[2];return e[0]=r*Math.cos(s)*Math.sin(a),e[1]=r*Math.sin(s),e[2]=r*Math.cos(s)*Math.cos(a),e},vec3.reflect=function(e,t,r){var s=t[0],a=t[1],o=t[2];return vec3.scale(e,r,-2*vec3.dot(t,r)),e[0]+=s,e[1]+=a,e[2]+=o,e},vec4.random=function(e,t){return t=t||1,e[0]=Math.random()*t,e[1]=Math.random()*t,e[2]=Math.random()*t,e[3]=Math.random()*t,e},vec4.toArray=function(e){return[e[0],e[1],e[2],e[3]]},mat3.IDENTITY=mat3.create(),mat4.IDENTITY=mat4.create(),mat4.toArray=function(e){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]},mat4.setUpAndOrthonormalize=function(e,t,r){t!=e&&mat4.copy(e,t);var s=e.subarray(0,3);vec3.normalize(e.subarray(4,7),r);var a=e.subarray(8,11);vec3.cross(s,r,a),vec3.normalize(s,s),vec3.cross(a,s,r),vec3.normalize(a,a)},mat4.multiplyVec3=function(e,t,r){var s=r[0],a=r[1],o=r[2];return e[0]=t[0]*s+t[4]*a+t[8]*o+t[12],e[1]=t[1]*s+t[5]*a+t[9]*o+t[13],e[2]=t[2]*s+t[6]*a+t[10]*o+t[14],e},mat4.projectVec3=function(e,t,r){var s=r[0],a=r[1],o=r[2],h=t[0]*s+t[4]*a+t[8]*o+t[12],f=t[1]*s+t[5]*a+t[9]*o+t[13],p=t[2]*s+t[6]*a+t[10]*o+t[14],T=t[3]*s+t[7]*a+t[11]*o+t[15];return e[0]=(h/T+1)/2,e[1]=(f/T+1)/2,e[2]=(p/T+1)/2,e},vec3.project=function(e,t,r,s){s=s||gl.viewport_data;var a=r,o=t[0],h=t[1],f=t[2],p=a[0]*o+a[4]*h+a[8]*f+a[12],T=a[1]*o+a[5]*h+a[9]*f+a[13],_=a[2]*o+a[6]*h+a[10]*f+a[14],S=a[3]*o+a[7]*h+a[11]*f+a[15],b=(p/S+1)/2,M=1-(T/S+1)/2,G=(_/S+1)/2;return e[0]=b*s[2]+s[0],e[1]=M*s[3]+s[1],e[2]=G,e};var E=mat4.create(),L=vec4.create();vec3.unproject=function(e,t,r,s){var a=E,o=L;return o[0]=(t[0]-s[0])*2/s[2]-1,o[1]=(t[1]-s[1])*2/s[3]-1,o[2]=2*t[2]-1,o[3]=1,!mat4.invert(a,r)||(vec4.transformMat4(o,o,a),o[3]===0)?null:(e[0]=o[0]/o[3],e[1]=o[1]/o[3],e[2]=o[2]/o[3],e)},mat4.rotateVec3=function(e,t,r){var s=r[0],a=r[1],o=r[2];return e[0]=t[0]*s+t[4]*a+t[8]*o,e[1]=t[1]*s+t[5]*a+t[9]*o,e[2]=t[2]*s+t[6]*a+t[10]*o,e},mat4.fromTranslationFrontTop=function(e,t,r,s){return vec3.cross(e.subarray(0,3),r,s),e.set(s,4),e.set(r,8),e.set(t,12),e},mat4.translationMatrix=function(e){var t=mat4.create();return t[12]=e[0],t[13]=e[1],t[14]=e[2],t},mat4.setTranslation=function(e,t){return e[12]=t[0],e[13]=t[1],e[14]=t[2],e},mat4.getTranslation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},mat4.toRotationMat4=function(e,t){return mat4.copy(e,t),e[12]=e[13]=e[14]=0,e},mat4.swapRows=function(e,t,r,s){if(e!=t)return mat4.copy(e,t),e[4*r]=t[4*s],e[4*r+1]=t[4*s+1],e[4*r+2]=t[4*s+2],e[4*r+3]=t[4*s+3],e[4*s]=t[4*r],e[4*s+1]=t[4*r+1],e[4*s+2]=t[4*r+2],e[4*s+3]=t[4*r+3],e;var a=new Float32Array(matrix.subarray(r*4,r*5));return matrix.set(matrix.subarray(s*4,s*5),r*4),matrix.set(a,s*4),e},mat4.scaleAndAdd=function(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e[3]=t[3]+r[3]*s,e[4]=t[4]+r[4]*s,e[5]=t[5]+r[5]*s,e[6]=t[6]+r[6]*s,e[7]=t[7]+r[7]*s,e[8]=t[8]+r[8]*s,e[9]=t[9]+r[9]*s,e[10]=t[10]+r[10]*s,e[11]=t[11]+r[11]*s,e[12]=t[12]+r[12]*s,e[13]=t[13]+r[13]*s,e[14]=t[14]+r[14]*s,e[15]=t[15]+r[15]*s,e},quat.fromAxisAngle=function(e,t){var r=quat.create();t=t*.5;var s=Math.sin(t);return r[0]=s*e[0],r[1]=s*e[1],r[2]=s*e[2],r[3]=Math.cos(t),r},quat.lookRotation=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s,a,o){vec3.normalize(e,a),vec3.cross(t,o,e),vec3.normalize(t,t),vec3.cross(r,e,t);var h=t[0],f=t[1],p=t[2],T=r[0],_=r[1],S=r[2],b=e[0],M=e[1],G=e[2],O=h+_+G;if(O>0){var B=Math.sqrt(O+1);return s[3]=B*.5,B=.5/B,s[0]=(S-M)*B,s[1]=(b-p)*B,s[2]=(f-T)*B,s}if(h>=_&&h>=G){var H=Math.sqrt(1+h-_-G),z=.5/H;return s[0]=.5*H,s[1]=(f+T)*z,s[2]=(p+b)*z,s[3]=(S-M)*z,s}if(_>G){var k=Math.sqrt(1+_-h-G),X=.5/k;return s[0]=(T+f)*X,s[1]=.5*k,s[2]=(M+S)*X,s[3]=(b-p)*X,s}var Q=Math.sqrt(1+G-h-_),te=.5/Q;return s[0]=(b+p)*te,s[1]=(M+S)*te,s[2]=.5*Q,s[3]=(f-T)*te,s}}(),quat.toEuler=function(e,t){var r=Math.atan2(2*t[1]*t[3]-2*t[0]*t[2],1-2*t[1]*t[1]-2*t[2]*t[2]),s=Math.asin(2*t[0]*t[1]+2*t[2]*t[3]),a=Math.atan2(2*t[0]*t[3]-2*t[1]*t[2],1-2*t[0]*t[0]-2*t[2]*t[2]);return e||(e=vec3.create()),vec3.set(e,r,s,a),e},quat.fromEuler=function(e,t){var r=t[0],s=t[1],a=t[2],o=Math.cos(r),h=Math.cos(s),f=Math.cos(a),p=Math.sin(r),T=Math.sin(s),_=Math.sin(a),S=Math.sqrt(1+o*h+o*f-p*T*_+h*f)*.5;S==0&&(S=1e-6);var b=(h*_+o*_+p*T*f)/(4*S),M=(p*h+p*f+o*T*_)/(4*S),G=(-p*_+o*T*f+T)/(4*S);return quat.set(e,b,M,G,S),quat.normalize(e,e),e},quat.fromMat4=function(e,t){var r=t[0]+t[5]+t[10];if(r>0){var s=Math.sqrt(r+1);e[3]=s*.5;var a=.5/s;e[0]=(t[9]-t[6])*a,e[1]=(t[8]-t[2])*a,e[2]=(t[4]-t[1])*a}else{var o=0;t[5]>t[0]&&(o=1),t[10]>t[o*4+o]&&(o=2);var h=(o+1)%3,f=(h+1)%3,s=Math.sqrt(t[o*4+o]-t[h*4+h]-t[f*4+f]+1);e[o]=.5*s;var a=.5/s;e[3]=(t[f*4+h]-t[h*4+f])*a,e[h]=(t[h*4+o]+t[o*4+h])*a,e[f]=(t[f*4+o]+t[o*4+f])*a}quat.normalize(e,e)},vec3.getMat3Column=function(e,t,r){return e[0]=t[r*3],e[1]=t[r*3+1],e[2]=t[r*3+2],e},mat3.setColumn=function(e,t,r){return e[r*3]=t[0],e[r*3+1]=t[1],e[r*3+2]=t[2],e},quat.fromMat3AndQuat=function(){var e=mat3.create(),t=quat.create(),r=vec3.create(),s=vec3.create(),a=vec3.create(),o=vec3.create(),h=vec3.create(),f=vec3.create(),p=vec3.create(),T=vec3.create(),_=vec3.create(),S=vec3.create();return mat3.create(),function(b,M,G){G=G||25;for(var O=0;O<G;++O){var B=mat3.fromQuat(e,b);vec3.getMat3Column(r,B,0),vec3.getMat3Column(s,B,1),vec3.getMat3Column(a,B,2),vec3.getMat3Column(o,M,0),vec3.getMat3Column(h,M,1),vec3.getMat3Column(f,M,2),vec3.cross(p,r,o),vec3.cross(T,s,h),vec3.cross(_,a,f),vec3.add(S,p,T),vec3.add(S,S,_);var H=1/Math.abs(vec3.dot(r,o)+vec3.dot(s,h)+vec3.dot(a,f))+1e-9;vec3.scale(S,S,H);var z=vec3.length(S);if(z<1e-9)break;vec3.scale(S,S,1/z),quat.setAxisAngle(t,S,z),quat.mul(b,t,b),quat.normalize(b,b)}return b}}(),quat.rotateToFrom=function(){var e=vec3.create();return function(t,r,s){t=t||quat.create();var a=vec3.cross(e,r,s),o=vec3.dot(r,s);return o<-1+.01?(t[0]=0,t[1]=1,t[2]=0,t[3]=0,t):(t[0]=a[0]*.5,t[1]=a[1]*.5,t[2]=a[2]*.5,t[3]=(1+o)*.5,quat.normalize(t,t),t)}}(),quat.lookAt=function(){var e=vec3.create();return function(t,r,s){var a=vec3.dot(vec3.FRONT,r);if(Math.abs(a- -1)<1e-6)return t.set(vec3.UP),t[3]=Math.PI,t;if(Math.abs(a-1)<1e-6)return quat.identity(t);var o=Math.acos(a);return vec3.cross(e,vec3.FRONT,r),vec3.normalize(e,e),quat.setAxisAngle(t,e,o),t}}(),n.Indexer=function(){this.unique=[],this.indices=[],this.map={}},n.Indexer.prototype={add:function(e){var t=JSON.stringify(e);return t in this.map||(this.map[t]=this.unique.length,this.unique.push(e)),this.map[t]}},n.Buffer=function(t,r,s,a,o){n.debug&&console.log("GL.Buffer created"),o!==null&&(o=o||l.gl),this.gl=o,this.buffer=null,this.target=t,this.attribute=null,this.normalize=!1,this.data=r,this.spacing=s||3,this.data&&this.gl&&this.upload(a)},n.Buffer.prototype.bind=function(e,t){t=t||this.gl,t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,this.spacing,this.buffer.gl_type,this.normalize||!1,0,0)},n.Buffer.prototype.unbind=function(e,t){t=t||this.gl,t.disableVertexAttribArray(e)},n.Buffer.prototype.forEach=function(e){for(var t=this.data,r=0,s=this.spacing,a=t.length;r<a;r+=s)e(t.subarray(r,r+s),r);return this},n.Buffer.prototype.applyTransform=function(e){for(var t=this.data,r=0,s=this.spacing,a=t.length;r<a;r+=s){var o=t.subarray(r,r+s);vec3.transformMat4(o,o,e)}return this},n.Buffer.prototype.upload=function(e){var t=this.spacing||3,r=this.gl;if(r){if(!this.data)throw"No data supplied";var s=this.data;if(!s.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||r.createBuffer(),!!this.buffer){switch(this.buffer.length=s.length,this.buffer.spacing=t,s.constructor){case Int8Array:this.buffer.gl_type=r.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=r.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=r.SHORT;break;case Uint16Array:this.buffer.gl_type=r.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=r.INT;break;case Uint32Array:this.buffer.gl_type=r.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=r.FLOAT;break;default:throw"unsupported buffer type"}this.target==r.ARRAY_BUFFER&&(this.buffer.gl_type==r.INT||this.buffer.gl_type==r.UNSIGNED_INT)&&(console.warn("WebGL does not support UINT32 or INT32 as vertex buffer types, converting to FLOAT"),this.buffer.gl_type=r.FLOAT,s=new Float32Array(s)),r.bindBuffer(this.target,this.buffer),r.bufferData(this.target,s,e||this.stream_type||r.STATIC_DRAW)}}},n.Buffer.prototype.compile=n.Buffer.prototype.upload,n.Buffer.prototype.setData=function(e,t){if(!e.buffer)throw"Data must be typed array";if(t=t||0,this.data){if(this.data.length<e.length)throw"buffer is not big enough, you cannot set data to a smaller buffer"}else{this.data=e,this.upload();return}if(this.data!=e){if(this.data.length==e.length){this.data.set(e),this.upload();return}var r=new Uint8Array(e.buffer,e.buffer.byteOffset,e.buffer.byteLength),s=new Uint8Array(this.data.buffer);s.set(r,t),this.uploadRange(t,r.length)}},n.Buffer.prototype.uploadRange=function(e,t){if(!this.data)throw"No data stored in this buffer";var r=this.data;if(!r.buffer)throw"Buffers must be typed arrays";var s=new Uint8Array(this.data.buffer,e,t),a=this.gl;a.bindBuffer(this.target,this.buffer),a.bufferSubData(this.target,e,s)},n.Buffer.prototype.clone=function(e){var t=new n.Buffer;if(e)for(var r in this)t[r]=this[r];else this.target&&(t.target=this.target),this.gl&&(t.gl=this.gl),this.spacing&&(t.spacing=this.spacing),this.data&&(t.data=new l[this.data.constructor](this.data),t.upload());return t},n.Buffer.prototype.toJSON=function(){return this.data?{data_type:getClassName(this.data),data:this.data.toJSON(),target:this.target,attribute:this.attribute,spacing:this.spacing}:(console.error("cannot serialize a mesh without data"),null)},n.Buffer.prototype.fromJSON=function(e){var t=l[e.data_type]||Float32Array;this.data=new t(e.data),this.target=e.target,this.spacing=e.spacing||3,this.attribute=e.attribute,this.upload(n.STATIC_DRAW)},n.Buffer.prototype.delete=function(){var e=this.gl;e.deleteBuffer(this.buffer),this.buffer=null},l.Mesh=n.Mesh=function(t,r,s,a){if(n.debug&&console.log("GL.Mesh created"),a!==null&&(a=a||l.gl,this.gl=a),this._context_id=a.context_id,this.vertexBuffers={},this.indexBuffers={},this.info={groups:[]},this._bounding=BBox.create(),(t||r)&&this.addBuffers(t,r,s?s.stream_type:null),s)for(var o in s)this[o]=s[o]},Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal",normalize:!0},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color",normalize:!0},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights",normalize:!0},extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}},Mesh.default_datatype=Float32Array,Object.defineProperty(Mesh.prototype,"bounding",{set:function(e){if(e){if(e.length<13)throw"Bounding must use the BBox bounding format of 13 floats: center, halfsize, min, max, radius";this._bounding.set(e)}},get:function(){return this._bounding}}),Mesh.prototype.addBuffer=function(e,t){if(t.target==gl.ARRAY_BUFFER?this.vertexBuffers[e]=t:this.indexBuffers[e]=t,!t.attribute){var r=n.Mesh.common_buffers[e];r&&(t.attribute=r.attribute)}},Mesh.prototype.addBuffers=function(e,t,r){var s=0;this.vertexBuffers.vertices&&(s=this.vertexBuffers.vertices.data.length/3);for(var a in e){var o=e[a];if(o){if(o.constructor==n.Buffer||o.data)o=o.data;else if(typeof o[0]!="number"){for(var h=[],f=0,p=1e4;f<o.length;f+=p)h=Array.prototype.concat.apply(h,o.slice(f,f+p));o=h}var T=n.Mesh.common_buffers[a];if(o.constructor===Array){var _=n.Mesh.default_datatype;T&&T.type&&(_=T.type),o=new _(o)}a=="vertices"&&(s=o.length/3);var S=o.length/s;T&&T.spacing&&(S=T.spacing);var b="a_"+a;T&&T.attribute&&(b=T.attribute),this.vertexBuffers[a]?this.updateVertexBuffer(a,b,S,o,r):this.createVertexBuffer(a,b,S,o,r)}}if(t)for(var a in t){var o=t[a];if(o){if((o.constructor==n.Buffer||o.data)&&(o=o.data),typeof o[0]!="number"){h=[];for(var a=0,p=1e4;a<o.length;a+=p)h=Array.prototype.concat.apply(h,o.slice(a,a+p));o=h}if(o.constructor===Array){var _=Uint16Array;s>256*256&&(_=Uint32Array),o=new _(o)}this.createIndexBuffer(a,o)}}},Mesh.prototype.createVertexBuffer=function(e,t,r,s,a){var o=n.Mesh.common_buffers[e];if(!t&&o&&(t=o.attribute),!t)throw"Buffer added to mesh without attribute name";if(!r&&o&&(o&&o.spacing?r=o.spacing:r=3),!s){var h=this.getNumVertices();if(!h)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";s=new n.Mesh.default_datatype(h*r)}if(!s.buffer)throw"Buffer data MUST be typed array";var f=this.vertexBuffers[e]=new n.Buffer(gl.ARRAY_BUFFER,s,r,a,this.gl);return f.name=e,f.attribute=t,(s.constructor==Uint8Array||s.constructor==Int8Array||s.constructor==Uint16Array||s.constructor==Int16Array||s.constructor==Uint32Array||s.constructor==Int32Array)&&o&&o.normalize&&(f.normalize=!0),f},Mesh.prototype.updateVertexBuffer=function(e,t,r,s,a){var o=this.vertexBuffers[e];if(!o){console.log("buffer not found: ",e);return}s.length&&(o.attribute=t,o.spacing=r,o.data=s,o.upload(a))},Mesh.prototype.removeVertexBuffer=function(e,t){var r=this.vertexBuffers[e];r&&(t&&r.delete(),delete this.vertexBuffers[e])},Mesh.prototype.getVertexBuffer=function(e){return this.vertexBuffers[e]},Mesh.prototype.createIndexBuffer=function(e,t,r){if(t.constructor===Array){var s=Uint16Array,a=this.vertexBuffers.vertices;if(a){var o=a.data.length/3;o>256*256&&(s=Uint32Array),t=new s(t)}}var h=this.indexBuffers[e]=new n.Buffer(gl.ELEMENT_ARRAY_BUFFER,t,0,r,this.gl);return h},Mesh.prototype.getBuffer=function(e){return this.vertexBuffers[e]},Mesh.prototype.getIndexBuffer=function(e){return this.indexBuffers[e]},Mesh.prototype.removeIndexBuffer=function(e,t){var r=this.indexBuffers[e];r&&(t&&r.delete(),delete this.indexBuffers[e])},Mesh.prototype.upload=function(e){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t];r.upload(e)}for(var s in this.indexBuffers){var r=this.indexBuffers[s];r.upload()}},Mesh.prototype.compile=Mesh.prototype.upload,Mesh.prototype.deleteBuffers=function(){for(var e in this.vertexBuffers){var t=this.vertexBuffers[e];t.delete()}this.vertexBuffers={};for(var e in this.indexBuffers){var t=this.indexBuffers[e];t.delete()}this.indexBuffers={}},Mesh.prototype.delete=Mesh.prototype.deleteBuffers,Mesh.prototype.bindBuffers=function(e){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t],s=r.attribute||t,a=e.attributes[s];a==null||!r.buffer||(gl.bindBuffer(gl.ARRAY_BUFFER,r.buffer),gl.enableVertexAttribArray(a),gl.vertexAttribPointer(a,r.buffer.spacing,r.buffer.gl_type,r.normalize||!1,0,0))}},Mesh.prototype.unbindBuffers=function(e){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t],s=r.attribute||t,a=e.attributes[s];a==null||!r.buffer||gl.disableVertexAttribArray(e.attributes[s])}},Mesh.prototype.clone=function(t){var t=t||l.gl,r={},s={};for(var a in this.vertexBuffers){var o=this.vertexBuffers[a];r[a]=new o.data.constructor(o.data)}for(var a in this.indexBuffers){var o=this.indexBuffers[a];s[a]=new o.data.constructor(o.data)}return new n.Mesh(r,s,void 0,t)},Mesh.prototype.cloneShared=function(t){var t=t||l.gl;return new n.Mesh(this.vertexBuffers,this.indexBuffers,void 0,t)},Mesh.prototype.toObject=function(){var e={},t={};for(var r in this.vertexBuffers){var s=this.vertexBuffers[r];e[r]={spacing:s.spacing,data:new s.data.constructor(s.data)}}for(var r in this.indexBuffers){var s=this.indexBuffers[r];t[r]={data:new s.data.constructor(s.data)}}return{vertexBuffers:e,indexBuffers:t,info:this.info?cloneObject(this.info):null,bounding:this._bounding.toJSON()}},Mesh.prototype.toJSON=function(){var e={vertexBuffers:{},indexBuffers:{},info:this.info?cloneObject(this.info):null,bounding:this._bounding.toJSON()};for(var t in this.vertexBuffers)e.vertexBuffers[t]=this.vertexBuffers[t].toJSON();for(var t in this.indexBuffers)e.indexBuffers[t]=this.indexBuffers[t].toJSON();return e},Mesh.prototype.fromJSON=function(e){this.vertexBuffers={},this.indexBuffers={};for(var t in e.vertexBuffers)if(e.vertexBuffers[t]){var r=new n.Buffer;r.fromJSON(e.vertexBuffers[t]),!r.attribute&&n.Mesh.common_buffers[t]&&(r.attribute=n.Mesh.common_buffers[t].attribute),this.vertexBuffers[t]=r}for(var t in e.indexBuffers)if(e.indexBuffers[t]){var r=new n.Buffer;r.fromJSON(e.indexBuffers[t]),this.indexBuffers[t]=r}e.info&&(this.info=cloneObject(e.info)),e.bounding&&(this.bounding=e.bounding)},Mesh.prototype.generateMetadata=function(){var e={},t=this.vertexBuffers.vertices.data,r=this.indexBuffers.triangles.data;e.vertices=t.length/3,r?e.faces=r.length/3:e.faces=t.length/9,e.indexed=!!this.metadata.faces,this.metadata=e},Mesh.prototype.computeWireframe=function(){var e=this.indexBuffers.triangles,t=this.vertexBuffers.vertices.data,r=t.length/3;if(e){for(var h=e.data,f=new n.Indexer,o=0;o<h.length;o+=3)for(var p=h.subarray(o,o+3),T=0;T<p.length;T++){var _=p[T],S=p[(T+1)%p.length];f.add([Math.min(_,S),Math.max(_,S)])}for(var b=f.unique,a=r>256*256?new Uint32Array(b.length*2):new Uint16Array(b.length*2),o=0,M=b.length;o<M;++o)a.set(b[o],o*2)}else for(var s=r/3,a=r>256*256?new Uint32Array(s*6):new Uint16Array(s*6),o=0;o<r;o+=3)a[o*2]=o,a[o*2+1]=o+1,a[o*2+2]=o+1,a[o*2+3]=o+2,a[o*2+4]=o+2,a[o*2+5]=o;return this.createIndexBuffer("wireframe",a),this},Mesh.prototype.flipNormals=function(e){var t=this.vertexBuffers.normals;if(t){for(var a=t.data,o=a.length,r=0;r<o;++r)a[r]*=-1;t.upload(e),this.indexBuffers.triangles||this.computeIndices();for(var s=this.indexBuffers.triangles,a=s.data,o=a.length,r=0;r<o;r+=3){var h=a[r];a[r]=a[r+1],a[r+1]=h}s.upload(e)}},Mesh.prototype.computeIndices=function(){var e=[],t=[],r=[],s=[],a=this.vertexBuffers.vertices,o=this.vertexBuffers.normals,h=this.vertexBuffers.coords,f=a.data,p=null;o&&(p=o.data);var T=null;h&&(T=h.data);for(var _={},S=f.length/3,b=0;b<S;++b){var M=f.subarray(b*3,(b+1)*3),G=M[0]*1e3|0,O=0,B=_[G];if(B)for(var H=B.length;O<H;O++){var z=e[B[O]];if(vec3.sqrDist(M,z)<.01){s.push(O);break}}if(!(B&&O!=H)){var k=O;e.push(M),_[G]?_[G].push(k):_[G]=[k],p&&t.push(p.subarray(b*3,(b+1)*3)),T&&r.push(T.subarray(b*2,(b+1)*2)),s.push(k)}}this.vertexBuffers={},this.createVertexBuffer("vertices",n.Mesh.common_buffers.vertices.attribute,3,A(e)),p&&this.createVertexBuffer("normals",n.Mesh.common_buffers.normals.attribute,3,A(t)),T&&this.createVertexBuffer("coords",n.Mesh.common_buffers.coords.attribute,2,A(r)),this.createIndexBuffer("triangles",s)},Mesh.prototype.explodeIndices=function(e){e=e||"triangles";var t=this.getIndexBuffer(e);if(t){var r=t.data,s={};for(var a in this.vertexBuffers){var o=n.Mesh.common_buffers[a];s[a]=new(o.type||Float32Array)(o.spacing*r.length)}for(var a=0,h=r.length;a<h;++a){var f=r[a];for(var p in this.vertexBuffers){var T=this.vertexBuffers[p],o=n.Mesh.common_buffers[p],_=T.spacing||o.spacing,S=s[p];S.set(T.data.subarray(f*_,f*_+_),a*_)}}for(var a in s){var b=this.vertexBuffers[a];this.createVertexBuffer(a,b.attribute,b.spacing,s[a])}delete this.indexBuffers[e]}},Mesh.prototype.computeNormals=function(e){var t=this.vertexBuffers.vertices;if(!t)return console.error("Cannot compute normals of a mesh without vertices");var r=this.vertexBuffers.vertices.data;r.length/3;var s=new Float32Array(r.length),a=null;this.indexBuffers.triangles&&(a=this.indexBuffers.triangles.data);for(var o=n.temp_vec3,h=n.temp2_vec3,f,p,T,_,S,b,M,G,O,B=a?a.length:r.length,H=0;H<B;H+=3)a?(f=a[H],p=a[H+1],T=a[H+2],_=r.subarray(f*3,f*3+3),S=r.subarray(p*3,p*3+3),b=r.subarray(T*3,T*3+3),M=s.subarray(f*3,f*3+3),G=s.subarray(p*3,p*3+3),O=s.subarray(T*3,T*3+3)):(_=r.subarray(H*3,H*3+3),S=r.subarray(H*3+3,H*3+6),b=r.subarray(H*3+6,H*3+9),M=s.subarray(H*3,H*3+3),G=s.subarray(H*3+3,H*3+6),O=s.subarray(H*3+6,H*3+9)),vec3.sub(o,S,_),vec3.sub(h,b,_),vec3.cross(o,o,h),vec3.normalize(o,o),vec3.add(M,M,o),vec3.add(G,G,o),vec3.add(O,O,o);if(a)for(var H=0,B=s.length;H<B;H+=3){var z=s.subarray(H,H+3);vec3.normalize(z,z)}var k=this.vertexBuffers.normals;if(k)k.data=s,k.upload(e);else return this.createVertexBuffer("normals",n.Mesh.common_buffers.normals.attribute,3,s);return k},Mesh.prototype.computeTangents=function(){var e=this.vertexBuffers.vertices;if(!e)return console.error("Cannot compute tangents of a mesh without vertices");var t=this.vertexBuffers.normals;if(!t)return console.error("Cannot compute tangents of a mesh without normals");var r=this.vertexBuffers.coords;if(!r)return console.error("Cannot compute tangents of a mesh without uvs");var s=this.indexBuffers.triangles;if(!s)return console.error("Cannot compute tangents of a mesh without indices");var a=e.data,o=t.data,h=r.data,f=s.data;if(!(!a||!o||!h)){var p=a.length/3,T=new Float32Array(p*4),_=new Float32Array(p*3*2),S=_.subarray(p*3),b,M,G=vec3.create(),O=vec3.create(),B=vec3.create(),H=vec3.create();for(b=0,M=f.length;b<M;b+=3){var z=f[b],k=f[b+1],X=f[b+2],Q=a.subarray(z*3,z*3+3),te=a.subarray(k*3,k*3+3),D=a.subarray(X*3,X*3+3),J=h.subarray(z*2,z*2+2),ee=h.subarray(k*2,k*2+2),Y=h.subarray(X*2,X*2+2),$=te[0]-Q[0],W=D[0]-Q[0],ie=te[1]-Q[1],K=D[1]-Q[1],se=te[2]-Q[2],le=D[2]-Q[2],ue=ee[0]-J[0],he=Y[0]-J[0],ve=ee[1]-J[1],I=Y[1]-J[1],V,Z=ue*I-he*ve;Math.abs(Z)<1e-9?V=0:V=1/Z,vec3.copy(G,[(I*$-ve*W)*V,(I*ie-ve*K)*V,(I*se-ve*le)*V]),vec3.copy(O,[(ue*W-he*$)*V,(ue*K-he*ie)*V,(ue*le-he*se)*V]),vec3.add(_.subarray(z*3,z*3+3),_.subarray(z*3,z*3+3),G),vec3.add(_.subarray(k*3,k*3+3),_.subarray(k*3,k*3+3),G),vec3.add(_.subarray(X*3,X*3+3),_.subarray(X*3,X*3+3),G),vec3.add(S.subarray(z*3,z*3+3),S.subarray(z*3,z*3+3),O),vec3.add(S.subarray(k*3,k*3+3),S.subarray(k*3,k*3+3),O),vec3.add(S.subarray(X*3,X*3+3),S.subarray(X*3,X*3+3),O)}for(b=0,M=a.length;b<M;b+=3){var j=o.subarray(b,b+3),re=_.subarray(b,b+3);vec3.subtract(B,re,vec3.scale(B,j,vec3.dot(j,re))),vec3.normalize(B,B);var ae=vec3.dot(vec3.cross(H,j,re),S.subarray(b,b+3))<0?-1:1;T.set([B[0],B[1],B[2],ae],b/3*4)}this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,T)}},Mesh.prototype.computeTextureCoordinates=function(e){var t=this.vertexBuffers.vertices;if(!t)return console.error("Cannot compute uvs of a mesh without vertices");this.explodeIndices("triangles");var r=t.data,s=r.length/3,a=this.vertexBuffers.coords,o=new Float32Array(s*2),h=this.indexBuffers.triangles,f=null;h&&(f=h.data);var p=vec3.create(),T=vec3.create(),_=vec3.create(),S=this.getBoundingBox(),b=BBox.getCenter(S),M=vec3.create();M.set(BBox.getHalfsize(S)),vec3.scale(M,M,2);for(var G=f?f.length:r.length/3,O=0;O<G;O+=3){if(f)var B=f[O],H=f[O+1],z=f[O+2],k=r.subarray(B*3,B*3+3),X=r.subarray(H*3,H*3+3),Q=r.subarray(z*3,z*3+3),te=o.subarray(B*2,B*2+2),D=o.subarray(H*2,H*2+2),J=o.subarray(z*2,z*2+2);else var k=r.subarray(O*3,O*3+3),X=r.subarray((O+1)*3,(O+1)*3+3),Q=r.subarray((O+2)*3,(O+2)*3+3),te=o.subarray(O*2,O*2+2),D=o.subarray((O+1)*2,(O+1)*2+2),J=o.subarray((O+2)*2,(O+2)*2+2);vec3.sub(T,k,X),vec3.sub(_,k,Q),vec3.cross(p,T,_),p[0]=Math.abs(p[0]),p[1]=Math.abs(p[1]),p[2]=Math.abs(p[2]),p[0]>p[1]&&p[0]>p[2]?(te[0]=(k[2]-b[2])/M[2],te[1]=(k[1]-b[1])/M[1],D[0]=(X[2]-b[2])/M[2],D[1]=(X[1]-b[1])/M[1],J[0]=(Q[2]-b[2])/M[2],J[1]=(Q[1]-b[1])/M[1]):p[1]>p[2]?(te[0]=(k[0]-b[0])/M[0],te[1]=(k[2]-b[2])/M[2],D[0]=(X[0]-b[0])/M[0],D[1]=(X[2]-b[2])/M[2],J[0]=(Q[0]-b[0])/M[0],J[1]=(Q[2]-b[2])/M[2]):(te[0]=(k[0]-b[0])/M[0],te[1]=(k[1]-b[1])/M[1],D[0]=(X[0]-b[0])/M[0],D[1]=(X[1]-b[1])/M[1],J[0]=(Q[0]-b[0])/M[0],J[1]=(Q[1]-b[1])/M[1])}a?(a.data=o,a.upload(e)):this.createVertexBuffer("coords",Mesh.common_buffers.coords.attribute,2,o)},Mesh.prototype.getNumVertices=function(){var e=this.vertexBuffers.vertices;return e?e.data.length/e.spacing:0},Mesh.prototype.getNumTriangles=function(){var e=this.getIndexBuffer("triangles");return e?e.data.length/3:this.getNumVertices()/3},Mesh.computeBoundingBox=function(e,t,r){if(e){var s=0;if(r){for(var a=0;a<r.length;++a)if(r[a]){s=a;break}if(s==r.length){console.warn("mask contains only zeros, no vertices marked");return}}for(var o=vec3.clone(e.subarray(s*3,s*3+3)),h=vec3.clone(e.subarray(s*3,s*3+3)),f,a=s*3;a<e.length;a+=3)r&&!r[a/3]||(f=e.subarray(a,a+3),vec3.min(o,f,o),vec3.max(h,f,h));(isNaN(o[0])||isNaN(o[1])||isNaN(o[2])||isNaN(h[0])||isNaN(h[1])||isNaN(h[2]))&&(o[0]=o[1]=o[2]=0,h[0]=h[1]=h[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices"));var p=vec3.add(vec3.create(),o,h);vec3.scale(p,p,.5);var T=vec3.subtract(vec3.create(),h,p);return BBox.setCenterHalfsize(t||BBox.create(),p,T)}},Mesh.prototype.getBoundingBox=function(){return this._bounding?this._bounding:(this.updateBoundingBox(),this._bounding)},Mesh.prototype.updateBoundingBox=function(){var e=this.vertexBuffers.vertices;e&&(n.Mesh.computeBoundingBox(e.data,this._bounding),this.info&&this.info.groups&&this.info.groups.length&&this.computeGroupsBoundingBoxes())},Mesh.prototype.computeGroupsBoundingBoxes=function(){var e=null,t=this.getIndexBuffer("triangles");t&&(e=t.data);var r=this.getVertexBuffer("vertices");if(!r)return!1;var s=r.data;if(!s.length)return!1;var a=this.info.groups;if(a){for(var o=0;o<a.length;++o){var h=a[o];h.bounding=h.bounding||BBox.create();var f=null;if(e){for(var p=new Uint8Array(s.length/3),T=h.start,_=0,S=h.length;_<S;_+=3)p[e[T+_]]=1,p[e[T+_+1]]=1,p[e[T+_+2]]=1;n.Mesh.computeBoundingBox(s,h.bounding,p)}else f=s.subarray(h.start*3,(h.start+h.length)*3),n.Mesh.computeBoundingBox(f,h.bounding)}return!0}},Mesh.prototype.setBoundingBox=function(e,t){BBox.setCenterHalfsize(this._bounding,e,t)},Mesh.prototype.freeData=function(){for(var e in this.vertexBuffers)this.vertexBuffers[e].data=null,delete this[this.vertexBuffers[e].name];for(var t in this.indexBuffers)this.indexBuffers[t].data=null,delete this[this.indexBuffers[t].name]},Mesh.prototype.configure=function(e,t){var r={},s={};t=t||{};for(var a in e)if(e[a]){if(a=="vertexBuffers"||a=="vertex_buffers"){for(o in e[a])r[o]=e[a][o];continue}if(a=="indexBuffers"||a=="index_buffers"){for(o in e[a])s[o]=e[a][o];continue}a=="indices"||a=="lines"||a=="wireframe"||a=="triangles"?s[a]=e[a]:n.Mesh.common_buffers[a]?r[a]=e[a]:t[a]=e[a]}this.addBuffers(r,s,t.stream_type);for(var o in t)this[o]=t[o];t.bounding||this.updateBoundingBox()},Mesh.prototype.totalMemory=function(){var e=0;for(var t in this.vertexBuffers)e+=this.vertexBuffers[t].data.buffer.byteLength;for(var t in this.indexBuffers)e+=this.indexBuffers[t].data.buffer.byteLength;return e},Mesh.prototype.slice=function(e,t){var r={},s=this.indexBuffers.triangles;if(!s)return console.warn("splice in not indexed not supported yet"),null;var a=s.data,o=[],h=new Int32Array(a.length);h.fill(-1);var f=e+t;f>=a.length&&(f=a.length);for(var p=0,T=e;T<f;++T){var _=a[T];if(h[_]!=-1){o.push(h[_]);continue}var S=p++;h[_]=S,o.push(S);for(var b in this.vertexBuffers){var M=this.vertexBuffers[b],G=M.data,O=M.spacing;r[b]||(r[b]=[]);for(var B=r[b],H=0;H<O;++H)B.push(G[H+_*O])}}var z=new n.Mesh(r,{triangles:o},null,gl);return z.updateBoundingBox(),z},Mesh.prototype.simplify=function(){var e=this.getBoundingBox(),t=BBox.getMin(e),r=BBox.getHalfsize(e),s=vec3.scale(vec3.create(),r,2),a=new n.Mesh,o=vec3.create();for(var h in this.vertexBuffers){var f=this.vertexBuffers[h],p=f.data,T=new Float32Array(p.length);if(h=="vertices")for(var _=0,S=p.length;_<S;_+=3){var b=p.subarray(_,_+3);vec3.sub(o,b,t),vec3.div(o,o,s),o[0]=Math.round(o[0]*256)/256,o[1]=Math.round(o[1]*256)/256,o[2]=Math.round(o[2]*256)/256,vec3.mul(o,o,s),vec3.add(o,o,t),T.set(o,_)}a.addBuffer()}},Mesh.load=function(e,t,r,s){t=t||{},t.no_gl&&(s=null);var a=r||new n.Mesh(null,null,null,s);return a.configure(e,t),a},Mesh.mergeMeshes=function(e,t){t=t||{};for(var r={},s={},a={},o=[],h=0,f=[],p=[],T={},_=0;_<e.length;++_){var S=e[_],b=S.mesh,M=h;o.push(M);var G=b.vertexBuffers.vertices.data.length/3;h+=G;for(var O in b.vertexBuffers)r[O]?r[O]+=b.vertexBuffers[O].data.length:r[O]=b.vertexBuffers[O].data.length;for(var O in b.indexBuffers)s[O]?s[O]+=b.indexBuffers[O].data.length:s[O]=b.indexBuffers[O].data.length;var B={name:"mesh_"+_,start:M,length:G,material:""};if(b.bones){for(var H={},O=0;O<b.bones.length;++O){var z=b.bones[O];T[z[0]]||(T[z[0]]=p.length,p.push(z)),H[O]=T[z[0]]}for(var k=b.vertexBuffers.bone_indices.data,O=0;O<k.length;O+=1)k[O]=H[k[O]]}else if(p.length)throw"cannot merge meshes, one contains bones, the other doesnt";f.push(B)}for(var O in r){var X=t[O];if(X===null){delete r[O];continue}if(!X){var Q=b.vertexBuffers[O];Q&&(Q.data&&(Q=Q.data),Q.constructor!==Array&&(X=Q.constructor)),X||(X=Float32Array)}r[O]=new X(r[O]),a[O]=0}for(var O in s){var X=h<65536?Uint16Array:Uint32Array;s[O]=new X(s[O]),a[O]=0}for(var _=0;_<e.length;++_){var S=e[_],b=S.mesh,M=0,G=0;for(var O in b.vertexBuffers)if(r[O]){if(O=="vertices"&&(G=b.vertexBuffers[O].data.length/3),r[O].set(b.vertexBuffers[O].data,a[O]),S[O+"_matrix"]){var te=S[O+"_matrix"];te.length==16?D(r[O],a[O],b.vertexBuffers[O].data.length,te):te.length==9&&J(r[O],a[O],b.vertexBuffers[O].data.length,te)}a[O]+=b.vertexBuffers[O].data.length}for(var O in b.indexBuffers)s[O].set(b.indexBuffers[O].data,a[O]),ee(s[O],a[O],b.indexBuffers[O].data.length,o[_]),a[O]+=b.indexBuffers[O].data.length}function D($,W,ie,K){for(var se=W+ie,le=W;le<se;le+=3){var ue=$.subarray(le,le+3);vec3.transformMat4(ue,ue,K)}}function J($,W,ie,K){for(var se=W+ie,le=W;le<se;le+=2){var ue=$.subarray(le,le+2);vec2.transformMat3(ue,ue,K)}}function ee($,W,ie,K){if(K)for(var se=W+ie,le=W;le<se;++le)$[le]+=K}var Y={info:{groups:f}};if(p.length&&(Y.bones=p),typeof gl<"u"||t.only_data){var b=new n.Mesh(r,s,Y);return b.updateBoundingBox(),b}return{vertexBuffers:r,indexBuffers:s,info:{groups:f}}},Mesh.parsers={},Mesh.encoders={},Mesh.binary_file_formats={},Mesh.compressors={},Mesh.decompressors={},Mesh.fromURL=function(e,t,r,s){s=s||{},r=r||l.gl;var a=e.lastIndexOf("."),o=e.substr(a+1).toLowerCase();s.extension&&(o=s.extension);var h=n.Mesh.parsers[o.toLowerCase()];if(!h)return console.error("No parser available in litegl to parse mesh of type",o),null;var f=new n.Mesh(void 0,void 0,void 0,r);return f.ready=!1,s.binary=Mesh.binary_file_formats[o],HttpRequest(e,null,function(p){f.parse(p,o,s),delete f.ready,t&&t.call(f,f,e,s)},function(p){t&&t(null)},s),f},Mesh.prototype.parse=function(e,t,r){r=r||{},r.mesh=this,t=t.toLowerCase();var s=n.Mesh.parsers[t];if(s)return s.call(null,e,r);throw"GL.Mesh.parse: no parser found for format "+t},Mesh.prototype.encode=function(e,t){e=e.toLowerCase();var r=n.Mesh.encoders[e];if(r)return r.call(null,this,t);throw"GL.Mesh.encode: no encoder found for format "+e},Mesh.getScreenQuad=function(e){e=e||l.gl;var t=e.meshes[":screen_quad"];if(t)return t;var r=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]),s=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]);return t=new n.Mesh({vertices:r,coords:s},void 0,void 0,e),e.meshes[":screen_quad"]=t};function A(e,t){if(e.constructor===t)return e;if(e.constructor!==Array)return t=t||Float32Array,new t(e);t=t||Float32Array;for(var r=e[0].length,s=e.length*r,a=new t(s),o=0;o<e.length;++o)for(var h=0;h<r;++h)a[o*r+h]=e[o][h];return a}n.linearizeArray=A,n.Mesh.EXTENSION="wbin",n.Mesh.enable_wbin_compression=!0;function N(e,t,r,s,a){e=e||1024,n.debug&&console.log("GL.Mesh created"),a!==null&&(a=a||l.gl,this.gl=a),this._context_id=a.context_id,this.vertexBuffers={},this.indexBuffers={},this.info={groups:[]},this._bounding=BBox.create(),this.resize(e)}N.DEFAULT_NORMAL=vec3.fromValues(0,1,0),N.DEFAULT_COORD=vec2.fromValues(.5,.5),N.DEFAULT_COLOR=vec4.fromValues(1,1,1,1),N.prototype.resize=function(e){var t={};this._vertex_data=new Float32Array(e*3),t.vertices=this._vertex_data,normals&&(t.normals=this._normal_data=new Float32Array(e*3)),coords&&(t.coords=this._coord_data=new Float32Array(e*2)),colors&&(t.colors=this._color_data=new Float32Array(e*4)),this.addBuffers(t),this.current_pos=0,this.max_size=e,this._must_update=!0},N.prototype.clear=function(){this.current_pos=0},N.prototype.addPoint=function(e,t,r,s){if(a>=this.max_size)return console.warn("DynamicMesh: not enough space, reserve more"),!1;var a=this.current_pos++;return this._vertex_data.set(e,a*3),this._normal_data&&this._normal_data.set(t||N.DEFAULT_NORMAL,a*3),this._coord_data&&this._coord_data.set(r||N.DEFAULT_COORD,a*2),this._color_data&&this._color_data.set(s||N.DEFAULT_COLOR,a*4),this._must_update=!0,!0},N.prototype.update=function(e){return!this._must_update&&!e?this.current_pos:(this._must_update=!1,this.getBuffer("vertices").upload(gl.STREAM_DRAW),this._normal_data&&this.getBuffer("normal").upload(gl.STREAM_DRAW),this._coord_data&&this.getBuffer("coord").upload(gl.STREAM_DRAW),this._color_data&&this.getBuffer("color").upload(gl.STREAM_DRAW),this.current_pos)},extendClass(N,Mesh),Mesh.plane=function(e,t){e=e||{},e.triangles=[];var r=e.detailX||e.detail||1,s=e.detailY||e.detail||1,a=e.width||e.size||1,o=e.height||e.size||1,h=e.xz;a*=.5,o*=.5;var f=[],p=[],T=[],_=[],S=vec3.fromValues(0,0,1);h&&S.set([0,1,0]);for(var b=0;b<=s;b++)for(var M=b/s,G=0;G<=r;G++){var O=G/r;if(h?p.push((2*O-1)*a,0,-(2*M-1)*o):p.push((2*O-1)*a,(2*M-1)*o,0),T.push(O,M),_.push(S[0],S[1],S[2]),G<r&&b<s){var B=G+b*(r+1);h?(f.push(B+1,B+r+1,B),f.push(B+1,B+r+2,B+r+1)):(f.push(B,B+1,B+r+1),f.push(B+r+1,B+1,B+r+2))}}var H=BBox.fromCenterHalfsize([0,0,0],h?[a,0,o]:[a,o,0]),z={vertices:p,normals:_,coords:T,triangles:f};return n.Mesh.load(z,{bounding:H},t)},Mesh.plane2D=function(e,t){var r=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),s=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(e&&e.size)for(var a=e.size*.5,o=0;o<r.length;++o)r[o]*=a;return new n.Mesh({vertices2D:r,coords:s},null,t)},Mesh.point=function(e){return new n.Mesh({vertices:[0,0,0]})},Mesh.cube=function(e,t){e=e||{};var r=(e.size||1)*.5,s={};s.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var a=0,o=s.vertices.length;a<o;++a)s.vertices[a]*=r;return s.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]),s.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]),e.wireframe&&(s.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11])),e.bounding=BBox.fromCenterHalfsize([0,0,0],[r,r,r]),n.Mesh.load(s,e,t)},Mesh.box=function(e,t){e=e||{};var r=e.sizex||1,s=e.sizey||1,a=e.sizez||1;r*=.5,s*=.5,a*=.5;var o={};o.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var h=0,f=o.vertices.length;h<f;h+=3)o.vertices[h]*=r,o.vertices[h+1]*=s,o.vertices[h+2]*=a;return o.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]),o.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]),e.wireframe&&(o.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11])),e.bounding=BBox.fromCenterHalfsize([0,0,0],[r,s,a]),n.Mesh.load(o,e,t)},Mesh.circle=function(e,t){e=e||{};var r=e.size||e.radius||1,s=Math.ceil(e.slices||24),a=e.xz||!1,o=e.empty||!1;s<3&&(s=3);var h=2*Math.PI/s,f=vec3.create(),p=vec3.create(),T=vec3.fromValues(0,0,1),_=vec2.fromValues(.5,.5),S=vec2.create();a&&T.set([0,1,0]);var b=a?2:1,M=new Float32Array(3*(s+1)),G=new Float32Array(3*(s+1)),O=new Float32Array(2*(s+1)),B=null;M.set(f,0),G.set(T,0),O.set(_,0);for(var H=0,z=0,k=0;k<s;++k)H=Math.sin(h*k),z=Math.cos(h*k),p[0]=H*r,p[b]=z*r,S[0]=H*.5+.5,S[1]=z*.5+.5,M.set(p,k*3+3),G.set(T,k*3+3),O.set(S,k*2+2);if(o)M=M.subarray(3),G=M.subarray(3),O=M.subarray(2),B=null;else{var B=new Uint16Array(3*s),X=2,Q=1;a&&(X=1,Q=2);for(var k=0;k<s-1;++k)B[k*3]=0,B[k*3+1]=k+X,B[k*3+2]=k+Q;B[k*3]=0,a?(B[k*3+1]=k+1,B[k*3+2]=1):(B[k*3+1]=1,B[k*3+2]=k+1)}e.bounding=BBox.fromCenterHalfsize([0,0,0],a?[r,0,r]:[r,r,0]);var te={vertices:M,normals:G,coords:O,triangles:B};if(e.wireframe){for(var D=new Uint16Array(s*2),k=0;k<s;k++)D[k*2]=k,D[k*2+1]=k+1;D[0]=s,te.wireframe=D}return n.Mesh.load(te,e,t)},Mesh.ring=function(e,t){e=e||{};var r=e.size||e.radius||1,s=e.thickness||r*.1,a=Math.ceil(e.slices||24),o=e.xz||!1,h=e.empty||!1;a<3&&(a=3);var f=2*Math.PI/a;vec3.create();var p=vec3.create(),T=vec3.create(),_=vec3.fromValues(0,0,1);vec2.fromValues(.5,.5);var S=vec2.create();o&&_.set([0,1,0]);for(var b=o?2:1,M=new Float32Array(3*(a*2+2)),G=new Float32Array(3*(a*2+2)),O=new Float32Array(2*(a*2+2)),B=null,H=0,z=0,k=0;k<=a;++k)H=Math.sin(f*k),z=Math.cos(f*k),p[0]=H*(r-s),p[b]=z*(r-s),S[0]=k/a,S[1]=0,M.set(p,k*6),G.set(_,k*6),O.set(S,k*4),T[0]=H*(r+s),T[b]=z*(r+s),S[1]=1,M.set(T,k*6+3),G.set(_,k*6+3),O.set(S,k*4+2);if(h)M=M.subarray(3),G=M.subarray(3),O=M.subarray(2),B=null;else{var B=new Uint16Array(6*a),X=2,Q=1;o&&(X=1,Q=2);for(var k=0;k<a;++k)B[k*6]=k*2,B[k*6+1]=k*2+X,B[k*6+2]=k*2+Q,B[k*6+3]=k*2+Q,B[k*6+4]=k*2+X,B[k*6+5]=k*2+3}e.bounding=BBox.fromCenterHalfsize([0,0,0],o?[r+s,0,r+s]:[r+s,r+s,0]);var te={vertices:M,normals:G,coords:O,triangles:B};if(e.wireframe){for(var D=new Uint16Array(a*4),k=0;k<a;k++)D[k*4]=k*2,D[k*4+1]=k*2+2,D[k*4+2]=k*2+1,D[k*4+3]=k*2+3;te.wireframe=D}return n.Mesh.load(te,e,t)},Mesh.cylinder=function(e,t){e=e||{};for(var r=e.radius||e.size||1,s=e.height||e.size||2,a=e.subdivisions||64,o=new Float32Array(a*6*3*2),h=new Float32Array(a*6*3*2),f=new Float32Array(a*6*2*2),p=2*Math.PI/a,T=null,_=0;_<a;++_){var S=_*p;T=[Math.sin(S),0,Math.cos(S)],o.set([T[0]*r,s*.5,T[2]*r],_*6*3),h.set(T,_*6*3),f.set([_/a,1],_*6*2),T=[Math.sin(S),0,Math.cos(S)],o.set([T[0]*r,s*-.5,T[2]*r],_*6*3+3),h.set(T,_*6*3+3),f.set([_/a,0],_*6*2+2),T=[Math.sin(S+p),0,Math.cos(S+p)],o.set([T[0]*r,s*-.5,T[2]*r],_*6*3+6),h.set(T,_*6*3+6),f.set([(_+1)/a,0],_*6*2+4),T=[Math.sin(S+p),0,Math.cos(S+p)],o.set([T[0]*r,s*.5,T[2]*r],_*6*3+9),h.set(T,_*6*3+9),f.set([(_+1)/a,1],_*6*2+6),T=[Math.sin(S),0,Math.cos(S)],o.set([T[0]*r,s*.5,T[2]*r],_*6*3+12),h.set(T,_*6*3+12),f.set([_/a,1],_*6*2+8),T=[Math.sin(S+p),0,Math.cos(S+p)],o.set([T[0]*r,s*-.5,T[2]*r],_*6*3+15),h.set(T,_*6*3+15),f.set([(_+1)/a,0],_*6*2+10)}var b=_*6*3,M=_*6*2,G=b;if(e.caps===!1)o=o.subarray(0,b),h=h.subarray(0,b),f=f.subarray(0,M);else for(var O=vec3.fromValues(0,s*.5,0),B=vec3.fromValues(0,s*-.5,0),H=vec3.fromValues(0,1,0),z=vec3.fromValues(0,-1,0),_=0;_<a;++_){var S=_*p,k=vec3.fromValues(Math.sin(S),0,Math.cos(S)),X=vec3.fromValues(Math.sin(S+p),0,Math.cos(S+p));o.set([k[0]*r,s*.5,k[2]*r],b+_*6*3),h.set(H,b+_*6*3),f.set([-k[0]*.5+.5,k[2]*.5+.5],M+_*6*2),o.set([X[0]*r,s*.5,X[2]*r],b+_*6*3+3),h.set(H,b+_*6*3+3),f.set([-X[0]*.5+.5,X[2]*.5+.5],M+_*6*2+2),o.set(O,b+_*6*3+6),h.set(H,b+_*6*3+6),f.set([.5,.5],M+_*6*2+4),o.set([X[0]*r,s*-.5,X[2]*r],b+_*6*3+9),h.set(z,b+_*6*3+9),f.set([X[0]*.5+.5,X[2]*.5+.5],M+_*6*2+6),o.set([k[0]*r,s*-.5,k[2]*r],b+_*6*3+12),h.set(z,b+_*6*3+12),f.set([k[0]*.5+.5,k[2]*.5+.5],M+_*6*2+8),o.set(B,b+_*6*3+15),h.set(z,b+_*6*3+15),f.set([.5,.5],M+_*6*2+10)}var Q={vertices:o,normals:h,coords:f};return e.bounding=BBox.fromCenterHalfsize([0,0,0],[r,s*.5,r]),e.info={groups:[]},e.caps!==!1&&(e.info.groups.push({name:"side",start:0,length:G/3}),e.info.groups.push({name:"caps",start:G/3,length:(o.length-G)/3})),Mesh.load(Q,e,t)},Mesh.cone=function(e,t){e=e||{};for(var r=e.radius||e.size||1,s=e.height||e.size||2,a=e.subdivisions||64,o=new Float32Array(a*3*3*2),h=new Float32Array(a*3*3*2),f=new Float32Array(a*2*3*2),p=2*Math.PI/a,T=null,_=r/s,S=0;S<a;++S){var b=S*p;T=[Math.sin(b+p*.5),_,Math.cos(b+p*.5)],vec3.normalize(T,T),o.set([0,s,0],S*6*3),h.set(T,S*6*3),f.set([S/a,1],S*6*2),T=[Math.sin(b),_,Math.cos(b)],o.set([T[0]*r,0,T[2]*r],S*6*3+3),vec3.normalize(T,T),h.set(T,S*6*3+3),f.set([S/a,0],S*6*2+2),T=[Math.sin(b+p),_,Math.cos(b+p)],o.set([T[0]*r,0,T[2]*r],S*6*3+6),vec3.normalize(T,T),h.set(T,S*6*3+6),f.set([(S+1)/a,0],S*6*2+4)}for(var M=0,G=0,O=vec3.fromValues(0,0,0),B=vec3.fromValues(0,-1,0),S=0;S<a;++S){var b=S*p,H=vec3.fromValues(Math.sin(b),0,Math.cos(b)),z=vec3.fromValues(Math.sin(b+p),0,Math.cos(b+p));o.set([z[0]*r,0,z[2]*r],M+S*6*3+9),h.set(B,M+S*6*3+9),f.set([z[0]*.5+.5,z[2]*.5+.5],G+S*6*2+6),o.set([H[0]*r,0,H[2]*r],M+S*6*3+12),h.set(B,M+S*6*3+12),f.set([H[0]*.5+.5,H[2]*.5+.5],G+S*6*2+8),o.set(O,M+S*6*3+15),h.set(B,M+S*6*3+15),f.set([.5,.5],G+S*6*2+10)}var k={vertices:o,normals:h,coords:f};return e.bounding=BBox.fromCenterHalfsize([0,s*.5,0],[r,s*.5,r]),Mesh.load(k,e,t)},Mesh.torus=function(e,t){e=e||{};var r=e.outerradius||e.radius||1,s=Math.ceil(e.outerslices||e.slices||24),a=e.innerradius||r*.1,o=Math.ceil(e.innerslices||s),h=e.angle||Math.PI*2,f=Math.PI*2/o,p=h/s,T=1;vec3.create();var _=vec3.create(),S=vec3.fromValues(0,0,1);vec2.fromValues(.5,.5);for(var b=vec2.create(),M=h==Math.PI*2,G=new Float32Array(3*o),O=new Float32Array(3*o),X=0,Q=0,B=0;B<o;++B)X=Math.sin(f*B),Q=Math.cos(f*B),_[0]=X*a,_[T]=Q*a,b[0]=X*.5+.5,b[1]=Q*.5+.5,G.set(_,B*3),vec3.normalize(S,_),O.set(S,B*3);var H=new Float32Array(3*s*o),z=new Float32Array(3*s*o),k=new Float32Array(2*s*o),ee=null,X=0,Q=0,te=mat4.create(),D=vec3.fromValues(-r,0,0),J=vec3.fromValues(0,1,0);vec3.create();for(var ee=[],Y=o,B=0;B<s;++B){mat4.identity(te),mat4.rotate(te,te,B*p,J),mat4.translate(te,te,D);var $=B*o,Y=o;B>=s-1&&(Y=(s-1)*-o,M||(Y=0));for(var W=0;W<o;++W){var ie=G.subarray(W*3,W*3+3),K=O.subarray(W*3,W*3+3);mat4.multiplyVec3(_,te,ie),mat4.rotateVec3(S,te,K),H.set(_,W*3+B*3*o),z.set(S,W*3+B*3*o),k.set([B/s,W/o],W*2+B*2*o);var se=$+W,le=$+(W+1)%o;ee.push(le,se,se+Y,le,se+Y,le+Y)}}var ue=a+r;e.bounding=BBox.fromCenterHalfsize([0,0,0],[ue,ue,a]);var he={vertices:H,normals:z,coords:k,triangles:ee};return n.Mesh.load(he,e,t)},Mesh.sphere=function(e,t){e=e||{};for(var r=e.radius||e.size||1,s=e.lat||e.subdivisions||16,a=e.long||e.subdivisions||16,o=new Float32Array((s+1)*(a+1)*3),h=new Float32Array((s+1)*(a+1)*3),f=new Float32Array((s+1)*(a+1)*2),p=new Uint16Array(s*a*6),T=e.hemi?Math.PI*.5:Math.PI,_=0,S=0,b=0;b<=s;b++)for(var M=b*T/s,G=Math.sin(M),O=Math.cos(M),B=0;B<=a;B++){var H=B*2*Math.PI/a,z=Math.sin(H),k=Math.cos(H),X=k*G,Q=O,te=z*G,D=1-B/a,J=1-b/s;o.set([r*X,r*Q,r*te],_),h.set([X,Q,te],_),f.set([D,J],S),_+=3,S+=2}_=0;for(var b=0;b<s;b++)for(var B=0;B<a;B++){var ee=b*(a+1)+B,Y=ee+a+1;p.set([Y,ee,ee+1],_),p.set([Y+1,Y,ee+1],_+3),_+=6}var $={vertices:o,normals:h,coords:f,triangles:p};if(e.wireframe){for(var W=new Uint16Array(a*s*4),ie=0,_=0;_<s;_++){for(var K=0;K<a;K++)W[ie]=_*(a+1)+K,W[ie+1]=_*(a+1)+K+1,ie+=2;W[ie-a*2]=_*(a+1)+K}for(var _=0;_<a;_++)for(var K=0;K<s;K++)W[ie]=K*(a+1)+_,W[ie+1]=(K+1)*(a+1)+_,ie+=2;$.wireframe=W}return e.hemi?e.bounding=BBox.fromCenterHalfsize([0,r*.5,0],[r,r*.5,r],r):e.bounding=BBox.fromCenterHalfsize([0,0,0],[r,r,r],r),n.Mesh.load($,e,t)},Mesh.grid=function(e,t){e=e||{};var r=e.lines||11;r<0&&(r=1);for(var s=e.size||10,a=new Float32Array(r*2*2*3),o=s*.5,h=0,f=-o,p=s/(r-1),T=0;T<r;T++)a[h]=f,a[h+2]=-o,a[h+3]=f,a[h+5]=o,a[h+6]=o,a[h+8]=f,a[h+9]=-o,a[h+11]=f,f+=p,h+=12;return new n.Mesh({vertices:a},e,t)},Mesh.icosahedron=function(e,t){e=e||{};var r=e.radius||e.size||1,s=e.subdivisions===void 0?0:e.subdivisions;s>6&&(s=6);for(var a=(1+Math.sqrt(5))/2,o=[-1,a,0,1,a,0,-1,-a,0,1,-a,0,0,-1,a,0,1,a,0,-1,-a,0,1,-a,a,0,-1,a,0,1,-a,0,-1,-a,0,1],h=[],f=[],p=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],T=o.length,_=0;_<T;_+=3){var S=Math.sqrt(o[_]*o[_]+o[_+1]*o[_+1]+o[_+2]*o[_+2]),b=o[_]/S,M=o[_+1]/S,G=o[_+2]/S;h.push(b,M,G),f.push(Math.atan2(b,G),Math.acos(M)),o[_]*=r/S,o[_+1]*=r/S,o[_+2]*=r/S}var O={};function B(te,D){var J=p[te]<p[D]?p[te]+":"+p[D]:p[D]+":"+p[te],ee=O[J];if(ee)return ee;var Y=o.length/3;o.push((o[p[te]*3]+o[p[D]*3])*.5,(o[p[te]*3+1]+o[p[D]*3+1])*.5,(o[p[te]*3+2]+o[p[D]*3+2])*.5);var $=Math.sqrt(o[Y*3]*o[Y*3]+o[Y*3+1]*o[Y*3+1]+o[Y*3+2]*o[Y*3+2]),W=o[Y*3]/$,ie=o[Y*3+1]/$,K=o[Y*3+2]/$;return h.push(W,ie,K),f.push(Math.atan2(W,K)/Math.PI*.5,Math.acos(ie)/Math.PI),o[Y*3]*=r/$,o[Y*3+1]*=r/$,o[Y*3+2]*=r/$,O[J]=Y,Y}for(var H=0;H<s;++H){for(var z=[],T=p.length,_=0;_<T;_+=3){var k=B(_,_+1),X=B(_+1,_+2),Q=B(_+2,_);z.push(p[_],k,Q),z.push(p[_+1],X,k),z.push(p[_+2],Q,X),z.push(k,X,Q)}p=z}return e.bounding=BBox.fromCenterHalfsize([0,0,0],[r,r,r],r),new n.Mesh.load({vertices:o,coords:f,normals:h,triangles:p},e,t)},Mesh.shape=function(e,t,r){if(t=t||{},typeof earcut>"u")throw"To use GL.Mesh.shape you must download and include earcut.js (do not link it directly!): https://raw.githubusercontent.com/mapbox/earcut/master/src/earcut.js";if(!e||!e.length||e.length%2==1)throw"GL.Mesh.shape line missing, must be an array of 2D vertices";var s=t.extrude||0;e[0].constructor===Array&&(e=earcut.flatten(e));var a=earcut(e).reverse();console.log(a);for(var o=[],h=[],f=[],p=[e[0],e[1]],T=[e[0],e[1]],_=0;_<e.length;_+=2)p[0]=Math.min(p[0],e[_]),p[1]=Math.max(p[1],e[_]),T[0]=Math.min(T[0],e[_+1]),T[1]=Math.max(T[1],e[_+1]);var S=p[1]-p[0],b=T[1]-T[0],M=[],G=null;if(s){G=[];for(var O=vec3.create(),B=e.length,_=0;_<e.length;_+=2){var H=e[_],z=e[_+1],k=e[(_+2)%B],X=e[(_+3)%B],Q=o.length/3;o.push(H,s*.5,z),o.push(H,s*-.5,z),o.push(k,s*.5,X),o.push(k,s*-.5,X),vec3.normalize(O,vec3.cross(O,[0,1,0],[k-H,0,X-z])),h.push(O[0],O[1],O[2],O[0],O[1],O[2],O[0],O[1],O[2],O[0],O[1],O[2]);var te=(H-p[0])/S,D=(z-T[0])/b,J=(k-p[0])/S,ee=(X-T[0])/b;f.push(te,D,te,D,J,ee,J,ee),G.push(Q,Q+2,Q+1,Q+2,Q+3,Q+1)}M.push({name:"side",start:0,length:G.length});for(var Y=o.length/3,$=G.length,_=0;_<e.length;_+=2){var H=e[_],z=e[_+1],te=(H-p[0])/S,D=(z-T[0])/b;o.push(H,s*.5,z),o.push(H,s*-.5,z),h.push(0,1,0,0,-1,0),f.push(te,D,te,D)}for(var _=0;_<a.length;_+=3)G.push(Y+a[_]*2,Y+a[_+1]*2,Y+a[_+2]*2),G.push(Y+a[_]*2+1,Y+a[_+2]*2+1,Y+a[_+1]*2+1);M.push({name:"caps",start:$,length:G.length}),t.bounding=BBox.fromCenterHalfsize([(p[0]+p[1])*.5,0,(T[0]+T[1])*.5],[S*.5,s*.5,b*.5],vec2.len([S*.5,s*.5,b*.5]))}else{for(var _=0;_<e.length;_+=2)o.push(e[_],0,e[_+1]),h.push(0,1,0),f.push((e[_]-p[0])/S,(e[_+1]-T[0])/b);G=a,M.push({name:"side",start:0,length:G.length}),t.bounding=BBox.fromCenterHalfsize([(p[0]+p[1])*.5,0,(T[0]+T[1])*.5],[S*.5,0,b*.5],vec2.len([S*.5,0,b*.5]))}if(t.xy){for(var _=0;_<o.length;_+=3)W(o,_),W(h,_);s?t.bounding=BBox.fromCenterHalfsize([(p[0]+p[1])*.5,(T[0]+T[1])*.5,0],[S*.5,b*.5,s*.5],vec2.len([S*.5,b*.5,s*.5])):t.bounding=BBox.fromCenterHalfsize([(p[0]+p[1])*.5,(T[0]+T[1])*.5,0],[S*.5,b*.5,0],vec2.len([S*.5,b*.5,0]))}return t.info={groups:M},new n.Mesh.load({vertices:o,coords:f,normals:h,triangles:G},t,r);function W(ie,K){var se=ie[K+1];ie[K+1]=ie[K+2],ie[K+2]=-se}},l.Texture=n.Texture=function e(t,r,s,a){if(s=s||{},a=a||l.gl,this.gl=a,this._context_id=a.context_id,t=parseInt(t),r=parseInt(r),n.debug&&console.log("GL.Texture created: ",t,r),this.handler=a.createTexture(),this.width=t,this.height=r,s.depth&&(this.depth=s.depth),this.texture_type=s.texture_type||a.TEXTURE_2D,this.format=s.format||e.DEFAULT_FORMAT,this.internalFormat=s.internalFormat,this.type=s.type||e.DEFAULT_TYPE,this.magFilter=s.magFilter||s.filter||e.DEFAULT_MAG_FILTER,this.minFilter=s.minFilter||s.filter||e.DEFAULT_MIN_FILTER,this.wrapS=s.wrap||s.wrapS||e.DEFAULT_WRAP_S,this.wrapT=s.wrap||s.wrapT||e.DEFAULT_WRAP_T,this.data=null,e.MAX_TEXTURE_IMAGE_UNITS||(e.MAX_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS)),this.has_mipmaps=!1,this.format==a.DEPTH_COMPONENT&&a.webgl_version==1&&!a.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==a.FLOAT&&!a.extensions.OES_texture_float&&a.webgl_version==1)throw"Float Texture not supported";if(this.type==a.HALF_FLOAT_OES){if(!a.extensions.OES_texture_half_float&&a.webgl_version==1)throw"Half Float Texture extension not supported.";a.webgl_version>1&&(console.warn("using HALF_FLOAT_OES in WebGL2 is deprecated, suing HALF_FLOAT instead"),this.type=this.format==a.RGB?a.RGB16F:a.RGBA16F)}if((!isPowerOfTwo(this.width)||!isPowerOfTwo(this.height))&&(this.minFilter!=a.NEAREST&&this.minFilter!=a.LINEAR||this.wrapS!=a.CLAMP_TO_EDGE||this.wrapT!=a.CLAMP_TO_EDGE))if(s.ignore_pot)this.minFilter=this.magFilter=a.LINEAR,this.wrapS=this.wrapT=a.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(!t||!r)return;this.internalFormat||this.computeInternalFormat(),a.activeTexture(a.TEXTURE0+e.MAX_TEXTURE_IMAGE_UNITS-1),a.bindTexture(this.texture_type,this.handler),a.texParameteri(this.texture_type,a.TEXTURE_MAG_FILTER,this.magFilter),a.texParameteri(this.texture_type,a.TEXTURE_MIN_FILTER,this.minFilter),a.texParameteri(this.texture_type,a.TEXTURE_WRAP_S,this.wrapS),a.texParameteri(this.texture_type,a.TEXTURE_WRAP_T,this.wrapT),s.anisotropic&&a.extensions.EXT_texture_filter_anisotropic&&a.texParameterf(n.TEXTURE_2D,a.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,s.anisotropic);var o=this.type,h=s.pixel_data;if(h&&!h.buffer){if(this.texture_type==n.TEXTURE_CUBE_MAP)if(h[0].constructor===Number)h=p(h),h=[h,h,h,h,h,h];else for(var f=0;f<h.length;++f)h[f]=p(h[f]);else h=p(h);this.data=h}function p(S){return S.constructor!==Array?S:o==n.FLOAT?new Float32Array(S):o==n.HALF_FLOAT_OES?new Uint16Array(S):new Uint8Array(S)}if(e.setUploadOptions(s),this.texture_type==n.TEXTURE_2D)a.texImage2D(n.TEXTURE_2D,0,this.internalFormat,t,r,0,this.format,this.type,h||null),n.isPowerOfTwo(t)&&n.isPowerOfTwo(r)&&s.minFilter&&s.minFilter!=a.NEAREST&&s.minFilter!=a.LINEAR&&(a.generateMipmap(this.texture_type),this.has_mipmaps=!0);else if(this.texture_type==n.TEXTURE_CUBE_MAP)for(var T=t*t*(this.format==n.RGBA?4:3),f=0;f<6;++f){var _=h;_&&(_.constructor===Array?_=_[f]:_.subarray(T*f,T*(f+1))),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,this.internalFormat,this.width,this.height,0,this.format,this.type,_||null)}else if(this.texture_type==n.TEXTURE_3D){if(this.gl.webgl_version==1)throw"TEXTURE_3D not supported in WebGL 1. Enable WebGL 2 in the context by passing webgl2:true to the context";if(!s.depth)throw"3d texture depth must be set in the options.depth";a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.texImage3D(n.TEXTURE_3D,0,this.internalFormat,t,r,s.depth,0,this.format,this.type,h||null)}a.bindTexture(this.texture_type,null),a.activeTexture(a.TEXTURE0)},Texture.DEFAULT_TYPE=n.UNSIGNED_BYTE,Texture.DEFAULT_FORMAT=n.RGBA,Texture.DEFAULT_MAG_FILTER=n.LINEAR,Texture.DEFAULT_MIN_FILTER=n.LINEAR,Texture.DEFAULT_WRAP_S=n.CLAMP_TO_EDGE,Texture.DEFAULT_WRAP_T=n.CLAMP_TO_EDGE,Texture.EXTENSION="png",Texture.framebuffer=null,Texture.renderbuffer=null,Texture.loading_color=new Uint8Array([0,0,0,0]),Texture.use_renderbuffer_pool=!0,Texture.CROSS_ORIGIN_CREDENTIALS="Anonymous",Texture.prototype.computeInternalFormat=function(){if(this.internalFormat=this.format,this.format==n.DEPTH_COMPONENT){if(this.minFilter=n.NEAREST,gl.webgl_version==2)if(this.type==n.UNSIGNED_SHORT)this.internalFormat=n.DEPTH_COMPONENT16;else if(this.type==n.UNSIGNED_INT)this.internalFormat=n.DEPTH_COMPONENT24;else if(this.type==n.FLOAT)this.internalFormat=n.DEPTH_COMPONENT32F;else throw"unsupported type for a depth texture";else if(gl.webgl_version==1){if(this.type==n.FLOAT)throw"WebGL 1.0 does not support float depth textures";this.internalFormat=n.DEPTH_COMPONENT}}else this.format==gl.RGBA&&(gl.webgl_version==2?this.type==n.FLOAT?this.internalFormat=n.RGBA32F:this.type==n.HALF_FLOAT?this.internalFormat=n.RGBA16F:this.type==n.HALF_FLOAT_OES&&(console.warn("webgl 2 does not use HALF_FLOAT_OES, converting to HALF_FLOAT"),this.type=n.HALF_FLOAT,this.internalFormat=n.RGBA16F):gl.webgl_version==1&&this.type==n.HALF_FLOAT&&(console.warn("webgl 1 does not use HALF_FLOAT, converting to HALF_FLOAT_OES"),this.type=n.HALF_FLOAT_OES))},Texture.prototype.delete=function(){gl.deleteTexture(this.handler),this.handler=null},Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}},Texture.prototype.hasSameProperties=function(e){return e?e.width==this.width&&e.height==this.height&&e.type==this.type&&e.format==this.format&&e.texture_type==this.texture_type:!1},Texture.prototype.hasSameSize=function(e){return e?e.width==this.width&&e.height==this.height:!1},Texture.prototype.toJSON=function(){return""},Texture.isDepthSupported=function(){return gl.extensions.WEBGL_depth_texture!=null},Texture.prototype.bind=function(e){e==null&&(e=0);var t=this.gl;return t.activeTexture(t.TEXTURE0+e),t.bindTexture(this.texture_type,this.handler),e},Texture.prototype.unbind=function(e){e===void 0&&(e=0);var t=this.gl;t.activeTexture(t.TEXTURE0+e),t.bindTexture(this.texture_type,null)},Texture.prototype.setParameter=function(e,t){switch(this.bind(0),this.gl.texParameteri(this.texture_type,e,t),e){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=t;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=t;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=t;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=t;break}},Texture.setUploadOptions=function(e,t){t=t||l.gl,Texture.disable_deprecated||(e?(t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!e.premultiply_alpha),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!e.no_flip)):(t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0))),t.pixelStorei(t.UNPACK_ALIGNMENT,1)},Texture.flipYData=function(e,t,r,s){for(var a=new e.constructor(t*s),o=0,h=t*(r-1)*s,f=Math.floor(r*.5),p=0;p<f;++p){var T=e.subarray(o,o+t*s),_=e.subarray(h,h+t*s);if(a.set(T),T.set(_),_.set(a),o+=t*s,h-=t*s,o>h)break}},Texture.prototype.uploadImage=function(e,t){this.bind();var r=this.gl;if(!e)throw"uploadImage parameter must be Image";Texture.setUploadOptions(t,r);try{if(t&&t.subimage)r.webgl_version==1?r.texSubImage2D(r.TEXTURE_2D,0,0,0,this.format,this.type,e):r.texSubImage2D(r.TEXTURE_2D,0,0,0,e.videoWidth||e.width,e.videoHeight||e.height,this.format,this.type,e);else{var s=e.videoWidth||e.width,a=e.videoHeight||e.height;(s!=this.width||a!=this.height)&&this.width!=1&&this.height!=1&&console.warn("image uploaded has a different size than texture, resizing it."),r.texImage2D(r.TEXTURE_2D,0,this.format,this.format,this.type,e),this.width=s,this.height=a}this.data=e}catch(o){throw console.error(o),location.protocol=="file:"?'image not loaded for security reasons (serve this page over "http://" instead)':"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}this.minFilter&&this.minFilter!=r.NEAREST&&this.minFilter!=r.LINEAR&&(r.generateMipmap(this.texture_type),this.has_mipmaps=!0),r.bindTexture(this.texture_type,null)},Texture.prototype.uploadData=function(e,t,r){if(t=t||{},!e)throw"no data passed";var s=this.gl;this.bind(),Texture.setUploadOptions(t,s);var a=t.mipmap_level||0,o=this.width,h=this.height;o=o>>a,h=h>>a;var f=this.internalFormat||this.format;if(this.type==n.HALF_FLOAT_OES&&e.constructor===Float32Array&&console.warn("cannot uploadData to a HALF_FLOAT texture from a Float32Array, must be Uint16Array. To upload it we recomment to create a FLOAT texture, upload data there and copy to your HALF_FLOAT."),this.texture_type==n.TEXTURE_2D)s.webgl_version==1?e.buffer&&e.buffer.constructor==ArrayBuffer?s.texImage2D(this.texture_type,a,f,o,h,0,this.format,this.type,e):s.texImage2D(this.texture_type,a,f,this.format,this.type,e):s.webgl_version==2&&(e.buffer&&e.buffer.constructor==ArrayBuffer?s.texImage2D(this.texture_type,a,f,o,h,0,this.format,this.type,e):s.texImage2D(this.texture_type,a,f,o,h,0,this.format,this.type,e));else if(this.texture_type==n.TEXTURE_3D)s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),s.texImage3D(this.texture_type,a,f,o,h,this.depth>>a,0,this.format,this.type,e);else if(this.texture_type==n.TEXTURE_CUBE_MAP)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+(t.cubemap_face||0),a,f,o,h,0,this.format,this.type,e);else throw"cannot uploadData for this texture type";this.data=e,!r&&this.minFilter&&this.minFilter!=s.NEAREST&&this.minFilter!=s.LINEAR&&(s.generateMipmap(this.texture_type),this.has_mipmaps=!0),s.bindTexture(this.texture_type,null)},Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,0,0)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}],Texture.prototype.drawTo=function(e,t){var r=this.gl,s=r.getViewport(),a=n.getTime(),o=r.getParameter(r.FRAMEBUFFER_BINDING),h=r._framebuffer=r._framebuffer||r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,h);var f=null;if(Texture.use_renderbuffer_pool){r._renderbuffers_pool||(r._renderbuffers_pool={});var p=this.width+":"+this.height;r._renderbuffers_pool[p]?(f=r._renderbuffers_pool[p],f.time=a,r.bindRenderbuffer(r.RENDERBUFFER,f)):(r._renderbuffers_pool[p]=f=r.createRenderbuffer(),f.time=a,f.width=this.width,f.height=this.height,r.bindRenderbuffer(r.RENDERBUFFER,f),setTimeout(T.bind(f),1e3*60))}else f=r._renderbuffer=r._renderbuffer||r.createRenderbuffer(),f.width=this.width,f.height=this.height,r.bindRenderbuffer(r.RENDERBUFFER,f);this.format===r.DEPTH_COMPONENT?r.renderbufferStorage(r.RENDERBUFFER,r.RGBA4,this.width,this.height):r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,this.width,this.height);function T(){n.getTime()-this.time>=1e3*60?(r.deleteRenderbuffer(r._renderbuffers_pool[p]),delete r._renderbuffers_pool[p]):setTimeout(T.bind(this),1e3*60)}if(r.viewport(0,0,this.width,this.height),r._current_texture_drawto=this,r._current_fbo_color=h,r._current_fbo_depth=f,this.texture_type==r.TEXTURE_2D)this.format!==r.DEPTH_COMPONENT?(r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.handler,0),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,f)):(r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,f),r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_2D,this.handler,0)),e(this,t);else if(this.texture_type==r.TEXTURE_CUBE_MAP){this.format!==r.DEPTH_COMPONENT?r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,f):r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,f);for(var _=0;_<6;_++)this.format!==r.DEPTH_COMPONENT?r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+_,this.handler,0):r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_CUBE_MAP_POSITIVE_X+_,this.handler,0),e(this,_,t)}return this.data=null,r._current_texture_drawto=null,r._current_fbo_color=null,r._current_fbo_depth=null,r.bindFramebuffer(r.FRAMEBUFFER,o),r.bindRenderbuffer(r.RENDERBUFFER,null),r.viewport(s[0],s[1],s[2],s[3]),this},Texture.prototype.copyTo=function(e,t,r){var s=this.gl;if(!e)throw"target_texture required";var a=s.getParameter(s.FRAMEBUFFER_BINDING),o=s.getViewport();t||(t=this.texture_type==s.TEXTURE_2D?n.Shader.getScreenShader():n.Shader.getCubemapCopyShader()),s.disable(s.BLEND),s.disable(s.DEPTH_TEST),t&&r&&t.uniforms(r);var h=s.__copy_fbo;if(h||(h=s.__copy_fbo=s.createFramebuffer()),s.bindFramebuffer(s.FRAMEBUFFER,h),s.viewport(0,0,e.width,e.height),this.texture_type==s.TEXTURE_2D)if(this.format!==s.DEPTH_COMPONENT&&this.format!==s.DEPTH_STENCIL)s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,e.handler,0),this.toViewport(t);else{var f=s._color_renderbuffer=s._color_renderbuffer||s.createRenderbuffer(),p=f.width=e.width,T=f.height=e.height;s.bindRenderbuffer(s.RENDERBUFFER,f),s.renderbufferStorage(s.RENDERBUFFER,s.RGBA4,p,T),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,f);var _=e.format==s.DEPTH_STENCIL?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;s.framebufferTexture2D(s.FRAMEBUFFER,_,s.TEXTURE_2D,e.handler,0);var S=s.checkFramebufferStatus(s.FRAMEBUFFER);if(S!==s.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+S;s.enable(s.DEPTH_TEST),s.depthFunc(s.ALWAYS),s.colorMask(!1,!1,!1,!1),t=n.Shader.getCopyDepthShader(),this.toViewport(t),s.colorMask(!0,!0,!0,!0),s.disable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,null),s.framebufferTexture2D(s.FRAMEBUFFER,_,s.TEXTURE_2D,null,0)}else if(this.texture_type==s.TEXTURE_CUBE_MAP){t.uniforms({u_texture:0});for(var b=n.temp_mat3,M=0;M<6;M++){s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+M,e.handler,0);var G=n.Texture.cubemap_camera_parameters[M];mat3.identity(b),b.set(G.right,0),b.set(G.up,3),b.set(G.dir,6),this.toViewport(t,{u_rotation:b})}}return s.setViewport(o),s.bindFramebuffer(s.FRAMEBUFFER,a),e.minFilter&&e.minFilter!=s.NEAREST&&e.minFilter!=s.LINEAR&&(e.bind(),s.generateMipmap(e.texture_type),e.has_mipmaps=!0),e.data=null,s.bindTexture(e.texture_type,null),this},Texture.prototype.blit=function(){var e=new Float32Array(4);return function(t,r,s){var a=this.gl;if(this.texture_type!=a.TEXTURE_2D||this.format===a.DEPTH_COMPONENT||this.format===a.DEPTH_STENCIL)throw"blit only support TEXTURE_2D of RGB or RGBA. use copyTo instead";var o=a.getParameter(a.FRAMEBUFFER_BINDING);e.set(a.viewport_data),r=r||n.Shader.getScreenShader(),r&&s&&r.uniforms(s);var h=a.__copy_fbo;return h||(h=a.__copy_fbo=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,h),a.viewport(0,0,t.width,t.height),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,t.handler,0),this.bind(0),r.draw(n.Mesh.getScreenQuad(),a.TRIANGLES),a.setViewport(e),a.bindFramebuffer(a.FRAMEBUFFER,o),t.data=null,a.bindTexture(t.texture_type,null),this}}(),Texture.prototype.toViewport=function(e,t){e=e||Shader.getScreenShader();var r=Mesh.getScreenQuad();this.bind(0),t&&e.uniforms(t),e.draw(r,gl.TRIANGLES)},Texture.prototype.fill=function(e,t){if(e.constructor===n.Shader){var r=e;this.drawTo(function(){r.toViewport()})}else{var s=e,a=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(s[0],s[1],s[2],s[3]),this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)}),gl.clearColor(a[0],a[1],a[2],a[3])}!t&&this.minFilter&&this.minFilter!=gl.NEAREST&&this.minFilter!=gl.LINEAR&&(this.bind(),gl.generateMipmap(this.texture_type),this.has_mipmaps=!0)},Texture.prototype.renderQuad=function(){var e=mat3.create(),t=vec2.create(),r=vec2.create(),s=vec4.fromValues(1,1,1,1);return function(a,o,h,f,p,T){t[0]=a,t[1]=o,r[0]=h,r[1]=f,p=p||Shader.getQuadShader(this.gl);var _=Mesh.getScreenQuad(this.gl);this.bind(0),p.uniforms({u_texture:0,u_position:t,u_color:s,u_size:r,u_viewport:gl.viewport_data.subarray(2,4),u_transform:e}),T&&p.uniforms(T),p.draw(_,gl.TRIANGLES)}}(),Texture.prototype.applyBlur=function(e,t,r,s,a){var o=this.gl;e===void 0&&(e=1),t===void 0&&(t=1),o.disable(o.DEPTH_TEST),o.disable(o.BLEND),s=s||this;var h=!a;if(a===s)throw"cannot use applyBlur in a texture using as temporary itself";if(s&&this.texture_type!==s.texture_type)throw"cannot use applyBlur with textures of different texture_type";var f=o.getParameter(o.FRAMEBUFFER_BINDING),p=o.getViewport(),T=o.__copy_fbo;if(T||(T=o.__copy_fbo=o.createFramebuffer()),o.bindFramebuffer(o.FRAMEBUFFER,T),o.viewport(0,0,this.width,this.height),this.texture_type===o.TEXTURE_2D){var _=n.Shader.getBlurShader();a||(a=n.Texture.getTemporary(this.width,this.height,this)),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,a.handler,0),this.toViewport(_,{u_texture:0,u_intensity:r,u_offset:[0,t/this.height]}),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,s.handler,0),o.viewport(0,0,s.width,s.height),a.toViewport(_,{u_intensity:r,u_offset:[e/a.width,0]}),h&&n.Texture.releaseTemporary(a)}else if(this.texture_type===o.TEXTURE_CUBE_MAP){var _=n.Shader.getCubemapBlurShader();_.uniforms({u_texture:0,u_intensity:r,u_offset:[e/this.width,t/this.height]}),this.bind(0);var S=Mesh.getScreenQuad();S.bindBuffers(_),_.bind();var b=null;!a&&s==this?b=a=n.Texture.getTemporary(s.width,s.height,s):b=s;for(var M=n.temp_mat3,G=0;G<6;++G){o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_CUBE_MAP_POSITIVE_X+G,b.handler,0);var O=n.Texture.cubemap_camera_parameters[G];mat3.identity(M),M.set(O.right,0),M.set(O.up,3),M.set(O.dir,6),_._setUniform("u_rotation",M),o.drawArrays(o.TRIANGLES,0,6)}S.unbindBuffers(_),a&&a.copyTo(s),a&&h&&n.Texture.releaseTemporary(a)}o.setViewport(p),o.bindFramebuffer(o.FRAMEBUFFER,f),s.data=null,s.minFilter&&s.minFilter!=o.NEAREST&&s.minFilter!=o.LINEAR&&(s.bind(),o.generateMipmap(s.texture_type),s.has_mipmaps=!0),o.bindTexture(s.texture_type,null)},Texture.fromURL=function(e,t,r,s){s=s||l.gl,t=t||{},t=Object.create(t);var a=t.texture||new n.Texture(1,1,t,s);e.length<64&&(a.url=e),a.bind();var o=t.temp_color||Texture.loading_color;s.pixelStorei(s.UNPACK_ALIGNMENT,4);var h=t.type==s.FLOAT?new Float32Array(o):new Uint8Array(o);s.texImage2D(s.TEXTURE_2D,0,a.format,a.width,a.height,0,a.format,a.type,h),s.bindTexture(a.texture_type,null),a.ready=!1;var f=null;if(t.extension&&(f=t.extension),!f&&e.length<512){var p=e,T=e.indexOf("?");T!=-1&&(p=e.substr(0,T)),T=p.lastIndexOf("."),T!=-1&&(f=p.substr(T+1).toLowerCase())}if(f=="dds"){var f=s.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||s.getExtension("WEBGL_compressed_texture_s3tc"),_=new n.Texture(0,0,t,s);m.loadDDSTextureEx(s,f,e,_.handler,!0,function(M){a.texture_type=M.texture_type,a.handler=M,delete a.ready,r&&r(a,e)})}else if(f=="tga")HttpRequest(e,null,function(b){var M=n.Texture.parseTGA(b);M&&(t.texture=a,M.flipY&&(t.no_flip=!0),M.format=="RGB"&&(a.format=s.RGB),a=n.Texture.fromMemory(M.width,M.height,M.pixels,t),delete a.ready,r&&r(a,e))},null,{binary:!0});else{var S=new Image;S.src=e,S.crossOrigin=Texture.CROSS_ORIGIN_CREDENTIALS,S.onload=function(){t.texture=a,n.Texture.fromImage(this,t),delete a.ready,r&&r(a,e)},S.onerror=function(){r&&r(null)}}return a},Texture.parseTGA=function(e){if(!e||e.constructor!==ArrayBuffer)throw"TGA: data must be ArrayBuffer";e=new Uint8Array(e);for(var t=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),r=e.subarray(0,12),s=0;s<r.length;s++)if(t[s]!=r[s])return console.error("TGA header is not valid"),null;var a=e.subarray(12,18),o={};o.width=a[1]*256+a[0],o.height=a[3]*256+a[2],o.bpp=a[4],o.bytesPerPixel=o.bpp/8,o.imageSize=o.width*o.height*o.bytesPerPixel,o.pixels=e.subarray(18,18+o.imageSize),o.pixels=new Uint8Array(o.pixels),o.flipY=(a[5]&32)==0;for(var s=0;s<o.imageSize;s+=o.bytesPerPixel){var h=o.pixels[s];o.pixels[s]=o.pixels[s+2],o.pixels[s+2]=h}return o.format=o.bpp==32?"RGBA":"RGB",o},Texture.fromImage=function(e,t){t=t||{};var r=t.texture||new n.Texture(e.width,e.height,t);return r.uploadImage(e,t),r.bind(),gl.texParameteri(r.texture_type,gl.TEXTURE_MAG_FILTER,r.magFilter||n.LINEAR),gl.texParameteri(r.texture_type,gl.TEXTURE_MIN_FILTER,r.minFilter||n.LINEAR_MIPMAP_LINEAR),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_S,r.wrapS||n.REPEAT),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_T,r.wrapT||n.REPEAT),n.isPowerOfTwo(r.width)&&n.isPowerOfTwo(r.height)||gl.webgl_version>1?t.minFilter&&t.minFilter!=gl.NEAREST&&t.minFilter!=gl.LINEAR&&(r.bind(),gl.generateMipmap(r.texture_type),r.has_mipmaps=!0):(gl.texParameteri(r.texture_type,gl.TEXTURE_MIN_FILTER,n.LINEAR),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),gl.texParameteri(r.texture_type,gl.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),r.has_mipmaps=!1),gl.bindTexture(r.texture_type,null),r.data=e,t.keep_image&&(r.img=e),r},Texture.fromVideo=function(e,t){t=t||{};var r=t.texture||new n.Texture(e.videoWidth,e.videoHeight,t);return r.bind(),r.uploadImage(e,t),t.minFilter&&t.minFilter!=gl.NEAREST&&t.minFilter!=gl.LINEAR&&(r.bind(),gl.generateMipmap(r.texture_type),r.has_mipmaps=!0,r.data=e),gl.bindTexture(r.texture_type,null),r},Texture.fromTexture=function(e,t){t=t||{};var r=new n.Texture(e.width,e.height,t);return e.copyTo(r),r},Texture.prototype.clone=function(e){var t=this.getProperties();if(e)for(var r in e)t[r]=e[r];return Texture.fromTexture(this,t)},Texture.fromMemory=function(e,t,r,s){s=s||{};var a=s.texture||new n.Texture(e,t,s);return Texture.setUploadOptions(s),a.bind(),r.constructor===Array&&(s.type==gl.FLOAT?r=new Float32Array(r):s.type==n.HALF_FLOAT||s.type==n.HALF_FLOAT_OES?r=new Uint16Array(r):r=new Uint8Array(r)),gl.texImage2D(gl.TEXTURE_2D,0,a.format,e,t,0,a.format,a.type,r),a.width=e,a.height=t,a.data=r,s.minFilter&&s.minFilter!=gl.NEAREST&&s.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),a.has_mipmaps=!0),gl.bindTexture(a.texture_type,null),a},Texture.fromDDSInMemory=function(e,t){t=t||{};var r=t.texture||new n.Texture(0,0,t);n.Texture.setUploadOptions(t),r.bind();var s=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");return m.loadDDSTextureFromMemoryEx(gl,s,e,r,!0),gl.bindTexture(r.texture_type,null),r},Texture.fromShader=function(e,t,r,s){s=s||{};var a=new n.Texture(e,t,s);return a.drawTo(function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE);var o=Mesh.getScreenQuad();r.draw(o)}),a},Texture.cubemapFromImages=function(e,t){if(t=t||{},e.length!=6)throw"missing images to create cubemap";var r=e[0].width,s=e[0].height;t.texture_type=gl.TEXTURE_CUBE_MAP;var a=null;t.texture?(a=t.texture,a.width=r,a.height=s):a=new n.Texture(r,s,t),Texture.setUploadOptions(t),a.bind();try{for(var o=0;o<6;o++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,a.format,a.format,a.type,e[o]);a.data=e}catch{throw location.protocol=="file:"?'image not loaded for security reasons (serve this page over "http://" instead)':"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}return t.minFilter&&t.minFilter!=gl.NEAREST&&t.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),a.has_mipmaps=!0),a.unbind(),a},Texture.cubemapFromImage=function(e,t){if(t=t||{},e.width!=e.height/6&&e.height%6!=0&&!t.faces&&!t.is_polar)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",e.width,e.height),null;var r=e.width,s=e.height;if(t.is_polar){var S=t.size||n.nearestPowerOfTwo(e.height),a=n.Texture.fromImage(e,{ignore_pot:!0,wrap:gl.REPEAT,filter:gl.LINEAR}),o=new n.Texture(S,S,{texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGBA});if(t.texture){var h=t.texture;for(var f in o)h[f]=o[f];o=h}var p=mat3.create(),T={u_texture:0,u_rotation:p};gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND);var _=n.Shader.getPolarToCubemapShader();return o.drawTo(function(H,z){var k=n.Texture.cubemap_camera_parameters[z];mat3.identity(p),p.set(k.right,0),p.set(k.up,3),p.set(k.dir,6),a.toViewport(_,T)}),t.keep_image&&(o.img=e),o}else t.is_cross!==void 0?(t.faces=Texture.generateCubemapCrossFacesInfo(e.width,t.is_cross),r=s=e.width/4):t.faces?(r=t.width||t.faces[0].width,s=t.height||t.faces[0].height):s/=6;if(r!=s)return console.log("Texture not valid, width and height for every face must be square"),null;var S=r;t.no_flip=!0;for(var b=[],f=0;f<6;f++){var M=createCanvas(S,S),G=M.getContext("2d");t.faces?G.drawImage(e,t.faces[f].x,t.faces[f].y,t.faces[f].width||S,t.faces[f].height||S,0,0,S,S):G.drawImage(e,0,s*f,r,s,0,0,S,S),b.push(M)}var O=Texture.cubemapFromImages(b,t);return t.keep_image&&(O.img=e),O},Texture.generateCubemapCrossFacesInfo=function(e,t){t===void 0&&(t=1);var r=e/4;return[{x:2*r,y:r,width:r,height:r},{x:0,y:r,width:r,height:r},{x:t*r,y:0,width:r,height:r},{x:t*r,y:2*r,width:r,height:r},{x:r,y:r,width:r,height:r},{x:3*r,y:r,width:r,height:r}]},Texture.cubemapFromURL=function(e,t,r){t=t||{},t=Object.create(t),t.texture_type=gl.TEXTURE_CUBE_MAP;var s=t.texture||new n.Texture(1,1,t);s.bind(),Texture.setUploadOptions(t);for(var a=t.temp_color||[0,0,0,255],o=t.type==gl.FLOAT?new Float32Array(a):new Uint8Array(a),h=0;h<6;h++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+h,0,s.format,1,1,0,s.format,s.type,o);gl.bindTexture(s.texture_type,null),s.ready=!1;var f=new Image;return f.src=e,f.onload=function(){t.texture=s,s=n.Texture.cubemapFromImage(this,t),s&&delete s.ready,r&&r(s)},s},Texture.prototype.getPixels=function(e,t){t=t||0;var r=this.gl,s=r.getViewport(),a=r.getParameter(r.FRAMEBUFFER_BINDING);if(this.format==r.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";r.disable(r.DEPTH_TEST);var o=r.__copy_fbo;o||(o=r.__copy_fbo=r.createFramebuffer()),r.bindFramebuffer(r.FRAMEBUFFER,o);var h=null,f=this.width>>t,p=this.height>>t;r.viewport(0,0,f,p),this.texture_type==r.TEXTURE_2D?r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.handler,t):this.texture_type==r.TEXTURE_CUBE_MAP&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+(e||0),this.handler,t);var T=this.format==r.RGB?3:4;T=4;var _=this.type;return _==r.UNSIGNED_BYTE?h=new Uint8Array(f*p*T):_==n.HALF_FLOAT||_==n.HALF_FLOAT_OES?h=new Uint16Array(f*p*T):h=new Float32Array(f*p*T),r.readPixels(0,0,f,p,T==3?r.RGB:r.RGBA,_,h),r.bindFramebuffer(r.FRAMEBUFFER,a),r.viewport(s[0],s[1],s[2],s[3]),h},Texture.prototype.setPixels=function(e,t,r,s){var a={no_flip:t};s&&(a.cubemap_face=s),this.uploadData(e,a,r)},Texture.prototype.getCubemapPixels=function(){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap";return[this.getPixels(0),this.getPixels(1),this.getPixels(2),this.getPixels(3),this.getPixels(4),this.getPixels(5)]},Texture.prototype.setCubemapPixels=function(e,t){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap, it should be created with { texture_type: gl.TEXTURE_CUBE_MAP }";for(var r=0;r<6;++r)this.setPixels(e[r],t,r!=5,r)},Texture.prototype.toCanvas=function(e,t,r){r=r||8192;var s=this.gl,a=Math.min(this.width,r),o=Math.min(this.height,r);this.texture_type==s.TEXTURE_CUBE_MAP&&(a=a*4,o=o*3),e=e||createCanvas(a,o),e.width!=a&&(e.width=a),e.height!=o&&(e.height=o);var h=null;if(this.texture_type==s.TEXTURE_2D){if(this.width!=a||this.height!=o||this.type!=s.UNSIGNED_BYTE){var f=new n.Texture(a,o,{format:s.RGBA,filter:s.NEAREST});this.copyTo(f),h=f.getPixels()}else h=this.getPixels();var p=e.getContext("2d"),T=p.getImageData(0,0,a,o);if(T.data.set(h),p.putImageData(T,0,0),t){var f=createCanvas(a,o),_=f.getContext("2d");_.translate(0,f.height),_.scale(1,-1),_.drawImage(e,0,0,f.width,f.height),p.clearRect(0,0,p.canvas.width,p.canvas.height),p.drawImage(f,0,0)}}else if(this.texture_type==s.TEXTURE_CUBE_MAP){var S=createCanvas(this.width,this.height),_=S.getContext("2d"),b=n.Texture.generateCubemapCrossFacesInfo(e.width,1),p=e.getContext("2d");p.fillStyle="black",p.fillRect(0,0,e.width,e.height);var M=this;this.type!=s.UNSIGNED_BYTE&&(M=new n.Texture(this.width,this.height,{format:s.RGBA,texture_type:s.TEXTURE_CUBE_MAP,filter:s.NEAREST,type:s.UNSIGNED_BYTE}),this.copyTo(M));for(var G=0;G<6;G++){var T=_.getImageData(0,0,S.width,S.height);h=M.getPixels(G),T.data.set(h),_.putImageData(T,0,0),p.drawImage(S,b[G].x,b[G].y,S.width,S.height)}}return e},Texture.binary_extension="png",Texture.prototype.toBinary=function(e,t){for(var r=this.toCanvas(null,e),s=r.toDataURL(t),a=s.indexOf(","),o=s.substr(a+1),h=atob(o),f=h.length,p=new Uint8Array(f),T=0;T<f;++T)p[T]=h.charCodeAt(T);return p},Texture.prototype.toBlob=function(e,t){var r=this.toBinary(e),s=new Blob([r],{type:t||"image/png"});return s},Texture.prototype.toBlobAsync=function(e,t,r){var s=this.toCanvas(null,e);if(s.toBlob){s.toBlob(r,t);return}var a=this.toBlob(e,t);r&&r(a)},Texture.prototype.toBase64=function(e){var t=this.width,r=this.height,s=this.getPixels(),a=createCanvas(t,r),o=a.getContext("2d"),h=o.getImageData(0,0,t,r);if(h.data.set(s),o.putImageData(h,0,0),e){var f=createCanvas(t,r),p=f.getContext("2d");p.translate(0,r),p.scale(1,-1),p.drawImage(a,0,0),a=f}var T=a.toDataURL("image/png");return T},Texture.prototype.generateMetadata=function(){var e={};e.width=this.width,e.height=this.height,this.metadata=e},Texture.compareFormats=function(e,t){return!e||!t?!1:e==t?!0:!(e.width!=t.width||e.height!=t.height||e.type!=t.type||e.format!=t.format||e.texture_type!=t.texture_type)},Texture.blend=function(e,t,r,s){if(!e||!t)return!1;if(e==t)return s?e.copyTo(s):e.toViewport(),!0;gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE);var a=n.Shader.getBlendShader(),o=n.Mesh.getScreenQuad();return t.bind(1),a.uniforms({u_texture:0,u_texture2:1,u_factor:r}),s?(s.drawTo(function(){if(e==s||t==s)throw"Blend output cannot be the same as the input";e.bind(0),a.draw(o,gl.TRIANGLES)}),!0):(e.bind(0),a.draw(o,gl.TRIANGLES),!0)},Texture.cubemapToTexture2D=function(e,t,r,s,a){if(!e||e.texture_type!=gl.TEXTURE_CUBE_MAP)throw"No cubemap in convert";t=t||e.width;var o=s?e.type:gl.UNSIGNED_BYTE;a=a||0,r||(r=new n.Texture(t*2,t,{minFilter:gl.NEAREST,type:o}));var h=gl.shaders.cubemap_to_texture2D;return h||(h=gl.shaders.cubemap_to_texture2D=new n.Shader(n.Shader.SCREEN_VERTEX_SHADER,`		precision mediump float;
		#define PI 3.14159265358979323846264
		uniform samplerCube texture;		varying vec2 v_coord;		uniform float u_yaw;
		void main() {			float alpha = ((1.0 - v_coord.x) * 2.0) * PI + u_yaw;			float beta = (v_coord.y * 2.0 - 1.0) * PI * 0.5;			vec3 N = vec3( -cos(alpha) * cos(beta), sin(beta), sin(alpha) * cos(beta) );			gl_FragColor = textureCube(texture,N);		}`)),h.setUniform("u_yaw",a),r.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),e.toViewport(h)}),r},Texture.getWhiteTexture=function(e){e=e||l.gl;var t=e.textures[":white"];if(t)return t;var r=new Uint8Array([255,255,255,255]);return e.textures[":white"]=new n.Texture(1,1,{pixel_data:r})},Texture.getBlackTexture=function(e){e=e||l.gl;var t=e.textures[":black"];if(t)return t;var r=new Uint8Array([0,0,0,255]);return e.textures[":black"]=new n.Texture(1,1,{pixel_data:r})},Texture.getTemporary=function(e,t,r,s){s=s||l.gl,s._texture_pool||(s._texture_pool=[]);var a=n.TEXTURE_2D,o=Texture.DEFAULT_TYPE,h=Texture.DEFAULT_FORMAT;r&&(r.texture_type&&(a=r.texture_type),r.type&&(o=r.type),r.format&&(h=r.format));for(var f=a+":"+o+":"+e+"x"+t+":"+h,p=s._texture_pool,T=0;T<p.length;++T){var _=p[T];if(_._key==f)return p.splice(T,1),_._pool=0,_}var _=new n.Texture(e,t,{type:o,texture_type:a,format:h,filter:s.LINEAR});return _._key=f,_._pool=0,_},Texture.releaseTemporary=function(e,t){t=t||l.gl,t._texture_pool||(t._texture_pool=[]),e._pool>0&&console.warn("this texture is already in the textures pool");var r=t._texture_pool;if(r||(r=t._texture_pool=[]),e._pool=getTime(),r.push(e),r.length>20){r.sort(function(a,o){return o._pool-a._pool});var e=r.pop();e._pool=0,e.delete()}},Texture.nextPOT=function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.log(2)))};function C(e,t,r,s){if(s=s||l.gl,this.gl=s,this._context_id=s.context_id,e&&e.constructor!==Array)throw"FBO textures must be an Array";this.handler=null,this.width=-1,this.height=-1,this.color_textures=[],this.depth_texture=null,this.stencil=!!r,this._stencil_enabled=!1,this._num_binded_textures=0,this.order=null,(e&&e.length||t)&&this.setTextures(e,t),this._old_fbo_handler=null,this._old_viewport=new Float32Array(4)}n.FBO=C,C.prototype.setTextures=function(e,t,r){if(t&&t.constructor===n.Texture){if(t.format!==n.DEPTH_COMPONENT&&t.format!==n.DEPTH_STENCIL&&t.format!==n.DEPTH_COMPONENT16&&t.format!==n.DEPTH_COMPONENT24&&t.format!==n.DEPTH_COMPONENT32F)throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT, gl.DEPTH_STENCIL or gl.DEPTH_COMPONENT16/24/32F (only in webgl2)";if(t.type!=n.UNSIGNED_SHORT&&t.type!=n.UNSIGNED_INT&&t.type!=n.UNSIGNED_INT_24_8_WEBGL&&t.type!=n.FLOAT)throw"FBO Depth texture must be of type: gl.UNSIGNED_SHORT, gl.UNSIGNED_INT, gl.UNSIGNED_INT_24_8_WEBGL"}var s=this.depth_texture==t;if(s&&e){if(e.constructor!==Array)throw"FBO: color_textures parameter must be an array containing all the textures to be binded in the color";if(e.length==this.color_textures.length){for(var a=0;a<e.length;++a)if(e[a]!=this.color_textures[a]){s=!1;break}}else s=!1}if(this._stencil_enabled!==this.stencil&&(s=!1),!s){if(this.color_textures.length=e?e.length:0,e)for(var a=0;a<e.length;++a)this.color_textures[a]=e[a];this.depth_texture=t,this.update(r)}},C.prototype.update=function(e){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING),this.handler||(this.handler=gl.createFramebuffer());var t=-1,r=-1,s=null,a=null,o=this.color_textures,h=this.depth_texture;if(o&&o.length)for(var f=0;f<o.length;f++){var p=o[f];if(p.constructor!==n.Texture)throw"FBO can only bind instances of GL.Texture";if(t==-1)t=p.width;else if(t!=p.width)throw"Cannot bind textures with different dimensions";if(r==-1)r=p.height;else if(r!=p.height)throw"Cannot bind textures with different dimensions";if(s==null)s=p.type,a=p.format;else if(s!=p.type)throw"Cannot bind textures to a FBO with different pixel formats";if(p.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO"}else t=h.width,r=h.height;this.width=t,this.height=r,gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);var T=gl.extensions.WEBGL_draw_buffers;if(gl.webgl_version==1&&!T&&o&&o.length>1)throw"Rendering to several textures not supported by your browser";var _=gl.webgl_version==1?gl.FRAMEBUFFER:gl.DRAW_FRAMEBUFFER;if(gl.framebufferRenderbuffer(_,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,null),gl.framebufferRenderbuffer(_,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,null),h&&h.constructor===n.Texture){if(gl.webgl_version==1&&!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";this.stencil&&h.format!==gl.DEPTH_STENCIL&&console.warn("Stencil cannot be enabled if there is a depth texture with a DEPTH_STENCIL format"),h.format==gl.DEPTH_STENCIL?gl.framebufferTexture2D(_,gl.DEPTH_STENCIL_ATTACHMENT,gl.TEXTURE_2D,h.handler,0):gl.framebufferTexture2D(_,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,h.handler,0)}else{var S=null;h&&h.constructor===WebGLRenderbuffer&&h.width==t&&h.height==r?S=this._depth_renderbuffer=h:(S=this._depth_renderbuffer=this._depth_renderbuffer||gl.createRenderbuffer(),S.width=t,S.height=r),gl.bindRenderbuffer(gl.RENDERBUFFER,S),this.stencil?(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,t,r),gl.framebufferRenderbuffer(_,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,S)):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,t,r),gl.framebufferRenderbuffer(_,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,S))}if(o&&o.length){this.order=[];for(var f=0;f<o.length;f++){var p=o[f];gl.framebufferTexture2D(_,gl.COLOR_ATTACHMENT0+f,gl.TEXTURE_2D,p.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+f)}}else{var b=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer();b.width=t,b.height=r,gl.bindRenderbuffer(gl.RENDERBUFFER,b),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,t,r),gl.framebufferRenderbuffer(_,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,b)}for(var M=o?o.length:0,f=M;f<this._num_binded_textures;++f)gl.framebufferTexture2D(_,gl.COLOR_ATTACHMENT0+f,gl.TEXTURE_2D,null,0);this._num_binded_textures=M,this._stencil_enabled=this.stencil,o&&o.length>1&&(T?T.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order));var G=gl.checkFramebufferStatus(_);if(G!==gl.FRAMEBUFFER_COMPLETE)throw a==n.RGB&&(s==n.FLOAT||s==n.HALF_FLOAT_OES)&&console.error("Tip: Firefox does not support RGB channel float/half_float textures, you must use RGBA"),"FBO not complete: "+G;gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),e||gl.bindFramebuffer(_,this._old_fbo_handler)},C.prototype.bind=function(e){if(this.multi_sample){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING),this._old_viewport.set(gl.viewport_data),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,this.colorRenderbuffer),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer),gl.viewport(0,0,this.width,this.height),C.current=this;return}if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data),e?this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING):this._old_fbo_handler=null,this._old_fbo_handler!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);for(var t=0;t<this.color_textures.length;++t)this.color_textures[t]._in_current_fbo=!0;this.depth_texture&&(this.depth_texture._in_current_fbo=!0),gl.viewport(0,0,this.width,this.height),C.current=this},C.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler),this._old_fbo_handler=null,gl.setViewport(this._old_viewport);for(var e=0;e<this.color_textures.length;++e)this.color_textures[e]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1),C.current=null},C.prototype.switchTo=function(e){e._old_fbo_handler=this._old_fbo_handler,e._old_viewport.set(this._old_viewport),gl.bindFramebuffer(gl.FRAMEBUFFER,e.handler),this._old_fbo_handler=null,gl.viewport(0,0,this.width,this.height);for(var t=0;t<this.color_textures.length;++t)this.color_textures[t]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);for(var t=0;t<e.color_textures.length;++t)e.color_textures[t]._in_current_fbo=!0;e.depth_texture&&(e.depth_texture._in_current_fbo=!0),C.current=e},C.prototype.delete=function(){gl.deleteFramebuffer(this.handler),this.handler=null},C.supported={},C.testSupport=function(e,t){var r=e+":"+t;if(C.supported[r]!=null)return C.supported[r];var s=new n.Texture(1,1,{format:t,type:e});try{var a=new n.FBO([s])}catch{return console.warn("This browser WEBGL implementation doesn't support this FBO format: "+n.reverse[e]+" "+n.reverse[t]),C.supported[r]=!1}return C.supported[r]=!0,!0},C.prototype.toSingle=function(e){if(e=e||0,!(this.color_textures.length<2)){var t=gl.extensions.WEBGL_draw_buffers;t?t.drawBuffersWEBGL([this.order[e]]):gl.drawBuffers([this.order[e]])}},C.prototype.toMulti=function(){if(!(this.color_textures.length<2)){var e=gl.extensions.WEBGL_draw_buffers;e?e.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}},C.prototype.clearSecondary=function(e){if(!(!this.order||this.order.length<2)){for(var t=gl.extensions.WEBGL_draw_buffers,r=[gl.NONE],s=1;s<this.order.length;++s)r.push(this.order[s]);t?t.drawBuffersWEBGL(r):gl.drawBuffers(r),gl.clearColor(e[0],e[1],e[2],e[3]),gl.clear(gl.COLOR_BUFFER_BIT),t?t.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}},C.prototype.makeMultiSample=function(e,t,r,s){if(this.gl.webgl_version==1)throw"cannot use makeMultiSample in webgl 1.0";this.width=e,this.height=t,r=r||4,s=s||{};var a=s.format||gl.RGBA8,o=gl.DEPTH_COMPONENT16;this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING),this.handler=gl.createFramebuffer(),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),this.colorRenderbuffer=gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,this.colorRenderbuffer),gl.renderbufferStorageMultisample(gl.RENDERBUFFER,r,a,this.width,this.height),this.depthRenderbuffer=gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthRenderbuffer),gl.renderbufferStorageMultisample(gl.RENDERBUFFER,r,o,this.width,this.height),gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,this.colorRenderbuffer),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthRenderbuffer),gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler),this._old_fbo_handler=null,this.multi_sample=!0},C.prototype.blitMultisample=function(e){if(!e||e.constructor!==n.FBO)throw"parameter must be GL.FBO";gl.bindFramebuffer(gl.READ_FRAMEBUFFER,this.handler),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,e.handler),gl.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,gl.COLOR_BUFFER_BIT,gl.LINEAR),gl.bindFramebuffer(gl.READ_FRAMEBUFFER,null),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler),this._old_fbo_handler=null,gl.setViewport(this._old_viewport)},l.Shader=n.Shader=function e(t,r,s){if(n.debug&&console.log("GL.Shader created"),!t||!r)throw"GL.Shader source code parameter missing";this._context_id=l.gl.context_id;var a=this.gl=l.gl,o=e.expandMacros(s),h=t.constructor===String?e.injectCode(o,t,a):t,f=r.constructor===String?e.injectCode(o,r,a):r;this.program=a.createProgram();var p=t.constructor===String?n.Shader.compileSource(a.VERTEX_SHADER,h):t,T=r.constructor===String?n.Shader.compileSource(a.FRAGMENT_SHADER,f):r;a.attachShader(this.program,p,a),a.attachShader(this.program,T,a),a.linkProgram(this.program),this.vs_shader=p,this.fs_shader=T,this.attributes={},this.uniformInfo={},this.samplers={},e.use_async?this._first_use=!0:this.checkLink()},Shader.use_async=!0,Shader.expandMacros=function(e){var t="";if(e)for(var r in e)t+="#define "+r+" "+(e[r]?e[r]:"")+`
`;return t},Shader.injectCode=function(e,t,r){var s=t.indexOf(`
`),a=r?"#define WEBGL"+r.webgl_version+`
`:"",o=t.substr(0,s).trim();return o.indexOf("#version")==-1?a+e+t:o+`
`+a+e+t.substr(s)},Shader.compileSource=function(e,t,r,s){return r=r||l.gl,s=s||r.createShader(e),r.shaderSource(s,t),r.compileShader(s),s},Shader.parseError=function(e,t,r){if(!e)return null;var s=e.split(" "),a=s[5].split(":");return{type:s[0],line_number:parseInt(a[1]),line_pos:parseInt(a[0]),line_code:(s[0]=="Fragment"?r:t).split(`
`)[parseInt(a[1])],err:e}},Shader.prototype.delete=function(){this.program&&this.gl.deleteProgram(this.program),this.vs_shader&&this.gl.deleteShader(this.vs_shader),this.fs_shader&&this.gl.deleteShader(this.fs_shader),this.gl=null,this.attributes={},this.uniformInfo={},this.samplers={}},Shader.prototype.updateShader=function(e,t,r){var s=this.gl||l.gl,a=Shader.expandMacros(r);this.program?(s.detachShader(this.program,this.vs_shader),s.detachShader(this.program,this.fs_shader)):this.program=s.createProgram();var a=Shader.expandMacros(r),o=e.constructor===String?Shader.injectCode(a,e,s):e,h=t.constructor===String?Shader.injectCode(a,t,s):t,f=e.constructor===String?n.Shader.compileSource(s.VERTEX_SHADER,o):e,p=t.constructor===String?n.Shader.compileSource(s.FRAGMENT_SHADER,h):t;s.attachShader(this.program,f,s),s.attachShader(this.program,p,s),s.linkProgram(this.program),this.vs_shader=f,this.fs_shader=p,this.attributes={},this.uniformInfo={},this.samplers={},Shader.use_async?this._first_use=!0:this.checkLink()},Shader.prototype.extractShaderInfo=function(){for(var e=this.gl,t=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS),r=0;r<t;++r){var s=e.getActiveUniform(this.program,r);if(!s)break;var a=s.name,o=a.indexOf("[");if(o!=-1){var h=a.indexOf("].");h==-1&&(a=a.substr(0,o))}(s.type==n.SAMPLER_2D||s.type==n.SAMPLER_CUBE||s.type==n.SAMPLER_3D||s.type==n.INT_SAMPLER_2D||s.type==n.INT_SAMPLER_CUBE||s.type==n.INT_SAMPLER_3D||s.type==n.UNSIGNED_INT_SAMPLER_2D||s.type==n.UNSIGNED_INT_SAMPLER_CUBE||s.type==n.UNSIGNED_INT_SAMPLER_3D)&&(this.samplers[a]=s.type);var f=Shader.getUniformFunc(s),p=!1;(s.type==e.FLOAT_MAT2||s.type==e.FLOAT_MAT3||s.type==e.FLOAT_MAT4)&&(p=!0);var T=n.TYPE_LENGTH[s.type]||1;this.uniformInfo[a]={type:s.type,func:f,size:s.size,type_length:T,is_matrix:p,loc:e.getUniformLocation(this.program,a),data:new Float32Array(T*s.size)}}for(var r=0,t=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES);r<t;++r){var s=e.getActiveAttrib(this.program,r);if(!s)break;var f=Shader.getUniformFunc(s),T=n.TYPE_LENGTH[s.type]||1;this.uniformInfo[s.name]={type:s.type,func:f,type_length:T,size:s.size,loc:null},this.attributes[s.name]=e.getAttribLocation(this.program,s.name)}},Shader.prototype.hasUniform=function(e){return this.uniformInfo[e]},Shader.prototype.hasAttribute=function(e){return this.attributes[e]},Shader.getUniformFunc=function(e){var t=null;switch(e.type){case n.FLOAT:e.size==1?t=gl.uniform1f:t=gl.uniform1fv;break;case n.FLOAT_MAT2:t=gl.uniformMatrix2fv;break;case n.FLOAT_MAT3:t=gl.uniformMatrix3fv;break;case n.FLOAT_MAT4:t=gl.uniformMatrix4fv;break;case n.FLOAT_VEC2:t=gl.uniform2fv;break;case n.FLOAT_VEC3:t=gl.uniform3fv;break;case n.FLOAT_VEC4:t=gl.uniform4fv;break;case n.UNSIGNED_INT:case n.INT:e.size==1?t=gl.uniform1i:t=gl.uniform1iv;break;case n.INT_VEC2:t=gl.uniform2iv;break;case n.INT_VEC3:t=gl.uniform3iv;break;case n.INT_VEC4:t=gl.uniform4iv;break;case n.SAMPLER_2D:case n.SAMPLER_3D:case n.SAMPLER_CUBE:case n.INT_SAMPLER_2D:case n.INT_SAMPLER_3D:case n.INT_SAMPLER_CUBE:case n.UNSIGNED_INT_SAMPLER_2D:case n.UNSIGNED_INT_SAMPLER_3D:case n.UNSIGNED_INT_SAMPLER_CUBE:t=gl.uniform1i;break;default:t=gl.uniform1f;break}return t},Shader.fromURL=function(e,t,r){var s=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute mat4 u_mvp;
			void main() { 
				gl_Position = u_mvp * vec4(a_vertex,1.0); 
			}
		`,a=`
			precision highp float;
			void main() {
				gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
			`,o=new n.Shader(s,a);o.ready=!1;var h=null,f=null;HttpRequest(e,null,function(T){h=T,f&&p()}),HttpRequest(t,null,function(T){f=T,h&&p()});function p(){var T=new n.Shader(h,f);for(var _ in T)o[_]=T[_];o.ready=!0}return o},Shader.prototype.checkLink=function(){if(this._first_use=!1,!gl.getShaderParameter(this.vs_shader,gl.COMPILE_STATUS))throw"Vertex shader compile error: "+gl.getShaderInfoLog(this.vs_shader);if(!gl.getShaderParameter(this.fs_shader,gl.COMPILE_STATUS))throw"Fragment shader compile error: "+gl.getShaderInfoLog(this.fs_shader);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS))throw"link error: "+gl.getProgramInfoLog(this.program);this.extractShaderInfo()},Shader.prototype.bind=function(){var e=this.gl;Shader.use_async&&this._first_use&&(this.checkLink(),this._first_use=!1),e.useProgram(this.program),e._current_shader=this},Shader.prototype.getLocation=function(e){var t=this.uniformInfo[e];return t?this.uniformInfo[e].loc:null},Shader._temp_uniform=new Float32Array(16),Shader.prototype.uniforms=function(e){var t=this.gl;this._first_use&&this.checkLink(),t.useProgram(this.program),t._current_shader=this;for(var r in e){var s=this.uniformInfo[r];s&&this._setUniform(r,e[r])}return this},Shader.prototype.uniformsArray=function(e){var t=this.gl;this._first_use&&this.checkLink(),t.useProgram(this.program),t._current_shader=this;for(var r=0,s=e.length;r<s;++r){var a=e[r];for(var o in a)this._setUniform(o,a[o])}return this},Shader.prototype.setUniform=function(){return function(e,t){this.gl._current_shader!=this&&this.bind();var r=this.uniformInfo[e];r&&r.loc!==null&&t!=null&&(t.constructor===Array&&(r.data.set(t),t=r.data),r.is_matrix?r.func.call(this.gl,r.loc,!1,t):r.func.call(this.gl,r.loc,t))}}(),Shader.prototype._setUniform=function(){return function(e,t){this._first_use&&this.checkLink();var r=this.uniformInfo[e];r&&r.loc!==null&&t!=null&&(t.constructor===Array&&(r.data.set(t),t=r.data),r.is_matrix?r.func.call(this.gl,r.loc,!1,t):r.func.call(this.gl,r.loc,t))}}(),Shader.prototype.draw=function(e,t,r){r=r===void 0?t==gl.LINES?"lines":"triangles":r,this.drawBuffers(e.vertexBuffers,r?e.indexBuffers[r]:null,arguments.length<2?gl.TRIANGLES:t)},Shader.prototype.drawRange=function(e,t,r,s,a){a=a===void 0?t==gl.LINES?"lines":"triangles":a,this.drawBuffers(e.vertexBuffers,a?e.indexBuffers[a]:null,t,r,s)};var R=new Uint8Array(16),P=new Uint8Array(16);Shader.prototype.drawBuffers=function(e,t,r,s,a){if(a!=0){var o=this.gl;this._first_use&&this.checkLink(),o.useProgram(this.program);var h=0,f=R;f.set(P);for(var p in e){var T=e[p],_=T.attribute||p,S=this.attributes[_];S==null||!T.buffer||(f[S]=1,o.bindBuffer(o.ARRAY_BUFFER,T.buffer),o.enableVertexAttribArray(S),o.vertexAttribPointer(S,T.buffer.spacing,T.buffer.gl_type,T.normalize,0,0),h=T.buffer.length/T.buffer.spacing)}var b=0;s>0&&(b=s),t&&(h=t.buffer.length-b),a>0&&a<h&&(h=a);var M=t&&t.data?t.data.constructor.BYTES_PER_ELEMENT:1;b*=M;for(var _ in this.attributes){var S=this.attributes[_];f[S]||o.disableVertexAttribArray(this.attributes[_])}return h&&(!t||t.buffer)&&(t?(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t.buffer),o.drawElements(r,h,t.buffer.gl_type,b),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null)):o.drawArrays(r,b,h),o.draw_calls++),this}},Shader._instancing_arrays=[],Shader.prototype.drawInstanced=function(e,t,r,s,a,o,h){if(o!==0){var f=this.gl;if(f.webgl_version==1&&!f.extensions.ANGLE_instanced_arrays)throw"instancing not supported";this._first_use&&this.checkLink(),f.useProgram(this.program);var p=0,T=R;T.set(P);var _=e.vertexBuffers;for(var S in _){var b=_[S],M=b.attribute||S,G=this.attributes[M];G==null||!b.buffer||(T[G]=1,f.bindBuffer(f.ARRAY_BUFFER,b.buffer),f.enableVertexAttribArray(G),f.vertexAttribPointer(G,b.buffer.spacing,b.buffer.gl_type,b.normalize,0,0),p=b.buffer.length/b.buffer.spacing)}var O=null;r&&(r.constructor===String?O=e.getIndexBuffer(r):r.constructor===n.Buffer&&(O=r));var B=0;a>0&&(B=a),O&&(p=O.buffer.length-B),o>0&&o<p&&(p=o);var H=O&&O.data?O.data.constructor.BYTES_PER_ELEMENT:1;B*=H;for(var M in this.attributes){var G=this.attributes[M];T[G]||f.disableVertexAttribArray(this.attributes[M])}var z=f.extensions.ANGLE_instanced_arrays,k=0,X=0;for(var Q in s){var te=s[Q];k=te.length;var D=this.attributes[Q];if(D==null)return;var J=0,ee=0;te.constructor===Array?(J=te[0].constructor===Number?1:te[0].length,ee=J*te.length):(J=this.uniformInfo[Q].type_length,ee=te.length,k=ee/J);var Y=Shader._instancing_arrays[X];if((!Y||Y.data.length<ee)&&(Y=Shader._instancing_arrays[X]={data:new Float32Array(ee),buffer:f.createBuffer()}),Y.uniform=Q,Y.element_size=J,te.constructor===Array)for(var $=0;$<te.length;++$)Y.data.set(te[$],$*J);else Y.data.set(te);if(f.bindBuffer(f.ARRAY_BUFFER,Y.buffer),f.bufferData(f.ARRAY_BUFFER,Y.data,f.STREAM_DRAW),J==16)for(var W=0;W<4;++W)f.enableVertexAttribArray(D+W),f.vertexAttribPointer(D+W,4,f.FLOAT,!1,16*4,W*4*4),z?z.vertexAttribDivisorANGLE(D+W,1):f.vertexAttribDivisor(D+W,1);else f.enableVertexAttribArray(D),f.vertexAttribPointer(D,J,f.FLOAT,!1,J*4,0),z?z.vertexAttribDivisorANGLE(D,1):f.vertexAttribDivisor(D,1);X+=1}h&&(k=h),z?O?(f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,O.buffer),z.drawElementsInstancedANGLE(t,p,O.buffer.gl_type,B,k),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null)):z.drawArraysInstancedANGLE(t,B,p,k):O?(f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,O.buffer),f.drawElementsInstanced(t,p,O.buffer.gl_type,B,k),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null)):f.drawArraysInstanced(t,B,p,k);for(var ie=0;ie<X;++ie){var K=Shader._instancing_arrays[ie],D=this.attributes[K.uniform],J=K.element_size;if(J==16)for(var W=0;W<4;++W)f.disableVertexAttribArray(D+W),z?z.vertexAttribDivisorANGLE(D+W,0):f.vertexAttribDivisor(D+W,0);else f.enableVertexAttribArray(D),z?z.vertexAttribDivisorANGLE(D,0):f.vertexAttribDivisor(D,0)}return this}},Shader.expandImports=function(e,t){t=t||Shader.files;var r={};if(!t)throw"Shader.files not initialized, assign files there";var s=function(a){var o=a.split('"'),h=o[1];if(r[h])return"//already imported: "+h+`
`;var f=t[h];return r[h]=!0,f?f+`
`:"//import code not found: "+h+`
`};return e.replace(/#import\s+\"([a-zA-Z0-9_\.]+)\"\s*\n/g,s)},Shader.dumpErrorToConsole=function(e,t,r){console.error(e),e.msg;var s=null;e.indexOf("Fragment")!=-1?s=r:s=t;var a=s.split(`
`);for(var o in a)a[o]=o+"| "+a[o];console.groupCollapsed("Shader code"),console.log(a.join(`
`)),console.groupEnd()},Shader.convertTo100=function(e,t){},Shader.convertTo300=function(e,t){},Shader.validateValue=function(e,t){if(e==null)return!1;switch(t.type){case n.INT:case n.FLOAT:case n.SAMPLER_2D:case n.SAMPLER_3D:case n.SAMPLER_CUBE:case n.INT_SAMPLER_2D:case n.INT_SAMPLER_3D:case n.INT_SAMPLER_CUBE:case n.UNSIGNED_INT_SAMPLER_2D:case n.UNSIGNED_INT_SAMPLER_3D:case n.UNSIGNED_INT_SAMPLER_CUBE:return isNumber(e);case n.INT_VEC2:case n.FLOAT_VEC2:return e.length===2;case n.INT_VEC3:case n.FLOAT_VEC3:return e.length===3;case n.INT_VEC4:case n.FLOAT_VEC4:case n.FLOAT_MAT2:return e.length===4;case n.FLOAT_MAT3:return e.length===8;case n.FLOAT_MAT4:return e.length===16}return!0},Shader.DEFAULT_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec3 a_normal;
			attribute vec2 a_coord;
			varying vec3 v_position;
			varying vec3 v_normal;
			varying vec2 v_coord;
			uniform mat4 u_model;
			uniform mat4 u_mvp;
			void main() {
				v_position = (u_model * vec4(a_vertex,1.0)).xyz;
				v_normal = (u_model * vec4(a_normal,0.0)).xyz;
				v_coord = a_coord;
				gl_Position = u_mvp * vec4(a_vertex,1.0);
			}
			`,Shader.SCREEN_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			void main() { 
				v_coord = a_coord; 
				gl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); 
			}
			`,Shader.SCREEN_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = texture2D(u_texture, v_coord);
			}
			`,Shader.SCREEN_FRAGMENT_FX=`
			precision highp float;
			uniform sampler2D u_texture;
			varying vec2 v_coord;
			#ifdef FX_UNIFORMS
				FX_UNIFORMS
			#endif
			void main() {
				vec2 uv = v_coord;
				vec4 color = texture2D(u_texture, uv);
				#ifdef FX_CODE
					FX_CODE ;
				#endif
				gl_FragColor = color;
			}
			`,Shader.SCREEN_COLORED_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = u_color * texture2D(u_texture, v_coord);
			}
			`,Shader.BLEND_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform sampler2D u_texture2;
			uniform float u_factor;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);
			}
			`,Shader.QUAD_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			uniform vec2 u_position;
			uniform vec2 u_size;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			void main() { 
				vec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);
				v_coord = a_coord; 
				pos = u_transform * pos;
				pos.z = 0.0;
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
			}
			`,Shader.QUAD_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			varying vec2 v_coord;
			void main() {
				gl_FragColor = u_color * texture2D(u_texture, v_coord);
			}
			`,Shader.QUAD2_FRAGMENT_SHADER=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			uniform vec4 u_texture_area;
			varying vec2 v_coord;
			void main() {
			    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );
				gl_FragColor = u_color * texture2D(u_texture, uv);
			}
			`,Shader.PRIMITIVE2D_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			void main() { 
				vec3 pos = a_vertex;
				pos = u_transform * pos;
				pos.z = 0.0;
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
			}
			`,Shader.FLAT_VERTEX_SHADER=`
			precision highp float;
			attribute vec3 a_vertex;
			uniform mat4 u_mvp;
			void main() { 
				gl_Position = u_mvp * vec4(a_vertex,1.0); 
			}
			`,Shader.FLAT_FRAGMENT_SHADER=`
			precision highp float;
			uniform vec4 u_color;
			void main() {
				gl_FragColor = u_color;
			}
			`,Shader.SCREEN_FLAT_FRAGMENT_SHADER=Shader.FLAT_FRAGMENT_SHADER,Shader.createFX=function(e,t,r){e=n.Shader.removeComments(e,!0),t=n.Shader.removeComments(t,!0);var s={FX_CODE:e,FX_UNIFORMS:t||""};return r?(r.updateShader(n.Shader.SCREEN_VERTEX_SHADER,n.Shader.SCREEN_FRAGMENT_FX,s),r):new n.Shader(n.Shader.SCREEN_VERTEX_SHADER,n.Shader.SCREEN_FRAGMENT_FX,s)},Shader.replaceCodeUsingContext=function(e,t){return e.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(r){return r=r.replace(/[\{\}]/g,""),t[r]||""})},Shader.removeComments=function(s,t){if(!s)return"";for(var r=/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(\/\/.*)/g,s=s.replace(r,""),a=s.split(`
`),o=[],h=0;h<a.length;++h){var f=a[h],p=f.indexOf("//");p!=-1&&(f=a[h].substr(0,p)),f=f.trim(),f.length&&o.push(f)}return o.join(t?"":`
`)},Shader.prototype.toViewport=function(e){var t=n.Mesh.getScreenQuad();e&&this.uniforms(e),this.draw(t)},Shader.getScreenShader=function(e){e=e||l.gl;var t=e.shaders[":screen"];return t||(t=e.shaders[":screen"]=new n.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER),t.uniforms({u_texture:0}))},Shader.getFlatScreenShader=function(e){e=e||l.gl;var t=e.shaders[":flat_screen"];return t||(t=e.shaders[":flat_screen"]=new n.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER),t.uniforms({u_color:[1,1,1,1]}))},Shader.getColoredScreenShader=function(e){e=e||l.gl;var t=e.shaders[":colored_screen"];return t||(t=e.shaders[":colored_screen"]=new n.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER),t.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)}))},Shader.getQuadShader=function(e){e=e||l.gl;var t=e.shaders[":quad"];return t||(e.shaders[":quad"]=new n.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER))},Shader.getPartialQuadShader=function(e){e=e||l.gl;var t=e.shaders[":quad2"];return t||(e.shaders[":quad2"]=new n.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER))},Shader.getBlendShader=function(e){e=e||l.gl;var t=e.shaders[":blend"];return t||(e.shaders[":blend"]=new n.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.BLEND_FRAGMENT_SHADER))},Shader.getBlurShader=function(e){e=e||l.gl;var t=e.shaders[":blur"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_offset;
			uniform float u_intensity;
			void main() {
			   vec4 sum = vec4(0.0);
			   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;
			   sum += texture2D(u_texture, v_coord) * 0.16/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;
			   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;
			   gl_FragColor = u_intensity * sum;
			}
			`);return e.shaders[":blur"]=t},Shader.getCopyDepthShader=function(e){e=e||l.gl;var t=e.shaders[":copy_depth"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			#extension GL_EXT_frag_depth : enable
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			void main() {
			   gl_FragDepthEXT = texture2D( u_texture, v_coord ).x;
			   gl_FragColor = vec4(1.0);
			}
			`);return e.shaders[":copy_depth"]=t},Shader.getCubemapShowShader=function(e){e=e||l.gl;var t=e.shaders[":show_cubemap"];if(t)return t;var t=new n.Shader(Shader.DEFAULT_VERTEX_SHADER,`
			precision highp float;
			varying vec3 v_normal;
			uniform samplerCube u_texture;
			void main() {
			   gl_FragColor = textureCube( u_texture, v_normal );
			}
			`);return t.uniforms({u_texture:0}),e.shaders[":show_cubemap"]=t},Shader.getPolarToCubemapShader=function(e){e=e||l.gl;var t=e.shaders[":polar_to_cubemap"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform mat3 u_rotation;
			void main() {
				vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );
				vec3 dir = normalize( vec3( uv - vec2(0.5), 0.5 ));
				dir = u_rotation * dir;
				float u = atan(dir.x,dir.z) / 6.28318531;
				float v = (asin(dir.y) / 1.57079633) * 0.5 + 0.5;
				u = mod(u,1.0);
				v = mod(v,1.0);
			   gl_FragColor = texture2D( u_texture, vec2(u,v) );
			}
			`);return e.shaders[":polar_to_cubemap"]=t},Shader.getCubemapCopyShader=function(e){e=e||l.gl;var t=e.shaders[":copy_cubemap"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform samplerCube u_texture;
			uniform mat3 u_rotation;
			void main() {
				vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );
				vec3 dir = vec3( uv - vec2(0.5), 0.5 );
				dir = u_rotation * dir;
			   gl_FragColor = textureCube( u_texture, dir );
			}
			`);return e.shaders[":copy_cubemap"]=t},Shader.getCubemapBlurShader=function(e){e=e||l.gl;var t=e.shaders[":blur_cubemap"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			#ifndef NUM_SAMPLES
				#define NUM_SAMPLES 4
			#endif
			
			precision highp float;
			varying vec2 v_coord;
			uniform samplerCube u_texture;
			uniform mat3 u_rotation;
			uniform vec2 u_offset;
			uniform float u_intensity;
			void main() {
				vec4 sum = vec4(0.0);
				vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);
				vec3 dir = vec3(0.0);
				vec4 color = vec4(0.0);
				for( int x = -2; x <= 2; x++ )
				{
					for( int y = -2; y <= 2; y++ )
					{
						dir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;
						dir.z = 0.5;
						dir = u_rotation * dir;
						color = textureCube( u_texture, dir );
						color.xyz = color.xyz * color.xyz;/*linearize*/
						sum += color;
					}
				}
				sum /= 25.0;
			   gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;
			}
			`);return e.shaders[":blur_cubemap"]=t},Shader.FXAA_FUNC=`
	uniform vec2 u_viewportSize;
	uniform vec2 u_iViewportSize;
	#define FXAA_REDUCE_MIN   (1.0/ 128.0)
	#define FXAA_REDUCE_MUL   (1.0 / 8.0)
	#define FXAA_SPAN_MAX     8.0
	
	/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */
	/* fragCoord MUST BE IN PIXELS */
	vec4 applyFXAA(sampler2D tex, vec2 fragCoord)
	{
		vec4 color = vec4(0.0);
		/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/
		vec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;
		vec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;
		vec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;
		vec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;
		vec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;
		vec3 luma = vec3(0.299, 0.587, 0.114);
		float lumaNW = dot(rgbNW, luma);
		float lumaNE = dot(rgbNE, luma);
		float lumaSW = dot(rgbSW, luma);
		float lumaSE = dot(rgbSE, luma);
		float lumaM  = dot(rgbM,  luma);
		float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
		float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));
		
		vec2 dir;
		dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
		dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));
		
		float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
		
		float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
		dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;
		
		vec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + 
			texture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);
		vec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + 
			texture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);
		
		//return vec4(rgbA,1.0);
		float lumaB = dot(rgbB, luma);
		if ((lumaB < lumaMin) || (lumaB > lumaMax))
			color = vec4(rgbA, 1.0);
		else
			color = vec4(rgbB, 1.0);
		return color;
	}
`,Shader.getFXAAShader=function(e){e=e||l.gl;var t=e.shaders[":fxaa"];if(t)return t;var t=new n.Shader(Shader.SCREEN_VERTEX_SHADER,`
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			`+Shader.FXAA_FUNC+`
			
			void main() {
			   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;
			}
			`),r=vec2.fromValues(e.viewport_data[2],e.viewport_data[3]),s=vec2.fromValues(1/e.viewport_data[2],1/e.viewport_data[3]);return t.setup=function(){r[0]=e.viewport_data[2],r[1]=e.viewport_data[3],s[0]=1/e.viewport_data[2],s[1]=1/e.viewport_data[3],this.uniforms({u_viewportSize:r,u_iViewportSize:s})},e.shaders[":fxaa"]=t},Shader.getFlatShader=function(e){e=e||l.gl;var t=e.shaders[":flat"];if(t)return t;var t=new n.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);return t.uniforms({u_color:[1,1,1,1]}),e.shaders[":flat"]=t},n.create=function(e){e=e||{};var t=null;if(e.canvas)if(typeof e.canvas=="string"){if(t=document.getElementById(e.canvas),!t)throw"Canvas element not found: "+e.canvas}else t=e.canvas;else{var r=null;if(e.container&&(r=e.container.constructor===String?document.querySelector(e.container):e.container),r&&!e.width){var s=r.getBoundingClientRect();e.width=s.width,e.height=s.height}t=createCanvas(e.width||800,e.height||600),r&&r.appendChild(t)}"alpha"in e||(e.alpha=!1);var a=null,o=null;if(e.version==2?o=["webgl2","experimental-webgl2"]:e.version==1||e.version===void 0?o=["webgl","experimental-webgl"]:e.version===0&&(o=["webgl2","experimental-webgl2","webgl","experimental-webgl"]),!o)throw"Incorrect WebGL version, must be 1 or 2";for(var h={alpha:e.alpha===void 0?!0:e.alpha,depth:e.depth===void 0?!0:e.depth,stencil:e.stencil===void 0?!0:e.stencil,antialias:e.antialias===void 0?!0:e.antialias,premultipliedAlpha:e.premultipliedAlpha===void 0?!0:e.premultipliedAlpha,preserveDrawingBuffer:e.preserveDrawingBuffer===void 0?!0:e.preserveDrawingBuffer},f=0;f<o.length;++f){try{a=t.getContext(o[f],h)}catch{}if(a)break}if(!a)throw t.getContext("webgl")?"WebGL supported but not with those parameters":"WebGL not supported";a.webgl_version=a.constructor.name==="WebGL2RenderingContext"?2:1,l.gl=a,t.is_webgl=!0,t.gl=a,a.context_id=this.last_context_id++,a.extensions={};for(var p=a.getSupportedExtensions(),f=0;f<p.length;++f)a.extensions[p[f]]=a.getExtension(p[f]);if(a.webgl_version==1?a.HIGH_PRECISION_FORMAT=a.extensions.OES_texture_half_float?n.HALF_FLOAT_OES:a.extensions.OES_texture_float?n.FLOAT:n.UNSIGNED_BYTE:a.HIGH_PRECISION_FORMAT=n.HALF_FLOAT_OES,a.max_texture_units=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS),a._viewport_func?console.warn("Creating LiteGL context over the same canvas twice"):(a._viewport_func=a.viewport,a.viewport_data=new Float32Array([0,0,a.canvas.width,a.canvas.height]),a.viewport=function(D,J,ee,Y){var $=this.viewport_data;$[0]=D|0,$[1]=J|0,$[2]=ee|0,$[3]=Y|0,this._viewport_func(D,J,ee,Y)},a.getViewport=function(D){return D?(D[0]=a.viewport_data[0],D[1]=a.viewport_data[1],D[2]=a.viewport_data[2],D[3]=a.viewport_data[3],D):new Float32Array(a.viewport_data)},a.setViewport=function(D,J){a.viewport_data.set(D),J&&(a.viewport_data[1]=this.drawingBufferHeight-D[1]-D[3]),this._viewport_func(D[0],a.viewport_data[1],D[2],D[3])}),!n.reverse){n.reverse={};for(var f in a)a[f]&&a[f].constructor===Number&&(n.reverse[a[f]]=f)}if(window.glMatrix==null)throw"glMatrix not found, LiteGL requires glMatrix to be included";var T=0;a.shaders={},a.textures={},a.meshes={},a.draw_calls=0,a.makeCurrent=function(){l.gl=this},a.execute=function(D){var J=l.gl;l.gl=this,D(),l.gl=J},a.animate=function(D){if(D===!1){l.cancelAnimationFrame(this._requestFrame_id),this._requestFrame_id=null;return}var J=l.requestAnimationFrame,ee=getTime(),Y=this,$=0;function W(){if(!a.destroyed){Y._requestFrame_id=J(W);var ie=getTime(),K=(ie-ee)*.001;if(Y.mouse&&(Y.mouse.last_buttons=$),$=Y.mouse.buttons,Y.onupdate&&Y.onupdate(K),F.trigger(Y,"update",K),Y.ondraw){var se=l.gl;l.gl=Y,Y.ondraw(),F.trigger(Y,"draw"),l.gl=se}ee=ie}}this._requestFrame_id=J(W)},a.destroy=function(){k&&(document.removeEventListener("keydown",k),document.removeEventListener("keyup",k)),b&&(this.canvas.removeEventListener("mousedown",b),this.canvas.removeEventListener("mousemove",b),this.canvas.removeEventListener("mouseup",b),this.canvas.addEventListener("drag",b),this.canvas.addEventListener("dragstart",b),this.canvas.addEventListener("wheel",b));for(var D in this.shaders)this.shaders[D].delete(),this.shaders[D]=null;this.shaders={};for(var D in this.meshes)this.meshes[D].deleteBuffers(),this.meshes[D]=null;this.meshes={};for(var D in this.textures)this.textures[D].delete(),this.textures[D]=null;this.textures={},this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.destroyed=!0,l.gl==this&&(l.gl=null)};var _=a.mouse={buttons:0,last_buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,clientx:0,clienty:0,isInsideRect:function(D,J,ee,Y,$){var W=this.y;return $&&(W=a.canvas.height-W),this.x>D&&this.x<D+ee&&W>J&&W<J+Y},isButtonPressed:function(D){if(D==n.LEFT_MOUSE_BUTTON)return this.buttons&n.LEFT_MOUSE_BUTTON_MASK;if(D==n.MIDDLE_MOUSE_BUTTON)return this.buttons&n.MIDDLE_MOUSE_BUTTON_MASK;if(D==n.RIGHT_MOUSE_BUTTON)return this.buttons&n.RIGHT_MOUSE_BUTTON_MASK},wasButtonPressed:function(D){var J=0;return D==n.LEFT_MOUSE_BUTTON?J=n.LEFT_MOUSE_BUTTON_MASK:D==n.MIDDLE_MOUSE_BUTTON?J=n.MIDDLE_MOUSE_BUTTON_MASK:D==n.RIGHT_MOUSE_BUTTON&&(J=n.RIGHT_MOUSE_BUTTON_MASK),this.buttons&J&&!(this.last_buttons&J)}};a.captureMouse=function(D,J){t.addEventListener("mousedown",S),t.addEventListener("mousemove",S),t.addEventListener("drag",S),t.addEventListener("dragstart",S),D&&(t.addEventListener("mousewheel",S,!1),t.addEventListener("wheel",S,!1)),t.addEventListener("contextmenu",function(ee){return ee.preventDefault(),!1}),J&&this.captureTouch(!0)};function S(D){if(!a.ignore_events){var J=a.mouse.buttons;n.augmentEvent(D,t),D.eventType=D.eventType||D.type;var ee=getTime();if(_.dragging=D.dragging,_.position[0]=D.canvasx,_.position[1]=D.canvasy,_.x=D.canvasx,_.y=D.canvasy,_.mousex=D.mousex,_.mousey=D.mousey,_.canvasx=D.canvasx,_.canvasy=D.canvasy,_.clientx=D.mousex,_.clienty=D.mousey,_.buttons=D.buttons,_.left_button=!!(_.buttons&n.LEFT_MOUSE_BUTTON_MASK),_.middle_button=!!(_.buttons&n.MIDDLE_MOUSE_BUTTON_MASK),_.right_button=!!(_.buttons&n.RIGHT_MOUSE_BUTTON_MASK),D.eventType=="mousedown"){if(J==0){t.removeEventListener("mousemove",S);var Y=t.ownerDocument;Y.addEventListener("mousemove",S),Y.addEventListener("mouseup",S)}T=ee,a.onmousedown&&a.onmousedown(D),F.trigger(a,"mousedown")}else if(D.eventType=="mousemove")a.onmousemove&&a.onmousemove(D),F.trigger(a,"mousemove",D);else if(D.eventType=="mouseup"){if(a.mouse.buttons==0){t.addEventListener("mousemove",S);var Y=t.ownerDocument;Y.removeEventListener("mousemove",S),Y.removeEventListener("mouseup",S)}D.click_time=ee-T,a.onmouseup&&a.onmouseup(D),F.trigger(a,"mouseup",D)}else D.eventType=="mousewheel"||D.eventType=="wheel"||D.eventType=="DOMMouseScroll"?(D.eventType="mousewheel",D.type=="wheel"?D.wheel=-D.deltaY:D.wheel=D.wheelDeltaY!=null?D.wheelDeltaY:D.detail*-60,D.delta=D.wheelDelta!==void 0?D.wheelDelta/40:D.deltaY?-D.deltaY/3:0,a.onmousewheel&&a.onmousewheel(D),F.trigger(a,"mousewheel",D)):D.eventType=="dragstart"&&(a.ondragstart&&a.ondragstart(D),F.trigger(a,"dragstart",D));if(a.onmouse&&a.onmouse(D),!D.skip_preventDefault)return D.eventType!="mousemove"&&D.stopPropagation(),D.preventDefault(),!1}}var b=S,M=!1;if(typeof Hammer<"u"){var G=new Hammer.Manager(t),O=new Hammer.Pinch({threshold:.3});G&&O&&(G.add(O),G.on("pinch",B))}function B(D){var J=D.srcEvent,ee="wheel",Y=document.createEvent("MouseEvent");Y.initMouseEvent(ee,!0,!0,window,1,J.screenX,J.screenY,J.clientX,J.clientY,!1,!1,!1,!1,0,null),Y.originalEvent=Y,Y.is_touch=!0;var $=!1;D.additionalEvent==="pinchin"?(Y.deltaY=1,$=!0):D.additionalEvent==="pinchout"&&(Y.deltaY=-1,$=!0),$&&(Y.pinchScaling=D.distance*.0312,J.target.dispatchEvent(Y)),J.preventDefault()}a.captureTouch=function(D){M=D,t.addEventListener("touchstart",H,!0),t.addEventListener("touchmove",H,!0),t.addEventListener("touchend",H,!0),t.addEventListener("touchcancel",H,!0),t.addEventListener("gesturestart",z),t.addEventListener("gesturechange",z),t.addEventListener("gestureend",z)};function H(D){var J=D.changedTouches,ee=J[0],Y="";if(!(a.ontouch&&a.ontouch(D)===!0)&&F.trigger(a,D.type,D)!==!0&&M&&!(D.touches.length&&D.changedTouches[0].identifier!==D.touches[0].identifier)&&!(J>1)){switch(D.type){case"touchstart":Y="mousedown";break;case"touchmove":Y="mousemove";break;case"touchend":Y="mouseup";break;default:return}var $=document.createEvent("MouseEvent");$.initMouseEvent(Y,!0,!0,window,1,ee.screenX,ee.screenY,ee.clientX,ee.clientY,!1,!1,!1,!1,0,null),$.originalEvent=$,$.is_touch=!0,ee.target.dispatchEvent($),D.preventDefault()}}function z(D){D.eventType=D.type,!(a.ongesture&&a.ongesture(D)===!1)&&F.trigger(a,D.type,D)!==!1&&D.preventDefault()}a.keys={};var k=null;a.captureKeys=function(D,J){if(k)return;a.keys={},J&&a.canvas,document.addEventListener("keydown",ee),document.addEventListener("keyup",ee);function ee(Y){X(Y,D)}k=ee};function X(D,J){D.eventType=D.type;var ee=D.target.nodeName.toLowerCase();if(!(ee==="input"||ee==="textarea"||ee==="select"||D.target.contentEditable==="true")){D.character=String.fromCharCode(D.keyCode).toLowerCase();var Y=!1,$=n.mapKeyCode(D.keyCode);$||($=D.character);var W=D.altKey||D.ctrlKey||D.metaKey;W||($&&(a.keys[$]=D.type=="keydown"),Y=a.keys[D.keyCode],a.keys[D.keyCode]=D.type=="keydown"),(Y!=a.keys[D.keyCode]||W)&&(D.type=="keydown"&&a.onkeydown?a.onkeydown(D):D.type=="keyup"&&a.onkeyup&&a.onkeyup(D),F.trigger(a,D.type,D)),a.onkey&&a.onkey(D),J&&(D.isChar||n.blockable_keys[D.keyIdentifier||D.key])&&D.preventDefault()}}a.gamepads=null,a.captureGamepads=function(){var D=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;D&&(this.gamepads=D.call(navigator))},a.getGamepads=function(D){var J=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(J){var ee=J.call(navigator);this.gamepads||(this.gamepads=[]);for(var Y=0;Y<4;Y++){var $=ee[Y];if($&&!D&&Q($),$&&!$.prev_buttons){$.prev_buttons=new Uint8Array(32);var W=new CustomEvent("gamepadconnected");W.eventType=W.type,W.gamepad=$,this.ongamepadconnected&&this.ongamepadconnected(W),F.trigger(a,"gamepadconnected",W)}if($)for(var ie=0;ie<$.buttons.length;++ie){var K=$.buttons[ie];if(K.was_pressed=!1,K.pressed&&!$.prev_buttons[ie]){K.was_pressed=!0;var W=new CustomEvent("gamepadButtonDown");W.eventType=W.type,W.button=K,W.which=ie,W.gamepad=$,a.onbuttondown&&a.onbuttondown(W),F.trigger(a,"buttondown",W)}else if(!K.pressed&&$.prev_buttons[ie]){var W=new CustomEvent("gamepadButtonUp");W.eventType=W.type,W.button=K,W.which=ie,W.gamepad=$,a.onbuttondown&&a.onbuttondown(W),F.trigger(a,"buttonup",W)}$.prev_buttons[ie]=K.pressed?1:0}}return this.gamepads=ee,ee}};function Q(D){var J=D.xbox||{axes:[],buttons:{},hat:""};J.axes.lx=D.axes[0],J.axes.ly=D.axes[1],J.axes.rx=D.axes[2],J.axes.ry=D.axes[3],J.axes.triggers=D.axes[4];for(var ee=0;ee<D.buttons.length;ee++)switch(ee){case 0:J.buttons.a=D.buttons[ee].pressed;break;case 1:J.buttons.b=D.buttons[ee].pressed;break;case 2:J.buttons.x=D.buttons[ee].pressed;break;case 3:J.buttons.y=D.buttons[ee].pressed;break;case 4:J.buttons.lb=D.buttons[ee].pressed;break;case 5:J.buttons.rb=D.buttons[ee].pressed;break;case 6:J.buttons.lt=D.buttons[ee].pressed;break;case 7:J.buttons.rt=D.buttons[ee].pressed;break;case 8:J.buttons.back=D.buttons[ee].pressed;break;case 9:J.buttons.start=D.buttons[ee].pressed;break;case 10:J.buttons.ls=D.buttons[ee].pressed;break;case 11:J.buttons.rs=D.buttons[ee].pressed;break;case 12:D.buttons[ee].pressed&&(J.hat+="up");break;case 13:D.buttons[ee].pressed&&(J.hat+="down");break;case 14:D.buttons[ee].pressed&&(J.hat+="left");break;case 15:D.buttons[ee].pressed&&(J.hat+="right");break;case 16:J.buttons.home=D.buttons[ee].pressed;break}D.xbox=J}a.fullscreen=function(){var D=this.canvas;D.requestFullScreen?D.requestFullScreen():D.webkitRequestFullScreen?D.webkitRequestFullScreen():D.mozRequestFullScreen?D.mozRequestFullScreen():console.error("Fullscreen not supported")},a.snapshot=function(D,J,ee,Y,$){var W=createCanvas(ee,Y),le=W.getContext("2d"),ie=le.getImageData(0,0,W.width,W.height),K=new Uint8Array(ee*Y*4);if(a.readPixels(D,J,W.width,W.height,a.RGBA,a.UNSIGNED_BYTE,K),ie.data.set(K),le.putImageData(ie,0,0),$)return W;var se=createCanvas(ee,Y),le=se.getContext("2d");return le.translate(0,Y),le.scale(1,-1),le.drawImage(W,0,0),se};var te={};return a.loadTexture=function(D,J,ee){if(this.textures[D])return this.textures[D];if(te[D])return null;var Y=new Image;return Y.url=D,Y.onload=function(){var $=n.Texture.fromImage(this,J);$.img=this,a.textures[this.url]=$,delete te[this.url],ee&&ee($)},Y.src=D,te[D]=!0,null},a.drawTexture=function(){var D=mat3.create(),J=vec2.create(),ee=vec2.create(),Y=vec4.create(),$=vec4.fromValues(1,1,1,1),W=vec2.create(),ie={u_texture:0,u_position:J,u_color:$,u_size:ee,u_texture_area:Y,u_viewport:W,u_transform:D};return function(K,se,le,ue,he,ve,I,V,Z,j,re){J[0]=se,J[1]=le,ue===void 0&&(ue=K.width),he===void 0&&(he=K.height),ee[0]=ue,ee[1]=he,ve===void 0&&(ve=0),I===void 0&&(I=0),V===void 0&&(V=K.width),Z===void 0&&(Z=K.height),Y[0]=ve/K.width,Y[1]=I/K.height,Y[2]=(ve+V)/K.width,Y[3]=(I+Z)/K.height,W[0]=this.viewport_data[2],W[1]=this.viewport_data[3],j=j||Shader.getPartialQuadShader(this);var ae=Mesh.getScreenQuad(this);K.bind(0),j.uniforms(ie),re&&j.uniforms(re),j.draw(ae,a.TRIANGLES)}}(),a.canvas.addEventListener("webglcontextlost",function(D){D.preventDefault(),a.context_lost=!0,a.onlosecontext&&a.onlosecontext(D)},!1),a.reset=function(){a.viewport(0,0,this.canvas.width,this.canvas.height),a.disable(a.BLEND),a.disable(a.CULL_FACE),a.disable(a.DEPTH_TEST),a.frontFace(a.CCW),a._current_texture_drawto=null,a._current_fbo_color=null,a._current_fbo_depth=null},a.dump=function(){console.log("userAgent: ",navigator.userAgent),console.log("Supported extensions:");var D=a.getSupportedExtensions();console.log(D.join(","));var J=["VENDOR","VERSION","MAX_VERTEX_ATTRIBS","MAX_VARYING_VECTORS","MAX_VERTEX_UNIFORM_VECTORS","MAX_VERTEX_TEXTURE_IMAGE_UNITS","MAX_FRAGMENT_UNIFORM_VECTORS","MAX_TEXTURE_SIZE","MAX_TEXTURE_IMAGE_UNITS"];console.log("WebGL info:");for(var ee in J)console.log(" * "+J[ee]+": "+a.getParameter(a[J[ee]]));console.log("*************************************************")},a.reset(),a},n.mapKeyCode=function(e){var t={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",33:"PAGEUP",34:"PAGEDOWN",35:"END",36:"HOME",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};return t[e]||(e>=65&&e<=90?String.fromCharCode(e):null)},n.dragging=!1,n.last_pos=[0,0],n.augmentEvent=function(e,t){var r=null;t=t||e.target||gl.canvas,r=t.getBoundingClientRect(),e.mousex=e.clientX-r.left,e.mousey=e.clientY-r.top,e.canvasx=e.mousex,e.canvasy=r.height-e.mousey,e.deltax=0,e.deltay=0,e.is_touch&&(gl.mouse.buttons=e.which),document.pointerLockElement===t&&(e.canvasx=e.mousex=r.width*.5,e.canvasy=e.mousey=r.height*.5),e.type=="mousedown"?this.dragging=!0:e.type=="mousemove"||e.type=="mouseup"&&e.buttons==0&&(this.dragging=!1),e.movementX!==void 0&&!e.is_touch&&!n.isMobile()?(e.deltax=e.movementX,e.deltay=e.movementY):(e.deltax=e.mousex-this.last_pos[0],e.deltay=e.mousey-this.last_pos[1]),this.last_pos[0]=e.mousex,this.last_pos[1]=e.mousey,e.dragging=this.dragging,e.leftButton=!!(gl.mouse.buttons&n.LEFT_MOUSE_BUTTON_MASK),e.middleButton=!!(gl.mouse.buttons&n.MIDDLE_MOUSE_BUTTON_MASK),e.rightButton=!!(gl.mouse.buttons&n.RIGHT_MOUSE_BUTTON_MASK),e.buttons_mask=0,e.leftButton&&(e.buttons_mask=1),e.middleButton&&(e.buttons_mask|=2),e.rightButton&&(e.buttons_mask|=4),e.isButtonPressed=function(s){return this.buttons_mask&1<<s}},n.isMobile=function(){return this.mobile!==void 0?this.mobile:l.navigator?navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/SamsungBrowser/i)||navigator.userAgent.match(/Mobile\ VR/i)||navigator.userAgent.match(/Android/i)?this.mobile=!0:this.mobile=!1:this.mobile=!1};var F=l.LEvent=n.LEvent={bind:function(e,t,r,s){if(!e)throw"cannot bind event to null";if(!r)throw"cannot bind to null callback";if(e.constructor===String)throw"cannot bind event to a string";var a=e.__levents;a||(Object.defineProperty(e,"__levents",{value:{},enumerable:!1}),a=e.__levents),a.hasOwnProperty(t)?a[t].push([r,s]):a[t]=[[r,s]],e.onLEventBinded&&e.onLEventBinded(t,r,s)},unbind:function(e,t,r,s){if(!e)throw"cannot unbind event to null";if(!r)throw"cannot unbind from null callback";if(e.constructor===String)throw"cannot bind event to a string";var a=e.__levents;if(a&&a.hasOwnProperty(t)){for(var o=0,h=a[t].length;o<h;++o){var f=a[t][o];if(f[0]===r&&f[1]===s){a[t].splice(o,1);break}}a[t].length==0&&delete a[t],e.onLEventUnbinded&&e.onLEventUnbinded(t,r,s)}},unbindAll:function(e,t,r){if(!e)throw"cannot unbind events in null";var s=e.__levents;if(s){if(e.onLEventUnbindAll&&e.onLEventUnbindAll(t,r),!t){delete e.__levents;return}for(var a in s)for(var o=s[a],h=o.length-1;h>=0;--h)o[h][1]!=t||r&&r!==o[h][0]||o.splice(h,1)}},unbindAllEvent:function(e,t){if(!e)throw"cannot unbind events in null";var r=e.__levents;r&&(delete r[t],e.onLEventUnbindAll&&e.onLEventUnbindAll(t,target_instance,callback))},isBind:function(e,t,r,s){if(!e)throw"LEvent cannot have null as instance";var a=e.__levents;if(a){if(!a.hasOwnProperty(t))return!1;for(var o=0,h=a[t].length;o<h;++o){var f=a[t][o];if(f[0]===r&&f[1]===s)return!0}return!1}},hasBind:function(e,t){if(!e)throw"LEvent cannot have null as instance";var r=e.__levents;return!(!r||!r.hasOwnProperty(t)||!r[t].length)},hasBindTo:function(e,t){if(!e)throw"LEvent cannot have null as instance";var r=e.__levents;if(!r)return!1;for(var s in r)for(var a=r[s],o=0;o<a.length;++o)if(a[o][1]===t)return!0;return!1},trigger:function(e,t,r,s,a){if(!e)throw"cannot trigger event from null";if(e.constructor===String)throw"cannot bind event to a string";var o=e.__levents;if(!o||!o.hasOwnProperty(t))return!1;var h=o[t];if(s)for(var f=h.length-1;f>=0;--f){var p=h[f];if(a){if(p&&p[0].apply(p[1],r)===!0)return!0}else if(p&&p[0].call(p[1],t,r)===!0)return!0}else for(var f=0,T=h.length;f<T;++f){var p=h[f];if(a){if(p&&p[0].apply(p[1],r)===!0)return!0}else if(p&&p[0].call(p[1],t,r)===!0)return!0}return!1},triggerArray:function(e,t,r,s,a){for(var o=!1,h=0,f=e.length;h<f;++h){var p=e[h];if(!p)throw"cannot trigger event from null";if(p.constructor===String)throw"cannot bind event to a string";var T=p.__levents;if(!(!T||!T.hasOwnProperty(t)))if(s)for(var _=T[t].length-1;_>=0;--_){var S=T[t][_];if(a){if(S[0].apply(S[1],r)===!0){o=!0;break}}else if(S[0].call(S[1],t,r)===!0){o=!0;break}}else for(var _=0,b=T[t].length;_<b;++_){var S=T[t][_];if(a){if(S[0].apply(S[1],r)===!0){o=!0;break}}else if(S[0].call(S[1],t,r)===!0){o=!0;break}}}return o},extendObject:function(e){e.bind=function(t,r,s){return F.bind(this,t,r,s)},e.trigger=function(t,r){return F.trigger(this,t,r)},e.unbind=function(t,r,s){return F.unbind(this,t,r,instance)},e.unbindAll=function(t,r){return F.unbindAll(this,t,r)}},extendClass:function(e){this.extendObject(e.prototype)}};l.CLIP_INSIDE=n.CLIP_INSIDE=0,l.CLIP_OUTSIDE=n.CLIP_OUTSIDE=1,l.CLIP_OVERLAP=n.CLIP_OVERLAP=2,l.geo={last_t:-1,createPlane:function(e,t){return new Float32Array([t[0],t[1],t[2],-vec3.dot(e,t)])},planeFromTriangle:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s,a,o,h){return vec3.sub(e,o,a),vec3.sub(t,h,a),vec3.cross(r,e,t),vec3.normalize(r,r),s[0]=r[0],s[1]=r[1],s[2]=r[2],s[3]=-vec3.dot(a,r),s}}(),computeTriangleNormal:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s,a,o,h){return vec3.sub(e,o,a),vec3.sub(t,h,a),vec3.cross(r,e,t),vec3.normalize(r,r),s[0]=r[0],s[1]=r[1],s[2]=r[2],s}}(),distancePointToPlane:function(e,t){return(vec3.dot(e,t)+t[3])/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},distance2PointToPlane:function(e,t){return(vec3.dot(e,t)+t[3])/(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},projectPointOnLine:function(){var e=vec3.create(),t=vec3.create();return function(r,s,a,o){o=o||vec3.create(),vec3.sub(e,r,s),vec3.sub(t,a,s);var h=vec3.dot(e,t)/vec3.dot(t,t);return o[0]=s[0]+h*t[0],o[1]=s[1]+h*t[1],o[2]=s[2]+h*t[2],o}}(),project2DPointOnLine:function(e,t,r,s){s=s||vec2.create();var a=vec2.fromValues(e[0]-t[0],e[1]-t[1]),o=vec2.fromValues(r[0]-t[0],r[1]-t[1]),h=vec2.dot(a,o)/vec2.dot(o,o);return s[0]=t[0]+h*o[0],s[1]=t[1]+h*o[1],s},closestPointToSegment:function(){var e=vec3.create(),t=vec3.create();return function(r,s,a,o){o=o||vec3.create(),vec3.sub(e,r,s),vec3.sub(t,a,s);var h=vec3.dot(e,t)/vec3.dot(t,t);return h=Math.min(1,Math.max(0,h)),o[0]=s[0]+h*t[0],o[1]=s[1]+h*t[1],o[2]=s[2]+h*t[2],o}}(),projectPointOnPlane:function(){var e=vec3.create();return function(t,r,s,a){a=a||vec3.create(),vec3.sub(e,t,r);var o=vec3.dot(e,s);return vec3.scale(e,s,o),vec3.sub(a,t,e)}}(),isPointInsideTriangle:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create(),o=vec3.create();return function(h,f,p,T){return vec3.sub(e,f,h),vec3.sub(t,p,h),vec3.sub(r,T,h),vec3.cross(s,t,r),vec3.cross(a,r,e),vec3.cross(o,e,t),!(vec3.dot(s,a)<0||vec3.dot(s,o)<0)}}(),reflectPointInPlane:function(e,t,r){var s=-1*(t[0]*r[0]+t[1]*r[1]+t[2]*r[2]),a=-(s+r[0]*e[0]+r[1]*e[1]+r[2]*e[2])/(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);return vec3.fromValues(e[0]+a*r[0]*2,e[1]+a*r[1]*2,e[2]+a*r[2]*2)},testRayPlane:function(e,t,r,s,a){var o=vec3.dot(r,s),h=o-vec3.dot(s,e),f=vec3.dot(s,t);if(Math.abs(f)<EPSILON)return!1;var p=this.last_t=h/f;return p<0?!1:(a&&vec3.add(a,e,vec3.scale(a,t,p)),!0)},testSegmentPlane:function(){var e=vec3.create();return function(t,r,s,a,o){var h=vec3.dot(s,a),f=h-vec3.dot(a,t),p=vec3.sub(e,r,t),T=vec3.dot(a,p);if(Math.abs(T)<EPSILON)return!1;var _=this.last_t=f/T;return _<0||_>1?!1:(o&&vec3.add(o,t,vec3.scale(o,p,_)),!0)}}(),testRaySphere:function(){var e=vec3.create();return function(t,r,s,a,o,h){var f=vec3.subtract(e,t,s),p=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],T=2*f[0]*r[0]+2*f[1]*r[1]+2*f[2]*r[2],_=f[0]*f[0]+f[1]*f[1]+f[2]*f[2]-a*a,S=T*T-4*p*_;if(S<0)return!1;if(o){var b=Math.sqrt(S),M=1/(2*p),G=(-T+b)*M,O=(-T-b)*M,B=G<O?G:O;if(h!==void 0&&B>h)return!1;this.last_t=B,vec3.add(o,t,vec3.scale(o,r,B))}return!0}}(),hitTestTriangle:function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create();return function(o,h,f,p,T,_){vec3.subtract(e,p,f),vec3.subtract(t,T,f),vec3.cross(r,e,t),vec3.normalize(r,r);var S=vec3.dot(r,vec3.subtract(s,f,o))/vec3.dot(r,h);if(S>0){vec3.add(a,o,vec3.scale(s,h,S));var b=vec3.subtract(s,s,f),M=vec3.dot(t,t),G=vec3.dot(t,e),O=vec3.dot(t,b),B=vec3.dot(e,e),H=vec3.dot(e,b),z=M*B-G*G,k=(B*O-G*H)/z,X=(M*H-G*O)/z;if(k>=0&&X>=0&&k+X<=1)return this.last_t=S,_&&vec3.add(_,o,vec3.scale(s,h,S)),!0}return!1}}(),testRayCylinder:function(e,t,r,s,a,o){var h=vec3.clone(e),f=vec3.add(vec3.create(),e,vec3.scale(vec3.create(),t,1e5)),p=0,T=vec3.subtract(vec3.create(),s,r),_=vec3.subtract(vec3.create(),h,r),S=vec3.subtract(vec3.create(),f,h),b=vec3.dot(_,T),M=vec3.dot(S,T),G=vec3.dot(T,T);if(b<0&&b+M<0||b>G&&b+M>G)return!1;var O=vec3.dot(S,S),B=vec3.dot(_,S),H=G*O-M*M,z=vec3.dot(_,_)-a*a,k=G*z-b*b;if(Math.abs(H)<EPSILON)return k>0?!1:(b<0?p=-B/O:b>G?p=(M-B)/O:p=0,o&&vec3.add(o,h,vec3.scale(o,S,p)),!0);var X=G*B-M*b,Q=X*X-H*k;return Q<0||(p=(-X-Math.sqrt(Q))/H,p<0||p>1)?!1:b+p*M<0?M<=0?!1:(p=-b/M,o&&vec3.add(o,h,vec3.scale(o,S,p)),z+2*p*(B+p*O)<=0):b+p*M>G?M>=0?!1:(p=(G-b)/M,o&&vec3.add(o,h,vec3.scale(o,S,p)),z+G-2*b+p*(2*(B-M)+p*O)<=0):(this.last_t=p,o&&vec3.add(o,h,vec3.scale(o,S,p)),!0)},testRayBox:function(){var e=new Float32Array(3),t=new Float32Array(3),r=new Float32Array(3);return function(s,a,o,h,f,p){p=p||Number.MAX_VALUE;var T=!0,_=0,S;for(e.fill(0),r.fill(0),t.fill(0),_=0;_<3;++_)s[_]<o[_]?(e[_]=1,t[_]=o[_],T=!1):s[_]>h[_]?(e[_]=0,t[_]=h[_],T=!1):e[_]=2;if(T)return this.last_t=0,f&&vec3.copy(f,s),!0;for(_=0;_<3;++_)e[_]!=2&&a[_]!=0?r[_]=(t[_]-s[_])/a[_]:r[_]=-1;for(S=0,_=1;_<3;_++)r[S]<r[_]&&(S=_);if(r[S]<0||r[S]>p)return!1;for(this.last_t=r[S],_=0;_<3;++_)if(S!=_){var b=s[_]+r[S]*a[_];if(b<o[_]||b>h[_])return!1;f&&(f[_]=b)}else f&&(f[_]=t[_]);return!0}}(),testRayBBox:function(){var e=mat4.create(),t=vec3.create(),r=vec3.create();return function(s,a,o,h,f,p,T){if(!s||!a||!o)throw"parameters missing";h&&(mat4.invert(e,h),vec3.add(t,s,a),s=vec3.transformMat4(r,s,e),vec3.transformMat4(t,t,e),vec3.sub(t,t,s),a=vec3.normalize(t,t));var _=this.testRayBox(s,a,o.subarray(6,9),o.subarray(9,12),f,p);return!T&&h&&f&&vec3.transformMat4(f,f,h),_}}(),testPointBBox:function(e,t){return!(e[0]<t[6]||e[0]>t[9]||e[1]<t[7]||e[0]>t[10]||e[2]<t[8]||e[0]>t[11])},testBBoxBBox:function(e,t){var r=Math.abs(t[0]-e[0]);if(r>e[3]+t[3])return!1;var s=Math.abs(t[1]-e[1]);if(s>e[4]+t[4])return!1;var a=Math.abs(t[2]-e[2]);if(a>e[5]+t[5])return!1;var o=BBox.getMin(t);if(geo.testPointBBox(o,e)){var h=BBox.getMax(t);if(geo.testPointBBox(h,e))return!0}return!0},testSphereBBox:function(e,t,r){for(var s,a=0,o=BBox.getMin(r),h=BBox.getMax(r),f=0;f<3;++f)e[f]<o[f]?(s=e[f]-o[f],a+=s*s):e[f]>h[f]&&(s=e[f]-h[f],a+=s*s);var p=t*t;return a<=p},closestPointBetweenLines:function(e,t,r,s,a,o){var h=vec3.subtract(vec3.create(),t,e),f=vec3.subtract(vec3.create(),s,r),p=vec3.subtract(vec3.create(),e,r),T=vec3.dot(h,h),_=vec3.dot(h,f),S=vec3.dot(f,f),b=vec3.dot(h,p),M=vec3.dot(f,p),G=T*S-_*_,O,B;G<EPSILON?(O=0,B=_>S?b/_:M/S):(O=(_*M-S*b)/G,B=(T*M-_*b)/G),a&&vec3.add(a,e,vec3.scale(vec3.create(),h,O)),o&&vec3.add(o,r,vec3.scale(vec3.create(),f,B));var H=vec3.add(vec3.create(),p,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),h,O),vec3.scale(vec3.create(),f,B)));return vec3.length(H)},extractPlanes:function(e,r){var r=r||new Float32Array(24);return r.set([e[3]-e[0],e[7]-e[4],e[11]-e[8],e[15]-e[12]],0),s(0),r.set([e[3]+e[0],e[7]+e[4],e[11]+e[8],e[15]+e[12]],4),s(4),r.set([e[3]+e[1],e[7]+e[5],e[11]+e[9],e[15]+e[13]],8),s(8),r.set([e[3]-e[1],e[7]-e[5],e[11]-e[9],e[15]-e[13]],12),s(12),r.set([e[3]-e[2],e[7]-e[6],e[11]-e[10],e[15]-e[14]],16),s(16),r.set([e[3]+e[2],e[7]+e[6],e[11]+e[10],e[15]+e[14]],20),s(20),r;function s(a){var o=r.subarray(a,a+3),h=vec3.length(o);h!==0&&(h=1/h,r[a]*=h,r[a+1]*=h,r[a+2]*=h,r[a+3]*=h)}},frustumTestBox:function(e,t){var r=0,s=0;return r=planeBoxOverlap(e.subarray(0,4),t),r==CLIP_OUTSIDE||(s+=r,r=planeBoxOverlap(e.subarray(4,8),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(e.subarray(8,12),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(e.subarray(12,16),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(e.subarray(16,20),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(e.subarray(20,24),t),r==CLIP_OUTSIDE)?CLIP_OUTSIDE:(s+=r,s==0?CLIP_INSIDE:CLIP_OVERLAP)},frustumTestSphere:function(e,t,r){var s,a=!1;return s=distanceToPlane(e.subarray(0,4),t),s<-r||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(e.subarray(4,8),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(e.subarray(8,12),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(e.subarray(12,16),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(e.subarray(16,20),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(e.subarray(20,24),t),s<-r)?CLIP_OUTSIDE:(s>=-r&&s<=r&&(a=!0),a?CLIP_OVERLAP:CLIP_INSIDE)},testPoint2DInPolygon:function(e,t){for(var r=!1,s=-1,a=e.length,o=a-1;++s<a;o=s)(e[s][1]<=t[1]&&t[1]<e[o][1]||e[o][1]<=t[1]&&t[1]<e[s][1])&&t[0]<(e[o][0]-e[s][0])*(t[1]-e[s][1])/(e[o][1]-e[s][1])+e[s][0]&&(r=!r);return r}},l.BBox=n.BBox={center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:[vec3.fromValues(1,1,1),vec3.fromValues(1,1,-1),vec3.fromValues(1,-1,1),vec3.fromValues(1,-1,-1),vec3.fromValues(-1,1,1),vec3.fromValues(-1,1,-1),vec3.fromValues(-1,-1,1),vec3.fromValues(-1,-1,-1)],create:function(){return new Float32Array(13)},clone:function(e){return new Float32Array(e)},copy:function(e,t){return e.set(t),e},fromPoint:function(e){var t=this.create();return t.set(e,0),t.set(e,6),t.set(e,9),t},fromMinMax:function(e,t){var r=this.create();return this.setMinMax(r,e,t),r},fromCenterHalfsize:function(e,t){var r=this.create();return this.setCenterHalfsize(r,e,t),r},fromPoints:function(e){var t=this.create();return this.setFromPoints(t,e),t},setFromPoints:function(e,t){var r=e.subarray(6,9),s=e.subarray(9,12);r[0]=t[0],r[1]=t[1],r[2]=t[2],s.set(r);for(var a=3,o=t.length;a<o;a+=3){var h=t[a],f=t[a+1],p=t[a+2];h<r[0]?r[0]=h:h>s[0]&&(s[0]=h),f<r[1]?r[1]=f:f>s[1]&&(s[1]=f),p<r[2]?r[2]=p:p>s[2]&&(s[2]=p)}return e[0]=(r[0]+s[0])*.5,e[1]=(r[1]+s[1])*.5,e[2]=(r[2]+s[2])*.5,e[3]=s[0]-e[0],e[4]=s[1]-e[1],e[5]=s[2]-e[2],e[12]=Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]),e},setMinMax:function(e,t,r){e[6]=t[0],e[7]=t[1],e[8]=t[2],e[9]=r[0],e[10]=r[1],e[11]=r[2];var s=e.subarray(3,6);return vec3.sub(s,r,t),vec3.scale(s,s,.5),e[0]=r[0]-s[0],e[1]=r[1]-s[1],e[2]=r[2]-s[2],e[12]=vec3.length(e.subarray(3,6)),e},setCenterHalfsize:function(e,t,r,s){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=r[0],e[4]=r[1],e[5]=r[2],e[6]=e[0]-e[3],e[7]=e[1]-e[4],e[8]=e[2]-e[5],e[9]=e[0]+e[3],e[10]=e[1]+e[4],e[11]=e[2]+e[5],s?e[12]=s:e[12]=vec3.length(r),e},transformMat4:function(){for(var e=0,t=0,r=0,s=new Float32Array(8*3),a=[],o=0;o<24;o+=3)a.push(s.subarray(o,o+3));return function(h,f,p){var T=f[0],_=f[1],S=f[2];e=f[3],t=f[4],r=f[5];for(var b=this.corners,M=0;M<8;++M){var G=b[M],O=a[M];O[0]=e*G[0]+T,O[1]=t*G[1]+_,O[2]=r*G[2]+S,mat4.multiplyVec3(O,p,O)}return this.setFromPoints(h,s)}}(),getCorners:function(e,t){var r=e,s=e.subarray(3,6),a=null;t?(t.set(this.corners),a=t):a=new Float32Array(this.corners);for(var o=0;o<8;++o){var h=a.subarray(o*3,o*3+3);vec3.multiply(h,s,h),vec3.add(h,h,r)}return a},merge:function(e,t,r){var s=e.subarray(6,9),a=e.subarray(9,12);return vec3.min(s,t.subarray(6,9),r.subarray(6,9)),vec3.max(a,t.subarray(9,12),r.subarray(9,12)),BBox.setMinMax(e,s,a)},extendToPoint:function(e,t){t[0]<e[6]?e[6]=t[0]:t[0]>e[9]&&(e[9]=t[0]),t[1]<e[7]?e[7]=t[1]:t[1]>e[10]&&(e[10]=t[1]),t[2]<e[8]?e[8]=t[2]:t[2]>e[11]&&(e[11]=t[2]);var r=e.subarray(6,9),s=e.subarray(9,12),a=vec3.add(e.subarray(0,3),r,s);return vec3.scale(a,a,.5),vec3.subtract(e.subarray(3,6),s,a),e[12]=vec3.length(e.subarray(3,6)),e},clampPoint:function(e,t,r){e[0]=Math.clamp(r[0],t[0]-t[3],t[0]+t[3]),e[1]=Math.clamp(r[1],t[1]-t[4],t[1]+t[4]),e[2]=Math.clamp(r[2],t[2]-t[5],t[2]+t[5])},isPointInside:function(e,t){return!(e[0]-e[3]>t[0]||e[1]-e[4]>t[1]||e[2]-e[5]>t[2]||e[0]+e[3]<t[0]||e[1]+e[4]<t[1]||e[2]+e[5]<t[2])},getCenter:function(e){return e.subarray(0,3)},getHalfsize:function(e){return e.subarray(3,6)},getMin:function(e){return e.subarray(6,9)},getMax:function(e){return e.subarray(9,12)},getRadius:function(e){return e[12]}},l.distanceToPlane=n.distanceToPlane=function(t,r){return vec3.dot(t,r)+t[3]},l.planeBoxOverlap=n.planeBoxOverlap=function(t,r){var s=t,a=t[3],o=r,h=r,f=Math.abs(h[3]*s[0])+Math.abs(h[4]*s[1])+Math.abs(h[5]*s[2]),p=vec3.dot(s,o)+a;return p<=-f?CLIP_OUTSIDE:p<=f?CLIP_OVERLAP:CLIP_INSIDE},l.Octree=n.Octree=function(t,r,s){this.root=null,this.total_depth=0,this.total_nodes=0,t&&(this.buildFromMesh(t,r,s),this.total_nodes=this.trim())},Octree.MAX_NODE_TRIANGLES_RATIO=.1,Octree.MAX_OCTREE_DEPTH=8,Octree.OCTREE_MARGIN_RATIO=.01,Octree.OCTREE_MIN_MARGIN=.1,Octree.NEAREST=0,Octree.FIRST=1,Octree.ALL=2,Octree.prototype.buildFromMesh=function(e,t,r){this.total_depth=0,this.total_nodes=0,t=t||0;var s=e.getBuffer("vertices").data,a=e.getIndexBuffer("triangles");a&&(a=a.data),r||(r=a?a.length:s.length/3);var o=null;a?o=this.computeAABBFromIndices(s,a,t,r):o=this.computeAABB(s),this.root=o,this.total_nodes=1,this.total_triangles=a?a.length/3:s.length/9,this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var h=vec3.create();vec3.scale(h,o.size,Octree.OCTREE_MARGIN_RATIO),h[0]<Octree.OCTREE_MIN_MARGIN&&(h[0]=Octree.OCTREE_MIN_MARGIN),h[1]<Octree.OCTREE_MIN_MARGIN&&(h[1]=Octree.OCTREE_MIN_MARGIN),h[2]<Octree.OCTREE_MIN_MARGIN&&(h[2]=Octree.OCTREE_MIN_MARGIN),vec3.sub(o.min,o.min,h),vec3.add(o.max,o.max,h),o.faces=[],o.inside=0;var f=t+r;if(a)for(var p=t;p<f;p+=3){var T=new Float32Array([s[a[p]*3],s[a[p]*3+1],s[a[p]*3+2],s[a[p+1]*3],s[a[p+1]*3+1],s[a[p+1]*3+2],s[a[p+2]*3],s[a[p+2]*3+1],s[a[p+2]*3+2],p/3]);Octree.isValidFace(T)&&this.addToNode(T,o,0)}else for(var p=t*3;p<r*3;p+=9){var T=new Float32Array(10);T.set(s.subarray(p,p+9)),T[9]=p/9,Octree.isValidFace(T)&&this.addToNode(T,o,0)}return o},Octree.isValidFace=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create();return function(s){var a=s.subarray(0,3),o=s.subarray(3,6),h=s.subarray(6,9);return vec3.sub(e,o,a),vec3.sub(t,h,a),vec3.cross(r,e,t),vec3.length(r)>0}}(),Octree.prototype.addToNode=function(e,t,r){if(t.inside+=1,t.c){for(var s=this.computeAABB(e),a=!1,o=0;o<t.c.length;++o){var h=t.c[o];if(Octree.isInsideAABB(s,h)){this.addToNode(e,h,r+1),a=!0;break}}a||(t.faces==null&&(t.faces=[]),t.faces.push(e))}else if(t.faces==null&&(t.faces=[]),t.faces.push(e),t.faces.length>this.max_node_triangles&&r<Octree.MAX_OCTREE_DEPTH){this.splitNode(t),this.total_depth<r+1&&(this.total_depth=r+1);var f=t.faces.concat();t.faces=null;for(var o=0;o<f.length;++o){for(var e=f[o],s=this.computeAABB(e),a=!1,p=0;p<t.c.length;++p){var h=t.c[p];if(Octree.isInsideAABB(s,h)){this.addToNode(e,h,r+1),a=!0;break}}a||(t.faces==null&&(t.faces=[]),t.faces.push(e))}}},Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]],Octree.prototype.splitNode=function(e){e.c=[];for(var t=[(e.max[0]-e.min[0])*.5,(e.max[1]-e.min[1])*.5,(e.max[2]-e.min[2])*.5],r=0;r<this.octree_pos_ref.length;++r){var s=this.octree_pos_ref[r],a={};this.total_nodes+=1,a.min=[e.min[0]+t[0]*s[0],e.min[1]+t[1]*s[1],e.min[2]+t[2]*s[2]],a.max=[a.min[0]+t[0],a.min[1]+t[1],a.min[2]+t[2]],a.faces=null,a.inside=0,e.c.push(a)}},Octree.prototype.computeAABB=function(e){for(var t=new Float32Array([e[0],e[1],e[2]]),r=new Float32Array(t),s=3;s<e.length-1;s+=3)for(var a=0;a<3;a++)t[a]>e[s+a]&&(t[a]=e[s+a]),r[a]<e[s+a]&&(r[a]=e[s+a]);return{min:t,max:r,size:vec3.sub(vec3.create(),r,t)}},Octree.prototype.computeAABBFromIndices=function(e,t,r,s){r=r||0,s=s||t.length;for(var a=t[r],o=new Float32Array([e[a*3],e[a*3+1],e[a*3+2]]),h=new Float32Array([e[a*3],e[a*3+1],e[a*3+2]]),f=r+1;f<r+s;++f)for(var a=t[f]*3,p=0;p<3;p++)o[p]>e[a+p]&&(o[p]=e[a+p]),h[p]<e[a+p]&&(h[p]=e[a+p]);return{min:o,max:h,size:vec3.sub(vec3.create(),h,o)}},Octree.prototype.trim=function(e){if(e=e||this.root,!e.c)return 1;for(var t=1,r=[],s=e.c,a=0;a<s.length;++a)s[a].inside&&(r.push(s[a]),t+=this.trim(s[a]));return e.c=r,t},Octree.prototype.testRay=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create();return function(a,o,h,f,p,T){if(T=T||Octree.NEAREST,!this.root)throw"Error: octree not build";e.set(a),t.set(o),r.set(this.root.min),s.set(this.root.max);var _=Octree.hitTestBox(e,t,r,s);if(!_)return null;var _=Octree.testRayInNode(this.root,e,t,p,T);if(_==null)return null;if(T==Octree.ALL)return _;var S=vec3.scale(vec3.create(),o,_.t);return vec3.add(S,S,a),_.pos=S,_}}(),Octree.testRayInNode=function(e,t,r,s,a){var o=null,h=null;if(e.faces)for(var f=0,p=e.faces.length;f<p;++f){var T=e.faces[f];if(o=Octree.hitTestTriangle(t,r,T.subarray(0,3),T.subarray(3,6),T.subarray(6,9),s),o!=null){if(a==Octree.FIRST)return o;a==Octree.ALL?(h||(h=[]),h.push(o)):(o.face=T,h?h.mergeWith(o):h=o)}}var _=vec3.create(),S=vec3.create(),b;if(e.c){for(var f=0;f<e.c.length;++f)if(b=e.c[f],_.set(b.min),S.set(b.max),o=Octree.hitTestBox(t,r,_,S),o!=null&&!(a!=Octree.ALL&&h&&o.t>h.t)&&(o=Octree.testRayInNode(b,t,r,s,a),o!=null)){if(a==Octree.FIRST)return o;a==Octree.ALL?(h||(h=[]),h.push(o)):h?h.mergeWith(o):h=o}}return h},Octree.prototype.testSphere=function(e,t){if(e=vec3.clone(e),!this.root)throw"Error: octree not build";var r=t*t;return Octree.testSphereBox(e,r,vec3.clone(this.root.min),vec3.clone(this.root.max))?Octree.testSphereInNode(this.root,e,r):!1},Octree.testSphereInNode=function(e,t,r){if(e.faces)for(var s=0,a=e.faces.length;s<a;++s){var o=e.faces[s];if(Octree.testSphereTriangle(t,r,o.subarray(0,3),o.subarray(3,6),o.subarray(6,9)))return!0}var h=vec3.create(),f=vec3.create(),p;if(e.c){for(var s=0;s<e.c.length;++s)if(p=e.c[s],h.set(p.min),f.set(p.max),!!Octree.testSphereBox(t,r,h,f)&&Octree.testSphereInNode(p,t,r))return!0}return!1},Octree.prototype.findNearestPoint=function(e,t,r,s){if(r=r||1/0,e===t)throw"findNearestPoint input point and output cannot be the same";return Octree.nearestInNode(this.root,e,t,r,s)},Octree.nearestInNode=function(e,t,r,s,a){var o=vec3.create(),h;if(a&&(h=vec3.create()),e.faces)for(var f=0,p=e.faces.length;f<p;++f){var T=e.faces[f];Octree.closestPointOnTriangle(t,T.subarray(0,3),T.subarray(3,6),T.subarray(6,9),o);var _=vec3.dist(o,t);_<s&&(s=_,vec3.copy(r,o),a&&geo.computeTriangleNormal(a,T.subarray(0,3),T.subarray(3,6),T.subarray(6,9)))}if(!e.c)return s;for(var f=0;f<e.c.length;++f){var S=e.c[f],b=Octree.distanceToBox(t,S.min,S.max);if(!(b>s)){var _=Octree.nearestInNode(S,t,o,s,h);_<s&&(s=_,vec3.copy(r,o),a&&vec3.copy(a,h))}}return s},Octree.closestPointOnTriangle=function(){var e=new Float32Array(4),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create();return function(o,h,f,p,T){if(geo.planeFromTriangle(e,h,f,p),vec3.length(e)>1e-6&&(geo.projectPointOnPlane(o,h,e,t),geo.isPointInsideTriangle(t,h,f,p)))return vec3.copy(T,t),T;geo.closestPointToSegment(t,h,f,r),geo.closestPointToSegment(t,f,p,s),geo.closestPointToSegment(t,p,h,a);var _=vec3.sqrDist(t,r),S=vec3.sqrDist(t,s),b=vec3.sqrDist(t,a),M=Math.min(_,S,b);return M===_?vec3.copy(T,r):M===S?vec3.copy(T,s):vec3.copy(T,a),T}}(),Octree.isInsideAABB=function(e,t){return!(e.min[0]<t.min[0]||e.min[1]<t.min[1]||e.min[2]<t.min[2]||e.max[0]>t.max[0]||e.max[1]>t.max[1]||e.max[2]>t.max[2])},Octree.distanceToBox=function(e,t,r){var s=(r[0]+t[0])*.5,a=(r[1]+t[1])*.5,o=(r[2]+t[2])*.5,h=r[0]-s,f=r[1]-a,p=r[2]-o,T=Math.abs(e[0]-s)-h,_=Math.abs(e[1]-a)-f,S=Math.abs(e[2]-o)-p,b=Math.min(Math.max(T,_,S),0);return T=Math.max(T,0),_=Math.max(_,0),S=Math.max(S,0),Math.sqrt(T*T+_*_+S*S)+b},Octree.hitTestBox=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create(),o=vec3.create(),h=1e-6,f=vec3.fromValues(h,h,h);return function(p,T,_,S){if(vec3.subtract(e,_,p),vec3.subtract(t,S,p),vec3.maxValue(e)<0&&vec3.minValue(t)>0)return new HitTest(0,p,T);r[0]=1/T[0],r[1]=1/T[1],r[2]=1/T[2],vec3.multiply(e,e,r),vec3.multiply(t,t,r),vec3.min(s,e,t),vec3.max(a,e,t);var b=vec3.maxValue(s),M=vec3.minValue(a);if(b>0&&b<M){var G=vec3.add(vec3.create(),vec3.scale(o,T,b),p);return vec3.add(_,_,f),vec3.subtract(_,_,f),new HitTest(b,G,vec3.fromValues((G[0]>S[0])-(G[0]<_[0]),(G[1]>S[1])-(G[1]<_[1]),(G[2]>S[2])-(G[2]<_[2])))}return null}}(),Octree.hitTestTriangle=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create();return function(a,o,h,f,p,T){vec3.subtract(e,f,h),vec3.subtract(t,p,h);var _=vec3.cross(vec3.create(),e,t);if(vec3.normalize(_,_),!T&&vec3.dot(_,o)>0)return null;var S=vec3.dot(_,vec3.subtract(s,h,a))/vec3.dot(_,o);if(S>0){var b=vec3.scale(vec3.create(),o,S);vec3.add(b,b,a),vec3.subtract(r,b,h);var M=vec3.dot(t,t),G=vec3.dot(t,e),O=vec3.dot(t,r),B=vec3.dot(e,e),H=vec3.dot(e,r),z=M*B-G*G,k=(B*O-G*H)/z,X=(M*H-G*O)/z;if(k>=0&&X>=0&&k+X<=1)return new HitTest(S,b,_)}return null}}(),Octree.testSphereTriangle=function(){var e=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create(),o=vec3.create(),h=vec3.create(),f=vec3.create();return function(p,T,_,S,b){vec3.sub(e,_,p),vec3.sub(t,S,p),vec3.sub(r,b,p),vec3.sub(s,t,e),vec3.sub(a,r,e),vec3.cross(f,s,a);var M=vec3.dot(e,f),G=vec3.dot(f,f),O=M*M>T*G,B=vec3.dot(e,e),H=vec3.dot(e,t),z=vec3.dot(e,r),k=vec3.dot(t,t),X=vec3.dot(t,r),Q=vec3.dot(r,r),te=B>T&H>B&z>B,D=k>T&H>k&X>k,J=Q>T&z>Q&X>Q,ee=H-B,Y=X-k,$=z-Q;vec3.sub(o,r,t),vec3.sub(h,e,r);var W=vec3.dot(s,s),ie=vec3.dot(o,o),K=vec3.dot(h,h),se=vec3.scale(vec3.create(),e,W);vec3.sub(se,se,vec3.scale(vec3.create(),s,ee));var le=vec3.scale(vec3.create(),t,ie);vec3.sub(le,le,vec3.scale(vec3.create(),o,Y));var ue=vec3.scale(vec3.create(),r,K);vec3.sub(ue,ue,vec3.scale(vec3.create(),h,$));var he=vec3.scale(vec3.create(),r,W);he=vec3.sub(he,he,se);var ve=vec3.scale(vec3.create(),e,ie);ve=vec3.sub(ve,ve,le);var I=vec3.scale(vec3.create(),t,K);I=vec3.sub(I,I,ue);var V=vec3.dot(se,se)>T*W*W&vec3.dot(se,he)>0,Z=vec3.dot(le,le)>T*ie*ie&vec3.dot(le,ve)>0,j=vec3.dot(ue,ue)>T*K*K&vec3.dot(ue,I)>0,re=O|te|D|J|V|Z|j;return!re}}(),Octree.testSphereBox=function(e,t,r,s){for(var a,o=0,h=0;h<3;++h)e[h]<r[h]?(a=e[h]-r[h],o+=a*a):e[h]>s[h]&&(a=e[h]-s[h],o+=a*a);return o<=t},l.HitTest=n.HitTest=function(t,r,s){this.t=arguments.length?t:Number.MAX_VALUE,this.hit=r,this.normal=s,this.face=null},HitTest.prototype={mergeWith:function(e){e.t>0&&e.t<this.t&&(this.t=e.t,this.hit=e.hit,this.normal=e.normal,this.face=e.face)}},l.Ray=n.Ray=function(t,r){this.origin=vec3.create(),this.direction=vec3.create(),this.collision_point=vec3.create(),this.t=-1,t&&this.origin.set(t),r&&this.direction.set(r)},Ray.prototype.testPlane=function(e,t){var r=geo.testRayPlane(this.origin,this.direction,e,t,this.collision_point);return this.t=geo.last_t,r},Ray.prototype.testSphere=function(e,t,r){var s=geo.testRaySphere(this.origin,this.direction,e,t,this.collision_point,r);return this.t=geo.last_t,s},Ray.prototype.testBBox=function(e,t,r,s){var a=geo.testRayBBox(this.origin,this.direction,e,r,this.collision_point,t,s);return this.t=geo.last_t,a},l.Raytracer=n.Raytracer=function(t,r){this.viewport=vec4.create(),this.ray00=vec3.create(),this.ray10=vec3.create(),this.ray01=vec3.create(),this.ray11=vec3.create(),this.eye=vec3.create(),this.setup(t,r)},Raytracer.prototype.setup=function(e,t){t=t||gl.viewport_data,this.viewport.set(t);var r=t[0],s=r+t[2],a=t[1],o=a+t[3];vec3.set(this.ray00,r,a,1),vec3.set(this.ray10,s,a,1),vec3.set(this.ray01,r,o,1),vec3.set(this.ray11,s,o,1),vec3.unproject(this.ray00,this.ray00,e,t),vec3.unproject(this.ray10,this.ray10,e,t),vec3.unproject(this.ray01,this.ray01,e,t),vec3.unproject(this.ray11,this.ray11,e,t);var h=this.eye;vec3.unproject(h,h,e,t),vec3.subtract(this.ray00,this.ray00,h),vec3.subtract(this.ray10,this.ray10,h),vec3.subtract(this.ray01,this.ray01,h),vec3.subtract(this.ray11,this.ray11,h)},Raytracer.prototype.getRayForPixel=function(){var e=vec3.create(),t=vec3.create();return function(r,s,a){return a=a||vec3.create(),r=(r-this.viewport[0])/this.viewport[2],s=1-(s-this.viewport[1])/this.viewport[3],vec3.lerp(e,this.ray00,this.ray10,r),vec3.lerp(t,this.ray01,this.ray11,r),vec3.lerp(a,e,t,s),vec3.normalize(a,a)}}();var U=mat4.create();Raytracer.hitTestBox=function(e,t,r,s,a){var o=new Float32Array(30);if(a){var h=mat4.invert(U,a);e=mat4.multiplyVec3(o.subarray(3,6),h,e),t=mat4.rotateVec3(o.subarray(6,9),h,t)}var f=vec3.subtract(o.subarray(9,12),r,e);vec3.divide(f,f,t);var p=vec3.subtract(o.subarray(12,15),s,e);vec3.divide(p,p,t);var T=vec3.min(o.subarray(15,18),f,p),_=vec3.max(o.subarray(18,21),f,p),S=vec3.maxValue(T),b=vec3.minValue(_);if(S>0&&S<=b){var M=1e-6,G=vec3.scale(o.subarray(21,24),t,S);return vec3.add(G,e,G),vec3.addValue(o.subarray(24,27),r,M),vec3.subValue(o.subarray(27,30),s,M),new HitTest(S,G,vec3.fromValues((G[0]>s[0])-(G[0]<r[0]),(G[1]>s[1])-(G[1]<r[1]),(G[2]>s[2])-(G[2]<r[2])))}return null},Raytracer.hitTestSphere=function(e,t,r,s){var a=vec3.subtract(vec3.create(),e,r),o=vec3.dot(t,t),h=2*vec3.dot(t,a),f=vec3.dot(a,a)-s*s,p=h*h-4*o*f;if(p>0){var T=(-h-Math.sqrt(p))/(2*o),_=vec3.add(vec3.create(),e,vec3.scale(vec3.create(),t,T));return new HitTest(T,_,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),_,r),1/s))}return null},Raytracer.hitTestTriangle=function(e,t,r,s,a){var o=vec3.subtract(vec3.create(),s,r),h=vec3.subtract(vec3.create(),a,r),f=vec3.cross(vec3.create(),o,h);vec3.normalize(f,f);var p=vec3.dot(f,vec3.subtract(vec3.create(),r,e))/vec3.dot(f,t);if(p>0){var T=vec3.add(vec3.create(),e,vec3.scale(vec3.create(),t,p)),_=vec3.subtract(vec3.create(),T,r),S=vec3.dot(h,h),b=vec3.dot(h,o),M=vec3.dot(h,_),G=vec3.dot(o,o),O=vec3.dot(o,_),B=S*G-b*b,H=(G*M-b*O)/B,z=(S*O-b*M)/B;if(H>=0&&z>=0&&H+z<=1)return new HitTest(p,T,f)}return null},Mesh.parseOBJ=function(e,t){t=t||{};var r=t.matextension||"",s=[],a=[],o=[],h=[],f=[],p=[],T=[],_={},S=null,b=fe(),M=new Map,G=0,O=1;t.scale&&(O=t.scale);for(var B=1,H=2,z=3,k=4,X=5,Q=6,te=7,D=8,J={v:B,vt:H,vn:z,f:k,g:X,o:Q,usemtl:te,mtllib:D},ee,Y,$,W=e.split(`
`),ie=W.length,K=0;K<ie;++K){var se=W[K];if(se=se.replace(/[ \t]+/g," ").replace(/\s\s*$/,""),se[se.length-1]=="\\"){K+=1;var le=W[K].replace(/[ \t]+/g," ").replace(/\s\s*$/,"");se=(se.substr(0,se.length-1)+le).replace(/[ \t]+/g," ").replace(/\s\s*$/,"")}if(se[0]!="#"&&se!=""){var ue=se.split(" "),he=J[ue[0]];switch(he<=z&&(ee=parseFloat(ue[1]),Y=parseFloat(ue[2]),he!=H&&($=parseFloat(ue[3]))),he){case B:ee*=O,Y*=O,$*=O,s.push(ee,Y,$);break;case H:o.push(ee,Y);break;case z:a.push(ee,Y,$);break;case k:if(ue.length<4)continue;for(var ve=[],I=1;I<ue.length;++I)ve.push(ce(ue[I]));b.indices.push(ve[0],ve[1],ve[2]);for(var I=2;I<ve.length-1;++I)b.indices.push(ve[0],ve[I],ve[I+1]);break;case X:case Q:var V=ue[1];S=V,b.name?(_={},b=fe(V)):b.name=V;break;case te:ge(ue[1]);break;case D:ue[1];break}}}for(var Z=[],j=0,re=[],I=0;I<T.length;++I){var b=T[I];b.indices&&(b.start=j,b.length=b.indices.length,Z=Z.concat(b.indices),delete b.indices,j+=b.length,re.push(b))}T=re;var ae={};if(!s.length)return console.error("mesh without vertices"),null;if(t.flip_normals&&f.length)for(var a=f,I=0;I<a.length;++I)a[I]*=-1;ae.vertices=new Float32Array(h),f.length&&(ae.normals=new Float32Array(f)),p.length&&(ae.coords=new Float32Array(p)),Z&&Z.length>0&&(ae.triangles=new(j>256*256?Uint32Array:Uint16Array)(Z)),ae.bounding=n.Mesh.computeBoundingBox(ae.vertices);var oe={};if(T.length>1&&(oe.groups=T),ae.info=oe,!ae.bounding)return console.log("empty mesh"),null;if(t.only_data)return ae;var _e=null;return _e=Mesh.load(ae,null,t.mesh),_e;function ce(pe){var de,me,Ee,Te,we=!1;if(pe.indexOf("-")==-1){var be=M.get(pe);if(be!==void 0)return be}else we=!0;if(Te||(Te=pe.split("/")),Te.length==1)de=parseInt(Te[0]),me=de,Ee=de;else if(Te.length==2)de=parseInt(Te[0]),me=parseInt(Te[1]),Ee=de;else if(Te.length==3)de=parseInt(Te[0]),me=parseInt(Te[1]),Ee=parseInt(Te[2]);else return console.log("Problem parsing: unknown number of values per face"),-1;if(de<0&&(de=s.length/3+de+1),Ee<0&&(Ee=a.length/2+Ee+1),me<0&&(me=o.length/2+me+1),we){pe=de+"/"+me+"/"+Ee;var be=M.get(pe);if(be!==void 0)return be}de-=1,me-=1,Ee-=1,h.push(s[de*3+0],s[de*3+1],s[de*3+2]),o.length&&p.push(o[me*2+0],o[me*2+1]),a.length&&f.push(a[Ee*3+0],a[Ee*3+1],a[Ee*3+2]);var be=G;return M.set(pe,be),++G,be}function fe(pe){var de={name:pe||"",material:"",start:-1,length:-1,indices:[]};return T.push(de),de}function ge(pe){if(!b.material)return b.material=pe+r,_[pe]=b,b;var de=_[pe];return de||(de=fe(S+"_"+pe),de.material=pe+r,_[pe]=de),b=de,de}},Mesh.parsers.obj=Mesh.parseOBJ,Mesh.encoders.obj=function(e,t){var r=e.getBuffer("vertices");if(!r)return null;var s=[];s.push(`# Generated with liteGL.js by Javi Agenjo
`);for(var a=r.data,o=0;o<a.length;o+=3)s.push("v "+a[o].toFixed(4)+" "+a[o+1].toFixed(4)+" "+a[o+2].toFixed(4));var h=e.getBuffer("normals");if(h){s.push("");for(var f=h.data,o=0;o<f.length;o+=3)s.push("vn "+f[o].toFixed(4)+" "+f[o+1].toFixed(4)+" "+f[o+2].toFixed(4))}var p=e.getBuffer("coords");if(p){s.push("");for(var T=p.data,o=0;o<T.length;o+=2)s.push("vt "+T[o].toFixed(4)+" "+T[o+1].toFixed(4)+"  0.0000")}var _=e.info.groups,S=e.getIndexBuffer("triangles");if(S){var b=S.data;(!_||!_.length)&&(_=[{start:0,length:b.length,name:"mesh"}]);for(var M=0;M<_.length;++M){var G=_[M];s.push("g "+G.name);var O=G.material||"mat_"+M;O.indexOf(".json")!=-1&&(O=O.substr(0,O.indexOf(".json"))),s.push("usemtl "+O);for(var B=G.start,H=B+G.length,o=B;o<H;o+=3)s.push("f "+(b[o]+1)+"/"+(b[o]+1)+"/"+(b[o]+1)+" "+(b[o+1]+1)+"/"+(b[o+1]+1)+"/"+(b[o+1]+1)+" "+(b[o+2]+1)+"/"+(b[o+2]+1)+"/"+(b[o+2]+1))}}else{(!_||!_.length)&&(_=[{start:0,length:a.length/3,name:"mesh"}]);for(var M=0;M<_.length;++M){var G=_[M];s.push("g "+G.name),s.push("usemtl "+(G.material||"mat_"+M));for(var B=G.start,H=B+G.length,o=B;o<H;o+=3)s.push("f "+(o+1)+"/"+(o+1)+"/"+(o+1)+" "+(o+2)+"/"+(o+2)+"/"+(o+2)+" "+(o+3)+"/"+(o+3)+"/"+(o+3))}}return s.join(`
`)},Mesh.parsers.mesh=function(e,t){for(var r={},s=e.split(`
`),a=0;a<s.length;++a){var o=s[a],h=o[0],f=o.substr(1).split(","),p=f[0];if(h=="-"){var T=1,_=Float32Array;(p=="weights"||p=="bone_indices")&&(_=Uint8Array),p=="weights"&&(T=255);for(var S=new _(Number(f[1])),b=0;b<S.length;++b)S[b]=Number(f[b+2])*T;r[p]=S}else if(h=="*"){var _=Uint16Array;Number(f[1])>256*256&&(_=Uint32Array);for(var S=new _(Number(f[1])),b=0;b<S.length;++b)S[b]=Number(f[b+2]);r[p]=S}else if(h=="@"){if(p=="bones"){for(var M=[],G=Number(f[1]),b=0;b<G;++b){var O=f.slice(3+b*17,3+(b+1)*17-1).map(Number);M.push([f[2+b*17],O])}r.bones=M}else if(p=="bind_matrix")r.bind_matrix=f.slice(1,17).map(Number);else if(p=="groups"){r.info={groups:[]};for(var B=Number(f[1]),b=0;b<B;++b){var H={name:f[2+b*4],material:f[2+b*4+1],start:Number(f[2+b*4+2]),length:Number(f[2+b*4+3])};r.info.groups.push(H)}}}else console.warn("type unknown: "+f[0])}if(t.only_data)return r;var z=null;return z=Mesh.load(r,null,t.mesh),z.updateBoundingBox(),z},Mesh.encoders.mesh=function(e,t){var r=[];for(var s in e.vertexBuffers){var a=e.vertexBuffers[s],o=typedArrayToArray(a.data);if(a.normalize&&a.data.constructor==Uint8Array)for(var h=0;h<o.length;++h)o[h]/=255;var f=["-"+s,a.data.length,a.data,o];r.push(f.join(","))}for(var s in e.indexBuffers){var a=e.indexBuffers[s],o=typedArrayToArray(a.data),f=["*"+s,a.data.length,a.data,o];r.push(f.join(","))}if(e.bounding&&r.push(["@bounding",typedArrayToArray(e.bounding.subarray(0,6))].join(",")),e.info&&e.info.groups){for(var p=[],h=0;h<e.info.groups.length;++h){var T=e.info.groups[h];p.push(T.name,T.material,T.start,T.length)}r.push(["@groups",e.info.groups.length].concat(p).join(","))}return e.bones&&r.push(["@bones",e.bones.length,e.bones.flat()].join(",")),e.bind_matrix&&r.push(["@bind_matrix",typedArrayToArray(e.bind_matrix)].join(",")),r.join(`
`)},l.WBin&&(l.WBin.classes.Mesh=Mesh),Mesh.binary_file_formats.wbin=!0,Mesh.parsers.wbin=Mesh.fromBinary=function(e,t){t=t||{};var r=null;if(e.constructor==ArrayBuffer){if(!l.WBin)throw"To use binary meshes you need to install WBin.js from https://github.com/jagenjo/litescene.js/blob/master/src/utils/wbin.js ";r=WBin.load(e,!0)}else r=e;r.info||console.warn("This WBin doesn't seem to contain a mesh. Classname: ",r["@classname"]),r.format&&n.Mesh.decompress(r);var s={};if(r.vertex_buffers)for(var a in r.vertex_buffers)s[r.vertex_buffers[a]]=r[r.vertex_buffers[a]];else r.vertices&&(s.vertices=r.vertices),r.normals&&(s.normals=r.normals),r.coords&&(s.coords=r.coords),r.weights&&(s.weights=r.weights),r.bone_indices&&(s.bone_indices=r.bone_indices);var o={};if(r.index_buffers)for(var a in r.index_buffers)o[r.index_buffers[a]]=r[r.index_buffers[a]];else r.triangles&&(o.triangles=r.triangles),r.wireframe&&(o.wireframe=r.wireframe);var h={vertex_buffers:s,index_buffers:o,bounding:r.bounding,info:r.info};if(r.bones){h.bones=r.bones;for(var a=0;a<h.bones.length;++a)h.bones[a][1]=mat4.clone(h.bones[a][1]);r.bind_matrix&&(h.bind_matrix=mat4.clone(r.bind_matrix))}if(r.morph_targets&&(h.morph_targets=r.morph_targets),t.only_data)return h;var f=t.mesh||new n.Mesh;return f.configure(h),f},Mesh.encoders.wbin=function(e,t){return e.updateBoundingBox(),e.toBinary(t)},Mesh.prototype.toBinary=function(e){if(!l.WBin)throw"to use Mesh.toBinary you need to have WBin included. Check the repository for wbin.js";this.info||(this.info={});var t={object_class:"Mesh",info:this.info,groups:this.groups};if(this.bones){for(var r=[],s=0;s<this.bones.length;++s)r.push([this.bones[s][0],mat4.toArray(this.bones[s][1])]);t.bones=r,this.bind_matrix&&(t.bind_matrix=this.bind_matrix)}this.bounding||this.updateBoundingBox(),t.bounding=this.bounding;var a=[],o=[];for(var s in this.vertexBuffers){var h=this.vertexBuffers[s];t[h.name]=h.data,a.push(h.name),h.name=="vertices"&&(t.info.num_vertices=h.data.length/3)}for(var s in this.indexBuffers){var h=this.indexBuffers[s];t[s]=h.data,o.push(s)}t.vertex_buffers=a,t.index_buffers=o,n.Mesh.enable_wbin_compression&&n.Mesh.compress(t);var f=WBin.create(t,"Mesh");return f},Mesh.compress=function(e,t){t=t||"bounding_compressed",e.format={type:t};var r=Mesh.compressors[t];if(!r)throw"compression format not supported:"+t;return r(e)},Mesh.decompress=function(e){if(e.format){var t=Mesh.decompressors[e.format.type];if(!t)throw"decompression format not supported:"+e.format.type;return t(e)}},Mesh.compressors.bounding_compressed=function(e){if(!e.vertex_buffers)throw"buffers not found";for(var t=BBox.getMin(e.bounding),r=BBox.getMax(e.bounding),s=vec3.sub(vec3.create(),r,t),a=e.vertices,o=new Uint16Array(a.length),h=0;h<a.length;h+=3)o[h]=(a[h]-t[0])/s[0]*65535,o[h+1]=(a[h+1]-t[1])/s[1]*65535,o[h+2]=(a[h+2]-t[2])/s[2]*65535;if(e.vertices=o,e.normals){for(var f=e.normals,p=new Uint8Array(f.length),T=p.constructor==Uint8Array?255:65535,h=0;h<f.length;h+=3)p[h]=(f[h]*.5+.5)*T,p[h+1]=(f[h+1]*.5+.5)*T,p[h+2]=(f[h+2]*.5+.5)*T;e.normals=p}if(e.coords){for(var _=e.coords,S=[1e4,1e4,-1e4,-1e4],h=0;h<_.length;h+=2){var b=_[h];S[0]>b?S[0]=b:S[2]<b&&(S[2]=b);var M=_[h+1];S[1]>M?S[1]=M:S[3]<M&&(S[3]=M)}e.format.uvs_bounding=S;for(var G=new Uint16Array(_.length),s=[S[2]-S[0],S[3]-S[1]],h=0;h<_.length;h+=2)G[h]=(_[h]-S[0])/s[0]*65535,G[h+1]=(_[h+1]-S[1])/s[1]*65535;e.coords=G}if(e.weights){for(var O=e.weights,B=new Uint16Array(O.length),H=B.constructor==Uint8Array?255:65535,h=0;h<O.length;h+=4)B[h]=O[h]*H,B[h+1]=O[h+1]*H,B[h+2]=O[h+2]*H,B[h+3]=O[h+3]*H;e.weights=B}},Mesh.decompressors.bounding_compressed=function(e){var t=e.bounding;if(!t)throw"error in mesh decompressing data: bounding not found, cannot use the bounding decompression.";for(var r=BBox.getMin(t),s=BBox.getMax(t),a=vec3.sub(vec3.create(),s,r),o=e.format,h=1/255,f=1/65535,p=e.vertices,T=new Float32Array(p.length),_=0,S=p.length;_<S;_+=3)T[_]=p[_]*f*a[0]+r[0],T[_+1]=p[_+1]*f*a[1]+r[1],T[_+2]=p[_+2]*f*a[2]+r[2];if(e.vertices=T,e.normals&&e.normals.constructor!=Float32Array){for(var b=e.normals,M=new Float32Array(b.length),G=b.constructor==Uint8Array?h:f,_=0,S=b.length;_<S;_+=3){M[_]=b[_]*G*2-1,M[_+1]=b[_+1]*G*2-1,M[_+2]=b[_+2]*G*2-1;var O=M.subarray(_,_+3);vec3.normalize(O,O)}e.normals=M}if(e.coords&&o.uvs_bounding&&e.coords.constructor!=Float32Array){for(var B=e.coords,H=o.uvs_bounding,a=[H[2]-H[0],H[3]-H[1]],z=new Float32Array(B.length),_=0,S=B.length;_<S;_+=2)z[_]=B[_]*f*a[0]+H[0],z[_+1]=B[_+1]*f*a[1]+H[1];e.coords=z}if(e.weights&&e.weights.constructor!=Float32Array){for(var k=e.weights,X=new Float32Array(k.length),Q=k.constructor==Uint8Array?h:f,_=0,S=k.length;_<S;_+=4)X[_]=k[_]*Q,X[_+1]=k[_+1]*Q,X[_+2]=k[_+2]*Q,X[_+3]=k[_+3]*Q;e.weights=X}}}(typeof window<"u"?window:typeof self<"u"?self:global);const GL$1=window.GL;if(typeof GL$1>"u")throw"litegl.js must be included to use enableWebGLCanvas";function enableWebGLCanvas(l,n){var u;if(n=n||{},l.is_webgl)u=l.gl;else{n.canvas=l,n.alpha=!0,n.stencil=!0;try{u=GL$1.create(n)}catch{return console.log("This canvas cannot be used as WebGL, maybe WebGL is not supported or this canvas has already a 2D context associated"),u=l.getContext("2d",n),u}}const c=u.getError();if(c!==u.NO_ERROR&&console.error("WebGL error:",c),l.canvas2DtoWebGL_enabled)return u;var d=50,g=1e4,m=1e3;l.canvas2DtoWebGL_enabled=!0;var E=null,L=l.ctx=u;L.WebGLCanvas={},vec4.fromValues(1,1,1,1);var A=0,N=new Float32Array(g*3),C=new GL$1.Mesh,R=C.createVertexBuffer("vertices",null,null,N,u.STREAM_DRAW),P=GL$1.Mesh.getScreenQuad(),F=GL$1.Mesh.circle({size:1}),U=mat4.create(),e=n.anisotropic!==void 0?n.anisotropic:2,t={u_texture:0},r={};n.allow3D&&(r.EXTRA_PROJECTION="");var s=u.WebGLCanvas.textures_atlas={};u.WebGLCanvas.clearAtlas=function(){s=u.WebGLCanvas.textures_atlas={}};var a=null,o=null,h=null,f=null,p=null,T=null,_=null,S=null,b=null,M=null;u.WebGLCanvas.set3DMatrix=function(I){I?U.set(I):mat4.identity(U),r.EXTRA_PROJECTION==null&&(r.EXTRA_PROJECTION="",G(),t.u_projection=U),t.u_projection_enabled=!!I},G();function G(){a=`
				precision highp float;
				attribute vec3 a_vertex;
				uniform vec2 u_viewport;
				uniform mat3 u_transform;
				#ifdef EXTRA_PROJECTION
					uniform bool u_projection_enabled;
					uniform mat4 u_projection;
				#endif
				varying float v_visible;
				void main() { 
					vec3 pos = a_vertex;
					v_visible = pos.z;
					pos = u_transform * vec3(pos.xy,1.0);
					pos.z = 0.0;
					#ifdef EXTRA_PROJECTION
						if(u_projection_enabled)
						{
							gl_Position = u_projection * vec4(pos.xy,0.0,1.0);
							return;
						}
					#endif
					//normalize
					pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
					pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
					gl_Position = vec4(pos, 1.0); 
				}
				`,o=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			uniform vec2 u_position;
			uniform vec2 u_size;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			#ifdef EXTRA_PROJECTION
				uniform bool u_projection_enabled;
				uniform mat4 u_projection;
			#endif
			void main() { 
				vec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);
				v_coord = a_coord; 
				pos = u_transform * pos;
				pos.z = 0.0;
				#ifdef EXTRA_PROJECTION
					if(u_projection_enabled)
					{
						gl_Position = u_projection * vec4(pos.xy,0.0,1.0);
						return;
					}
				#endif
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
			}
		`,h=new GL$1.Shader(o,`
				precision highp float;
				uniform vec4 u_color;
				void main() {
					gl_FragColor = u_color;
				}
			`,r),f=new GL$1.Shader(o,`
				precision highp float;
				varying vec2 v_coord;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				void main() {
					gl_FragColor = u_color * texture2D( u_texture, v_coord );
				}
			`,r),p=new GL$1.Shader(o,`
				precision highp float;
				varying vec2 v_coord;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				void main() {
					vec4 color = u_color * texture2D( u_texture, v_coord );
					if(color.a <= 0.0)
						discard;
					gl_FragColor = color;
				}
			`,r),T=new GL$1.Shader(a,`
				precision highp float;
				varying float v_visible;
				uniform vec4 u_color;
				void main() {
					if (v_visible == 0.0)
						discard;
					gl_FragColor = u_color;
				}
			`,r),_=new GL$1.Shader(GL$1.Shader.QUAD_VERTEX_SHADER,`
				precision highp float;
				uniform sampler2D u_texture;
				uniform vec4 u_color;
				uniform vec4 u_texture_transform;
				varying vec2 v_coord;
				void main() {
					vec2 uv = v_coord * u_texture_transform.zw + vec2(u_texture_transform.x,0.0);
					uv.y = uv.y - u_texture_transform.y + (1.0 - u_texture_transform.w);
					uv = clamp(uv,vec2(0.0),vec2(1.0));
					gl_FragColor = u_color * texture2D(u_texture, uv);
				}
			`,r),S=new GL$1.Shader(a,`
				precision highp float;
				varying float v_visible;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				uniform vec4 u_texture_transform;
				uniform vec2 u_viewport;
				uniform mat3 u_itransform;
				void main() {
					vec2 pos = (u_itransform * vec3( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t,1.0)).xy;
					pos *= vec2( (u_viewport.x * u_texture_transform.z), (u_viewport.y * u_texture_transform.w) );
					vec2 uv = fract(pos / u_viewport) + u_texture_transform.xy;
					uv.y = 1.0 - uv.y;
					gl_FragColor = u_color * texture2D( u_texture, uv);
				}
			`,r),b=new GL$1.Shader(a,`
				precision highp float;
				varying float v_visible;
				uniform vec4 u_color;
				uniform sampler2D u_texture;
				uniform vec4 u_gradient;
				uniform vec2 u_viewport;
				uniform mat3 u_itransform;
				void main() {
					vec2 pos = (u_itransform * vec3( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t,1.0)).xy;
					//vec2 pos = vec2( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t);
					vec2 AP = pos - u_gradient.xy;
					vec2 AB = u_gradient.zw - u_gradient.xy;
					float dotAPAB = dot(AP,AB);
					float dotABAB = dot(AB,AB);
					float x = dotAPAB / dotABAB;
					vec2 uv = vec2( x, 0.0 );
					gl_FragColor = u_color * texture2D( u_texture, uv );
				}
			`,r);var I=`
			precision highp float;
			attribute vec3 a_vertex;
			attribute vec2 a_coord;
			varying vec2 v_coord;
			uniform vec2 u_viewport;
			uniform mat3 u_transform;
			#ifdef EXTRA_PROJECTION
				uniform bool u_projection_enabled;
				uniform mat4 u_projection;
			#endif
			uniform float u_pointSize;
			void main() { 
				vec3 pos = a_vertex;
				pos = u_transform * pos;
				pos.z = 0.0;
				#ifdef EXTRA_PROJECTION
					if(u_projection_enabled)
					{
						gl_Position = u_projection * vec4(pos.xy,0.0,1.0);
						return;
					}
				#endif
				//normalize
				pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
				pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
				gl_Position = vec4(pos, 1.0); 
				gl_PointSize = ceil(u_pointSize);
				v_coord = a_coord;
			}
			`,V=`
			precision highp float;
			uniform sampler2D u_texture;
			uniform float u_iCharSize;
			uniform vec4 u_color;
			uniform float u_pointSize;
			uniform vec2 u_viewport;
			uniform vec2 u_angle_sincos;
			varying vec2 v_coord;
			void main() {
				vec2 uv = vec2(1.0 - gl_PointCoord.s, gl_PointCoord.t);
				uv = vec2( ((uv.y - 0.5) * u_angle_sincos.y - (uv.x - 0.5) * u_angle_sincos.x) + 0.5, ((uv.x - 0.5) * u_angle_sincos.y + (uv.y - 0.5) * u_angle_sincos.x) + 0.5);
				uv = v_coord - uv * u_iCharSize + vec2(u_iCharSize*0.5);
				uv.y = 1.0 - uv.y;
				gl_FragColor = vec4(u_color.xyz, u_color.a * texture2D(u_texture, uv, -1.0  ).a);
      }
			`;M=new GL$1.Shader(I,V,r)}L.createImageShader=function(I){return new GL$1.Shader(GL$1.Shader.QUAD_VERTEX_SHADER,`
			precision highp float;
			uniform sampler2D u_texture;
			uniform vec4 u_color;
			uniform vec4 u_texture_transform;
			uniform vec2 u_viewport;
			varying vec2 v_coord;
			void main() {
				vec2 uv = v_coord * u_texture_transform.zw + vec2(u_texture_transform.x,0.0);
				uv.y = uv.y - u_texture_transform.y + (1.0 - u_texture_transform.w);
				uv = clamp(uv,vec2(0.0),vec2(1.0));
				vec4 color = u_color * texture2D(u_texture, uv);
				`+I+`;
				gl_FragColor = color;
			}
		`,r)},L.WebGLCanvas.vertex_shader=a,L._matrix=mat3.create();var O=mat3.create(),B=vec2.create(),H=vec4.create(),z=vec4.create(),k=vec2.create();L._stack=[],L._stack_size=0;var X=0,Q=L.viewport_data.subarray(2,4);L.translate=function(I,V){B[0]=I,B[1]=V,mat3.translate(this._matrix,this._matrix,B)},L.rotate=function(I){mat3.rotate(this._matrix,this._matrix,I),X+=I},L.scale=function(I,V){B[0]=I,B[1]=V,mat3.scale(this._matrix,this._matrix,B)},L.resetTransform=function(){u._stack_size=0,this._matrix.set([1,0,0,0,1,0,0,0,1]),X=0},L.save=function(){if(!(this._stack_size>=32)){var I=null;this._stack_size==this._stack.length?I=this._stack[this._stack_size]={matrix:mat3.create(),fillColor:vec4.create(),strokeColor:vec4.create(),shadowColor:vec4.create(),globalAlpha:1,font:"",fontFamily:"",fontSize:14,fontMode:"",textAlign:"",clip_level:0}:I=this._stack[this._stack_size],this._stack_size++,I.matrix.set(this._matrix),I.fillColor.set(this._fillcolor),I.strokeColor.set(this._strokecolor),I.shadowColor.set(this._shadowcolor),I.globalAlpha=this._globalAlpha,I.font=this._font,I.fontFamily=this._font_family,I.fontSize=this._font_size,I.fontMode=this._font_mode,I.textAlign=this.textAlign,I.clip_level=this.clip_level}},L.restore=function(){if(this._stack_size==0){mat3.identity(this._matrix),X=0;return}this._stack_size--;var I=this._stack[this._stack_size];this._matrix.set(I.matrix),this._fillcolor.set(I.fillColor),this._strokecolor.set(I.strokeColor),this._shadowcolor.set(I.shadowColor),this._globalAlpha=I.globalAlpha,this._font=I.font,this._font_family=I.fontFamily,this._font_size=parseInt(I.fontSize),this._font_mode=I.fontMode,this.textAlign=I.textAlign;var V=this.clip_level;this.clip_level=I.clip_level,X=Math.atan2(this._matrix[3],this._matrix[4]),V==this.clip_level||(this.clip_level==0?(u.enable(u.STENCIL_TEST),u.clearStencil(0),u.clear(u.STENCIL_BUFFER_BIT),u.disable(u.STENCIL_TEST)):(u.stencilFunc(u.LEQUAL,this.clip_level,255),u.stencilOp(u.KEEP,u.KEEP,u.KEEP)))},L.clip=function(){this.clip_level==0,this.clip_level++,u.colorMask(!1,!1,!1,!1),u.depthMask(!1),u.enable(u.STENCIL_TEST),u.stencilFunc(u.EQUAL,this.clip_level-1,255),u.stencilOp(u.KEEP,u.KEEP,u.INCR),this.fill(),u.colorMask(!0,!0,!0,!0),u.depthMask(!0),u.stencilFunc(u.EQUAL,this.clip_level,255),u.stencilOp(u.KEEP,u.KEEP,u.KEEP)},L.clipImage=function(I,V,Z,j,re){this.clip_level++,u.colorMask(!1,!1,!1,!1),u.depthMask(!1),u.enable(u.STENCIL_TEST),u.stencilFunc(u.EQUAL,this.clip_level-1,255),u.stencilOp(u.KEEP,u.KEEP,u.INCR),this.drawImage(I,V,Z,j,re,p),u.colorMask(!0,!0,!0,!0),u.depthMask(!0),u.stencilFunc(u.EQUAL,this.clip_level,255),u.stencilOp(u.KEEP,u.KEEP,u.KEEP)},L.transform=function(I,V,Z,j,re,ae){var oe=O;oe[0]=I,oe[1]=V,oe[2]=0,oe[3]=Z,oe[4]=j,oe[5]=0,oe[6]=re,oe[7]=ae,oe[8]=1,mat3.multiply(this._matrix,this._matrix,oe),X=Math.atan2(this._matrix[0],this._matrix[1])},L.setTransform=function(I,V,Z,j,re,ae){var oe=this._matrix;oe[0]=I,oe[1]=V,oe[2]=0,oe[3]=Z,oe[4]=j,oe[5]=0,oe[6]=re,oe[7]=ae,oe[8]=1,X=Math.atan2(this._matrix[0],this._matrix[1])};function te(I){var V=null;if(I.constructor===GL$1.Texture)return I._context_id==u.context_id?I:null;if(I.gl||(I.gl={}),I.src){var Z=u.REPEAT;return V=I.gl[u.context_id],V?(I.mustUpdate&&(V.uploadData(I),I.mustUpdate=!1),V):I.gl[u.context_id]=GL$1.Texture.fromImage(I,{magFilter:u.LINEAR,minFilter:u.LINEAR_MIPMAP_LINEAR,wrap:Z,ignore_pot:!0,premultipliedAlpha:!0,anisotropic:e})}else return V=I.gl[u.context_id],V?(I.mustUpdate&&(V.uploadData(I),I.mustUpdate=!1),V):I.gl[u.context_id]=GL$1.Texture.fromImage(I,{minFilter:u.LINEAR,magFilter:u.LINEAR,anisotropic:e})}L.drawImage=function(I,V,Z,j,re,ae){if(I){var oe=I.videoWidth||I.width,_e=I.videoHeight||I.height;if(!(oe==0||_e==0)){var ce=te(I);ce&&(arguments.length==9?(z.set([V/oe,Z/_e,j/oe,re/_e]),V=arguments[5],Z=arguments[6],j=arguments[7],re=arguments[8],ae=_):z.set([0,0,1,1]),B[0]=V,B[1]=Z,k[0]=j===void 0?ce.width:j,k[1]=re===void 0?ce.height:re,ce.bind(0),ce!==I&&u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,this.imageSmoothingEnabled?u.LINEAR:u.NEAREST),this.tintImages||(H[0]=H[1]=H[2]=1,H[3]=this._globalAlpha),t.u_color=this.tintImages?this._fillcolor:H,t.u_position=B,t.u_size=k,t.u_transform=this._matrix,t.u_texture_transform=z,t.u_viewport=Q,ae=ae||f,ae.uniforms(t).draw(P),U[14]-=.001)}}},L.createPattern=function(I){return te(I)};function D(I,V,Z,j){this.id=L._last_gradient_id++%L._max_gradients,this.points=new Float32Array([I,V,Z,j]),this.stops=[],this._must_update=!0}L._last_gradient_id=0,L._max_gradients=16,L._gradients_pool=[],D.prototype.addColorStop=function(I,V){var Z=hexColorToRGBA(V),j=new Uint8Array(4);j[0]=Math.clamp(Z[0],0,1)*255,j[1]=Math.clamp(Z[1],0,1)*255,j[2]=Math.clamp(Z[2],0,1)*255,j[3]=Math.clamp(Z[3],0,1)*255,this.stops.push([I,j]),this.stops.sort(function(re,ae){return re[0]>ae[0]?1:ae[0]>re[0]?-1:0}),this._must_update=!0},D.prototype.toTexture=function(){if(this._texture||(this.id!=-1&&(this._texture=L._gradients_pool[this.id]),this._texture||(this._texture=new GL$1.Texture(128,1,{format:u.RGBA,magFilter:u.LINEAR,wrap:u.CLAMP_TO_EDGE,minFilter:u.NEAREST}),this.id!=-1&&(L._gradients_pool[this.id]=this._texture))),!this._must_update)return this._texture;if(this._must_update=!1,this.stops.length<1)return this._texture;if(this.stops.length<2)return this._texture.fill(this.stops[0][1]),this._texture;for(var I=0,V=this.stops[I],Z=this.stops[I+1],j=new Uint8Array(128*4),re=0;re<128;re+=1){var ae=j.subarray(re*4,re*4+4),oe=re/128;if(V[0]>oe)if(I==0)ae.set(V[1]);else{if(I+=1,V=this.stops[I],Z=this.stops[I+1],!Z)break;re-=1}else if(V[0]<=oe&&oe<Z[0]){var _e=(oe-V[0])/(Z[0]-V[0]);vec4.lerp(ae,V[1],Z[1],_e)}else if(Z[0]<=oe){if(I+=1,V=this.stops[I],Z=this.stops[I+1],!Z)break;re-=1}}if(re<128)for(var ce=re;ce<128;ce+=1)j.set(V[1],ce*4);return this._texture.uploadData(j),this._texture},L.createLinearGradient=function(I,V,Z,j){return new D(I,V,Z,j)},L.beginPath=function(){A=0},L.closePath=function(){A<3||(N[A]=N[0],N[A+1]=N[1],N[A+2]=1,A+=3)},L.moveTo=function(I,V){A==0?(N[A]=I,N[A+1]=V,N[A+2]=1,A+=3):(N[A]=N[A-3],N[A+1]=N[A-2],N[A+2]=0,A+=3,N[A]=I,N[A+1]=V,N[A+2]=0,A+=3)},L.lineTo=function(I,V){N[A]=I,N[A+1]=V,N[A+2]=1,A+=3},L.bezierCurveTo=function(I,V,Z,j,re,ae){if(!(A<3))for(var oe=[N[A-3],N[A-2]],_e=[oe,[I,V],[Z,j],[re,ae]],ce=0;ce<=d;ce++){var fe=ce/d,ge,pe,de,me,Ee,Te,we,be;de=3*(_e[1][0]-_e[0][0]),pe=3*(_e[2][0]-_e[1][0])-de,ge=_e[3][0]-_e[0][0]-de-pe,Te=3*(_e[1][1]-_e[0][1]),Ee=3*(_e[2][1]-_e[1][1])-Te,me=_e[3][1]-_e[0][1]-Te-Ee,we=fe*fe,be=we*fe;var Ce=ge*be+pe*we+de*fe+_e[0][0],Se=me*be+Ee*we+Te*fe+_e[0][1];N[A]=Ce,N[A+1]=Se,N[A+2]=1,A+=3}},L.quadraticCurveTo=function(I,V,Z,j){if(!(A<3))for(var re=N[A-3],ae=N[A-2],oe=0;oe<=d;oe++){var _e=oe/d,ce=1-_e,fe=re*ce+I*_e,ge=ae*ce+V*_e,pe=I*ce+Z*_e,de=V*ce+j*_e;N[A]=fe*ce+pe*_e,N[A+1]=ge*ce+de*_e,N[A+2]=1,A+=3}},L.fill=function(){if(!(A<9)){R.uploadRange(0,A*4),t.u_viewport=Q;var I=T;this._shadowcolor[3]>0&&(t.u_color=this._shadowcolor,this.save(),this.translate(this.shadowOffsetX,this.shadowOffsetY),I.uniforms(t).drawRange(C,u.TRIANGLE_FAN,0,A/3),this.restore()),t.u_color=this._fillcolor,t.u_transform=this._matrix;var V=this._fillStyle;if(V.constructor===D){var Z=V,j=Z.toTexture();t.u_color=[1,1,1,this.globalAlpha],t.u_gradient=Z.points,t.u_texture=0,t.u_itransform=mat3.invert(O,this._matrix),j.bind(0),I=b}else if(V.constructor===GL$1.Texture){var j=V;t.u_color=[1,1,1,this._globalAlpha],t.u_texture=0,H.set([0,0,1/j.width,1/j.height]),t.u_texture_transform=H,t.u_itransform=mat3.invert(O,this._matrix),j.bind(0),I=S}I.uniforms(t).drawRange(C,u.TRIANGLE_FAN,0,A/3),U[14]-=.001}},L.strokeThin=function(){A<6||(R.uploadRange(0,A*4),u.setLineWidth(this.lineWidth),t.u_color=this._strokecolor,t.u_transform=this._matrix,t.u_viewport=Q,T.uniforms(t).drawRange(C,u.LINE_STRIP,0,A/3))};var J=new Float32Array(g*3),ee=new GL$1.Mesh,Y=ee.createVertexBuffer("vertices",null,null,J,u.STREAM_DRAW);L.stroke=function(){if(!(A<6)){if(B[0]=this._matrix[0],B[1]=this._matrix[1],this.lineWidth*vec2.length(B)<=1)return this.strokeThin();var I=J,V=A,Z=this.lineWidth*.5,j=N,re=0,ae=0,oe=0,_e=0,ce=0,fe=0,ge=0,pe=0;if(j[0]==j[A-3]&&j[1]==j[A-2]){re=j[A-3]-j[A-6],ae=j[A-2]-j[A-5];var de=Math.sqrt(re*re+ae*ae);de!=0&&(re=re/de,ae=ae/de)}var me,Ee=0;for(me=0;me<V-3;me+=3){oe=re,_e=ae,re=j[me+3]-j[me],ae=j[me+4]-j[me+1];var de=Math.sqrt(re*re+ae*ae);de!=0&&(re=re/de,ae=ae/de),me==0&&(ge=re,pe=ae),ce=re+oe,fe=ae+_e;var de=Math.sqrt(ce*ce+fe*fe);de!=0&&(ce=ce/de,fe=fe/de),I[Ee+0]=j[me]-fe*Z,I[Ee+1]=j[me+1]+ce*Z,I[Ee+2]=1,I[Ee+3]=j[me]+fe*Z,I[Ee+4]=j[me+1]-ce*Z,I[Ee+5]=1,Ee+=6}if(j[0]==j[A-3]&&j[1]==j[A-2]){ce=re+ge,fe=ae+pe;var de=Math.sqrt(ce*ce+fe*fe);de!=0&&(ce=ce/de,fe=fe/de),I[Ee+0]=j[me]-fe*Z,I[Ee+1]=j[me+1]+ce*Z,I[Ee+2]=1,I[Ee+3]=j[me]+fe*Z,I[Ee+4]=j[me+1]-ce*Z,I[Ee+5]=1}else{var de=Math.sqrt(re*re+ae*ae);de!=0&&(ce=re/de,fe=ae/de),I[Ee+0]=j[me]-(fe-ce)*Z,I[Ee+1]=j[me+1]+(ce+fe)*Z,I[Ee+2]=1,I[Ee+3]=j[me]+(fe+ce)*Z,I[Ee+4]=j[me+1]-(ce-fe)*Z,I[Ee+5]=1}Ee+=6,Y.upload(u.STREAM_DRAW),Y.uploadRange(0,Ee*4),t.u_transform=this._matrix,t.u_viewport=Q,this._shadowcolor[3]>0&&(t.u_color=this._shadowcolor,this.save(),this.translate(this.shadowOffsetX,this.shadowOffsetY),T.uniforms(t).drawRange(C,u.TRIANGLE_STRIP,0,Ee/3),this.restore()),t.u_color=this._strokecolor,T.uniforms(t).drawRange(ee,u.TRIANGLE_STRIP,0,Ee/3),U[14]-=.001}},L.rect=function(I,V,Z,j){N[A]=I,N[A+1]=V,N[A+2]=1,N[A+3]=I+Z,N[A+4]=V,N[A+5]=1,N[A+6]=I+Z,N[A+7]=V+j,N[A+8]=1,N[A+9]=I,N[A+10]=V+j,N[A+11]=1,N[A+12]=I,N[A+13]=V,N[A+14]=1,A+=15},L.roundRect=function(I,V,Z,j,re,ae){var oe=0,_e=0,ce=0,fe=0;if(re===0){this.rect(I,V,Z,j);return}if(ae===void 0&&(ae=re),re!=null&&re.constructor===Array)if(re.length==1)oe=_e=ce=fe=re[0];else if(re.length==2)oe=fe=re[0],_e=ce=re[1];else if(re.length==4)oe=re[0],_e=re[1],ce=re[2],fe=re[3];else return;else oe=re||0,_e=re||0,ce=ae||0,fe=ae||0;var ge=N,pe=A;if(oe>0)for(var de=0;de<10;++de){var me=de/10*Math.PI*.5;ge[pe]=I+oe*(1-Math.cos(me)),ge[pe+1]=V+oe*(1-Math.sin(me)),ge[pe+2]=1,pe+=3}if(ge[pe+0]=I+oe,ge[pe+1]=V,ge[pe+2]=1,ge[pe+3]=I+Z-_e,ge[pe+4]=V,ge[pe+5]=1,pe+=6,_e>0)for(var de=0;de<10;++de){var me=de/10*Math.PI*.5;ge[pe+0]=I+Z-_e*(1-Math.sin(me)),ge[pe+1]=V+_e*(1-Math.cos(me)),ge[pe+2]=1,pe+=3}if(ge[pe+0]=I+Z,ge[pe+1]=V+_e,ge[pe+2]=1,ge[pe+3]=I+Z,ge[pe+4]=V+j-fe,ge[pe+5]=1,pe+=6,fe>0)for(var de=0;de<10;++de){var me=de/10*Math.PI*.5;ge[pe+0]=I+Z-fe*(1-Math.cos(me)),ge[pe+1]=V+j-fe*(1-Math.sin(me)),ge[pe+2]=1,pe+=3}if(ge[pe+0]=I+Z-fe,ge[pe+1]=V+j,ge[pe+2]=1,ge[pe+3]=I+ce,ge[pe+4]=V+j,ge[pe+5]=1,pe+=6,ce>0)for(var de=0;de<10;++de){var me=de/10*Math.PI*.5;ge[pe+0]=I+ce*(1-Math.sin(me)),ge[pe+1]=V+j-ce*(1-Math.cos(me)),ge[pe+2]=1,pe+=3}ge[pe+0]=I,ge[pe+1]=V+oe,ge[pe+2]=1,A=pe+3},L.arc=function(I,V,Z,j,re){var ae=Math.max(Math.abs(this._matrix[0]),Math.abs(this._matrix[1]),Math.abs(this._matrix[3]),Math.abs(this._matrix[4])),oe=Math.ceil(Z*2*ae+1);if(!(oe<1)){oe=Math.min(oe,1024),j=j===void 0?0:j,re=re===void 0?Math.PI*2:re;for(var _e=(re-j)/oe,ce=0;ce<=oe;ce++){var fe=j+ce*_e;this.lineTo(I+Math.cos(fe)*Z,V+Math.sin(fe)*Z)}}},L.strokeRect=function(I,V,Z,j){this.beginPath(),this.rect(I,V,Z,j),this.stroke()},L.fillRect=function(I,V,Z,j){if(A=0,this._fillStyle.constructor==GL$1.Texture||this._fillStyle.constructor===D){this.beginPath(),this.rect(I,V,Z,j),this.fill();return}t.u_color=this._fillcolor,B[0]=I,B[1]=V,k[0]=Z,k[1]=j,t.u_position=B,t.u_size=k,t.u_transform=this._matrix,t.u_viewport=Q,h.uniforms(t).draw(P),U[14]-=.001},L.clearRect=function(I,V,Z,j){(I!=0||V!=0||Z!=l.width||j!=l.height)&&(u.enable(u.SCISSOR_TEST),u.scissor(I,V,Z,j)),u.clear(u.COLOR_BUFFER_BIT);var re=u.viewport_data;u.scissor(re[0],re[1],re[2],re[3]),u.disable(u.SCISSOR_TEST)},L.fillCircle=function(I,V,Z){if(A=0,this._fillStyle.constructor==GL$1.Texture||this._fillStyle.constructor===D){this.beginPath(),this.arc(I,V,Z,0,Math.PI*2),this.fill();return}t.u_color=this._fillcolor,B[0]=I,B[1]=V,k[0]=Z,k[1]=Z,t.u_position=B,t.u_size=k,t.u_transform=this._matrix,t.u_viewport=Q,h.uniforms(t).draw(F),U[14]-=.001},L.start2D=function(){E=window.gl,window.gl=this;var I=this;I.disable(I.CULL_FACE),I.disable(I.DEPTH_TEST),I.disable(I.STENCIL_TEST),I.enable(I.BLEND),I.blendFunc(I.SRC_ALPHA,I.ONE_MINUS_SRC_ALPHA),I.blendEquation(I.FUNC_ADD),I.lineWidth=1,A=0,mat4.identity(U),this.clip_level=0},L.finish2D=function(){A=0,u.lineWidth=1,window.gl=E,u.disable(u.STENCIL_TEST)};var $=new Float32Array(m*3),W=new Float32Array(m*2),ie=new GL$1.Mesh,K=ie.createVertexBuffer("vertices",null,null,$,u.STREAM_DRAW),se=ie.createVertexBuffer("coords",null,null,W,u.STREAM_DRAW);L.fillText=L.strokeText=function(I,V,Z){if(I==null)return;I.constructor!==String&&(I=String(I));let j=0;const{textures:re,info:ae}=le.call(this,this._font_family,this._font_mode),oe=$,_e=W,ce=this._font_size*1.1;ce<1&&(ce=1);let fe=0,ge=0;const pe=I.length,de=ae.spacing,me=ae.kernings;let Ee=!0,Te=0,we=0,be=-1;function Ce(){if(Te===0||we===0||be===-1)return;K.uploadRange(0,Te*4),se.uploadRange(0,we*4),t.u_color=this._fillcolor,t.u_pointSize=ce*vec2.length(this._matrix),t.u_iCharSize=ae.char_size/j,t.u_transform=this._matrix,t.u_viewport=Q,t.u_angle_sincos||(t.u_angle_sincos=vec2.create());const ye=X;X=0,t.u_angle_sincos[1]=Math.sin(-X),t.u_angle_sincos[0]=-Math.cos(-X),X=ye,M.uniforms(t).drawRange(ie,u.POINTS,0,Te/3),Te=0,we=0}for(let ye=0;ye<pe;ye++){const Le=I.charCodeAt(ye),Ae=ae.pages[Le];if(!Ae){Le===10?(fe=0,ge+=ce,Ee=!0):fe+=ce*.5;continue}const[Me,Re,Ne,Be]=Ae;if(Ne!==be)if(Ce.call(this),be=Ne,re[Ne])re[Ne].bind(0),j=re[Ne].width;else{console.error(`Page ${Ne} not found in textures.`);continue}const xe=me[I[ye]];Ee&&(fe-=ce*((xe==null?void 0:xe.nwidth)||0)*.25,Ee=!1),oe[Te+0]=V+fe+ce*.5,oe[Te+1]=Z+ge-ce*.25,oe[Te+2]=1,Te+=3,_e[we+0]=Me,_e[we+1]=Re,we+=2;const Oe=me[I[ye+1]]?me[I[ye+1]].nwidth:de/ae.char_size;fe+=ce*Oe}Ce.call(this);let Se=0;if(this.textAlign==="right"?Se=fe+ce*.5:this.textAlign==="center"&&(Se=(fe+ce*.5)*.5),Se)for(let ye=0;ye<Te;ye+=3)oe[ye]-=Se;return{x:fe,y:ge}},L.measureText=function(I){const{info:V}=le.call(this,this._font_family,this._font_mode),Z=Math.ceil(this._font_size*(V.line_height||1));let j=0;const re=Z*(V.spacing/V.char_size);for(let ae=0;ae<I.length;++ae){const oe=V.kernings[I[ae]];oe?j+=oe.nwidth:j+=re}return j*=Z,{width:j,height:Z}},L.cacheFontAtlas=function(I="monospace",V="normal",Z=!1){const j=`:font_${I}:${V}:${enableWebGLCanvas.useInternationalFont}`;if(!Z&&s[j])return s[j];const re=le.call(this,I,V,Z);return s[j]=re,re},L.loadCachedTextures=async function(){const I=await getAllData();if(I&&(I==null?void 0:I.length)>0)for(let V in I){const Z=I[V];s[Z.name]=Z}};function le(I="monospace",V="normal",Z=!1){const j=`:font_${I}:${V}:${enableWebGLCanvas.useInternationalFont}`;if(!Z&&s[j])return s[j];const re=enableWebGLCanvas.useInternationalFont;let ae=1024,oe=10,_e=200;re&&(_e=55203,oe=20,ae=2048);const ce=this.imageSmoothingEnabled,fe=Math.floor(ae/oe),ge=Math.floor(fe*.95);let pe=.5,de=ge*-.15;const me=[],Ee={font_size:ge,char_size:fe,spacing:fe*.6,space:null,kernings:{},pages:[]},Te=ye=>ye>=32&&ye<=47||ye>=58&&ye<=64||ye>=91&&ye<=96||ye>=123&&ye<=126,we=ye=>ye>=65&&ye<=90||ye>=97&&ye<=122||ye>=48&&ye<=57||ye>=32&&ye<=47||ye>=58&&ye<=64||ye>=91&&ye<=96||ye>=123&&ye<=126||ye>=44032&&ye<=55203||ye>=127744&&ye<=128767,be=[];for(let ye=32;ye<=_e;ye++)we(ye)&&be.push(ye);const Ce=Math.ceil(be.length/(oe*oe));for(let ye=0;ye<Ce;ye++){const Le=createCanvas(ae,ae),Ae=Le.getContext("2d");Ae.fillStyle="white",Ae.imageSmoothingEnabled=ce,Ae.clearRect(0,0,Le.width,Le.height),Ae.font=`${V} ${ge}px ${I}`,Ae.textAlign="center";let Me=0,Re=0;const Ne=ye*oe*oe,Be=Math.min(be.length,Ne+oe*oe);for(let Oe=Ne;Oe<Be;Oe++){const De=be[Oe],Ie=String.fromCharCode(De);let Fe=Ae.measureText(Ie).width;Te(De)&&Fe<50&&(Fe*=1.8),Ee.kernings[Ie]={width:Fe,nwidth:Fe/ge},Ee.pages[De]=[(Me+fe*.5)/Le.width,(Re+fe*.5)/Le.height,ye,Ie],Ae.save(),Ae.beginPath(),Ae.rect(Math.floor(Me)+.5,Math.floor(Re)+.5,fe-2,fe-2),Ae.clip(),Ae.fillText(Ie,Math.floor(Me+fe*pe),Math.floor(Re+fe+de),fe),Ae.restore(),Me+=fe,Me+fe>Le.width&&(Me=0,Re+=fe)}const xe=GL$1.Texture.fromImage(Le,{format:u.RGBA,magFilter:u.LINEAR,minFilter:u.LINEAR_MIPMAP_LINEAR,premultiply_alpha:!1,anisotropic:1});me.push(xe)}Ee.space=Ee.kernings[" "]?Ee.kernings[" "].width/ge:0;const Se={textures:me,info:Ee,name:j};return s[j]=Se,saveComplexData(Se,1),s[j]}L.getImageData=function(I,V,Z,j){var re=new Uint8Array(Z*j*4);return u.readPixels(I,V,Z,j,u.RGBA,u.UNSIGNED_BYTE,re),{data:re,width:Z,height:j,resolution:1}},L.putImageData=function(I,V,Z){var j=new GL$1.Texture(I.width,I.height,{filter:u.NEAREST,pixel_data:I.data});j.renderQuad(V,Z,j.width,j.height)},Object.defineProperty(u,"fillStyle",{get:function(){return this._fillStyle},set:function(I){I&&(this._fillStyle=I,hexColorToRGBA(I,this._fillcolor,this._globalAlpha))}}),Object.defineProperty(u,"strokeStyle",{get:function(){return this._strokeStyle},set:function(I){I&&(this._strokeStyle=I,hexColorToRGBA(I,this._strokecolor,this._globalAlpha))}}),Object.defineProperty(u,"fillColor",{get:function(){return this._fillcolor},set:function(I){I&&(I.length<5?this._fillcolor.set(I):console.error("fillColor value has more than 4 components"))}}),Object.defineProperty(u,"strokeColor",{get:function(){return this._strokecolor},set:function(I){I&&(I.length<5?this._strokecolor.set(I):console.error("strokeColor value has more than 4 components"))}}),Object.defineProperty(u,"shadowColor",{get:function(){return this._shadowcolor},set:function(I){I&&hexColorToRGBA(I,this._shadowcolor,this._globalAlpha)}}),Object.defineProperty(u,"globalAlpha",{get:function(){return this._globalAlpha},set:function(I){this._globalAlpha=I,this._strokecolor[3]=this._fillcolor[3]=I}}),Object.defineProperty(u,"globalCompositeOperation",{get:function(){return this._globalCompositeOperation},set:function(I){switch(this._globalCompositeOperation=I,u.blendEquation(u.FUNC_ADD),I){case"source-over":u.blendFunc(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA);break;case"difference":u.blendFunc(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA),u.blendEquation(u.FUNC_REVERSE_SUBTRACT);break}}}),Object.defineProperty(u,"font",{get:function(){return this._font},set:function(I){this._font=I;var V=I.split(" ");V.length>=3?(this._font_mode=V[0],this._font_size=parseFloat(V[1]),Number.isNaN(this._font_size)&&(this._font_size=14),this._font_size<5&&(this._font_size=5),this._font_family=V[2]):V.length==2?(this._font_mode="normal",this._font_size=parseFloat(V[0]),Number.isNaN(this._font_size)&&(this._font_size=14),this._font_size<5&&(this._font_size=5),this._font_family=V[1]):(this._font_mode="normal",this._font_family=V[0])}}),L._fillcolor=vec4.fromValues(0,0,0,1),L._strokecolor=vec4.fromValues(0,0,0,1),L._shadowcolor=vec4.fromValues(0,0,0,0),L._globalAlpha=1,L._font="14px monospace",L._font_family="monospace",L._font_size="14px",L._font_mode="normal",L.clip_level=0,L.strokeStyle="rgba(0,0,0,1)",L.fillStyle="rgba(0,0,0,1)",L.shadowColor="transparent",L.shadowOffsetX=L.shadowOffsetY=0,L.globalAlpha=1,L.globalCompositeOperation="source-over",L.setLineWidth=L.lineWidth,L.lineWidth=4,L.imageSmoothingEnabled=!0,L.tintImages=!1;var ue=["arcTo","isPointInPath","createImageData"],he=function(){};for(var ve in ue)L[ue[ve]]=he;return L}function openDatabase(){return new Promise((l,n)=>{const u=indexedDB.open("WebglContextDB",2);u.onupgradeneeded=function(c){var g;const d=c.target.result;(g=d.objectStoreNames)!=null&&g.contains("fontTexture")||d.createObjectStore("fontTexture",{keyPath:"name"})},u.onsuccess=function(c){l(c.target.result)},u.onerror=function(c){n(c.target.error)}})}async function makeTexture(l){const n=base64ToBlob(l.data),u=await blobToImage(n),c=GL$1.Texture.fromImage(u);return c.wrapS=l.wrapS||c.gl.CLAMP_TO_EDGE,c.wrapT=l.wrapT||c.gl.CLAMP_TO_EDGE,c.minFilter=l.minFilter||c.gl.LINEAR,c.magFilter=l.magFilter||c.gl.LINEAR,c.format=l.format||c.format,c.internalFormat=l.internalFormat||c.internalFormat,c.type=l.type||c.type,c.texture_type=l.texture_type||c.texture_type,c.width=l.width||c.width,c.height=l.height||c.height,l=c,l}function base64ToBlob(l){const n=atob(l.split(",")[1]),u=l.split(",")[0].split(":")[1].split(";")[0],c=new Array(n.length);for(let g=0;g<n.length;g++)c[g]=n.charCodeAt(g);const d=new Uint8Array(c);return new Blob([d],{type:u})}function blobToImage(l){return new Promise((n,u)=>{const c=new Image;c.onload=()=>n(c),c.onerror=u,c.src=URL.createObjectURL(l)})}function textureToBase64(l){const n=l.gl,u=l.handler,c=l.width,d=l.height,g=n.createFramebuffer();if(n.bindFramebuffer(n.FRAMEBUFFER,g),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,u,0),n.checkFramebufferStatus(n.FRAMEBUFFER)!==n.FRAMEBUFFER_COMPLETE)return console.error("Framebuffer is not complete."),n.bindFramebuffer(n.FRAMEBUFFER,null),n.deleteFramebuffer(g),null;const m=new Uint8Array(c*d*4),E=l.format||n.RGBA,L=l.type||n.UNSIGNED_BYTE;try{n.readPixels(0,0,c,d,E,L,m)}catch(P){return console.error("Error reading pixels from framebuffer:",P),null}const A=document.createElement("canvas");A.width=c,A.height=d;const N=A.getContext("2d"),C=N.createImageData(c,d);for(let P=0;P<d;P++){const F=P*c*4,U=(d-P-1)*c*4;C.data.set(m.subarray(F,F+c*4),U)}N.putImageData(C,0,0);const R=A.toDataURL("image/png");return n.bindFramebuffer(n.FRAMEBUFFER,null),n.deleteFramebuffer(g),R}async function saveComplexData(l,n=1){var u;try{const g=(await openDatabase()).transaction("fontTexture","readwrite").objectStore("fontTexture"),E=(u=l.textures)==null?void 0:u.map(C=>{const{width:R,height:P,format:F,internalFormat:U,type:e,wrapS:t,wrapT:r,minFilter:s,magFilter:a,has_mipmaps:o,texture_type:h}=C,f=textureToBase64(C);return{width:R,height:P,format:F,internalFormat:U,type:e,wrapS:t,wrapT:r,minFilter:s,magFilter:a,has_mipmaps:o,texture_type:h,data:f}}),L=new Date;L.setDate(L.getDate()+n);const A={info:l.info,textures:E,name:l.name,expiresAt:L.toISOString()},N=g.put(A);N.onsuccess=function(){},N.onerror=function(C){console.error("Error saving data:",C)}}catch(c){console.error("Error in saveComplexData:",c)}}async function getAllData(){const l=await openDatabase();return new Promise((n,u)=>{const d=l.transaction("fontTexture","readwrite").objectStore("fontTexture"),g=d.getAll();g.onsuccess=async function(m){const L=m.target.result.filter(A=>{const N=new Date,C=new Date(A.expiresAt);return N<C?!0:(d.delete(A.name),!1)});if((L==null?void 0:L.length)===0){n([]);return}for(const A of L)A.textures=await Promise.all(A.textures.map(async N=>makeTexture(N)));n(L)},g.onerror=function(m){console.error("Error retrieving data:",m.target.error),u(m.target.error)}})}enableWebGLCanvas.useInternationalFont=!0,enableWebGLCanvas.fontOffsetY=0;let LiteGraph$1=(q=class{constructor(){}static distance(n,u){return Math.sqrt((u[0]-n[0])*(u[0]-n[0])+(u[1]-n[1])*(u[1]-n[1]))}static isInsideRectangle(n,u,c,d,g,m){return c<n&&c+g>n&&d<u&&d+m>u}static closeAllContextMenus(n){n=n||window;let u=n.document.querySelectorAll(".litecontextmenu");if(!u.length)return;let c=[];for(let d=0;d<u.length;d++)c.push(u[d]);for(let d=0;d<c.length;d++)c[d].close?c[d].close():c[d].parentNode&&c[d].parentNode.removeChild(c[d])}static extendClass(n,u){var c,d,g,m;for(const E in u)Object.prototype.hasOwnProperty.call(n,E)||(n[E]=u[E]);if(u.prototype)for(const E in u.prototype){if(!Object.prototype.hasOwnProperty.call(u.prototype,E)||Object.prototype.hasOwnProperty.call(n.prototype,E))continue;const L=(d=(c=u.prototype).__lookupGetter__)==null?void 0:d.call(c,E),A=(m=(g=u.prototype).__lookupSetter__)==null?void 0:m.call(g,E);L?n.prototype.__defineGetter__(E,L):n.prototype[E]=u.prototype[E],A&&n.prototype.__defineSetter__(E,A)}}static getParameterNames(n){return(n+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)}static pointerListenerAdd(n,u,c,d=!1){if(!n||!n.addEventListener||!u||typeof c!="function")return;let g=q.pointerevents_method,m=u;if(g==="pointer"&&!window.PointerEvent){console.warn("PointerEvent not supported. Converting to touch event.");const L={down:"start",move:"move",up:"end",cancel:"cancel"};L[m]?(g="touch",m=L[m]):m==="enter"?console.log("debug: Should I send a move event?"):console.warn(`Event ${m} will not be called`)}if(["down","up","move","over","out","enter","leave","cancel","gotpointercapture","lostpointercapture"].includes(m)&&(g!=="mouse"||["down","up","move","over","out","enter"].includes(m))){n.addEventListener(g+m,c,d);return}n.addEventListener(m,c,d)}static pointerListenerRemove(n,u,c,d=!1){if(!n||!n.removeEventListener||!u||typeof c!="function")return;const g=q.pointerevents_method,m=["down","up","move","over","out","enter"],E=["leave","cancel","gotpointercapture","lostpointercapture"];if(m.includes(u)&&(g==="pointer"||g==="mouse")){n.removeEventListener(g+u,c,d);return}if(E.includes(u)&&g==="pointer"){n.removeEventListener(g+u,c,d);return}n.removeEventListener(u,c,d)}static overlapBounding(n,u){let c=n[0]+n[2],d=n[1]+n[3],g=u[0]+u[2],m=u[1]+u[3];return!(n[0]>g||n[1]>m||c<u[0]||d<u[1])}static registerNodeType(n,u){if(!u.prototype)throw"Cannot register a simple object, it must be a class with a prototype";u.type=n,q.debug&&console.log("Node registered: "+n);const c=u.name,d=n.lastIndexOf("/");u.category=n.substring(0,d),u.title||(u.title=c);for(let m in LGraphNode$1.prototype)u.prototype[m]||(u.prototype[m]=LGraphNode$1.prototype[m]);const g=q.registered_node_types[n];if(g&&console.log("replacing node type: "+n),!Object.prototype.hasOwnProperty.call(u.prototype,"shape")&&(Object.defineProperty(u.prototype,"shape",{set:function(m){switch(m){case"default":delete this._shape;break;case"box":this._shape=q.BOX_SHAPE;break;case"round":this._shape=q.ROUND_SHAPE;break;case"circle":this._shape=q.CIRCLE_SHAPE;break;case"card":this._shape=q.CARD_SHAPE;break;default:this._shape=m}},get:function(){return this._shape},enumerable:!0,configurable:!0}),u.supported_extensions))for(let m in u.supported_extensions){const E=u.supported_extensions[m];E&&E.constructor===String&&(this.node_types_by_file_extension[E.toLowerCase()]=u)}q.registered_node_types[n]=u,u.constructor.name&&(this.Nodes[c]=u),q.onNodeTypeRegistered&&q.onNodeTypeRegistered(n,u),g&&q.onNodeTypeReplaced&&q.onNodeTypeReplaced(n,u,g),u.prototype.onPropertyChange&&console.warn("LiteGraph node class "+n+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),this.auto_load_slot_types&&new u(u.title||"tmpnode")}static unregisterNodeType(n){const u=n.constructor===String?q.registered_node_types[n]:n;if(!u)throw"node type not found: "+n;delete q.registered_node_types[u.type],u.constructor.name&&delete this.Nodes[u.constructor.name]}static registerNodeAndSlotType(n,u,c){c=c||!1;const g=(n.constructor===String&&q.registered_node_types[n]!=="anonymous"?q.registered_node_types[n]:n).constructor.type;let m=[];typeof u=="string"?m=u.split(","):u==this.EVENT||u==this.ACTION?m=["_event_"]:m=["*"];for(let E=0;E<m.length;++E){let L=m[E];L===""&&(L="*");const A=c?"registered_slot_out_types":"registered_slot_in_types";this[A][L]===void 0&&(this[A][L]={nodes:[]}),this[A][L].nodes.includes(g)||this[A][L].nodes.push(g),c?this.slot_types_out.includes(L.toLowerCase())||(this.slot_types_out.push(L.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(L.toLowerCase())||(this.slot_types_in.push(L.toLowerCase()),this.slot_types_in.sort())}}static buildNodeClassFromObject(n,u){let c="";if(u.inputs)for(let g=0;g<u.inputs.length;++g){let m=u.inputs[g][0],E=u.inputs[g][1];E&&E.constructor===String&&(E='"'+E+'"'),c+="this.addInput('"+m+"',"+E+`);
`}if(u.outputs)for(let g=0;g<u.outputs.length;++g){let m=u.outputs[g][0],E=u.outputs[g][1];E&&E.constructor===String&&(E='"'+E+'"'),c+="this.addOutput('"+m+"',"+E+`);
`}if(u.properties)for(let g in u.properties){let m=u.properties[g];m&&m.constructor===String&&(m='"'+m+'"'),c+="this.addProperty('"+g+"',"+m+`);
`}c+="if(this.onCreate)this.onCreate()";let d=Function(c);for(let g in u)g!="inputs"&&g!="outputs"&&g!="properties"&&(d.prototype[g]=u[g]);return d.title=u.title||n.split("/").pop(),d.desc=u.desc||"Generated from object",q.registerNodeType(n,d),d}static wrapFunctionAsNode(n,u,c,d,g){let m=Array(u.length),E="";if(c!==null){let A=q.getParameterNames(u);for(let N=0;N<A.length;++N){let C=0;c&&(c[N]!=null&&c[N].constructor===String?C="'"+c[N]+"'":c[N]!=null&&(C=c[N])),E+="this.addInput('"+A[N]+"',"+C+`);
`}}d!==null&&(E+="this.addOutput('out',"+(d!=null?d.constructor===String?"'"+d+"'":d:0)+`);
`),g&&(E+="this.properties = "+JSON.stringify(g)+`;
`);let L=Function(E);return L.title=n.split("/").pop(),L.desc="Generated from "+u.name,L.prototype.onExecute=function(){for(let C=0;C<m.length;++C)m[C]=this.getInputData(C);let N=u.apply(this,m);this.setOutputData(0,N)},this.registerNodeType(n,L),L}static clearRegisteredTypes(){q.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}static addNodeMethod(n,u){LGraphNode$1.prototype[n]=u;for(let c in q.registered_node_types){let d=q.registered_node_types[c];d.prototype[n]&&(d.prototype["_"+n]=d.prototype[n]),d.prototype[n]=u}}static createNode(n,u,c){let d=q.registered_node_types[n];if(!d)return q.debug&&console.log('GraphNode type "'+n+'" not registered.'),null;d.prototype,u=u||d.title||n;let g=null;if(q.catch_exceptions)try{g=new d(u)}catch(m){return console.error(m),null}else g=new d(u);if(g.type=n,!g.title&&u&&(g.title=u),g.properties||(g.properties={}),g.properties_info||(g.properties_info=[]),g.flags||(g.flags={}),g.size||(g.size=g.computeSize()),g.pos||(g.pos=q.DEFAULT_POSITION.concat()),g.mode||(g.mode=q.ALWAYS),c)for(let m in c)g[m]=c[m];return g.onNodeCreated&&g.onNodeCreated(),g}static getNodeType(n){return q.registered_node_types[n]}static getNodeTypesInCategory(n,u){let c=[];for(let d in q.registered_node_types){let g=q.registered_node_types[d];g.filter==u&&(n==""?g.category==null&&c.push(g):g.category==n&&c.push(g))}return this.auto_sort_node_types&&c.sort(function(d,g){return d.title.localeCompare(g.title)}),c}static getNodeTypesCategories(n){let u={"":1};for(let d in q.registered_node_types){let g=q.registered_node_types[d];if(g.category&&!g.skip_list){if(g.filter!=n)continue;u[g.category]=1}}let c=[];for(let d in u)c.push(d);return this.auto_sort_node_types?c.sort():c}static reloadNodes(n){let u=document.getElementsByTagName("script"),c=[];for(let g=0;g<u.length;g++)c.push(u[g]);let d=document.getElementsByTagName("head")[0];n=document.location.href+n;for(let g=0;g<c.length;g++){let m=c[g].src;if(!(!m||m.substr(0,n.length)!=n))try{q.debug&&console.log("Reloading: "+m);let E=document.createElement("script");E.type="text/javascript",E.src=m,d.appendChild(E),d.removeChild(c[g])}catch(E){if(q.throw_errors)throw E;q.debug&&console.log("Error while reloading "+m)}}q.debug&&console.log("Nodes reloaded")}static cloneObject(n,u){if(n==null)return null;let c=JSON.parse(JSON.stringify(n));if(!u)return c;for(let d in c)u[d]=c[d];return u}static uuidv4(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,n=>(n^Math.random()*16>>n/4).toString(16))}static isValidConnection(n,u){if((n==""||n==="*")&&(n=0),(u==""||u==="*")&&(u=0),!n||!u||n==u||n==q.EVENT&&u==q.ACTION)return!0;if(n=String(n),u=String(u),n=n.toLowerCase(),u=u.toLowerCase(),n.indexOf(",")==-1&&u.indexOf(",")==-1)return n==u;let c=n.split(","),d=u.split(",");for(let g=0;g<c.length;++g)for(let m=0;m<d.length;++m)if(this.isValidConnection(c[g],d[m]))return!0;return!1}static registerSearchboxExtra(n,u,c){this.searchbox_extras[u.toLowerCase()]={type:n,desc:u,data:c}}static fetchFile(n,u,c,d){if(!n)return null;if(u=u||"text",n.constructor===String)return n.substr(0,4)=="http"&&q.proxy&&(n=q.proxy+n.substr(n.indexOf(":")+3)),fetch(n).then(function(g){if(!g.ok)throw new Error("File not found");if(u=="arraybuffer")return g.arrayBuffer();if(u=="text"||u=="string")return g.text();if(u=="json")return g.json();if(u=="blob")return g.blob()}).then(function(g){c&&c(g)}).catch(function(g){console.error("error fetching file:",n),d&&d(g)});if(n.constructor===File||n.constructor===Blob){let g=new FileReader;if(g.onload=function(m){let E=m.target.result;u=="json"&&(E=JSON.parse(E)),c&&c(E)},u=="arraybuffer")return g.readAsArrayBuffer(n);if(u=="text"||u=="json")return g.readAsText(n);if(u=="blob")return g.readAsBinaryString(n)}return null}},ne(q,"VERSION",.4),ne(q,"CANVAS_GRID_SIZE",10),ne(q,"NODE_TITLE_HEIGHT",30),ne(q,"NODE_TITLE_TEXT_Y",20),ne(q,"NODE_SLOT_HEIGHT",20),ne(q,"NODE_WIDGET_HEIGHT",20),ne(q,"NODE_WIDTH",140),ne(q,"NODE_MIN_WIDTH",50),ne(q,"NODE_COLLAPSED_RADIUS",10),ne(q,"NODE_COLLAPSED_WIDTH",80),ne(q,"NODE_TITLE_COLOR","#999"),ne(q,"NODE_SELECTED_TITLE_COLOR","#FFF"),ne(q,"NODE_TEXT_SIZE",14),ne(q,"NODE_TEXT_COLOR","#AAA"),ne(q,"NODE_SUBTEXT_SIZE",12),ne(q,"NODE_DEFAULT_COLOR","#333"),ne(q,"NODE_DEFAULT_BGCOLOR","#353535"),ne(q,"NODE_DEFAULT_BOXCOLOR","#666"),ne(q,"NODE_DEFAULT_SHAPE","box"),ne(q,"NODE_BOX_OUTLINE_COLOR","#FFF"),ne(q,"DEFAULT_SHADOW_COLOR","rgba(0,0,0,0.5)"),ne(q,"DEFAULT_GROUP_FONT",24),ne(q,"WIDGET_BGCOLOR","#222"),ne(q,"WIDGET_OUTLINE_COLOR","#666"),ne(q,"WIDGET_TEXT_COLOR","#DDD"),ne(q,"WIDGET_SECONDARY_TEXT_COLOR","#999"),ne(q,"LINK_COLOR","#9A9"),ne(q,"EVENT_LINK_COLOR","#A86"),ne(q,"CONNECTING_LINK_COLOR","#AFA"),ne(q,"MAX_NUMBER_OF_NODES",1e3),ne(q,"DEFAULT_POSITION",[100,100]),ne(q,"VALID_SHAPES",["default","box","round","card"]),ne(q,"BOX_SHAPE",1),ne(q,"ROUND_SHAPE",2),ne(q,"CIRCLE_SHAPE",3),ne(q,"CARD_SHAPE",4),ne(q,"ARROW_SHAPE",5),ne(q,"GRID_SHAPE",6),ne(q,"INPUT",1),ne(q,"OUTPUT",2),ne(q,"EVENT",-1),ne(q,"ACTION",-1),ne(q,"NODE_MODES",["Always","On Event","Never","On Trigger"]),ne(q,"NODE_MODES_COLORS",["#666","#422","#333","#224","#626"]),ne(q,"ALWAYS",0),ne(q,"ON_EVENT",1),ne(q,"NEVER",2),ne(q,"ON_TRIGGER",3),ne(q,"UP",1),ne(q,"DOWN",2),ne(q,"LEFT",3),ne(q,"RIGHT",4),ne(q,"CENTER",5),ne(q,"LINK_RENDER_MODES",["Straight","Linear","Spline"]),ne(q,"STRAIGHT_LINK",0),ne(q,"LINEAR_LINK",1),ne(q,"SPLINE_LINK",2),ne(q,"NORMAL_TITLE",0),ne(q,"NO_TITLE",1),ne(q,"TRANSPARENT_TITLE",2),ne(q,"AUTOHIDE_TITLE",3),ne(q,"VERTICAL_LAYOUT","vertical"),ne(q,"proxy",null),ne(q,"node_images_path",""),ne(q,"debug",!1),ne(q,"catch_exceptions",!0),ne(q,"throw_errors",!0),ne(q,"allow_scripts",!1),ne(q,"use_deferred_actions",!0),ne(q,"registered_node_types",{}),ne(q,"node_types_by_file_extension",{}),ne(q,"Nodes",{}),ne(q,"Globals",{}),ne(q,"searchbox_extras",{}),ne(q,"auto_sort_node_types",!1),ne(q,"node_box_coloured_when_on",!1),ne(q,"node_box_coloured_by_mode",!1),ne(q,"dialog_close_on_mouse_leave",!0),ne(q,"dialog_close_on_mouse_leave_delay",500),ne(q,"shift_click_do_break_link_from",!1),ne(q,"click_do_break_link_to",!1),ne(q,"search_hide_on_mouse_leave",!0),ne(q,"search_filter_enabled",!1),ne(q,"search_show_all_on_open",!0),ne(q,"auto_load_slot_types",!1),ne(q,"registered_slot_in_types",{}),ne(q,"registered_slot_out_types",{}),ne(q,"slot_types_in",[]),ne(q,"slot_types_out",[]),ne(q,"slot_types_default_in",[]),ne(q,"slot_types_default_out",[]),ne(q,"alt_drag_do_clone_nodes",!1),ne(q,"do_add_triggers_slots",!1),ne(q,"allow_multi_output_for_events",!0),ne(q,"middle_click_slot_add_default_node",!1),ne(q,"release_link_on_empty_shows_menu",!1),ne(q,"pointerevents_method","mouse"),ne(q,"ctrl_shift_v_paste_connect_unselected_outputs",!1),ne(q,"use_uuids",!1),q);typeof performance<"u"?LiteGraph$1.getTime=performance.now.bind(performance):typeof Date<"u"&&Date.now?LiteGraph$1.getTime=Date.now.bind(Date):typeof process<"u"?LiteGraph$1.getTime=function(){let l=process.hrtime();return l[0]*.001+l[1]*1e-6}:LiteGraph$1.getTime=function(){return new Date().getTime()};class LLink{constructor(n,u,c,d,g,m){this.id=n,this.type=u,this.origin_id=c,this.origin_slot=d,this.target_id=g,this.target_slot=m,this._data=null,this._pos=new Float32Array(2)}configure(n){n.constructor===Array?(this.id=n[0],this.origin_id=n[1],this.origin_slot=n[2],this.target_id=n[3],this.target_slot=n[4],this.type=n[5]):(this.id=n.id,this.type=n.type,this.origin_id=n.origin_id,this.origin_slot=n.origin_slot,this.target_id=n.target_id,this.target_slot=n.target_slot)}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}let LGraphNode$1=class Ge{constructor(n){this._ctor(n)}_ctor(n){this.title=n||"Unnamed",this.size=[LiteGraph$1.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(u){!u||u.length<2||(this._pos[0]=u[0],this._pos[1]=u[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph$1.use_uuids?this.id=LiteGraph$1.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}}configure(n){this.graph&&this.graph._version++;for(const u in n){if(u=="properties"){for(const c in n.properties)this.properties[c]=n.properties[c],this.onPropertyChanged&&this.onPropertyChanged(c,n.properties[c]);continue}n[u]!=null&&(typeof n[u]=="object"?this[u]&&this[u].configure?this[u].configure(n[u]):this[u]=LiteGraph$1.cloneObject(n[u],this[u]):this[u]=n[u])}if(n.title||(this.title=this.constructor.title),this.inputs)for(let u=0;u<this.inputs.length;++u){const c=this.inputs[u],d=this.graph?this.graph.links[c.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph$1.INPUT,u,!0,d,c),this.onInputAdded&&this.onInputAdded(c)}if(this.outputs)for(let u=0;u<this.outputs.length;++u){const c=this.outputs[u];if(c.links){for(let d=0;d<c.links.length;++d){const g=this.graph?this.graph.links[c.links[d]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph$1.OUTPUT,u,!0,g,c)}this.onOutputAdded&&this.onOutputAdded(c)}}if(this.widgets){for(let u=0;u<this.widgets.length;++u){const c=this.widgets[u];c&&c.options&&c.options.property&&this.properties[c.options.property]!=null&&(c.value=JSON.parse(JSON.stringify(this.properties[c.options.property])))}if(n.widgets_values)for(let u=0;u<n.widgets_values.length;++u)this.widgets[u]&&(this.widgets[u].value=n.widgets_values[u])}this.onConfigure&&this.onConfigure(n)}serialize(){const n={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph$1.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===Ge&&this.last_serialization)return this.last_serialization;if(this.inputs&&(n.inputs=this.inputs),this.outputs){for(let u=0;u<this.outputs.length;u++)delete this.outputs[u]._data;n.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(n.title=this.title),this.properties&&(n.properties=LiteGraph$1.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){n.widgets_values=[];for(let u=0;u<this.widgets.length;++u)this.widgets[u]?n.widgets_values[u]=this.widgets[u].value:n.widgets_values[u]=null}return n.type||(n.type=this.constructor.type),this.color&&(n.color=this.color),this.bgcolor&&(n.bgcolor=this.bgcolor),this.boxcolor&&(n.boxcolor=this.boxcolor),this.shape&&(n.shape=this.shape),this.onSerialize&&this.onSerialize(n)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),n}clone(){const n=LiteGraph$1.createNode(this.type);if(!n)return null;const u=LiteGraph$1.cloneObject(this.serialize());if(u.inputs)for(let c=0;c<u.inputs.length;++c)u.inputs[c].link=null;if(u.outputs)for(let c=0;c<u.outputs.length;++c)u.outputs[c].links&&(u.outputs[c].links.length=0);return delete u.id,LiteGraph$1.use_uuids&&(u.id=LiteGraph$1.uuidv4()),n.configure(u),n}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title||this.constructor.title}setProperty(n,u){if(this.properties||(this.properties={}),u===this.properties[n])return;const c=this.properties[n];if(this.properties[n]=u,this.onPropertyChanged&&this.onPropertyChanged(n,u,c)===!1&&(this.properties[n]=c),this.widgets)for(let d=0;d<this.widgets.length;++d){const g=this.widgets[d];if(g&&g.options.property==n){g.value=u;break}}}setOutputData(n,u){if(!this.outputs||n==-1||n>=this.outputs.length)return;const c=this.outputs[n];if(c&&(c._data=u,this.outputs[n].links))for(let d=0;d<this.outputs[n].links.length;d++){const g=this.outputs[n].links[d],m=this.graph.links[g];m&&(m.data=u)}}setOutputDataType(n,u){if(!this.outputs||n==-1||n>=this.outputs.length)return;const c=this.outputs[n];if(c&&(c.type=u,this.outputs[n].links))for(let d=0;d<this.outputs[n].links.length;d++){const g=this.outputs[n].links[d];this.graph.links[g].type=u}}getInputData(n,u){if(!this.inputs||n>=this.inputs.length||this.inputs[n].link==null)return;const c=this.inputs[n].link,d=this.graph.links[c];if(!d)return null;if(!u)return d.data;const g=this.graph.getNodeById(d.origin_id);return g&&(g.updateOutputData?g.updateOutputData(d.origin_slot):g.onExecute&&g.onExecute()),d.data}getInputDataType(n){if(!this.inputs||n>=this.inputs.length||this.inputs[n].link==null)return null;const u=this.inputs[n].link,c=this.graph.links[u];if(!c)return null;const d=this.graph.getNodeById(c.origin_id);if(!d)return c.type;const g=d.outputs[c.origin_slot];return g?g.type:null}getInputDataByName(n,u){const c=this.findInputSlot(n);return c==-1?null:this.getInputData(c,u)}isInputConnected(n){return this.inputs?n<this.inputs.length&&this.inputs[n].link!=null:!1}getInputInfo(n){return this.inputs&&n<this.inputs.length?this.inputs[n]:null}getInputLink(n){if(!this.inputs)return null;if(n<this.inputs.length){const u=this.inputs[n];return this.graph.links[u.link]}return null}getInputNode(n){if(!this.inputs||n>=this.inputs.length)return null;const u=this.inputs[n];if(!u||u.link===null)return null;const c=this.graph.links[u.link];return c?this.graph.getNodeById(c.origin_id):null}getInputOrProperty(n){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[n]:null;for(let u=0,c=this.inputs.length;u<c;++u){const d=this.inputs[u];if(n==d.name&&d.link!=null){const g=this.graph.links[d.link];if(g)return g.data}}return this.properties[n]}getOutputData(n){return!this.outputs||n>=this.outputs.length?null:this.outputs[n]._data}getOutputInfo(n){return this.outputs&&n<this.outputs.length?this.outputs[n]:null}isOutputConnected(n){return this.outputs?n<this.outputs.length&&this.outputs[n].links&&this.outputs[n].links.length:!1}isAnyOutputConnected(){if(!this.outputs)return!1;for(let n=0;n<this.outputs.length;++n)if(this.outputs[n].links&&this.outputs[n].links.length)return!0;return!1}getOutputNodes(n){if(!this.outputs||this.outputs.length==0||n>=this.outputs.length)return null;const u=this.outputs[n];if(!u.links||u.links.length==0)return null;const c=[];for(let d=0;d<u.links.length;d++){const g=u.links[d],m=this.graph.links[g];if(m){const E=this.graph.getNodeById(m.target_id);E&&c.push(E)}}return c}addOnTriggerInput(){const n=this.findInputSlot("onTrigger");if(n==-1){//!trigS ||
return this.addInput("onTrigger",LiteGraph$1.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")}return n}addOnExecutedOutput(){const n=this.findOutputSlot("onExecuted");if(n==-1){//!trigS ||
return this.addOutput("onExecuted",LiteGraph$1.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")}return n}onAfterExecuteNode(n,u){const c=this.findOutputSlot("onExecuted");c!=-1&&this.triggerSlot(c,n,null,u)}changeMode(n){switch(n){case LiteGraph$1.ON_EVENT:break;case LiteGraph$1.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph$1.NEVER:break;case LiteGraph$1.ALWAYS:break;case LiteGraph$1.ON_REQUEST:break;default:return!1}return this.mode=n,!0}executePendingActions(){if(!(!this._waiting_actions||!this._waiting_actions.length)){for(let n=0;n<this._waiting_actions.length;++n){const u=this._waiting_actions[n];this.onAction(u[0],u[1],u[2],u[3],u[4])}this._waiting_actions.length=0}}doExecute(n,u){u=u||{},this.onExecute&&(u.action_call||(u.action_call=this.id+"_exec_"+Math.floor(Math.random()*9999)),this.graph.nodes_executing[this.id]=!0,this.onExecute(n,u),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,u&&u.action_call&&(this.action_call=u.action_call,this.graph.nodes_executedAction[this.id]=u.action_call)),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(n,u)}actionDo(n,u,c,d){c=c||{},this.onAction&&(c.action_call||(c.action_call=this.id+"_"+(n||"action")+"_"+Math.floor(Math.random()*9999)),this.graph.nodes_actioning[this.id]=n||"actioning",this.onAction(n,u,c,d),this.graph.nodes_actioning[this.id]=!1,c&&c.action_call&&(this.action_call=c.action_call,this.graph.nodes_executedAction[this.id]=c.action_call)),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(u,c)}trigger(n,u,c){if(!(!this.outputs||!this.outputs.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph$1.getTime());for(let d=0;d<this.outputs.length;++d){const g=this.outputs[d];!g||g.type!==LiteGraph$1.EVENT||n&&g.name!=n||this.triggerSlot(d,u,null,c)}}}triggerSlot(n,u,c,d){if(d=d||{},!this.outputs)return;if(n==null){console.error("slot must be a number");return}n.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");const g=this.outputs[n];if(!g)return;const m=g.links;if(!(!m||!m.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph$1.getTime());for(let E=0;E<m.length;++E){const L=m[E];if(c!=null&&c!=L)continue;const A=this.graph.links[m[E]];if(!A)continue;A._last_time=LiteGraph$1.getTime();const N=this.graph.getNodeById(A.target_id);if(N){if(N.inputs[A.target_slot],N.mode===LiteGraph$1.ON_TRIGGER)d.action_call||(d.action_call=this.id+"_trigg_"+Math.floor(Math.random()*9999)),N.onExecute&&N.doExecute(u,d);else if(N.onAction){d.action_call||(d.action_call=this.id+"_act_"+Math.floor(Math.random()*9999));const C=N.inputs[A.target_slot];LiteGraph$1.use_deferred_actions&&N.onExecute?(N._waiting_actions||(N._waiting_actions=[]),N._waiting_actions.push([C.name,u,d,A.target_slot])):N.actionDo(C.name,u,d,A.target_slot)}}}}}clearTriggeredSlot(n,u){if(!this.outputs)return;const c=this.outputs[n];if(!c)return;const d=c.links;if(!(!d||!d.length))for(let g=0;g<d.length;++g){const m=d[g];if(u!=null&&u!=m)continue;const E=this.graph.links[d[g]];E&&(E._last_time=0)}}setSize(n){this.size=n,this.onResize&&this.onResize(this.size)}addProperty(n,u,c,d){const g={name:n,type:c,default_value:u};if(d)for(const m in d)g[m]=d[m];return this.properties_info||(this.properties_info=[]),this.properties_info.push(g),this.properties||(this.properties={}),this.properties[n]=u,g}addOutput(n,u,c){const d={name:n,type:u,links:null};if(c)for(const g in c)d[g]=c[g];return this.outputs||(this.outputs=[]),this.outputs.push(d),this.onOutputAdded&&this.onOutputAdded(d),LiteGraph$1.auto_load_slot_types&&LiteGraph$1.registerNodeAndSlotType(this,u,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),d}addOutputs(n){for(let u=0;u<n.length;++u){const c=n[u],d={name:c[0],type:c[1],link:null};if(n[2])for(const g in c[2])d[g]=c[2][g];this.outputs||(this.outputs=[]),this.outputs.push(d),this.onOutputAdded&&this.onOutputAdded(d),LiteGraph$1.auto_load_slot_types&&LiteGraph$1.registerNodeAndSlotType(this,c[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}removeOutput(n){this.disconnectOutput(n),this.outputs.splice(n,1);for(let u=n;u<this.outputs.length;++u){if(!this.outputs[u]||!this.outputs[u].links)continue;const c=this.outputs[u].links;for(let d=0;d<c.length;++d){const g=this.graph.links[c[d]];g&&(g.origin_slot-=1)}}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(n),this.setDirtyCanvas(!0,!0)}addInput(n,u,c){u=u||0;const d={name:n,type:u,link:null};if(c)for(const g in c)d[g]=c[g];return this.inputs||(this.inputs=[]),this.inputs.push(d),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(d),LiteGraph$1.registerNodeAndSlotType(this,u),this.setDirtyCanvas(!0,!0),d}addInputs(n){for(let u=0;u<n.length;++u){const c=n[u],d={name:c[0],type:c[1],link:null};if(n[2])for(const g in c[2])d[g]=c[2][g];this.inputs||(this.inputs=[]),this.inputs.push(d),this.onInputAdded&&this.onInputAdded(d),LiteGraph$1.registerNodeAndSlotType(this,c[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)}removeInput(n){this.disconnectInput(n);const u=this.inputs.splice(n,1);for(let c=n;c<this.inputs.length;++c){if(!this.inputs[c])continue;const d=this.graph.links[this.inputs[c].link];d&&(d.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(n,u[0]),this.setDirtyCanvas(!0,!0)}addConnection(n,u,c,d){const g={name:n,type:u,pos:c,direction:d,links:null};return this.connections.push(g),g}computeSize(n){if(this.constructor.size)return this.constructor.size.concat();let u=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1);const c=n||new Float32Array([0,0]);u=Math.max(u,1);const d=LiteGraph$1.NODE_TEXT_SIZE,g=A(this.title);let m=0,E=0;if(this.inputs)for(let N=0,C=this.inputs.length;N<C;++N){const R=this.inputs[N],P=R.label||R.name||"",F=A(P);m<F&&(m=F)}if(this.outputs)for(let N=0,C=this.outputs.length;N<C;++N){const R=this.outputs[N],P=R.label||R.name||"",F=A(P);E<F&&(E=F)}c[0]=Math.max(m+E+10,g),c[0]=Math.max(c[0],LiteGraph$1.NODE_WIDTH),this.widgets&&this.widgets.length&&(c[0]=Math.max(c[0],LiteGraph$1.NODE_WIDTH*1.5)),c[1]=(this.constructor.slot_start_y||0)+u*LiteGraph$1.NODE_SLOT_HEIGHT;let L=0;if(this.widgets&&this.widgets.length){for(let N=0,C=this.widgets.length;N<C;++N)this.widgets[N].computeSize?L+=this.widgets[N].computeSize(c[0])[1]+4:L+=LiteGraph$1.NODE_WIDGET_HEIGHT+4;L+=8}this.widgets_up?c[1]=Math.max(c[1],L):this.widgets_start_y!=null?c[1]=Math.max(c[1],L+this.widgets_start_y):c[1]+=L;function A(N){return N?d*N.length*.6:0}return this.constructor.min_height&&c[1]<this.constructor.min_height&&(c[1]=this.constructor.min_height),c[1]+=6,c}getPropertyInfo(n){let u=null;if(this.properties_info){for(let c=0;c<this.properties_info.length;++c)if(this.properties_info[c].name==n){u=this.properties_info[c];break}}return this.constructor["@"+n]&&(u=this.constructor["@"+n]),this.constructor.widgets_info&&this.constructor.widgets_info[n]&&(u=this.constructor.widgets_info[n]),!u&&this.onGetPropertyInfo&&(u=this.onGetPropertyInfo(n)),u||(u={}),u.type||(u.type=typeof this.properties[n]),u.widget=="combo"&&(u.type="enum"),u}addWidget(n,u,c,d,g){this.widgets||(this.widgets=[]),!g&&d&&d.constructor===Object&&(g=d,d=null),g&&g.constructor===String&&(g={property:g}),d&&d.constructor===String&&(g||(g={}),g.property=d,d=null),d&&d.constructor!==Function&&(console.warn("addWidget: callback must be a function"),d=null);const m={type:n.toLowerCase(),name:u,value:c,callback:d,options:g||{}};if(m.options.y!==void 0&&(m.y=m.options.y),!d&&!m.options.callback&&!m.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),n=="combo"&&!m.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(m),this.setSize(this.computeSize()),m}addCustomWidget(n){return this.widgets||(this.widgets=[]),this.widgets.push(n),n}getBounding(n,u){n=n||new Float32Array(4);const c=this.pos,d=this.flags.collapsed,g=this.size;let m=0,E=1,L=0,A=0;return u&&(m=4,E=6+m,L=4,A=5+L),n[0]=c[0]-m,n[1]=c[1]-LiteGraph$1.NODE_TITLE_HEIGHT-L,n[2]=d?(this._collapsed_width||LiteGraph$1.NODE_COLLAPSED_WIDTH)+E:g[0]+E,n[3]=d?LiteGraph$1.NODE_TITLE_HEIGHT+A:g[1]+LiteGraph$1.NODE_TITLE_HEIGHT+A,this.onBounding&&this.onBounding(n),n}isPointInside(n,u,c,d){c=c||0;let g=this.graph&&this.graph.isLive()?0:LiteGraph$1.NODE_TITLE_HEIGHT;if(d&&(g=0),this.flags&&this.flags.collapsed){if(LiteGraph$1.isInsideRectangle(n,u,this.pos[0]-c,this.pos[1]-LiteGraph$1.NODE_TITLE_HEIGHT-c,(this._collapsed_width||LiteGraph$1.NODE_COLLAPSED_WIDTH)+2*c,LiteGraph$1.NODE_TITLE_HEIGHT+2*c))return!0}else if(this.pos[0]-4-c<n&&this.pos[0]+this.size[0]+4+c>n&&this.pos[1]-g-c<u&&this.pos[1]+this.size[1]+c>u)return!0;return!1}getSlotInPosition(n,u){const c=new Float32Array(2);if(this.inputs)for(let d=0,g=this.inputs.length;d<g;++d){const m=this.inputs[d];if(this.getConnectionPos(!0,d,c),LiteGraph$1.isInsideRectangle(n,u,c[0]-10,c[1]-5,20,10))return{input:m,slot:d,link_pos:c}}if(this.outputs)for(let d=0,g=this.outputs.length;d<g;++d){const m=this.outputs[d];if(this.getConnectionPos(!1,d,c),LiteGraph$1.isInsideRectangle(n,u,c[0]-10,c[1]-5,20,10))return{output:m,slot:d,link_pos:c}}return null}findInputSlot(n,u){if(!this.inputs)return-1;for(let c=0,d=this.inputs.length;c<d;++c)if(n==this.inputs[c].name)return u?this.inputs[c]:c;return-1}findOutputSlot(n,u){if(u=u||!1,!this.outputs)return-1;for(let c=0,d=this.outputs.length;c<d;++c)if(n==this.outputs[c].name)return u?this.outputs[c]:c;return-1}findInputSlotFree(n){const d=Object.assign({returnObj:!1,typesNotAccepted:[]},n||{});if(!this.inputs)return-1;for(let g=0,m=this.inputs.length;g<m;++g)if(!(this.inputs[g].link&&this.inputs[g].link!=null)&&!(d.typesNotAccepted&&d.typesNotAccepted.includes&&d.typesNotAccepted.includes(this.inputs[g].type)))return d.returnObj?this.inputs[g]:g;return-1}findOutputSlotFree(n){const d=Object.assign({returnObj:!1,typesNotAccepted:[]},n||{});if(!this.outputs)return-1;for(let g=0,m=this.outputs.length;g<m;++g)if(!(this.outputs[g].links&&this.outputs[g].links!=null)&&!(d.typesNotAccepted&&d.typesNotAccepted.includes&&d.typesNotAccepted.includes(this.outputs[g].type)))return d.returnObj?this.outputs[g]:g;return-1}findInputSlotByType(n,u,c,d){return this.findSlotByType(!0,n,u,c,d)}findOutputSlotByType(n,u,c,d){return this.findSlotByType(!1,n,u,c,d)}findSlotByType(n,u,c,d,g){n=n||!1,c=c||!1,d=d||!1,g=g||!1;const m=n?this.inputs:this.outputs;if(!m)return-1;(u==""||u=="*")&&(u=0);for(let E=0,L=m.length;E<L;++E){const A=(u+"").toLowerCase().split(",");let N=m[E].type=="0"||m[E].type=="*"?"0":m[E].type;N=(N+"").toLowerCase().split(",");for(let C=0;C<A.length;C++)for(let R=0;R<N.length;R++)if(A[C]=="_event_"&&(A[C]=LiteGraph$1.EVENT),N[C]=="_event_"&&(N[C]=LiteGraph$1.EVENT),A[C]=="*"&&(A[C]=0),N[C]=="*"&&(N[C]=0),A[C]==N[R]){if(d&&m[E].links&&m[E].links!==null)continue;return c?m[E]:E}}if(d&&!g)for(let E=0,L=m.length;E<L;++E){const A=(u+"").toLowerCase().split(",");let N=m[E].type=="0"||m[E].type=="*"?"0":m[E].type;N=(N+"").toLowerCase().split(",");for(let C=0;C<A.length;C++)for(let R=0;R<N.length;R++)if(A[C]=="*"&&(A[C]=0),N[C]=="*"&&(N[C]=0),A[C]==N[R])return c?m[E]:E}return-1}connectByType(n,u,c,d){const E=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},d||{});u&&u.constructor===Number&&(u=this.graph.getNodeById(u));const L=u.findInputSlotByType(c,!1,!0);if(L>=0&&L!==null)return this.connect(n,u,L);if(E.createEventInCase&&c==LiteGraph$1.EVENT)return this.connect(n,u,-1);if(E.generalTypeInCase){const A=u.findInputSlotByType(0,!1,!0,!0);if(A>=0)return this.connect(n,u,A)}if(E.firstFreeIfOutputGeneralInCase&&(c==0||c=="*"||c=="")){const A=u.findInputSlotFree({typesNotAccepted:[LiteGraph$1.EVENT]});if(A>=0)return this.connect(n,u,A)}return console.debug("no way to connect type: ",c," to targetNODE ",u),null}connectByTypeOutput(n,u,c,d){const E=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},d||{});u&&u.constructor===Number&&(u=this.graph.getNodeById(u));const L=u.findOutputSlotByType(c,!1,!0);if(L>=0&&L!==null)return u.connect(L,this,n);if(E.generalTypeInCase){const A=u.findOutputSlotByType(0,!1,!0,!0);if(A>=0)return u.connect(A,this,n)}if(E.createEventInCase&&c==LiteGraph$1.EVENT&&LiteGraph$1.do_add_triggers_slots){const A=u.addOnExecutedOutput();return u.connect(A,this,n)}if(E.firstFreeIfInputGeneralInCase&&(c==0||c=="*"||c=="")){const A=u.findOutputSlotFree({typesNotAccepted:[LiteGraph$1.EVENT]});if(A>=0)return u.connect(A,this,n)}return console.debug("no way to connect byOUT type: ",c," to sourceNODE ",u),null}connect(n,u,c){if(c=c||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(n.constructor===String){if(n=this.findOutputSlot(n),n==-1)return LiteGraph$1.debug&&console.log("Connect: Error, no slot of name "+n),null}else if(!this.outputs||n>=this.outputs.length)return LiteGraph$1.debug&&console.log("Connect: Error, slot number not found"),null;if(u&&u.constructor===Number&&(u=this.graph.getNodeById(u)),!u)throw"target node is null";if(u==this)return null;if(c.constructor===String){if(c=u.findInputSlot(c),c==-1)return LiteGraph$1.debug&&console.log("Connect: Error, no slot of name "+c),null}else if(c===LiteGraph$1.EVENT)if(LiteGraph$1.do_add_triggers_slots)u.changeMode(LiteGraph$1.ON_TRIGGER),c=u.findInputSlot("onTrigger");else return null;else if(!u.inputs||c>=u.inputs.length)return LiteGraph$1.debug&&console.log("Connect: Error, slot number not found"),null;let d=!1;const g=u.inputs[c];let m=null;const E=this.outputs[n];if(!this.outputs[n])return null;if(u.onBeforeConnectInput&&(c=u.onBeforeConnectInput(c)),c===!1||c===null||!LiteGraph$1.isValidConnection(E.type,g.type))return this.setDirtyCanvas(!1,!0),d&&this.graph.connectionChange(this,m),null;if(u.onConnectInput&&u.onConnectInput(c,E.type,E,this,n)===!1||this.onConnectOutput&&this.onConnectOutput(n,g.type,g,u,c)===!1)return null;if(u.inputs[c]&&u.inputs[c].link!=null&&(this.graph.beforeChange(),u.disconnectInput(c,{doProcessChange:!1}),d=!0),E.links!==null&&E.links.length)switch(E.type){case LiteGraph$1.EVENT:LiteGraph$1.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(n,!1,{doProcessChange:!1}),d=!0);break}let L;return LiteGraph$1.use_uuids?L=LiteGraph$1.uuidv4():L=++this.graph.last_link_id,m=new LLink(L,g.type||E.type,this.id,n,u.id,c),this.graph.links[m.id]=m,E.links==null&&(E.links=[]),E.links.push(m.id),u.inputs[c].link=m.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph$1.OUTPUT,n,!0,m,E),u.onConnectionsChange&&u.onConnectionsChange(LiteGraph$1.INPUT,c,!0,m,g),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph$1.INPUT,u,c,this,n),this.graph.onNodeConnectionChange(LiteGraph$1.OUTPUT,this,n,u,c)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,m),m}disconnectOutput(n,u){if(n.constructor===String){if(n=this.findOutputSlot(n),n==-1)return LiteGraph$1.debug&&console.log("Connect: Error, no slot of name "+n),!1}else if(!this.outputs||n>=this.outputs.length)return LiteGraph$1.debug&&console.log("Connect: Error, slot number not found"),!1;const c=this.outputs[n];if(!c||!c.links||c.links.length==0)return!1;if(u){if(u.constructor===Number&&(u=this.graph.getNodeById(u)),!u)throw"Target Node not found";for(let d=0,g=c.links.length;d<g;d++){const m=c.links[d],E=this.graph.links[m];if(E.target_id==u.id){c.links.splice(d,1);const L=u.inputs[E.target_slot];L.link=null,delete this.graph.links[m],this.graph&&this.graph._version++,u.onConnectionsChange&&u.onConnectionsChange(LiteGraph$1.INPUT,E.target_slot,!1,E,L),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph$1.OUTPUT,n,!1,E,c),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph$1.OUTPUT,this,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph$1.OUTPUT,this,n),this.graph.onNodeConnectionChange(LiteGraph$1.INPUT,u,E.target_slot));break}}}else{for(let d=0,g=c.links.length;d<g;d++){const m=c.links[d],E=this.graph.links[m];if(!E)continue;const L=this.graph.getNodeById(E.target_id);let A=null;this.graph&&this.graph._version++,L&&(A=L.inputs[E.target_slot],A.link=null,L.onConnectionsChange&&L.onConnectionsChange(LiteGraph$1.INPUT,E.target_slot,!1,E,A),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph$1.INPUT,L,E.target_slot)),delete this.graph.links[m],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph$1.OUTPUT,n,!1,E,c),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph$1.OUTPUT,this,n),this.graph.onNodeConnectionChange(LiteGraph$1.INPUT,L,E.target_slot))}c.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}disconnectInput(n){if(n.constructor===String){if(n=this.findInputSlot(n),n==-1)return LiteGraph$1.debug&&console.log("Connect: Error, no slot of name "+n),!1}else if(!this.inputs||n>=this.inputs.length)return LiteGraph$1.debug&&console.log("Connect: Error, slot number not found"),!1;const u=this.inputs[n];if(!u)return!1;const c=this.inputs[n].link;if(c!=null){this.inputs[n].link=null;const d=this.graph.links[c];if(d){const g=this.graph.getNodeById(d.origin_id);if(!g)return!1;const m=g.outputs[d.origin_slot];if(!m||!m.links||m.links.length==0)return!1;let E=null;for(let L=0,A=m.links.length;L<A;L++)if(E=L,m.links[L]==c){m.links.splice(L,1);break}delete this.graph.links[c],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph$1.INPUT,n,!1,d,u),g.onConnectionsChange&&g.onConnectionsChange(LiteGraph$1.OUTPUT,E,!1,d,m),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph$1.OUTPUT,g,E),this.graph.onNodeConnectionChange(LiteGraph$1.INPUT,this,n))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}getConnectionPos(n,u,c){c=c||new Float32Array(2);let d=0;n&&this.inputs&&(d=this.inputs.length),!n&&this.outputs&&(d=this.outputs.length);const g=LiteGraph$1.NODE_SLOT_HEIGHT*.5;if(this.flags.collapsed){const m=this._collapsed_width||LiteGraph$1.NODE_COLLAPSED_WIDTH;return this.horizontal?(c[0]=this.pos[0]+m*.5,n?c[1]=this.pos[1]-LiteGraph$1.NODE_TITLE_HEIGHT:c[1]=this.pos[1]):(n?c[0]=this.pos[0]:c[0]=this.pos[0]+m,c[1]=this.pos[1]-LiteGraph$1.NODE_TITLE_HEIGHT*.5),c}return n&&u==-1?(c[0]=this.pos[0]+LiteGraph$1.NODE_TITLE_HEIGHT*.5,c[1]=this.pos[1]+LiteGraph$1.NODE_TITLE_HEIGHT*.5,c):n&&d>u&&this.inputs[u].pos?(c[0]=this.pos[0]+this.inputs[u].pos[0],c[1]=this.pos[1]+this.inputs[u].pos[1],c):!n&&d>u&&this.outputs[u].pos?(c[0]=this.pos[0]+this.outputs[u].pos[0],c[1]=this.pos[1]+this.outputs[u].pos[1],c):this.horizontal?(c[0]=this.pos[0]+(u+.5)*(this.size[0]/d),n?c[1]=this.pos[1]-LiteGraph$1.NODE_TITLE_HEIGHT:c[1]=this.pos[1]+this.size[1],c):(n?c[0]=this.pos[0]+g:c[0]=this.pos[0]+this.size[0]+1-g,c[1]=this.pos[1]+(u+.7)*LiteGraph$1.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),c)}alignToGrid(){this.pos[0]=LiteGraph$1.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph$1.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph$1.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph$1.CANVAS_GRID_SIZE)}trace(n){this.console||(this.console=[]),this.console.push(n),this.console.length>Ge.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,n)}setDirtyCanvas(n,u){this.graph&&this.graph.sendActionToCanvas("setDirty",[n,u])}loadImage(n){const u=new Image;u.src=LiteGraph$1.node_images_path+n,u.ready=!1;const c=this;return u.onload=function(){this.ready=!0,c.setDirtyCanvas(!0)},u}captureInput(n){if(!this.graph||!this.graph.list_of_graphcanvas)return;const u=this.graph.list_of_graphcanvas;for(let c=0;c<u.length;++c){const d=u[c];!n&&d.node_capturing_input!=this||(d.node_capturing_input=n?this:null)}}collapse(n){this.graph._version++,!(this.constructor.collapsable===!1&&!n)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))}pin(n){this.graph._version++,n===void 0?this.flags.pinned=!this.flags.pinned:this.flags.pinned=n}localToScreen(n,u,c){return[(n+this.pos[0])*c.scale+c.offset[0],(u+this.pos[1])*c.scale+c.offset[1]]}};class DragAndScale{constructor(n,u){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),n&&(this.element=n,u||this.bindEvents(n))}bindEvents(n){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph$1.pointerListenerAdd(n,"down",this._binded_mouse_callback),LiteGraph$1.pointerListenerAdd(n,"move",this._binded_mouse_callback),LiteGraph$1.pointerListenerAdd(n,"up",this._binded_mouse_callback),n.addEventListener("mousewheel",this._binded_mouse_callback,!1),n.addEventListener("wheel",this._binded_mouse_callback,!1)}computeVisibleArea(n){if(!this.element){this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0;return}let u=this.element.width,c=this.element.height,d=-this.offset[0],g=-this.offset[1];n&&(d+=n[0]/this.scale,g+=n[1]/this.scale,u=n[2],c=n[3]);const m=d+u/this.scale,E=g+c/this.scale;this.visible_area[0]=d,this.visible_area[1]=g,this.visible_area[2]=m-d,this.visible_area[3]=E-g}onMouse(n){if(!this.enabled)return;const u=this.element,c=u.getBoundingClientRect(),d=n.clientX-c.left,g=n.clientY-c.top;n.canvasx=d,n.canvasy=g,n.dragging=this.dragging;const m=!this.viewport||this.viewport&&d>=this.viewport[0]&&d<this.viewport[0]+this.viewport[2]&&g>=this.viewport[1]&&g<this.viewport[1]+this.viewport[3];let E=!1;if(this.onmouse&&(E=this.onmouse(n)),n.type==LiteGraph$1.pointerevents_method+"down"&&m)this.dragging=!0,LiteGraph$1.pointerListenerRemove(u,"move",this._binded_mouse_callback),LiteGraph$1.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph$1.pointerListenerAdd(document,"up",this._binded_mouse_callback);else if(n.type==LiteGraph$1.pointerevents_method+"move"){if(!E){const L=d-this.last_mouse[0],A=g-this.last_mouse[1];this.dragging&&this.mouseDrag(L,A)}}else n.type==LiteGraph$1.pointerevents_method+"up"?(this.dragging=!1,LiteGraph$1.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph$1.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph$1.pointerListenerAdd(u,"move",this._binded_mouse_callback)):m&&(n.type=="mousewheel"||n.type=="wheel"||n.type=="DOMMouseScroll")&&(n.eventType="mousewheel",n.type=="wheel"?n.wheel=-n.deltaY:n.wheel=n.wheelDeltaY!=null?n.wheelDeltaY:n.detail*-60,n.delta=n.wheelDelta?n.wheelDelta/40:n.deltaY?-n.deltaY/3:0,this.changeDeltaScale(1+n.delta*.05));if(this.last_mouse[0]=d,this.last_mouse[1]=g,m)return n.preventDefault(),n.stopPropagation(),!1}toCanvasContext(n){n.scale(this.scale,this.scale),n.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(n){return[(n[0]+this.offset[0])*this.scale,(n[1]+this.offset[1])*this.scale]}convertCanvasToOffset(n,u){return u=u||[0,0],u[0]=n[0]/this.scale-this.offset[0],u[1]=n[1]/this.scale-this.offset[1],u}mouseDrag(n,u){this.offset[0]+=n/this.scale,this.offset[1]+=u/this.scale,this.onredraw&&this.onredraw(this)}changeScale(n,u){if(n<this.min_scale?n=this.min_scale:n>this.max_scale&&(n=this.max_scale),n==this.scale||!this.element)return;const c=this.element.getBoundingClientRect();if(!c)return;u=u||[c.width*.5,c.height*.5];const d=this.convertCanvasToOffset(u);this.scale=n,Math.abs(this.scale-1)<.01&&(this.scale=1);const g=this.convertCanvasToOffset(u),m=[g[0]-d[0],g[1]-d[1]];this.offset[0]+=m[0],this.offset[1]+=m[1],this.onredraw&&this.onredraw(this)}changeDeltaScale(n,u){this.changeScale(this.scale*n,u)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}let LGraphCanvas$1=(_LGraphCanvas=class{constructor(l,n,u){ne(this,"saveUndoStack",async function(){var u,c;const l=this.graph.serialize(),n=this.tempDeepClone(l);(((u=this.undoStack)==null?void 0:u.length)===0||((c=this.undoStack)==null?void 0:c.length)>0&&!this.checkObjectEqual(n,this.undoStack[this.undoStack.length-1]))&&this.undoStack.push(n),this.undoStack.length>this.maxStackSize&&this.undoStack.shift(),this.redoStack.length=0});this.options=u=u||{},this.ALWAYS_FLOW=!1,this.isKeyPressed=!1,this._menus=[],this.maxStackSize=u.maxStackSize||1e3,this.undoStack=[],this.redoStack=[],this.saveUndoStackEvt=this.debounceTime(this.saveUndoStack.bind(this),50),this.background_image=_LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,l&&l.constructor===String&&(l=document.querySelector(l)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=""+LiteGraph$1.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph$1.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph$1.NODE_TITLE_COLOR,this.default_link_color=LiteGraph$1.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph$1.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=u.viewport||null,n&&n.attachCanvas(this),this.setCanvas(l,u.skip_events),this.clear(),u.skip_render||this.startRendering(),this.autoresize=u.autoresize}clear(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()}setGraph(l,n){if(this.graph!=l){if(n||this.clear(),!l&&this.graph){this.graph.detachCanvas(this);return}l.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)}}getTopGraph(){return this._graph_stack.length?this._graph_stack[0]:this.graph}openSubgraph(l){if(!l)throw"graph cannot be null";if(this.graph==l)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),l.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)}closeSubgraph(){if(!this._graph_stack||this._graph_stack.length==0)return;const l=this.graph._subgraph_node,n=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},n.attachCanvas(this),this.setDirty(!0,!0),l&&(this.centerOnNode(l),this.selectNodes([l])),this.ds.offset=[0,0],this.ds.scale=1}getCurrentGraph(){return this.graph}async setCanvas(l,n){if(l&&l.constructor===String&&(l=document.getElementById(l),!l))throw"Error creating LiteGraph canvas: Canvas not found";if(l===this.canvas)return;!l&&this.canvas&&(n||this.unbindEvents());const u=l.parentElement,{width:c,height:d}=u.getBoundingClientRect();if(l.width=c,l.height=d,this.canvas=l,this.ds.element=l,!!l){if(l.className+=" lgraphcanvas",l.data=this,l.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),l.getContext==null)throw l.localName!="canvas"?"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+l.localName:"This browser doesn't support Canvas";this.options.useWebgl?await this.enableWebGL():(this.ctx=l.getContext("2d"))==null&&(l.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),await this.enableWebGL()),n||this.bindEvents(),this.draw(!0,!0)}}_doNothing(l){return l.preventDefault(),!1}_doReturnTrue(l){return l.preventDefault(),!0}bindEvents(){if(this._events_binded){console.warn("LGraphCanvas: events already binded");return}const l=this.canvas,u=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph$1.pointerListenerAdd(l,"down",this._mousedown_callback,!0),l.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph$1.pointerListenerAdd(l,"up",this._mouseup_callback,!0),LiteGraph$1.pointerListenerAdd(l,"move",this._mousemove_callback),l.addEventListener("contextmenu",this._doNothing),l.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),l.setAttribute("tabindex",1),l.addEventListener("keydown",this._key_callback,!0),u.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),l.addEventListener("dragover",this._doNothing,!1),l.addEventListener("dragend",this._doNothing,!1),l.addEventListener("drop",this._ondrop_callback,!1),l.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}unbindEvents(){if(!this._events_binded){console.warn("LGraphCanvas: no events binded");return}const n=this.getCanvasWindow().document;LiteGraph$1.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph$1.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph$1.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),n.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}static getFileExtension(l){const n=l.indexOf("?");n!=-1&&(l=l.substr(0,n));const u=l.lastIndexOf(".");return u==-1?"":l.substr(u+1).toLowerCase()}async enableWebGL(){var n;if(typeof GL>"u")throw"litegl.js must be included to use a WebGL canvas";if(typeof enableWebGLCanvas>"u")throw"webglCanvas.js must be included to use this feature";const l=enableWebGLCanvas(this.canvas);l instanceof WebGLRenderingContext&&(await l.loadCachedTextures(),l.cacheFontAtlas("Arial","normal"),l.cacheFontAtlas("Arial","Bold")),this.gl=l,this.ctx=l,this.bgctx=l,(n=this.gl)==null||n.viewport(0,0,this.canvas.width,this.canvas.height),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.canvas.webgl_enabled=!0}setDirty(l,n){l&&(this.dirty_canvas=!0),n&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){if(!this.canvas)return window;const l=this.canvas.ownerDocument;return l.defaultView||l.parentWindow}startRendering(){if(this.is_rendering)return;this.is_rendering=!0,l.call(this);function l(){this.pause_rendering||this.draw();const n=this.getCanvasWindow();this.is_rendering&&n.requestAnimationFrame(l.bind(this))}}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}processMouseDown(l){let n=!1;if(this.block_drag_grp=!1,this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;this.adjustMouseEvent(l);const u=this.getCanvasWindow();u.document,_LGraphCanvas.active_canvas=this;const c=l.clientX,d=l.clientY;this.ds.viewport=this.viewport;const g=!this.viewport||this.viewport&&c>=this.viewport[0]&&c<this.viewport[0]+this.viewport[2]&&d>=this.viewport[1]&&d<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(LiteGraph$1.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph$1.pointerListenerAdd(u.document,"move",this._mousemove_callback,!0),LiteGraph$1.pointerListenerAdd(u.document,"up",this._mouseup_callback,!0)),!g)return;let m=this.graph.getNodeOnPos(l.canvasX,l.canvasY,this.visible_nodes,5),E=!1;const L=LiteGraph$1.getTime(),A=l.isPrimary===void 0||!l.isPrimary,N=L-this.last_mouseclick<300&&A;if(this.mouse[0]=l.clientX,this.mouse[1]=l.clientY,this.graph_mouse[0]=l.canvasX,this.graph_mouse[1]=l.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&A?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph$1.closeAllContextMenus(u),!(this.onMouse&&this.onMouse(l)==!0)){if(m||this.closePanels(),l.which==1&&!this.pointer_is_double){if(this.saveUndoStack(),l.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=l.canvasX,this.dragging_rectangle[1]=l.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,E=!0),LiteGraph$1.alt_drag_do_clone_nodes&&l.altKey&&m&&this.allow_interaction&&!E&&!this.read_only){let R=m.clone();(R=m.clone())&&(R.pos[0]+=5,R.pos[1]+=5,this.graph.add(R,!1,{doCalcSize:!1}),m=R,E=!0,n||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=m),this.selected_nodes[m.id]||this.processNodeSelected(m,l)))}let C=!1;if(m&&(this.allow_interaction||m.flags.allow_interaction)&&!E&&!this.read_only){if(!this.live_mode&&!m.flags.pinned&&this.bringToFront(m),this.allow_interaction&&!this.connecting_node&&!m.flags.collapsed&&!this.live_mode)if(!E&&m.resizable!==!1&&LiteGraph$1.isInsideRectangle(l.canvasX,l.canvasY,m.pos[0]+m.size[0]-5,m.pos[1]+m.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=m,this.canvas.style.cursor="se-resize",E=!0;else{if(m.outputs)for(let R=0,P=m.outputs.length;R<P;++R){const F=m.outputs[R],U=m.getConnectionPos(!1,R);if(LiteGraph$1.isInsideRectangle(l.canvasX,l.canvasY,U[0]-15,U[1]-10,30,20)){this.connecting_node=m,this.connecting_output=F,this.connecting_output.slot_index=R,this.connecting_pos=m.getConnectionPos(!1,R),this.connecting_slot=R,LiteGraph$1.shift_click_do_break_link_from&&l.shiftKey&&m.disconnectOutput(R),N?m.onOutputDblClick&&m.onOutputDblClick(R,l):m.onOutputClick&&m.onOutputClick(R,l),E=!0;break}}if(m.inputs)for(let R=0,P=m.inputs.length;R<P;++R){const F=m.inputs[R],U=m.getConnectionPos(!0,R);if(LiteGraph$1.isInsideRectangle(l.canvasX,l.canvasY,U[0]-15,U[1]-10,30,20)){if(N?m.onInputDblClick&&m.onInputDblClick(R,l):m.onInputClick&&m.onInputClick(R,l),F.link!==null){const e=this.graph.links[F.link];LiteGraph$1.click_do_break_link_to&&(m.disconnectInput(R),this.dirty_bgcanvas=!0,E=!0),(this.allow_reconnect_links||l.shiftKey)&&(LiteGraph$1.click_do_break_link_to||m.disconnectInput(R),this.connecting_node=this.graph._nodes_by_id[e.origin_id],this.connecting_slot=e.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),this.dirty_bgcanvas=!0,E=!0)}E||(this.connecting_node=m,this.connecting_input=F,this.connecting_input.slot_index=R,this.connecting_pos=m.getConnectionPos(!0,R),this.connecting_slot=R,this.dirty_bgcanvas=!0,E=!0)}}}if(!E){const R=[l.canvasX-m.pos[0],l.canvasY-m.pos[1]],P=this.processNodeWidgets(m,this.graph_mouse,l);if(P&&(n=!0,this.node_widget=[m,P]),this.allow_interaction&&N&&this.selected_nodes[m.id]&&(m.onDblClick&&m.onDblClick(l,R,this),this.processNodeDblClicked(m),n=!0),m.onMouseDown&&m.onMouseDown(l,R,this))n=!0;else{if(m.subgraph&&!m.skip_subgraph_button&&!m.flags.collapsed&&R[0]>m.size[0]-LiteGraph$1.NODE_TITLE_HEIGHT&&R[1]<0){const F=this;setTimeout(function(){F.openSubgraph(m.subgraph)},10)}this.live_mode&&(C=!0,n=!0)}n?m.is_selected||this.processNodeSelected(m,l):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=m),this.processNodeSelected(m,l)),this.dirty_canvas=!0}}else if(!E){if(!this.read_only)for(let R=0;R<this.visible_links.length;++R){const P=this.visible_links[R],F=P._pos;if(!(!F||l.canvasX<F[0]-4||l.canvasX>F[0]+4||l.canvasY<F[1]-4||l.canvasY>F[1]+4)){this.showLinkMenu(P,l),this.over_link_center=null;break}}this.selected_group=this.graph.getGroupOnPos(l.canvasX,l.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&N&&(l.preventDefault(),l.stopPropagation(),this.showGrpPanel(this.selected_group),this.block_drag_grp=!0),this.selected_group&&!this.read_only&&!N&&(this.block_drag_grp=!1,l.ctrlKey&&(this.dragging_rectangle=null),LiteGraph$1.distance([l.canvasX,l.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()),C=!0}!E&&C&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else if(l.which==2)if(this.saveUndoStack(),LiteGraph$1.middle_click_slot_add_default_node){if(m&&this.allow_interaction&&!E&&!this.read_only&&!this.connecting_node&&!m.flags.collapsed&&!this.live_mode){let C=!1,R=!1,P=!1;if(m.outputs)for(let F=0,U=m.outputs.length;F<U;++F){const e=m.outputs[F],t=m.getConnectionPos(!1,F);if(LiteGraph$1.isInsideRectangle(l.canvasX,l.canvasY,t[0]-15,t[1]-10,30,20)){C=e,R=F,P=!0;break}}if(m.inputs)for(let F=0,U=m.inputs.length;F<U;++F){const e=m.inputs[F],t=m.getConnectionPos(!0,F);if(LiteGraph$1.isInsideRectangle(l.canvasX,l.canvasY,t[0]-15,t[1]-10,30,20)){C=e,R=F,P=!1;break}}if(C&&R!==!1){const F=.5-(R+1)/(P?m.outputs.length:m.inputs.length),U=m.getBounding(),e=[P?U[0]+U[2]:U[0],l.canvasY-80];this.createDefaultNodeForSlot({nodeFrom:P?m:null,slotFrom:P?R:null,nodeTo:P?null:m,slotTo:P?null:R,position:e,nodeType:"AUTO",posAdd:[P?30:-30,-F*130],posSizeFix:[P?0:-1,0]})}}}else!E&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else(l.which==3||this.pointer_is_double)&&(this.saveUndoStack(),this.allow_interaction&&!E&&!this.read_only&&(m&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[m.id]||l.shiftKey||l.ctrlKey||l.metaKey)?this.selected_nodes[m.id]||this.selectNodes([m],!0):this.selectNodes([m])),this.processContextMenu(m,l)));return this.last_mouse[0]=l.clientX,this.last_mouse[1]=l.clientY,this.last_mouseclick=LiteGraph$1.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!u.document.activeElement||u.document.activeElement.nodeName.toLowerCase()!="input"&&u.document.activeElement.nodeName.toLowerCase()!="textarea")&&l.preventDefault(),l.stopPropagation(),this.onMouseDown&&this.onMouseDown(l),!1}}getGroupMenuOptions(l){return[{content:"",callback:this.onShowPropertyEditor},{content:" ",property:" ",type:"Number",callback:this.onGrpPositionEditor},{content:" ",property:" ",type:"Number",callback:this.onGrpSizeEditor},{content:" ",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeColors},{content:" ",property:"font_size",type:"Number",callback:this.onShowPropertyEditor},{content:"",property:"font_size",type:"Number",callback:this.bringGroupToFront.bind(this,l)},{content:"",property:"font_size",type:"Number",callback:this.sendGroupToBack.bind(this,l)},null,{content:" ",callback:_LGraphCanvas.onMenuNodeRemove}]}processMouseMove(l){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;_LGraphCanvas.active_canvas=this,this.adjustMouseEvent(l);const n=[l.clientX,l.clientY];this.mouse[0]=n[0],this.mouse[1]=n[1];const u=[n[0]-this.last_mouse[0],n[1]-this.last_mouse[1]];if(this.last_mouse=n,this.graph_mouse[0]=l.canvasX,this.graph_mouse[1]=l.canvasY,this.block_click)return l.preventDefault(),!1;l.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,l,this.node_widget[1]),this.dirty_canvas=!0);const c=this.graph.getNodeOnPos(l.canvasX,l.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=l.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=l.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[l.canvasX-this.selected_group.pos[0],l.canvasY-this.selected_group.pos[1]];else{const d=u[0]/this.ds.scale,g=u[1]/this.ds.scale;this.selected_group.move(d,g,l.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=u[0]/this.ds.scale,this.ds.offset[1]+=u[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||c&&c.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(let d=0,g=this.graph._nodes.length;d<g;++d)this.graph._nodes[d].mouseOver&&c!=this.graph._nodes[d]&&(this.graph._nodes[d].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(l),this.node_over=null,this.dirty_canvas=!0);if(c){if(c.redraw_on_mouse&&(this.dirty_canvas=!0),c.mouseOver||(c.mouseOver=!0,this.node_over=c,this.dirty_canvas=!0,c.onMouseEnter&&c.onMouseEnter(l)),c.onMouseMove&&c.onMouseMove(l,[l.canvasX-c.pos[0],l.canvasY-c.pos[1]],this),this.connecting_node){if(this.connecting_output){const d=this._highlight_input||[0,0];if(!this.isOverNodeBox(c,l.canvasX,l.canvasY)){const g=this.isOverNodeInput(c,l.canvasX,l.canvasY,d);if(g!=-1&&c.inputs[g]){const m=c.inputs[g].type;LiteGraph$1.isValidConnection(this.connecting_output.type,m)&&(this._highlight_input=d,this._highlight_input_slot=c.inputs[g])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input){const d=this._highlight_output||[0,0];if(!this.isOverNodeBox(c,l.canvasX,l.canvasY)){const g=this.isOverNodeOutput(c,l.canvasX,l.canvasY,d);if(g!=-1&&c.outputs[g]){const m=c.outputs[g].type;LiteGraph$1.isValidConnection(this.connecting_input.type,m)&&(this._highlight_output=d)}else this._highlight_output=null}}}this.canvas&&(LiteGraph$1.isInsideRectangle(l.canvasX,l.canvasY,c.pos[0]+c.size[0]-5,c.pos[1]+c.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{let d=null;for(let g=0;g<this.visible_links.length;++g){const m=this.visible_links[g],E=m._pos;if(!(!E||l.canvasX<E[0]-4||l.canvasX>E[0]+4||l.canvasY<E[1]-4||l.canvasY>E[1]+4)){d=m;break}}d!=this.over_link_center&&(this.over_link_center=d,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=c&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(l,[l.canvasX-this.node_capturing_input.pos[0],l.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(const d in this.selected_nodes){const g=this.selected_nodes[d];g.pos[0]+=u[0]/this.ds.scale,g.pos[1]+=u[1]/this.ds.scale,g.is_selected||this.processNodeSelected(g,l)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){const d=[l.canvasX-this.resizing_node.pos[0],l.canvasY-this.resizing_node.pos[1]],g=this.resizing_node.computeSize();d[0]=Math.max(g[0],d[0]),d[1]=Math.max(g[1],d[1]),this.resizing_node.setSize(d),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return l.preventDefault(),!1}processMouseUp(l){const n=l.isPrimary===void 0||l.isPrimary;if(!n)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;const c=this.getCanvasWindow().document;_LGraphCanvas.active_canvas=this,this.options.skip_events||(LiteGraph$1.pointerListenerRemove(c,"move",this._mousemove_callback,!0),LiteGraph$1.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph$1.pointerListenerRemove(c,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(l);const d=LiteGraph$1.getTime();if(l.click_time=d-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),l.which==1){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,l),this.node_widget=null,this.selected_group){const m=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),E=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(m,E,l.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}this.selected_group_resizing=!1;const g=this.graph.getNodeOnPos(l.canvasX,l.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){const m=this.graph._nodes,E=new Float32Array(4),L=Math.abs(this.dragging_rectangle[2]),A=Math.abs(this.dragging_rectangle[3]),N=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-L:this.dragging_rectangle[0],C=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-A:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=N,this.dragging_rectangle[1]=C,this.dragging_rectangle[2]=L,this.dragging_rectangle[3]=A,!g||L>10&&A>10){const R=[];for(let P=0;P<m.length;++P){const F=m[P];F.getBounding(E),LiteGraph$1.overlapBounding(this.dragging_rectangle,E)&&R.push(F)}R.length&&this.selectNodes(R,l.shiftKey)}else this.selectNodes([g],l.shiftKey||l.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;const E=(this.connecting_output||this.connecting_input).type;if(g){if(this.connecting_output){const L=this.isOverNodeInput(g,l.canvasX,l.canvasY);L!=-1?this.connecting_node.connect(this.connecting_slot,g,L):this.connecting_node.connectByType(this.connecting_slot,g,E)}else if(this.connecting_input){const L=this.isOverNodeOutput(g,l.canvasX,l.canvasY);L!=-1?g.connect(L,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,g,E)}}else LiteGraph$1.release_link_on_empty_shows_menu&&(l.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(l,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(l,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:l}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:l}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){const m=this.node_dragged;m&&l.click_time<300&&LiteGraph$1.isInsideRectangle(l.canvasX,l.canvasY,m.pos[0],m.pos[1]-LiteGraph$1.NODE_TITLE_HEIGHT,LiteGraph$1.NODE_TITLE_HEIGHT,LiteGraph$1.NODE_TITLE_HEIGHT)&&m.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else!this.graph.getNodeOnPos(l.canvasX,l.canvasY,this.visible_nodes)&&l.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(l,[l.canvasX-this.node_over.pos[0],l.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(l,[l.canvasX-this.node_capturing_input.pos[0],l.canvasY-this.node_capturing_input.pos[1]])}else l.which==2?(this.dirty_canvas=!0,this.dragging_canvas=!1):l.which==3&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return n&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),l.stopPropagation(),l.preventDefault(),!1}processMouseWheel(l){if(!this.graph||!this.allow_dragcanvas)return;const n=l.wheelDeltaY!=null?l.wheelDeltaY:l.detail*-60;this.adjustMouseEvent(l);const u=l.clientX,c=l.clientY;if(!(!this.viewport||this.viewport&&u>=this.viewport[0]&&u<this.viewport[0]+this.viewport[2]&&c>=this.viewport[1]&&c<this.viewport[1]+this.viewport[3]))return;let g=this.ds.scale;return n>0?g*=1.1:n<0&&(g*=1/1.1),this.ds.changeScale(g,[l.clientX,l.clientY]),this.graph.change(),l.preventDefault(),!1}isOverNodeBox(l,n,u){const c=LiteGraph$1.NODE_TITLE_HEIGHT;return!!LiteGraph$1.isInsideRectangle(n,u,l.pos[0]+2,l.pos[1]+2-c,c-4,c-4)}isOverNodeInput(l,n,u,c){if(l.inputs)for(let d=0,g=l.inputs.length;d<g;++d){l.inputs[d];const m=l.getConnectionPos(!0,d);let E=!1;if(l.horizontal?E=LiteGraph$1.isInsideRectangle(n,u,m[0]-5,m[1]-10,10,20):E=LiteGraph$1.isInsideRectangle(n,u,m[0]-10,m[1]-5,40,10),E)return c&&(c[0]=m[0],c[1]=m[1]),d}return-1}isOverNodeOutput(l,n,u,c){if(l.outputs)for(let d=0,g=l.outputs.length;d<g;++d){l.outputs[d];const m=l.getConnectionPos(!1,d);let E=!1;if(l.horizontal?E=LiteGraph$1.isInsideRectangle(n,u,m[0]-5,m[1]-10,10,20):E=LiteGraph$1.isInsideRectangle(n,u,m[0]-10,m[1]-5,40,10),E)return c&&(c[0]=m[0],c[1]=m[1]),d}return-1}processKey(l){if(!this.graph)return;let n=!1;if(l.target.localName!="input"){if(l.type=="keydown"){this.isKeyPressed=!0,l.keyCode==32&&(this.saveUndoStack(),this.dragging_canvas=!0,n=!0),l.keyCode==27&&(this.saveUndoStack(),this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),n=!0),l.keyCode==65&&l.ctrlKey&&(this.saveUndoStack(),this.selectNodes(),n=!0),l.keyCode===67&&(l.metaKey||l.ctrlKey)&&!l.shiftKey&&this.selected_nodes&&(this.saveUndoStack(),this.copyToClipboard(),n=!0),l.keyCode===86&&(l.metaKey||l.ctrlKey)&&(this.saveUndoStack(),this.pasteFromClipboard(l.shiftKey));const u=c=>{if(this.selected_nodes&&c.key==="ArrowUp"){this.saveUndoStackEvt();for(let d in this.selected_nodes)this.selected_nodes[d].pos[1]-=1}if(this.selected_nodes&&c.key==="ArrowDown"){this.saveUndoStackEvt();for(let d in this.selected_nodes)this.selected_nodes[d].pos[1]+=1}if(this.selected_nodes&&c.key==="ArrowLeft"){this.saveUndoStackEvt();for(let d in this.selected_nodes)this.selected_nodes[d].pos[0]-=1}if(this.selected_nodes&&c.key==="ArrowRight"){this.saveUndoStackEvt();for(let d in this.selected_nodes)this.selected_nodes[d].pos[0]+=1}};if(this.isKeyPressed?u(l):this.isKeyPressed=!1,(l.keyCode==46||l.keyCode==8)&&l.target.localName!="input"&&l.target.localName!="textarea"&&(this.saveUndoStack(),this.deleteSelectedNodes(),n=!0),this.selected_nodes)for(const c in this.selected_nodes)this.selected_nodes[c].onKeyDown&&this.selected_nodes[c].onKeyDown(l)}else if(l.type=="keyup"){if(l.keyCode==32&&(this.dragging_canvas=!1),this.selected_nodes)for(const u in this.selected_nodes)this.selected_nodes[u].onKeyUp&&this.selected_nodes[u].onKeyUp(l);l.ctrlKey&&l.key==="z"&&!this.read_only&&this.undo(),l.ctrlKey&&l.key==="y"&&!this.read_only&&this.redo()}if(this.graph.change(),n)return l.preventDefault(),l.stopImmediatePropagation(),!1}}checkObjectEqual(l,n){const u=JSON.stringify(l),c=JSON.stringify(n);return u===c}undo(){if(this.undoStack.length===0)return;const l=this.graph.serialize();this.redoStack.push(this.tempDeepClone(l));const n=this.undoStack.pop();this.graph.configure(this.tempDeepClone(n)),this.draw(!0,!0)}redo(){if(this.redoStack.length===0)return;const l=this.graph.serialize();this.undoStack.push(this.tempDeepClone(l));const n=this.redoStack.pop();this.graph.configure(this.tempDeepClone(n)),this.draw(!0,!0)}debounceTime(l,n){let u=null;return function(...c){const d=this;clearTimeout(u),u=setTimeout(()=>l.apply(d,c),n)}}tempDeepClone(l){return JSON.parse(JSON.stringify(l))}copyToClipboard(){const l={nodes:[],links:[]};let n=0;const u=[];for(const c in this.selected_nodes){const d=this.selected_nodes[c];d.clonable!==!1&&(d._relative_id=n,u.push(d),n+=1)}for(let c=0;c<u.length;++c){const d=u[c];if(d.clonable===!1)continue;const g=d.clone();if(!g){console.warn("node type not found: "+d.type);continue}if(l.nodes.push(g.serialize()),d.inputs&&d.inputs.length)for(let m=0;m<d.inputs.length;++m){const E=d.inputs[m];if(!E||E.link==null)continue;const L=this.graph.links[E.link];if(!L)continue;const A=this.graph.getNodeById(L.origin_id);A&&l.links.push([A._relative_id,L.origin_slot,d._relative_id,L.target_slot,A.id])}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(l))}pasteFromClipboard(l=!1){if(!LiteGraph$1.ctrl_shift_v_paste_connect_unselected_outputs&&l)return;const n=localStorage.getItem("litegrapheditor_clipboard");if(!n)return;this.graph.beforeChange();const u=JSON.parse(n);let c=!1,d=!1;for(let m=0;m<u.nodes.length;++m)c?(c[0]>u.nodes[m].pos[0]&&(c[0]=u.nodes[m].pos[0],d[0]=m),c[1]>u.nodes[m].pos[1]&&(c[1]=u.nodes[m].pos[1],d[1]=m)):(c=[u.nodes[m].pos[0],u.nodes[m].pos[1]],d=[m,m]);const g=[];for(let m=0;m<u.nodes.length;++m){const E=u.nodes[m],L=LiteGraph$1.createNode(E.type);L&&(L.configure(E),L.pos[0]+=this.graph_mouse[0]-c[0],L.pos[1]+=this.graph_mouse[1]-c[1],this.graph.add(L,{doProcessChange:!1}),g.push(L))}for(let m=0;m<u.links.length;++m){const E=u.links[m];let L;const A=E[0];if(A!=null)L=g[A];else if(LiteGraph$1.ctrl_shift_v_paste_connect_unselected_outputs&&l){const C=E[4];C&&(L=this.graph.getNodeById(C))}const N=g[E[2]];L&&N?L.connect(E[1],N,E[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(g),this.graph.afterChange()}processDrop(l){l.preventDefault(),this.adjustMouseEvent(l);const n=l.clientX,u=l.clientY;if(!(!this.viewport||this.viewport&&n>=this.viewport[0]&&n<this.viewport[0]+this.viewport[2]&&u>=this.viewport[1]&&u<this.viewport[1]+this.viewport[3]))return;const d=[l.canvasX,l.canvasY],g=this.graph?this.graph.getNodeOnPos(d[0],d[1]):null;if(!g){let m=null;this.onDropItem&&(m=this.onDropItem(event)),m||this.checkDropItem(l);return}if(g.onDropFile||g.onDropData){const m=l.dataTransfer.files;if(m&&m.length)for(let E=0;E<m.length;E++){const L=l.dataTransfer.files[0],A=L.name;if(_LGraphCanvas.getFileExtension(A),g.onDropFile&&g.onDropFile(L),g.onDropData){const N=new FileReader;N.onload=function(R){const P=R.target.result;g.onDropData(P,A,L)};const C=L.type.split("/")[0];C=="text"||C==""?N.readAsText(L):C=="image"?N.readAsDataURL(L):N.readAsArrayBuffer(L)}}}return g.onDropItem&&g.onDropItem(event)?!0:this.onDropItem?this.onDropItem(event):!1}checkDropItem(l){if(l.dataTransfer.files.length){const n=l.dataTransfer.files[0],u=_LGraphCanvas.getFileExtension(n.name).toLowerCase(),c=LiteGraph$1.node_types_by_file_extension[u];if(c){this.graph.beforeChange();const d=LiteGraph$1.createNode(c.type);d.pos=[l.canvasX,l.canvasY],this.graph.add(d),d.onDropFile&&d.onDropFile(n),this.graph.afterChange()}}}processNodeDblClicked(l){this.onShowNodePanel?this.onShowNodePanel(l):this.showShowNodePanel(l),this.onNodeDblClicked&&this.onNodeDblClicked(l),this.setDirty(!0)}processNodeSelected(l,n){this.selectNode(l,n&&(n.shiftKey||n.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(l)}selectNode(l,n){l==null?this.deselectAllNodes():this.selectNodes([l],n)}selectNodes(l,n){n||this.deselectAllNodes(),l=l||this.graph._nodes,typeof l=="string"&&(l=[l]);for(const u in l){const c=l[u];if(c.is_selected){this.deselectNode(c);continue}if(!c.is_selected&&c.onSelected&&c.onSelected(),c.is_selected=!0,this.selected_nodes[c.id]=c,c.inputs)for(let d=0;d<c.inputs.length;++d)this.highlighted_links[c.inputs[d].link]=!0;if(c.outputs)for(let d=0;d<c.outputs.length;++d){const g=c.outputs[d];if(g.links)for(let m=0;m<g.links.length;++m)this.highlighted_links[g.links[m]]=!0}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}deselectNode(l){if(l.is_selected){if(l.onDeselected&&l.onDeselected(),l.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(l),l.inputs)for(let n=0;n<l.inputs.length;++n)delete this.highlighted_links[l.inputs[n].link];if(l.outputs)for(let n=0;n<l.outputs.length;++n){const u=l.outputs[n];if(u.links)for(let c=0;c<u.links.length;++c)delete this.highlighted_links[u.links[c]]}}}deselectAllNodes(){if(!this.graph)return;const l=this.graph._nodes;for(let n=0,u=l.length;n<u;++n){const c=l[n];c.is_selected&&(c.onDeselected&&c.onDeselected(),c.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(c))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}deleteSelectedNodes(){this.graph.beforeChange();for(const l in this.selected_nodes){const n=this.selected_nodes[l];if(!n.block_delete){if(n.inputs&&n.inputs.length&&n.outputs&&n.outputs.length&&LiteGraph$1.isValidConnection(n.inputs[0].type,n.outputs[0].type)&&n.inputs[0].link&&n.outputs[0].links&&n.outputs[0].links.length){const u=n.graph.links[n.inputs[0].link],c=n.graph.links[n.outputs[0].links[0]],d=n.getInputNode(0),g=n.getOutputNodes(0)[0];d&&g&&d.connect(u.origin_slot,g,c.target_slot)}this.graph.remove(n),this.onNodeDeselected&&this.onNodeDeselected(n)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}centerOnNode(l){this.ds.offset[0]=-l.pos[0]-l.size[0]*.5+this.canvas.width*.5/this.ds.scale,this.ds.offset[1]=-l.pos[1]-l.size[1]*.5+this.canvas.height*.5/this.ds.scale,this.setDirty(!0,!0)}adjustMouseEvent(l){let n=0,u=0;if(this.canvas){const c=this.canvas.getBoundingClientRect();n=l.clientX-c.left,u=l.clientY-c.top}else n=l.clientX,u=l.clientY;this.last_mouse_position[0]=n,this.last_mouse_position[1]=u,l.canvasX=n/this.ds.scale-this.ds.offset[0],l.canvasY=u/this.ds.scale-this.ds.offset[1]}setZoom(l,n){this.ds.changeScale(l,n),this.dirty_canvas=!0,this.dirty_bgcanvas=!0}convertOffsetToCanvas(l,n){return this.ds.convertOffsetToCanvas(l,n)}convertCanvasToOffset(l,n){return this.ds.convertCanvasToOffset(l,n)}convertEventToCanvasOffset(l){const n=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([l.clientX-n.left,l.clientY-n.top])}bringToFront(l){const n=this.graph._nodes.indexOf(l);n!=-1&&(this.graph._nodes.splice(n,1),this.graph._nodes.push(l))}sendToBack(l){const n=this.graph._nodes.indexOf(l);n!=-1&&(this.graph._nodes.splice(n,1),this.graph._nodes.unshift(l))}computeVisibleNodes(l,n){const u=new Float32Array(4),c=n||[];c.length=0,l=l||this.graph._nodes;for(let d=0,g=l.length;d<g;++d){const m=l[d];this.live_mode&&!m.onDrawBackground&&!m.onDrawForeground||m.getBounding&&LiteGraph$1.overlapBounding(this.visible_area,m.getBounding(u,!0))&&c.push(m)}return c}draw(l,n){if(!this.canvas||this.canvas.width==0||this.canvas.height==0)return;const u=LiteGraph$1.getTime();this.render_time=(u-this.last_draw_time)*.001,this.last_draw_time=u,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||n||this.always_render_background||this.graph&&this.graph._last_trigger_time&&u-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||l)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}drawFrontCanvas(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));const l=this.ctx;if(!l)return;const n=this.canvas;l.start2D&&!this.viewport&&(l.start2D(),l.restore(),l.setTransform(1,0,0,1,0,0));const u=this.viewport||this.dirty_area;if(u&&(l.save(),l.beginPath(),l.rect(u[0],u[1],u[2],u[3]),l.clip()),this.clear_background&&(u?l.clearRect(u[0],u[1],u[2],u[3]):l.clearRect(0,0,n.width,n.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():l.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(n,l),this.show_info&&this.renderInfo(l,u?u[0]:0,u?u[1]:0),this.graph){l.save(),this.ds.toCanvasContext(l);const c=this.computeVisibleNodes(null,this.visible_nodes);for(let d=0;d<c.length;++d){const g=c[d];l.save(),l.translate(g.pos[0],g.pos[1]),this.drawNode(g,l),l.restore()}if(this.addNodeGuideLines(l),this.render_execution_order&&this.drawExecutionOrder(l),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(l)),this.connecting_pos!=null){l.lineWidth=this.connections_width;let d=null;const g=this.connecting_output||this.connecting_input,m=g.type;let E=g.dir;E==null&&(this.connecting_output?E=this.connecting_node.horizontal?LiteGraph$1.DOWN:LiteGraph$1.RIGHT:E=this.connecting_node.horizontal?LiteGraph$1.UP:LiteGraph$1.LEFT);const L=g.shape;switch(m){case LiteGraph$1.EVENT:d=LiteGraph$1.EVENT_LINK_COLOR;break;default:d=LiteGraph$1.CONNECTING_LINK_COLOR}if(this.renderLink(l,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,d,E,LiteGraph$1.CENTER),l.beginPath(),m===LiteGraph$1.EVENT||L===LiteGraph$1.BOX_SHAPE?(l.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),l.fill(),l.beginPath(),l.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):L===LiteGraph$1.ARROW_SHAPE?(l.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),l.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),l.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),l.closePath()):(l.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,Math.PI*2),l.fill(),l.beginPath(),l.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,Math.PI*2)),l.fill(),l.fillStyle="#ffcc00",this._highlight_input&&(l.beginPath(),this._highlight_input_slot.shape===LiteGraph$1.ARROW_SHAPE?(l.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),l.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),l.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),l.closePath()):l.arc(this._highlight_input[0],this._highlight_input[1],6,0,Math.PI*2),l.fill()),this._highlight_output){let A=this._highlight_input_slot.shape;l.beginPath(),A===LiteGraph$1.ARROW_SHAPE?(l.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),l.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),l.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),l.closePath()):l.arc(this._highlight_output[0],this._highlight_output[1],6,0,Math.PI*2),l.fill()}}this.dragging_rectangle&&(l.strokeStyle="#FFF",l.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(l,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(l,null),this.onDrawForeground&&this.onDrawForeground(l,this.visible_rect),l.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(l),this.onDrawOverlay&&this.onDrawOverlay(l),this.showPopover&&this.drawPopoverLine(l),u&&l.restore(),l.finish2D&&l.finish2D()}drawSubgraphPanel(l){const n=this.graph,u=n._subgraph_node;if(!u){console.warn("subgraph without subnode");return}this.drawSubgraphPanelLeft(n,u,l),this.drawSubgraphPanelRight(n,u,l)}drawSubgraphPanelLeft(l,n,u){const c=n.inputs?n.inputs.length:0,d=200,g=Math.floor(LiteGraph$1.NODE_SLOT_HEIGHT*1.6);if(u.fillStyle="#111",u.globalAlpha=.8,u.beginPath(),u.roundRect(10,10,d,(c+1)*g+50,[8]),u.fill(),u.globalAlpha=1,u.fillStyle="#888",u.font="14px Arial",u.textAlign="left",u.fillText("Graph Inputs",20,34),this.drawButton(d-20,20,20,20,"X","#151515")){this.closeSubgraph();return}let m=50;if(u.font="14px Arial",n.inputs)for(let E=0;E<n.inputs.length;++E){const L=n.inputs[E];if(!L.not_subgraph_input){if(this.drawButton(20,m+2,d-20,g-2)){const A=n.constructor.input_node_type||"graph/input";this.graph.beforeChange();const N=LiteGraph$1.createNode(A);N?(l.add(N),this.block_click=!1,this.last_click_position=null,this.selectNodes([N]),this.node_dragged=N,this.dragging_canvas=!1,N.setProperty("name",L.name),N.setProperty("type",L.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",A)}u.fillStyle="#9C9",u.beginPath(),u.arc(d-16,m+g*.5,5,0,2*Math.PI),u.fill(),u.fillStyle="#AAA",u.fillText(L.name,30,m+g*.75),u.fillStyle="#777",u.fillText(L.type,130,m+g*.75),m+=g}}this.drawButton(20,m+2,d-20,g-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(n)}drawSubgraphPanelRight(l,n,u){const c=n.outputs?n.outputs.length:0,d=this.bgcanvas.width,g=200,m=Math.floor(LiteGraph$1.NODE_SLOT_HEIGHT*1.6);u.fillStyle="#111",u.globalAlpha=.8,u.beginPath(),u.roundRect(d-g-10,10,g,(c+1)*m+50,[8]),u.fill(),u.globalAlpha=1,u.fillStyle="#888",u.font="14px Arial",u.textAlign="left";const E="Graph Outputs",L=u.measureText(E).width;if(u.fillText(E,d-L-20,34),this.drawButton(d-g,20,20,20,"X","#151515")){this.closeSubgraph();return}let A=50;if(u.font="14px Arial",n.outputs)for(let N=0;N<n.outputs.length;++N){const C=n.outputs[N];if(!C.not_subgraph_input){if(this.drawButton(d-g,A+2,g-20,m-2)){const R=n.constructor.output_node_type||"graph/output";this.graph.beforeChange();const P=LiteGraph$1.createNode(R);P?(l.add(P),this.block_click=!1,this.last_click_position=null,this.selectNodes([P]),this.node_dragged=P,this.dragging_canvas=!1,P.setProperty("name",C.name),P.setProperty("type",C.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",R)}u.fillStyle="#9C9",u.beginPath(),u.arc(d-g+16,A+m*.5,5,0,2*Math.PI),u.fill(),u.fillStyle="#AAA",u.fillText(C.name,d-g+30,A+m*.75),u.fillStyle="#777",u.fillText(C.type,d-g+130,A+m*.75),A+=m}}this.drawButton(d-g,A+2,g-20,m-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(n)}drawButton(l,n,u,c,d,g,m,E){const L=this.ctx;g=g||LiteGraph$1.NODE_DEFAULT_COLOR,m=m||"#555",E=E||LiteGraph$1.NODE_TEXT_COLOR;let A=this.ds.convertOffsetToCanvas(this.graph_mouse);const N=LiteGraph$1.isInsideRectangle(A[0],A[1],l,n,u,c);if(A=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null,A){const P=this.canvas.getBoundingClientRect();A[0]-=P.left,A[1]-=P.top}const C=A&&LiteGraph$1.isInsideRectangle(A[0],A[1],l,n,u,c);L.fillStyle=N?m:g,C&&(L.fillStyle="#AAA"),L.beginPath(),L.roundRect(l,n,u,c,[4]),L.fill(),d!=null&&d.constructor==String&&(L.fillStyle=E,L.textAlign="center",L.font=(c*.65|0)+"px Arial",L.fillText(d,l+u*.5,n+c*.75),L.textAlign="left");const R=C&&!this.block_click;return C&&this.blockClick(),R}isAreaClicked(l,n,u,c,d){let g=this.mouse;LiteGraph$1.isInsideRectangle(g[0],g[1],l,n,u,c),g=this.last_click_position;const m=g&&LiteGraph$1.isInsideRectangle(g[0],g[1],l,n,u,c),E=m&&!this.block_click;return m&&d&&this.blockClick(),E}renderInfo(l,n,u){n=n||10,u=u||this.canvas.height-80,l.save(),l.translate(n,u),l.font="10px Arial",l.fillStyle="#888",l.textAlign="left",this.graph?(l.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13*1),l.fillText("I: "+this.graph.iteration,5,13*2),l.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,13*3),l.fillText("V: "+this.graph._version,5,13*4),l.fillText("FPS:"+this.fps.toFixed(2),5,13*5)):l.fillText("No graph selected",5,13*1),l.restore()}drawBackCanvas(){const l=this.bgcanvas;(l.width!=this.canvas.width||l.height!=this.canvas.height)&&(l.width=this.canvas.width,l.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));const n=this.bgctx;n.start&&n.start();const u=this.viewport||[0,0,n.canvas.width,n.canvas.height];if(this.clear_background&&n.clearRect(u[0],u[1],u[2],u[3]),this._graph_stack&&this._graph_stack.length){n.save(),this._graph_stack[this._graph_stack.length-1];const d=this.graph._subgraph_node;n.strokeStyle=d.bgcolor,n.lineWidth=10,n.strokeRect(1,1,l.width-2,l.height-2),n.lineWidth=1,n.font="40px Arial",n.textAlign="center",n.fillStyle=d.bgcolor||"#AAA";let g="";for(let m=1;m<this._graph_stack.length;++m)g+=this._graph_stack[m]._subgraph_node.getTitle()+" >> ";n.fillText(g+d.getTitle(),l.width*.5,40),n.restore()}let c=!1;if(this.onRenderBackground&&(c=this.onRenderBackground(l,n)),this.viewport||(n.restore(),n.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(n.save(),this.ds.toCanvasContext(n),this.ds.scale<1.5&&!c&&this.clear_background_color&&(n.fillStyle=this.clear_background_color,n.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!c){if(this.zoom_modify_alpha?n.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:n.globalAlpha=this.editor_alpha,n.imageSmoothingEnabled=n.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;const g=this;this._bg_img.onload=function(){g.draw(!0,!0)}}let d=null;this._pattern==null&&this._bg_img.width>0?(d=n.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=d):d=this._pattern,d&&(n.fillStyle=d,n.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),n.fillStyle="transparent"),n.globalAlpha=1,n.imageSmoothingEnabled=n.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(l,n),this.onDrawBackground&&this.onDrawBackground(n,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(n.strokeStyle="#235",n.strokeRect(0,0,l.width,l.height)),this.render_connections_shadows?(n.shadowColor="#000",n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=6):n.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(n),n.shadowColor="rgba(0,0,0,0)",n.restore()}n.finish&&n.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(l,n){const u=new Float32Array(2);this.current_node=l;const c=l.color||l.constructor.color||LiteGraph$1.NODE_DEFAULT_COLOR;let d=l.bgcolor||l.constructor.bgcolor||LiteGraph$1.NODE_DEFAULT_BGCOLOR;l.mouseOver;const g=this.ds.scale<.6;if(this.live_mode){l.flags.collapsed||(n.shadowColor="transparent",l.onDrawForeground&&l.onDrawForeground(n,this,this.canvas));return}const m=this.editor_alpha;if(n.globalAlpha=m,this.render_shadows&&!g?(n.shadowColor=LiteGraph$1.DEFAULT_SHADOW_COLOR,n.shadowOffsetX=2*this.ds.scale,n.shadowOffsetY=2*this.ds.scale,n.shadowBlur=3*this.ds.scale):n.shadowColor="transparent",l.flags.collapsed&&l.onDrawCollapsed&&l.onDrawCollapsed(n,this)==!0)return;const E=l._shape||LiteGraph$1.BOX_SHAPE,L=u;u.set(l.size);const A=l.horizontal;if(l.flags.collapsed){n.font=this.inner_text_font;const U=l.getTitle?l.getTitle():l.title;U!=null&&(l._collapsed_width=Math.min(l.size[0],n.measureText(U).width+LiteGraph$1.NODE_TITLE_HEIGHT*2),L[0]=l._collapsed_width,L[1]=0)}l.clip_area&&(n.save(),n.beginPath(),E==LiteGraph$1.BOX_SHAPE?n.rect(0,0,L[0],L[1]):E==LiteGraph$1.ROUND_SHAPE?n.roundRect(0,0,L[0],L[1],[10]):E==LiteGraph$1.CIRCLE_SHAPE&&n.arc(L[0]*.5,L[1]*.5,L[0]*.5,0,Math.PI*2),n.clip()),l.has_errors&&(d="red"),this.drawNodeShape(l,n,L,c,d,l.is_selected,l.mouseOver),n.shadowColor="transparent",l.onDrawForeground&&l.onDrawForeground(n,this,this.canvas),n.textAlign=A?"center":"left",n.font=this.inner_text_font;const N=!g,C=this.connecting_output,R=this.connecting_input;n.lineWidth=1;let P=0;const F=new Float32Array(2);if(l.flags.collapsed){if(this.render_collapsed_slots){let U=null,e=null;if(l.inputs)for(let t=0;t<l.inputs.length;t++){const r=l.inputs[t];if(r.link!=null){U=r;break}}if(l.outputs)for(let t=0;t<l.outputs.length;t++){const r=l.outputs[t];r.links&&r.links.length&&(e=r)}if(U){let t=0,r=LiteGraph$1.NODE_TITLE_HEIGHT*-.5;A&&(t=l._collapsed_width*.5,r=-LiteGraph$1.NODE_TITLE_HEIGHT),n.fillStyle="#686",n.beginPath(),U.type===LiteGraph$1.EVENT||U.shape===LiteGraph$1.BOX_SHAPE?n.rect(t-7+.5,r-4,14,8):U.shape===LiteGraph$1.ARROW_SHAPE?(n.moveTo(t+8,r),n.lineTo(t-4,r-4),n.lineTo(t-4,r+4),n.closePath()):n.arc(t,r,4,0,Math.PI*2),n.fill()}if(e){let t=l._collapsed_width,r=LiteGraph$1.NODE_TITLE_HEIGHT*-.5;A&&(t=l._collapsed_width*.5,r=0),n.fillStyle="#686",n.strokeStyle="black",n.beginPath(),e.type===LiteGraph$1.EVENT||e.shape===LiteGraph$1.BOX_SHAPE?n.rect(t-7+.5,r-4,14,8):e.shape===LiteGraph$1.ARROW_SHAPE?(n.moveTo(t+6,r),n.lineTo(t-6,r-4),n.lineTo(t-6,r+4),n.closePath()):n.arc(t,r,4,0,Math.PI*2),n.fill()}}}else{if(l.inputs)for(let U=0;U<l.inputs.length;U++){const e=l.inputs[U],t=e.type;let r=e.shape;n.globalAlpha=m,this.connecting_output&&!LiteGraph$1.isValidConnection(e.type,C.type)&&(n.globalAlpha=.4*m),n.fillStyle=e.link!=null?e.color_on||this.default_connection_color_byType[t]||this.default_connection_color.input_on:e.color_off||this.default_connection_color_byTypeOff[t]||this.default_connection_color_byType[t]||this.default_connection_color.input_off;const s=l.getConnectionPos(!0,U,F);if(s[0]-=l.pos[0],s[1]-=l.pos[1],P<s[1]+LiteGraph$1.NODE_SLOT_HEIGHT*.5&&(P=s[1]+LiteGraph$1.NODE_SLOT_HEIGHT*.5),n.beginPath(),t=="array"&&(r=LiteGraph$1.GRID_SHAPE),e.type===LiteGraph$1.EVENT||e.shape===LiteGraph$1.BOX_SHAPE?A?n.rect(s[0]-5+.5,s[1]-8+.5,10,14):n.rect(s[0]-6+.5,s[1]-5+.5,14,10):r===LiteGraph$1.ARROW_SHAPE?(n.moveTo(s[0]+8,s[1]+.5),n.lineTo(s[0]-4,s[1]+6+.5),n.lineTo(s[0]-4,s[1]-6+.5),n.closePath()):r===LiteGraph$1.GRID_SHAPE?(n.rect(s[0]-4,s[1]-4,2,2),n.rect(s[0]-1,s[1]-4,2,2),n.rect(s[0]+2,s[1]-4,2,2),n.rect(s[0]-4,s[1]-1,2,2),n.rect(s[0]-1,s[1]-1,2,2),n.rect(s[0]+2,s[1]-1,2,2),n.rect(s[0]-4,s[1]+2,2,2),n.rect(s[0]-1,s[1]+2,2,2),n.rect(s[0]+2,s[1]+2,2,2)):g?n.rect(s[0]-4,s[1]-4,8,8):n.arc(s[0],s[1],4,0,Math.PI*2),n.fill(),N){const a=e.label!=null?e.label:e.name;a&&(n.fillStyle=LiteGraph$1.NODE_TEXT_COLOR,A||e.dir==LiteGraph$1.UP?n.fillText(a,s[0],s[1]-10):n.fillText(a,s[0]+10,s[1]+5))}}if(n.textAlign=A?"center":"right",n.strokeStyle="black",l.outputs)for(let U=0;U<l.outputs.length;U++){const e=l.outputs[U],t=e.type;let r=e.shape;this.connecting_input&&!LiteGraph$1.isValidConnection(t,R.type)&&(n.globalAlpha=.4*m);const s=l.getConnectionPos(!1,U,F);s[0]-=l.pos[0],s[1]-=l.pos[1],P<s[1]+LiteGraph$1.NODE_SLOT_HEIGHT*.5&&(P=s[1]+LiteGraph$1.NODE_SLOT_HEIGHT*.5),n.fillStyle=e.links&&e.links.length?e.color_on||this.default_connection_color_byType[t]||this.default_connection_color.output_on:e.color_off||this.default_connection_color_byTypeOff[t]||this.default_connection_color_byType[t]||this.default_connection_color.output_off,n.beginPath(),t=="array"&&(r=LiteGraph$1.GRID_SHAPE);let a=!0;if(t===LiteGraph$1.EVENT||r===LiteGraph$1.BOX_SHAPE?A?n.rect(s[0]-5+.5,s[1]-8+.5,10,14):n.rect(s[0]-6+.5,s[1]-5+.5,14,10):r===LiteGraph$1.ARROW_SHAPE?(n.moveTo(s[0]+8,s[1]+.5),n.lineTo(s[0]-4,s[1]+6+.5),n.lineTo(s[0]-4,s[1]-6+.5),n.closePath()):r===LiteGraph$1.GRID_SHAPE?(n.rect(s[0]-4,s[1]-4,2,2),n.rect(s[0]-1,s[1]-4,2,2),n.rect(s[0]+2,s[1]-4,2,2),n.rect(s[0]-4,s[1]-1,2,2),n.rect(s[0]-1,s[1]-1,2,2),n.rect(s[0]+2,s[1]-1,2,2),n.rect(s[0]-4,s[1]+2,2,2),n.rect(s[0]-1,s[1]+2,2,2),n.rect(s[0]+2,s[1]+2,2,2),a=!1):g?n.rect(s[0]-4,s[1]-4,8,8):n.arc(s[0],s[1],4,0,Math.PI*2),n.fill(),!g&&a&&n.stroke(),N){const o=e.label!=null?e.label:e.name;o&&(n.fillStyle=LiteGraph$1.NODE_TEXT_COLOR,A||e.dir==LiteGraph$1.DOWN?n.fillText(o,s[0],s[1]-8):n.fillText(o,s[0]-10,s[1]+5))}}if(n.textAlign="left",n.globalAlpha=1,l.widgets){let U=P;(A||l.widgets_up)&&(U=2),l.widgets_start_y!=null&&(U=l.widgets_start_y),this.drawNodeWidgets(l,U,n,this.node_widget&&this.node_widget[0]==l?this.node_widget[1]:null)}}l.clip_area&&n.restore(),n.globalAlpha=1}drawLinkTooltip(l,n){const u=n._pos;if(l.fillStyle="black",l.beginPath(),l.arc(u[0],u[1],3,0,Math.PI*2),l.fill(),n.data==null||this.onDrawLinkTooltip&&this.onDrawLinkTooltip(l,n,this)==!0)return;const c=n.data;let d=null;if(c.constructor===Number?d=c.toFixed(2):c.constructor===String?d='"'+c+'"':c.constructor===Boolean?d=String(c):c.toToolTip?d=c.toToolTip():d="["+c.constructor.name+"]",d==null)return;d=d.substr(0,30),l.font="14px Courier New";const m=l.measureText(d).width+20,E=24;l.shadowColor="black",l.shadowOffsetX=2,l.shadowOffsetY=2,l.shadowBlur=3,l.fillStyle="#454",l.beginPath(),l.roundRect(u[0]-m*.5,u[1]-15-E,m,E,[3]),l.moveTo(u[0]-10,u[1]-15),l.lineTo(u[0]+10,u[1]-15),l.lineTo(u[0],u[1]-5),l.fill(),l.shadowColor="transparent",l.textAlign="center",l.fillStyle="#CEC",l.fillText(d,u[0],u[1]-15-E*.3)}drawNodeShape(l,n,u,c,d,g,m){const E=new Float32Array(4);n.strokeStyle=c,n.fillStyle=d;const L=LiteGraph$1.NODE_TITLE_HEIGHT,A=this.ds.scale<.5,N=l._shape||l.constructor.shape||LiteGraph$1.ROUND_SHAPE,C=l.constructor.title_mode;let R=!0;C==LiteGraph$1.TRANSPARENT_TITLE||C==LiteGraph$1.NO_TITLE?R=!1:C==LiteGraph$1.AUTOHIDE_TITLE&&m&&(R=!0);const P=E;P[0]=0,P[1]=R?-L:0,P[2]=u[0]+1,P[3]=R?u[1]+L:u[1];const F=n.globalAlpha;if(n.beginPath(),N==LiteGraph$1.BOX_SHAPE||A?n.fillRect(P[0],P[1],P[2],P[3]):N==LiteGraph$1.ROUND_SHAPE||N==LiteGraph$1.CARD_SHAPE?n.roundRect(P[0],P[1],P[2],P[3],N==LiteGraph$1.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):N==LiteGraph$1.CIRCLE_SHAPE&&n.arc(u[0]*.5,u[1]*.5,u[0]*.5,0,Math.PI*2),n.fill(),!l.flags.collapsed&&R&&(n.shadowColor="transparent",n.fillStyle="rgba(0,0,0,0.2)",n.fillRect(0,-1,P[2],2)),n.shadowColor="transparent",l.onDrawBackground&&l.onDrawBackground(n,this,this.canvas,this.graph_mouse),R||C==LiteGraph$1.TRANSPARENT_TITLE){if(l.onDrawTitleBar)l.onDrawTitleBar(n,L,u,this.ds.scale,c);else if(C!=LiteGraph$1.TRANSPARENT_TITLE&&(l.constructor.title_color||this.render_title_colored)){const t=l.constructor.title_color||c;if(l.flags.collapsed&&(n.shadowColor=LiteGraph$1.DEFAULT_SHADOW_COLOR),this.use_gradients){let r=_LGraphCanvas.gradients[t];r||(r=_LGraphCanvas.gradients[t]=n.createLinearGradient(0,0,400,0),r.addColorStop(0,t),r.addColorStop(1,"#000")),n.fillStyle=r}else n.fillStyle=t;n.beginPath(),N==LiteGraph$1.BOX_SHAPE||A?n.rect(0,-L,u[0]+1,L):(N==LiteGraph$1.ROUND_SHAPE||N==LiteGraph$1.CARD_SHAPE)&&n.roundRect(0,-L,u[0]+1,L,l.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),n.fill(),n.shadowColor="transparent"}let U=!1;LiteGraph$1.node_box_coloured_by_mode&&LiteGraph$1.NODE_MODES_COLORS[l.mode]&&(U=LiteGraph$1.NODE_MODES_COLORS[l.mode]),LiteGraph$1.node_box_coloured_when_on&&(U=l.action_triggered?"#FFF":l.execute_triggered?"#AAA":U);const e=10;if(l.onDrawTitleBox?l.onDrawTitleBox(n,L,u,this.ds.scale):N==LiteGraph$1.ROUND_SHAPE||N==LiteGraph$1.CIRCLE_SHAPE||N==LiteGraph$1.CARD_SHAPE?(A&&(n.fillStyle="black",n.beginPath(),n.arc(L*.5,L*-.5,e*.5+1,0,Math.PI*2),n.fill()),n.fillStyle=l.boxcolor||U||LiteGraph$1.NODE_DEFAULT_BOXCOLOR,A?n.fillRect(L*.5-e*.5,L*-.5-e*.5,e,e):(n.beginPath(),n.arc(L*.5,L*-.5,e*.5,0,Math.PI*2),n.fill())):(A&&(n.fillStyle="black",n.fillRect((L-e)*.5-1,(L+e)*-.5-1,e+2,e+2)),n.fillStyle=l.boxcolor||U||LiteGraph$1.NODE_DEFAULT_BOXCOLOR,n.fillRect((L-e)*.5,(L+e)*-.5,e,e)),n.globalAlpha=F,l.onDrawTitleText&&l.onDrawTitleText(n,L,u,this.ds.scale,this.title_text_font,g),!A){n.font=this.title_text_font;const t=String(l.getTitle());t&&(g?n.fillStyle=LiteGraph$1.NODE_SELECTED_TITLE_COLOR:n.fillStyle=l.constructor.title_text_color||this.node_title_color,l.flags.collapsed?(n.textAlign="left",n.measureText(t),n.fillText(t.substr(0,20),L,LiteGraph$1.NODE_TITLE_TEXT_Y-L),n.textAlign="left"):(n.textAlign="left",n.fillText(t,L,LiteGraph$1.NODE_TITLE_TEXT_Y-L)))}if(!l.flags.collapsed&&l.subgraph&&!l.skip_subgraph_button){const t=LiteGraph$1.NODE_TITLE_HEIGHT,r=l.size[0]-t,s=LiteGraph$1.isInsideRectangle(this.graph_mouse[0]-l.pos[0],this.graph_mouse[1]-l.pos[1],r+2,-t+2,t-4,t-4);n.fillStyle=s?"#888":"#555",N==LiteGraph$1.BOX_SHAPE||A?n.fillRect(r+2,-t+2,t-4,t-4):(n.beginPath(),n.roundRect(r+2,-t+2,t-4,t-4,[4]),n.fill()),n.fillStyle="#333",n.beginPath(),n.moveTo(r+t*.2,-t*.6),n.lineTo(r+t*.8,-t*.6),n.lineTo(r+t*.5,-t*.3),n.fill()}l.onDrawTitle&&l.onDrawTitle(n)}g&&(l.onBounding&&l.onBounding(P),C==LiteGraph$1.TRANSPARENT_TITLE&&(P[1]-=L,P[3]+=L),n.lineWidth=1,n.globalAlpha=.8,n.beginPath(),N==LiteGraph$1.BOX_SHAPE?n.rect(-6+P[0],-6+P[1],12+P[2],12+P[3]):N==LiteGraph$1.ROUND_SHAPE||N==LiteGraph$1.CARD_SHAPE&&l.flags.collapsed?n.roundRect(-6+P[0],-6+P[1],12+P[2],12+P[3],[this.round_radius*2]):N==LiteGraph$1.CARD_SHAPE?n.roundRect(-6+P[0],-6+P[1],12+P[2],12+P[3],[this.round_radius*2,2,this.round_radius*2,2]):N==LiteGraph$1.CIRCLE_SHAPE&&n.arc(u[0]*.5,u[1]*.5,u[0]*.5+6,0,Math.PI*2),n.strokeStyle=LiteGraph$1.NODE_BOX_OUTLINE_COLOR,n.stroke(),n.strokeStyle=c,n.globalAlpha=1),l.execute_triggered>0&&l.execute_triggered--,l.action_triggered>0&&l.action_triggered--}drawConnections(l){const n=new Float32Array(4),u=new Float32Array(4),c=new Float32Array(2),d=new Float32Array(2),g=LiteGraph$1.getTime(),m=this.visible_area;n[0]=m[0]-20,n[1]=m[1]-20,n[2]=m[2]+40,n[3]=m[3]+40,l.lineWidth=this.connections_width,l.fillStyle="#AAA",l.strokeStyle="#AAA",l.globalAlpha=this.editor_alpha;const E=this.graph._nodes;for(let L=0,A=E.length;L<A;++L){const N=E[L];if(!(!N.inputs||!N.inputs.length))for(let C=0;C<N.inputs.length;++C){const R=N.inputs[C];if(!R||R.link==null)continue;const P=R.link,F=this.graph.links[P];if(!F)continue;const U=this.graph.getNodeById(F.origin_id);if(U==null)continue;let e=F.origin_slot,t=null;e==-1?t=[U.pos[0]+10,U.pos[1]+10]:t=U.getConnectionPos(!1,e,c);const r=N.getConnectionPos(!0,C,d);if(u[0]=t[0],u[1]=t[1],u[2]=r[0]-t[0],u[3]=r[1]-t[1],u[2]<0&&(u[0]+=u[2],u[2]=Math.abs(u[2])),u[3]<0&&(u[1]+=u[3],u[3]=Math.abs(u[3])),!LiteGraph$1.overlapBounding(u,n))continue;const s=U.outputs[e],a=N.inputs[C];if(!s||!a)continue;const o=s.dir||(U.horizontal?LiteGraph$1.DOWN:LiteGraph$1.RIGHT),h=a.dir||(N.horizontal?LiteGraph$1.UP:LiteGraph$1.LEFT);if(this.ALWAYS_FLOW)this.renderLink(l,t,r,F,!0,1,"white",o,h);else if(this.renderLink(l,t,r,F,!1,0,null,o,h),F&&F._last_time&&g-F._last_time<1e3){const f=2-(g-F._last_time)*.002,p=l.globalAlpha;l.globalAlpha=p*f,this.renderLink(l,t,r,F,!0,f,"white",o,h),l.globalAlpha=p}}}l.globalAlpha=1}showGrpPanel(l){this.closePanels();const n=this.getCanvasWindow(),u=this,c=this.createPanel(l.title||"",{closable:!0,window:n,onOpen:function(){u.NODEPANEL_IS_OPEN=!0},onClose:function(){u.NODEPANEL_IS_OPEN=!1,u.node_panel=null}});u.node_panel=c,c.id="node-panel",c.node=l,c.classList.add("settings");function d(){c.content.innerHTML="",c.addHTML("<h4></h4>","panel-section");const g=(m,E)=>{switch(u.graph.beforeChange(l),u.saveUndoStack(),m){case"Title":l.title=E;break;case"Color":_LGraphCanvas.node_colors[E]?l.color=_LGraphCanvas.node_colors[E].groupcolor:console.warn("unexpected color: "+E);break;case"X":l.move(parseInt(E)-l.pos[0],0);break;case"Y":l.move(0,parseInt(E)-l.pos[1]);break;case"":l.size[0]=parseInt(E);break;case"":l.size[1]=parseInt(E);break}u.graph.afterChange(),u.dirty_canvas=!0};c.addWidget("string","Title",l.title,{},g),l.id&&c.addWidget("string"," ",l.id,{},g),l.status&&c.addWidget("string","",l.status,{disabled:!0},g),c.addWidget("number","X",l.pos[0],{min:0},g),c.addWidget("number","Y",l.pos[1],{min:0},g),c.addWidget("number","",l.size[0],{min:0},g),c.addWidget("number","",l.size[1],{min:0},g),c.addSeparator()}d(),this.canvas.parentNode.appendChild(c)}drawGuideLines(l,{roundX:n,roundY:u,roundWidth:c,roundHeight:d,otherRoundX:g,otherRoundY:m,otherRoundWidth:E,otherRoundHeight:L}){E===c&&(l.beginPath(),l.moveTo(n,u-10),l.lineTo(n,u+d+10),l.stroke(),l.beginPath(),l.moveTo(n+ +c,u-10),l.lineTo(n+c,u+d+10),l.stroke(),l.beginPath(),l.moveTo(g,m-10),l.lineTo(g,m+L+10),l.stroke(),l.beginPath(),l.moveTo(g+E,m-10),l.lineTo(g+E,m+L+10),l.stroke()),L===d&&(l.beginPath(),l.moveTo(n-10,u),l.lineTo(n+c+10,u),l.stroke(),l.beginPath(),l.moveTo(n-10,u+d),l.lineTo(n+c+10,u+d),l.stroke(),l.beginPath(),l.moveTo(g-10,m),l.lineTo(g+E+10,m),l.stroke(),l.beginPath(),l.moveTo(g-10,m+L),l.lineTo(g+E+10,m+L),l.stroke()),g===n&&(u<m?(l.beginPath(),l.moveTo(n,u),l.lineTo(g,m+L),l.stroke()):(l.beginPath(),l.moveTo(g,m),l.lineTo(n,u+d),l.stroke())),g+E===n+c&&(u<m?(l.beginPath(),l.moveTo(n+c,u),l.lineTo(g+E,m+L),l.stroke()):(l.beginPath(),l.moveTo(g+E,m),l.lineTo(n+c,u+d),l.stroke())),m===u&&(n<g?(l.beginPath(),l.moveTo(n,u),l.lineTo(g+E,m),l.stroke()):(l.beginPath(),l.moveTo(g,m),l.lineTo(n+c,u),l.stroke())),m+L===u+d&&(n<g?(l.beginPath(),l.moveTo(n,u+d),l.lineTo(g+E,m+L),l.stroke()):(l.beginPath(),l.moveTo(g,m+L),l.lineTo(n+c,u+d),l.stroke()))}drawGroups(l,n){var c,d,g,m,E;if(!this.graph)return;const u=this.graph._groups;n.save(),n.globalAlpha=.5*this.editor_alpha;for(let L=0;L<u.length;++L){const A=u[L];if(!LiteGraph$1.overlapBounding(this.visible_area,A._bounding))continue;const N=A._pos,C=A._size,R=A.color||_LGraphCanvas.node_colors.black.groupcolor;n.fillStyle=R,n.globalAlpha=.75,n.beginPath();const P=10;n.fillStyle=R,n.beginPath(),n.moveTo(N[0]+P,N[1]),n.lineTo(N[0]+C[0]-P,N[1]),n.quadraticCurveTo(N[0]+C[0],N[1],N[0]+C[0],N[1]+P),n.lineTo(N[0]+C[0],N[1]+C[1]-P),n.quadraticCurveTo(N[0]+C[0],N[1]+C[1],N[0]+C[0]-P,N[1]+C[1]),n.lineTo(N[0]+P,N[1]+C[1]),n.quadraticCurveTo(N[0],N[1]+C[1],N[0],N[1]+C[1]-P),n.lineTo(N[0],N[1]+P),n.quadraticCurveTo(N[0],N[1],N[0]+P,N[1]),n.closePath(),n.fill(),this.read_only||(n.fillStyle="#0085FF",n.beginPath(),n.moveTo(N[0]+C[0]-7,N[1]+C[1]),n.lineTo(N[0]+C[0],N[1]+C[1]),n.lineTo(N[0]+C[0],N[1]+C[1]-7),n.closePath(),n.fill());const F=LiteGraph$1.DEFAULT_GROUP_FONT_SIZE||20,U=A.font_size||F;if(n.fillStyle="#ffffff",n.font="Bold "+U+"px Arial",n.textAlign="left",n.fillText(A.title,N[0]+12,N[1]+U+8),!this.read_only){const e=A.font_size*.6;n.font=`${e}px Arial`,n.fillStyle="#c6c6c6";const t=`x/y//: ${parseInt(A.pos[0])}/${parseInt(A.pos[1])}/${parseInt(A.size[0])}/${parseInt(A.size[1])}`;let r="";for(let s=0;s<t.length;s++){const a=r+t[s]+"";if(n.measureText(a).width>A.size[0]-30&&s>0){r=r.slice(0,r.length-2),r+=" ..";break}else r=a}n.fillText(r,N[0]+10,N[1]+A.size[1]-12)}if(this.selected_group&&(A==null?void 0:A.id)!==((c=this.selected_group)==null?void 0:c.id)&&!this.read_only){n.strokeStyle="#c4c4c4",n.lineWidth=1;const e=(d=this.selected_group)==null?void 0:d.size[0],t=(g=this.selected_group)==null?void 0:g.size[1],r=(m=this.selected_group)==null?void 0:m.pos[0],s=(E=this.selected_group)==null?void 0:E.pos[1],a=A.size[0],o=A.size[1],h=A.pos[0],f=A.pos[1],p=Math.round(r),T=Math.round(s),_=Math.round(e),S=Math.round(t),b=Math.round(h),M=Math.round(f),G=Math.round(a),O=Math.round(o);this.drawGuideLines(n,{roundX:p,roundY:T,roundWidth:_,roundHeight:S,otherRoundX:b,otherRoundY:M,otherRoundWidth:G,otherRoundHeight:O})}}n.restore()}scaleFit(){this.canvas&&(this.ds.scale=1,this.ds.max_scale=1,this.ds.min_scale=1,window.innerWidth>=3840&&(this.ds.scale=2,this.ds.max_scale=2,this.ds.min_scale=2))}renderLink(l,n,u,c,d,g,m,E,L,A){if(m="#3b3b3b",c){const R=this.graph.getNodeById(c.origin_id),P=this.graph.getNodeById(c.target_id),F=R.properties.status,U=P.properties.status,e=R.properties.resultIndex;typeof e=="number"&&c.origin_slot===e&&(F===1&&U===1?m="#34c38f":F===-1||U===-1?m="#f46a6a":(F===0||U===0)&&(m="#3b3b3b"))}c&&this.visible_links.push(c),!m&&c&&(m=c.color||_LGraphCanvas.link_type_colors[c.type]),m||(m=this.default_link_color),c!=null&&this.highlighted_links[c.id]&&(m="#FFF"),E=E||LiteGraph$1.RIGHT,L=L||LiteGraph$1.LEFT;const N=LiteGraph$1.distance(n,u);this.render_connections_border&&this.ds.scale>.6&&(l.lineWidth=this.connections_width+4),l.lineJoin="round",A=A||1,A>1&&(l.lineWidth=.5),l.beginPath();for(let R=0;R<A;R+=1){const P=(R-(A-1)*.5)*5;if(this.links_render_mode==LiteGraph$1.SPLINE_LINK){l.moveTo(n[0],n[1]+P);let F=0,U=0,e=0,t=0;switch(E){case LiteGraph$1.LEFT:F=N*-.25;break;case LiteGraph$1.RIGHT:F=N*.25;break;case LiteGraph$1.UP:U=N*-.25;break;case LiteGraph$1.DOWN:U=N*.25;break}switch(L){case LiteGraph$1.LEFT:e=N*-.25;break;case LiteGraph$1.RIGHT:e=N*.25;break;case LiteGraph$1.UP:t=N*-.25;break;case LiteGraph$1.DOWN:t=N*.25;break}l.bezierCurveTo(n[0]+F,n[1]+U+P,u[0]+e,u[1]+t+P,u[0],u[1]+P)}else if(this.links_render_mode==LiteGraph$1.LINEAR_LINK){l.moveTo(n[0],n[1]+P);let F=0,U=0,e=0,t=0;switch(E){case LiteGraph$1.LEFT:F=-1;break;case LiteGraph$1.RIGHT:F=1;break;case LiteGraph$1.UP:U=-1;break;case LiteGraph$1.DOWN:U=1;break}switch(L){case LiteGraph$1.LEFT:e=-1;break;case LiteGraph$1.RIGHT:e=1;break;case LiteGraph$1.UP:t=-1;break;case LiteGraph$1.DOWN:t=1;break}const r=15;l.lineTo(n[0]+F*r,n[1]+U*r+P),l.lineTo(u[0]+e*r,u[1]+t*r+P),l.lineTo(u[0],u[1]+P)}else if(this.links_render_mode==LiteGraph$1.STRAIGHT_LINK){l.moveTo(n[0],n[1]);let F=n[0],U=n[1],e=u[0],t=u[1];E==LiteGraph$1.RIGHT?F+=10:U+=10,L==LiteGraph$1.LEFT?e-=10:t-=10,l.lineTo(F,U),l.lineTo((F+e)*.5,U),l.lineTo((F+e)*.5,t),l.lineTo(e,t),l.lineTo(u[0],u[1])}else return}this.render_connections_border&&this.ds.scale>.6&&!d&&(l.strokeStyle="rgba(0,0,0,0.5)",l.stroke()),l.lineWidth=this.connections_width,l.fillStyle=l.strokeStyle=m,l.stroke();let C=this.computeConnectionPoint(n,u,.5,E,L);if(c&&c._pos&&(c._pos[0]=C[0],c._pos[1]=C[1]),this.ds.scale>=.6&&this.highquality_render&&L!=LiteGraph$1.CENTER&&!this.read_only){if(this.render_connection_arrows){const R=this.computeConnectionPoint(n,u,.25,E,L),P=this.computeConnectionPoint(n,u,.26,E,L),F=this.computeConnectionPoint(n,u,.75,E,L),U=this.computeConnectionPoint(n,u,.76,E,L);let e=0,t=0;this.render_curved_connections?(e=-Math.atan2(P[0]-R[0],P[1]-R[1]),t=-Math.atan2(U[0]-F[0],U[1]-F[1])):t=e=u[1]>n[1]?0:Math.PI,l.save(),l.translate(R[0],R[1]),l.rotate(e),l.beginPath(),l.moveTo(-5,-3),l.lineTo(0,7),l.lineTo(5,-3),l.fill(),l.restore(),l.save(),l.translate(F[0],F[1]),l.rotate(t),l.beginPath(),l.moveTo(-5,-3),l.lineTo(0,7),l.lineTo(5,-3),l.fill(),l.restore()}l.beginPath(),l.arc(C[0],C[1],5,0,Math.PI*2),l.fill()}if(g){l.fillStyle=m;for(let R=0;R<3;++R){let P=(LiteGraph$1.getTime()*2e-4+R*.2)%1;if(this.links_render_mode===LiteGraph$1.STRAIGHT_LINK){let F=n[0],U=n[1],e=u[0],t=u[1];E==LiteGraph$1.RIGHT?F+=10:E==LiteGraph$1.LEFT?F-=10:E==LiteGraph$1.DOWN?U+=10:E==LiteGraph$1.UP&&(U-=10),L==LiteGraph$1.LEFT?e-=10:L==LiteGraph$1.RIGHT?e+=10:L==LiteGraph$1.UP?t-=10:L==LiteGraph$1.DOWN&&(t+=10);const r=(F+e)*.5,s=Math.abs(r-F),a=Math.abs(t-U),o=Math.abs(e-r),h=s+a+o,f=P*h;let p=[F,U];if(f<=s)p=[F+f*(F<r?1:-1),U];else if(f<=s+a){const T=f-s;U<t?p=[r,U+T]:p=[r,U-T]}else if(f<=h){const T=f-(s+a);p=[r+T*(r<e?1:-1),t]}l.beginPath(),l.arc(p[0],p[1],5,0,2*Math.PI),l.fill()}else C=this.computeConnectionPoint(n,u,P,E,L);l.beginPath(),l.arc(C[0],C[1],5,0,2*Math.PI),l.fill()}}}computeConnectionPoint(l,n,u,c,d){c=c||LiteGraph$1.RIGHT,d=d||LiteGraph$1.LEFT;const g=LiteGraph$1.distance(l,n),m=l,E=[l[0],l[1]],L=[n[0],n[1]],A=n;switch(c){case LiteGraph$1.LEFT:E[0]+=g*-.25;break;case LiteGraph$1.RIGHT:E[0]+=g*.25;break;case LiteGraph$1.UP:E[1]+=g*-.25;break;case LiteGraph$1.DOWN:E[1]+=g*.25;break}switch(d){case LiteGraph$1.LEFT:L[0]+=g*-.25;break;case LiteGraph$1.RIGHT:L[0]+=g*.25;break;case LiteGraph$1.UP:L[1]+=g*-.25;break;case LiteGraph$1.DOWN:L[1]+=g*.25;break}const N=(1-u)*(1-u)*(1-u),C=3*((1-u)*(1-u))*u,R=3*(1-u)*(u*u),P=u*u*u,F=N*m[0]+C*E[0]+R*L[0]+P*A[0],U=N*m[1]+C*E[1]+R*L[1]+P*A[1];return[F,U]}drawExecutionOrder(l){l.shadowColor="transparent",l.globalAlpha=.25,l.textAlign="center",l.strokeStyle="white",l.globalAlpha=.75;const n=this.visible_nodes;for(let u=0;u<n.length;++u){const c=n[u];l.fillStyle="black",l.fillRect(c.pos[0]-LiteGraph$1.NODE_TITLE_HEIGHT,c.pos[1]-LiteGraph$1.NODE_TITLE_HEIGHT,LiteGraph$1.NODE_TITLE_HEIGHT,LiteGraph$1.NODE_TITLE_HEIGHT),c.order==0&&l.strokeRect(c.pos[0]-LiteGraph$1.NODE_TITLE_HEIGHT+.5,c.pos[1]-LiteGraph$1.NODE_TITLE_HEIGHT+.5,LiteGraph$1.NODE_TITLE_HEIGHT,LiteGraph$1.NODE_TITLE_HEIGHT),l.fillStyle="#FFF",l.fillText(c.order,c.pos[0]+LiteGraph$1.NODE_TITLE_HEIGHT*-.5,c.pos[1]-6)}l.globalAlpha=1}drawNodeWidgets(l,n,u,c){if(!l.widgets||!l.widgets.length)return 0;const d=l.size[0],g=l.widgets;n+=2;const m=LiteGraph$1.NODE_WIDGET_HEIGHT,E=this.ds.scale>.5;u.save(),u.globalAlpha=this.editor_alpha;const L=LiteGraph$1.WIDGET_OUTLINE_COLOR,A=LiteGraph$1.WIDGET_BGCOLOR,N=LiteGraph$1.WIDGET_TEXT_COLOR,C=LiteGraph$1.WIDGET_SECONDARY_TEXT_COLOR,R=15;for(let P=0;P<g.length;++P){let F=g[P],U=n;F.y&&(U=F.y),F.last_y=U,u.strokeStyle=L,u.fillStyle="#222",u.textAlign="left",F.disabled&&(u.globalAlpha*=.5);const e=F.width||d;let t=F.options.max-F.options.min,r=(F.value-F.options.min)/t;switch(F.type){case"button":F.clicked&&(u.fillStyle="#AAA",F.clicked=!1,this.dirty_canvas=!0),u.fillRect(R,U,e-R*2,m),E&&!F.disabled&&u.strokeRect(R,U,e-R*2,m),E&&(u.textAlign="center",u.fillStyle=N,u.fillText(F.label||F.name,e*.5,U+m*.7));break;case"toggle":if(u.textAlign="left",u.strokeStyle=L,u.fillStyle=A,u.beginPath(),E?u.roundRect(R,U,e-R*2,m,[m*.5]):u.rect(R,U,e-R*2,m),u.fill(),E&&!F.disabled&&u.stroke(),u.fillStyle=F.value?"#89A":"#333",u.beginPath(),u.arc(e-R*2,U+m*.5,m*.36,0,Math.PI*2),u.fill(),E){u.fillStyle=C;const s=F.label||F.name;s!=null&&u.fillText(s,R*2,U+m*.7),u.fillStyle=F.value?N:C,u.textAlign="right",u.fillText(F.value?F.options.on||"true":F.options.off||"false",e-40,U+m*.7)}break;case"slider":if(u.fillStyle=A,u.fillRect(R,U,e-R*2,m),r<0&&(r=0),r>1&&(r=1),u.fillStyle=Object.prototype.hasOwnProperty.call(F.options,"slider_color")?F.options.slider_color:c==F?"#89A":"#678",u.fillRect(R,U,r*(e-R*2),m),E&&!F.disabled&&u.strokeRect(R,U,e-R*2,m),F.marker){let s=(F.marker-F.options.min)/t;s<0&&(s=0),s>1&&(s=1),u.fillStyle=Object.prototype.hasOwnProperty.call(F.options,"marker_color")?F.options.marker_color:"#AA9",u.fillRect(R+s*(e-R*2),U,2,m)}E&&(u.textAlign="center",u.fillStyle=N,u.fillText(F.label||F.name+"  "+Number(F.value).toFixed(F.options.precision!=null?F.options.precision:3),e*.5,U+m*.7));break;case"number":case"combo":if(u.textAlign="left",u.strokeStyle=L,u.fillStyle=A,u.beginPath(),E?u.roundRect(R,U,e-R*2,m,[m*.5]):u.rect(R,U,e-R*2,m),u.fill(),E)if(F.disabled||u.stroke(),u.fillStyle=N,F.disabled||(u.beginPath(),u.moveTo(R+16,U+5),u.lineTo(R+6,U+m*.5),u.lineTo(R+16,U+m-5),u.fill(),u.beginPath(),u.moveTo(e-R-16,U+5),u.lineTo(e-R-6,U+m*.5),u.lineTo(e-R-16,U+m-5),u.fill()),u.fillStyle=C,u.fillText(F.label||F.name,R*2+5,U+m*.7),u.fillStyle=N,u.textAlign="right",F.type=="number")u.fillText(Number(F.value).toFixed(F.options.precision!==void 0?F.options.precision:3),e-R*2-20,U+m*.7);else{let s=F.value;if(F.options.values){let a=F.options.values;a.constructor===Function&&(a=a()),a&&a.constructor!==Array&&(s=a[F.value])}u.fillText(s,e-R*2-20,U+m*.7)}break;case"string":case"text":if(u.textAlign="left",u.strokeStyle=L,u.fillStyle=A,u.beginPath(),E?u.roundRect(R,U,e-R*2,m,[m*.5]):u.rect(R,U,e-R*2,m),u.fill(),E){F.disabled||u.stroke(),u.save(),u.beginPath(),u.rect(R,U,e-R*2,m),u.clip(),u.fillStyle=C;const s=F.label||F.name;s!=null&&u.fillText(s,R*2,U+m*.7),u.fillStyle=N,u.textAlign="right",u.fillText(String(F.value).substr(0,30),e-R*2,U+m*.7),u.restore()}break;default:F.draw&&F.draw(u,l,e,U,m);break}n+=(F.computeSize?F.computeSize(e)[1]:m)+4,u.globalAlpha=this.editor_alpha}u.restore(),u.textAlign="left"}processNodeWidgets(node,pos,event,active_widget){if(!node.widgets||!node.widgets.length||!this.allow_interaction&&!node.flags.allow_interaction)return null;const x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow();for(let i=0;i<node.widgets.length;++i){const w=node.widgets[i];if(!w||w.disabled)continue;const widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph$1.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(w!=active_widget&&(x<6||x>widget_width-12||y<w.last_y||y>w.last_y+widget_height||w.last_y===void 0))continue;const old_value=w.value;let _old_value=w.value,nvalue=clamp((x-15)/(widget_width-30),0,1);switch(w.type){case"button":event.type===LiteGraph$1.pointerevents_method+"down"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":if(w.options.read_only)break;w.value=w.options.min+(w.options.max-w.options.min)*nvalue,_old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value)},20),this.dirty_canvas=!0;break;case"number":case"combo":if(event.type==LiteGraph$1.pointerevents_method+"move"&&w.type=="number")deltaX&&(w.value+=deltaX*.1*(w.options.step||1)),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(event.type==LiteGraph$1.pointerevents_method+"down"){let l=w.options.values;l&&l.constructor===Function&&(l=w.options.values(w,node));let n=null;w.type!="number"&&(n=l.constructor===Array?l:Object.keys(l));const u=x<40?-1:x>widget_width-40?1:0;if(w.type=="number")w.value+=u*.1*(w.options.step||1),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(u){let c=-1;this.last_mouseclick=0,l.constructor===Object?c=n.indexOf(String(w.value))+u:c=n.indexOf(w.value)+u,c>=n.length&&(c=n.length-1),c<0&&(c=0),l.constructor===Array?w.value=l[c]:w.value=c}else{let d=function(g,m,E){return l!=n&&(g=c.indexOf(g)),this.value=g,inner_value_change(this,g),that.dirty_canvas=!0,!1};const c=l!=n?Object.values(l):l;new LiteGraph$1.ContextMenu(c,{scale:Math.max(1,this.ds.scale),event,className:"dark",callback:d.bind(w)},ref_window)}}else if(event.type==LiteGraph$1.pointerevents_method+"up"&&w.type=="number"){const delta=x<40?-1:x>widget_width-40?1:0;event.click_time<200&&delta==0&&this.prompt("Value",w.value,(function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(l){}this.value=Number(v),inner_value_change(this,this.value)}).bind(w),event)}old_value!=w.value&&setTimeout((function(){inner_value_change(this,this.value)}).bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph$1.pointerevents_method+"down"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type==LiteGraph$1.pointerevents_method+"down"&&this.prompt("Value",w.value,(function(l){inner_value_change(this,l)}).bind(w),event,w.options?w.options.multiline:!1);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node));break}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),w}function inner_value_change(l,n){l.type=="number"&&(n=Number(n)),l.value=n,l.options&&l.options.property&&node.properties[l.options.property]!==void 0&&node.setProperty(l.options.property,n),l.callback&&l.callback(l.value,that,node,pos,event)}return null}adjustNodesSize(){const l=this.graph._nodes;for(let n=0;n<l.length;++n)l[n].size=l[n].computeSize();this.setDirty(!0,!0)}resize(l,n){if(!l&&!n){const u=this.canvas.parentNode;l=u.offsetWidth,n=u.offsetHeight}this.canvas.width==l&&this.canvas.height==n||(this.canvas.width=l,this.canvas.height=n,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}switchLiveMode(l){if(!l){this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;return}const n=this,u=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);const c=setInterval(function(){n.editor_alpha*=u,n.dirty_canvas=!0,n.dirty_bgcanvas=!0,u<1&&n.editor_alpha<.01&&(clearInterval(c),u<1&&(n.live_mode=!0)),u>1&&n.editor_alpha>.99&&(clearInterval(c),n.editor_alpha=1)},1)}onNodeSelectionChange(l){}static onGroupAdd(l,n,u){const c=_LGraphCanvas.active_canvas;c.getCanvasWindow();const d=new LiteGraph$1.LGraphGroup;d.pos=c.convertEventToCanvasOffset(u),c.graph.add(d)}static getBoundaryNodes(l){let n=null,u=null,c=null,d=null;for(const g in l){const m=l[g],[E,L]=m.pos,[A,N]=m.size;(n===null||L<n.pos[1])&&(n=m),(u===null||E+A>u.pos[0]+u.size[0])&&(u=m),(c===null||L+N>c.pos[1]+c.size[1])&&(c=m),(d===null||E<d.pos[0])&&(d=m)}return{top:n,right:u,bottom:c,left:d}}boundaryNodesForSelection(){return _LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))}static alignNodes(l,n,u){if(!l)return;const c=_LGraphCanvas.active_canvas;let d=[];u===void 0?d=_LGraphCanvas.getBoundaryNodes(l):d={top:u,right:u,bottom:u,left:u};for(const[g,m]of Object.entries(c.selected_nodes))switch(n){case"right":m.pos[0]=d.right.pos[0]+d.right.size[0]-m.size[0];break;case"left":m.pos[0]=d.left.pos[0];break;case"top":m.pos[1]=d.top.pos[1];break;case"bottom":m.pos[1]=d.bottom.pos[1]+d.bottom.size[1]-m.size[1];break}c.dirty_canvas=!0,c.dirty_bgcanvas=!0}static onNodeAlign(l,n,u,c,d){new LiteGraph$1.ContextMenu(["Top","Bottom","Left","Right"],{event:u,callback:g,parentMenu:c});function g(m){_LGraphCanvas.alignNodes(_LGraphCanvas.active_canvas.selected_nodes,m.toLowerCase(),d)}}static onGroupAlign(l,n,u,c){new LiteGraph$1.ContextMenu(["Top","Bottom","Left","Right"],{event:u,callback:d,parentMenu:c});function d(g){_LGraphCanvas.alignNodes(_LGraphCanvas.active_canvas.selected_nodes,g.toLowerCase())}}static onMenuAdd(l,n,u,c,d){const g=_LGraphCanvas.active_canvas,m=g.getCanvasWindow(),E=g.graph;if(!E)return;function L(A,N){const C=LiteGraph$1.getNodeTypesCategories(g.filter||E.filter).filter(function(F){return F.startsWith(A)}),R=[];C.map(function(F){if(!F)return;const U=new RegExp("^("+A+")"),e=F.replace(U,"").split("/")[0],t=A===""?e+"/":A+e+"/";let r=e;r.indexOf("::")!=-1&&(r=r.split("::")[1]),R.findIndex(function(a){return a.value===t})===-1&&R.push({value:t,content:r,has_submenu:!0,callback:function(a,o,h,f){L(a.value,f)}})}),LiteGraph$1.getNodeTypesInCategory(A.slice(0,-1),g.filter||E.filter).map(function(F){if(F.skip_list)return;const U={value:F.type,content:F.title,has_submenu:!1,callback:function(e,t,r,s){const a=s.getFirstEvent();g.graph.beforeChange();const o=LiteGraph$1.createNode(e.value);o&&(o.pos=g.convertEventToCanvasOffset(a),g.graph.add(o)),d&&d(o),g.graph.afterChange()}};R.push(U)}),new LiteGraph$1.ContextMenu(R,{event:u,parentMenu:N},m)}return L("",c),!1}static onMenuCollapseAll(){}static onMenuNodeEdit(){}static showMenuNodeOptionalInputs(l,n,u,c,d){if(!d)return;const g=this,E=_LGraphCanvas.active_canvas.getCanvasWindow();let L=d.optional_inputs;d.onGetInputs&&(L=d.onGetInputs());let A=[];if(L)for(let C=0;C<L.length;C++){const R=L[C];if(!R){A.push(null);continue}let P=R[0];R[2]||(R[2]={}),R[2].label&&(P=R[2].label),R[2].removable=!0;const F={content:P,value:R};R[1]==LiteGraph$1.ACTION&&(F.className="event"),A.push(F)}if(d.onMenuNodeInputs){const C=d.onMenuNodeInputs(A);C&&(A=C)}if(!A.length){console.log("no input entries");return}new LiteGraph$1.ContextMenu(A,{event:u,callback:N,parentMenu:c,node:d},E);function N(C,R,P){d&&(C.callback&&C.callback.call(g,d,C,R,P),C.value&&(d.graph.beforeChange(),d.addInput(C.value[0],C.value[1],C.value[2]),d.onNodeInputAdd&&d.onNodeInputAdd(C.value),d.setDirtyCanvas(!0,!0),d.graph.afterChange()))}return!1}static showMenuNodeOptionalOutputs(l,n,u,c,d){if(!d)return;const g=this,E=_LGraphCanvas.active_canvas.getCanvasWindow();let L=d.optional_outputs;d.onGetOutputs&&(L=d.onGetOutputs());let A=[];if(L)for(let C=0;C<L.length;C++){const R=L[C];if(!R){A.push(null);continue}if(d.flags&&d.flags.skip_repeated_outputs&&d.findOutputSlot(R[0])!=-1)continue;let P=R[0];R[2]||(R[2]={}),R[2].label&&(P=R[2].label),R[2].removable=!0;const F={content:P,value:R};R[1]==LiteGraph$1.EVENT&&(F.className="event"),A.push(F)}if(this.onMenuNodeOutputs&&(A=this.onMenuNodeOutputs(A)),LiteGraph$1.do_add_triggers_slots&&d.findOutputSlot("onExecuted")==-1&&A.push({content:"On Executed",value:["onExecuted",LiteGraph$1.EVENT,{nameLocked:!0}],className:"event"}),d.onMenuNodeOutputs){const C=d.onMenuNodeOutputs(A);C&&(A=C)}if(!A.length)return;new LiteGraph$1.ContextMenu(A,{event:u,callback:N,parentMenu:c,node:d},E);function N(C,R,P){if(!d||(C.callback&&C.callback.call(g,d,C,R,P),!C.value))return;const F=C.value[1];if(F&&(F.constructor===Object||F.constructor===Array)){const U=[];for(const e in F)U.push({content:e,value:F[e]});return new LiteGraph$1.ContextMenu(U,{event:R,callback:N,parentMenu:c,node:d}),!1}else d.graph.beforeChange(),d.addOutput(C.value[0],C.value[1],C.value[2]),d.onNodeOutputAdd&&d.onNodeOutputAdd(C.value),d.setDirtyCanvas(!0,!0),d.graph.afterChange()}return!1}static onShowMenuNodeProperties(l,n,u,c,d){if(!d||!d.properties)return;const g=_LGraphCanvas.active_canvas,m=g.getCanvasWindow(),E=[];for(const A in d.properties){let N=d.properties[A]!==void 0?d.properties[A]:" ";typeof N=="object"&&(N=JSON.stringify(N));const C=d.getPropertyInfo(A);(C.type=="enum"||C.type=="combo")&&(N=_LGraphCanvas.getPropertyPrintableValue(N,C.values)),N=_LGraphCanvas.decodeHTML(N),E.push({content:"<span class='property_name'>"+(C.label?C.label:A)+"</span><span class='property_value'>"+N+"</span>",value:A})}if(!E.length)return;new LiteGraph$1.ContextMenu(E,{event:u,callback:L,parentMenu:c,allow_html:!0,node:d},m);function L(A,N,C,R){if(!d)return;const P=this.getBoundingClientRect();g.showEditPropertyValue(d,A.value,{position:[P.left,P.top]})}return!1}static decodeHTML(l){const n=document.createElement("div");return n.innerText=l,n.innerHTML}static onMenuResizeNode(l,n,u,c,d){if(!d)return;const g=function(E){E.size=E.computeSize(),E.onResize&&E.onResize(E.size)},m=_LGraphCanvas.active_canvas;if(!m.selected_nodes||Object.keys(m.selected_nodes).length<=1)g(d);else for(const E in m.selected_nodes)g(m.selected_nodes[E]);d.setDirtyCanvas(!0,!0)}static showLinkMenu(l,n){const u=this,c=u.graph.getNodeById(l.origin_id),d=u.graph.getNodeById(l.target_id);let g=!1;c&&c.outputs&&c.outputs[l.origin_slot]&&(g=c.outputs[l.origin_slot].type);let m=!1;d&&d.outputs&&d.outputs[l.target_slot]&&(m=d.inputs[l.target_slot].type);const E=["Add Node",null,"Delete",null],L=new LiteGraph$1.ContextMenu(E,{event:n,title:l.data!=null?l.data.constructor.name:null,callback:A});function A(N,C,R){switch(N){case"Add Node":_LGraphCanvas.onMenuAdd(null,null,R,L,function(P){!P.inputs||!P.inputs.length||!P.outputs||!P.outputs.length||c.connectByType(l.origin_slot,P,g)&&(P.connectByType(l.target_slot,d,m),P.pos[0]-=P.size[0]*.5)});break;case"Delete":u.graph.removeLink(l.id);break}}return!1}createDefaultNodeForSlot(l){const u=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},l||{}),c=this,d=u.nodeFrom&&u.slotFrom!==null,g=!d&&u.nodeTo&&u.slotTo!==null;if(!d&&!g)return console.warn("No data passed to createDefaultNodeForSlot "+u.nodeFrom+" "+u.slotFrom+" "+u.nodeTo+" "+u.slotTo),!1;if(!u.nodeType)return console.warn("No type to createDefaultNodeForSlot"),!1;const m=d?u.nodeFrom:u.nodeTo;let E=d?u.slotFrom:u.slotTo,L=!1;switch(typeof E){case"string":L=d?m.findOutputSlot(E,!1):m.findInputSlot(E,!1),E=d?m.outputs[E]:m.inputs[E];break;case"object":L=d?m.findOutputSlot(E.name):m.findInputSlot(E.name);break;case"number":L=E,E=d?m.outputs[E]:m.inputs[E];break;case"undefined":default:return console.warn("Cant get slot information "+E),!1}(E===!1||L===!1)&&console.warn("createDefaultNodeForSlot bad slotX "+E+" "+L);const A=E.type==LiteGraph$1.EVENT?"_event_":E.type,N=d?LiteGraph$1.slot_types_default_out:LiteGraph$1.slot_types_default_in;if(N&&N[A]){E.link;let C=!1;if(typeof N[A]=="object"||Array.isArray(N[A])){for(const R in N[A])if(u.nodeType==N[A][R]||u.nodeType=="AUTO"){C=N[A][R];break}}else(u.nodeType==N[A]||u.nodeType=="AUTO")&&(C=N[A]);if(C){let R=!1;typeof C=="object"&&C.node&&(R=C,C=C.node);const P=LiteGraph$1.createNode(C);if(P){if(R){if(R.properties)for(const F in R.properties)P.addProperty(F,R.properties[F]);if(R.inputs){P.inputs=[];for(const F in R.inputs)P.addOutput(R.inputs[F][0],R.inputs[F][1])}if(R.outputs){P.outputs=[];for(const F in R.outputs)P.addOutput(R.outputs[F][0],R.outputs[F][1])}R.title&&(P.title=R.title),R.json&&P.configure(R.json)}return c.graph.add(P),P.pos=[u.position[0]+u.posAdd[0]+(u.posSizeFix[0]?u.posSizeFix[0]*P.size[0]:0),u.position[1]+u.posAdd[1]+(u.posSizeFix[1]?u.posSizeFix[1]*P.size[1]:0)],d?u.nodeFrom.connectByType(L,P,A):u.nodeTo.connectByTypeOutput(L,P,A),!0}else console.log("failed creating "+C)}}return!1}showConnectionMenu(l){const u=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},l||{}),c=this,d=u.nodeFrom&&u.slotFrom,g=!d&&u.nodeTo&&u.slotTo;if(!d&&!g)return console.warn("No data passed to showConnectionMenu"),!1;const m=d?u.nodeFrom:u.nodeTo;let E=d?u.slotFrom:u.slotTo,L=!1;switch(typeof E){case"string":L=d?m.findOutputSlot(E,!1):m.findInputSlot(E,!1),E=d?m.outputs[E]:m.inputs[E];break;case"object":L=d?m.findOutputSlot(E.name):m.findInputSlot(E.name);break;case"number":L=E,E=d?m.outputs[E]:m.inputs[E];break;default:return console.warn("Cant get slot information "+E),!1}const A=["Add Node",null];c.allow_searchbox&&(A.push("Search"),A.push(null));const N=E.type==LiteGraph$1.EVENT?"_event_":E.type,C=d?LiteGraph$1.slot_types_default_out:LiteGraph$1.slot_types_default_in;if(C&&C[N])if(typeof C[N]=="object"||Array.isArray(C[N]))for(const F in C[N])A.push(C[N][F]);else A.push(C[N]);const R=new LiteGraph$1.ContextMenu(A,{event:u.e,title:(E&&E.name!=""?E.name+(N?" | ":""):"")+(E&&N?N:""),callback:P});function P(F,U,e){switch(c.createDefaultNodeForSlot(Object.assign(u,{position:[u.e.canvasX,u.e.canvasY],nodeType:F})),F){case"Add Node":_LGraphCanvas.onMenuAdd(null,null,e,R,function(t){d?u.nodeFrom.connectByType(L,t,N):u.nodeTo.connectByTypeOutput(L,t,N)});break;case"Search":d?c.showSearchBox(e,{node_from:u.nodeFrom,slot_from:E,type_filter_in:N}):c.showSearchBox(e,{node_to:u.nodeTo,slot_from:E,type_filter_out:N});break}}return!1}static onShowPropertyEditor(l,n,u,c,d){const g=l.property||"title",m=d[g],E=document.createElement("div");E.is_modified=!1,E.className="graphdialog",E.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",E.close=function(){E.parentNode&&E.parentNode.removeChild(E)};const L=E.querySelector(".name");L.innerText=g;let A=E.querySelector(".value");A&&(A.value=m,A.addEventListener("blur",function(s){this.focus()}),A.addEventListener("keydown",function(s){if(E.is_modified=!0,s.keyCode==27)E.close();else if(s.keyCode==13)t();else if(s.keyCode!=13&&s.target.localName!="textarea")return;s.preventDefault(),s.stopPropagation()}));const C=_LGraphCanvas.active_canvas.canvas,R=C.getBoundingClientRect();let P=-20,F=-20;R&&(P-=R.left,F-=R.top),event?(E.style.left=event.clientX+P+"px",E.style.top=event.clientY+F+"px"):(E.style.left=C.width*.5+P+"px",E.style.top=C.height*.5+F+"px"),E.querySelector("button").addEventListener("click",t),C.parentNode.appendChild(E),A&&A.focus();let e=null;E.addEventListener("mouseleave",function(s){LiteGraph$1.dialog_close_on_mouse_leave&&!E.is_modified&&LiteGraph$1.dialog_close_on_mouse_leave&&(e=setTimeout(E.close,LiteGraph$1.dialog_close_on_mouse_leave_delay))}),E.addEventListener("mouseenter",function(s){LiteGraph$1.dialog_close_on_mouse_leave&&e&&clearTimeout(e)});function t(){A&&r(A.value)}function r(s){l.type=="Number"?s=Number(s):l.type=="Boolean"&&(s=!!s),d[g]=s,E.parentNode&&E.parentNode.removeChild(E),d.setDirtyCanvas(!0,!0)}}prompt(l,n,u,c,d){const g=this;l=l||"";const m=document.createElement("div");m.is_modified=!1,m.className="graphdialog rounded",d?m.innerHTML="<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":m.innerHTML="<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",m.close=function(){g.prompt_box=null,m.parentNode&&m.parentNode.removeChild(m)};const L=_LGraphCanvas.active_canvas.canvas;L.parentNode.appendChild(m),this.ds.scale>1&&(m.style.transform="scale("+this.ds.scale+")");let A=null,N=!1;LiteGraph$1.pointerListenerAdd(m,"leave",function(s){N||LiteGraph$1.dialog_close_on_mouse_leave&&!m.is_modified&&LiteGraph$1.dialog_close_on_mouse_leave&&(A=setTimeout(m.close,LiteGraph$1.dialog_close_on_mouse_leave_delay))}),LiteGraph$1.pointerListenerAdd(m,"enter",function(s){LiteGraph$1.dialog_close_on_mouse_leave&&A&&clearTimeout(A)});const C=m.querySelectorAll("select");C&&C.forEach(function(s){s.addEventListener("click",function(a){N++}),s.addEventListener("blur",function(a){N=0}),s.addEventListener("change",function(a){N=-1})}),g.prompt_box&&g.prompt_box.close(),g.prompt_box=m;const R=m.querySelector(".name");R.innerText=l;const P=m.querySelector(".value");P.value=n;const F=P;F.addEventListener("keydown",function(s){if(m.is_modified=!0,s.keyCode==27)m.close();else if(s.keyCode==13&&s.target.localName!="textarea")u&&u(this.value),m.close();else return;s.preventDefault(),s.stopPropagation()}),m.querySelector("button").addEventListener("click",function(s){u&&u(F.value),g.setDirty(!0),m.close()});const e=L.getBoundingClientRect();let t=-20,r=-20;return e&&(t-=e.left,r-=e.top),c?(m.style.left=c.clientX+t+"px",m.style.top=c.clientY+r+"px"):(m.style.left=L.width*.5+t+"px",m.style.top=L.height*.5+r+"px"),setTimeout(function(){F.focus()},10),m}showSearchBox(l,n){const u={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph$1.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph$1.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph$1.search_show_all_on_open};n=Object.assign(u,n||{});const c=this,d=_LGraphCanvas.active_canvas,g=d.canvas,m=g.ownerDocument||document,E=document.createElement("div");E.className="litegraph litesearchbox graphdialog rounded",E.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",n.do_type_filter&&(E.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",E.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),E.innerHTML+="<div class='helper'></div>",m.fullscreenElement?m.fullscreenElement.appendChild(E):(m.body.appendChild(E),m.body.style.overflow="hidden");let L,A;if(n.do_type_filter&&(L=E.querySelector(".slot_in_type_filter"),A=E.querySelector(".slot_out_type_filter")),E.close=function(){c.search_box=null,this.blur(),g.focus(),m.body.style.overflow="",setTimeout(function(){c.canvas.focus()},20),E.parentNode&&E.parentNode.removeChild(E)},this.ds.scale>1&&(E.style.transform="scale("+this.ds.scale+")"),n.hide_on_mouse_leave){let o=!1,h=null;LiteGraph$1.pointerListenerAdd(E,"enter",function(f){h&&(clearTimeout(h),h=null)}),LiteGraph$1.pointerListenerAdd(E,"leave",function(f){o||(h=setTimeout(function(){E.close()},500))}),n.do_type_filter&&(L.addEventListener("click",function(f){o++}),L.addEventListener("blur",function(f){o=0}),L.addEventListener("change",function(f){o=-1}),A.addEventListener("click",function(f){o++}),A.addEventListener("blur",function(f){o=0}),A.addEventListener("change",function(f){o=-1}))}c.search_box&&c.search_box.close(),c.search_box=E;const N=E.querySelector(".helper");let C=null,R=null,P=null,F=E.querySelector("input");if(F&&(F.addEventListener("blur",function(o){c.search_box&&this.focus()}),F.addEventListener("keydown",function(o){if(o.keyCode==38)s(!1);else if(o.keyCode==40)s(!0);else if(o.keyCode==27)E.close();else if(o.keyCode==13)a(),P?r(P.innerHTML):C?r(C):E.close();else{R&&clearInterval(R),R=setTimeout(a,250);return}return o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation(),!0})),n.do_type_filter){if(L){const o=LiteGraph$1.slot_types_in,h=o.length;(n.type_filter_in==LiteGraph$1.EVENT||n.type_filter_in==LiteGraph$1.ACTION)&&(n.type_filter_in="_event_");for(let f=0;f<h;f++){const p=document.createElement("option");p.value=o[f],p.innerHTML=o[f],L.appendChild(p),n.type_filter_in!==!1&&(n.type_filter_in+"").toLowerCase()==(o[f]+"").toLowerCase()&&(p.selected=!0)}L.addEventListener("change",function(){a()})}if(A){const o=LiteGraph$1.slot_types_out,h=o.length;(n.type_filter_out==LiteGraph$1.EVENT||n.type_filter_out==LiteGraph$1.ACTION)&&(n.type_filter_out="_event_");for(let f=0;f<h;f++){const p=document.createElement("option");p.value=o[f],p.innerHTML=o[f],A.appendChild(p),n.type_filter_out!==!1&&(n.type_filter_out+"").toLowerCase()==(o[f]+"").toLowerCase()&&(p.selected=!0)}A.addEventListener("change",function(){a()})}}const U=g.getBoundingClientRect(),e=(l?l.clientX:U.left+U.width*.5)-80,t=(l?l.clientY:U.top+U.height*.5)-20;E.style.left=e+"px",E.style.top=t+"px",l.layerY>U.height-200&&(N.style.maxHeight=U.height-l.layerY-20+"px"),F.focus(),n.show_all_on_open&&a();function r(o){if(o)if(c.onSearchBoxSelection)c.onSearchBoxSelection(o,l,d);else{const h=LiteGraph$1.searchbox_extras[o.toLowerCase()];h&&(o=h.type),d.graph.beforeChange();const f=LiteGraph$1.createNode(o);if(f&&(f.pos=d.convertEventToCanvasOffset(l),d.graph.add(f,!1)),h&&h.data){if(h.data.properties)for(const p in h.data.properties)f.addProperty(p,h.data.properties[p]);if(h.data.inputs){f.inputs=[];for(const p in h.data.inputs)f.addOutput(h.data.inputs[p][0],h.data.inputs[p][1])}if(h.data.outputs){f.outputs=[];for(const p in h.data.outputs)f.addOutput(h.data.outputs[p][0],h.data.outputs[p][1])}h.data.title&&(f.title=h.data.title),h.data.json&&f.configure(h.data.json)}if(n.node_from){let p=!1;switch(typeof n.slot_from){case"string":p=n.node_from.findOutputSlot(n.slot_from);break;case"object":n.slot_from.name?p=n.node_from.findOutputSlot(n.slot_from.name):p=-1,p==-1&&typeof n.slot_from.slot_index<"u"&&(p=n.slot_from.slot_index);break;case"number":p=n.slot_from;break;default:p=0}typeof n.node_from.outputs[p]<"u"&&p!==!1&&p>-1&&n.node_from.connectByType(p,f,n.node_from.outputs[p].type)}if(n.node_to){let p=!1;switch(typeof n.slot_from){case"string":p=n.node_to.findInputSlot(n.slot_from);break;case"object":n.slot_from.name?p=n.node_to.findInputSlot(n.slot_from.name):p=-1,p==-1&&typeof n.slot_from.slot_index<"u"&&(p=n.slot_from.slot_index);break;case"number":p=n.slot_from;break;default:p=0}typeof n.node_to.inputs[p]<"u"&&p!==!1&&p>-1&&n.node_to.connectByTypeOutput(p,f,n.node_to.inputs[p].type)}d.graph.afterChange()}E.close()}function s(o){const h=P;P&&P.classList.remove("selected"),P?(P=o?P.nextSibling:P.previousSibling,P||(P=h)):P=o?N.childNodes[0]:N.childNodes[N.childNodes.length],P&&(P.classList.add("selected"),P.scrollIntoView({block:"end",behavior:"smooth"}))}function a(){R=null;let o=F.value;if(C=null,N.innerHTML="",!o&&!n.show_all_if_empty)return;if(c.onSearchBox){const f=c.onSearchBox(N,o,d);if(f)for(let p=0;p<f.length;++p)h(f[p])}else{let S=function(b,M){const B=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},M||{}),H=LiteGraph$1.registered_node_types[b];if(f&&H.filter!=f||(!n.show_all_if_empty||o)&&b.toLowerCase().indexOf(o)===-1)return!1;if(n.do_type_filter&&!B.skipFilter){const z=b;let k=p.value;if(B.inTypeOverride!==!1&&(k=B.inTypeOverride),p&&k&&LiteGraph$1.registered_slot_in_types[k]&&LiteGraph$1.registered_slot_in_types[k].nodes&&LiteGraph$1.registered_slot_in_types[k].nodes.includes(z)===!1)return!1;let X=T.value;if(B.outTypeOverride!==!1&&(X=B.outTypeOverride),T&&X&&LiteGraph$1.registered_slot_out_types[X]&&LiteGraph$1.registered_slot_out_types[X].nodes&&LiteGraph$1.registered_slot_out_types[X].nodes.includes(z)===!1)return!1}return!0};o=o.toLowerCase();const f=d.filter||d.graph.filter;let p=null,T=null;n.do_type_filter&&c.search_box?(p=c.search_box.querySelector(".slot_in_type_filter"),T=c.search_box.querySelector(".slot_out_type_filter")):(p=!1,T=!1);for(const b in LiteGraph$1.searchbox_extras){const M=LiteGraph$1.searchbox_extras[b];if((!n.show_all_if_empty||o)&&M.desc.toLowerCase().indexOf(o)===-1)continue;const G=LiteGraph$1.registered_node_types[M.type];G&&G.filter!=f||S(M.type)&&h(M.desc,"searchbox_extra")}let _=null;if(Array.prototype.filter)_=Object.keys(LiteGraph$1.registered_node_types).filter(S);else{_=[];for(const b in LiteGraph$1.registered_node_types)S(b)&&_.push(b)}for(let b=0;b<_.length;b++)h(_[b]);if(n.show_general_after_typefiltered&&(p.value||T.value)){const b=[];for(const M in LiteGraph$1.registered_node_types)S(M,{inTypeOverride:p&&p.value?"*":!1,outTypeOverride:T&&T.value?"*":!1})&&b.push(M);for(let M=0;M<b.length;M++)h(b[M],"generic_type")}if((p.value||T.value)&&N.childNodes.length==0&&n.show_general_if_none_on_typefilter){const b=[];for(const M in LiteGraph$1.registered_node_types)S(M,{skipFilter:!0})&&b.push(M);for(let M=0;M<b.length;M++)h(b[M],"not_in_filter")}}function h(f,p){const T=document.createElement("div");C||(C=f),T.innerText=f,T.dataset.type=escape(f),T.className="litegraph lite-search-item",p&&(T.className+=" "+p),T.addEventListener("click",function(_){r(unescape(this.dataset.type))}),N.appendChild(T)}}return E}showEditPropertyValue(l,n,u){if(!l||l.properties[n]===void 0)return;u=u||{};const c=l.getPropertyInfo(n),d=c.type;let g="";if(d=="string"||d=="number"||d=="array"||d=="object")g="<input autofocus type='text' class='value'/>";else if((d=="enum"||d=="combo")&&c.values){g="<select autofocus type='text' class='value'>";for(const C in c.values){let R=C;c.values.constructor===Array&&(R=c.values[C]),g+="<option value='"+R+"' "+(R==l.properties[n]?"selected":"")+">"+c.values[C]+"</option>"}g+="</select>"}else if(d=="boolean"||d=="toggle")g="<input autofocus type='checkbox' class='value' "+(l.properties[n]?"checked":"")+"/>";else{console.warn("unknown type: "+d);return}const m=this.createDialog("<span class='name'>"+(c.label?c.label:n)+"</span>"+g+"<button>OK</button>",u);let E=!1;if((d=="enum"||d=="combo")&&c.values)E=m.querySelector("select"),E.addEventListener("change",function(C){m.modified(),N(C.target.value)});else if(d=="boolean"||d=="toggle")E=m.querySelector("input"),E&&E.addEventListener("click",function(C){m.modified(),N(!!E.checked)});else if(E=m.querySelector("input"),E){E.addEventListener("blur",function(R){this.focus()});let C=l.properties[n]!==void 0?l.properties[n]:"";d!=="string"&&(C=JSON.stringify(C)),E.value=C,E.addEventListener("keydown",function(R){if(R.keyCode==27)m.close();else if(R.keyCode==13)A();else if(R.keyCode!=13){m.modified();return}R.preventDefault(),R.stopPropagation()})}E&&E.focus(),m.querySelector("button").addEventListener("click",A);function A(){N(E.value)}function N(C){c&&c.values&&c.values.constructor===Object&&c.values[C]!=null&&(C=c.values[C]),typeof l.properties[n]=="number"&&(C=Number(C)),(d=="array"||d=="object")&&(C=JSON.parse(C)),l.properties[n]=C,l.graph&&l.graph._version++,l.onPropertyChanged&&l.onPropertyChanged(n,C),u.onclose&&u.onclose(),m.close(),l.setDirtyCanvas(!0,!0)}return m}createDialog(l,n){n=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},n||{});const c=document.createElement("div");c.className="graphdialog",c.innerHTML=l,c.is_modified=!1;const d=this.canvas.getBoundingClientRect();let g=-20,m=-20;if(d&&(g-=d.left,m-=d.top),n.position?(g+=n.position[0],m+=n.position[1]):n.event?(g+=n.event.clientX,m+=n.event.clientY):(g+=this.canvas.width*.5,m+=this.canvas.height*.5),c.style.left=g+"px",c.style.top=m+"px",this.canvas.parentNode.appendChild(c),n.checkForInput){let N=[];(N=c.querySelectorAll("input"))&&N.forEach(function(C){C.addEventListener("keydown",function(R){if(c.modified(),R.keyCode==27)c.close();else if(R.keyCode!=13)return;R.preventDefault(),R.stopPropagation()}),C.focus()})}c.modified=function(){c.is_modified=!0},c.close=function(){c.parentNode&&c.parentNode.removeChild(c)};let E=null,L=!1;c.addEventListener("mouseleave",function(N){L||(n.closeOnLeave||LiteGraph$1.dialog_close_on_mouse_leave)&&!c.is_modified&&LiteGraph$1.dialog_close_on_mouse_leave&&(E=setTimeout(c.close,LiteGraph$1.dialog_close_on_mouse_leave_delay))}),c.addEventListener("mouseenter",function(N){(n.closeOnLeave||LiteGraph$1.dialog_close_on_mouse_leave)&&E&&clearTimeout(E)});const A=c.querySelectorAll("select");return A&&A.forEach(function(N){N.addEventListener("click",function(C){L++}),N.addEventListener("blur",function(C){L=0}),N.addEventListener("change",function(C){L=-1})}),c}createPanel(l,n){n=n||{};const u=n.window||window,c=document.createElement("div");if(c.className="litegraph dialog",c.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",c.header=c.querySelector(".dialog-header"),n.width&&(c.style.width=n.width+(n.width.constructor===Number?"px":"")),n.height&&(c.style.height=n.height+(n.height.constructor===Number?"px":"")),n.closable){const d=document.createElement("span");d.innerHTML="&#10005;",d.classList.add("close"),d.addEventListener("click",function(){c.close()}),c.header.appendChild(d)}return c.title_element=c.querySelector(".dialog-title"),c.title_element.innerText=l,c.content=c.querySelector(".dialog-content"),c.alt_content=c.querySelector(".dialog-alt-content"),c.footer=c.querySelector(".dialog-footer"),c.close=()=>{c.onClose&&typeof c.onClose=="function"&&c.onClose(),c.parentNode&&c.parentNode.removeChild(c),c.parentNode&&c.parentNode.removeChild(this)},c.toggleAltContent=d=>{let g,m;typeof d<"u"?(g=d?"block":"none",m=d?"none":"block"):(g=c.alt_content.style.display!="block"?"block":"none",m=c.alt_content.style.display!="block"?"none":"block"),c.alt_content.style.display=g,c.content.style.display=m},c.toggleFooterVisibility=d=>{let g;typeof d<"u"?g=d?"block":"none":g=c.footer.style.display!="block"?"block":"none",c.footer.style.display=g},c.clear=()=>{this.content.innerHTML=""},c.addHTML=(d,g,m)=>{const E=document.createElement("div");return g&&(E.className=g),E.innerHTML=d,m?c.footer.appendChild(E):c.content.appendChild(E),E},c.addButton=(d,g,m)=>{const E=document.createElement("button");return E.innerText=d,E.options=m,E.classList.add("btn"),E.addEventListener("click",g),c.footer.appendChild(E),E},c.addSeparator=()=>{const d=document.createElement("div");d.className="separator",c.content.appendChild(d)},c.addWidget=(d,g,m,E,L)=>{E=E||{};let A=String(m);d=d.toLowerCase(),d=="number"&&(A=parseFloat(m).toFixed(3));const N=document.createElement("div");N.className="property",N.innerHTML="<span class='property_name'></span><span class='property_value'></span>",N.querySelector(".property_name").innerText=E.label||g;const C=N.querySelector(".property_value");C.innerText=A,N.dataset.property=g,N.dataset.type=E.type||d,N.options=E,N.value=m;const R=E.disabled||!1;if(R&&C.classList.add("disabled"),d=="code")N.addEventListener("click",function(F){F.preventDefault(),!R&&c.inner_showCodePad(this.dataset.property)});else if(d=="boolean")N.classList.add("boolean"),m&&N.classList.add("bool-on"),N.addEventListener("click",function(F){if(F.preventDefault(),R)return;const U=this.dataset.property||g;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",P(U,this.value)});else if(d=="string"||d=="number"){const F=document.createElement("input"),U=d==="string"?"string":"number";E.id&&F.setAttribute("id",E.id),F.setAttribute("type",U),E.min&&F.setAttribute("min",E.min),E.max&&F.setAttribute("max",E.max),F.classList.add("property_value_input"),R&&(F.setAttribute("disabled",R),F.classList.add("disabled")),C.innerText="",F.value=d==="string"?A:Number(A),C.appendChild(F),F.addEventListener("input",function(t){if(t.preventDefault(),R)return;const r=c.parentNode.dataset.property||g,s=c.parentNode.dataset.type;let a=t.target.value;s=="number"&&(a=Number(a)),P(r,a)})}else if(d=="enum"||d=="combo"){const F=_LGraphCanvas.getPropertyPrintableValue(m,E.values);C.innerText=F,C.addEventListener("click",U=>{if(U.preventDefault(),R)return;this.closeAllContextmenu();const e=E.values||[],t=c.parentNode.dataset.property||g,r=C,s=new LiteGraph$1.ContextMenu(e,{event:U,className:"dark",callback:a},u);this._menus.push(s);function a(o,h,f){return r.innerText=o,P(t,o),!1}})}else if(d==="button"){N.innerHTML=`
                  <span class='property_name'></span>
                  <span class='property_value_img'>
                    <span class="property_img_src"></span>
                    
                  </span>`,N.querySelector(".property_name").innerText=E.label||g;const F=N.querySelector(".property_value_img");F.setAttribute("contenteditable",!0),F.innerText=A,N.dataset.property=g,N.dataset.type=E.type||d,N.options=E,N.value=m;const U=E.disabled,e=document.createElement("btn");e.classList.add("btn","btn-save-image"),e.textContent=" ",e.addEventListener("click",function(t){if(t.preventDefault(),U)return;const r=document.createElement("input");r.type="file",r.setAttribute("accept",".png,.jpg,.jpeg,.gif,.webp,"),r.click()}),F.appendChild(e)}c.content.appendChild(N);function P(F,U){E.callback&&E.callback(F,U,E),L&&L(F,U,E)}return N},c.onOpen&&typeof c.onOpen=="function"&&c.onOpen(),c}static getPropertyPrintableValue(l,n){if(!n||n.constructor===Array)return String(l);if(n.constructor===Object){let u="";for(const c in n)if(n[c]==l){u=c;break}return String(l)+" ("+u+")"}}closePanels(){const l=document.querySelector("#node-panel");l&&l.close();const n=document.querySelector("#option-panel");n&&n.close()}showShowGraphOptionsPanel(l,n,u,c){let d=document.querySelector("#node-panel"),g;if(this.constructor&&this.constructor.name=="HTMLDivElement"){if(!n||!n.event||!n.event.target||!n.event.target.lgraphcanvas){console.warn("Canvas not found");return}g=n.event.target.lgraphcanvas}else g=this;g.closePanels();const m=g.getCanvasWindow();d=g.createPanel("Options",{closable:!0,window:m,onOpen:function(){g.OPTIONPANEL_IS_OPEN=!0},onClose:function(){g.OPTIONPANEL_IS_OPEN=!1,g.options_panel=null}}),g.options_panel=d,d.id="option-panel",d.classList.add("settings");function E(){d.content.innerHTML="";const L=function(N,C,R){R&&R.key&&(N=R.key),R.values&&(C=Object.values(R.values).indexOf(C)),g[N]=C},A=LiteGraph$1.availableCanvasOptions;A.sort();for(const N in A){const C=A[N];d.addWidget("boolean",C,g[C],{key:C,on:"True",off:"False"},L)}g.links_render_mode,d.addWidget("combo","Render mode",LiteGraph$1.LINK_RENDER_MODES[g.links_render_mode],{key:"links_render_mode",values:LiteGraph$1.LINK_RENDER_MODES},L),d.addSeparator(),d.footer.innerHTML=""}E(),g.canvas.parentNode.appendChild(d)}showShowNodePanel(l){this.SELECTED_NODE=l,this.closePanels();const n=this.getCanvasWindow(),u=this,c=this.createPanel(l.title||"",{closable:!0,window:n,onOpen:function(){u.NODEPANEL_IS_OPEN=!0},onClose:function(){u.NODEPANEL_IS_OPEN=!1,u.node_panel=null}});u.node_panel=c,c.id="node-panel",c.node=l,c.classList.add("settings");function d(){var L;c.content.innerHTML="",c.addHTML("<span class='node_type'>"+l.type+"</span><span class='node_desc'>"+(l.constructor.desc||"")+"</span><span class='separator'></span>"),c.addHTML("<h4>Properties</h4>");const g=(A,N)=>{u.graph.beforeChange(l);const C=Object.values(LiteGraph$1.NODE_MODES).indexOf(N);if(A.includes("inputName")){const R=l.properties[`editable-${A}`];l.setInputName(R.index,N),l.properties[`editable-${A}`].value=N}else if(A.includes("outputName")){const R=l.properties[`editable-${A}`];l.setOutputName(R.index,N),l.properties[`editable-${A}`].value=N}else switch(A){case"Title":l.title=N;break;case"Mode":C>=0&&LiteGraph$1.NODE_MODES[C]?l.changeMode(C):console.warn("unexpected mode: "+N);break;case"Color":_LGraphCanvas.node_colors[N]?(l.color=_LGraphCanvas.node_colors[N].color,l.bgcolor=_LGraphCanvas.node_colors[N].bgcolor):console.warn("unexpected color: "+N);break;case"x":l.pos=[parseInt(N),l.pos[1]];break;case"y":l.pos=[l.pos[0],parseInt(N)];break;case"Width":l.size=[parseInt(N),l.size[1]];break;case"Height":l.size=[l.size[0],parseInt(N)];break;default:l.setProperty(A,N);break}u.graph.afterChange(),u.dirty_canvas=!0};c.addWidget("string","Title",l.title,{disabled:!1},g);const m=["font_size","status","message"];for(let A in l.properties){if(m.includes(A)||A.includes("editable-"))continue;const N=l.properties[A],C=l.getPropertyInfo(A);C.type,!(l.onAddPropertyToPanel&&l.onAddPropertyToPanel(A,c))&&c.addWidget(C.widget||C.type,A,N,C,g)}if(c.addSeparator(),l.onShowCustomPanelInfo&&l.onShowCustomPanelInfo(c),(L=Object.keys(l.properties))==null?void 0:L.some(A=>A.includes("editable-"))){c.addHTML("<h4>Editable-Properties</h4>");for(let A in l.properties)if(A.includes("editable-")){const N=l.properties[A].value,C=l.getPropertyInfo(A);C.type;const R=A.split("-")[1];if(l.onAddPropertyToPanel&&l.onAddPropertyToPanel(A,c))continue;c.addWidget(C.widget||C.type,R,N,C,g)}}c.footer.innerHTML="",c.addButton("Delete",function(){l.block_delete||(l.graph.remove(l),c.close())}).classList.add("delete")}c.inner_showCodePad=g=>{c.classList.remove("settings"),c.classList.add("centered"),c.alt_content.innerHTML="<textarea class='code'></textarea>";const m=c.alt_content.querySelector("textarea"),E=()=>{c.toggleAltContent(!1),c.toggleFooterVisibility(!0),m.parentNode.removeChild(m),c.classList.add("settings"),c.classList.remove("centered"),d()};m.value=l.properties[g],m.addEventListener("keydown",function(N){N.code=="Enter"&&N.ctrlKey&&(l.setProperty(g,m.value),E())}),c.toggleAltContent(!0),c.toggleFooterVisibility(!1),m.style.height="calc(100% - 40px)";const L=c.addButton("Assign",function(){l.setProperty(g,m.value),E()});c.alt_content.appendChild(L);const A=c.addButton("Close",E);A.style.float="right",c.alt_content.appendChild(A)},d(),this.canvas.parentNode.appendChild(c)}showSubgraphPropertiesDialog(l){console.log("showing subgraph properties dialog");const n=this.canvas.parentNode.querySelector(".subgraph_dialog");n&&n.close();const u=this.createPanel("Subgraph Inputs",{closable:!0,width:500});u.node=l,u.classList.add("subgraph_dialog");function c(){if(u.clear(),l.inputs)for(let m=0;m<l.inputs.length;++m){const E=l.inputs[m];if(E.not_subgraph_input)continue;const A=u.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");A.dataset.name=E.name,A.dataset.slot=m,A.querySelector(".name").innerText=E.name,A.querySelector(".type").innerText=E.type,A.querySelector("button").addEventListener("click",function(N){l.removeInput(Number(this.parentNode.dataset.slot)),c()})}}return u.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",function(m){const E=this.parentNode,L=E.querySelector(".name").value,A=E.querySelector(".type").value;!L||l.findInputSlot(L)!=-1||(l.addInput(L,A),E.querySelector(".name").value="",E.querySelector(".type").value="",c())}),c(),this.canvas.parentNode.appendChild(u),u}showSubgraphPropertiesDialogRight(l){const n=this.canvas.parentNode.querySelector(".subgraph_dialog");n&&n.close();const u=this.createPanel("Subgraph Outputs",{closable:!0,width:500});u.node=l,u.classList.add("subgraph_dialog");function c(){if(u.clear(),l.outputs)for(let E=0;E<l.outputs.length;++E){const L=l.outputs[E];if(L.not_subgraph_output)continue;const N=u.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");N.dataset.name=L.name,N.dataset.slot=E,N.querySelector(".name").innerText=L.name,N.querySelector(".type").innerText=L.type,N.querySelector("button").addEventListener("click",function(C){l.removeOutput(Number(this.parentNode.dataset.slot)),c()})}}const g=u.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);g.querySelector(".name").addEventListener("keydown",function(E){E.keyCode==13&&m.apply(this)}),g.querySelector("button").addEventListener("click",function(E){m.apply(this)});function m(){const E=this.parentNode,L=E.querySelector(".name").value,A=E.querySelector(".type").value;!L||l.findOutputSlot(L)!=-1||(l.addOutput(L,A),E.querySelector(".name").value="",E.querySelector(".type").value="",c())}return c(),this.canvas.parentNode.appendChild(u),u}checkPanels(){if(!this.canvas)return;const l=this.canvas.parentNode.querySelectorAll(".litegraph.dialog");for(let n=0;n<l.length;++n){const u=l[n];u.node&&(!u.node.graph||u.graph!=this.graph)&&u.close()}}static onMenuNodeCollapse(l,n,u,c,d){d.graph.beforeChange();const g=function(E){E.collapse()},m=_LGraphCanvas.active_canvas;if(!m.selected_nodes||Object.keys(m.selected_nodes).length<=1)g(d);else for(const E in m.selected_nodes)g(m.selected_nodes[E]);d.graph.afterChange()}static onMenuNodePin(l,n,u,c,d){d.pin()}static onMenuNodeMode(l,n,u,c,d){new LiteGraph$1.ContextMenu(LiteGraph$1.NODE_MODES,{event:u,callback:g,parentMenu:c,node:d});function g(m){if(!d)return;const E=Object.values(LiteGraph$1.NODE_MODES).indexOf(m),L=function(N){E>=0&&LiteGraph$1.NODE_MODES[E]?N.changeMode(E):(console.warn("unexpected mode: "+m),N.changeMode(LiteGraph$1.ALWAYS))},A=_LGraphCanvas.active_canvas;if(!A.selected_nodes||Object.keys(A.selected_nodes).length<=1)L(d);else for(const N in A.selected_nodes)L(A.selected_nodes[N])}return!1}static onMenuNodeColors(l,n,u,c,d){if(!d)throw"no node for color";const g=[];g.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(const E in _LGraphCanvas.node_colors){const L=_LGraphCanvas.node_colors[E],A={value:E,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+L.color+"; background-color:"+L.bgcolor+"'>"+E+"</span>"};g.push(A)}new LiteGraph$1.ContextMenu(g,{event:u,callback:m,parentMenu:c,node:d});function m(E){if(!d)return;const L=E.value?_LGraphCanvas.node_colors[E.value]:null,A=function(C){L?C.constructor===LiteGraph$1.LGraphGroup?C.color=L.groupcolor:(C.color=L.color,C.bgcolor=L.bgcolor):(delete C.color,delete C.bgcolor)},N=_LGraphCanvas.active_canvas;if(!N.selected_nodes||Object.keys(N.selected_nodes).length<=1)A(d);else for(const C in N.selected_nodes)A(N.selected_nodes[C]);d.setDirtyCanvas(!0,!0)}return!1}static onMenuNodeShapes(l,n,u,c,d){if(!d)throw"no node passed";new LiteGraph$1.ContextMenu(LiteGraph$1.VALID_SHAPES,{event:u,callback:g,parentMenu:c,node:d});function g(m){if(!d)return;d.graph.beforeChange();const E=function(A){A.shape=m},L=_LGraphCanvas.active_canvas;if(!L.selected_nodes||Object.keys(L.selected_nodes).length<=1)E(d);else for(const A in L.selected_nodes)E(L.selected_nodes[A]);d.graph.afterChange(),d.setDirtyCanvas(!0)}return!1}static onMenuNodeRemove(l,n,u,c,d){if(!d)throw"no node passed";const g=d.graph;g.beforeChange();const m=function(L){L.removable!==!1&&g.remove(L)},E=_LGraphCanvas.active_canvas;if(!E.selected_nodes||Object.keys(E.selected_nodes).length<=1)m(d);else for(const L in E.selected_nodes)m(E.selected_nodes[L]);g.afterChange(),d.setDirtyCanvas(!0,!0)}static onMenuNodeToSubgraph(l,n,u,c,d){const g=d.graph,m=_LGraphCanvas.active_canvas;if(!m)return;let E=Object.values(m.selected_nodes||{});E.length||(E=[d]);const L=LiteGraph$1.createNode("graph/subgraph");L.pos=d.pos.concat(),g.add(L),L.buildFromNodes(E),m.deselectAllNodes(),d.setDirtyCanvas(!0,!0)}static onMenuNodeClone(l,n,u,c,d){d.graph.beforeChange();const g={},m=function(L){if(L.clonable===!1)return;const A=L.clone();A&&(A.pos=[L.pos[0]+5,L.pos[1]+5],L.graph.add(A),g[A.id]=A)},E=_LGraphCanvas.active_canvas;if(!E.selected_nodes||Object.keys(E.selected_nodes).length<=1)m(d);else for(const L in E.selected_nodes)m(E.selected_nodes[L]);Object.keys(g).length&&E.selectNodes(g),d.graph.afterChange(),d.setDirtyCanvas(!0,!0)}getNodeMenuOptions(l){let n=null;if(l.getMenuOptions?n=l.getMenuOptions(this):(n=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:_LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:_LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:_LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:_LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeMode}],l.resizable!==!1&&n.push({content:"Resize",callback:_LGraphCanvas.onMenuResizeNode}),n.push({content:"Collapse",callback:_LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:_LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:_LGraphCanvas.onMenuNodeShapes},null)),l.onGetInputs){const u=l.onGetInputs();u&&u.length&&(n[0].disabled=!1)}if(l.onGetOutputs){const u=l.onGetOutputs();u&&u.length&&(n[1].disabled=!1)}if(l.getExtraMenuOptions){const u=l.getExtraMenuOptions(this,n);u&&(u.push(null),n=u.concat(n))}return l.clonable!==!1&&n.push({content:"Clone",callback:_LGraphCanvas.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&n.push({content:"Align Selected To",has_submenu:!0,callback:_LGraphCanvas.onNodeAlign}),n.push(null,{content:"Remove",disabled:!(l.removable!==!1&&!l.block_delete),callback:_LGraphCanvas.onMenuNodeRemove}),l.graph&&l.graph.onGetNodeMenuOptions&&l.graph.onGetNodeMenuOptions(n,l),n}bringGroupToFront(l){const n=this.graph._groups,u=this.findGroupIndexById(l.id);Number(u)!==-1&&(n.splice(Number(u),1),n.push(l),this.setDirty(!0,!0))}onGrpSizeEditor(l,n,u,c,d){l.property;const g=document.createElement("div");g.is_modified=!1,g.className="graphdialog",g.innerHTML=`
                <div class="d-flex flex-column align-items-start p-2" id="grpSizeDialog">
                  <div> <div><span class='main-tit p-1'>  </span> </div>
                  <div class="p-1"><span class='sub-prop'></span><input  type='number' class='value' id="widthValue" /></div>
                  <div class="p-1"><span class='sub-prop'></span><input type='number' class='value' id="heightValue"  /></div>
                  <div class="d-flex align-items-center justify-content-end p-1"><button class="okBtn">OK</button></div>
                </div>
               
                
                `,g.close=function(){g.parentNode&&g.parentNode.removeChild(g)};const E=_LGraphCanvas.active_canvas.canvas,L=E.getBoundingClientRect();let A=-20,N=-20;L&&(A-=L.left,N-=L.top),event?(g.style.left=event.clientX+A+"px",g.style.top=event.clientY+N+"px"):(g.style.left=E.width*.5+A+"px",g.style.top=E.height*.5+N+"px"),g.querySelector(".okBtn").addEventListener("click",U),E.parentNode.appendChild(g);const R=document.querySelector("#widthValue"),P=document.querySelector("#heightValue");R&&(R.value=Number(d.size[0]),R.addEventListener("keydown",function(t){if(g.is_modified=!0,t.keyCode==27)g.close();else if(t.keyCode==13)U();else if(t.keyCode!=13&&t.target.localName!="textarea")return;t.preventDefault(),t.stopPropagation()})),P&&(P.value=Number(d.size[1]),P.addEventListener("keydown",function(t){if(g.is_modified=!0,t.keyCode==27)g.close();else if(t.keyCode==13)U();else if(t.keyCode!=13&&t.target.localName!="textarea")return;t.preventDefault(),t.stopPropagation()}));let F=null;g.addEventListener("mouseleave",function(t){LiteGraph$1.dialog_close_on_mouse_leave&&!g.is_modified&&LiteGraph$1.dialog_close_on_mouse_leave&&(F=setTimeout(g.close,LiteGraph$1.dialog_close_on_mouse_leave_delay))}),g.addEventListener("mouseenter",function(t){LiteGraph$1.dialog_close_on_mouse_leave&&F&&clearTimeout(F)});function U(){e(R==null?void 0:R.value,P==null?void 0:P.value)}function e(t,r){const s=t||d.size[0],a=r||d.size[1];d.size=[s,a],g.parentNode&&g.parentNode.removeChild(g),d.setDirtyCanvas(!0,!0)}}onShowPropertyEditor(l,n,u,c,d){const g=l.property||"title",m=d[g],E=document.createElement("div");E.is_modified=!1,E.className="graphdialog",E.innerHTML="<span class='name'></span><input type='text' class='value '/><button>OK</button>",E.close=function(){E.parentNode&&E.parentNode.removeChild(E)};const L=E.querySelector(".name");L.innerText=g;let A=E.querySelector(".value");A&&(A.value=m,A.addEventListener("keydown",function(s){if(E.is_modified=!0,s.keyCode==27)E.close();else if(s.keyCode==13)t();else if(s.keyCode!=13&&s.target.localName!="textarea")return;s.preventDefault(),s.stopPropagation()}));const C=_LGraphCanvas.active_canvas.canvas,R=C.getBoundingClientRect();let P=-20,F=-20;R&&(P-=R.left,F-=R.top),event?(E.style.left=event.clientX+P+"px",E.style.top=event.clientY+F+"px"):(E.style.left=C.width*.5+P+"px",E.style.top=C.height*.5+F+"px"),E.querySelector("button").addEventListener("click",t),C.parentNode.appendChild(E);let e=null;E.addEventListener("mouseleave",function(s){LiteGraph$1.dialog_close_on_mouse_leave&&!E.is_modified&&LiteGraph$1.dialog_close_on_mouse_leave&&(e=setTimeout(E.close,LiteGraph$1.dialog_close_on_mouse_leave_delay))}),E.addEventListener("mouseenter",function(s){LiteGraph$1.dialog_close_on_mouse_leave&&e&&clearTimeout(e)});function t(){A&&r(A.value)}function r(s){l.type=="Number"?s=Number(s):l.type=="Boolean"&&(s=!!s),d[g]=s,E.parentNode&&E.parentNode.removeChild(E),d.setDirtyCanvas(!0,!0)}}onGrpPositionEditor(l,n,u,c,d){const g=document.createElement("div");g.is_modified=!1,g.className="graphdialog",g.innerHTML=`
                <div class="d-flex flex-column align-items-start p-2" id="grpSizeDialog">
                  <div> <div><span class='main-tit p-1'>  </span> </div>
                  <div class="p-1"><span class='sub-prop'>X</span><input  type='number' class='value' id="xValue" /></div>
                  <div class="p-1"><span class='sub-prop'>Y</span><input type='number' class='value' id="yValue" /></div>
                  <div class="d-flex align-items-center justify-content-end p-1"><button class="okBtn">OK</button></div>
                </div>
                `,g.close=function(){g.parentNode&&g.parentNode.removeChild(g)};const E=_LGraphCanvas.active_canvas.canvas,L=E.getBoundingClientRect();let A=-20,N=-20;L&&(A-=L.left,N-=L.top),event?(g.style.left=event.clientX+A+"px",g.style.top=event.clientY+N+"px"):(g.style.left=E.width*.5+A+"px",g.style.top=E.height*.5+N+"px"),g.querySelector(".okBtn").addEventListener("click",U),E.parentNode.appendChild(g);const R=document.querySelector("#xValue"),P=document.querySelector("#yValue");R&&(R.value=Number(d.pos[0]),R.addEventListener("keydown",function(t){if(g.is_modified=!0,t.keyCode==27)g.close();else if(t.keyCode==13)U();else if(t.keyCode!=13&&t.target.localName!="textarea")return;t.preventDefault(),t.stopPropagation()})),P&&(P.value=Number(d.pos[1]),P.addEventListener("keydown",function(t){if(g.is_modified=!0,t.keyCode==27)g.close();else if(t.keyCode==13)U();else if(t.keyCode!=13&&t.target.localName!="textarea")return;t.preventDefault(),t.stopPropagation()}));let F=null;g.addEventListener("mouseleave",function(t){LiteGraph$1.dialog_close_on_mouse_leave&&!g.is_modified&&LiteGraph$1.dialog_close_on_mouse_leave&&(F=setTimeout(g.close,LiteGraph$1.dialog_close_on_mouse_leave_delay))}),g.addEventListener("mouseenter",function(t){LiteGraph$1.dialog_close_on_mouse_leave&&F&&clearTimeout(F)});function U(){e(R==null?void 0:R.value,P==null?void 0:P.value)}function e(t,r){const s=t||d.pos[0],a=r||d.pos[1];d.recomputeInsideNodes();const o=[s-d.pos[0],a-d.pos[1]];d.move(o[0],o[1]),g.parentNode&&g.parentNode.removeChild(g),d.setDirtyCanvas(!0,!0)}}sendGroupToBack(l){const n=this.graph._groups,u=this.findGroupIndexById(l.id);Number(u)!==-1&&(n.splice(Number(u),1),n.unshift(l),this.setDirty(!0,!0))}findGroupIndexById(l){const n=this.graph._groups;for(let u in n)if(n[u].id===l)return u;return-1}addNodeGuideLines(l){var u;const n=this.selected_nodes?Object.keys(this.selected_nodes):[];if((n==null?void 0:n.length)===1&&!this.read_only&&((u=this.graph._nodes)==null?void 0:u.length)>=2){const c=this.selected_nodes[n[0]],g=c.constructor.title_mode?0:LiteGraph$1.NODE_TITLE_HEIGHT,m=this.graph._nodes.map(C=>({x:C.pos[0],y:C.pos[1]-g,width:C.size[0],height:C.size[1],id:C.id})).filter(C=>(C==null?void 0:C.id)!==(c==null?void 0:c.id)),E=c.size[0],L=c.size[1],A=c.pos[0],N=c.pos[1]-g;l.strokeStyle="#c4c4c4",l.lineWidth=1;for(let C in m){l.strokeStyle=16711680;const R=m[C],P=R.width,F=R.height,U=R.x,e=R.y,t=Math.round(A),r=Math.round(N),s=Math.round(E),a=Math.round(L),o=Math.round(U),h=Math.round(e),f=Math.round(P),p=Math.round(F);o===t&&(r<h?(l.beginPath(),l.moveTo(t,r),l.lineTo(o,h+p+g),l.stroke()):(l.beginPath(),l.moveTo(o,h),l.lineTo(t,r+a+g),l.stroke())),o+f===t+s&&(r<h?(l.beginPath(),l.moveTo(t+s,r),l.lineTo(o+f,h+p+g),l.stroke()):(l.beginPath(),l.moveTo(o+f,h),l.lineTo(t+s,r+a+g),l.stroke())),h===r&&(t<o?(l.beginPath(),l.moveTo(t,r),l.lineTo(o+f,h),l.stroke()):(l.beginPath(),l.moveTo(o,h),l.lineTo(t+s,r),l.stroke())),h+p===r+a&&(t<o?(l.beginPath(),l.moveTo(t,r+a+g),l.lineTo(o+f,h+p+g),l.stroke()):(l.beginPath(),l.moveTo(o,h+p+g),l.lineTo(t+s,r+a+g),l.stroke()))}}}getCanvasMenuOptions(){let l=null;if(this.getMenuOptions?l=this.getMenuOptions():(l=[{content:" ",has_submenu:!0,callback:_LGraphCanvas.onMenuAdd.bind(this)},{content:" ",callback:_LGraphCanvas.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&l.push({content:"",has_submenu:!0,callback:_LGraphCanvas.onGroupAlign}),this._graph_stack&&this._graph_stack.length>0&&l.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){const n=this.getExtraMenuOptions(this,l);n&&(l=l.concat(n))}return l}processContextMenu(l,n){const u=this,d=_LGraphCanvas.active_canvas.getCanvasWindow();if(!d)return;let g=null;const m={event:n,callback:L,extra:l};l&&(m.title=l.type);let E=null;if(l&&(E=l.getSlotInPosition(n.canvasX,n.canvasY),_LGraphCanvas.active_node=l),E){if(g=[],l.getSlotMenuOptions)g=l.getSlotMenuOptions(E);else{E&&E.output&&E.output.links&&E.output.links.length&&g.push({content:"Disconnect Links",slot:E});const A=E.input||E.output;A.removable&&g.push(A.locked?"Cannot remove":{content:"Remove Slot",slot:E}),A.nameLocked||g.push({content:"Rename Slot",slot:E})}m.title=(E.input?E.input.type:E.output.type)||"*",E.input&&E.input.type==LiteGraph$1.ACTION&&(m.title="Action"),E.output&&E.output.type==LiteGraph$1.EVENT&&(m.title="Event")}else if(l)g=this.getNodeMenuOptions(l);else{g=this.getCanvasMenuOptions();const A=this.graph.getGroupOnPos(n.canvasX,n.canvasY);A&&g.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:A,options:this.getGroupMenuOptions(A)}})}if(!g)return;new LiteGraph$1.ContextMenu(g,m,d);function L(A,N,C){if(A){if(A.content=="Remove Slot"){const R=A.slot;l.graph.beforeChange(),R.input?l.removeInput(R.slot):R.output&&l.removeOutput(R.slot),l.graph.afterChange();return}else if(A.content=="Disconnect Links"){const R=A.slot;l.graph.beforeChange(),R.output?l.disconnectOutput(R.slot):R.input&&l.disconnectInput(R.slot),l.graph.afterChange();return}else if(A.content=="Rename Slot"){const R=A.slot,P=R.input?l.getInputInfo(R.slot):l.getOutputInfo(R.slot),F=u.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",N),U=F.querySelector("input");U&&P&&(U.value=P.label||"");const e=function(){l.graph.beforeChange(),U.value&&(P&&(P.label=U.value),u.setDirty(!0)),F.close(),l.graph.afterChange()};F.querySelector("button").addEventListener("click",e),U.addEventListener("keydown",function(t){if(F.is_modified=!0,t.keyCode==27)F.close();else if(t.keyCode==13)e();else if(t.keyCode!=13&&t.target.localName!="textarea")return;t.preventDefault(),t.stopPropagation()}),U.focus()}}}}},ne(_LGraphCanvas,"DEFAULT_BACKGROUND_IMAGE","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII="),ne(_LGraphCanvas,"link_type_colors",{"-1":LiteGraph$1.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"}),ne(_LGraphCanvas,"gradients",{}),ne(_LGraphCanvas,"search_limit",-1),ne(_LGraphCanvas,"node_colors",{red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}}),_LGraphCanvas);function clamp(l,n,u){return n>l?n:u<l?u:l}typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(l){window.setTimeout(l,1e3/60)}),typeof exports<"u"&&(exports.LiteGraph=(void 0).LiteGraph,exports.LGraph=(void 0).LGraph,exports.LLink=(void 0).LLink,exports.LGraphNode=(void 0).LGraphNode,exports.LGraphGroup=(void 0).LGraphGroup,exports.DragAndScale=(void 0).DragAndScale,exports.LGraphCanvas=(void 0).LGraphCanvas,exports.ContextMenu=(void 0).ContextMenu);class Editor{constructor(n,u){u=u||{};var c="<div class='header'><div class='tools tools-left'></div><div class='tools tools-right'></div></div>";c+="<div class='content'><div class='editor-area'><canvas class='graphcanvas' width='1000' height='500' tabindex=10></canvas></div></div>",c+="<div class='footer'><div class='tools tools-left'></div><div class='tools tools-right'></div></div>";var d=document.createElement("div");this.root=d,d.className="litegraph litegraph-editor",d.innerHTML=c,this.tools=d.querySelector(".tools"),this.content=d.querySelector(".content"),this.footer=d.querySelector(".footer");var g=this.canvas=d.querySelector(".graphcanvas"),m=this.graph=new LGraph,E=this.graphcanvas=new LGraphCanvas(g,m,{useWebgl:!0});E.links_render_mode=0,E.background_image="imgs/grid.png",m.onAfterExecute=function(){E.draw(!0)},E.onDropItem=this.onDropItem.bind(this),this.addLoadCounter(),this.addToolsButton("playnode_button","Play","imgs/icon-play.png",this.onPlayButton.bind(this),".tools-right"),this.addToolsButton("playstepnode_button","Step","imgs/icon-playstep.png",this.onPlayStepButton.bind(this),".tools-right"),u.skip_livemode||this.addToolsButton("livemode_button","Live","imgs/icon-record.png",this.onLiveButton.bind(this),".tools-right"),u.skip_maximize||this.addToolsButton("maximize_button","","imgs/icon-maximize.png",this.onFullscreenButton.bind(this),".tools-right"),u.miniwindow&&this.addMiniWindow(300,200);var L=document.getElementById(n);L&&L.appendChild(d),E.resize()}addLoadCounter(){var n=document.createElement("div");n.className="headerpanel loadmeter toolbar-widget";var u="<div class='cpuload'><strong>CPU</strong> <div class='bgload'><div class='fgload'></div></div></div>";u+="<div class='gpuload'><strong>GFX</strong> <div class='bgload'><div class='fgload'></div></div></div>",n.innerHTML=u,this.root.querySelector(".header .tools-left").appendChild(n);var c=this;setInterval(function(){n.querySelector(".cpuload .fgload").style.width=2*c.graph.execution_time*90+"px",c.graph.status==LGraph.STATUS_RUNNING?n.querySelector(".gpuload .fgload").style.width=c.graphcanvas.render_time*10*90+"px":n.querySelector(".gpuload .fgload").style.width="4px"},200)}addToolsButton(n,u,c,d,g){g||(g=".tools");var m=this.createButton(u,c,d);m.id=n,this.root.querySelector(g).appendChild(m)}createButton(n,u,c){var d=document.createElement("button");return u&&(d.innerHTML="<img src='"+u+"'/> "),d.classList.add("btn"),d.innerHTML+=n,c&&d.addEventListener("click",c),d}onLoadButton(){var n=this.graphcanvas.createPanel("Load session",{closable:!0});this.root.appendChild(n)}onSaveButton(){}onPlayButton(){var n=this.graph,u=this.root.querySelector("#playnode_button");n.status==LGraph.STATUS_STOPPED?(u.innerHTML="<img src='imgs/icon-stop.png'/> Stop",n.start()):(u.innerHTML="<img src='imgs/icon-play.png'/> Play",n.stop())}onPlayStepButton(){var n=this.graph;n.runStep(1),this.graphcanvas.draw(!0,!0)}onLiveButton(){var n=!this.graphcanvas.live_mode;this.graphcanvas.switchLiveMode(!0),this.graphcanvas.draw(),this.graphcanvas.live_mode;var u=this.root.querySelector("#livemode_button");u.innerHTML=n?"<img src='imgs/icon-gear.png'/> Edit":"<img src='imgs/icon-record.png'/> Live"}onDropItem(n){for(var u=this,c=0;c<n.dataTransfer.files.length;++c){var d=n.dataTransfer.files[c],g=LGraphCanvas.getFileExtension(d.name),m=new FileReader;g=="json"&&(m.onload=function(E){var L=JSON.parse(E.target.result);u.graph.configure(L)},m.readAsText(d))}}goFullscreen(){if(this.root.requestFullscreen)this.root.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT);else if(this.root.mozRequestFullscreen)this.root.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT);else if(this.root.webkitRequestFullscreen)this.root.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);else throw"Fullscreen not supported";var n=this;setTimeout(function(){n.graphcanvas.resize()},100)}onFullscreenButton(){this.goFullscreen()}addMiniWindow(n,u){var c=document.createElement("div");c.className="litegraph miniwindow",c.innerHTML="<canvas class='graphcanvas' width='"+n+"' height='"+u+"' tabindex=10></canvas>";var d=c.querySelector("canvas"),g=this,m=new LGraphCanvas(d,this.graph);m.show_info=!1,m.background_image="imgs/grid.png",m.scale=.25,m.allow_dragnodes=!1,m.allow_interaction=!1,m.render_shadows=!1,m.max_zoom=.25,this.miniwindow_graphcanvas=m,m.onClear=function(){m.scale=.25,m.allow_dragnodes=!1,m.allow_interaction=!1},m.onRenderBackground=function(L,A){A.strokeStyle="#567";var N=g.graphcanvas.convertOffsetToCanvas([0,0]),C=g.graphcanvas.convertOffsetToCanvas([g.graphcanvas.canvas.width,g.graphcanvas.canvas.height]);N=this.convertCanvasToOffset(N),C=this.convertCanvasToOffset(C),A.lineWidth=1,A.strokeRect(Math.floor(N[0])+.5,Math.floor(N[1])+.5,Math.floor(C[0]-N[0]),Math.floor(C[1]-N[1]))},c.style.position="absolute",c.style.top="4px",c.style.right="4px";var E=document.createElement("div");E.className="corner-button",E.innerHTML="&#10060;",E.addEventListener("click",function(L){m.setGraph(null),c.parentNode.removeChild(c)}),c.appendChild(E),this.root.querySelector(".content").appendChild(c)}addMultiview(){var n=this.canvas;this.graphcanvas.ctx.fillStyle="black",this.graphcanvas.ctx.fillRect(0,0,n.width,n.height),this.graphcanvas.viewport=[0,0,n.width*.5-2,n.height];var u=new LGraphCanvas(n,this.graph);u.background_image="imgs/grid.png",this.graphcanvas2=u,this.graphcanvas2.viewport=[n.width*.5,0,n.width*.5,n.height]}}class RootNode extends LGraphNode{constructor(){super(),this.mode=0,this.addProperty("status",0,"number"),this.addProperty("message","","string")}}class ManualTrigger extends RootNode{constructor(){super(),this.title=" "}onExecute(){}}LiteGraph$1.registerNodeType("trigger/manualTrigger",ManualTrigger);var webgl_canvas=null;LiteGraph.node_images_path="../nodes_data/",console.log(Editor);var editor=new Editor("main",{miniwindow:!1});window.graphcanvas=editor.graphcanvas,window.graph=editor.graph;const graph=window.graph;updateEditorHiPPICanvas(),window.addEventListener("resize",function(){editor.graphcanvas.resize(),updateEditorHiPPICanvas()}),window.onbeforeunload=function(){var l=JSON.stringify(window.graph.serialize());localStorage.setItem("litegraphg demo backup",l)};function updateEditorHiPPICanvas(){const l=window.devicePixelRatio;if(l==1)return;const n=editor.canvas.parentNode.getBoundingClientRect(),{width:u,height:c}=n;return editor.canvas.width=u*l,editor.canvas.height=c*l,editor.canvas.style.width=u+"px",editor.canvas.style.height=c+"px",editor.canvas.getContext("2d").scale(l,l),editor.canvas}LiteGraph.allow_scripts=!0;var elem=document.createElement("span");elem.id="LGEditorTopBarSelector",elem.className="selector",elem.innerHTML="",elem.innerHTML+="Demo <select><option>Empty</option></select> <button class='btn' id='save'>Save</button><button class='btn' id='load'>Load</button><button class='btn' id='download'>Download</button> | <button class='btn' id='webgl'>WebGL</button> <button class='btn' id='multiview'>Multiview</button>",editor.tools.appendChild(elem);var select=elem.querySelector("select");select.addEventListener("change",function(l){var n=this.options[this.selectedIndex],u=n.dataset.url;u?graph.load(u):n.callback?n.callback():graph.clear()}),elem.querySelector("#save").addEventListener("click",function(){console.log("saved"),localStorage.setItem("graphdemo_save",JSON.stringify(graph.serialize()))}),elem.querySelector("#load").addEventListener("click",function(){var l=localStorage.getItem("graphdemo_save");l&&graph.configure(JSON.parse(l)),console.log("loaded")}),elem.querySelector("#download").addEventListener("click",function(){var l=JSON.stringify(graph.serialize()),n=new Blob([l]),u=URL.createObjectURL(n),c=document.createElement("a");c.setAttribute("href",u),c.setAttribute("download","graph.JSON"),c.style.display="none",document.body.appendChild(c),c.click(),document.body.removeChild(c),setTimeout(function(){URL.revokeObjectURL(u)},1e3*60)}),elem.querySelector("#webgl").addEventListener("click",enableWebGL),elem.querySelector("#multiview").addEventListener("click",function(){editor.addMultiview()});function addDemo(l,n){var u=document.createElement("option");n.constructor===String?u.dataset.url=n:u.callback=n,u.innerHTML=l,select.appendChild(u)}addDemo("Features","examples/features.json"),addDemo("Benchmark","examples/benchmark.json"),addDemo("Subgraph","examples/subgraph.json"),addDemo("Audio","examples/audio.json"),addDemo("Audio Delay","examples/audio_delay.json"),addDemo("Audio Reverb","examples/audio_reverb.json"),addDemo("MIDI Generation","examples/midi_generation.json"),addDemo("Copy Paste","examples/copypaste.json"),addDemo("autobackup",function(){var l=localStorage.getItem("litegraphg demo backup");if(l){var n=JSON.parse(l);graph.configure(n)}});function enableWebGL(){if(webgl_canvas){webgl_canvas.style.display=webgl_canvas.style.display=="none"?"block":"none";return}var l=["js/libs/gl-matrix-min.js","js/libs/litegl.js","../src/nodes/gltextures.js","../src/nodes/glfx.js","../src/nodes/glshaders.js","../src/nodes/geometry.js"];function n(){if(l.length==0)return u();var c=null;c=document.createElement("script"),c.onload=n,c.src=l.shift(),document.head.appendChild(c)}n();function u(){if(console.log(this.src),!window.GL)return;webgl_canvas=document.createElement("canvas"),webgl_canvas.width=400,webgl_canvas.height=300,webgl_canvas.style.position="absolute",webgl_canvas.style.top="0px",webgl_canvas.style.right="0px",webgl_canvas.style.border="1px solid #AAA",webgl_canvas.addEventListener("click",function(){var m=webgl_canvas.parentNode.getBoundingClientRect();webgl_canvas.width!=m.width?(webgl_canvas.width=m.width,webgl_canvas.height=m.height):(webgl_canvas.width=400,webgl_canvas.height=300)});var c=document.querySelector(".editor-area");c.appendChild(webgl_canvas);var d=GL.create({canvas:webgl_canvas});if(!d)return;editor.graph.onBeforeStep=g,console.log("webgl ready");function g(){d.clearColor(0,0,0,0),d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT),d.viewport(0,0,d.canvas.width,d.canvas.height)}}}LiteGraph$1.debug=!1,LiteGraph$1.catch_exceptions=!0,LiteGraph$1.throw_errors=!0,LiteGraph$1.allow_scripts=!1,LiteGraph$1.searchbox_extras={},LiteGraph$1.auto_sort_node_types=!0,LiteGraph$1.node_box_coloured_when_on=!0,LiteGraph$1.node_box_coloured_by_mode=!0,LiteGraph$1.dialog_close_on_mouse_leave=!0,LiteGraph$1.dialog_close_on_mouse_leave_delay=500,LiteGraph$1.shift_click_do_break_link_from=!1,LiteGraph$1.click_do_break_link_to=!1,LiteGraph$1.search_hide_on_mouse_leave=!0,LiteGraph$1.search_filter_enabled=!0,LiteGraph$1.search_show_all_on_open=!0,LiteGraph$1.auto_load_slot_types=!0,LiteGraph$1.alt_drag_do_clone_nodes=!0,LiteGraph$1.do_add_triggers_slots=!0,LiteGraph$1.allow_multi_output_for_events=!1,LiteGraph$1.middle_click_slot_add_default_node=!0,LiteGraph$1.release_link_on_empty_shows_menu=!0,LiteGraph$1.pointerevents_method="mouse",LiteGraph$1.ctrl_shift_v_paste_connect_unselected_outputs=!0})();
